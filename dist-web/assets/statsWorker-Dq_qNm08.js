(function(){"use strict";const tn=["selfBuffs","groupBuffs","squadBuffs"],sn=s=>s!=null&&s.classification?s.classification==="Boon":!0,an=s=>`b${s}`,Fn=(s,t)=>{const a=Array.isArray(s==null?void 0:s.activeTimes)?s.activeTimes:[],u=typeof a[0]=="number"?a[0]:0;return u>0?u:t},rn=(s,t,a,u,m,b,y)=>{const D=s==="selfBuffs"?1:Math.max(s==="groupBuffs"?b-1:y-1,0);return!D||!m?{generationMs:0,wastedMs:0}:t?{generationMs:a*m*D,wastedMs:u*m*D}:{generationMs:a/100*m*D,wastedMs:u/100*m*D}},vn=s=>{const t=new Map,a=new Map;return s.forEach(b=>{const y=b.details;if(!y)return;const D=y.durationMS||0,A=y.buffMap||{};Object.entries(A).forEach(([d,g])=>{if(!t.has(d)){t.set(d,g);return}const N=t.get(d)||{},C={name:N.name||g.name,stacking:N.stacking??g.stacking,icon:N.icon||g.icon,classification:N.classification||g.classification};t.set(d,C)});const J=(y.players||[]).filter(d=>!d.notInSquad),q=J.length,X=new Map;J.forEach(d=>{const g=d.group??0;X.set(g,(X.get(g)||0)+1)}),J.forEach(d=>{const g=d.account||d.name||d.character_name||"Unknown",N=d.profession||"Unknown",C=d.group??0,w=X.get(C)||1,te=Fn(d,D);a.has(g)||a.set(g,{account:g,profession:N,professions:new Set,professionTimeMs:{},activeTimeMs:0,numFights:0,groupSupported:0,squadSupported:0,boons:{}});const F=a.get(g);F.profession=N,N!=="Unknown"&&(F.professions.add(N),F.professionTimeMs[N]=(F.professionTimeMs[N]||0)+te),F.activeTimeMs+=te,F.numFights+=1,F.groupSupported+=w,F.squadSupported+=q,tn.forEach(W=>{(d[W]||[]).forEach(V=>{var Y,P,ke,Me;if(typeof(V==null?void 0:V.id)!="number")return;const L=an(V.id),M=A[L];if(!sn(M))return;const re=(M==null?void 0:M.stacking)??!1,_=((P=(Y=V.buffData)==null?void 0:Y[0])==null?void 0:P.generation)??0,I=((Me=(ke=V.buffData)==null?void 0:ke[0])==null?void 0:Me.wasted)??0,{generationMs:ie,wastedMs:Z}=rn(W,re,_,I,D,w,q);!ie&&!Z||(t.has(L)||t.set(L,M||{}),F.boons[L]||(F.boons[L]={selfBuffs:{generationMs:0,wastedMs:0},groupBuffs:{generationMs:0,wastedMs:0},squadBuffs:{generationMs:0,wastedMs:0}}),F.boons[L][W].generationMs+=ie,F.boons[L][W].wastedMs+=Z)})})})}),{boonTables:Array.from(t.keys()).filter(b=>sn(t.get(b))).map(b=>{const y=t.get(b)||{},D=[];return a.forEach(A=>{var d;const oe=A.boons[b];if(!oe||!tn.some(g=>oe[g].generationMs>0||oe[g].wastedMs>0))return;const q=Array.from(A.professions||[]).filter(g=>g&&g!=="Unknown");let X=A.profession;if(q.length>0){X=q[0];let g=((d=A.professionTimeMs)==null?void 0:d[X])||0;q.forEach(N=>{var w;const C=((w=A.professionTimeMs)==null?void 0:w[N])||0;C>g&&(g=C,X=N)})}D.push({account:A.account,profession:X||"Unknown",professionList:q,activeTimeMs:A.activeTimeMs||1,numFights:A.numFights||1,groupSupported:A.groupSupported||1,squadSupported:A.squadSupported||1,categories:{selfBuffs:{...oe.selfBuffs},groupBuffs:{...oe.groupBuffs},squadBuffs:{...oe.squadBuffs}}})}),{id:b,name:y.name||b,icon:y.icon,stacking:y.stacking??!1,rows:D}}).filter(b=>b.rows.length>0)}},cn=(s,t,a,u,m,b,y={})=>{var d,g,N,C;const A=((s==null?void 0:s[t])||[]).find(w=>w.id===a);if(!A)return{generationMs:0,wastedMs:0};const oe=y[an(a)],J=(oe==null?void 0:oe.stacking)??!1,q=((g=(d=A.buffData)==null?void 0:d[0])==null?void 0:g.generation)??0,X=((C=(N=A.buffData)==null?void 0:N[0])==null?void 0:C.wasted)??0;return rn(t,J,q,X,u,m,b)};var Bn={methods:{tiered:{tiers:{shortMs:500,mediumMs:1500,weights:{short:.5,medium:1,long:2}}}}};const Nn=Bn,Ge="count",In=s=>(s||0)/1e3,Pn=(s,t)=>{var m;if(!s)return 0;const a=(m=Nn.methods.tiered)==null?void 0:m.tiers;if(!a)return s;const u=t/Math.max(s,1);return u<=a.shortMs?s*a.weights.short:u<=a.mediumMs?s*a.weights.medium:s*a.weights.long},ln=(s,t,a)=>a==="duration"?In(t):a==="tiered"?Pn(s,t):s;function Rn(s,t=Ge){var b;const a=(b=s.statsAll)==null?void 0:b[0],u=Number((a==null?void 0:a.appliedCrowdControl)??0),m=Number((a==null?void 0:a.appliedCrowdControlDuration)??0);return ln(u,m,t)}function Un(s,t){const a=(t==null?void 0:t.durationMS)||0,u=(t==null?void 0:t.buffMap)||{},m=s.filter(D=>!D.notInSquad),b=m.length,y=new Map;m.forEach(D=>{const A=D.group??0;y.set(A,(y.get(A)||0)+1)}),m.forEach(D=>{const A=y.get(D.group??0)||1,oe=cn(D,"selfBuffs",1122,a,A,b,u),J=cn(D,"squadBuffs",1122,a,A,b,u);D.stabGeneration=(oe.generationMs+J.generationMs)/1e3})}function qn(s){if(!s.statsTargets)return 0;let t=0;for(const a of s.statsTargets)a&&a.length>0&&(t+=a[0].downContribution||0);return t}function On(s){if(!s.extBarrierStats||!s.extBarrierStats.outgoingBarrierAllies)return 0;let t=0;for(const a of s.extBarrierStats.outgoingBarrierAllies)if(a)for(const u of a)u&&(t+=u.barrier||0);return t}function Ln(s){if(!s.extHealingStats||!s.extHealingStats.outgoingHealingAllies)return 0;let t=0;for(const a of s.extHealingStats.outgoingHealingAllies)if(a)for(const u of a)u&&(t+=u.healing||0);return t}const $n=s=>{var t,a,u,m;return(((a=(t=s.support)==null?void 0:t[0])==null?void 0:a.condiCleanse)||0)+(((m=(u=s.support)==null?void 0:u[0])==null?void 0:m.condiCleanseSelf)||0)},xn=(s,t=Ge)=>{var b;const a=(b=s.support)==null?void 0:b[0],u=Number((a==null?void 0:a.boonStrips)??0),m=Number((a==null?void 0:a.boonStripsTime)??0);return ln(u,m,t)},yn=s=>qn(s),Wn=s=>Ln(s),_n=s=>On(s),Hn=(s,t=Ge)=>Rn(s,t),jn=(s,t)=>Un(s,t),Vn="count",zn={downContribution:1,healing:1,cleanses:1,strips:1,stability:1,cc:.7,revives:.7,distanceToTag:.7,participation:.7,dodging:.4,dps:.2,damage:.2},Kn={showMvp:!0,topSkillDamageSource:"target",topSkillsMetric:"damage"},un=new Map([["bleeding","Bleeding"],["burning","Burning"],["confusion","Confusion"],["poison","Poison"],["torment","Torment"],["vulnerability","Vulnerability"],["weakness","Weakness"],["weakened","Weakness"],["blind","Blind"],["blinded","Blind"],["blinding","Blind"],["cripple","Cripple"],["crippled","Cripple"],["chill","Chill"],["chilled","Chill"],["immob","Immobilize"],["immobile","Immobilize"],["immobilized","Immobilize"],["slow","Slow"],["slowed","Slow"],["fear","Fear"],["feared","Fear"],["taunt","Taunt"],["taunted","Taunt"]]),Gn={Blind:"https://render.guildwars2.com/file/09770136BB76FD0DBE1CC4267DEED54774CB20F6/102837.png",Chill:"https://render.guildwars2.com/file/28C4EC547A3516AF0242E826772DA43A5EAC3DF3/102839.png",Cripple:"https://render.guildwars2.com/file/070325E519C178D502A8160523766070D30C0C19/102838.png",Fear:"https://render.guildwars2.com/file/30307A6E766D74B6EB09EDA12A4A2DE50E4D76F4/102869.png",Immobilize:"https://render.guildwars2.com/file/397A613651BFCA2832B6469CE34735580A2C120E/102844.png",Slow:"https://render.guildwars2.com/file/F60D1EF5271D7B9319610855676D320CD25F01C6/961397.png",Taunt:"https://render.guildwars2.com/file/02EED459AD65FAF7DF32A260E479C625070841B9/1228472.png",Vulnerability:"https://render.guildwars2.com/file/3A394C1A0A3257EB27A44842DDEEF0DF000E1241/102850.png",Weakness:"https://render.guildwars2.com/file/6CB0E64AF9AA292E332A38C1770CE577E2CDE0E8/102853.png"},He=s=>{if(!s)return null;const t=s.trim().toLowerCase(),a=un.get(t);if(a)return a;const u=t.split(/[^a-z]+/).filter(Boolean);for(const m of u){const b=un.get(m);if(b)return b}return null},dn=s=>{const t=new Map;return s&&(Object.values(s).forEach(a=>{if(!(a!=null&&a.icon)||!(a!=null&&a.name))return;const u=He(a.name);u&&(t.has(u)||t.set(u,a.icon))}),Object.entries(Gn).forEach(([a,u])=>{t.has(a)||t.set(a,u)})),t},je=(s,t,a)=>{var u;if(t&&a){const m=(u=a[`b${t}`])==null?void 0:u.name,b=He(m);if(b)return b}return s?He(s):null},Jn=s=>{const t=(s==null?void 0:s.account)||"Unknown";return t&&t!=="Unknown"?t:(s==null?void 0:s.name)||"Unknown"||null},Yn=s=>{if(!s||s.length===0)return 0;let t=0,a=null;return s.forEach(u=>{const m=Number(u[1]??0);if(Number.isFinite(m)){if(a===null){a=m;return}m>a&&(t+=m-a),a=m}}),t},Qn=s=>{if(!s||s.length===0)return 0;let t=0;return s.forEach(a=>{const u=Number(a[0]??0),m=Number(a[1]??0);Number.isFinite(m)&&u!==0&&m>0&&(t+=1)}),t},Xn=s=>{const{players:t,targets:a,skillMap:u,buffMap:m}=s,b=s.getPlayerKey||Jn,y=dn(m),D={},A={};t.forEach(d=>{if(d!=null&&d.notInSquad)return;const g=b(d);g&&(D[g]||(D[g]={}),d!=null&&d.totalDamageDist&&d.totalDamageDist.forEach(N=>{N&&N.forEach(C=>{if(!C.id)return;let w=`Skill ${C.id}`,te;u&&(u[`s${C.id}`]?(w=u[`s${C.id}`].name||w,te=u[`s${C.id}`].icon||te):u[`${C.id}`]&&(w=u[`${C.id}`].name||w,te=u[`${C.id}`].icon||te));const F=je(w,C.id,m);if(!F)return;const W=m==null?void 0:m[`b${C.id}`],j=W==null?void 0:W.name,V=y.get(F)||(W==null?void 0:W.icon),L=w.startsWith("Skill ")?j||F:w,M=te||(W==null?void 0:W.icon),re=Number(C.connectedHits??0),_=Number(C.hits??0),I=re>0?re:_,ie=Number(C.totalDamage??0);if(!Number.isFinite(I)&&!Number.isFinite(ie))return;const Z=A[F]||{name:F,icon:V,applications:0,damage:0};Z.applications+=Number.isFinite(I)?I:0,Z.damage+=Number.isFinite(ie)?ie:0,!Z.icon&&V&&(Z.icon=V),A[F]=Z;const Y=D[g][F]||{icon:V,applications:0,damage:0,skills:{}};Y.applications+=Number.isFinite(I)?I:0,Y.damage+=Number.isFinite(ie)?ie:0;const P=Y.skills[L]||{name:L,hits:0,damage:0,icon:M};P.hits+=Number.isFinite(I)?I:0,P.damage+=Number.isFinite(ie)?ie:0,!P.icon&&M&&(P.icon=M),Y.skills[L]=P,!Y.icon&&V&&(Y.icon=V),D[g][F]=Y})}))});const oe=new Map;t.forEach(d=>{if(d!=null&&d.notInSquad)return;const g=b(d);g&&d!=null&&d.name&&oe.set(d.name,g)});let J=0,q=0,X=0;return a.forEach(d=>{d!=null&&d.buffs&&d.buffs.forEach(g=>{const N=Number(g==null?void 0:g.id);if(!Number.isFinite(N))return;const C=m==null?void 0:m[`b${N}`];if((C==null?void 0:C.classification)!=="Condition")return;const w=(C==null?void 0:C.name)||He(C==null?void 0:C.name);if(!w)return;const te=g.statesPerSource||{};X+=1,Object.entries(te).forEach(([F,W])=>{var _;const j=oe.get(F);if(!j)return;q+=1;const V=Yn(W),L=Qn(W);J+=V;const M=((_=D[j])==null?void 0:_[w])||{applications:0,damage:0,skills:{}};M.applicationsFromBuffs=(M.applicationsFromBuffs||0)+V,M.applicationsFromBuffsActive=(M.applicationsFromBuffsActive||0)+L,D[j]=D[j]||{},D[j][w]=M;const re=A[w]||{name:w,applications:0,damage:0};re.applicationsFromBuffs=(re.applicationsFromBuffs||0)+V,re.applicationsFromBuffsActive=(re.applicationsFromBuffsActive||0)+L,A[w]=re})})}),Object.values(D).forEach(d=>{Object.values(d).forEach(g=>{typeof g.applicationsFromBuffs=="number"&&(g.applications=g.applicationsFromBuffs)})}),Object.values(A).forEach(d=>{typeof d.applicationsFromBuffs=="number"&&(d.applications=d.applicationsFromBuffs)}),{playerConditions:D,summary:A,meta:{buffStateApplicationsTotal:J,targetBuffEntriesSeen:X,buffStateSourcesSeen:q}}},Zn=[{id:"damage",label:"Damage",field:"damage",source:"dpsAll"},{id:"directDmg",label:"Direct Damage",field:"directDmg",source:"statsTargets"},{id:"connectedDamageCount",label:"Connected Damage Count",field:"connectedDamageCount",source:"statsTargets"},{id:"connectedDirectDamageCount",label:"Connected Direct Damage Count",field:"connectedDirectDamageCount",source:"statsTargets"},{id:"battleStandardHits",label:"Battle Standard Tracking"},{id:"criticalRate",label:"Critical Rate",field:"criticalRate",isRate:!0,isPercent:!0,denomField:"critableDirectDamageCount",source:"statsTargets"},{id:"criticalDmg",label:"Critical Damage",field:"criticalDmg",source:"statsTargets"},{id:"flankingRate",label:"Flanking Rate",field:"flankingRate",isRate:!0,isPercent:!0,denomField:"connectedDirectDamageCount",source:"statsTargets"},{id:"glanceRate",label:"Glance Rate",field:"glanceRate",isRate:!0,isPercent:!0,denomField:"connectedDirectDamageCount",source:"statsTargets"},{id:"missed",label:"Missed",field:"missed",source:"statsTargets"},{id:"evaded",label:"Evaded (enemy)",field:"evaded",source:"statsTargets"},{id:"blocked",label:"Blocked (enemy)",field:"blocked",source:"statsTargets"},{id:"interrupts",label:"Interrupts",field:"interrupts",source:"statsTargets"},{id:"invulned",label:"Invulned",field:"invulned",source:"statsTargets"},{id:"killed",label:"Killed",field:"killed",source:"statsTargets"},{id:"downed",label:"Downed",field:"downed",source:"statsTargets"},{id:"downContribution",label:"Down Contribution",field:"downContribution",source:"statsTargets"},{id:"downContributionPercent",label:"Down Contribution %",isRate:!0,isPercent:!0},{id:"againstDownedDamage",label:"Against Downed Damage",field:"againstDownedDamage",source:"statsTargets"},{id:"appliedCrowdControl",label:"Applied CC",field:"appliedCrowdControl",source:"statsTargets"},{id:"appliedCrowdControlDuration",label:"Applied CC Duration",field:"appliedCrowdControlDuration",source:"statsTargets"},{id:"appliedCrowdControlDownContribution",label:"Applied CC Down Contribution",field:"appliedCrowdControlDownContribution",source:"statsTargets"},{id:"appliedCrowdControlDurationDownContribution",label:"Applied CC Duration Down Contribution",field:"appliedCrowdControlDurationDownContribution",source:"statsTargets"}],eo=[{id:"damageTaken",label:"Damage Taken",field:"damageTaken"},{id:"damageTakenCount",label:"Damage Taken Count",field:"damageTakenCount"},{id:"conditionDamageTaken",label:"Condition Damage Taken",field:"conditionDamageTaken"},{id:"conditionDamageTakenCount",label:"Condition Damage Taken Count",field:"conditionDamageTakenCount"},{id:"powerDamageTaken",label:"Power Damage Taken",field:"powerDamageTaken"},{id:"powerDamageTakenCount",label:"Power Damage Taken Count",field:"powerDamageTakenCount"},{id:"downedDamageTaken",label:"Downed Damage Taken",field:"downedDamageTaken"},{id:"downedDamageTakenCount",label:"Downed Damage Taken Count",field:"downedDamageTakenCount"},{id:"damageBarrier",label:"Damage Barrier",field:"damageBarrier"},{id:"damageBarrierCount",label:"Damage Barrier Count",field:"damageBarrierCount"},{id:"blockedCount",label:"Blocked Count",field:"blockedCount"},{id:"evadedCount",label:"Evaded Count",field:"evadedCount"},{id:"missedCount",label:"Missed Count",field:"missedCount"},{id:"dodgeCount",label:"Dodge Count",field:"dodgeCount"},{id:"invulnedCount",label:"Invulnerable Count",field:"invulnedCount"},{id:"interruptedCount",label:"Interrupted Count",field:"interruptedCount"},{id:"downCount",label:"Down Count",field:"downCount"},{id:"deadCount",label:"Death Count",field:"deadCount"},{id:"boonStrips",label:"Boon Strips (Incoming)",field:"boonStrips"},{id:"conditionCleanses",label:"Cleanses (Incoming)",field:"conditionCleanses"},{id:"receivedCrowdControl",label:"Crowd Control (Incoming)",field:"receivedCrowdControl"}],no=[{id:"condiCleanse",label:"Condition Cleanses",field:"condiCleanse"},{id:"condiCleanseTime",label:"Condition Cleanse Time",field:"condiCleanseTime",isTime:!0},{id:"condiCleanseSelf",label:"Condition Cleanse Self",field:"condiCleanseSelf"},{id:"condiCleanseTimeSelf",label:"Condition Cleanse Time Self",field:"condiCleanseTimeSelf",isTime:!0},{id:"boonStrips",label:"Boon Strips",field:"boonStrips"},{id:"boonStripsTime",label:"Boon Strips Time",field:"boonStripsTime",isTime:!0},{id:"boonStripDownContribution",label:"Boon Strip Down Contribution",field:"boonStripDownContribution"},{id:"boonStripDownContributionTime",label:"Boon Strip Down Contribution Time",field:"boonStripDownContributionTime",isTime:!0},{id:"stunBreak",label:"Stun Breaks",field:"stunBreak"},{id:"removedStunDuration",label:"Removed Stun Duration",field:"removedStunDuration",isTime:!0},{id:"resurrects",label:"Resurrects",field:"resurrects"},{id:"resurrectTime",label:"Resurrect Time",field:"resurrectTime",isTime:!0}],oo=["battle standard","glyph of renewal","glyph of the stars","illusion of life","spirit of nature","nature spirit","search and rescue","signet of mercy"],to=new Set([10244]),so=(s,t)=>{var m;if(to.has(s))return!0;const a=(t==null?void 0:t[`s${s}`])||(t==null?void 0:t[`${s}`]),u=((m=a==null?void 0:a.name)==null?void 0:m.toLowerCase())||"";return oo.some(b=>u.includes(b))},io=s=>{if(!s||!Number.isFinite(s))return"--:--";const t=Math.max(0,Math.round(s/1e3)),a=Math.floor(t/3600),u=Math.floor(t%3600/60),m=t%60;return a>0?`${a}:${String(u).padStart(2,"0")}:${String(m).padStart(2,"0")}`:`${u}:${String(m).padStart(2,"0")}`},Je={Guardian:"#72C1D9",Dragonhunter:"#72C1D9",Firebrand:"#72C1D9",Willbender:"#72C1D9",Revenant:"#D16E5A",Herald:"#D16E5A",Renegade:"#D16E5A",Vindicator:"#D16E5A",Warrior:"#FFD166",Berserker:"#FFD166",Spellbreaker:"#FFD166",Bladesworn:"#FFD166",Engineer:"#D09C59",Scrapper:"#D09C59",Holosmith:"#D09C59",Mechanist:"#D09C59",Ranger:"#8CDC82",Druid:"#8CDC82",Soulbeast:"#8CDC82",Untamed:"#8CDC82",Thief:"#C08F95",Daredevil:"#C08F95",Deadeye:"#C08F95",Specter:"#C08F95",Elementalist:"#F68A87",Tempest:"#F68A87",Weaver:"#F68A87",Catalyst:"#F68A87",Mesmer:"#B679D5",Chronomancer:"#B679D5",Mirage:"#B679D5",Virtuoso:"#B679D5",Necromancer:"#52A76F",Reaper:"#52A76F",Scourge:"#52A76F",Harbinger:"#52A76F",Ritualist:"#52A76F",Luminary:"#72C1D9",Conduit:"#D16E5A",Paragon:"#FFD166",Amalgam:"#D09C59",Galeshot:"#8CDC82",Antiquary:"#C08F95",Evoker:"#F68A87",Troubadour:"#B679D5",Unknown:"#64748B"};function fn(s){return Je[s]||Je.Unknown}const ao=({logs:s,precomputedStats:t,mvpWeights:a,statsViewSettings:u,disruptionMethod:m})=>{const b=(()=>{const J=s.filter(q=>q.details&&q.details.players&&q.details.players.length>0);return console.log("[useStatsAggregation] Filtering logs:",{total:s.length,passed:J.length,statuses:s.map(q=>q.status),hasDetails:s.map(q=>!!q.details)}),J})(),y=u||Kn,D=a||zn,A=(()=>{if(t)return t;const J=m||Vn,q=y.topSkillDamageSource||"target",X=y.topSkillsMetric||"damage",d=b.length;let g=0,N=0,C=0,w=0,te=0,F=0,W=0,j=0;const V=e=>{const o=((e==null?void 0:e.players)||[]).filter(O=>!O.notInSquad);let p=0,f=0,k=0,v=0;return o.forEach(O=>{var Q;const se=(Q=O.defenses)==null?void 0:Q[0];if(!se)return;const ce=Number(se.downCount||0),ee=Number(se.deadCount||0);p+=ce+ee,k+=ee}),o.forEach(O=>{!O.statsTargets||O.statsTargets.length===0||O.statsTargets.forEach(se=>{const ce=se==null?void 0:se[0];if(!ce)return;const ee=Number(ce.downed||0),Q=Number(ce.killed||0);f+=ee+Q,v+=Q})}),{squadDownsDeaths:p,enemyDownsDeaths:f,squadDeaths:k,enemyDeaths:v}},L=e=>{const{squadDownsDeaths:n,enemyDownsDeaths:o}=V(e);return n>0||o>0?o>n:typeof(e==null?void 0:e.success)=="boolean"?e.success:!1},M=new Map,re=new Set(["boonStripsTime","condiCleanseTime","condiCleanseTimeSelf"]),_={},I={},ie={},Z={},Y={},P=new Map,ke=new Map,Me=new Set(Object.keys(Je)),Ve=["Guardian","Revenant","Warrior","Engineer","Ranger","Thief","Elementalist","Mesmer","Necromancer"],_e=e=>{if(!e)return"Unknown";const n=String(e).replace(/\s\d+$/,"");if(Me.has(n))return n;const o=n.toLowerCase();return Ve.find(f=>o.includes(f.toLowerCase()))||n||"Unknown"},ze=e=>e!=null&&e.classification?e.classification==="Boon":!0;console.log("[useStatsAggregation] Starting aggregation loop",{validLogsCount:b.length}),b.forEach((e,n)=>{var xe,Ue;const o=e.details;if(!o)return;const p=o.players;console.log(`[useStatsAggregation] Processing log ${n}:`,{playerCount:p==null?void 0:p.length,hasTargets:!!o.targets,firstPlayer:p!=null&&p[0]?{account:p[0].account,notInSquad:p[0].notInSquad}:"none"});const f=o.targets||[],k=o.combatReplayMetaData||{},v=(k==null?void 0:k.inchToPixel)>0?k.inchToPixel:1,O=(k==null?void 0:k.pollingRate)>0?k.pollingRate:1,se=5e3,ce=i=>Array.isArray(i)?i.map(h=>Array.isArray(h)?[Number(h[0]),Number(h[1])]:null).filter(h=>!!h&&Number.isFinite(h[0])):[];let ee=[],Q=o.durationMS||0,Ae=!1;const ge=p.find(i=>(i==null?void 0:i.hasCommanderTag)&&!(i!=null&&i.notInSquad));(xe=ge==null?void 0:ge.combatReplayData)!=null&&xe.positions&&(ee=ge.combatReplayData.positions,ce(ge.combatReplayData.dead).forEach(([h])=>{h>0&&(Ae=!0,Q=Math.min(Q,h))}));const Ie=i=>{var de;const h=(de=i.statsAll)==null?void 0:de[0];if((h==null?void 0:h.distToCom)!==void 0&&(h==null?void 0:h.distToCom)!=="Infinity")return Math.round(Number(h.distToCom));if((h==null?void 0:h.stackDist)!==void 0)return Math.round(Number(h.stackDist))||0;if(i.hasCommanderTag)return 0;const E=i.combatReplayData;if(!(E!=null&&E.positions)||!ee.length)return 0;const he=E.positions,l=ce(E.dead),x=ce(E.down),ne=Math.floor((E.start||0)/O);let G=0;if(l.length&&x.length)for(const[ae]of l){if(ae<0)continue;const Pe=Math.max(0,Math.floor(ae/O))-ne;for(const[Te,De]of x){if(ae!==De)continue;const Fe=Ae&&Te>Q?Math.max(1,Math.floor(Q/O)):Pe,fe=Math.max(0,Math.min(Fe,he.length,ee.length));if(fe<=0)continue;let Se=0;for(let ve=0;ve<fe;ve++){const[qe,Oe]=he[ve],[Le,r]=ee[ve];Se+=Math.hypot(qe-Le,Oe-r)}G=Math.round(Se/fe/v)}}return G},le=p.filter(i=>!i.notInSquad),on=p.filter(i=>i.notInSquad);C+=le.length,w+=f.filter(i=>!i.isFake).length,jn(p,{durationMS:o.durationMS,buffMap:o.buffMap});const{squadDeaths:S,enemyDeaths:K}=V(o);te+=S,F+=K,j+=S,W+=K,L(o)?g++:N++;const H=o.skillMap?Number((Ue=Object.keys(o.skillMap).find(i=>{var h,E;return((E=(h=o.skillMap)==null?void 0:h[i])==null?void 0:E.name)==="Battle Standard"}))==null?void 0:Ue.replace(/^s/,"")):null;p.forEach(i=>{var Te,De,Fe,fe,Se,ve,qe,Oe,Le;if(i.notInSquad)return;const h=i.account||"Unknown",E=h!=="Unknown"?h:i.name||"Unknown",he=i.name||"Unknown";M.has(E)||M.set(E,{name:he,account:E,downContrib:0,cleanses:0,strips:0,stab:0,healing:0,barrier:0,cc:0,logsJoined:0,totalDist:0,distCount:0,dodges:0,downs:0,deaths:0,totalFightMs:0,offenseTotals:{},offenseRateWeights:{},defenseActiveMs:0,defenseTotals:{},supportActiveMs:0,supportTotals:{},healingActiveMs:0,healingTotals:{},profession:i.profession||"Unknown",professions:new Set,professionTimeMs:{},isCommander:!1,damage:0,dps:0,revives:0,outgoingConditions:{},incomingConditions:{}});const l=M.get(E);if(i.hasCommanderTag&&(l.isCommander=!0),i.profession&&i.profession!=="Unknown"){l.profession=i.profession,l.professions.add(i.profession);const r=Array.isArray(i.activeTimes)&&typeof i.activeTimes[0]=="number"?i.activeTimes[0]:o.durationMS||0;l.professionTimeMs[i.profession]=(l.professionTimeMs[i.profession]||0)+r}l.logsJoined++,l.downContrib+=yn(i),l.cleanses+=$n(i),l.strips+=xn(i,J),l.healing+=Wn(i),l.barrier+=_n(i),l.cc+=Hn(i,J),l.stab+=i.stabGeneration||0;const x=Ie(i);x<=se&&(l.totalDist+=x,l.distCount++),(Te=i.defenses)!=null&&Te[0]&&(l.dodges+=i.defenses[0].dodgeCount||0,l.downs+=i.defenses[0].downCount||0,l.deaths+=i.defenses[0].deadCount||0),o.durationMS&&(l.totalFightMs+=o.durationMS);const ne=Array.isArray(i.activeTimes)&&typeof i.activeTimes[0]=="number"?i.activeTimes[0]:o.durationMS||0;l.defenseActiveMs+=ne,l.supportActiveMs+=ne,l.healingActiveMs+=ne,Array.isArray(i.buffUptimes)&&i.buffUptimes.length>0&&i.buffUptimes.forEach(r=>{var kn,Mn,En,An;if(typeof(r==null?void 0:r.id)!="number")return;const c=`b${r.id}`,T=((kn=o.buffMap)==null?void 0:kn[c])||((Mn=o.buffMap)==null?void 0:Mn[String(r.id)]);if(!T||ze(T))return;const U=Number(((An=(En=r.buffData)==null?void 0:En[0])==null?void 0:An.uptime)??0);if(!Number.isFinite(U)||U<=0)return;const we=(T==null?void 0:T.stacking)??!1,Be=(we?U:U/100)*ne;if(!Number.isFinite(Be)||Be<=0)return;P.has(c)||P.set(c,{name:T==null?void 0:T.name,stacking:we,icon:T==null?void 0:T.icon}),ke.has(c)||ke.set(c,new Map);const Re=ke.get(c),Ne=l.account||i.account||i.name||"Unknown";let pe=Re.get(Ne);pe||(pe={account:Ne,profession:l.profession||i.profession||"Unknown",professions:new Set,professionTimeMs:{},totalMs:0,durationMs:0},Re.set(Ne,pe));const We=i.profession||l.profession;We&&We!=="Unknown"&&(pe.professions.add(We),pe.professionTimeMs[We]=(pe.professionTimeMs[We]||0)+ne,pe.profession=We),pe.totalMs+=Be,pe.durationMs+=ne}),(De=i.defenses)!=null&&De[0]&&eo.forEach(r=>{const c=Number(i.defenses[0][r.field]??0);Number.isFinite(c)&&(l.defenseTotals[r.id]=(l.defenseTotals[r.id]||0)+c)}),(Fe=i.support)!=null&&Fe[0]&&no.forEach(r=>{let c=Number(i.support[0][r.field]??0);Number.isFinite(c)&&(re.has(r.field)&&c>999999&&(c=0),l.supportTotals[r.id]=(l.supportTotals[r.id]||0)+c)});const G=(r,c)=>{Number.isFinite(c)&&(l.healingTotals[r]=(l.healingTotals[r]||0)+c)};if(Array.isArray(i.rotation)){let r=0;i.rotation.forEach(c=>{var U;if(!(c!=null&&c.id)||!so(c.id,o.skillMap))return;const T=((U=c.skills)==null?void 0:U.length)||0;T>0&&(r+=T,G(`resUtility_s${c.id}`,T))}),r>0&&G("resUtility",r)}const de=(fe=i.statsAll)==null?void 0:fe[0],ae=(Se=i.dpsAll)==null?void 0:Se[0];if(Zn.forEach(r=>{if(r.id==="downContributionPercent"||!r.field)return;let c=0,T=0;r.source==="dpsAll"&&ae?c=Number(ae[r.field]??0):r.source==="statsAll"&&de?(c=Number(de[r.field]??0),T=Number(de[r.denomField||r.weightField||"connectedDamageCount"]??0)):i.statsTargets&&i.statsTargets.forEach(U=>{U!=null&&U[0]&&(c+=Number(U[0][r.field]??0),T+=Number(U[0][r.denomField||r.weightField||"connectedDamageCount"]??0))}),Number.isFinite(c)&&(l.offenseTotals[r.id]=(l.offenseTotals[r.id]||0)+c,r.isRate&&T>0&&(l.offenseRateWeights[r.id]=(l.offenseRateWeights[r.id]||0)+T))}),i.targetDamageDist&&Number.isFinite(H)){const r=i.targetDamageDist.flatMap(c=>c||[]).flatMap(c=>c||[]).reduce((c,T)=>T!=null&&T.id&&T.id===H?c+((T==null?void 0:T.connectedHits)||0):c,0);l.offenseTotals.battleStandardHits=(l.offenseTotals.battleStandardHits||0)+r}l.revives+=((qe=(ve=i.support)==null?void 0:ve[0])==null?void 0:qe.resurrects)||0,ae&&(l.damage+=ae.damage||0,l.dps+=ae.dps||0);const Pe=r=>{var we,ye,Be,Re;if(!(r!=null&&r.id))return;let c=`Skill ${r.id}`;const T=((we=o.skillMap)==null?void 0:we[`s${r.id}`])||((ye=o.skillMap)==null?void 0:ye[`${r.id}`]);let U=T==null?void 0:T.icon;if(T!=null&&T.name&&(c=T.name),c.startsWith("Skill ")){const Ne=je(c,r.id,o.buffMap);Ne&&(c=Ne,U=((Re=(Be=o.buffMap)==null?void 0:Be[`b${r.id}`])==null?void 0:Re.icon)||U)}_[r.id]||(_[r.id]={name:c,icon:U,damage:0,hits:0,downContribution:0}),(!_[r.id].name.startsWith("Skill ")||c.startsWith("Skill "))&&(_[r.id].name=c),!_[r.id].icon&&U&&(_[r.id].icon=U),_[r.id].damage+=r.totalDamage,_[r.id].hits+=r.connectedHits,_[r.id].downContribution+=Number(r.downContribution||0)};q==="total"?(Oe=i.totalDamageDist)==null||Oe.forEach(r=>{r==null||r.forEach(c=>{Pe(c)})}):(Le=i.targetDamageDist)==null||Le.forEach(r=>{r==null||r.forEach(c=>{c==null||c.forEach(T=>{Pe(T)})})}),i.totalDamageTaken&&i.totalDamageTaken.forEach(r=>{r==null||r.forEach(c=>{var ye,Be,Re,Ne;if(!(c!=null&&c.id))return;let T=`Skill ${c.id}`;const U=((ye=o.skillMap)==null?void 0:ye[`s${c.id}`])||((Be=o.skillMap)==null?void 0:Be[`${c.id}`]);let we=U==null?void 0:U.icon;if(U!=null&&U.name&&(T=U.name),T.startsWith("Skill ")){const pe=je(T,c.id,o.buffMap);pe&&(T=pe,we=((Ne=(Re=o.buffMap)==null?void 0:Re[`b${c.id}`])==null?void 0:Ne.icon)||we)}I[c.id]||(I[c.id]={name:T,icon:we,damage:0,hits:0}),(!I[c.id].name.startsWith("Skill ")||T.startsWith("Skill "))&&(I[c.id].name=T),!I[c.id].icon&&we&&(I[c.id].icon=we),I[c.id].damage+=c.totalDamage,I[c.id].hits+=c.hits})})}),on.forEach(i=>{const h=_e(i.profession||i.name);h&&(Y[h]=(Y[h]||0)+1)});const $=Xn({players:p,targets:f,skillMap:o.skillMap,buffMap:o.buffMap,getPlayerKey:i=>i.account&&i.account!=="Unknown"?i.account:i.name||null}),ue=dn(o.buffMap);Object.entries($.playerConditions).forEach(([i,h])=>{const E=M.get(i);E&&Object.entries(h).forEach(([he,l])=>{const x=E.outgoingConditions[he]||{applications:0,damage:0,skills:{},icon:l.icon};x.applications+=Number(l.applications||0),x.damage+=Number(l.damage||0),l.applicationsFromBuffs&&(x.applicationsFromBuffs=(x.applicationsFromBuffs||0)+l.applicationsFromBuffs),l.applicationsFromBuffsActive&&(x.applicationsFromBuffsActive=(x.applicationsFromBuffsActive||0)+l.applicationsFromBuffsActive),Object.entries(l.skills||{}).forEach(([ne,G])=>{const de=x.skills[ne]||{name:G.name,hits:0,damage:0,icon:G.icon};de.hits+=Number(G.hits||0),de.damage+=Number(G.damage||0),!de.icon&&G.icon&&(de.icon=G.icon),x.skills[ne]=de}),!x.icon&&l.icon&&(x.icon=l.icon),E.outgoingConditions[he]=x})}),Object.entries($.summary).forEach(([i,h])=>{const E=ie[i]||{name:h.name||i,icon:h.icon,applications:0,damage:0};E.applications+=Number(h.applications||0),E.damage+=Number(h.damage||0),h.applicationsFromBuffs&&(E.applicationsFromBuffs=(E.applicationsFromBuffs||0)+h.applicationsFromBuffs),h.applicationsFromBuffsActive&&(E.applicationsFromBuffsActive=(E.applicationsFromBuffsActive||0)+h.applicationsFromBuffsActive),!E.icon&&h.icon&&(E.icon=h.icon),ie[i]=E}),le.forEach(i=>{const h=i.account&&i.account!=="Unknown"?i.account:i.name||"Unknown",E=M.get(h);!E||!i.totalDamageTaken||i.totalDamageTaken.forEach(he=>he==null?void 0:he.forEach(l=>{var ve,qe,Oe,Le,r,c;if(!(l!=null&&l.id))return;let x=`Skill ${l.id}`;const ne=((ve=o.skillMap)==null?void 0:ve[`s${l.id}`])||((qe=o.skillMap)==null?void 0:qe[`${l.id}`]);ne!=null&&ne.name&&(x=ne.name);const G=je(x,l.id,o.buffMap);if(!G)return;const de=(Le=(Oe=o.buffMap)==null?void 0:Oe[`b${l.id}`])==null?void 0:Le.name,ae=ue.get(G)||((c=(r=o.buffMap)==null?void 0:r[`b${l.id}`])==null?void 0:c.icon),Pe=(ne==null?void 0:ne.icon)||ae;x.startsWith("Skill ")&&(de||G)&&(x=de||G);const Te=Number(l.hits??0),De=Number(l.totalDamage??0),Fe=Z[G]||{name:G,icon:ae,applications:0,damage:0};Fe.applications+=Number.isFinite(Te)?Te:0,Fe.damage+=Number.isFinite(De)?De:0,!Fe.icon&&ae&&(Fe.icon=ae),Z[G]=Fe;const fe=E.incomingConditions[G]||{applications:0,damage:0,skills:{},icon:ae};fe.applications+=Number.isFinite(Te)?Te:0,fe.damage+=Number.isFinite(De)?De:0;const Se=fe.skills[x]||{name:x,hits:0,damage:0,icon:Pe};Se.hits+=Number.isFinite(Te)?Te:0,Se.damage+=Number.isFinite(De)?De:0,!Se.icon&&Pe&&(Se.icon=Pe),fe.skills[x]=Se,!fe.icon&&ae&&(fe.icon=ae),E.incomingConditions[G]=fe}))})});const ro=d>0?Math.round(C/d):0,co=d>0?Math.round(w/d):0,lo=te>0?(F/te).toFixed(2):F>0?"∞":"0.00",uo=W>0?(j/W).toFixed(2):j>0?"∞":"0.00",Cn=(e,n)=>{const p=e.filter(v=>Number.isFinite(v.value)&&(n?v.value>0:v.value>=0)).sort((v,O)=>{const se=n?O.value-v.value:v.value-O.value;return se!==0?se:v.account.localeCompare(O.account)});let f=null,k=0;return p.map((v,O)=>((f===null||v.value!==f)&&(k=O+1,f=v.value),{rank:k,...v}))},Xe=Array.from(M.values()).map(e=>{const n=Array.from(e.professions).filter(o=>o!=="Unknown");if(e.professionList=n,n.length>0){let o=n[0],p=e.professionTimeMs[o]||0;n.forEach(f=>{const k=e.professionTimeMs[f]||0;k>p&&(p=k,o=f)}),e.profession=o}return{key:e.account,stat:e}}),Ke=(e,n)=>{switch(n){case"downContrib":return e.downContrib;case"barrier":return e.barrier;case"healing":return e.healing;case"dodges":return e.dodges;case"strips":return e.strips;case"cleanses":return e.cleanses;case"cc":return e.cc;case"stability":return e.stab;case"revives":return e.revives;case"dps":return e.dps;case"damage":return e.damage;case"participation":return e.logsJoined;case"closestToTag":return!e.isCommander&&e.distCount>0?e.totalDist/e.distCount:Number.POSITIVE_INFINITY;default:return 0}},me=(e,n)=>Cn(Xe.map(({stat:o})=>({account:o.account,profession:o.profession,professionList:o.professionList,value:Ke(o,e),count:o.logsJoined})),n),z={downContrib:me("downContrib",!0),barrier:me("barrier",!0),healing:me("healing",!0),dodges:me("dodges",!0),strips:me("strips",!0),cleanses:me("cleanses",!0),cc:me("cc",!0),stability:me("stability",!0),revives:me("revives",!0),participation:me("participation",!0),dps:me("dps",!0),damage:me("damage",!0),closestToTag:me("closestToTag",!1).filter(e=>Number.isFinite(e.value))},fo={downContrib:"downContrib",barrier:"barrier",healing:"healing",dodges:"dodges",strips:"strips",cleanses:"cleanses",cc:"cc",stability:"stability",closestToTag:"closestToTag"},R=e=>{const n=e==null?void 0:e[0];return{value:(n==null?void 0:n.value)??0,player:(n==null?void 0:n.account)??"-",count:(n==null?void 0:n.count)??0,profession:(n==null?void 0:n.profession)??"Unknown",professionList:(n==null?void 0:n.professionList)??[]}},Ee={maxDownContrib:R([]),maxBarrier:R([]),maxHealing:R([]),maxDodges:R([]),maxStrips:R([]),maxCleanses:R([]),maxCC:R([]),maxStab:R([]),closestToTag:R([])},Ce={},mo=(e,n)=>{if(n==="closestToTag")return Ke(e,n);const o=Math.max(1,(e.totalFightMs||0)/1e3);return Ke(e,n)/o};Object.values(fo).forEach(e=>{const n=e!=="closestToTag";Ce[e]=Cn(Xe.map(({stat:o})=>({account:o.account,profession:o.profession,professionList:o.professionList,value:mo(o,e),count:o.logsJoined})),n)}),Ee.maxDownContrib=R(Ce.downContrib),Ee.maxBarrier=R(Ce.barrier),Ee.maxHealing=R(Ce.healing),Ee.maxDodges=R(Ce.dodges),Ee.maxStrips=R(Ce.strips),Ee.maxCleanses=R(Ce.cleanses),Ee.maxCC=R(Ce.cc),Ee.maxStab=R(Ce.stability),Ee.closestToTag=R(Ce.closestToTag);const go={maxDownContrib:R(z.downContrib),maxBarrier:R(z.barrier),maxHealing:R(z.healing),maxDodges:R(z.dodges),maxStrips:R(z.strips),maxCleanses:R(z.cleanses),maxCC:R(z.cc),maxStab:R(z.stability),closestToTag:R(z.closestToTag)};let hn={player:"None",account:"None",score:-1,profession:"Unknown",professionList:[],color:"#64748b",topStats:[]},Tn,Dn,Sn=0;if(y!=null&&y.showMvp){const e=[];if(Xe.forEach(({stat:n})=>{let o=0;const p=[],f=(k,v,O,se,ce=!0)=>{var Q,Ae;if(O<=0)return;const ee=((Q=v[0])==null?void 0:Q.value)||0;if(ee&&Number.isFinite(k)&&(ce?k>0:k<Number.POSITIVE_INFINITY)){const ge=ce?k/ee:ee/k;o+=ge*O;const Ie=((Ae=v.find(le=>le.account===n.account))==null?void 0:Ae.rank)||0;p.push({name:se,ratio:ge,val:k.toLocaleString(),rank:Ie})}};f(n.downContrib,z.downContrib,D.downContribution,"Down Contribution"),f(n.healing,z.healing,D.healing,"Healing"),f(n.cleanses,z.cleanses,D.cleanses,"Cleanses"),f(n.strips,z.strips,D.strips,"Strips"),f(n.stab,z.stability,D.stability,"Stability"),f(n.cc,z.cc,D.cc,"CC"),f(n.revives,z.revives,D.revives,"Revives"),f(Ke(n,"closestToTag"),z.closestToTag,D.distanceToTag,"Distance to Tag",!1),f(n.logsJoined,z.participation,D.participation,"Participation"),f(n.dodges,z.dodges,D.dodging,"Dodging"),f(n.dps,z.dps,D.dps,"DPS"),f(n.damage,z.damage,D.damage,"Damage"),e.push({...n,score:o,contribs:p})}),e.sort((n,o)=>o.score-n.score),e[0]){const n=[...e[0].contribs].sort((o,p)=>p.ratio-o.ratio)[0];hn={...e[0],player:e[0].name,reason:(n==null?void 0:n.name)||"Top Performance",topStats:e[0].contribs.slice(0,3)}}Tn=e[1],Dn=e[2],Sn=e.length>0?e.reduce((n,o)=>n+o.score,0)/e.length:0}const po=Object.values(_).sort((e,n)=>{const o=X==="downContribution"?e.downContribution:e.damage;return(X==="downContribution"?n.downContribution:n.damage)-o}).slice(0,25),bo=Object.values(I).sort((e,n)=>n.damage-e.damage).slice(0,25),Co=e=>{const n=String(e).replace(/^Detailed\s*WvW\s*-\s*/i,"").replace(/^World\s*vs\s*World\s*-\s*/i,"").replace(/^WvW\s*-\s*/i,"").trim(),o=n.match(/^(Red|Blue|Green)\s+(?:Alpine|Desert)?\s*Borderlands$/i);return o?`${o[1]} Borderlands`:n||"Unknown"},wn=(e,n)=>Co((e==null?void 0:e.zone)||(e==null?void 0:e.mapName)||(e==null?void 0:e.map)||(e==null?void 0:e.location)||(e==null?void 0:e.fightName)||(n==null?void 0:n.fightName)||(n==null?void 0:n.encounterName)||"Unknown"),Ze={};b.forEach(e=>{const n=wn(e==null?void 0:e.details,e);Ze[n]=(Ze[n]||0)+1});const ho=Object.entries(Ze).map(([e,n])=>{const o=String(e).trim(),p=/eternal battlegrounds|^ebg$/i.test(o);let f="#64748b";return p?f="#ffffff":/red/i.test(o)?f="#ef4444":/blue/i.test(o)?f="#3b82f6":/green/i.test(o)&&(f="#22c55e"),{name:e,value:n,color:f}}).sort((e,n)=>n.value-e.value),{boonTables:To}=vn(b),Do=b.map((e,n)=>{var p,f,k;const o=((p=e.details)==null?void 0:p.players)||[];return{index:n+1,label:`Log ${n+1}`,timestamp:((f=e.details)==null?void 0:f.uploadTime)||0,squadCount:o.filter(v=>!v.notInSquad).length,friendlyCount:o.length,enemies:((k=e.details)==null?void 0:k.targets).filter(v=>!v.isFake).length}}).sort((e,n)=>e.timestamp-n.timestamp),en={};Array.from(M.values()).forEach(e=>{e.profession&&e.profession!=="Unknown"&&(en[e.profession]=(en[e.profession]||0)+1)});const So=Object.entries(en).map(([e,n])=>({name:e,value:n,color:fn(e)})).sort((e,n)=>n.value-e.value),nn={};Object.keys(Y).length===0&&b.forEach(e=>{var n,o;(o=(n=e.details)==null?void 0:n.targets)==null||o.forEach(p=>{if(p.isFake)return;const f=p.profession&&p.profession!=="Unknown"?p.profession:p.name||p.id||"Unknown",k=_e(f);nn[k]=(nn[k]||0)+1})});const wo=Object.keys(Y).length>0?Y:nn,ko=Object.entries(wo).map(([e,n])=>({name:e,value:n,color:fn(e)})).sort((e,n)=>n.value-e.value).slice(0,10),Mo=b.map((e,n)=>({log:e,originalIndex:n})).sort((e,n)=>{var o,p;return(((o=e.log.details)==null?void 0:o.uploadTime)||0)-(((p=n.log.details)==null?void 0:p.uploadTime)||0)}).map(({log:e},n)=>{const o=e.details;if(!o)return null;const p=o.players||[],f=p.filter(S=>!S.notInSquad),k=p.filter(S=>S.notInSquad),v=o.targets||[],O=v.filter(S=>!S.isFake),se=f.reduce((S,K)=>{var B,H;return S+(((H=(B=K.dpsAll)==null?void 0:B[0])==null?void 0:H.damage)||0)},0),ce=f.reduce((S,K)=>{var B,H;return S+(((H=(B=K.defenses)==null?void 0:B[0])==null?void 0:H.damageTaken)||0)},0),{enemyDeaths:ee,enemyDownsDeaths:Q}=V(o),Ae=L(o),ge=o.uploadTime??e.uploadTime??0,Ie=wn(o,e),le={red:0,green:0,blue:0},on=(S,K)=>{if(S==null)return null;if(typeof S=="string"){const B=S.toLowerCase();return B.includes("red")?"red":B.includes("green")?"green":B.includes("blue")?"blue":B==="r"?"red":B==="g"?"green":B==="b"?"blue":null}if(typeof S=="number")if(K==="zeroBased"){if(S===0)return"red";if(S===1)return"green";if(S===2)return"blue"}else{if(S===1)return"red";if(S===2)return"green";if(S===3)return"blue"}return null};if(o.teamCounts&&typeof o.teamCounts=="object")le.red=Number(o.teamCounts.red||o.teamCounts.r||0),le.green=Number(o.teamCounts.green||o.teamCounts.g||0),le.blue=Number(o.teamCounts.blue||o.teamCounts.b||0);else{const S=[];v.forEach($=>{if($!=null&&$.isFake)return;const ue=$.teamID??$.team??$.teamColor;ue!=null&&S.push(ue)}),p.forEach($=>{if(!($!=null&&$.notInSquad))return;const ue=$.teamID??$.team??$.teamColor;ue!=null&&S.push(ue)});const K=new Set;S.forEach($=>{typeof $=="number"&&K.add($)});const B=K.has(0)?"zeroBased":K.has(3)?"oneBased":"zeroBased";if(S.forEach($=>{const ue=on($,B);ue&&(le[ue]+=1)}),le.red+le.green+le.blue===0&&S.length>0){const $=new Map;S.forEach(xe=>{const Ue=String(xe);$.set(Ue,($.get(Ue)||0)+1)});const ue=Array.from($.values()).sort((xe,Ue)=>Ue-xe);le.red=ue[0]||0,le.green=ue[1]||0,le.blue=ue[2]||0}}return{id:e.filePath||`fight-${n}`,label:e.encounterName||`Fight ${n+1}`,permalink:e.permalink,timestamp:ge,mapName:Ie,duration:io(o.durationMS),isWin:Ae,squadCount:f.length,allyCount:k.length,enemyCount:O.length,teamCounts:le,alliesDown:f.reduce((S,K)=>{var B,H;return S+(((H=(B=K.defenses)==null?void 0:B[0])==null?void 0:H.downCount)||0)},0),alliesDead:f.reduce((S,K)=>{var B,H;return S+(((H=(B=K.defenses)==null?void 0:B[0])==null?void 0:H.deadCount)||0)},0),alliesRevived:f.reduce((S,K)=>{var B,H;return S+(((H=(B=K.statsAll)==null?void 0:B[0])==null?void 0:H.saved)||0)},0),rallies:0,enemyDeaths:ee,enemyDowns:Math.max(0,Q-ee),totalOutgoingDamage:se,totalIncomingDamage:ce,incomingBarrierAbsorbed:f.reduce((S,K)=>{var B,H;return S+(((H=(B=K.defenses)==null?void 0:B[0])==null?void 0:H.damageBarrier)||0)},0),outgoingBarrierAbsorbed:f.reduce((S,K)=>{var B,H;return S+(((H=(B=K.statsAll)==null?void 0:B[0])==null?void 0:H.damageBarrier)||0)},0)}}).filter(Boolean),Eo=Array.from(ke.entries()).map(([e,n])=>{const o=P.get(e)||{},p=Array.from(n.values()).map(f=>{var ee;const k=Array.from(f.professions||[]).filter(Q=>Q&&Q!=="Unknown");let v=f.profession||"Unknown";if(k.length>0){v=k[0];let Q=((ee=f.professionTimeMs)==null?void 0:ee[v])||0;k.forEach(Ae=>{var Ie;const ge=((Ie=f.professionTimeMs)==null?void 0:Ie[Ae])||0;ge>Q&&(Q=ge,v=Ae)})}const O=f.durationMs||0,se=f.totalMs/1e3,ce=O>0?f.totalMs/O:0;return{account:f.account,profession:v,professionList:k,total:se,perSecond:ce,duration:O/1e3}}).filter(f=>f.total>0||f.perSecond>0);return{id:e,name:o.name||e,icon:o.icon,rows:p}}).filter(e=>e.rows.length>0);return{total:d,wins:g,losses:N,avgSquadSize:ro,avgEnemies:co,squadKDR:lo,enemyKDR:uo,totalSquadKills:F,totalSquadDeaths:te,totalEnemyKills:j,totalEnemyDeaths:W,leaderboards:z,...go,outgoingConditionSummary:Object.values(ie).sort((e,n)=>n.damage-e.damage),incomingConditionSummary:Object.values(Z).sort((e,n)=>n.damage-e.damage),outgoingConditionPlayers:Array.from(M.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,conditions:e.outgoingConditions})),incomingConditionPlayers:Array.from(M.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,conditions:e.incomingConditions})),topSkills:po,topIncomingSkills:bo,topSkillsMetric:X,mapData:ho,timelineData:Do,boonTables:To,offensePlayers:Array.from(M.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,offenseTotals:e.offenseTotals,offenseRateWeights:e.offenseRateWeights,totalFightMs:e.totalFightMs})),defensePlayers:Array.from(M.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,defenseTotals:e.defenseTotals,activeMs:e.defenseActiveMs})),supportPlayers:Array.from(M.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,supportTotals:e.supportTotals,activeMs:e.supportActiveMs})),healingPlayers:Array.from(M.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,healingTotals:e.healingTotals,activeMs:e.healingActiveMs})),mvp:hn,silver:Tn,bronze:Dn,squadClassData:So,enemyClassData:ko,fightBreakdown:Mo,specialTables:Eo,topStatsPerSecond:Ee,topStatsLeaderboardsPerSecond:Ce,avgMvpScore:Sn}})(),oe=(()=>{const J=new Map,q=new Map,X=[],d=new Map,g=new Map;b.forEach(C=>{const w=C.details;if(!w)return;const te=w.skillMap||{},F=w.fightName||"Log",W=w.uploadTime??C.uploadTime??Date.now(),j={id:C.filePath||C.id||F,label:F,timestamp:W,skillEntries:{},playerActiveSeconds:{},durationSeconds:w.durationMS?w.durationMS/1e3:0};(w.players||[]).forEach(L=>{if(L.notInSquad)return;const M=L.account||L.name||"Unknown",re=L.profession||"Unknown",_=`${M}|${re}`;let I=q.get(_);I||(I={key:_,account:M,displayName:M,profession:re,professionList:[re],logs:0,totalActiveSeconds:0,skillTotals:{}},q.set(_,I)),I.logs++;const ie=(Array.isArray(L.activeTimes)?L.activeTimes[0]:0)/1e3;I.totalActiveSeconds=(I.totalActiveSeconds||0)+ie,j.playerActiveSeconds[_]=ie,(L.rotation||[]).forEach(Z=>{var Ve,_e,ze;if(!(Z!=null&&Z.id))return;const Y=((Ve=Z.skills)==null?void 0:Ve.length)||0;if(Y<=0)return;const P=`s${Z.id}`,ke=((_e=te[P])==null?void 0:_e.name)||`Skill ${Z.id}`,Me=(ze=te[P])==null?void 0:ze.icon;I.skillTotals[P]=(I.skillTotals[P]||0)+Y,J.set(P,(J.get(P)||0)+Y),d.set(P,ke),Me&&!g.has(P)&&g.set(P,Me),j.skillEntries[P]||(j.skillEntries[P]={name:ke,icon:Me,players:{}}),!j.skillEntries[P].icon&&Me&&(j.skillEntries[P].icon=Me),j.skillEntries[P].players[_]=(j.skillEntries[P].players[_]||0)+Y})}),X.push(j)});const N=Array.from(J.entries()).map(([C,w])=>({id:C,name:d.get(C)||C,total:w,icon:g.get(C)})).sort((C,w)=>w.total-C.total);return{logRecords:X,players:Array.from(q.values()),skillOptions:N,resUtilitySkills:[]}})();return{validLogs:b,stats:A,skillUsageData:oe}};let be=null,$e=!1,mn=null,gn=0,pn=0,Ye=null;const bn=()=>{if(!$e||!be)return;$e=!1,gn+=1;const s=Ye;Ye=null;const t=ao(be);self.postMessage({type:"result",result:t,computeId:gn,logCount:be.logs.length,token:pn,completedAt:Date.now(),flushId:s})},Qe=()=>{mn===null&&(mn=setInterval(()=>{bn()},5e3))};self.onmessage=s=>{var a,u,m,b;const t=s.data;if((t==null?void 0:t.type)==="reset"){be={logs:[]},typeof t.token=="number"&&(pn=t.token),$e=!0,Qe();return}if((t==null?void 0:t.type)==="settings"){be={logs:(be==null?void 0:be.logs)||[],precomputedStats:(a=t.payload)==null?void 0:a.precomputedStats,mvpWeights:(u=t.payload)==null?void 0:u.mvpWeights,statsViewSettings:(m=t.payload)==null?void 0:m.statsViewSettings,disruptionMethod:(b=t.payload)==null?void 0:b.disruptionMethod},$e=!0,Qe();return}if((t==null?void 0:t.type)==="log"){be||(be={logs:[]}),be.logs.push(t.payload),$e=!0,Qe();return}(t==null?void 0:t.type)==="flush"&&(typeof t.flushId=="number"&&(Ye=t.flushId),$e=!0,bn())}})();
