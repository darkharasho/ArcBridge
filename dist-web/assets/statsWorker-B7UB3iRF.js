(function(){"use strict";const Kn=["selfBuffs","groupBuffs","squadBuffs"],Gn=o=>o!=null&&o.classification?o.classification==="Boon":!0,Jn=o=>`b${o}`,It=(o,s)=>{const r=Array.isArray(o==null?void 0:o.activeTimes)?o.activeTimes:[],k=typeof r[0]=="number"?r[0]:0;return k>0?k:s},yn=(o,s,r,k,v,M,ee)=>{const P=o==="selfBuffs"?1:Math.max(o==="groupBuffs"?M-1:ee-1,0);return!P||!v?{generationMs:0,wastedMs:0}:s?{generationMs:r*v*P,wastedMs:k*v*P}:{generationMs:r/100*v*P,wastedMs:k/100*v*P}},Pt=o=>{const s=new Map,r=new Map;return o.forEach(M=>{const ee=M.details;if(!ee)return;const P=ee.durationMS||0,ne=ee.buffMap||{};Object.entries(ne).forEach(([T,E])=>{if(!s.has(T)){s.set(T,E);return}const te=s.get(T)||{},D={name:te.name||E.name,stacking:te.stacking??E.stacking,icon:te.icon||E.icon,classification:te.classification||E.classification};s.set(T,D)});const Re=(ee.players||[]).filter(T=>!T.notInSquad),ae=Re.length,ie=new Map;Re.forEach(T=>{const E=T.group??0;ie.set(E,(ie.get(E)||0)+1)}),Re.forEach(T=>{const E=T.account||T.name||T.character_name||"Unknown",te=T.profession||"Unknown",D=T.group??0,j=ie.get(D)||1,V=It(T,P);r.has(E)||r.set(E,{account:E,profession:te,professions:new Set,professionTimeMs:{},activeTimeMs:0,numFights:0,groupSupported:0,squadSupported:0,boons:{}});const z=r.get(E);z.profession=te,te!=="Unknown"&&(z.professions.add(te),z.professionTimeMs[te]=(z.professionTimeMs[te]||0)+V),z.activeTimeMs+=V,z.numFights+=1,z.groupSupported+=j,z.squadSupported+=ae,Kn.forEach(re=>{(T[re]||[]).forEach(y=>{var ve,Ie,Se,Je;if(typeof(y==null?void 0:y.id)!="number")return;const Ee=Jn(y.id),Ae=ne[Ee];if(!Gn(Ae))return;const de=(Ae==null?void 0:Ae.stacking)??!1,$e=((Ie=(ve=y.buffData)==null?void 0:ve[0])==null?void 0:Ie.generation)??0,ce=((Je=(Se=y.buffData)==null?void 0:Se[0])==null?void 0:Je.wasted)??0,{generationMs:me,wastedMs:Oe}=yn(re,de,$e,ce,P,j,ae);!me&&!Oe||(s.has(Ee)||s.set(Ee,Ae||{}),z.boons[Ee]||(z.boons[Ee]={selfBuffs:{generationMs:0,wastedMs:0},groupBuffs:{generationMs:0,wastedMs:0},squadBuffs:{generationMs:0,wastedMs:0}}),z.boons[Ee][re].generationMs+=me,z.boons[Ee][re].wastedMs+=Oe)})})})}),{boonTables:Array.from(s.keys()).filter(M=>Gn(s.get(M))).map(M=>{const ee=s.get(M)||{},P=[];return r.forEach(ne=>{var T;const Ue=ne.boons[M];if(!Ue||!Kn.some(E=>Ue[E].generationMs>0||Ue[E].wastedMs>0))return;const ae=Array.from(ne.professions||[]).filter(E=>E&&E!=="Unknown");let ie=ne.profession;if(ae.length>0){ie=ae[0];let E=((T=ne.professionTimeMs)==null?void 0:T[ie])||0;ae.forEach(te=>{var j;const D=((j=ne.professionTimeMs)==null?void 0:j[te])||0;D>E&&(E=D,ie=te)})}P.push({account:ne.account,profession:ie||"Unknown",professionList:ae,activeTimeMs:ne.activeTimeMs||1,numFights:ne.numFights||1,groupSupported:ne.groupSupported||1,squadSupported:ne.squadSupported||1,categories:{selfBuffs:{...Ue.selfBuffs},groupBuffs:{...Ue.groupBuffs},squadBuffs:{...Ue.squadBuffs}}})}),{id:M,name:ee.name||M,icon:ee.icon,stacking:ee.stacking??!1,rows:P}}).filter(M=>M.rows.length>0)}},Yn=(o,s,r,k,v,M,ee={})=>{var T,E,te,D;const ne=((o==null?void 0:o[s])||[]).find(j=>j.id===r);if(!ne)return{generationMs:0,wastedMs:0};const Ue=ee[Jn(r)],Re=(Ue==null?void 0:Ue.stacking)??!1,ae=((E=(T=ne.buffData)==null?void 0:T[0])==null?void 0:E.generation)??0,ie=((D=(te=ne.buffData)==null?void 0:te[0])==null?void 0:D.wasted)??0;return yn(s,Re,ae,ie,k,v,M)};var Ut={methods:{tiered:{tiers:{shortMs:500,mediumMs:1500,weights:{short:.5,medium:1,long:2}}}}};const Ht=Ut,Un="count",Lt=o=>(o||0)/1e3,$t=(o,s)=>{var v;if(!o)return 0;const r=(v=Ht.methods.tiered)==null?void 0:v.tiers;if(!r)return o;const k=s/Math.max(o,1);return k<=r.shortMs?o*r.weights.short:k<=r.mediumMs?o*r.weights.medium:o*r.weights.long},Qn=(o,s,r)=>r==="duration"?Lt(s):r==="tiered"?$t(o,s):o;function Ot(o,s=Un){var M;const r=(M=o.statsAll)==null?void 0:M[0],k=Number((r==null?void 0:r.appliedCrowdControl)??0),v=Number((r==null?void 0:r.appliedCrowdControlDuration)??0);return Qn(k,v,s)}function _t(o,s){const r=(s==null?void 0:s.durationMS)||0,k=(s==null?void 0:s.buffMap)||{},v=o.filter(P=>!P.notInSquad),M=v.length,ee=new Map;v.forEach(P=>{const ne=P.group??0;ee.set(ne,(ee.get(ne)||0)+1)}),v.forEach(P=>{const ne=ee.get(P.group??0)||1,Ue=Yn(P,"selfBuffs",1122,r,ne,M,k),Re=Yn(P,"squadBuffs",1122,r,ne,M,k);P.stabGeneration=(Ue.generationMs+Re.generationMs)/1e3})}function Rt(o){if(!o.statsTargets)return 0;let s=0;for(const r of o.statsTargets)r&&r.length>0&&(s+=r[0].downContribution||0);return s}function qt(o){if(!o.extBarrierStats||!o.extBarrierStats.outgoingBarrierAllies)return 0;let s=0;for(const r of o.extBarrierStats.outgoingBarrierAllies)if(r)for(const k of r)k&&(s+=k.barrier||0);return s}function xt(o){if(!o.extHealingStats||!o.extHealingStats.outgoingHealingAllies)return 0;let s=0;for(const r of o.extHealingStats.outgoingHealingAllies)if(r)for(const k of r)k&&(s+=k.healing||0);return s}const Wt=o=>{var s,r,k,v;return(((r=(s=o.support)==null?void 0:s[0])==null?void 0:r.condiCleanse)||0)+(((v=(k=o.support)==null?void 0:k[0])==null?void 0:v.condiCleanseSelf)||0)},jt=(o,s=Un)=>{var M;const r=(M=o.support)==null?void 0:M[0],k=Number((r==null?void 0:r.boonStrips)??0),v=Number((r==null?void 0:r.boonStripsTime)??0);return Qn(k,v,s)},Vt=o=>Rt(o),zt=o=>xt(o),Kt=o=>qt(o),Gt=(o,s=Un)=>Ot(o,s),Jt=(o,s)=>_t(o,s),yt="count",Yt={downContribution:1,healing:1,cleanses:1,strips:1,stability:1,cc:.7,revives:.7,distanceToTag:.7,participation:.7,dodging:.4,dps:.2,damage:.2},Qt={showMvp:!0,topSkillDamageSource:"target",topSkillsMetric:"damage"},Xn=new Map([["bleeding","Bleeding"],["burning","Burning"],["confusion","Confusion"],["poison","Poison"],["torment","Torment"],["vulnerability","Vulnerability"],["weakness","Weakness"],["weakened","Weakness"],["blind","Blind"],["blinded","Blind"],["blinding","Blind"],["cripple","Cripple"],["crippled","Cripple"],["chill","Chill"],["chilled","Chill"],["immob","Immobilize"],["immobile","Immobilize"],["immobilized","Immobilize"],["slow","Slow"],["slowed","Slow"],["fear","Fear"],["feared","Fear"],["taunt","Taunt"],["taunted","Taunt"]]),Xt={Blind:"https://render.guildwars2.com/file/09770136BB76FD0DBE1CC4267DEED54774CB20F6/102837.png",Chill:"https://render.guildwars2.com/file/28C4EC547A3516AF0242E826772DA43A5EAC3DF3/102839.png",Cripple:"https://render.guildwars2.com/file/070325E519C178D502A8160523766070D30C0C19/102838.png",Fear:"https://render.guildwars2.com/file/30307A6E766D74B6EB09EDA12A4A2DE50E4D76F4/102869.png",Immobilize:"https://render.guildwars2.com/file/397A613651BFCA2832B6469CE34735580A2C120E/102844.png",Slow:"https://render.guildwars2.com/file/F60D1EF5271D7B9319610855676D320CD25F01C6/961397.png",Taunt:"https://render.guildwars2.com/file/02EED459AD65FAF7DF32A260E479C625070841B9/1228472.png",Vulnerability:"https://render.guildwars2.com/file/3A394C1A0A3257EB27A44842DDEEF0DF000E1241/102850.png",Weakness:"https://render.guildwars2.com/file/6CB0E64AF9AA292E332A38C1770CE577E2CDE0E8/102853.png"},dn=o=>{if(!o)return null;const s=o.trim().toLowerCase(),r=Xn.get(s);if(r)return r;const k=s.split(/[^a-z]+/).filter(Boolean);for(const v of k){const M=Xn.get(v);if(M)return M}return null},Zt=o=>dn(o),Zn=o=>{const s=new Map;return o&&(Object.values(o).forEach(r=>{if(!(r!=null&&r.icon)||!(r!=null&&r.name))return;const k=dn(r.name);k&&(s.has(k)||s.set(k,r.icon))}),Object.entries(Xt).forEach(([r,k])=>{s.has(r)||s.set(r,k)})),s},Dn=(o,s,r)=>{var k;if(s&&r){const v=(k=r[`b${s}`])==null?void 0:k.name,M=dn(v);if(M)return M}return o?dn(o):null},eo=o=>{const s=(o==null?void 0:o.account)||"Unknown";return s&&s!=="Unknown"?s:(o==null?void 0:o.name)||"Unknown"||null},no=o=>{if(!o||o.length===0)return 0;let s=0,r=null;return o.forEach(k=>{const v=Number(k[1]??0);if(Number.isFinite(v)){if(r===null){r=v;return}v>r&&(s+=v-r),r=v}}),s},to=o=>{if(!o||o.length===0)return 0;let s=0;return o.forEach(r=>{const k=Number(r[0]??0),v=Number(r[1]??0);Number.isFinite(v)&&k!==0&&v>0&&(s+=1)}),s},oo=o=>{const{players:s,targets:r,skillMap:k,buffMap:v}=o,M=o.getPlayerKey||eo,ee=Zn(v),P={},ne={};s.forEach(T=>{if(T!=null&&T.notInSquad)return;const E=M(T);E&&(P[E]||(P[E]={}),T!=null&&T.totalDamageDist&&T.totalDamageDist.forEach(te=>{te&&te.forEach(D=>{if(!D.id)return;let j=`Skill ${D.id}`,V;k&&(k[`s${D.id}`]?(j=k[`s${D.id}`].name||j,V=k[`s${D.id}`].icon||V):k[`${D.id}`]&&(j=k[`${D.id}`].name||j,V=k[`${D.id}`].icon||V));const z=Dn(j,D.id,v);if(!z)return;const re=v==null?void 0:v[`b${D.id}`],Le=re==null?void 0:re.name,y=ee.get(z)||(re==null?void 0:re.icon),Ee=j.startsWith("Skill ")?Le||z:j,Ae=V||(re==null?void 0:re.icon),de=Number(D.connectedHits??0),$e=Number(D.hits??0),ce=de>0?de:$e,me=Number(D.totalDamage??0);if(!Number.isFinite(ce)&&!Number.isFinite(me))return;const Oe=ne[z]||{name:z,icon:y,applications:0,damage:0};Oe.applications+=Number.isFinite(ce)?ce:0,Oe.damage+=Number.isFinite(me)?me:0,!Oe.icon&&y&&(Oe.icon=y),ne[z]=Oe;const ve=P[E][z]||{icon:y,applications:0,damage:0,skills:{}};ve.applications+=Number.isFinite(ce)?ce:0,ve.damage+=Number.isFinite(me)?me:0;const Ie=ve.skills[Ee]||{name:Ee,hits:0,damage:0,icon:Ae};Ie.hits+=Number.isFinite(ce)?ce:0,Ie.damage+=Number.isFinite(me)?me:0,!Ie.icon&&Ae&&(Ie.icon=Ae),ve.skills[Ee]=Ie,!ve.icon&&y&&(ve.icon=y),P[E][z]=ve})}))});const Ue=new Map;s.forEach(T=>{if(T!=null&&T.notInSquad)return;const E=M(T);E&&T!=null&&T.name&&Ue.set(T.name,E)});let Re=0,ae=0,ie=0;return r.forEach(T=>{T!=null&&T.buffs&&T.buffs.forEach(E=>{const te=Number(E==null?void 0:E.id);if(!Number.isFinite(te))return;const D=v==null?void 0:v[`b${te}`],j=dn(D==null?void 0:D.name);if(!j||D!=null&&D.classification&&D.classification!=="Condition")return;const V=j;if(!V)return;const z=E.statesPerSource||{};ie+=1,Object.entries(z).forEach(([re,Le])=>{var ce;const y=Ue.get(re);if(!y)return;ae+=1;const Ee=no(Le),Ae=to(Le);Re+=Ee;const de=((ce=P[y])==null?void 0:ce[V])||{applications:0,damage:0,skills:{}};de.applicationsFromBuffs=(de.applicationsFromBuffs||0)+Ee,de.applicationsFromBuffsActive=(de.applicationsFromBuffsActive||0)+Ae,P[y]=P[y]||{},P[y][V]=de;const $e=ne[V]||{name:V,applications:0,damage:0};$e.applicationsFromBuffs=($e.applicationsFromBuffs||0)+Ee,$e.applicationsFromBuffsActive=($e.applicationsFromBuffsActive||0)+Ae,ne[V]=$e})})}),Object.values(P).forEach(T=>{Object.values(T).forEach(E=>{typeof E.applicationsFromBuffs=="number"&&(E.applications=E.applicationsFromBuffs)})}),Object.values(ne).forEach(T=>{typeof T.applicationsFromBuffs=="number"&&(T.applications=T.applicationsFromBuffs)}),{playerConditions:P,summary:ne,meta:{buffStateApplicationsTotal:Re,targetBuffEntriesSeen:ie,buffStateSourcesSeen:ae}}},io=new Set(["Vulnerability","Weakness","Blind","Cripple","Chill","Immobilize","Slow","Fear","Taunt"]),so=[{id:"damage",label:"Damage",field:"damage",source:"dpsAll"},{id:"directDmg",label:"Direct Damage",field:"directDmg",source:"statsTargets"},{id:"connectedDamageCount",label:"Connected Damage Count",field:"connectedDamageCount",source:"statsTargets"},{id:"connectedDirectDamageCount",label:"Connected Direct Damage Count",field:"connectedDirectDamageCount",source:"statsTargets"},{id:"battleStandardHits",label:"Battle Standard Tracking"},{id:"criticalRate",label:"Critical Rate",field:"criticalRate",isRate:!0,isPercent:!0,denomField:"critableDirectDamageCount",source:"statsTargets"},{id:"criticalDmg",label:"Critical Damage",field:"criticalDmg",source:"statsTargets"},{id:"flankingRate",label:"Flanking Rate",field:"flankingRate",isRate:!0,isPercent:!0,denomField:"connectedDirectDamageCount",source:"statsTargets"},{id:"glanceRate",label:"Glance Rate",field:"glanceRate",isRate:!0,isPercent:!0,denomField:"connectedDirectDamageCount",source:"statsTargets"},{id:"missed",label:"Missed",field:"missed",source:"statsTargets"},{id:"evaded",label:"Evaded (enemy)",field:"evaded",source:"statsTargets"},{id:"blocked",label:"Blocked (enemy)",field:"blocked",source:"statsTargets"},{id:"interrupts",label:"Interrupts",field:"interrupts",source:"statsTargets"},{id:"invulned",label:"Invulned",field:"invulned",source:"statsTargets"},{id:"killed",label:"Killed",field:"killed",source:"statsTargets"},{id:"downed",label:"Downed",field:"downed",source:"statsTargets"},{id:"downContribution",label:"Down Contribution",field:"downContribution",source:"statsTargets"},{id:"downContributionPercent",label:"Down Contribution %",isRate:!0,isPercent:!0},{id:"againstDownedDamage",label:"Against Downed Damage",field:"againstDownedDamage",source:"statsTargets"},{id:"appliedCrowdControl",label:"Applied CC",field:"appliedCrowdControl",source:"statsTargets"},{id:"appliedCrowdControlDuration",label:"Applied CC Duration",field:"appliedCrowdControlDuration",source:"statsTargets"},{id:"appliedCrowdControlDownContribution",label:"Applied CC Down Contribution",field:"appliedCrowdControlDownContribution",source:"statsTargets"},{id:"appliedCrowdControlDurationDownContribution",label:"Applied CC Duration Down Contribution",field:"appliedCrowdControlDurationDownContribution",source:"statsTargets"},{id:"boonStrips",label:"Boon Strips",field:"boonStrips",source:"support"}],ao=[{id:"damageTaken",label:"Damage Taken",field:"damageTaken"},{id:"damageTakenCount",label:"Damage Taken Count",field:"damageTakenCount"},{id:"conditionDamageTaken",label:"Condition Damage Taken",field:"conditionDamageTaken"},{id:"conditionDamageTakenCount",label:"Condition Damage Taken Count",field:"conditionDamageTakenCount"},{id:"powerDamageTaken",label:"Power Damage Taken",field:"powerDamageTaken"},{id:"powerDamageTakenCount",label:"Power Damage Taken Count",field:"powerDamageTakenCount"},{id:"downedDamageTaken",label:"Downed Damage Taken",field:"downedDamageTaken"},{id:"downedDamageTakenCount",label:"Downed Damage Taken Count",field:"downedDamageTakenCount"},{id:"damageBarrier",label:"Damage Barrier",field:"damageBarrier"},{id:"damageBarrierCount",label:"Damage Barrier Count",field:"damageBarrierCount"},{id:"blockedCount",label:"Blocked Count",field:"blockedCount"},{id:"evadedCount",label:"Evaded Count",field:"evadedCount"},{id:"missedCount",label:"Missed Count",field:"missedCount"},{id:"dodgeCount",label:"Dodge Count",field:"dodgeCount"},{id:"invulnedCount",label:"Invulnerable Count",field:"invulnedCount"},{id:"interruptedCount",label:"Interrupted Count",field:"interruptedCount"},{id:"downCount",label:"Down Count",field:"downCount"},{id:"deadCount",label:"Death Count",field:"deadCount"},{id:"boonStrips",label:"Boon Strips (Incoming)",field:"boonStrips"},{id:"conditionCleanses",label:"Cleanses (Incoming)",field:"conditionCleanses"},{id:"receivedCrowdControl",label:"Crowd Control (Incoming)",field:"receivedCrowdControl"}],ro=[{id:"condiCleanse",label:"Condition Cleanses",field:"condiCleanse"},{id:"condiCleanseTime",label:"Condition Cleanse Time",field:"condiCleanseTime",isTime:!0},{id:"condiCleanseSelf",label:"Condition Cleanse Self",field:"condiCleanseSelf"},{id:"condiCleanseTimeSelf",label:"Condition Cleanse Time Self",field:"condiCleanseTimeSelf",isTime:!0},{id:"boonStrips",label:"Boon Strips",field:"boonStrips"},{id:"boonStripsTime",label:"Boon Strips Time",field:"boonStripsTime",isTime:!0},{id:"boonStripDownContribution",label:"Boon Strip Down Contribution",field:"boonStripDownContribution"},{id:"boonStripDownContributionTime",label:"Boon Strip Down Contribution Time",field:"boonStripDownContributionTime",isTime:!0},{id:"stunBreak",label:"Stun Breaks",field:"stunBreak"},{id:"removedStunDuration",label:"Removed Stun Duration",field:"removedStunDuration",isTime:!0},{id:"resurrects",label:"Resurrects",field:"resurrects"},{id:"resurrectTime",label:"Resurrect Time",field:"resurrectTime",isTime:!0}],co=["battle standard","glyph of renewal","glyph of the stars","illusion of life","spirit of nature","nature spirit","search and rescue","signet of mercy"],lo=new Set([10244]),uo=(o,s)=>{var v;if(lo.has(o))return!0;const r=(s==null?void 0:s[`s${o}`])||(s==null?void 0:s[`${o}`]),k=((v=r==null?void 0:r.name)==null?void 0:v.toLowerCase())||"";return co.some(M=>k.includes(M))},mo=o=>{if(!o||!Number.isFinite(o))return"--:--";const s=Math.max(0,Math.round(o/1e3)),r=Math.floor(s/3600),k=Math.floor(s%3600/60),v=s%60;return r>0?`${r}:${String(k).padStart(2,"0")}:${String(v).padStart(2,"0")}`:`${k}:${String(v).padStart(2,"0")}`},Sn={Guardian:"#72C1D9",Dragonhunter:"#72C1D9",Firebrand:"#72C1D9",Willbender:"#72C1D9",Revenant:"#D16E5A",Herald:"#D16E5A",Renegade:"#D16E5A",Vindicator:"#D16E5A",Warrior:"#FFD166",Berserker:"#FFD166",Spellbreaker:"#FFD166",Bladesworn:"#FFD166",Engineer:"#D09C59",Scrapper:"#D09C59",Holosmith:"#D09C59",Mechanist:"#D09C59",Ranger:"#8CDC82",Druid:"#8CDC82",Soulbeast:"#8CDC82",Untamed:"#8CDC82",Thief:"#C08F95",Daredevil:"#C08F95",Deadeye:"#C08F95",Specter:"#C08F95",Elementalist:"#F68A87",Tempest:"#F68A87",Weaver:"#F68A87",Catalyst:"#F68A87",Mesmer:"#B679D5",Chronomancer:"#B679D5",Mirage:"#B679D5",Virtuoso:"#B679D5",Necromancer:"#52A76F",Reaper:"#52A76F",Scourge:"#52A76F",Harbinger:"#52A76F",Ritualist:"#52A76F",Luminary:"#72C1D9",Conduit:"#D16E5A",Paragon:"#FFD166",Amalgam:"#D09C59",Galeshot:"#8CDC82",Antiquary:"#C08F95",Evoker:"#F68A87",Troubadour:"#B679D5",Unknown:"#64748B"};function et(o){return Sn[o]||Sn.Unknown}const fo=o=>{if(o==null||o==="")return 0;if(typeof o=="number")return!Number.isFinite(o)||o<=0?0:o>1e12?o:o*1e3;if(o instanceof Date){const ee=o.getTime();return Number.isFinite(ee)&&ee>0?ee:0}const s=String(o).trim();if(!s)return 0;const r=Number(s);if(Number.isFinite(r)&&r>0)return r>1e12?r:r*1e3;const k=Date.parse(s);if(Number.isFinite(k)&&k>0)return k;const v=s.replace(/([+-]\d{2})$/,"$1:00"),M=Date.parse(v);return Number.isFinite(M)&&M>0?M:0},Ze=(o,s)=>fo((o==null?void 0:o.uploadTime)??(s==null?void 0:s.uploadTime)??(o==null?void 0:o.timeStartStd)??(o==null?void 0:o.timeStart)??(o==null?void 0:o.timeEndStd)??(o==null?void 0:o.timeEnd)??(o==null?void 0:o.timeStartText)??(o==null?void 0:o.timeEndText)),go=({logs:o,precomputedStats:s,mvpWeights:r,statsViewSettings:k,disruptionMethod:v})=>{const M=(()=>{const ae=o.filter(ie=>ie.details&&ie.details.players&&ie.details.players.length>0);return console.log("[useStatsAggregation] Filtering logs:",{total:o.length,passed:ae.length,statuses:o.map(ie=>ie.status),hasDetails:o.map(ie=>!!ie.details)}),ae})(),ee=k||Qt,P=r||Yt,ne=ae=>{if(!ae||typeof ae!="object")return ae;const ie=Array.isArray(ae.fightBreakdown)?ae.fightBreakdown:null;if(!ie||ie.length===0)return ae;const T=new Map,E=new Map;o.forEach(D=>{var z;const j=(D==null?void 0:D.filePath)||(D==null?void 0:D.id);j&&T.set(String(j),D);const V=(D==null?void 0:D.permalink)||((z=D==null?void 0:D.details)==null?void 0:z.permalink);typeof V=="string"&&V.trim()&&E.set(V.trim(),D)});const te=ie.map(D=>{if(!D||typeof D!="object"||Number(D.timestamp)>0)return D;const V=D.id?String(D.id):"",z=typeof D.permalink=="string"?D.permalink.trim():"",re=(V?T.get(V):void 0)||(z?E.get(z):void 0);if(!re)return D;const Le=Ze(re==null?void 0:re.details,re);return Le?{...D,timestamp:Le}:D});return{...ae,fightBreakdown:te}},Ue=(()=>{if(s)return ne(s);const ae=v||yt,ie=ee.topSkillDamageSource||"target",T=ee.topSkillsMetric||"damage",E=M.length;let te=0,D=0,j=0,V=0,z=0,re=0,Le=0,y=0;const Ee=e=>{const t=((e==null?void 0:e.players)||[]).filter(p=>!p.notInSquad);let c=0,a=0,m=0,h=0;return t.forEach(p=>{var H;const f=(H=p.defenses)==null?void 0:H[0];if(!f)return;const w=Number(f.downCount||0),K=Number(f.deadCount||0);c+=w+K,m+=K}),t.forEach(p=>{!p.statsTargets||p.statsTargets.length===0||p.statsTargets.forEach(f=>{const w=f==null?void 0:f[0];if(!w)return;const K=Number(w.downed||0),H=Number(w.killed||0);a+=K+H,h+=H})}),{squadDownsDeaths:c,enemyDownsDeaths:a,squadDeaths:m,enemyDeaths:h}},Ae=e=>{const{squadDownsDeaths:n,enemyDownsDeaths:t}=Ee(e);return n>0||t>0?t>n:typeof(e==null?void 0:e.success)=="boolean"?e.success:!1},de=new Map,$e=new Set(["boonStripsTime","condiCleanseTime","condiCleanseTimeSelf"]),ce={},me={},Oe=new Map,ve={},Ie={},Se={},Je=new Map,Ke=new Map,Tn=new Set(Object.keys(Sn)),An=Object.keys(Sn).filter(e=>e&&e!=="Unknown").sort((e,n)=>n.length-e.length),vn=["Guardian","Revenant","Warrior","Engineer","Ranger","Thief","Elementalist","Mesmer","Necromancer"],cn=e=>{if(!e)return"Unknown";const n=String(e).replace(/\s*\([^)]*\)\s*$/,"").replace(/\s*\[[^\]]*\]\s*$/,"").replace(/\s\d+$/,"").trim();if(Tn.has(n))return n;const t=n.toLowerCase();for(const a of An)if(t.includes(a.toLowerCase()))return a;return vn.find(a=>t.includes(a.toLowerCase()))||n||"Unknown"},bo=e=>e!=null&&e.classification?e.classification==="Boon":!0,wn=new Map,Mn=new Map,mn=()=>({totalHits:0,blocked:0,evaded:0,glanced:0,missed:0,invulned:0,interrupted:0,totalMitigation:0,minMitigation:0}),x=e=>{const n=Number(e);return Number.isFinite(n)?n:0},at=e=>{const n=String(e).split("|"),t=n[0]||"Unknown",c=cn(n[1]||"Unknown"),a=n[2]||t||"Unknown";return{name:t,profession:c,account:a}},rt=(e,n,t)=>{let c=e.get(n);return c?t.profession&&!c.professionList.includes(t.profession)&&c.professionList.push(t.profession):(c={account:t.account,name:t.name,profession:t.profession,professionList:t.profession?[t.profession]:[],activeMs:0,mitigationTotals:mn()},e.set(n,c)),c},ct=(e,n,t)=>{let c=e.get(n);return c?t.profession&&!c.professionList.includes(t.profession)&&c.professionList.push(t.profession):(c={account:t.account,name:t.name,profession:t.profession,professionList:t.profession?[t.profession]:[],activeMs:0,mitigationTotals:mn(),minion:t.minion},e.set(n,c)),c},lt=(e,n)=>{e.totalHits+=x((n==null?void 0:n.skill_hits)??(n==null?void 0:n.skillHits)),e.blocked+=x(n==null?void 0:n.blocked),e.evaded+=x(n==null?void 0:n.evaded),e.glanced+=x(n==null?void 0:n.glanced),e.missed+=x(n==null?void 0:n.missed),e.invulned+=x(n==null?void 0:n.invulned),e.interrupted+=x(n==null?void 0:n.interrupted),e.totalMitigation+=x((n==null?void 0:n.avoided_damage)??(n==null?void 0:n.avoidedDamage)),e.minMitigation+=x((n==null?void 0:n.min_avoided_damage)??(n==null?void 0:n.minAvoidedDamage))},ho=e=>Object.values(e).some(n=>n>0);console.log("[useStatsAggregation] Starting aggregation loop",{validLogsCount:M.length});const Nn=(e,n,t)=>{var m,h,p,f;const c=`s${e}`;if((m=n==null?void 0:n[c])!=null&&m.name)return n[c].name;if((h=n==null?void 0:n[String(e)])!=null&&h.name)return n[String(e)].name;const a=`b${e}`;return(p=t==null?void 0:t[a])!=null&&p.name?t[a].name:(f=t==null?void 0:t[String(e)])!=null&&f.name?t[String(e)].name:`Unknown Skill ${e}`},fn=new Map,tn=e=>{const n=fn.get(e);if(!n)return{hasSkill:!1,avg:1,min:1,hits:0};const t=n.connectedHits||0,c=t>0?n.totalDamage/t:0,a=n.minCount>0?n.minTotal/n.minCount:0;return{hasSkill:!0,avg:c,min:a,hits:t}},En="Ashtonlightstone.9145",ut="Illusionary Warden",$n=[],on=[],On=[],_n=[],dt=new Map,mt=new Map,ft=(e,n,t)=>{const c=e.get(n)||mn();return c.totalHits+=t.totalHits,c.blocked+=t.blocked,c.evaded+=t.evaded,c.glanced+=t.glanced,c.missed+=t.missed,c.invulned+=t.invulned,c.interrupted+=t.interrupted,e.set(n,c),c};M.forEach(e=>{const n=e.details;if(!n)return;(n.targets||[]).forEach(c=>{const a=(c==null?void 0:c.totalDamageDist)||[],m=Array.isArray(a)?a[0]:null;m==null||m.forEach(h=>{if(!(h!=null&&h.id))return;const p=Number(h.id),f=fn.get(p)||{totalDamage:0,connectedHits:0,minTotal:0,minCount:0};f.totalDamage+=Number(h.totalDamage||0),f.connectedHits+=Number(h.connectedHits||0);const w=Number.isFinite(Number(h.min))?Number(h.min):0;f.minTotal+=w,f.minCount+=1,fn.set(p,f)})})}),M.forEach((e,n)=>{var Dt,St;const t=e.details;if(!t)return;const c=t.players;console.log(`[useStatsAggregation] Processing log ${n}:`,{playerCount:c==null?void 0:c.length,hasTargets:!!t.targets,firstPlayer:c!=null&&c[0]?{account:c[0].account,notInSquad:c[0].notInSquad}:"none"});const a=t.targets||[],m=t.skillMap||{},h=t.buffMap||{},p=new Map,f=new Map;a.forEach(i=>{const g=(i==null?void 0:i.totalDamageDist)||[],A=Array.isArray(g)?g[0]:null;A==null||A.forEach(_=>{var Q;if(!(_!=null&&_.id))return;const B=Number(_.id),C=((Q=m==null?void 0:m[B])==null?void 0:Q.name)||_.name||_.skillName||String(B),W=p.get(B)||{totalDamage:0,connectedHits:0,minTotal:0,minCount:0};W.totalDamage+=Number(_.totalDamage||0),W.connectedHits+=Number(_.connectedHits||0);const N=Number.isFinite(Number(_.min))?Number(_.min):0;W.minTotal+=N,W.minCount+=1,p.set(B,W);const $=f.get(C)||{totalDamage:0,connectedHits:0,minTotal:0,minCount:0};$.totalDamage+=Number(_.totalDamage||0),$.connectedHits+=Number(_.connectedHits||0);const pe=Number.isFinite(Number(_.min))?Number(_.min):0;$.minTotal+=pe,$.minCount+=1,f.set(C,$)})});const w=i=>{const g=p.get(i);if(!g||g.connectedHits<=0)return{avg:1,min:1};const A=g.connectedHits>0?g.totalDamage/g.connectedHits:0,_=g.minCount>0?g.minTotal/g.minCount:A;return{avg:A||1,min:_||1}},K=i=>{const g=f.get(i);if(!g||g.connectedHits<=0)return{avg:1,min:1};const A=g.connectedHits>0?g.totalDamage/g.connectedHits:0,_=g.minCount>0?g.minTotal/g.minCount:A;return{avg:A||1,min:_||1}},H=t.combatReplayMetaData||{},Fe=(H==null?void 0:H.inchToPixel)>0?H.inchToPixel:1,Ne=(H==null?void 0:H.pollingRate)>0?H.pollingRate:1,ke=5e3,fe=i=>Array.isArray(i)?i.map(g=>Array.isArray(g)?[Number(g[0]),Number(g[1])]:null).filter(g=>!!g&&Number.isFinite(g[0])):[];let He=[],Pe=t.durationMS||0,S=!1;const F=c.find(i=>(i==null?void 0:i.hasCommanderTag)&&!(i!=null&&i.notInSquad));(Dt=F==null?void 0:F.combatReplayData)!=null&&Dt.positions&&(He=F.combatReplayData.positions,fe(F.combatReplayData.dead).forEach(([g])=>{g>0&&(S=!0,Pe=Math.min(Pe,g))}));const Te=i=>{var $;const g=($=i.statsAll)==null?void 0:$[0];if((g==null?void 0:g.distToCom)!==void 0&&(g==null?void 0:g.distToCom)!=="Infinity")return Math.round(Number(g.distToCom));if((g==null?void 0:g.stackDist)!==void 0)return Math.round(Number(g.stackDist))||0;if(i.hasCommanderTag)return 0;const A=i.combatReplayData;if(!(A!=null&&A.positions)||!He.length)return 0;const _=A.positions,B=fe(A.dead),C=fe(A.down),W=Math.floor((A.start||0)/Ne);let N=0;if(B.length&&C.length)for(const[pe]of B){if(pe<0)continue;const Q=Math.max(0,Math.floor(pe/Ne))-W;for(const[L,X]of C){if(pe!==X)continue;const q=S&&L>Pe?Math.max(1,Math.floor(Pe/Ne)):Q,ue=Math.max(0,Math.min(q,_.length,He.length));if(ue<=0)continue;let G=0;for(let he=0;he<ue;he++){const[U,se]=_[he],[oe,Z]=He[he];G+=Math.hypot(U-oe,se-Z)}N=Math.round(G/ue/Fe)}}return N},ge=c.filter(i=>!i.notInSquad),De=c.filter(i=>i.notInSquad);j+=ge.length,V+=a.filter(i=>!i.isFake).length,Jt(c,{durationMS:t.durationMS,buffMap:t.buffMap});const{squadDeaths:u,enemyDeaths:J}=Ee(t);z+=u,re+=J,y+=u,Le+=J,Ae(t)?te++:D++;const Y=t.skillMap?Number((St=Object.keys(t.skillMap).find(i=>{var g,A;return((A=(g=t.skillMap)==null?void 0:g[i])==null?void 0:A.name)==="Battle Standard"}))==null?void 0:St.replace(/^s/,"")):null;c.forEach((i,g)=>{var ye,Ye,sn,an,In,gn,pn,Tt,At,vt,wt,Mt;if(i.notInSquad)return;const A=i.account||"Unknown",_=A!=="Unknown"?A:i.name||"Unknown",B=i.name||"Unknown";de.has(_)||de.set(_,{name:B,account:_,downContrib:0,cleanses:0,strips:0,stab:0,healing:0,barrier:0,cc:0,logsJoined:0,totalDist:0,distCount:0,dodges:0,downs:0,deaths:0,totalFightMs:0,offenseTotals:{},offenseRateWeights:{},defenseActiveMs:0,defenseTotals:{},supportActiveMs:0,supportTotals:{},healingActiveMs:0,healingTotals:{},profession:i.profession||"Unknown",professions:new Set,professionTimeMs:{},isCommander:!1,damage:0,dps:0,revives:0,outgoingConditions:{},incomingConditions:{}});const C=de.get(_);if(i.hasCommanderTag&&(C.isCommander=!0),i.profession&&i.profession!=="Unknown"){C.profession=i.profession,C.professions.add(i.profession);const l=Array.isArray(i.activeTimes)&&typeof i.activeTimes[0]=="number"?i.activeTimes[0]:t.durationMS||0;C.professionTimeMs[i.profession]=(C.professionTimeMs[i.profession]||0)+l}C.logsJoined++,C.downContrib+=Vt(i),C.cleanses+=Wt(i),C.strips+=jt(i,ae),C.healing+=zt(i),C.barrier+=Kt(i),C.cc+=Gt(i,ae),C.stab+=i.stabGeneration||0;const W=Te(i);W<=ke&&(C.totalDist+=W,C.distCount++),(ye=i.defenses)!=null&&ye[0]&&(C.dodges+=i.defenses[0].dodgeCount||0,C.downs+=i.defenses[0].downCount||0,C.deaths+=i.defenses[0].deadCount||0),t.durationMS&&(C.totalFightMs+=t.durationMS);const N=Array.isArray(i.activeTimes)&&typeof i.activeTimes[0]=="number"?i.activeTimes[0]:t.durationMS||0;C.defenseActiveMs+=N,C.supportActiveMs+=N,C.healingActiveMs+=N,Array.isArray(i.buffUptimes)&&i.buffUptimes.length>0&&i.buffUptimes.forEach(l=>{var Nt,Et,Ft,Bt;if(typeof(l==null?void 0:l.id)!="number")return;const d=`b${l.id}`,b=((Nt=t.buffMap)==null?void 0:Nt[d])||((Et=t.buffMap)==null?void 0:Et[String(l.id)]);if(!b||bo(b))return;const O=Number(((Bt=(Ft=l.buffData)==null?void 0:Ft[0])==null?void 0:Bt.uptime)??0);if(!Number.isFinite(O)||O<=0)return;const we=(b==null?void 0:b.stacking)??!1,xe=(we?O:O/100)*N;if(!Number.isFinite(xe)||xe<=0)return;const Be=Zt(b==null?void 0:b.name);if(Be&&io.has(Be)&&(!(b!=null&&b.classification)||b.classification==="Condition")){const Pn=xe/1e3,je=b==null?void 0:b.icon,bn=ve[Be]||{name:Be,icon:je,applications:0,damage:0};bn.applicationsFromUptime=(bn.applicationsFromUptime||0)+Pn,!bn.icon&&je&&(bn.icon=je),ve[Be]=bn;const hn=C.outgoingConditions[Be]||{applications:0,damage:0,skills:{},icon:je};hn.applicationsFromUptime=(hn.applicationsFromUptime||0)+Pn,!hn.icon&&je&&(hn.icon=je),C.outgoingConditions[Be]=hn;const Cn=Ie[Be]||{name:Be,icon:je,applications:0,damage:0};Cn.applicationsFromUptime=(Cn.applicationsFromUptime||0)+Pn,!Cn.icon&&je&&(Cn.icon=je),Ie[Be]=Cn;const kn=C.incomingConditions[Be]||{applications:0,damage:0,skills:{},icon:je};kn.applicationsFromUptime=(kn.applicationsFromUptime||0)+Pn,!kn.icon&&je&&(kn.icon=je),C.incomingConditions[Be]=kn}Je.has(d)||Je.set(d,{name:b==null?void 0:b.name,stacking:we,icon:b==null?void 0:b.icon}),Ke.has(d)||Ke.set(d,new Map);const nn=Ke.get(d),ln=C.account||i.account||i.name||"Unknown";let Xe=nn.get(ln);Xe||(Xe={account:ln,profession:C.profession||i.profession||"Unknown",professions:new Set,professionTimeMs:{},totalMs:0,durationMs:0},nn.set(ln,Xe));const un=i.profession||C.profession;un&&un!=="Unknown"&&(Xe.professions.add(un),Xe.professionTimeMs[un]=(Xe.professionTimeMs[un]||0)+N,Xe.profession=un),Xe.totalMs+=xe,Xe.durationMs+=N}),(Ye=i.defenses)!=null&&Ye[0]&&ao.forEach(l=>{const d=Number(i.defenses[0][l.field]??0);Number.isFinite(d)&&(C.defenseTotals[l.id]=(C.defenseTotals[l.id]||0)+d)}),(sn=i.support)!=null&&sn[0]&&ro.forEach(l=>{let d=Number(i.support[0][l.field]??0);Number.isFinite(d)&&($e.has(l.field)&&d>999999&&(d=0),C.supportTotals[l.id]=(C.supportTotals[l.id]||0)+d)});const $=(l,d)=>{Number.isFinite(d)&&(C.healingTotals[l]=(C.healingTotals[l]||0)+d)},pe=(l,d)=>Array.isArray(l)?l.reduce((b,O)=>b+Number((O==null?void 0:O[d])??0),0):0,Q=(l,d,b)=>{if(!Number.isFinite(b)||b<=0)return;const O=c[d],we=d===g,Qe=O==null?void 0:O.notInSquad,xe=!Qe,Be=xe&&(O==null?void 0:O.group)!=null&&O.group===i.group;$(l,b),xe&&$(`squad${l[0].toUpperCase()}${l.slice(1)}`,b),Be&&$(`group${l[0].toUpperCase()}${l.slice(1)}`,b),we&&$(`self${l[0].toUpperCase()}${l.slice(1)}`,b),Qe&&$(`offSquad${l[0].toUpperCase()}${l.slice(1)}`,b)};if(Array.isArray(i.rotation)){let l=0;i.rotation.forEach(d=>{var O;if(!(d!=null&&d.id)||!uo(d.id,t.skillMap))return;const b=((O=d.skills)==null?void 0:O.length)||0;b>0&&(l+=b,$(`resUtility_s${d.id}`,b))}),l>0&&$("resUtility",l)}const L=(an=i.extHealingStats)==null?void 0:an.outgoingHealingAllies;Array.isArray(L)&&L.forEach((l,d)=>{const b=pe(l,"healing"),O=pe(l,"downedHealing");Q("healing",d,b),Q("downedHealing",d,O)});const X=(In=i.extBarrierStats)==null?void 0:In.outgoingBarrierAllies;Array.isArray(X)&&X.forEach((l,d)=>{const b=pe(l,"barrier");Q("barrier",d,b)});const q=(gn=i.statsAll)==null?void 0:gn[0],ue=(pn=i.dpsAll)==null?void 0:pn[0],G=(Tt=i.support)==null?void 0:Tt[0];if(so.forEach(l=>{if(l.id==="downContributionPercent"||!l.field)return;let d=0,b=0;l.source==="dpsAll"&&ue?d=Number(ue[l.field]??0):l.source==="statsAll"&&q?(d=Number(q[l.field]??0),b=Number(q[l.denomField||l.weightField||"connectedDamageCount"]??0)):l.source==="support"&&G?d=Number(G[l.field]??0):i.statsTargets&&i.statsTargets.forEach(O=>{O!=null&&O[0]&&(d+=Number(O[0][l.field]??0),b+=Number(O[0][l.denomField||l.weightField||"connectedDamageCount"]??0))}),Number.isFinite(d)&&(C.offenseTotals[l.id]=(C.offenseTotals[l.id]||0)+d,l.isRate&&b>0&&(C.offenseRateWeights[l.id]=(C.offenseRateWeights[l.id]||0)+b))}),i.targetDamageDist&&Number.isFinite(Y)){const l=i.targetDamageDist.flatMap(d=>d||[]).flatMap(d=>d||[]).reduce((d,b)=>b!=null&&b.id&&b.id===Y?d+((b==null?void 0:b.connectedHits)||0):d,0);C.offenseTotals.battleStandardHits=(C.offenseTotals.battleStandardHits||0)+l}C.revives+=((vt=(At=i.support)==null?void 0:At[0])==null?void 0:vt.resurrects)||0,ue&&(C.damage+=ue.damage||0,C.dps+=ue.dps||0);const he=l=>{var we,Qe,xe,Be;let d=`Skill ${l.id}`;const b=((we=t.skillMap)==null?void 0:we[`s${l.id}`])||((Qe=t.skillMap)==null?void 0:Qe[`${l.id}`]);let O=b==null?void 0:b.icon;if(b!=null&&b.name&&(d=b.name),d.startsWith("Skill ")){const nn=Dn(d,l.id,t.buffMap);nn&&(d=nn,O=((Be=(xe=t.buffMap)==null?void 0:xe[`b${l.id}`])==null?void 0:Be.icon)||O)}return{name:d,icon:O}},U=l=>{if(!(l!=null&&l.id))return;const{name:d,icon:b}=he(l);ce[l.id]||(ce[l.id]={name:d,icon:b,damage:0,hits:0,downContribution:0}),ce[l.id].name.startsWith("Skill ")&&!d.startsWith("Skill ")&&(ce[l.id].name=d),!ce[l.id].icon&&b&&(ce[l.id].icon=b),ce[l.id].damage+=l.totalDamage,ce[l.id].hits+=l.connectedHits,ce[l.id].downContribution+=Number(l.downContribution||0)},se=i.account||i.name||"Unknown",oe=i.profession||"Unknown",Z=`${se}|${oe}`;let be=Oe.get(Z);be||(be={key:Z,account:se,displayName:se,profession:oe,professionList:[oe],totalFightMs:0,skills:new Map},Oe.set(Z,be)),be.professionList.includes(oe)||be.professionList.push(oe),be.totalFightMs+=t.durationMS||0;const _e=l=>{if(!(l!=null&&l.id))return;const{name:d,icon:b}=he(l),O=`s${l.id}`;let we=be.skills.get(O);we||(we={id:O,name:d,icon:b,damage:0,downContribution:0},be.skills.set(O,we)),we.name.startsWith("Skill ")&&!d.startsWith("Skill ")&&(we.name=d),!we.icon&&b&&(we.icon=b),we.damage+=Number(l.totalDamage||0),we.downContribution+=Number(l.downContribution||0)};ie==="total"?(wt=i.totalDamageDist)==null||wt.forEach(l=>{l==null||l.forEach(d=>{U(d),_e(d)})}):(Mt=i.targetDamageDist)==null||Mt.forEach(l=>{l==null||l.forEach(d=>{d==null||d.forEach(b=>{U(b),_e(b)})})}),i.totalDamageTaken&&i.totalDamageTaken.forEach(l=>{l==null||l.forEach(d=>{var Qe,xe,Be,nn;if(!(d!=null&&d.id))return;let b=`Skill ${d.id}`;const O=((Qe=t.skillMap)==null?void 0:Qe[`s${d.id}`])||((xe=t.skillMap)==null?void 0:xe[`${d.id}`]);let we=O==null?void 0:O.icon;if(O!=null&&O.name&&(b=O.name),b.startsWith("Skill ")){const ln=Dn(b,d.id,t.buffMap);ln&&(b=ln,we=((nn=(Be=t.buffMap)==null?void 0:Be[`b${d.id}`])==null?void 0:nn.icon)||we)}me[d.id]||(me[d.id]={name:b,icon:we,damage:0,hits:0}),(!me[d.id].name.startsWith("Skill ")||b.startsWith("Skill "))&&(me[d.id].name=b),!me[d.id].icon&&we&&(me[d.id].icon=we),me[d.id].damage+=d.totalDamage,me[d.id].hits+=d.hits})})}),De.forEach(i=>{const g=cn(i.profession||i.name);g&&(Se[g]=(Se[g]||0)+1)});const I=oo({players:c,targets:a,skillMap:t.skillMap,buffMap:t.buffMap,getPlayerKey:i=>i.account&&i.account!=="Unknown"?i.account:i.name||null}),le=Zn(t.buffMap);Object.entries(I.playerConditions).forEach(([i,g])=>{const A=de.get(i);A&&Object.entries(g).forEach(([_,B])=>{const C=A.outgoingConditions[_]||{applications:0,damage:0,skills:{},icon:B.icon};C.applications+=Number(B.applications||0),C.damage+=Number(B.damage||0),B.applicationsFromBuffs&&(C.applicationsFromBuffs=(C.applicationsFromBuffs||0)+B.applicationsFromBuffs),B.applicationsFromBuffsActive&&(C.applicationsFromBuffsActive=(C.applicationsFromBuffsActive||0)+B.applicationsFromBuffsActive),Object.entries(B.skills||{}).forEach(([W,N])=>{const $=C.skills[W]||{name:N.name,hits:0,damage:0,icon:N.icon};$.hits+=Number(N.hits||0),$.damage+=Number(N.damage||0),!$.icon&&N.icon&&($.icon=N.icon),C.skills[W]=$}),!C.icon&&B.icon&&(C.icon=B.icon),A.outgoingConditions[_]=C})}),Object.entries(I.summary).forEach(([i,g])=>{const A=ve[i]||{name:g.name||i,icon:g.icon,applications:0,damage:0};A.applications+=Number(g.applications||0),A.damage+=Number(g.damage||0),g.applicationsFromBuffs&&(A.applicationsFromBuffs=(A.applicationsFromBuffs||0)+g.applicationsFromBuffs),g.applicationsFromBuffsActive&&(A.applicationsFromBuffsActive=(A.applicationsFromBuffsActive||0)+g.applicationsFromBuffsActive),!A.icon&&g.icon&&(A.icon=g.icon),ve[i]=A}),ge.forEach(i=>{const g=i.account&&i.account!=="Unknown"?i.account:i.name||"Unknown",A=de.get(g);!A||!i.totalDamageTaken||i.totalDamageTaken.forEach(_=>_==null?void 0:_.forEach(B=>{var he,U,se,oe,Z,be;if(!(B!=null&&B.id))return;let C=`Skill ${B.id}`;const W=((he=t.skillMap)==null?void 0:he[`s${B.id}`])||((U=t.skillMap)==null?void 0:U[`${B.id}`]);W!=null&&W.name&&(C=W.name);const N=Dn(C,B.id,t.buffMap);if(!N)return;const $=(oe=(se=t.buffMap)==null?void 0:se[`b${B.id}`])==null?void 0:oe.name,pe=le.get(N)||((be=(Z=t.buffMap)==null?void 0:Z[`b${B.id}`])==null?void 0:be.icon),Q=(W==null?void 0:W.icon)||pe;C.startsWith("Skill ")&&($||N)&&(C=$||N);const L=Number(B.hits??0),X=Number(B.totalDamage??0),q=Ie[N]||{name:N,icon:pe,applications:0,damage:0};q.applications+=Number.isFinite(L)?L:0,q.damage+=Number.isFinite(X)?X:0,!q.icon&&pe&&(q.icon=pe),Ie[N]=q;const ue=A.incomingConditions[N]||{applications:0,damage:0,skills:{},icon:pe};ue.applications+=Number.isFinite(L)?L:0,ue.damage+=Number.isFinite(X)?X:0;const G=ue.skills[C]||{name:C,hits:0,damage:0,icon:Q};G.hits+=Number.isFinite(L)?L:0,G.damage+=Number.isFinite(X)?X:0,!G.icon&&Q&&(G.icon=Q),ue.skills[C]=G,!ue.icon&&pe&&(ue.icon=pe),A.incomingConditions[N]=ue}))});const We=t.player_damage_mitigation||t.playerDamageMitigation,en=We&&typeof We=="object"&&Object.keys(We).length>0;en&&Object.entries(We).forEach(([i,g])=>{if(!g||typeof g!="object")return;const A=at(i),_=rt(wn,A.account,A);Object.values(g).forEach(B=>{x((B==null?void 0:B.avoided_damage)??(B==null?void 0:B.avoidedDamage))<=0||lt(_.mitigationTotals,B)})});const Bn=t.player_minion_damage_mitigation||t.playerMinionDamageMitigation,zn=Bn&&typeof Bn=="object"&&Object.keys(Bn).length>0;zn&&Object.entries(Bn).forEach(([i,g])=>{if(!g||typeof g!="object")return;const A=at(i);Object.entries(g).forEach(([_,B])=>{if(!B||typeof B!="object")return;const C=`${A.account}::${_}`,W=ct(Mn,C,{...A,minion:String(_||"Unknown")});Object.values(B).forEach(N=>{lt(W.mitigationTotals,N)})})}),(!en||!zn)&&(en||ge.forEach(i=>{const g=(i==null?void 0:i.totalDamageTaken)||[];if(!Array.isArray(g)||g.length===0)return;const A=i.account||i.name||"Unknown",_={account:A,name:i.name||A,profession:cn(i.profession||"Unknown")};rt(wn,A,_);const B=t.skillMap||{},C=t.buffMap||{},W=Array.isArray(g)?g[0]:null;if(W==null||W.forEach(N=>{if(!(N!=null&&N.id))return;const $=x(N.blocked),pe=x(N.evaded),Q=x(N.glance??N.glanced),L=x(N.missed),X=x(N.invulned),q=x(N.interrupted),ue=x(N.hits??N.connectedHits),G=Number(N.id),he=Nn(G,B,C);if(ft(dt,`${A}::${G}`,{totalHits:ue,blocked:$,evaded:pe,glanced:Q,missed:L,invulned:X,interrupted:q}),A===En){const U=fn.get(G),se=tn(G),oe=se.hasSkill?se.hits>0?se.avg:0:1,Z=se.hasSkill?se.min||0:1,be=se.hits>0?Q*oe/2+($+pe+L+X+q)*oe:0,_e=se.hits>0?Q*Z/2+($+pe+L+X+q)*Z:0;On.push({logId:e.filePath||e.id||n,skillId:N.id,skillName:he,blocked:$,evaded:pe,glanced:Q,missed:L,invulned:X,interrupted:q,totalAvoids:$+pe+Q+L+X+q,avg:oe,min:Z,enemyHits:(U==null?void 0:U.connectedHits)??0,enemyTotalDmg:(U==null?void 0:U.totalDamage)??0,avoidDmg:be,avoidMinDmg:_e})}}),A===En){const N=($,pe)=>{let Q=0,L=0,X=0;if(!Array.isArray($))return{total:Q,minTotal:L,hits:X};for(const q of $){if(!(q!=null&&q.id))continue;const ue=x(q.blocked),G=x(q.evaded),he=x(q.glance??q.glanced),U=x(q.missed),se=x(q.invulned),oe=x(q.interrupted),Z=Nn(Number(q.id),m,h),be=pe(Number(q.id),Z);(be.hits??0)>0&&(Q+=he*be.avg/2+(ue+G+U+se+oe)*be.avg,L+=he*be.min/2+(ue+G+U+se+oe)*be.min),X+=x(q.hits??q.connectedHits)}return{total:Q,minTotal:L,hits:X}};_n.push({logId:e.filePath||e.id||n,variant:"current_global_name_taken0",...N(W,($,pe)=>{const Q=tn($),L=Q.hasSkill?Q.hits>0?Q.avg:0:1,X=Q.hasSkill?Q.min||0:1;return{avg:L,min:X,hits:Q.hits}})})}}),zn||ge.forEach(i=>{const g=(i==null?void 0:i.minions)||[];if(!Array.isArray(g)||g.length===0)return;const A=i.account||i.name||"Unknown",_={account:A,name:i.name||A,profession:cn(i.profession||"Unknown")},B=t.skillMap||{},C=t.buffMap||{};g.forEach(W=>{const N=(W==null?void 0:W.totalDamageTakenDist)||[];if(!Array.isArray(N)||N.length===0)return;let $=String((W==null?void 0:W.name)||"Unknown").replace(/^Juvenile\s+/i,"")||"Unknown";$.toUpperCase().includes("UNKNOWN")&&($="Unknown");const pe=`${A}::${$}`;ct(Mn,pe,{..._,minion:$});const Q=Array.isArray(N)?N[0]:null;if(Q==null||Q.forEach(L=>{if(!(L!=null&&L.id))return;const X=x(L.blocked),q=x(L.evaded),ue=x(L.glance??L.glanced),G=x(L.missed),he=x(L.invulned),U=x(L.interrupted),se=x(L.hits??L.connectedHits),oe=Number(L.id),Z=Nn(oe,B,C);if(ft(mt,`${pe}::${oe}`,{totalHits:se,blocked:X,evaded:q,glanced:ue,missed:G,invulned:he,interrupted:U}),A===En&&$===ut){const be=fn.get(oe),_e=tn(oe),ye=_e.hasSkill?_e.hits>0?_e.avg:0:1,Ye=_e.hasSkill?_e.min||0:1,sn=_e.hits>0?ue*ye/2+(X+q+G+he+U)*ye:0,an=_e.hits>0?ue*Ye/2+(X+q+G+he+U)*Ye:0;$n.push({logId:e.filePath||e.id||n,skillId:L.id,skillName:Z,blocked:X,evaded:q,glanced:ue,missed:G,invulned:he,interrupted:U,totalAvoids:X+q+ue+G+he+U,avg:ye,min:Ye,enemyHits:(be==null?void 0:be.connectedHits)??0,enemyTotalDmg:(be==null?void 0:be.totalDamage)??0,avoidDmg:sn,avoidMinDmg:an})}}),A===En&&$===ut){const L=(G,he)=>{let U=0,se=0,oe=0;if(!Array.isArray(G))return{total:U,minTotal:se,hits:oe};for(const Z of G){if(!(Z!=null&&Z.id))continue;const be=x(Z.blocked),_e=x(Z.evaded),ye=x(Z.glance??Z.glanced),Ye=x(Z.missed),sn=x(Z.invulned),an=x(Z.interrupted),In=Nn(Number(Z.id),m,h),{avg:gn,min:pn}=he(Number(Z.id),In);x(Z.hits??Z.connectedHits)>0&&(U+=ye*gn/2+(be+_e+Ye+sn+an)*gn,se+=ye*pn/2+(be+_e+Ye+sn+an)*pn),oe+=x(Z.hits??Z.connectedHits)}return{total:U,minTotal:se,hits:oe}},X=Array.isArray(N)?N[0]||[]:[],q=Array.isArray(N)?N.flat():[],ue=Array.isArray(W==null?void 0:W.totalDamageTaken)?W.totalDamageTaken[0]||[]:[];on.push({logId:e.filePath||e.id||n,variant:"current_global_name_dist0",...L(X,(G,he)=>{const U=tn(G),se=U.hasSkill?U.hits>0?U.avg:0:1,oe=U.hasSkill&&U.min||0;return{avg:se,min:oe}})}),on.push({logId:e.filePath||e.id||n,variant:"local_name_dist0",...L(X,(G,he)=>K(he))}),on.push({logId:e.filePath||e.id||n,variant:"local_id_dist0",...L(X,G=>w(G))}),on.push({logId:e.filePath||e.id||n,variant:"global_name_alllists",...L(q,(G,he)=>{const U=tn(G),se=U.hasSkill?U.hits>0?U.avg:0:1,oe=U.hasSkill&&U.min||0;return{avg:se,min:oe}})}),on.push({logId:e.filePath||e.id||n,variant:"global_name_taken0",...L(ue,(G,he)=>{const U=tn(G),se=U.hasSkill?U.hits>0?U.avg:0:1,oe=U.hasSkill&&U.min||0;return{avg:se,min:oe}})})}})}))}),$n.length>0&&(console.groupCollapsed("[Mitigation Debug] Ashtonlightstone.9145 / Illusionary Warden"),console.table($n),on.length>0&&console.table(on),console.groupEnd()),On.length>0&&(console.groupCollapsed("[Mitigation Debug] Ashtonlightstone.9145 / Player"),console.table(On),_n.length>0&&console.table(_n),console.groupEnd());const gt=(e,n)=>{const t=new Map,c=a=>{let m=t.get(a);return m||(m=mn(),t.set(a,m)),m};n.forEach((a,m)=>{const h=m.lastIndexOf("::"),p=h>-1?m.slice(0,h):m,f=h>-1?Number(m.slice(h+2)):Number.NaN,w=Number.isFinite(f)?tn(f):{hasSkill:!1,avg:0,min:0,hits:0};if(!w.hasSkill||w.hits<=0)return;const K=w.avg,H=w.min,Fe=a.glanced*K/2+(a.blocked+a.evaded+a.missed+a.invulned+a.interrupted)*K,Ne=a.glanced*H/2+(a.blocked+a.evaded+a.missed+a.invulned+a.interrupted)*H;if(Fe<=0)return;const ke=c(p);ke.totalHits+=a.totalHits,ke.blocked+=a.blocked,ke.evaded+=a.evaded,ke.glanced+=a.glanced,ke.missed+=a.missed,ke.invulned+=a.invulned,ke.interrupted+=a.interrupted,ke.totalMitigation+=Fe,ke.minMitigation+=Ne}),e.forEach((a,m)=>{const h=t.get(m)||mn();a.mitigationTotals.totalHits=h.totalHits,a.mitigationTotals.blocked=h.blocked,a.mitigationTotals.evaded=h.evaded,a.mitigationTotals.glanced=h.glanced,a.mitigationTotals.missed=h.missed,a.mitigationTotals.invulned=h.invulned,a.mitigationTotals.interrupted=h.interrupted,a.mitigationTotals.totalMitigation=h.totalMitigation,a.mitigationTotals.minMitigation=h.minMitigation})};gt(wn,dt),gt(Mn,mt);const Co=E>0?Math.round(j/E):0,ko=E>0?Math.round(V/E):0,Do=z>0?(re/z).toFixed(2):re>0?"∞":"0.00",So=Le>0?(y/Le).toFixed(2):y>0?"∞":"0.00",pt=(e,n)=>{const c=e.filter(h=>Number.isFinite(h.value)&&(n?h.value>0:h.value>=0)).sort((h,p)=>{const f=n?p.value-h.value:h.value-p.value;return f!==0?f:h.account.localeCompare(p.account)});let a=null,m=0;return c.map((h,p)=>((a===null||h.value!==a)&&(m=p+1,a=h.value),{rank:m,...h}))},Rn=Array.from(de.values()).map(e=>{const n=Array.from(e.professions).filter(t=>t!=="Unknown");if(e.professionList=n,n.length>0){let t=n[0],c=e.professionTimeMs[t]||0;n.forEach(a=>{const m=e.professionTimeMs[a]||0;m>c&&(c=m,t=a)}),e.profession=t}return{key:e.account,stat:e}}),bt=e=>{const n=de.get(e.account);if(!n){const a=e.professionList.length>0?e.professionList:e.profession?[e.profession]:[];return{...e,professionList:a}}const t=n.professionList&&n.professionList.length>0?n.professionList:Array.from(n.professions||[]).filter(a=>a&&a!=="Unknown"),c=n.profession||e.profession;return{...e,profession:c,professionList:t.length>0?t:c?[c]:[],activeMs:n.defenseActiveMs||n.totalFightMs||e.activeMs}},To=Array.from(wn.values()).map(bt).filter(e=>ho(e.mitigationTotals)).sort((e,n)=>e.account.localeCompare(n.account)),Ao=Array.from(Mn.values()).map(bt).filter(e=>e.mitigationTotals.totalMitigation>0).sort((e,n)=>{const t=e.account.localeCompare(n.account);return t!==0?t:String(e.minion||"").localeCompare(String(n.minion||""))}),Fn=(e,n)=>{switch(n){case"downContrib":return e.downContrib;case"barrier":return e.barrier;case"healing":return e.healing;case"dodges":return e.dodges;case"strips":return e.strips;case"cleanses":return e.cleanses;case"cc":return e.cc;case"stability":return e.stab;case"revives":return e.revives;case"dps":return e.dps;case"damage":return e.damage;case"participation":return e.logsJoined;case"closestToTag":return!e.isCommander&&e.distCount>0?e.totalDist/e.distCount:Number.POSITIVE_INFINITY;default:return 0}},qe=(e,n)=>pt(Rn.map(({stat:t})=>({account:t.account,profession:t.profession,professionList:t.professionList,value:Fn(t,e),count:t.logsJoined})),n),Me={downContrib:qe("downContrib",!0),barrier:qe("barrier",!0),healing:qe("healing",!0),dodges:qe("dodges",!0),strips:qe("strips",!0),cleanses:qe("cleanses",!0),cc:qe("cc",!0),stability:qe("stability",!0),revives:qe("revives",!0),participation:qe("participation",!0),dps:qe("dps",!0),damage:qe("damage",!0),closestToTag:qe("closestToTag",!1).filter(e=>Number.isFinite(e.value))},vo={downContrib:"downContrib",barrier:"barrier",healing:"healing",dodges:"dodges",strips:"strips",cleanses:"cleanses",cc:"cc",stability:"stability",closestToTag:"closestToTag"},Ce=e=>{const n=e==null?void 0:e[0];return{value:(n==null?void 0:n.value)??0,player:(n==null?void 0:n.account)??"-",count:(n==null?void 0:n.count)??0,profession:(n==null?void 0:n.profession)??"Unknown",professionList:(n==null?void 0:n.professionList)??[]}},Ge={maxDownContrib:Ce([]),maxBarrier:Ce([]),maxHealing:Ce([]),maxDodges:Ce([]),maxStrips:Ce([]),maxCleanses:Ce([]),maxCC:Ce([]),maxStab:Ce([]),closestToTag:Ce([])},ze={},wo=(e,n)=>{if(n==="closestToTag")return Fn(e,n);const t=Math.max(1,(e.totalFightMs||0)/1e3);return Fn(e,n)/t};Object.values(vo).forEach(e=>{const n=e!=="closestToTag";ze[e]=pt(Rn.map(({stat:t})=>({account:t.account,profession:t.profession,professionList:t.professionList,value:wo(t,e),count:t.logsJoined})),n)}),Ge.maxDownContrib=Ce(ze.downContrib),Ge.maxBarrier=Ce(ze.barrier),Ge.maxHealing=Ce(ze.healing),Ge.maxDodges=Ce(ze.dodges),Ge.maxStrips=Ce(ze.strips),Ge.maxCleanses=Ce(ze.cleanses),Ge.maxCC=Ce(ze.cc),Ge.maxStab=Ce(ze.stability),Ge.closestToTag=Ce(ze.closestToTag);const Mo={maxDownContrib:Ce(Me.downContrib),maxBarrier:Ce(Me.barrier),maxHealing:Ce(Me.healing),maxDodges:Ce(Me.dodges),maxStrips:Ce(Me.strips),maxCleanses:Ce(Me.cleanses),maxCC:Ce(Me.cc),maxStab:Ce(Me.stability),closestToTag:Ce(Me.closestToTag)};let qn={player:"None",account:"None",score:-1,profession:"Unknown",professionList:[],color:"#64748b",topStats:[]},ht,Ct,kt=0;if(ee!=null&&ee.showMvp){const e={"Down Contribution":"downContribution",Healing:"healing",Cleanses:"cleanses",Strips:"strips",Stability:"stability",CC:"cc",Revives:"revives","Distance to Tag":"distanceToTag",Participation:"participation",Dodging:"dodging",DPS:"dps",Damage:"damage"},n=m=>{const h=e[m];return h?Number(P[h]||0)>0:!1},t=[],c=m=>[...m||[]].filter(h=>n(h==null?void 0:h.name)).sort((h,p)=>p.ratio-h.ratio||h.rank-p.rank||h.name.localeCompare(p.name)).slice(0,3),a=m=>{var p;if(!m)return;const h=c(m.contribs);return{...m,player:m.name,reason:((p=h[0])==null?void 0:p.name)||"Top Performance",topStats:h}};Rn.forEach(({stat:m})=>{let h=0;const p=[],f=(w,K,H,Fe,Ne=!0)=>{var fe,He;if(H<=0)return;const ke=((fe=K[0])==null?void 0:fe.value)||0;if(ke&&Number.isFinite(w)&&(Ne?w>0:w<Number.POSITIVE_INFINITY)){const Pe=Ne?w/ke:ke/w;h+=Pe*H;const S=((He=K.find(F=>F.account===m.account))==null?void 0:He.rank)||0;p.push({name:Fe,ratio:Pe,val:w.toLocaleString(),rank:S})}};f(m.downContrib,Me.downContrib,P.downContribution,"Down Contribution"),f(m.healing,Me.healing,P.healing,"Healing"),f(m.cleanses,Me.cleanses,P.cleanses,"Cleanses"),f(m.strips,Me.strips,P.strips,"Strips"),f(m.stab,Me.stability,P.stability,"Stability"),f(m.cc,Me.cc,P.cc,"CC"),f(m.revives,Me.revives,P.revives,"Revives"),f(Fn(m,"closestToTag"),Me.closestToTag,P.distanceToTag,"Distance to Tag",!1),f(m.logsJoined,Me.participation,P.participation,"Participation"),f(m.dodges,Me.dodges,P.dodging,"Dodging"),f(m.dps,Me.dps,P.dps,"DPS"),f(m.damage,Me.damage,P.damage,"Damage"),t.push({...m,score:h,contribs:p.filter(w=>n(w.name))})}),t.sort((m,h)=>h.score-m.score),t[0]&&t[0].score>0&&(qn=a(t[0])||qn),ht=a(t[1]),Ct=a(t[2]),kt=t.length>0?t.reduce((m,h)=>m+h.score,0)/t.length:0}const No=Object.values(ce).sort((e,n)=>{const t=T==="downContribution"?e.downContribution:e.damage;return(T==="downContribution"?n.downContribution:n.damage)-t}).slice(0,25),Eo=Object.values(me).sort((e,n)=>n.damage-e.damage).slice(0,25),Fo=e=>{const n=String(e).replace(/^Detailed\s*WvW\s*-\s*/i,"").replace(/^World\s*vs\s*World\s*-\s*/i,"").replace(/^WvW\s*-\s*/i,"").trim(),t=n.match(/^(Red|Blue|Green)\s+(?:Alpine|Desert)?\s*Borderlands$/i);return t?`${t[1]} Borderlands`:n||"Unknown"},xn=(e,n)=>Fo((e==null?void 0:e.zone)||(e==null?void 0:e.mapName)||(e==null?void 0:e.map)||(e==null?void 0:e.location)||(e==null?void 0:e.fightName)||(n==null?void 0:n.fightName)||(n==null?void 0:n.encounterName)||"Unknown"),Bo=(e,n)=>{const t=(n==null?void 0:n.permalink)||(e==null?void 0:e.permalink);if(typeof t=="string"&&t.trim().length>0)return t.trim();const c=e==null?void 0:e.uploadLinks;if(!Array.isArray(c))return"";for(const a of c){if(typeof a=="string"&&a.trim().length>0)return a.trim();if(a&&typeof a=="object"){const m=a.permalink||a.link||a.url||a.reportLink;if(typeof m=="string"&&m.trim().length>0)return m.trim()}}return""},Wn={};M.forEach(e=>{const n=xn(e==null?void 0:e.details,e);Wn[n]=(Wn[n]||0)+1});const Io=Object.entries(Wn).map(([e,n])=>{const t=String(e).trim(),c=/eternal battlegrounds|^ebg$/i.test(t);let a="#64748b";return c?a="#ffffff":/red/i.test(t)?a="#ef4444":/blue/i.test(t)?a="#3b82f6":/green/i.test(t)&&(a="#22c55e"),{name:e,value:n,color:a}}).sort((e,n)=>n.value-e.value),{boonTables:Po}=Pt(M),Uo=M.map((e,n)=>{var c,a;const t=((c=e.details)==null?void 0:c.players)||[];return{index:n+1,label:`Log ${n+1}`,timestamp:Ze(e.details,e),squadCount:t.filter(m=>!m.notInSquad).length,friendlyCount:t.length,enemies:((a=e.details)==null?void 0:a.targets).filter(m=>!m.isFake).length}}).sort((e,n)=>e.timestamp-n.timestamp),jn={};Array.from(de.values()).forEach(e=>{e.profession&&e.profession!=="Unknown"&&(jn[e.profession]=(jn[e.profession]||0)+1)});const Ho=Object.entries(jn).map(([e,n])=>({name:e,value:n,color:et(e)})).sort((e,n)=>n.value-e.value),Vn={};Object.keys(Se).length===0&&M.forEach(e=>{var n,t;(t=(n=e.details)==null?void 0:n.targets)==null||t.forEach(c=>{if(c.isFake)return;const a=c.profession&&c.profession!=="Unknown"?c.profession:c.name||c.id||"Unknown",m=cn(a);Vn[m]=(Vn[m]||0)+1})});const Lo=Object.keys(Se).length>0?Se:Vn,$o=Object.entries(Lo).map(([e,n])=>({name:e,value:n,color:et(e)})).sort((e,n)=>n.value-e.value),Oo=M.map((e,n)=>({log:e,originalIndex:n})).sort((e,n)=>Ze(e.log.details,e.log)-Ze(n.log.details,n.log)).map(({log:e},n)=>{const t=e.details;if(!t)return null;const c=t.players||[],a=c.filter(u=>!u.notInSquad),m=c.filter(u=>u.notInSquad),h=t.targets||[],p=h.filter(u=>!u.isFake),f=a.reduce((u,J)=>{var R,Y;return u+(((Y=(R=J.dpsAll)==null?void 0:R[0])==null?void 0:Y.damage)||0)},0),w=a.reduce((u,J)=>{var R,Y;return u+(((Y=(R=J.defenses)==null?void 0:R[0])==null?void 0:Y.damageTaken)||0)},0),{enemyDeaths:K,enemyDownsDeaths:H}=Ee(t),Fe=Ae(t),Ne=Ze(t,e),ke=xn(t,e),fe={red:0,green:0,blue:0},He=u=>{const J=Number(u);return Number.isFinite(J)?J:0},Pe=u=>{if(!u||typeof u!="object")return;const J=u.teamID??u.teamId??u.team??u.teamColor??u.team_color;if(J!=null)return J;const R=Object.keys(u).find(Y=>/^team/i.test(Y));return R?u[R]:void 0},S=(u,J)=>{if(u==null)return null;if(typeof u=="string"){const R=u.toLowerCase();return R.includes("red")?"red":R.includes("green")?"green":R.includes("blue")?"blue":R==="r"?"red":R==="g"?"green":R==="b"?"blue":null}if(typeof u=="number")if(J==="zeroBased"){if(u===0)return"red";if(u===1)return"green";if(u===2)return"blue"}else{if(u===1)return"red";if(u===2)return"green";if(u===3)return"blue"}return null},F=(u,J)=>{const R={};return u.forEach(Y=>{const I=J(Y),le=cn(I);le&&(R[le]=(R[le]||0)+1)}),R},Te=F(a,u=>(u==null?void 0:u.profession)||(u==null?void 0:u.name)),ge=F(m,u=>(u==null?void 0:u.profession)||(u==null?void 0:u.name)),De=F(p,u=>(u==null?void 0:u.profession)||(u==null?void 0:u.name)||(u==null?void 0:u.id));if(t.teamCounts&&typeof t.teamCounts=="object"){const u=t.teamCounts;fe.red=He(u.red??u.r??u[0]??u[1]),fe.green=He(u.green??u.g??u[1]??u[2]),fe.blue=He(u.blue??u.b??u[2]??u[3])}else{const u=[];h.forEach(I=>{if(I!=null&&I.isFake)return;const le=Pe(I);le!=null&&u.push(le)}),c.forEach(I=>{if(!(I!=null&&I.notInSquad))return;const le=Pe(I);le!=null&&u.push(le)}),u.length===0&&c.forEach(I=>{const le=Pe(I);le!=null&&u.push(le)});const J=new Set;u.forEach(I=>{typeof I=="number"&&J.add(I)});const R=J.has(0)?"zeroBased":J.has(3)?"oneBased":"zeroBased";if(u.forEach(I=>{const le=S(I,R);le&&(fe[le]+=1)}),fe.red+fe.green+fe.blue===0&&u.length>0){const I=new Map;u.forEach(We=>{const en=String(We);I.set(en,(I.get(en)||0)+1)});const le=Array.from(I.values()).sort((We,en)=>en-We);fe.red=le[0]||0,fe.green=le[1]||0,fe.blue=le[2]||0}fe.red+fe.green+fe.blue===0&&(fe.red=Math.max(p.length,c.filter(I=>I==null?void 0:I.notInSquad).length))}return{id:e.filePath||`fight-${n}`,label:e.encounterName||`Fight ${n+1}`,permalink:Bo(t,e),timestamp:Ne,mapName:ke,duration:mo(t.durationMS),isWin:Fe,squadCount:a.length,allyCount:m.length,enemyCount:p.length,teamCounts:fe,alliesDown:a.reduce((u,J)=>{var R,Y;return u+(((Y=(R=J.defenses)==null?void 0:R[0])==null?void 0:Y.downCount)||0)},0),alliesDead:a.reduce((u,J)=>{var R,Y;return u+(((Y=(R=J.defenses)==null?void 0:R[0])==null?void 0:Y.deadCount)||0)},0),alliesRevived:a.reduce((u,J)=>{var R,Y;return Number(((Y=(R=J.statsAll)==null?void 0:R[0])==null?void 0:Y.saved)||0)>0?u+1:u},0),rallies:0,enemyDeaths:K,enemyDowns:Math.max(0,H-K),totalOutgoingDamage:f,totalIncomingDamage:w,incomingBarrierAbsorbed:a.reduce((u,J)=>{var R,Y;return u+(((Y=(R=J.defenses)==null?void 0:R[0])==null?void 0:Y.damageBarrier)||0)},0),outgoingBarrierAbsorbed:a.reduce((u,J)=>{var I;const R=(I=J.extBarrierStats)==null?void 0:I.outgoingBarrier;if(!Array.isArray(R))return u;let Y=0;return R.forEach(le=>{if(Array.isArray(le)){le.forEach(We=>{Y+=Number((We==null?void 0:We.barrier)||0)});return}Y+=Number((le==null?void 0:le.barrier)||0)}),u+Y},0),squadClassCountsFight:Te,allyClassCountsFight:ge,enemyClassCounts:De}}).filter(Boolean),_o=(e,n)=>{const t=(n==null?void 0:n.skillMap)||{},c=(n==null?void 0:n.buffMap)||{};let a=0,m="";const h=f=>{const w=Number(f);if(!Number.isFinite(w))return String(f||"Unknown Skill");const K=(t==null?void 0:t[`s${w}`])||(t==null?void 0:t[`${w}`]);if(K!=null&&K.name)return String(K.name);const H=(c==null?void 0:c[`b${w}`])||(c==null?void 0:c[`${w}`]);return H!=null&&H.name?String(H.name):`Skill ${w}`},p=f=>{if(!f||typeof f!="object")return;const w=[Number(f.max),Number(f.maxDamage),Number(f.maxHit),Number(f.totalDamage)>0&&Number(f.connectedHits)>0?Number(f.totalDamage)/Number(f.connectedHits):0].filter(H=>Number.isFinite(H)),K=w.length>0?Math.max(...w):0;K>a&&(a=K,m=h(f.id))};return Array.isArray(e==null?void 0:e.totalDamageDist)&&e.totalDamageDist.forEach(f=>{Array.isArray(f)&&f.forEach(w=>p(w))}),Array.isArray(e==null?void 0:e.targetDamageDist)&&e.targetDamageDist.forEach(f=>{Array.isArray(f)&&f.forEach(w=>{Array.isArray(w)&&w.forEach(K=>p(K))})}),{peak:a,skillName:m||"Unknown Skill"}},Ro=(()=>{const e=p=>String(p||"").replace(/^Detailed\s*WvW\s*-\s*/i,"").replace(/^World\s*vs\s*World\s*-\s*/i,"").replace(/^WvW\s*-\s*/i,"").trim(),n=p=>e(p).toLowerCase().split(/[^a-z0-9]+/i).map(f=>f.trim()).filter(Boolean).map(f=>f.length>3&&f.endsWith("s")?f.slice(0,-1):f),t=(p,f)=>{const w=e(p),K=e(f);if(!K)return w;if(!w)return K;const H=n(w),Fe=n(K),Ne=new Set(H),ke=new Set(Fe),fe=Fe.length>0&&Fe.every(Pe=>Ne.has(Pe)),He=H.length>0&&H.every(Pe=>ke.has(Pe));return fe||He?w:`${w} - ${K}`},c=[],a=new Map,m=(p,f)=>{const w=S=>{if(!Array.isArray(S)||S.length===0)return[];const F=[];for(let Te=0;Te<S.length;Te+=1){const ge=Number(S[Te]||0),De=Te>0?Number(S[Te-1]||0):0;F.push(Math.max(0,ge-De))}return F},K=(S,F)=>{if(!Array.isArray(S)||S.length===0||F<=0)return 0;let Te=0,ge=0;for(let De=0;De<S.length;De+=1)Te+=Number(S[De]||0),De>=F&&(Te-=Number(S[De-F]||0)),De>=F-1&&Te>ge&&(ge=Te);return Math.max(0,ge)},H=S=>{if(!Array.isArray(S))return[];const F=S.reduce((ge,De)=>Math.max(ge,Array.isArray(De)?De.length:0),0);if(F<=0)return[];const Te=new Array(F).fill(0);return S.forEach(ge=>{if(Array.isArray(ge))for(let De=0;De<F;De+=1)Te[De]+=Number(ge[De]||0)}),Te},Fe=S=>Array.isArray(S)?S.map(F=>Number(F||0)):null,ke=(S=>{if(!Array.isArray(S)||S.length===0)return null;const F=S[0];if(!Array.isArray(F))return null;if(Array.isArray(F[0])&&Array.isArray(F[0][0]))return H(F);if(Array.isArray(F[0])&&!Array.isArray(F[0][0])){const Te=S.map(ge=>Fe(Array.isArray(ge)?ge[0]:null)).filter(ge=>Array.isArray(ge)&&ge.length>0);if(Te.length>0)return H(Te)}return null})(p==null?void 0:p.targetDamage1S),fe=Array.isArray(p==null?void 0:p.damage1S)&&Array.isArray(p.damage1S[0])?p.damage1S[0]:null,He=ke||(Array.isArray(fe)?fe.map(S=>Number(S||0)):[]),Pe=w(He);return K(Pe,f)};M.map(p=>({log:p,ts:Ze(p==null?void 0:p.details,p)})).sort((p,f)=>p.ts-f.ts).forEach(({log:p},f)=>{const w=p==null?void 0:p.details;if(!w)return;const K=e(w.fightName||p.fightName||`Fight ${f+1}`),H=xn(w,p),Fe=t(K,String(H||"")),Ne={};(Array.isArray(w.players)?w.players:[]).forEach(S=>{if(S!=null&&S.notInSquad)return;const F=String((S==null?void 0:S.account)||(S==null?void 0:S.name)||"Unknown"),Te=String((S==null?void 0:S.character_name)||(S==null?void 0:S.display_name)||(S==null?void 0:S.name)||""),ge=String((S==null?void 0:S.profession)||"Unknown"),De=`${F}|${ge}`,u=_o(S,w),J=Number(u.peak||0),R=Number(m(S,1)||0),Y=Number(m(S,5)||0);Ne[De]={hit:J,burst1s:R,burst5s:Y,skillName:u.skillName};const I=a.get(De)||{key:De,account:F,displayName:F,characterName:Te,profession:ge,professionList:[ge],logs:0,peakHit:0,peak1s:0,peak5s:0,peakFightLabel:"",peakSkillName:""};I.logs+=1,I.professionList.includes(ge)||I.professionList.push(ge),!I.characterName&&Te&&(I.characterName=Te),J>I.peakHit&&(I.peakHit=J,I.peakFightLabel=Fe,I.peakSkillName=u.skillName),R>I.peak1s&&(I.peak1s=R),Y>I.peak5s&&(I.peak5s=Y),a.set(De,I)});const fe=Object.values(Ne).reduce((S,F)=>Math.max(S,Number((F==null?void 0:F.hit)||0)),0),He=Object.values(Ne).reduce((S,F)=>Math.max(S,Number((F==null?void 0:F.burst1s)||0)),0),Pe=Object.values(Ne).reduce((S,F)=>Math.max(S,Number((F==null?void 0:F.burst5s)||0)),0);c.push({id:p.filePath||p.id||`fight-${f+1}`,shortLabel:`F${f+1}`,fullLabel:Fe,timestamp:Ze(w,p),values:Ne,maxHit:fe,max1s:He,max5s:Pe})});const h=Array.from(a.values()).sort((p,f)=>f.peakHit!==p.peakHit?f.peakHit-p.peakHit:p.displayName.localeCompare(f.displayName));return{fights:c,players:h}})(),qo=Array.from(Ke.entries()).map(([e,n])=>{const t=Je.get(e)||{},c=Array.from(n.values()).map(a=>{var K;const m=Array.from(a.professions||[]).filter(H=>H&&H!=="Unknown");let h=a.profession||"Unknown";if(m.length>0){h=m[0];let H=((K=a.professionTimeMs)==null?void 0:K[h])||0;m.forEach(Fe=>{var ke;const Ne=((ke=a.professionTimeMs)==null?void 0:ke[Fe])||0;Ne>H&&(H=Ne,h=Fe)})}const p=a.durationMs||0,f=a.totalMs/1e3,w=p>0?a.totalMs/p:0;return{account:a.account,profession:h,professionList:m,total:f,perSecond:w,duration:p/1e3}}).filter(a=>a.total>0||a.perSecond>0);return{id:e,name:t.name||e,icon:t.icon,rows:c}}).filter(e=>e.rows.length>0),xo=Array.from(Oe.values()).map(e=>{const n=Array.from(e.skills.values()).sort((c,a)=>a.damage-c.damage),t=n.reduce((c,a)=>(c[a.id]=a,c),{});return{key:e.key,account:e.account,displayName:e.displayName,profession:e.profession,professionList:e.professionList,totalFightMs:e.totalFightMs,skills:n,skillMap:t}}).sort((e,n)=>e.displayName.localeCompare(n.displayName));return{total:E,wins:te,losses:D,avgSquadSize:Co,avgEnemies:ko,squadKDR:Do,enemyKDR:So,totalSquadKills:re,totalSquadDeaths:z,totalEnemyKills:y,totalEnemyDeaths:Le,leaderboards:Me,...Mo,outgoingConditionSummary:Object.values(ve).sort((e,n)=>n.damage-e.damage),incomingConditionSummary:Object.values(Ie).sort((e,n)=>n.damage-e.damage),outgoingConditionPlayers:Array.from(de.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,conditions:e.outgoingConditions})),incomingConditionPlayers:Array.from(de.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,conditions:e.incomingConditions})),topSkills:No,topIncomingSkills:Eo,playerSkillBreakdowns:xo,topSkillsMetric:T,mapData:Io,timelineData:Uo,boonTables:Po,offensePlayers:Array.from(de.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,offenseTotals:e.offenseTotals,offenseRateWeights:e.offenseRateWeights,totalFightMs:e.totalFightMs})),defensePlayers:Array.from(de.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,defenseTotals:e.defenseTotals,activeMs:e.defenseActiveMs})),damageMitigationPlayers:To,damageMitigationMinions:Ao,supportPlayers:Array.from(de.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,supportTotals:e.supportTotals,activeMs:e.supportActiveMs})),healingPlayers:Array.from(de.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,healingTotals:e.healingTotals,activeMs:e.healingActiveMs})),mvp:qn,silver:ht,bronze:Ct,squadClassData:Ho,enemyClassData:$o,fightBreakdown:Oo,spikeDamage:Ro,specialTables:qo,topStatsPerSecond:Ge,topStatsLeaderboardsPerSecond:ze,avgMvpScore:kt}})(),Re=(()=>{const ae=new Map,ie=new Map,T=[],E=new Map,te=new Map;M.forEach(j=>{const V=j.details;if(!V)return;const z=V.skillMap||{},re=V.fightName||"Log",Le=Ze(V,j)||Date.now(),y={id:j.filePath||j.id||re,label:re,timestamp:Le,skillEntries:{},playerActiveSeconds:{},durationSeconds:V.durationMS?V.durationMS/1e3:0};(V.players||[]).forEach(Ae=>{if(Ae.notInSquad)return;const de=Ae.account||Ae.name||"Unknown",$e=Ae.profession||"Unknown",ce=`${de}|${$e}`;let me=ie.get(ce);me||(me={key:ce,account:de,displayName:de,profession:$e,professionList:[$e],logs:0,totalActiveSeconds:0,skillTotals:{}},ie.set(ce,me)),me.logs++;const Oe=(Array.isArray(Ae.activeTimes)?Ae.activeTimes[0]:0)/1e3;me.totalActiveSeconds=(me.totalActiveSeconds||0)+Oe,y.playerActiveSeconds[ce]=Oe,(Ae.rotation||[]).forEach(ve=>{var Tn,An,vn;if(!(ve!=null&&ve.id))return;const Ie=((Tn=ve.skills)==null?void 0:Tn.length)||0;if(Ie<=0)return;const Se=`s${ve.id}`,Je=((An=z[Se])==null?void 0:An.name)||`Skill ${ve.id}`,Ke=(vn=z[Se])==null?void 0:vn.icon;me.skillTotals[Se]=(me.skillTotals[Se]||0)+Ie,ae.set(Se,(ae.get(Se)||0)+Ie),E.set(Se,Je),Ke&&!te.has(Se)&&te.set(Se,Ke),y.skillEntries[Se]||(y.skillEntries[Se]={name:Je,icon:Ke,players:{}}),!y.skillEntries[Se].icon&&Ke&&(y.skillEntries[Se].icon=Ke),y.skillEntries[Se].players[ce]=(y.skillEntries[Se].players[ce]||0)+Ie})}),T.push(y)});const D=Array.from(ae.entries()).map(([j,V])=>({id:j,name:E.get(j)||j,total:V,icon:te.get(j)})).sort((j,V)=>V.total-j.total);return{logRecords:T,players:Array.from(ie.values()),skillOptions:D,resUtilitySkills:[]}})();return{validLogs:M,stats:Ue,skillUsageData:Re}};let Ve=null,rn=!1,nt=null,tt=0,ot=0,Hn=null;const it=o=>{if(!o||typeof o!="object")return o;const s=(k,v)=>{const M={};return v.forEach(ee=>{k&&Object.prototype.hasOwnProperty.call(k,ee)&&(M[ee]=k[ee])}),M},r=s(o,["players","targets","durationMS","uploadTime","timeStart","timeStartStd","timeEnd","timeEndStd","fightName","success","teamCounts","combatReplayMetaData","skillMap","buffMap","encounterDuration","player_damage_mitigation","player_minion_damage_mitigation","playerDamageMitigation","playerMinionDamageMitigation"]);return Array.isArray(r.players)&&(r.players=r.players.map(k=>s(k,["name","display_name","character_name","profession","elite_spec","group","dpsAll","statsAll","dpsTargets","statsTargets","defenses","support","rotation","extHealingStats","extBarrierStats","squadBuffVolumes","selfBuffs","groupBuffs","squadBuffs","selfBuffsActive","groupBuffsActive","squadBuffsActive","buffUptimes","totalDamageDist","targetDamageDist","damage1S","targetDamage1S","totalDamageTaken","totalDamageTakenDist","minions","combatReplayData","hasCommanderTag","notInSquad","account","activeTimes"]))),Array.isArray(r.targets)&&(r.targets=r.targets.map(k=>s(k,["id","name","isFake","dpsAll","statsAll","defenses","totalHealth","healthPercentBurned","enemyPlayer","totalDamageDist"]))),r},po=o=>{if(!o||typeof o!="object")return o;const s={...o};return o.details?s.details=it(o.details):s.details=it(o),s},st=()=>{if(!rn||!Ve)return;rn=!1,tt+=1;const o=Hn;Hn=null;const s=go(Ve);self.postMessage({type:"result",result:s,computeId:tt,logCount:Ve.logs.length,token:ot,completedAt:Date.now(),flushId:o})},Ln=()=>{nt===null&&(nt=setInterval(()=>{st()},5e3))};self.onmessage=o=>{var r,k,v,M;const s=o.data;if((s==null?void 0:s.type)==="reset"){Ve={logs:[]},typeof s.token=="number"&&(ot=s.token),rn=!0,Ln();return}if((s==null?void 0:s.type)==="settings"){Ve={logs:(Ve==null?void 0:Ve.logs)||[],precomputedStats:(r=s.payload)==null?void 0:r.precomputedStats,mvpWeights:(k=s.payload)==null?void 0:k.mvpWeights,statsViewSettings:(v=s.payload)==null?void 0:v.statsViewSettings,disruptionMethod:(M=s.payload)==null?void 0:M.disruptionMethod},rn=!0,Ln();return}if((s==null?void 0:s.type)==="log"){Ve||(Ve={logs:[]}),Ve.logs.push(po(s.payload)),rn=!0,Ln();return}(s==null?void 0:s.type)==="flush"&&(typeof s.flushId=="number"&&(Hn=s.flushId),rn=!0,st())}})();
