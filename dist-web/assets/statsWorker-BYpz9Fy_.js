(function(){"use strict";const Kt=["selfBuffs","groupBuffs","squadBuffs"],Gt=o=>o!=null&&o.classification?o.classification==="Boon":!0,Jt=o=>`b${o}`,Bn=(o,s)=>{const c=Array.isArray(o==null?void 0:o.activeTimes)?o.activeTimes:[],k=typeof c[0]=="number"?c[0]:0;return k>0?k:s},Yt=(o,s,c,k,v,B,oe)=>{const _=o==="selfBuffs"?1:Math.max(o==="groupBuffs"?B-1:oe-1,0);return!_||!v?{generationMs:0,wastedMs:0}:s?{generationMs:c*v*_,wastedMs:k*v*_}:{generationMs:c/100*v*_,wastedMs:k/100*v*_}},In=o=>{const s=new Map,c=new Map;return o.forEach(B=>{const oe=B.details;if(!oe)return;const _=oe.durationMS||0,ie=oe.buffMap||{};Object.entries(ie).forEach(([M,I])=>{if(!s.has(M)){s.set(M,I);return}const se=s.get(M)||{},T={name:se.name||I.name,stacking:se.stacking??I.stacking,icon:se.icon||I.icon,classification:se.classification||I.classification};s.set(M,T)});const qe=(oe.players||[]).filter(M=>!M.notInSquad),ge=qe.length,ce=new Map;qe.forEach(M=>{const I=M.group??0;ce.set(I,(ce.get(I)||0)+1)}),qe.forEach(M=>{const I=M.account||M.name||M.character_name||"Unknown",se=M.profession||"Unknown",T=M.group??0,J=ce.get(T)||1,Y=Bn(M,_);c.has(I)||c.set(I,{account:I,profession:se,professions:new Set,professionTimeMs:{},activeTimeMs:0,numFights:0,groupSupported:0,squadSupported:0,boons:{}});const Q=c.get(I);Q.profession=se,se!=="Unknown"&&(Q.professions.add(se),Q.professionTimeMs[se]=(Q.professionTimeMs[se]||0)+Y),Q.activeTimeMs+=Y,Q.numFights+=1,Q.groupSupported+=J,Q.squadSupported+=ge,Kt.forEach(pe=>{(M[pe]||[]).forEach(te=>{var Fe,He,Ne,Xe;if(typeof(te==null?void 0:te.id)!="number")return;const Pe=Jt(te.id),Ee=ie[Pe];if(!Gt(Ee))return;const Ce=(Ee==null?void 0:Ee.stacking)??!1,_e=((He=(Fe=te.buffData)==null?void 0:Fe[0])==null?void 0:He.generation)??0,be=((Xe=(Ne=te.buffData)==null?void 0:Ne[0])==null?void 0:Xe.wasted)??0,{generationMs:ke,wastedMs:Re}=Yt(pe,Ce,_e,be,_,J,ge);!ke&&!Re||(s.has(Pe)||s.set(Pe,Ee||{}),Q.boons[Pe]||(Q.boons[Pe]={selfBuffs:{generationMs:0,wastedMs:0},groupBuffs:{generationMs:0,wastedMs:0},squadBuffs:{generationMs:0,wastedMs:0}}),Q.boons[Pe][pe].generationMs+=ke,Q.boons[Pe][pe].wastedMs+=Re)})})})}),{boonTables:Array.from(s.keys()).filter(B=>Gt(s.get(B))).map(B=>{const oe=s.get(B)||{},_=[];return c.forEach(ie=>{var M;const Le=ie.boons[B];if(!Le||!Kt.some(I=>Le[I].generationMs>0||Le[I].wastedMs>0))return;const ge=Array.from(ie.professions||[]).filter(I=>I&&I!=="Unknown");let ce=ie.profession;if(ge.length>0){ce=ge[0];let I=((M=ie.professionTimeMs)==null?void 0:M[ce])||0;ge.forEach(se=>{var J;const T=((J=ie.professionTimeMs)==null?void 0:J[se])||0;T>I&&(I=T,ce=se)})}_.push({account:ie.account,profession:ce||"Unknown",professionList:ge,activeTimeMs:ie.activeTimeMs||1,numFights:ie.numFights||1,groupSupported:ie.groupSupported||1,squadSupported:ie.squadSupported||1,categories:{selfBuffs:{...Le.selfBuffs},groupBuffs:{...Le.groupBuffs},squadBuffs:{...Le.squadBuffs}}})}),{id:B,name:oe.name||B,icon:oe.icon,stacking:oe.stacking??!1,rows:_}}).filter(B=>B.rows.length>0)}},Qt=(o,s,c,k,v,B,oe={})=>{var M,I,se,T;const ie=((o==null?void 0:o[s])||[]).find(J=>J.id===c);if(!ie)return{generationMs:0,wastedMs:0};const Le=oe[Jt(c)],qe=(Le==null?void 0:Le.stacking)??!1,ge=((I=(M=ie.buffData)==null?void 0:M[0])==null?void 0:I.generation)??0,ce=((T=(se=ie.buffData)==null?void 0:se[0])==null?void 0:T.wasted)??0;return Yt(s,qe,ge,ce,k,v,B)};var Pn={methods:{tiered:{tiers:{shortMs:500,mediumMs:1500,weights:{short:.5,medium:1,long:2}}}}};const Un=Pn,Ht="count",Hn=o=>(o||0)/1e3,Ln=(o,s)=>{var v;if(!o)return 0;const c=(v=Un.methods.tiered)==null?void 0:v.tiers;if(!c)return o;const k=s/Math.max(o,1);return k<=c.shortMs?o*c.weights.short:k<=c.mediumMs?o*c.weights.medium:o*c.weights.long},Xt=(o,s,c)=>c==="duration"?Hn(s):c==="tiered"?Ln(o,s):o;function $n(o,s=Ht){var B;const c=(B=o.statsAll)==null?void 0:B[0],k=Number((c==null?void 0:c.appliedCrowdControl)??0),v=Number((c==null?void 0:c.appliedCrowdControlDuration)??0);return Xt(k,v,s)}function On(o,s){const c=(s==null?void 0:s.durationMS)||0,k=(s==null?void 0:s.buffMap)||{},v=o.filter(_=>!_.notInSquad),B=v.length,oe=new Map;v.forEach(_=>{const ie=_.group??0;oe.set(ie,(oe.get(ie)||0)+1)}),v.forEach(_=>{const ie=oe.get(_.group??0)||1,Le=Qt(_,"selfBuffs",1122,c,ie,B,k),qe=Qt(_,"squadBuffs",1122,c,ie,B,k);_.stabGeneration=(Le.generationMs+qe.generationMs)/1e3})}function _n(o){if(!o.statsTargets)return 0;let s=0;for(const c of o.statsTargets)c&&c.length>0&&(s+=c[0].downContribution||0);return s}function Rn(o){if(!o.extBarrierStats||!o.extBarrierStats.outgoingBarrierAllies)return 0;let s=0;for(const c of o.extBarrierStats.outgoingBarrierAllies)if(c)for(const k of c)k&&(s+=k.barrier||0);return s}function xn(o){if(!o.extHealingStats||!o.extHealingStats.outgoingHealingAllies)return 0;let s=0;for(const c of o.extHealingStats.outgoingHealingAllies)if(c)for(const k of c)k&&(s+=k.healing||0);return s}const qn=o=>{var s,c,k,v;return(((c=(s=o.support)==null?void 0:s[0])==null?void 0:c.condiCleanse)||0)+(((v=(k=o.support)==null?void 0:k[0])==null?void 0:v.condiCleanseSelf)||0)},jn=(o,s=Ht)=>{var B;const c=(B=o.support)==null?void 0:B[0],k=Number((c==null?void 0:c.boonStrips)??0),v=Number((c==null?void 0:c.boonStripsTime)??0);return Xt(k,v,s)},Wn=o=>_n(o),Vn=o=>xn(o),zn=o=>Rn(o),Kn=(o,s=Ht)=>$n(o,s),Gn=(o,s)=>On(o,s),Jn="count",Yn={downContribution:1,healing:1,cleanses:1,strips:1,stability:1,cc:.7,revives:.7,distanceToTag:.7,participation:.7,dodging:.4,dps:.2,damage:.2},Qn={showMvp:!0,topSkillDamageSource:"target",topSkillsMetric:"damage"},Zt=new Map([["bleeding","Bleeding"],["burning","Burning"],["confusion","Confusion"],["poison","Poison"],["torment","Torment"],["vulnerability","Vulnerability"],["weakness","Weakness"],["weakened","Weakness"],["blind","Blind"],["blinded","Blind"],["blinding","Blind"],["cripple","Cripple"],["crippled","Cripple"],["chill","Chill"],["chilled","Chill"],["immob","Immobilize"],["immobile","Immobilize"],["immobilized","Immobilize"],["slow","Slow"],["slowed","Slow"],["fear","Fear"],["feared","Fear"],["taunt","Taunt"],["taunted","Taunt"]]),Xn={Blind:"https://render.guildwars2.com/file/09770136BB76FD0DBE1CC4267DEED54774CB20F6/102837.png",Chill:"https://render.guildwars2.com/file/28C4EC547A3516AF0242E826772DA43A5EAC3DF3/102839.png",Cripple:"https://render.guildwars2.com/file/070325E519C178D502A8160523766070D30C0C19/102838.png",Fear:"https://render.guildwars2.com/file/30307A6E766D74B6EB09EDA12A4A2DE50E4D76F4/102869.png",Immobilize:"https://render.guildwars2.com/file/397A613651BFCA2832B6469CE34735580A2C120E/102844.png",Slow:"https://render.guildwars2.com/file/F60D1EF5271D7B9319610855676D320CD25F01C6/961397.png",Taunt:"https://render.guildwars2.com/file/02EED459AD65FAF7DF32A260E479C625070841B9/1228472.png",Vulnerability:"https://render.guildwars2.com/file/3A394C1A0A3257EB27A44842DDEEF0DF000E1241/102850.png",Weakness:"https://render.guildwars2.com/file/6CB0E64AF9AA292E332A38C1770CE577E2CDE0E8/102853.png"},ft=o=>{if(!o)return null;const s=o.trim().toLowerCase(),c=Zt.get(s);if(c)return c;const k=s.split(/[^a-z]+/).filter(Boolean);for(const v of k){const B=Zt.get(v);if(B)return B}return null},Zn=o=>ft(o),yt=o=>{const s=new Map;return o&&(Object.values(o).forEach(c=>{if(!(c!=null&&c.icon)||!(c!=null&&c.name))return;const k=ft(c.name);k&&(s.has(k)||s.set(k,c.icon))}),Object.entries(Xn).forEach(([c,k])=>{s.has(c)||s.set(c,k)})),s},Tt=(o,s,c)=>{var k;if(s&&c){const v=(k=c[`b${s}`])==null?void 0:k.name,B=ft(v);if(B)return B}return o?ft(o):null},yn=o=>{const s=(o==null?void 0:o.account)||"Unknown";return s&&s!=="Unknown"?s:(o==null?void 0:o.name)||"Unknown"||null},eo=o=>{if(!o||o.length===0)return 0;let s=0,c=null;return o.forEach(k=>{const v=Number(k[1]??0);if(Number.isFinite(v)){if(c===null){c=v;return}v>c&&(s+=v-c),c=v}}),s},to=o=>{if(!o||o.length===0)return 0;let s=0;return o.forEach(c=>{const k=Number(c[0]??0),v=Number(c[1]??0);Number.isFinite(v)&&k!==0&&v>0&&(s+=1)}),s},no=o=>{const{players:s,targets:c,skillMap:k,buffMap:v}=o,B=o.getPlayerKey||yn,oe=yt(v),_={},ie={};s.forEach(M=>{if(M!=null&&M.notInSquad)return;const I=B(M);I&&(_[I]||(_[I]={}),M!=null&&M.totalDamageDist&&M.totalDamageDist.forEach(se=>{se&&se.forEach(T=>{if(!T.id)return;let J=`Skill ${T.id}`,Y;k&&(k[`s${T.id}`]?(J=k[`s${T.id}`].name||J,Y=k[`s${T.id}`].icon||Y):k[`${T.id}`]&&(J=k[`${T.id}`].name||J,Y=k[`${T.id}`].icon||Y));const Q=Tt(J,T.id,v);if(!Q)return;const pe=v==null?void 0:v[`b${T.id}`],Oe=pe==null?void 0:pe.name,te=oe.get(Q)||(pe==null?void 0:pe.icon),Pe=J.startsWith("Skill ")?Oe||Q:J,Ee=Y||(pe==null?void 0:pe.icon),Ce=Number(T.connectedHits??0),_e=Number(T.hits??0),be=Ce>0?Ce:_e,ke=Number(T.totalDamage??0);if(!Number.isFinite(be)&&!Number.isFinite(ke))return;const Re=ie[Q]||{name:Q,icon:te,applications:0,damage:0};Re.applications+=Number.isFinite(be)?be:0,Re.damage+=Number.isFinite(ke)?ke:0,!Re.icon&&te&&(Re.icon=te),ie[Q]=Re;const Fe=_[I][Q]||{icon:te,applications:0,damage:0,skills:{}};Fe.applications+=Number.isFinite(be)?be:0,Fe.damage+=Number.isFinite(ke)?ke:0;const He=Fe.skills[Pe]||{name:Pe,hits:0,damage:0,icon:Ee};He.hits+=Number.isFinite(be)?be:0,He.damage+=Number.isFinite(ke)?ke:0,!He.icon&&Ee&&(He.icon=Ee),Fe.skills[Pe]=He,!Fe.icon&&te&&(Fe.icon=te),_[I][Q]=Fe})}))});const Le=new Map;s.forEach(M=>{if(M!=null&&M.notInSquad)return;const I=B(M);I&&M!=null&&M.name&&Le.set(M.name,I)});let qe=0,ge=0,ce=0;return c.forEach(M=>{M!=null&&M.buffs&&M.buffs.forEach(I=>{const se=Number(I==null?void 0:I.id);if(!Number.isFinite(se))return;const T=v==null?void 0:v[`b${se}`],J=ft(T==null?void 0:T.name);if(!J||T!=null&&T.classification&&T.classification!=="Condition")return;const Y=J;if(!Y)return;const Q=I.statesPerSource||{};ce+=1,Object.entries(Q).forEach(([pe,Oe])=>{var be;const te=Le.get(pe);if(!te)return;ge+=1;const Pe=eo(Oe),Ee=to(Oe);qe+=Pe;const Ce=((be=_[te])==null?void 0:be[Y])||{applications:0,damage:0,skills:{}};Ce.applicationsFromBuffs=(Ce.applicationsFromBuffs||0)+Pe,Ce.applicationsFromBuffsActive=(Ce.applicationsFromBuffsActive||0)+Ee,_[te]=_[te]||{},_[te][Y]=Ce;const _e=ie[Y]||{name:Y,applications:0,damage:0};_e.applicationsFromBuffs=(_e.applicationsFromBuffs||0)+Pe,_e.applicationsFromBuffsActive=(_e.applicationsFromBuffsActive||0)+Ee,ie[Y]=_e})})}),Object.values(_).forEach(M=>{Object.values(M).forEach(I=>{typeof I.applicationsFromBuffs=="number"&&(I.applications=I.applicationsFromBuffs)})}),Object.values(ie).forEach(M=>{typeof M.applicationsFromBuffs=="number"&&(M.applications=M.applicationsFromBuffs)}),{playerConditions:_,summary:ie,meta:{buffStateApplicationsTotal:qe,targetBuffEntriesSeen:ce,buffStateSourcesSeen:ge}}},oo=new Set(["Vulnerability","Weakness","Blind","Cripple","Chill","Immobilize","Slow","Fear","Taunt"]),io=[{id:"damage",label:"Damage",field:"damage",source:"dpsAll"},{id:"directDmg",label:"Direct Damage",field:"directDmg",source:"statsTargets"},{id:"connectedDamageCount",label:"Connected Damage Count",field:"connectedDamageCount",source:"statsTargets"},{id:"connectedDirectDamageCount",label:"Connected Direct Damage Count",field:"connectedDirectDamageCount",source:"statsTargets"},{id:"battleStandardHits",label:"Battle Standard Tracking"},{id:"criticalRate",label:"Critical Rate",field:"criticalRate",isRate:!0,isPercent:!0,denomField:"critableDirectDamageCount",source:"statsTargets"},{id:"criticalDmg",label:"Critical Damage",field:"criticalDmg",source:"statsTargets"},{id:"flankingRate",label:"Flanking Rate",field:"flankingRate",isRate:!0,isPercent:!0,denomField:"connectedDirectDamageCount",source:"statsTargets"},{id:"glanceRate",label:"Glance Rate",field:"glanceRate",isRate:!0,isPercent:!0,denomField:"connectedDirectDamageCount",source:"statsTargets"},{id:"missed",label:"Missed",field:"missed",source:"statsTargets"},{id:"evaded",label:"Evaded (enemy)",field:"evaded",source:"statsTargets"},{id:"blocked",label:"Blocked (enemy)",field:"blocked",source:"statsTargets"},{id:"interrupts",label:"Interrupts",field:"interrupts",source:"statsTargets"},{id:"invulned",label:"Invulned",field:"invulned",source:"statsTargets"},{id:"killed",label:"Killed",field:"killed",source:"statsTargets"},{id:"downed",label:"Downed",field:"downed",source:"statsTargets"},{id:"downContribution",label:"Down Contribution",field:"downContribution",source:"statsTargets"},{id:"downContributionPercent",label:"Down Contribution %",isRate:!0,isPercent:!0},{id:"againstDownedDamage",label:"Against Downed Damage",field:"againstDownedDamage",source:"statsTargets"},{id:"appliedCrowdControl",label:"Applied CC",field:"appliedCrowdControl",source:"statsTargets"},{id:"appliedCrowdControlDuration",label:"Applied CC Duration",field:"appliedCrowdControlDuration",source:"statsTargets"},{id:"appliedCrowdControlDownContribution",label:"Applied CC Down Contribution",field:"appliedCrowdControlDownContribution",source:"statsTargets"},{id:"appliedCrowdControlDurationDownContribution",label:"Applied CC Duration Down Contribution",field:"appliedCrowdControlDurationDownContribution",source:"statsTargets"},{id:"boonStrips",label:"Boon Strips",field:"boonStrips",source:"support"}],so=[{id:"damageTaken",label:"Damage Taken",field:"damageTaken"},{id:"damageTakenCount",label:"Damage Taken Count",field:"damageTakenCount"},{id:"conditionDamageTaken",label:"Condition Damage Taken",field:"conditionDamageTaken"},{id:"conditionDamageTakenCount",label:"Condition Damage Taken Count",field:"conditionDamageTakenCount"},{id:"powerDamageTaken",label:"Power Damage Taken",field:"powerDamageTaken"},{id:"powerDamageTakenCount",label:"Power Damage Taken Count",field:"powerDamageTakenCount"},{id:"downedDamageTaken",label:"Downed Damage Taken",field:"downedDamageTaken"},{id:"downedDamageTakenCount",label:"Downed Damage Taken Count",field:"downedDamageTakenCount"},{id:"damageBarrier",label:"Damage Barrier",field:"damageBarrier"},{id:"damageBarrierCount",label:"Damage Barrier Count",field:"damageBarrierCount"},{id:"blockedCount",label:"Blocked Count",field:"blockedCount"},{id:"evadedCount",label:"Evaded Count",field:"evadedCount"},{id:"missedCount",label:"Missed Count",field:"missedCount"},{id:"dodgeCount",label:"Dodge Count",field:"dodgeCount"},{id:"invulnedCount",label:"Invulnerable Count",field:"invulnedCount"},{id:"interruptedCount",label:"Interrupted Count",field:"interruptedCount"},{id:"downCount",label:"Down Count",field:"downCount"},{id:"deadCount",label:"Death Count",field:"deadCount"},{id:"boonStrips",label:"Boon Strips (Incoming)",field:"boonStrips"},{id:"conditionCleanses",label:"Cleanses (Incoming)",field:"conditionCleanses"},{id:"receivedCrowdControl",label:"Crowd Control (Incoming)",field:"receivedCrowdControl"}],ao=[{id:"condiCleanse",label:"Condition Cleanses",field:"condiCleanse"},{id:"condiCleanseTime",label:"Condition Cleanse Time",field:"condiCleanseTime",isTime:!0},{id:"condiCleanseSelf",label:"Condition Cleanse Self",field:"condiCleanseSelf"},{id:"condiCleanseTimeSelf",label:"Condition Cleanse Time Self",field:"condiCleanseTimeSelf",isTime:!0},{id:"boonStrips",label:"Boon Strips",field:"boonStrips"},{id:"boonStripsTime",label:"Boon Strips Time",field:"boonStripsTime",isTime:!0},{id:"boonStripDownContribution",label:"Boon Strip Down Contribution",field:"boonStripDownContribution"},{id:"boonStripDownContributionTime",label:"Boon Strip Down Contribution Time",field:"boonStripDownContributionTime",isTime:!0},{id:"stunBreak",label:"Stun Breaks",field:"stunBreak"},{id:"removedStunDuration",label:"Removed Stun Duration",field:"removedStunDuration",isTime:!0},{id:"resurrects",label:"Resurrects",field:"resurrects"},{id:"resurrectTime",label:"Resurrect Time",field:"resurrectTime",isTime:!0}],ro=["battle standard","glyph of renewal","glyph of the stars","illusion of life","spirit of nature","nature spirit","search and rescue","signet of mercy"],co=new Set([10244]),lo=(o,s)=>{var v;if(co.has(o))return!0;const c=(s==null?void 0:s[`s${o}`])||(s==null?void 0:s[`${o}`]),k=((v=c==null?void 0:c.name)==null?void 0:v.toLowerCase())||"";return ro.some(B=>k.includes(B))},uo=o=>{if(!o||!Number.isFinite(o))return"--:--";const s=Math.max(0,Math.round(o/1e3)),c=Math.floor(s/3600),k=Math.floor(s%3600/60),v=s%60;return c>0?`${c}:${String(k).padStart(2,"0")}:${String(v).padStart(2,"0")}`:`${k}:${String(v).padStart(2,"0")}`},At={Guardian:"#72C1D9",Dragonhunter:"#72C1D9",Firebrand:"#72C1D9",Willbender:"#72C1D9",Revenant:"#D16E5A",Herald:"#D16E5A",Renegade:"#D16E5A",Vindicator:"#D16E5A",Warrior:"#FFD166",Berserker:"#FFD166",Spellbreaker:"#FFD166",Bladesworn:"#FFD166",Engineer:"#D09C59",Scrapper:"#D09C59",Holosmith:"#D09C59",Mechanist:"#D09C59",Ranger:"#8CDC82",Druid:"#8CDC82",Soulbeast:"#8CDC82",Untamed:"#8CDC82",Thief:"#C08F95",Daredevil:"#C08F95",Deadeye:"#C08F95",Specter:"#C08F95",Elementalist:"#F68A87",Tempest:"#F68A87",Weaver:"#F68A87",Catalyst:"#F68A87",Mesmer:"#B679D5",Chronomancer:"#B679D5",Mirage:"#B679D5",Virtuoso:"#B679D5",Necromancer:"#52A76F",Reaper:"#52A76F",Scourge:"#52A76F",Harbinger:"#52A76F",Ritualist:"#52A76F",Luminary:"#72C1D9",Conduit:"#D16E5A",Paragon:"#FFD166",Amalgam:"#D09C59",Galeshot:"#8CDC82",Antiquary:"#C08F95",Evoker:"#F68A87",Troubadour:"#B679D5",Unknown:"#64748B"};function en(o){return At[o]||At.Unknown}const mo=o=>{if(o==null||o==="")return 0;if(typeof o=="number")return!Number.isFinite(o)||o<=0?0:o>1e12?o:o*1e3;if(o instanceof Date){const oe=o.getTime();return Number.isFinite(oe)&&oe>0?oe:0}const s=String(o).trim();if(!s)return 0;const c=Number(s);if(Number.isFinite(c)&&c>0)return c>1e12?c:c*1e3;const k=Date.parse(s);if(Number.isFinite(k)&&k>0)return k;const v=s.replace(/([+-]\d{2})$/,"$1:00"),B=Date.parse(v);return Number.isFinite(B)&&B>0?B:0},nt=(o,s)=>mo((o==null?void 0:o.uploadTime)??(s==null?void 0:s.uploadTime)??(o==null?void 0:o.timeStartStd)??(o==null?void 0:o.timeStart)??(o==null?void 0:o.timeEndStd)??(o==null?void 0:o.timeEnd)??(o==null?void 0:o.timeStartText)??(o==null?void 0:o.timeEndText)),fo=({logs:o,precomputedStats:s,mvpWeights:c,statsViewSettings:k,disruptionMethod:v})=>{const B=(()=>{const ge=o.filter(ce=>ce.details&&ce.details.players&&ce.details.players.length>0);return console.log("[useStatsAggregation] Filtering logs:",{total:o.length,passed:ge.length,statuses:o.map(ce=>ce.status),hasDetails:o.map(ce=>!!ce.details)}),ge})(),oe=k||Qn,_=c||Yn,ie=ge=>{if(!ge||typeof ge!="object")return ge;const ce=Array.isArray(ge.fightBreakdown)?ge.fightBreakdown:null;if(!ce||ce.length===0)return ge;const M=new Map,I=new Map;o.forEach(T=>{var Q;const J=(T==null?void 0:T.filePath)||(T==null?void 0:T.id);J&&M.set(String(J),T);const Y=(T==null?void 0:T.permalink)||((Q=T==null?void 0:T.details)==null?void 0:Q.permalink);typeof Y=="string"&&Y.trim()&&I.set(Y.trim(),T)});const se=ce.map(T=>{if(!T||typeof T!="object"||Number(T.timestamp)>0)return T;const Y=T.id?String(T.id):"",Q=typeof T.permalink=="string"?T.permalink.trim():"",pe=(Y?M.get(Y):void 0)||(Q?I.get(Q):void 0);if(!pe)return T;const Oe=nt(pe==null?void 0:pe.details,pe);return Oe?{...T,timestamp:Oe}:T});return{...ge,fightBreakdown:se}},Le=(()=>{if(s)return ie(s);const ge=v||Jn,ce=oe.topSkillDamageSource||"target",M=oe.topSkillsMetric||"damage",I=B.length;let se=0,T=0,J=0,Y=0,Q=0,pe=0,Oe=0,te=0;const Pe=e=>{const n=((e==null?void 0:e.players)||[]).filter($=>!$.notInSquad);let u=0,a=0,f=0,p=0;return n.forEach($=>{var X;const S=(X=$.defenses)==null?void 0:X[0];if(!S)return;const j=Number(S.downCount||0),le=Number(S.deadCount||0);u+=j+le,f+=le}),n.forEach($=>{!$.statsTargets||$.statsTargets.length===0||$.statsTargets.forEach(S=>{const j=S==null?void 0:S[0];if(!j)return;const le=Number(j.downed||0),X=Number(j.killed||0);a+=le+X,p+=X})}),{squadDownsDeaths:u,enemyDownsDeaths:a,squadDeaths:f,enemyDeaths:p}},Ee=e=>{const{squadDownsDeaths:t,enemyDownsDeaths:n}=Pe(e);return t>0||n>0?n>t:typeof(e==null?void 0:e.success)=="boolean"?e.success:!1},Ce=new Map,_e=new Set(["boonStripsTime","condiCleanseTime","condiCleanseTimeSelf"]),be={},ke={},Re=new Map,Fe={},He={},Ne={},Xe=new Map,Ge=new Map,Mt=new Set(Object.keys(At)),Nt=Object.keys(At).filter(e=>e&&e!=="Unknown").sort((e,t)=>t.length-e.length),wt=["Guardian","Revenant","Warrior","Engineer","Ranger","Thief","Elementalist","Mesmer","Necromancer"],lt=e=>{if(!e)return"Unknown";const t=String(e).replace(/\s*\([^)]*\)\s*$/,"").replace(/\s*\[[^\]]*\]\s*$/,"").replace(/\s\d+$/,"").trim();if(Mt.has(t))return t;const n=t.toLowerCase();for(const a of Nt)if(n.includes(a.toLowerCase()))return a;return wt.find(a=>n.includes(a.toLowerCase()))||t||"Unknown"},po=e=>e!=null&&e.classification?e.classification==="Boon":!0,vt=new Map,Et=new Map,gt=()=>({totalHits:0,blocked:0,evaded:0,glanced:0,missed:0,invulned:0,interrupted:0,totalMitigation:0,minMitigation:0}),G=e=>{const t=Number(e);return Number.isFinite(t)?t:0},rn=e=>{const t=String(e).split("|"),n=t[0]||"Unknown",u=lt(t[1]||"Unknown"),a=t[2]||n||"Unknown";return{name:n,profession:u,account:a}},cn=(e,t,n)=>{let u=e.get(t);return u?n.profession&&!u.professionList.includes(n.profession)&&u.professionList.push(n.profession):(u={account:n.account,name:n.name,profession:n.profession,professionList:n.profession?[n.profession]:[],activeMs:0,mitigationTotals:gt()},e.set(t,u)),u},ln=(e,t,n)=>{let u=e.get(t);return u?n.profession&&!u.professionList.includes(n.profession)&&u.professionList.push(n.profession):(u={account:n.account,name:n.name,profession:n.profession,professionList:n.profession?[n.profession]:[],activeMs:0,mitigationTotals:gt(),minion:n.minion},e.set(t,u)),u},un=(e,t)=>{e.totalHits+=G((t==null?void 0:t.skill_hits)??(t==null?void 0:t.skillHits)),e.blocked+=G(t==null?void 0:t.blocked),e.evaded+=G(t==null?void 0:t.evaded),e.glanced+=G(t==null?void 0:t.glanced),e.missed+=G(t==null?void 0:t.missed),e.invulned+=G(t==null?void 0:t.invulned),e.interrupted+=G(t==null?void 0:t.interrupted),e.totalMitigation+=G((t==null?void 0:t.avoided_damage)??(t==null?void 0:t.avoidedDamage)),e.minMitigation+=G((t==null?void 0:t.min_avoided_damage)??(t==null?void 0:t.minAvoidedDamage))},bo=e=>Object.values(e).some(t=>t>0);console.log("[useStatsAggregation] Starting aggregation loop",{validLogsCount:B.length});const Ft=(e,t,n)=>{var f,p,$,S;const u=`s${e}`;if((f=t==null?void 0:t[u])!=null&&f.name)return t[u].name;if((p=t==null?void 0:t[String(e)])!=null&&p.name)return t[String(e)].name;const a=`b${e}`;return($=n==null?void 0:n[a])!=null&&$.name?n[a].name:(S=n==null?void 0:n[String(e)])!=null&&S.name?n[String(e)].name:`Unknown Skill ${e}`},pt=new Map,it=e=>{const t=pt.get(e);if(!t)return{hasSkill:!1,avg:1,min:1,hits:0};const n=t.connectedHits||0,u=n>0?t.totalDamage/n:0,a=t.minCount>0?t.minTotal/t.minCount:0;return{hasSkill:!0,avg:u,min:a,hits:n}},Bt="Ashtonlightstone.9145",dn="Illusionary Warden",Ot=[],st=[],_t=[],Rt=[],mn=new Map,fn=new Map,gn=(e,t,n)=>{const u=e.get(t)||gt();return u.totalHits+=n.totalHits,u.blocked+=n.blocked,u.evaded+=n.evaded,u.glanced+=n.glanced,u.missed+=n.missed,u.invulned+=n.invulned,u.interrupted+=n.interrupted,e.set(t,u),u};B.forEach(e=>{const t=e.details;if(!t)return;(t.targets||[]).forEach(u=>{const a=(u==null?void 0:u.totalDamageDist)||[],f=Array.isArray(a)?a[0]:null;f==null||f.forEach(p=>{if(!(p!=null&&p.id))return;const $=Number(p.id),S=pt.get($)||{totalDamage:0,connectedHits:0,minTotal:0,minCount:0};S.totalDamage+=Number(p.totalDamage||0),S.connectedHits+=Number(p.connectedHits||0);const j=Number.isFinite(Number(p.min))?Number(p.min):0;S.minTotal+=j,S.minCount+=1,pt.set($,S)})})}),B.forEach((e,t)=>{var Qe,ut;const n=e.details;if(!n)return;const u=n.players;console.log(`[useStatsAggregation] Processing log ${t}:`,{playerCount:u==null?void 0:u.length,hasTargets:!!n.targets,firstPlayer:u!=null&&u[0]?{account:u[0].account,notInSquad:u[0].notInSquad}:"none"});const a=n.targets||[],f=n.skillMap||{},p=n.buffMap||{},$=new Map,S=new Map;a.forEach(i=>{const m=(i==null?void 0:i.totalDamageDist)||[],A=Array.isArray(m)?m[0]:null;A==null||A.forEach(V=>{var y;if(!(V!=null&&V.id))return;const U=Number(V.id),h=((y=f==null?void 0:f[U])==null?void 0:y.name)||V.name||V.skillName||String(U),K=$.get(U)||{totalDamage:0,connectedHits:0,minTotal:0,minCount:0};K.totalDamage+=Number(V.totalDamage||0),K.connectedHits+=Number(V.connectedHits||0);const w=Number.isFinite(Number(V.min))?Number(V.min):0;K.minTotal+=w,K.minCount+=1,$.set(U,K);const x=S.get(h)||{totalDamage:0,connectedHits:0,minTotal:0,minCount:0};x.totalDamage+=Number(V.totalDamage||0),x.connectedHits+=Number(V.connectedHits||0);const me=Number.isFinite(Number(V.min))?Number(V.min):0;x.minTotal+=me,x.minCount+=1,S.set(h,x)})});const j=i=>{const m=$.get(i);if(!m||m.connectedHits<=0)return{avg:1,min:1};const A=m.connectedHits>0?m.totalDamage/m.connectedHits:0,V=m.minCount>0?m.minTotal/m.minCount:A;return{avg:A||1,min:V||1}},le=i=>{const m=S.get(i);if(!m||m.connectedHits<=0)return{avg:1,min:1};const A=m.connectedHits>0?m.totalDamage/m.connectedHits:0,V=m.minCount>0?m.minTotal/m.minCount:A;return{avg:A||1,min:V||1}},X=n.combatReplayMetaData||{},D=(X==null?void 0:X.inchToPixel)>0?X.inchToPixel:1,E=(X==null?void 0:X.pollingRate)>0?X.pollingRate:1,F=5e3,O=i=>Array.isArray(i)?i.map(m=>Array.isArray(m)?[Number(m[0]),Number(m[1])]:null).filter(m=>!!m&&Number.isFinite(m[0])):[];let ue=[],ee=n.durationMS||0,Se=!1;const Te=u.find(i=>(i==null?void 0:i.hasCommanderTag)&&!(i!=null&&i.notInSquad));(Qe=Te==null?void 0:Te.combatReplayData)!=null&&Qe.positions&&(ue=Te.combatReplayData.positions,O(Te.combatReplayData.dead).forEach(([m])=>{m>0&&(Se=!0,ee=Math.min(ee,m))}));const ae=i=>{var x;const m=(x=i.statsAll)==null?void 0:x[0];if((m==null?void 0:m.distToCom)!==void 0&&(m==null?void 0:m.distToCom)!=="Infinity")return Math.round(Number(m.distToCom));if((m==null?void 0:m.stackDist)!==void 0)return Math.round(Number(m.stackDist))||0;if(i.hasCommanderTag)return 0;const A=i.combatReplayData;if(!(A!=null&&A.positions)||!ue.length)return 0;const V=A.positions,U=O(A.dead),h=O(A.down),K=Math.floor((A.start||0)/E);let w=0;if(U.length&&h.length)for(const[me]of U){if(me<0)continue;const y=Math.max(0,Math.floor(me/E))-K;for(const[N,P]of h){if(me!==P)continue;const L=Se&&N>ee?Math.max(1,Math.floor(ee/E)):y,he=Math.max(0,Math.min(L,V.length,ue.length));if(he<=0)continue;let Z=0;for(let Ae=0;Ae<he;Ae++){const[q,fe]=V[Ae],[re,ne]=ue[Ae];Z+=Math.hypot(q-re,fe-ne)}w=Math.round(Z/he/D)}}return w},de=u.filter(i=>!i.notInSquad);J+=de.length,Y+=a.filter(i=>!i.isFake).length,Gn(u,{durationMS:n.durationMS,buffMap:n.buffMap});const{squadDeaths:we,enemyDeaths:r}=Pe(n);Q+=we,pe+=r,te+=we,Oe+=r,Ee(n)?se++:T++;const g=n.skillMap?Number((ut=Object.keys(n.skillMap).find(i=>{var m,A;return((A=(m=n.skillMap)==null?void 0:m[i])==null?void 0:A.name)==="Battle Standard"}))==null?void 0:ut.replace(/^s/,"")):null;u.forEach((i,m)=>{var Ze,ye,at,rt,Pt,bt,ht,Sn,Tn,An,Mn,Nn;if(i.notInSquad)return;const A=i.account||"Unknown",V=A!=="Unknown"?A:i.name||"Unknown",U=i.name||"Unknown";Ce.has(V)||Ce.set(V,{name:U,account:V,downContrib:0,cleanses:0,strips:0,stab:0,healing:0,barrier:0,cc:0,logsJoined:0,totalDist:0,distCount:0,dodges:0,downs:0,deaths:0,totalFightMs:0,offenseTotals:{},offenseRateWeights:{},defenseActiveMs:0,defenseTotals:{},supportActiveMs:0,supportTotals:{},healingActiveMs:0,healingTotals:{},profession:i.profession||"Unknown",professions:new Set,professionTimeMs:{},isCommander:!1,damage:0,dps:0,revives:0,outgoingConditions:{},incomingConditions:{}});const h=Ce.get(V);if(i.hasCommanderTag&&(h.isCommander=!0),i.profession&&i.profession!=="Unknown"){h.profession=i.profession,h.professions.add(i.profession);const l=Array.isArray(i.activeTimes)&&typeof i.activeTimes[0]=="number"?i.activeTimes[0]:n.durationMS||0;h.professionTimeMs[i.profession]=(h.professionTimeMs[i.profession]||0)+l}h.logsJoined++,h.downContrib+=Wn(i),h.cleanses+=qn(i),h.strips+=jn(i,ge),h.healing+=Vn(i),h.barrier+=zn(i),h.cc+=Kn(i,ge),h.stab+=i.stabGeneration||0;const K=ae(i);K<=F&&(h.totalDist+=K,h.distCount++),(Ze=i.defenses)!=null&&Ze[0]&&(h.dodges+=i.defenses[0].dodgeCount||0,h.downs+=i.defenses[0].downCount||0,h.deaths+=i.defenses[0].deadCount||0),n.durationMS&&(h.totalFightMs+=n.durationMS);const w=Array.isArray(i.activeTimes)&&typeof i.activeTimes[0]=="number"?i.activeTimes[0]:n.durationMS||0;h.defenseActiveMs+=w,h.supportActiveMs+=w,h.healingActiveMs+=w,Array.isArray(i.buffUptimes)&&i.buffUptimes.length>0&&i.buffUptimes.forEach(l=>{var wn,vn,En,Fn;if(typeof(l==null?void 0:l.id)!="number")return;const d=`b${l.id}`,C=((wn=n.buffMap)==null?void 0:wn[d])||((vn=n.buffMap)==null?void 0:vn[String(l.id)]);if(!C||po(C))return;const z=Number(((Fn=(En=l.buffData)==null?void 0:En[0])==null?void 0:Fn.uptime)??0);if(!Number.isFinite(z)||z<=0)return;const Be=(C==null?void 0:C.stacking)??!1,We=(Be?z:z/100)*w;if(!Number.isFinite(We)||We<=0)return;const Ue=Zn(C==null?void 0:C.name);if(Ue&&oo.has(Ue)&&(!(C!=null&&C.classification)||C.classification==="Condition")){const Ut=We/1e3,Ve=C==null?void 0:C.icon,Ct=Fe[Ue]||{name:Ue,icon:Ve,applications:0,damage:0};Ct.applicationsFromUptime=(Ct.applicationsFromUptime||0)+Ut,!Ct.icon&&Ve&&(Ct.icon=Ve),Fe[Ue]=Ct;const kt=h.outgoingConditions[Ue]||{applications:0,damage:0,skills:{},icon:Ve};kt.applicationsFromUptime=(kt.applicationsFromUptime||0)+Ut,!kt.icon&&Ve&&(kt.icon=Ve),h.outgoingConditions[Ue]=kt;const Dt=He[Ue]||{name:Ue,icon:Ve,applications:0,damage:0};Dt.applicationsFromUptime=(Dt.applicationsFromUptime||0)+Ut,!Dt.icon&&Ve&&(Dt.icon=Ve),He[Ue]=Dt;const St=h.incomingConditions[Ue]||{applications:0,damage:0,skills:{},icon:Ve};St.applicationsFromUptime=(St.applicationsFromUptime||0)+Ut,!St.icon&&Ve&&(St.icon=Ve),h.incomingConditions[Ue]=St}Xe.has(d)||Xe.set(d,{name:C==null?void 0:C.name,stacking:Be,icon:C==null?void 0:C.icon}),Ge.has(d)||Ge.set(d,new Map);const ot=Ge.get(d),dt=h.account||i.account||i.name||"Unknown";let tt=ot.get(dt);tt||(tt={account:dt,profession:h.profession||i.profession||"Unknown",professions:new Set,professionTimeMs:{},totalMs:0,durationMs:0},ot.set(dt,tt));const mt=i.profession||h.profession;mt&&mt!=="Unknown"&&(tt.professions.add(mt),tt.professionTimeMs[mt]=(tt.professionTimeMs[mt]||0)+w,tt.profession=mt),tt.totalMs+=We,tt.durationMs+=w}),(ye=i.defenses)!=null&&ye[0]&&so.forEach(l=>{const d=Number(i.defenses[0][l.field]??0);Number.isFinite(d)&&(h.defenseTotals[l.id]=(h.defenseTotals[l.id]||0)+d)}),(at=i.support)!=null&&at[0]&&ao.forEach(l=>{let d=Number(i.support[0][l.field]??0);Number.isFinite(d)&&(_e.has(l.field)&&d>999999&&(d=0),h.supportTotals[l.id]=(h.supportTotals[l.id]||0)+d)});const x=(l,d)=>{Number.isFinite(d)&&(h.healingTotals[l]=(h.healingTotals[l]||0)+d)},me=(l,d)=>Array.isArray(l)?l.reduce((C,z)=>C+Number((z==null?void 0:z[d])??0),0):0,y=(l,d,C)=>{if(!Number.isFinite(C)||C<=0)return;const z=u[d],Be=d===m,et=z==null?void 0:z.notInSquad,We=!et,Ue=We&&(z==null?void 0:z.group)!=null&&z.group===i.group;x(l,C),We&&x(`squad${l[0].toUpperCase()}${l.slice(1)}`,C),Ue&&x(`group${l[0].toUpperCase()}${l.slice(1)}`,C),Be&&x(`self${l[0].toUpperCase()}${l.slice(1)}`,C),et&&x(`offSquad${l[0].toUpperCase()}${l.slice(1)}`,C)};if(Array.isArray(i.rotation)){let l=0;i.rotation.forEach(d=>{var z;if(!(d!=null&&d.id)||!lo(d.id,n.skillMap))return;const C=((z=d.skills)==null?void 0:z.length)||0;C>0&&(l+=C,x(`resUtility_s${d.id}`,C))}),l>0&&x("resUtility",l)}const N=(rt=i.extHealingStats)==null?void 0:rt.outgoingHealingAllies;Array.isArray(N)&&N.forEach((l,d)=>{const C=me(l,"healing"),z=me(l,"downedHealing");y("healing",d,C),y("downedHealing",d,z)});const P=(Pt=i.extBarrierStats)==null?void 0:Pt.outgoingBarrierAllies;Array.isArray(P)&&P.forEach((l,d)=>{const C=me(l,"barrier");y("barrier",d,C)});const L=(bt=i.statsAll)==null?void 0:bt[0],he=(ht=i.dpsAll)==null?void 0:ht[0],Z=(Sn=i.support)==null?void 0:Sn[0];if(io.forEach(l=>{if(l.id==="downContributionPercent"||!l.field)return;let d=0,C=0;l.source==="dpsAll"&&he?d=Number(he[l.field]??0):l.source==="statsAll"&&L?(d=Number(L[l.field]??0),C=Number(L[l.denomField||l.weightField||"connectedDamageCount"]??0)):l.source==="support"&&Z?d=Number(Z[l.field]??0):i.statsTargets&&i.statsTargets.forEach(z=>{z!=null&&z[0]&&(d+=Number(z[0][l.field]??0),C+=Number(z[0][l.denomField||l.weightField||"connectedDamageCount"]??0))}),Number.isFinite(d)&&(h.offenseTotals[l.id]=(h.offenseTotals[l.id]||0)+d,l.isRate&&C>0&&(h.offenseRateWeights[l.id]=(h.offenseRateWeights[l.id]||0)+C))}),i.targetDamageDist&&Number.isFinite(g)){const l=i.targetDamageDist.flatMap(d=>d||[]).flatMap(d=>d||[]).reduce((d,C)=>C!=null&&C.id&&C.id===g?d+((C==null?void 0:C.connectedHits)||0):d,0);h.offenseTotals.battleStandardHits=(h.offenseTotals.battleStandardHits||0)+l}h.revives+=((An=(Tn=i.support)==null?void 0:Tn[0])==null?void 0:An.resurrects)||0,he&&(h.damage+=he.damage||0,h.dps+=he.dps||0);const Ae=l=>{var Be,et,We,Ue;let d=`Skill ${l.id}`;const C=((Be=n.skillMap)==null?void 0:Be[`s${l.id}`])||((et=n.skillMap)==null?void 0:et[`${l.id}`]);let z=C==null?void 0:C.icon;if(C!=null&&C.name&&(d=C.name),d.startsWith("Skill ")){const ot=Tt(d,l.id,n.buffMap);ot&&(d=ot,z=((Ue=(We=n.buffMap)==null?void 0:We[`b${l.id}`])==null?void 0:Ue.icon)||z)}return{name:d,icon:z}},q=l=>{if(!(l!=null&&l.id))return;const{name:d,icon:C}=Ae(l);be[l.id]||(be[l.id]={name:d,icon:C,damage:0,hits:0,downContribution:0}),be[l.id].name.startsWith("Skill ")&&!d.startsWith("Skill ")&&(be[l.id].name=d),!be[l.id].icon&&C&&(be[l.id].icon=C),be[l.id].damage+=l.totalDamage,be[l.id].hits+=l.connectedHits,be[l.id].downContribution+=Number(l.downContribution||0)},fe=i.account||i.name||"Unknown",re=i.profession||"Unknown",ne=`${fe}|${re}`;let De=Re.get(ne);De||(De={key:ne,account:fe,displayName:fe,profession:re,professionList:[re],totalFightMs:0,skills:new Map},Re.set(ne,De)),De.professionList.includes(re)||De.professionList.push(re),De.totalFightMs+=n.durationMS||0;const xe=l=>{if(!(l!=null&&l.id))return;const{name:d,icon:C}=Ae(l),z=`s${l.id}`;let Be=De.skills.get(z);Be||(Be={id:z,name:d,icon:C,damage:0,downContribution:0},De.skills.set(z,Be)),Be.name.startsWith("Skill ")&&!d.startsWith("Skill ")&&(Be.name=d),!Be.icon&&C&&(Be.icon=C),Be.damage+=Number(l.totalDamage||0),Be.downContribution+=Number(l.downContribution||0)};ce==="total"?(Mn=i.totalDamageDist)==null||Mn.forEach(l=>{l==null||l.forEach(d=>{q(d),xe(d)})}):(Nn=i.targetDamageDist)==null||Nn.forEach(l=>{l==null||l.forEach(d=>{d==null||d.forEach(C=>{q(C),xe(C)})})}),i.totalDamageTaken&&i.totalDamageTaken.forEach(l=>{l==null||l.forEach(d=>{var et,We,Ue,ot;if(!(d!=null&&d.id))return;let C=`Skill ${d.id}`;const z=((et=n.skillMap)==null?void 0:et[`s${d.id}`])||((We=n.skillMap)==null?void 0:We[`${d.id}`]);let Be=z==null?void 0:z.icon;if(z!=null&&z.name&&(C=z.name),C.startsWith("Skill ")){const dt=Tt(C,d.id,n.buffMap);dt&&(C=dt,Be=((ot=(Ue=n.buffMap)==null?void 0:Ue[`b${d.id}`])==null?void 0:ot.icon)||Be)}ke[d.id]||(ke[d.id]={name:C,icon:Be,damage:0,hits:0}),(!ke[d.id].name.startsWith("Skill ")||C.startsWith("Skill "))&&(ke[d.id].name=C),!ke[d.id].icon&&Be&&(ke[d.id].icon=Be),ke[d.id].damage+=d.totalDamage,ke[d.id].hits+=d.hits})})}),a.forEach(i=>{if(i!=null&&i.isFake)return;const m=lt((i==null?void 0:i.profession)||(i==null?void 0:i.name)||(i==null?void 0:i.id));m&&(Ne[m]=(Ne[m]||0)+1)});const b=no({players:u,targets:a,skillMap:n.skillMap,buffMap:n.buffMap,getPlayerKey:i=>i.account&&i.account!=="Unknown"?i.account:i.name||null}),H=yt(n.buffMap);Object.entries(b.playerConditions).forEach(([i,m])=>{const A=Ce.get(i);A&&Object.entries(m).forEach(([V,U])=>{const h=A.outgoingConditions[V]||{applications:0,damage:0,skills:{},icon:U.icon};h.applications+=Number(U.applications||0),h.damage+=Number(U.damage||0),U.applicationsFromBuffs&&(h.applicationsFromBuffs=(h.applicationsFromBuffs||0)+U.applicationsFromBuffs),U.applicationsFromBuffsActive&&(h.applicationsFromBuffsActive=(h.applicationsFromBuffsActive||0)+U.applicationsFromBuffsActive),Object.entries(U.skills||{}).forEach(([K,w])=>{const x=h.skills[K]||{name:w.name,hits:0,damage:0,icon:w.icon};x.hits+=Number(w.hits||0),x.damage+=Number(w.damage||0),!x.icon&&w.icon&&(x.icon=w.icon),h.skills[K]=x}),!h.icon&&U.icon&&(h.icon=U.icon),A.outgoingConditions[V]=h})}),Object.entries(b.summary).forEach(([i,m])=>{const A=Fe[i]||{name:m.name||i,icon:m.icon,applications:0,damage:0};A.applications+=Number(m.applications||0),A.damage+=Number(m.damage||0),m.applicationsFromBuffs&&(A.applicationsFromBuffs=(A.applicationsFromBuffs||0)+m.applicationsFromBuffs),m.applicationsFromBuffsActive&&(A.applicationsFromBuffsActive=(A.applicationsFromBuffsActive||0)+m.applicationsFromBuffsActive),!A.icon&&m.icon&&(A.icon=m.icon),Fe[i]=A}),de.forEach(i=>{const m=i.account&&i.account!=="Unknown"?i.account:i.name||"Unknown",A=Ce.get(m);!A||!i.totalDamageTaken||i.totalDamageTaken.forEach(V=>V==null?void 0:V.forEach(U=>{var Ae,q,fe,re,ne,De;if(!(U!=null&&U.id))return;let h=`Skill ${U.id}`;const K=((Ae=n.skillMap)==null?void 0:Ae[`s${U.id}`])||((q=n.skillMap)==null?void 0:q[`${U.id}`]);K!=null&&K.name&&(h=K.name);const w=Tt(h,U.id,n.buffMap);if(!w)return;const x=(re=(fe=n.buffMap)==null?void 0:fe[`b${U.id}`])==null?void 0:re.name,me=H.get(w)||((De=(ne=n.buffMap)==null?void 0:ne[`b${U.id}`])==null?void 0:De.icon),y=(K==null?void 0:K.icon)||me;h.startsWith("Skill ")&&(x||w)&&(h=x||w);const N=Number(U.hits??0),P=Number(U.totalDamage??0),L=He[w]||{name:w,icon:me,applications:0,damage:0};L.applications+=Number.isFinite(N)?N:0,L.damage+=Number.isFinite(P)?P:0,!L.icon&&me&&(L.icon=me),He[w]=L;const he=A.incomingConditions[w]||{applications:0,damage:0,skills:{},icon:me};he.applications+=Number.isFinite(N)?N:0,he.damage+=Number.isFinite(P)?P:0;const Z=he.skills[h]||{name:h,hits:0,damage:0,icon:y};Z.hits+=Number.isFinite(N)?N:0,Z.damage+=Number.isFinite(P)?P:0,!Z.icon&&y&&(Z.icon=y),he.skills[h]=Z,!he.icon&&me&&(he.icon=me),A.incomingConditions[w]=he}))});const R=n.player_damage_mitigation||n.playerDamageMitigation,ve=R&&typeof R=="object"&&Object.keys(R).length>0;ve&&Object.entries(R).forEach(([i,m])=>{if(!m||typeof m!="object")return;const A=rn(i),V=cn(vt,A.account,A);Object.values(m).forEach(U=>{G((U==null?void 0:U.avoided_damage)??(U==null?void 0:U.avoidedDamage))<=0||un(V.mitigationTotals,U)})});const $e=n.player_minion_damage_mitigation||n.playerMinionDamageMitigation,Ye=$e&&typeof $e=="object"&&Object.keys($e).length>0;Ye&&Object.entries($e).forEach(([i,m])=>{if(!m||typeof m!="object")return;const A=rn(i);Object.entries(m).forEach(([V,U])=>{if(!U||typeof U!="object")return;const h=`${A.account}::${V}`,K=ln(Et,h,{...A,minion:String(V||"Unknown")});Object.values(U).forEach(w=>{un(K.mitigationTotals,w)})})}),(!ve||!Ye)&&(ve||de.forEach(i=>{const m=(i==null?void 0:i.totalDamageTaken)||[];if(!Array.isArray(m)||m.length===0)return;const A=i.account||i.name||"Unknown",V={account:A,name:i.name||A,profession:lt(i.profession||"Unknown")};cn(vt,A,V);const U=n.skillMap||{},h=n.buffMap||{},K=Array.isArray(m)?m[0]:null;if(K==null||K.forEach(w=>{if(!(w!=null&&w.id))return;const x=G(w.blocked),me=G(w.evaded),y=G(w.glance??w.glanced),N=G(w.missed),P=G(w.invulned),L=G(w.interrupted),he=G(w.hits??w.connectedHits),Z=Number(w.id),Ae=Ft(Z,U,h);if(gn(mn,`${A}::${Z}`,{totalHits:he,blocked:x,evaded:me,glanced:y,missed:N,invulned:P,interrupted:L}),A===Bt){const q=pt.get(Z),fe=it(Z),re=fe.hasSkill?fe.hits>0?fe.avg:0:1,ne=fe.hasSkill?fe.min||0:1,De=fe.hits>0?y*re/2+(x+me+N+P+L)*re:0,xe=fe.hits>0?y*ne/2+(x+me+N+P+L)*ne:0;_t.push({logId:e.filePath||e.id||t,skillId:w.id,skillName:Ae,blocked:x,evaded:me,glanced:y,missed:N,invulned:P,interrupted:L,totalAvoids:x+me+y+N+P+L,avg:re,min:ne,enemyHits:(q==null?void 0:q.connectedHits)??0,enemyTotalDmg:(q==null?void 0:q.totalDamage)??0,avoidDmg:De,avoidMinDmg:xe})}}),A===Bt){const w=(x,me)=>{let y=0,N=0,P=0;if(!Array.isArray(x))return{total:y,minTotal:N,hits:P};for(const L of x){if(!(L!=null&&L.id))continue;const he=G(L.blocked),Z=G(L.evaded),Ae=G(L.glance??L.glanced),q=G(L.missed),fe=G(L.invulned),re=G(L.interrupted),ne=Ft(Number(L.id),f,p),De=me(Number(L.id),ne);(De.hits??0)>0&&(y+=Ae*De.avg/2+(he+Z+q+fe+re)*De.avg,N+=Ae*De.min/2+(he+Z+q+fe+re)*De.min),P+=G(L.hits??L.connectedHits)}return{total:y,minTotal:N,hits:P}};Rt.push({logId:e.filePath||e.id||t,variant:"current_global_name_taken0",...w(K,(x,me)=>{const y=it(x),N=y.hasSkill?y.hits>0?y.avg:0:1,P=y.hasSkill?y.min||0:1;return{avg:N,min:P,hits:y.hits}})})}}),Ye||de.forEach(i=>{const m=(i==null?void 0:i.minions)||[];if(!Array.isArray(m)||m.length===0)return;const A=i.account||i.name||"Unknown",V={account:A,name:i.name||A,profession:lt(i.profession||"Unknown")},U=n.skillMap||{},h=n.buffMap||{};m.forEach(K=>{const w=(K==null?void 0:K.totalDamageTakenDist)||[];if(!Array.isArray(w)||w.length===0)return;let x=String((K==null?void 0:K.name)||"Unknown").replace(/^Juvenile\s+/i,"")||"Unknown";x.toUpperCase().includes("UNKNOWN")&&(x="Unknown");const me=`${A}::${x}`;ln(Et,me,{...V,minion:x});const y=Array.isArray(w)?w[0]:null;if(y==null||y.forEach(N=>{if(!(N!=null&&N.id))return;const P=G(N.blocked),L=G(N.evaded),he=G(N.glance??N.glanced),Z=G(N.missed),Ae=G(N.invulned),q=G(N.interrupted),fe=G(N.hits??N.connectedHits),re=Number(N.id),ne=Ft(re,U,h);if(gn(fn,`${me}::${re}`,{totalHits:fe,blocked:P,evaded:L,glanced:he,missed:Z,invulned:Ae,interrupted:q}),A===Bt&&x===dn){const De=pt.get(re),xe=it(re),Ze=xe.hasSkill?xe.hits>0?xe.avg:0:1,ye=xe.hasSkill?xe.min||0:1,at=xe.hits>0?he*Ze/2+(P+L+Z+Ae+q)*Ze:0,rt=xe.hits>0?he*ye/2+(P+L+Z+Ae+q)*ye:0;Ot.push({logId:e.filePath||e.id||t,skillId:N.id,skillName:ne,blocked:P,evaded:L,glanced:he,missed:Z,invulned:Ae,interrupted:q,totalAvoids:P+L+he+Z+Ae+q,avg:Ze,min:ye,enemyHits:(De==null?void 0:De.connectedHits)??0,enemyTotalDmg:(De==null?void 0:De.totalDamage)??0,avoidDmg:at,avoidMinDmg:rt})}}),A===Bt&&x===dn){const N=(Z,Ae)=>{let q=0,fe=0,re=0;if(!Array.isArray(Z))return{total:q,minTotal:fe,hits:re};for(const ne of Z){if(!(ne!=null&&ne.id))continue;const De=G(ne.blocked),xe=G(ne.evaded),Ze=G(ne.glance??ne.glanced),ye=G(ne.missed),at=G(ne.invulned),rt=G(ne.interrupted),Pt=Ft(Number(ne.id),f,p),{avg:bt,min:ht}=Ae(Number(ne.id),Pt);G(ne.hits??ne.connectedHits)>0&&(q+=Ze*bt/2+(De+xe+ye+at+rt)*bt,fe+=Ze*ht/2+(De+xe+ye+at+rt)*ht),re+=G(ne.hits??ne.connectedHits)}return{total:q,minTotal:fe,hits:re}},P=Array.isArray(w)?w[0]||[]:[],L=Array.isArray(w)?w.flat():[],he=Array.isArray(K==null?void 0:K.totalDamageTaken)?K.totalDamageTaken[0]||[]:[];st.push({logId:e.filePath||e.id||t,variant:"current_global_name_dist0",...N(P,(Z,Ae)=>{const q=it(Z),fe=q.hasSkill?q.hits>0?q.avg:0:1,re=q.hasSkill&&q.min||0;return{avg:fe,min:re}})}),st.push({logId:e.filePath||e.id||t,variant:"local_name_dist0",...N(P,(Z,Ae)=>le(Ae))}),st.push({logId:e.filePath||e.id||t,variant:"local_id_dist0",...N(P,Z=>j(Z))}),st.push({logId:e.filePath||e.id||t,variant:"global_name_alllists",...N(L,(Z,Ae)=>{const q=it(Z),fe=q.hasSkill?q.hits>0?q.avg:0:1,re=q.hasSkill&&q.min||0;return{avg:fe,min:re}})}),st.push({logId:e.filePath||e.id||t,variant:"global_name_taken0",...N(he,(Z,Ae)=>{const q=it(Z),fe=q.hasSkill?q.hits>0?q.avg:0:1,re=q.hasSkill&&q.min||0;return{avg:fe,min:re}})})}})}))}),Ot.length>0&&(console.groupCollapsed("[Mitigation Debug] Ashtonlightstone.9145 / Illusionary Warden"),console.table(Ot),st.length>0&&console.table(st),console.groupEnd()),_t.length>0&&(console.groupCollapsed("[Mitigation Debug] Ashtonlightstone.9145 / Player"),console.table(_t),Rt.length>0&&console.table(Rt),console.groupEnd());const pn=(e,t)=>{const n=new Map,u=a=>{let f=n.get(a);return f||(f=gt(),n.set(a,f)),f};t.forEach((a,f)=>{const p=f.lastIndexOf("::"),$=p>-1?f.slice(0,p):f,S=p>-1?Number(f.slice(p+2)):Number.NaN,j=Number.isFinite(S)?it(S):{hasSkill:!1,avg:0,min:0,hits:0};if(!j.hasSkill||j.hits<=0)return;const le=j.avg,X=j.min,D=a.glanced*le/2+(a.blocked+a.evaded+a.missed+a.invulned+a.interrupted)*le,E=a.glanced*X/2+(a.blocked+a.evaded+a.missed+a.invulned+a.interrupted)*X;if(D<=0)return;const F=u($);F.totalHits+=a.totalHits,F.blocked+=a.blocked,F.evaded+=a.evaded,F.glanced+=a.glanced,F.missed+=a.missed,F.invulned+=a.invulned,F.interrupted+=a.interrupted,F.totalMitigation+=D,F.minMitigation+=E}),e.forEach((a,f)=>{const p=n.get(f)||gt();a.mitigationTotals.totalHits=p.totalHits,a.mitigationTotals.blocked=p.blocked,a.mitigationTotals.evaded=p.evaded,a.mitigationTotals.glanced=p.glanced,a.mitigationTotals.missed=p.missed,a.mitigationTotals.invulned=p.invulned,a.mitigationTotals.interrupted=p.interrupted,a.mitigationTotals.totalMitigation=p.totalMitigation,a.mitigationTotals.minMitigation=p.minMitigation})};pn(vt,mn),pn(Et,fn);const ho=I>0?Math.round(J/I):0,Co=I>0?Math.round(Y/I):0,ko=Q>0?(pe/Q).toFixed(2):pe>0?"∞":"0.00",Do=Oe>0?(te/Oe).toFixed(2):te>0?"∞":"0.00",bn=(e,t)=>{const u=e.filter(p=>Number.isFinite(p.value)&&(t?p.value>0:p.value>=0)).sort((p,$)=>{const S=t?$.value-p.value:p.value-$.value;return S!==0?S:p.account.localeCompare($.account)});let a=null,f=0;return u.map((p,$)=>((a===null||p.value!==a)&&(f=$+1,a=p.value),{rank:f,...p}))},xt=Array.from(Ce.values()).map(e=>{const t=Array.from(e.professions).filter(n=>n!=="Unknown");if(e.professionList=t,t.length>0){let n=t[0],u=e.professionTimeMs[n]||0;t.forEach(a=>{const f=e.professionTimeMs[a]||0;f>u&&(u=f,n=a)}),e.profession=n}return{key:e.account,stat:e}}),hn=e=>{const t=Ce.get(e.account);if(!t){const a=e.professionList.length>0?e.professionList:e.profession?[e.profession]:[];return{...e,professionList:a}}const n=t.professionList&&t.professionList.length>0?t.professionList:Array.from(t.professions||[]).filter(a=>a&&a!=="Unknown"),u=t.profession||e.profession;return{...e,profession:u,professionList:n.length>0?n:u?[u]:[],activeMs:t.defenseActiveMs||t.totalFightMs||e.activeMs}},So=Array.from(vt.values()).map(hn).filter(e=>bo(e.mitigationTotals)).sort((e,t)=>e.account.localeCompare(t.account)),To=Array.from(Et.values()).map(hn).filter(e=>e.mitigationTotals.totalMitigation>0).sort((e,t)=>{const n=e.account.localeCompare(t.account);return n!==0?n:String(e.minion||"").localeCompare(String(t.minion||""))}),It=(e,t)=>{switch(t){case"downContrib":return e.downContrib;case"barrier":return e.barrier;case"healing":return e.healing;case"dodges":return e.dodges;case"strips":return e.strips;case"cleanses":return e.cleanses;case"cc":return e.cc;case"stability":return e.stab;case"revives":return e.revives;case"dps":return e.dps;case"damage":return e.damage;case"participation":return e.logsJoined;case"closestToTag":return!e.isCommander&&e.distCount>0?e.totalDist/e.distCount:Number.POSITIVE_INFINITY;default:return 0}},je=(e,t)=>bn(xt.map(({stat:n})=>({account:n.account,profession:n.profession,professionList:n.professionList,value:It(n,e),count:n.logsJoined})),t),Ie={downContrib:je("downContrib",!0),barrier:je("barrier",!0),healing:je("healing",!0),dodges:je("dodges",!0),strips:je("strips",!0),cleanses:je("cleanses",!0),cc:je("cc",!0),stability:je("stability",!0),revives:je("revives",!0),participation:je("participation",!0),dps:je("dps",!0),damage:je("damage",!0),closestToTag:je("closestToTag",!1).filter(e=>Number.isFinite(e.value))},Ao={downContrib:"downContrib",barrier:"barrier",healing:"healing",dodges:"dodges",strips:"strips",cleanses:"cleanses",cc:"cc",stability:"stability",closestToTag:"closestToTag"},Me=e=>{const t=e==null?void 0:e[0];return{value:(t==null?void 0:t.value)??0,player:(t==null?void 0:t.account)??"-",count:(t==null?void 0:t.count)??0,profession:(t==null?void 0:t.profession)??"Unknown",professionList:(t==null?void 0:t.professionList)??[]}},Je={maxDownContrib:Me([]),maxBarrier:Me([]),maxHealing:Me([]),maxDodges:Me([]),maxStrips:Me([]),maxCleanses:Me([]),maxCC:Me([]),maxStab:Me([]),closestToTag:Me([])},Ke={},Mo=(e,t)=>{if(t==="closestToTag")return It(e,t);const n=Math.max(1,(e.totalFightMs||0)/1e3);return It(e,t)/n};Object.values(Ao).forEach(e=>{const t=e!=="closestToTag";Ke[e]=bn(xt.map(({stat:n})=>({account:n.account,profession:n.profession,professionList:n.professionList,value:Mo(n,e),count:n.logsJoined})),t)}),Je.maxDownContrib=Me(Ke.downContrib),Je.maxBarrier=Me(Ke.barrier),Je.maxHealing=Me(Ke.healing),Je.maxDodges=Me(Ke.dodges),Je.maxStrips=Me(Ke.strips),Je.maxCleanses=Me(Ke.cleanses),Je.maxCC=Me(Ke.cc),Je.maxStab=Me(Ke.stability),Je.closestToTag=Me(Ke.closestToTag);const No={maxDownContrib:Me(Ie.downContrib),maxBarrier:Me(Ie.barrier),maxHealing:Me(Ie.healing),maxDodges:Me(Ie.dodges),maxStrips:Me(Ie.strips),maxCleanses:Me(Ie.cleanses),maxCC:Me(Ie.cc),maxStab:Me(Ie.stability),closestToTag:Me(Ie.closestToTag)};let qt={player:"None",account:"None",score:-1,profession:"Unknown",professionList:[],color:"#64748b",topStats:[]},Cn,kn,Dn=0;if(oe!=null&&oe.showMvp){const e={"Down Contribution":"downContribution",Healing:"healing",Cleanses:"cleanses",Strips:"strips",Stability:"stability",CC:"cc",Revives:"revives","Distance to Tag":"distanceToTag",Participation:"participation",Dodging:"dodging",DPS:"dps",Damage:"damage"},t=f=>{const p=e[f];return p?Number(_[p]||0)>0:!1},n=[],u=f=>[...f||[]].filter(p=>t(p==null?void 0:p.name)).sort((p,$)=>$.ratio-p.ratio||p.rank-$.rank||p.name.localeCompare($.name)).slice(0,3),a=f=>{var $;if(!f)return;const p=u(f.contribs);return{...f,player:f.name,reason:(($=p[0])==null?void 0:$.name)||"Top Performance",topStats:p}};xt.forEach(({stat:f})=>{let p=0;const $=[],S=(j,le,X,D,E=!0)=>{var O,ue;if(X<=0)return;const F=((O=le[0])==null?void 0:O.value)||0;if(F&&Number.isFinite(j)&&(E?j>0:j<Number.POSITIVE_INFINITY)){const ee=E?j/F:F/j;p+=ee*X;const Se=((ue=le.find(Te=>Te.account===f.account))==null?void 0:ue.rank)||0;$.push({name:D,ratio:ee,val:j.toLocaleString(),rank:Se})}};S(f.downContrib,Ie.downContrib,_.downContribution,"Down Contribution"),S(f.healing,Ie.healing,_.healing,"Healing"),S(f.cleanses,Ie.cleanses,_.cleanses,"Cleanses"),S(f.strips,Ie.strips,_.strips,"Strips"),S(f.stab,Ie.stability,_.stability,"Stability"),S(f.cc,Ie.cc,_.cc,"CC"),S(f.revives,Ie.revives,_.revives,"Revives"),S(It(f,"closestToTag"),Ie.closestToTag,_.distanceToTag,"Distance to Tag",!1),S(f.logsJoined,Ie.participation,_.participation,"Participation"),S(f.dodges,Ie.dodges,_.dodging,"Dodging"),S(f.dps,Ie.dps,_.dps,"DPS"),S(f.damage,Ie.damage,_.damage,"Damage"),n.push({...f,score:p,contribs:$.filter(j=>t(j.name))})}),n.sort((f,p)=>p.score-f.score),n[0]&&n[0].score>0&&(qt=a(n[0])||qt),Cn=a(n[1]),kn=a(n[2]),Dn=n.length>0?n.reduce((f,p)=>f+p.score,0)/n.length:0}const wo=Object.values(be).sort((e,t)=>{const n=M==="downContribution"?e.downContribution:e.damage;return(M==="downContribution"?t.downContribution:t.damage)-n}).slice(0,25),vo=Object.values(ke).sort((e,t)=>t.damage-e.damage).slice(0,25),Eo=e=>{const t=String(e).replace(/^Detailed\s*WvW\s*-\s*/i,"").replace(/^World\s*vs\s*World\s*-\s*/i,"").replace(/^WvW\s*-\s*/i,"").trim(),n=t.match(/^(Red|Blue|Green)\s+(?:Alpine|Desert)?\s*Borderlands$/i);return n?`${n[1]} Borderlands`:t||"Unknown"},jt=(e,t)=>Eo((e==null?void 0:e.zone)||(e==null?void 0:e.mapName)||(e==null?void 0:e.map)||(e==null?void 0:e.location)||(e==null?void 0:e.fightName)||(t==null?void 0:t.fightName)||(t==null?void 0:t.encounterName)||"Unknown"),Fo=(e,t)=>{const n=(t==null?void 0:t.permalink)||(e==null?void 0:e.permalink);if(typeof n=="string"&&n.trim().length>0)return n.trim();const u=e==null?void 0:e.uploadLinks;if(!Array.isArray(u))return"";for(const a of u){if(typeof a=="string"&&a.trim().length>0)return a.trim();if(a&&typeof a=="object"){const f=a.permalink||a.link||a.url||a.reportLink;if(typeof f=="string"&&f.trim().length>0)return f.trim()}}return""},Wt={};B.forEach(e=>{const t=jt(e==null?void 0:e.details,e);Wt[t]=(Wt[t]||0)+1});const Bo=Object.entries(Wt).map(([e,t])=>{const n=String(e).trim(),u=/eternal battlegrounds|^ebg$/i.test(n);let a="#64748b";return u?a="#ffffff":/red/i.test(n)?a="#ef4444":/blue/i.test(n)?a="#3b82f6":/green/i.test(n)&&(a="#22c55e"),{name:e,value:t,color:a}}).sort((e,t)=>t.value-e.value),{boonTables:Io}=In(B),Po=B.map((e,t)=>{var u,a;const n=((u=e.details)==null?void 0:u.players)||[];return{index:t+1,label:`Log ${t+1}`,timestamp:nt(e.details,e),squadCount:n.filter(f=>!f.notInSquad).length,friendlyCount:n.length,enemies:((a=e.details)==null?void 0:a.targets).filter(f=>!f.isFake).length}}).sort((e,t)=>e.timestamp-t.timestamp),Vt={};Array.from(Ce.values()).forEach(e=>{e.profession&&e.profession!=="Unknown"&&(Vt[e.profession]=(Vt[e.profession]||0)+1)});const Uo=Object.entries(Vt).map(([e,t])=>({name:e,value:t,color:en(e)})).sort((e,t)=>t.value-e.value),zt={};Object.keys(Ne).length===0&&B.forEach(e=>{var t,n;(n=(t=e.details)==null?void 0:t.targets)==null||n.forEach(u=>{if(u.isFake)return;const a=u.profession&&u.profession!=="Unknown"?u.profession:u.name||u.id||"Unknown",f=lt(a);zt[f]=(zt[f]||0)+1})});const Ho=Object.keys(Ne).length>0?Ne:zt,Lo=Object.entries(Ho).map(([e,t])=>({name:e,value:t,color:en(e)})).sort((e,t)=>t.value-e.value),$o=B.map((e,t)=>({log:e,originalIndex:t})).sort((e,t)=>nt(e.log.details,e.log)-nt(t.log.details,t.log)).map(({log:e},t)=>{const n=e.details;if(!n)return null;const u=n.players||[],a=u.filter(r=>!r.notInSquad),f=u.filter(r=>r.notInSquad),p=n.targets||[],$=p.filter(r=>!r.isFake),S=a.reduce((r,W)=>{var g,b;return r+(((b=(g=W.dpsAll)==null?void 0:g[0])==null?void 0:b.damage)||0)},0),j=a.reduce((r,W)=>{var g,b;return r+(((b=(g=W.defenses)==null?void 0:g[0])==null?void 0:b.damageTaken)||0)},0),{enemyDeaths:le,enemyDownsDeaths:X}=Pe(n),D=Ee(n),E=nt(n,e),F=jt(n,e),O={red:0,green:0,blue:0},ue=r=>{const W=Number(r);return Number.isFinite(W)?W:0},ee=r=>{if(!r||typeof r!="object")return;const W=r.teamID??r.teamId??r.team??r.teamColor??r.team_color;if(W!=null)return W;const g=Object.keys(r).find(b=>/^team/i.test(b));return g?r[g]:void 0},Se=(r,W)=>{if(r==null)return null;if(typeof r=="string"){const g=r.toLowerCase();return g.includes("red")?"red":g.includes("green")?"green":g.includes("blue")?"blue":g==="r"?"red":g==="g"?"green":g==="b"?"blue":null}if(typeof r=="number")if(W==="zeroBased"){if(r===0)return"red";if(r===1)return"green";if(r===2)return"blue"}else{if(r===1)return"red";if(r===2)return"green";if(r===3)return"blue"}return null},Te=(r,W)=>{const g={};return r.forEach(b=>{const H=W(b),R=lt(H);R&&(g[R]=(g[R]||0)+1)}),g},ae=Te(a,r=>(r==null?void 0:r.profession)||(r==null?void 0:r.name)),de=Te(f,r=>(r==null?void 0:r.profession)||(r==null?void 0:r.name)),we=Te($,r=>(r==null?void 0:r.profession)||(r==null?void 0:r.name)||(r==null?void 0:r.id));if(n.teamCounts&&typeof n.teamCounts=="object"){const r=n.teamCounts;O.red=ue(r.red??r.r??r[0]??r[1]),O.green=ue(r.green??r.g??r[1]??r[2]),O.blue=ue(r.blue??r.b??r[2]??r[3])}else{const r=[];p.forEach(H=>{if(H!=null&&H.isFake)return;const R=ee(H);R!=null&&r.push(R)}),u.forEach(H=>{if(!(H!=null&&H.notInSquad))return;const R=ee(H);R!=null&&r.push(R)}),r.length===0&&u.forEach(H=>{const R=ee(H);R!=null&&r.push(R)});const W=new Set;r.forEach(H=>{typeof H=="number"&&W.add(H)});const g=W.has(0)?"zeroBased":W.has(3)?"oneBased":"zeroBased";if(r.forEach(H=>{const R=Se(H,g);R&&(O[R]+=1)}),O.red+O.green+O.blue===0&&r.length>0){const H=new Map;r.forEach(ve=>{const $e=String(ve);H.set($e,(H.get($e)||0)+1)});const R=Array.from(H.values()).sort((ve,$e)=>$e-ve);O.red=R[0]||0,O.green=R[1]||0,O.blue=R[2]||0}O.red+O.green+O.blue===0&&(O.red=Math.max($.length,u.filter(H=>H==null?void 0:H.notInSquad).length))}return{id:e.filePath||`fight-${t}`,label:e.encounterName||`Fight ${t+1}`,permalink:Fo(n,e),timestamp:E,mapName:F,duration:uo(n.durationMS),isWin:D,squadCount:a.length,allyCount:f.length,enemyCount:$.length,teamCounts:O,alliesDown:a.reduce((r,W)=>{var g,b;return r+(((b=(g=W.defenses)==null?void 0:g[0])==null?void 0:b.downCount)||0)},0),alliesDead:a.reduce((r,W)=>{var g,b;return r+(((b=(g=W.defenses)==null?void 0:g[0])==null?void 0:b.deadCount)||0)},0),alliesRevived:a.reduce((r,W)=>{var g,b;return Number(((b=(g=W.statsAll)==null?void 0:g[0])==null?void 0:b.saved)||0)>0?r+1:r},0),rallies:0,enemyDeaths:le,enemyDowns:Math.max(0,X-le),totalOutgoingDamage:S,totalIncomingDamage:j,incomingBarrierAbsorbed:a.reduce((r,W)=>{var g,b;return r+(((b=(g=W.defenses)==null?void 0:g[0])==null?void 0:b.damageBarrier)||0)},0),outgoingBarrierAbsorbed:a.reduce((r,W)=>{var H;const g=(H=W.extBarrierStats)==null?void 0:H.outgoingBarrier;if(!Array.isArray(g))return r;let b=0;return g.forEach(R=>{if(Array.isArray(R)){R.forEach(ve=>{b+=Number((ve==null?void 0:ve.barrier)||0)});return}b+=Number((R==null?void 0:R.barrier)||0)}),r+b},0),squadClassCountsFight:ae,allyClassCountsFight:de,enemyClassCounts:we}}).filter(Boolean),Oo=(e,t)=>{const n=(t==null?void 0:t.skillMap)||{},u=(t==null?void 0:t.buffMap)||{};let a=0,f="";const p=S=>{const j=Number(S);if(!Number.isFinite(j))return String(S||"Unknown Skill");const le=(n==null?void 0:n[`s${j}`])||(n==null?void 0:n[`${j}`]);if(le!=null&&le.name)return String(le.name);const X=(u==null?void 0:u[`b${j}`])||(u==null?void 0:u[`${j}`]);return X!=null&&X.name?String(X.name):`Skill ${j}`},$=S=>{if(!S||typeof S!="object")return;const j=[Number(S.max),Number(S.maxDamage),Number(S.maxHit),Number(S.totalDamage)>0&&Number(S.connectedHits)>0?Number(S.totalDamage)/Number(S.connectedHits):0].filter(X=>Number.isFinite(X)),le=j.length>0?Math.max(...j):0;le>a&&(a=le,f=p(S.id))};return Array.isArray(e==null?void 0:e.totalDamageDist)&&e.totalDamageDist.forEach(S=>{Array.isArray(S)&&S.forEach(j=>$(j))}),Array.isArray(e==null?void 0:e.targetDamageDist)&&e.targetDamageDist.forEach(S=>{Array.isArray(S)&&S.forEach(j=>{Array.isArray(j)&&j.forEach(le=>$(le))})}),{peak:a,skillName:f||"Unknown Skill"}},_o=(()=>{const e=D=>String(D||"").replace(/^Detailed\s*WvW\s*-\s*/i,"").replace(/^World\s*vs\s*World\s*-\s*/i,"").replace(/^WvW\s*-\s*/i,"").trim(),t=D=>e(D).toLowerCase().split(/[^a-z0-9]+/i).map(E=>E.trim()).filter(Boolean).map(E=>E.length>3&&E.endsWith("s")?E.slice(0,-1):E),n=(D,E)=>{const F=e(D),O=e(E);if(!O)return F;if(!F)return O;const ue=t(F),ee=t(O),Se=new Set(ue),Te=new Set(ee),ae=ee.length>0&&ee.every(we=>Se.has(we)),de=ue.length>0&&ue.every(we=>Te.has(we));return ae||de?F:`${F} - ${O}`},u=[],a=new Map,f=D=>{const E=ae=>{if(!Array.isArray(ae)||ae.length===0)return[];const de=[];for(let we=0;we<ae.length;we+=1){const r=Number(ae[we]||0),W=we>0?Number(ae[we-1]||0):0;de.push(Math.max(0,r-W))}return de},F=ae=>{if(!Array.isArray(ae))return[];const de=ae.reduce((r,W)=>Math.max(r,Array.isArray(W)?W.length:0),0);if(de<=0)return[];const we=new Array(de).fill(0);return ae.forEach(r=>{if(Array.isArray(r))for(let W=0;W<de;W+=1)we[W]+=Number(r[W]||0)}),we},O=ae=>Array.isArray(ae)?ae.map(de=>Number(de||0)):null,ee=(ae=>{if(!Array.isArray(ae)||ae.length===0)return null;const de=ae[0];if(!Array.isArray(de))return null;if(Array.isArray(de[0])&&Array.isArray(de[0][0]))return F(de);if(Array.isArray(de[0])&&!Array.isArray(de[0][0])){const we=ae.map(r=>O(Array.isArray(r)?r[0]:null)).filter(r=>Array.isArray(r)&&r.length>0);if(we.length>0)return F(we)}return null})(D==null?void 0:D.targetDamage1S),Se=Array.isArray(D==null?void 0:D.damage1S)&&Array.isArray(D.damage1S[0])?D.damage1S[0]:null,Te=ee||(Array.isArray(Se)?Se.map(ae=>Number(ae||0)):[]);return E(Te)},p=(D,E)=>{if(!Array.isArray(D)||D.length===0||E<=0)return 0;let F=0,O=0;for(let ue=0;ue<D.length;ue+=1)F+=Number(D[ue]||0),ue>=E&&(F-=Number(D[ue-E]||0)),ue>=E-1&&F>O&&(O=F);return Math.max(0,O)},$=(D,E)=>{if(!Array.isArray(D)||D.length===0||E<=0)return[];const F=[];for(let O=0;O<D.length;O+=E){const ue=Math.min(O+E,D.length),ee=D.slice(O,ue).reduce((Se,Te)=>Se+Number(Te||0),0);F.push(ee)}return F},S=D=>Array.isArray(D)?D.map(E=>Array.isArray(E)?[Number(E[0]),Number(E[1])]:E&&typeof E=="object"?[Number(E.time),Number(E.value)]:null).filter(E=>!!E&&Number.isFinite(E[0])&&E[0]>=0):[],j=(D,E,F,O,ue)=>{if(!D.length||O<=0)return[];const ee=Math.max(O*5e3,ue||0),Se=b=>b.reduce((H,R)=>R>=0&&R<=ee+2e3?H+1:H,0),Te=D.map(b=>Number(b||0)).filter(b=>Number.isFinite(b)&&b>=0);if(!Te.length)return[];const ae=[Te],de=Te.reduce((b,H)=>Math.max(b,H),0),we=Te.reduce((b,H)=>Math.min(b,H),Number.POSITIVE_INFINITY);de>ee*20&&ae.push(Te.map(b=>b/1e3)),de<=ee*2&&we>=0&&de>0&&de<Math.max(120,O*5+10)&&ae.push(Te.map(b=>b*1e3));let r=Te,W=0,g=-1;return ae.forEach(b=>{const H=b.reduce((ve,$e)=>Math.min(ve,$e),Number.POSITIVE_INFINITY),R=new Set([0,...E,...F]);if(Number.isFinite(H)&&ee>0&&H>ee){const ve=Math.floor(H/ee)*ee;R.add(ve),R.add(Math.max(0,ve-ee))}R.forEach(ve=>{const $e=b.map(Qe=>Qe-ve),Ye=Se($e);Ye>g&&(g=Ye,W=ve,r=b)})}),r.map(b=>b-W).filter(b=>Number.isFinite(b)&&b>=0)},le=(D,E,F,O,ue)=>{const ee=j(D,E,F,O,ue);return Array.from(new Set(ee.map(Se=>Math.floor(Se/5e3)).filter(Se=>Number.isFinite(Se)&&Se>=0&&Se<O)))};B.map(D=>({log:D,ts:nt(D==null?void 0:D.details,D)})).sort((D,E)=>D.ts-E.ts).forEach(({log:D},E)=>{const F=D==null?void 0:D.details;if(!F)return;const O=e(F.fightName||D.fightName||`Fight ${E+1}`),ue=jt(F,D),ee=n(O,String(ue||"")),Se={},Te=Array.isArray(F.players)?F.players:[],ae=Te.flatMap(g=>{const b=g==null?void 0:g.combatReplayData;return Array.isArray(b)?b.map(H=>Number(H==null?void 0:H.start)):[Number(b==null?void 0:b.start)]}).filter(g=>Number.isFinite(g)&&g>=0);Te.forEach(g=>{if(g!=null&&g.notInSquad)return;const b=String((g==null?void 0:g.account)||(g==null?void 0:g.name)||"Unknown"),H=String((g==null?void 0:g.character_name)||(g==null?void 0:g.display_name)||(g==null?void 0:g.name)||""),R=String((g==null?void 0:g.profession)||"Unknown"),ve=`${b}|${R}`,$e=Oo(g,F),Ye=Number($e.peak||0),Qe=f(g),ut=Number(p(Qe,1)||0),i=Number(p(Qe,5)||0),m=Number(p(Qe,30)||0),A=Math.max(0,Math.ceil(Number((F==null?void 0:F.durationMS)||0)/5e3)),V=Math.max(0,Math.ceil(Qe.length/5)),U=Math.max(A,V),h=$(Qe,5),K=Array.from({length:U},(P,L)=>Number(h[L]||0)),w=(()=>{const P=g==null?void 0:g.combatReplayData;return Array.isArray(P)?P.filter(L=>L&&typeof L=="object"):P&&typeof P=="object"?[P]:[]})(),x=w.map(P=>Number(P==null?void 0:P.start)).filter(P=>Number.isFinite(P)&&P>=0),me=w.flatMap(P=>S(P==null?void 0:P.down).map(([L])=>Number(L||0))),y=w.flatMap(P=>S(P==null?void 0:P.dead).map(([L])=>Number(L||0)));Se[ve]={hit:Ye,burst1s:ut,burst5s:i,burst30s:m,skillName:$e.skillName,buckets5s:K,downIndices5s:le(me,x,ae,U,Number((F==null?void 0:F.durationMS)||0)),deathIndices5s:le(y,x,ae,U,Number((F==null?void 0:F.durationMS)||0))};const N=a.get(ve)||{key:ve,account:b,displayName:b,characterName:H,profession:R,professionList:[R],logs:0,peakHit:0,peak1s:0,peak5s:0,peak30s:0,peakFightLabel:"",peakSkillName:""};N.logs+=1,N.professionList.includes(R)||N.professionList.push(R),!N.characterName&&H&&(N.characterName=H),Ye>N.peakHit&&(N.peakHit=Ye,N.peakFightLabel=ee,N.peakSkillName=$e.skillName),ut>N.peak1s&&(N.peak1s=ut),i>N.peak5s&&(N.peak5s=i),m>N.peak30s&&(N.peak30s=m),a.set(ve,N)});const de=Object.values(Se).reduce((g,b)=>Math.max(g,Number((b==null?void 0:b.hit)||0)),0),we=Object.values(Se).reduce((g,b)=>Math.max(g,Number((b==null?void 0:b.burst1s)||0)),0),r=Object.values(Se).reduce((g,b)=>Math.max(g,Number((b==null?void 0:b.burst5s)||0)),0),W=Object.values(Se).reduce((g,b)=>Math.max(g,Number((b==null?void 0:b.burst30s)||0)),0);u.push({id:D.filePath||D.id||`fight-${E+1}`,shortLabel:`F${E+1}`,fullLabel:ee,timestamp:nt(F,D),values:Se,maxHit:de,max1s:we,max5s:r,max30s:W})});const X=Array.from(a.values()).sort((D,E)=>E.peakHit!==D.peakHit?E.peakHit-D.peakHit:D.displayName.localeCompare(E.displayName));return{fights:u,players:X}})(),Ro=Array.from(Ge.entries()).map(([e,t])=>{const n=Xe.get(e)||{},u=Array.from(t.values()).map(a=>{var le;const f=Array.from(a.professions||[]).filter(X=>X&&X!=="Unknown");let p=a.profession||"Unknown";if(f.length>0){p=f[0];let X=((le=a.professionTimeMs)==null?void 0:le[p])||0;f.forEach(D=>{var F;const E=((F=a.professionTimeMs)==null?void 0:F[D])||0;E>X&&(X=E,p=D)})}const $=a.durationMs||0,S=a.totalMs/1e3,j=$>0?a.totalMs/$:0;return{account:a.account,profession:p,professionList:f,total:S,perSecond:j,duration:$/1e3}}).filter(a=>a.total>0||a.perSecond>0);return{id:e,name:n.name||e,icon:n.icon,rows:u}}).filter(e=>e.rows.length>0),xo=Array.from(Re.values()).map(e=>{const t=Array.from(e.skills.values()).sort((u,a)=>a.damage-u.damage),n=t.reduce((u,a)=>(u[a.id]=a,u),{});return{key:e.key,account:e.account,displayName:e.displayName,profession:e.profession,professionList:e.professionList,totalFightMs:e.totalFightMs,skills:t,skillMap:n}}).sort((e,t)=>e.displayName.localeCompare(t.displayName));return{total:I,wins:se,losses:T,avgSquadSize:ho,avgEnemies:Co,squadKDR:ko,enemyKDR:Do,totalSquadKills:pe,totalSquadDeaths:Q,totalEnemyKills:te,totalEnemyDeaths:Oe,leaderboards:Ie,...No,outgoingConditionSummary:Object.values(Fe).sort((e,t)=>t.damage-e.damage),incomingConditionSummary:Object.values(He).sort((e,t)=>t.damage-e.damage),outgoingConditionPlayers:Array.from(Ce.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,conditions:e.outgoingConditions})),incomingConditionPlayers:Array.from(Ce.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,conditions:e.incomingConditions})),topSkills:wo,topIncomingSkills:vo,playerSkillBreakdowns:xo,topSkillsMetric:M,mapData:Bo,timelineData:Po,boonTables:Io,offensePlayers:Array.from(Ce.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,offenseTotals:e.offenseTotals,offenseRateWeights:e.offenseRateWeights,totalFightMs:e.totalFightMs})),defensePlayers:Array.from(Ce.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,defenseTotals:e.defenseTotals,activeMs:e.defenseActiveMs})),damageMitigationPlayers:So,damageMitigationMinions:To,supportPlayers:Array.from(Ce.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,supportTotals:e.supportTotals,activeMs:e.supportActiveMs})),healingPlayers:Array.from(Ce.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,healingTotals:e.healingTotals,activeMs:e.healingActiveMs})),mvp:qt,silver:Cn,bronze:kn,squadClassData:Uo,enemyClassData:Lo,fightBreakdown:$o,spikeDamage:_o,specialTables:Ro,topStatsPerSecond:Je,topStatsLeaderboardsPerSecond:Ke,avgMvpScore:Dn}})(),qe=(()=>{const ge=new Map,ce=new Map,M=[],I=new Map,se=new Map;B.forEach(J=>{const Y=J.details;if(!Y)return;const Q=Y.skillMap||{},pe=Y.fightName||"Log",Oe=nt(Y,J)||Date.now(),te={id:J.filePath||J.id||pe,label:pe,timestamp:Oe,skillEntries:{},playerActiveSeconds:{},durationSeconds:Y.durationMS?Y.durationMS/1e3:0};(Y.players||[]).forEach(Ee=>{if(Ee.notInSquad)return;const Ce=Ee.account||Ee.name||"Unknown",_e=Ee.profession||"Unknown",be=`${Ce}|${_e}`;let ke=ce.get(be);ke||(ke={key:be,account:Ce,displayName:Ce,profession:_e,professionList:[_e],logs:0,totalActiveSeconds:0,skillTotals:{}},ce.set(be,ke)),ke.logs++;const Re=(Array.isArray(Ee.activeTimes)?Ee.activeTimes[0]:0)/1e3;ke.totalActiveSeconds=(ke.totalActiveSeconds||0)+Re,te.playerActiveSeconds[be]=Re,(Ee.rotation||[]).forEach(Fe=>{var Mt,Nt,wt;if(!(Fe!=null&&Fe.id))return;const He=((Mt=Fe.skills)==null?void 0:Mt.length)||0;if(He<=0)return;const Ne=`s${Fe.id}`,Xe=((Nt=Q[Ne])==null?void 0:Nt.name)||`Skill ${Fe.id}`,Ge=(wt=Q[Ne])==null?void 0:wt.icon;ke.skillTotals[Ne]=(ke.skillTotals[Ne]||0)+He,ge.set(Ne,(ge.get(Ne)||0)+He),I.set(Ne,Xe),Ge&&!se.has(Ne)&&se.set(Ne,Ge),te.skillEntries[Ne]||(te.skillEntries[Ne]={name:Xe,icon:Ge,players:{}}),!te.skillEntries[Ne].icon&&Ge&&(te.skillEntries[Ne].icon=Ge),te.skillEntries[Ne].players[be]=(te.skillEntries[Ne].players[be]||0)+He})}),M.push(te)});const T=Array.from(ge.entries()).map(([J,Y])=>({id:J,name:I.get(J)||J,total:Y,icon:se.get(J)})).sort((J,Y)=>Y.total-J.total);return{logRecords:M,players:Array.from(ce.values()),skillOptions:T,resUtilitySkills:[]}})();return{validLogs:B,stats:Le,skillUsageData:qe}};let ze=null,ct=!1,tn=null,nn=0,on=0,Lt=null;const sn=o=>{if(!o||typeof o!="object")return o;const s=(k,v)=>{const B={};return v.forEach(oe=>{k&&Object.prototype.hasOwnProperty.call(k,oe)&&(B[oe]=k[oe])}),B},c=s(o,["players","targets","durationMS","uploadTime","timeStart","timeStartStd","timeEnd","timeEndStd","fightName","success","teamCounts","combatReplayMetaData","skillMap","buffMap","encounterDuration","player_damage_mitigation","player_minion_damage_mitigation","playerDamageMitigation","playerMinionDamageMitigation"]);return Array.isArray(c.players)&&(c.players=c.players.map(k=>s(k,["name","display_name","character_name","profession","elite_spec","group","dpsAll","statsAll","dpsTargets","statsTargets","defenses","support","rotation","extHealingStats","extBarrierStats","squadBuffVolumes","selfBuffs","groupBuffs","squadBuffs","selfBuffsActive","groupBuffsActive","squadBuffsActive","buffUptimes","totalDamageDist","targetDamageDist","damage1S","targetDamage1S","totalDamageTaken","totalDamageTakenDist","minions","combatReplayData","hasCommanderTag","notInSquad","account","activeTimes"]))),Array.isArray(c.targets)&&(c.targets=c.targets.map(k=>s(k,["id","name","isFake","dpsAll","statsAll","defenses","totalHealth","healthPercentBurned","enemyPlayer","totalDamageDist"]))),c},go=o=>{if(!o||typeof o!="object")return o;const s={...o};return o.details?s.details=sn(o.details):s.details=sn(o),s},an=()=>{if(!ct||!ze)return;ct=!1,nn+=1;const o=Lt;Lt=null;const s=fo(ze);self.postMessage({type:"result",result:s,computeId:nn,logCount:ze.logs.length,token:on,completedAt:Date.now(),flushId:o})},$t=()=>{tn===null&&(tn=setInterval(()=>{an()},5e3))};self.onmessage=o=>{var c,k,v,B;const s=o.data;if((s==null?void 0:s.type)==="reset"){ze={logs:[]},typeof s.token=="number"&&(on=s.token),ct=!0,$t();return}if((s==null?void 0:s.type)==="settings"){ze={logs:(ze==null?void 0:ze.logs)||[],precomputedStats:(c=s.payload)==null?void 0:c.precomputedStats,mvpWeights:(k=s.payload)==null?void 0:k.mvpWeights,statsViewSettings:(v=s.payload)==null?void 0:v.statsViewSettings,disruptionMethod:(B=s.payload)==null?void 0:B.disruptionMethod},ct=!0,$t();return}if((s==null?void 0:s.type)==="log"){ze||(ze={logs:[]}),ze.logs.push(go(s.payload)),ct=!0,$t();return}(s==null?void 0:s.type)==="flush"&&(typeof s.flushId=="number"&&(Lt=s.flushId),ct=!0,an())}})();
