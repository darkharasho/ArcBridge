(function(){"use strict";const an=["selfBuffs","groupBuffs","squadBuffs"],rn=t=>t!=null&&t.classification?t.classification==="Boon":!0,ln=t=>`b${t}`,qn=(t,o)=>{const i=Array.isArray(t==null?void 0:t.activeTimes)?t.activeTimes:[],c=typeof i[0]=="number"?i[0]:0;return c>0?c:o},cn=(t,o,i,c,m,b,P)=>{const T=t==="selfBuffs"?1:Math.max(t==="groupBuffs"?b-1:P-1,0);return!T||!m?{generationMs:0,wastedMs:0}:o?{generationMs:i*m*T,wastedMs:c*m*T}:{generationMs:i/100*m*T,wastedMs:c/100*m*T}},Ln=t=>{const o=new Map,i=new Map;return t.forEach(b=>{const P=b.details;if(!P)return;const T=P.durationMS||0,E=P.buffMap||{};Object.entries(E).forEach(([f,C])=>{if(!o.has(f)){o.set(f,C);return}const R=o.get(f)||{},h={name:R.name||C.name,stacking:R.stacking??C.stacking,icon:R.icon||C.icon,classification:R.classification||C.classification};o.set(f,h)});const J=(P.players||[]).filter(f=>!f.notInSquad),q=J.length,X=new Map;J.forEach(f=>{const C=f.group??0;X.set(C,(X.get(C)||0)+1)}),J.forEach(f=>{const C=f.account||f.name||f.character_name||"Unknown",R=f.profession||"Unknown",h=f.group??0,k=X.get(h)||1,se=qn(f,T);i.has(C)||i.set(C,{account:C,profession:R,professions:new Set,professionTimeMs:{},activeTimeMs:0,numFights:0,groupSupported:0,squadSupported:0,boons:{}});const F=i.get(C);F.profession=R,R!=="Unknown"&&(F.professions.add(R),F.professionTimeMs[R]=(F.professionTimeMs[R]||0)+se),F.activeTimeMs+=se,F.numFights+=1,F.groupSupported+=k,F.squadSupported+=q,an.forEach(W=>{(f[W]||[]).forEach(V=>{var ee,B,ve,pe;if(typeof(V==null?void 0:V.id)!="number")return;const O=ln(V.id),M=E[O];if(!rn(M))return;const ce=(M==null?void 0:M.stacking)??!1,_=((B=(ee=V.buffData)==null?void 0:ee[0])==null?void 0:B.generation)??0,y=((pe=(ve=V.buffData)==null?void 0:ve[0])==null?void 0:pe.wasted)??0,{generationMs:ae,wastedMs:Z}=cn(W,ce,_,y,T,k,q);!ae&&!Z||(o.has(O)||o.set(O,M||{}),F.boons[O]||(F.boons[O]={selfBuffs:{generationMs:0,wastedMs:0},groupBuffs:{generationMs:0,wastedMs:0},squadBuffs:{generationMs:0,wastedMs:0}}),F.boons[O][W].generationMs+=ae,F.boons[O][W].wastedMs+=Z)})})})}),{boonTables:Array.from(o.keys()).filter(b=>rn(o.get(b))).map(b=>{const P=o.get(b)||{},T=[];return i.forEach(E=>{var f;const oe=E.boons[b];if(!oe||!an.some(C=>oe[C].generationMs>0||oe[C].wastedMs>0))return;const q=Array.from(E.professions||[]).filter(C=>C&&C!=="Unknown");let X=E.profession;if(q.length>0){X=q[0];let C=((f=E.professionTimeMs)==null?void 0:f[X])||0;q.forEach(R=>{var k;const h=((k=E.professionTimeMs)==null?void 0:k[R])||0;h>C&&(C=h,X=R)})}T.push({account:E.account,profession:X||"Unknown",professionList:q,activeTimeMs:E.activeTimeMs||1,numFights:E.numFights||1,groupSupported:E.groupSupported||1,squadSupported:E.squadSupported||1,categories:{selfBuffs:{...oe.selfBuffs},groupBuffs:{...oe.groupBuffs},squadBuffs:{...oe.squadBuffs}}})}),{id:b,name:P.name||b,icon:P.icon,stacking:P.stacking??!1,rows:T}}).filter(b=>b.rows.length>0)}},un=(t,o,i,c,m,b,P={})=>{var f,C,R,h;const E=((t==null?void 0:t[o])||[]).find(k=>k.id===i);if(!E)return{generationMs:0,wastedMs:0};const oe=P[ln(i)],J=(oe==null?void 0:oe.stacking)??!1,q=((C=(f=E.buffData)==null?void 0:f[0])==null?void 0:C.generation)??0,X=((h=(R=E.buffData)==null?void 0:R[0])==null?void 0:h.wasted)??0;return cn(o,J,q,X,c,m,b)};var On={methods:{tiered:{tiers:{shortMs:500,mediumMs:1500,weights:{short:.5,medium:1,long:2}}}}};const $n=On,Ye="count",xn=t=>(t||0)/1e3,Wn=(t,o)=>{var m;if(!t)return 0;const i=(m=$n.methods.tiered)==null?void 0:m.tiers;if(!i)return t;const c=o/Math.max(t,1);return c<=i.shortMs?t*i.weights.short:c<=i.mediumMs?t*i.weights.medium:t*i.weights.long},dn=(t,o,i)=>i==="duration"?xn(o):i==="tiered"?Wn(t,o):t;function _n(t,o=Ye){var b;const i=(b=t.statsAll)==null?void 0:b[0],c=Number((i==null?void 0:i.appliedCrowdControl)??0),m=Number((i==null?void 0:i.appliedCrowdControlDuration)??0);return dn(c,m,o)}function Hn(t,o){const i=(o==null?void 0:o.durationMS)||0,c=(o==null?void 0:o.buffMap)||{},m=t.filter(T=>!T.notInSquad),b=m.length,P=new Map;m.forEach(T=>{const E=T.group??0;P.set(E,(P.get(E)||0)+1)}),m.forEach(T=>{const E=P.get(T.group??0)||1,oe=un(T,"selfBuffs",1122,i,E,b,c),J=un(T,"squadBuffs",1122,i,E,b,c);T.stabGeneration=(oe.generationMs+J.generationMs)/1e3})}function jn(t){if(!t.statsTargets)return 0;let o=0;for(const i of t.statsTargets)i&&i.length>0&&(o+=i[0].downContribution||0);return o}function Vn(t){if(!t.extBarrierStats||!t.extBarrierStats.outgoingBarrierAllies)return 0;let o=0;for(const i of t.extBarrierStats.outgoingBarrierAllies)if(i)for(const c of i)c&&(o+=c.barrier||0);return o}function zn(t){if(!t.extHealingStats||!t.extHealingStats.outgoingHealingAllies)return 0;let o=0;for(const i of t.extHealingStats.outgoingHealingAllies)if(i)for(const c of i)c&&(o+=c.healing||0);return o}const Kn=t=>{var o,i,c,m;return(((i=(o=t.support)==null?void 0:o[0])==null?void 0:i.condiCleanse)||0)+(((m=(c=t.support)==null?void 0:c[0])==null?void 0:m.condiCleanseSelf)||0)},Gn=(t,o=Ye)=>{var b;const i=(b=t.support)==null?void 0:b[0],c=Number((i==null?void 0:i.boonStrips)??0),m=Number((i==null?void 0:i.boonStripsTime)??0);return dn(c,m,o)},Jn=t=>jn(t),Yn=t=>zn(t),Qn=t=>Vn(t),Xn=(t,o=Ye)=>_n(t,o),Zn=(t,o)=>Hn(t,o),et="count",nt={downContribution:1,healing:1,cleanses:1,strips:1,stability:1,cc:.7,revives:.7,distanceToTag:.7,participation:.7,dodging:.4,dps:.2,damage:.2},tt={showMvp:!0,topSkillDamageSource:"target",topSkillsMetric:"damage"},fn=new Map([["bleeding","Bleeding"],["burning","Burning"],["confusion","Confusion"],["poison","Poison"],["torment","Torment"],["vulnerability","Vulnerability"],["weakness","Weakness"],["weakened","Weakness"],["blind","Blind"],["blinded","Blind"],["blinding","Blind"],["cripple","Cripple"],["crippled","Cripple"],["chill","Chill"],["chilled","Chill"],["immob","Immobilize"],["immobile","Immobilize"],["immobilized","Immobilize"],["slow","Slow"],["slowed","Slow"],["fear","Fear"],["feared","Fear"],["taunt","Taunt"],["taunted","Taunt"]]),ot={Blind:"https://render.guildwars2.com/file/09770136BB76FD0DBE1CC4267DEED54774CB20F6/102837.png",Chill:"https://render.guildwars2.com/file/28C4EC547A3516AF0242E826772DA43A5EAC3DF3/102839.png",Cripple:"https://render.guildwars2.com/file/070325E519C178D502A8160523766070D30C0C19/102838.png",Fear:"https://render.guildwars2.com/file/30307A6E766D74B6EB09EDA12A4A2DE50E4D76F4/102869.png",Immobilize:"https://render.guildwars2.com/file/397A613651BFCA2832B6469CE34735580A2C120E/102844.png",Slow:"https://render.guildwars2.com/file/F60D1EF5271D7B9319610855676D320CD25F01C6/961397.png",Taunt:"https://render.guildwars2.com/file/02EED459AD65FAF7DF32A260E479C625070841B9/1228472.png",Vulnerability:"https://render.guildwars2.com/file/3A394C1A0A3257EB27A44842DDEEF0DF000E1241/102850.png",Weakness:"https://render.guildwars2.com/file/6CB0E64AF9AA292E332A38C1770CE577E2CDE0E8/102853.png"},Ve=t=>{if(!t)return null;const o=t.trim().toLowerCase(),i=fn.get(o);if(i)return i;const c=o.split(/[^a-z]+/).filter(Boolean);for(const m of c){const b=fn.get(m);if(b)return b}return null},mn=t=>{const o=new Map;return t&&(Object.values(t).forEach(i=>{if(!(i!=null&&i.icon)||!(i!=null&&i.name))return;const c=Ve(i.name);c&&(o.has(c)||o.set(c,i.icon))}),Object.entries(ot).forEach(([i,c])=>{o.has(i)||o.set(i,c)})),o},ze=(t,o,i)=>{var c;if(o&&i){const m=(c=i[`b${o}`])==null?void 0:c.name,b=Ve(m);if(b)return b}return t?Ve(t):null},st=t=>{const o=(t==null?void 0:t.account)||"Unknown";return o&&o!=="Unknown"?o:(t==null?void 0:t.name)||"Unknown"||null},it=t=>{if(!t||t.length===0)return 0;let o=0,i=null;return t.forEach(c=>{const m=Number(c[1]??0);if(Number.isFinite(m)){if(i===null){i=m;return}m>i&&(o+=m-i),i=m}}),o},at=t=>{if(!t||t.length===0)return 0;let o=0;return t.forEach(i=>{const c=Number(i[0]??0),m=Number(i[1]??0);Number.isFinite(m)&&c!==0&&m>0&&(o+=1)}),o},rt=t=>{const{players:o,targets:i,skillMap:c,buffMap:m}=t,b=t.getPlayerKey||st,P=mn(m),T={},E={};o.forEach(f=>{if(f!=null&&f.notInSquad)return;const C=b(f);C&&(T[C]||(T[C]={}),f!=null&&f.totalDamageDist&&f.totalDamageDist.forEach(R=>{R&&R.forEach(h=>{if(!h.id)return;let k=`Skill ${h.id}`,se;c&&(c[`s${h.id}`]?(k=c[`s${h.id}`].name||k,se=c[`s${h.id}`].icon||se):c[`${h.id}`]&&(k=c[`${h.id}`].name||k,se=c[`${h.id}`].icon||se));const F=ze(k,h.id,m);if(!F)return;const W=m==null?void 0:m[`b${h.id}`],j=W==null?void 0:W.name,V=P.get(F)||(W==null?void 0:W.icon),O=k.startsWith("Skill ")?j||F:k,M=se||(W==null?void 0:W.icon),ce=Number(h.connectedHits??0),_=Number(h.hits??0),y=ce>0?ce:_,ae=Number(h.totalDamage??0);if(!Number.isFinite(y)&&!Number.isFinite(ae))return;const Z=E[F]||{name:F,icon:V,applications:0,damage:0};Z.applications+=Number.isFinite(y)?y:0,Z.damage+=Number.isFinite(ae)?ae:0,!Z.icon&&V&&(Z.icon=V),E[F]=Z;const ee=T[C][F]||{icon:V,applications:0,damage:0,skills:{}};ee.applications+=Number.isFinite(y)?y:0,ee.damage+=Number.isFinite(ae)?ae:0;const B=ee.skills[O]||{name:O,hits:0,damage:0,icon:M};B.hits+=Number.isFinite(y)?y:0,B.damage+=Number.isFinite(ae)?ae:0,!B.icon&&M&&(B.icon=M),ee.skills[O]=B,!ee.icon&&V&&(ee.icon=V),T[C][F]=ee})}))});const oe=new Map;o.forEach(f=>{if(f!=null&&f.notInSquad)return;const C=b(f);C&&f!=null&&f.name&&oe.set(f.name,C)});let J=0,q=0,X=0;return i.forEach(f=>{f!=null&&f.buffs&&f.buffs.forEach(C=>{const R=Number(C==null?void 0:C.id);if(!Number.isFinite(R))return;const h=m==null?void 0:m[`b${R}`];if((h==null?void 0:h.classification)!=="Condition")return;const k=(h==null?void 0:h.name)||Ve(h==null?void 0:h.name);if(!k)return;const se=C.statesPerSource||{};X+=1,Object.entries(se).forEach(([F,W])=>{var _;const j=oe.get(F);if(!j)return;q+=1;const V=it(W),O=at(W);J+=V;const M=((_=T[j])==null?void 0:_[k])||{applications:0,damage:0,skills:{}};M.applicationsFromBuffs=(M.applicationsFromBuffs||0)+V,M.applicationsFromBuffsActive=(M.applicationsFromBuffsActive||0)+O,T[j]=T[j]||{},T[j][k]=M;const ce=E[k]||{name:k,applications:0,damage:0};ce.applicationsFromBuffs=(ce.applicationsFromBuffs||0)+V,ce.applicationsFromBuffsActive=(ce.applicationsFromBuffsActive||0)+O,E[k]=ce})})}),Object.values(T).forEach(f=>{Object.values(f).forEach(C=>{typeof C.applicationsFromBuffs=="number"&&(C.applications=C.applicationsFromBuffs)})}),Object.values(E).forEach(f=>{typeof f.applicationsFromBuffs=="number"&&(f.applications=f.applicationsFromBuffs)}),{playerConditions:T,summary:E,meta:{buffStateApplicationsTotal:J,targetBuffEntriesSeen:X,buffStateSourcesSeen:q}}},lt=[{id:"damage",label:"Damage",field:"damage",source:"dpsAll"},{id:"directDmg",label:"Direct Damage",field:"directDmg",source:"statsTargets"},{id:"connectedDamageCount",label:"Connected Damage Count",field:"connectedDamageCount",source:"statsTargets"},{id:"connectedDirectDamageCount",label:"Connected Direct Damage Count",field:"connectedDirectDamageCount",source:"statsTargets"},{id:"battleStandardHits",label:"Battle Standard Tracking"},{id:"criticalRate",label:"Critical Rate",field:"criticalRate",isRate:!0,isPercent:!0,denomField:"critableDirectDamageCount",source:"statsTargets"},{id:"criticalDmg",label:"Critical Damage",field:"criticalDmg",source:"statsTargets"},{id:"flankingRate",label:"Flanking Rate",field:"flankingRate",isRate:!0,isPercent:!0,denomField:"connectedDirectDamageCount",source:"statsTargets"},{id:"glanceRate",label:"Glance Rate",field:"glanceRate",isRate:!0,isPercent:!0,denomField:"connectedDirectDamageCount",source:"statsTargets"},{id:"missed",label:"Missed",field:"missed",source:"statsTargets"},{id:"evaded",label:"Evaded (enemy)",field:"evaded",source:"statsTargets"},{id:"blocked",label:"Blocked (enemy)",field:"blocked",source:"statsTargets"},{id:"interrupts",label:"Interrupts",field:"interrupts",source:"statsTargets"},{id:"invulned",label:"Invulned",field:"invulned",source:"statsTargets"},{id:"killed",label:"Killed",field:"killed",source:"statsTargets"},{id:"downed",label:"Downed",field:"downed",source:"statsTargets"},{id:"downContribution",label:"Down Contribution",field:"downContribution",source:"statsTargets"},{id:"downContributionPercent",label:"Down Contribution %",isRate:!0,isPercent:!0},{id:"againstDownedDamage",label:"Against Downed Damage",field:"againstDownedDamage",source:"statsTargets"},{id:"appliedCrowdControl",label:"Applied CC",field:"appliedCrowdControl",source:"statsTargets"},{id:"appliedCrowdControlDuration",label:"Applied CC Duration",field:"appliedCrowdControlDuration",source:"statsTargets"},{id:"appliedCrowdControlDownContribution",label:"Applied CC Down Contribution",field:"appliedCrowdControlDownContribution",source:"statsTargets"},{id:"appliedCrowdControlDurationDownContribution",label:"Applied CC Duration Down Contribution",field:"appliedCrowdControlDurationDownContribution",source:"statsTargets"},{id:"boonStrips",label:"Boon Strips",field:"boonStrips",source:"support"}],ct=[{id:"damageTaken",label:"Damage Taken",field:"damageTaken"},{id:"damageTakenCount",label:"Damage Taken Count",field:"damageTakenCount"},{id:"conditionDamageTaken",label:"Condition Damage Taken",field:"conditionDamageTaken"},{id:"conditionDamageTakenCount",label:"Condition Damage Taken Count",field:"conditionDamageTakenCount"},{id:"powerDamageTaken",label:"Power Damage Taken",field:"powerDamageTaken"},{id:"powerDamageTakenCount",label:"Power Damage Taken Count",field:"powerDamageTakenCount"},{id:"downedDamageTaken",label:"Downed Damage Taken",field:"downedDamageTaken"},{id:"downedDamageTakenCount",label:"Downed Damage Taken Count",field:"downedDamageTakenCount"},{id:"damageBarrier",label:"Damage Barrier",field:"damageBarrier"},{id:"damageBarrierCount",label:"Damage Barrier Count",field:"damageBarrierCount"},{id:"blockedCount",label:"Blocked Count",field:"blockedCount"},{id:"evadedCount",label:"Evaded Count",field:"evadedCount"},{id:"missedCount",label:"Missed Count",field:"missedCount"},{id:"dodgeCount",label:"Dodge Count",field:"dodgeCount"},{id:"invulnedCount",label:"Invulnerable Count",field:"invulnedCount"},{id:"interruptedCount",label:"Interrupted Count",field:"interruptedCount"},{id:"downCount",label:"Down Count",field:"downCount"},{id:"deadCount",label:"Death Count",field:"deadCount"},{id:"boonStrips",label:"Boon Strips (Incoming)",field:"boonStrips"},{id:"conditionCleanses",label:"Cleanses (Incoming)",field:"conditionCleanses"},{id:"receivedCrowdControl",label:"Crowd Control (Incoming)",field:"receivedCrowdControl"}],ut=[{id:"condiCleanse",label:"Condition Cleanses",field:"condiCleanse"},{id:"condiCleanseTime",label:"Condition Cleanse Time",field:"condiCleanseTime",isTime:!0},{id:"condiCleanseSelf",label:"Condition Cleanse Self",field:"condiCleanseSelf"},{id:"condiCleanseTimeSelf",label:"Condition Cleanse Time Self",field:"condiCleanseTimeSelf",isTime:!0},{id:"boonStrips",label:"Boon Strips",field:"boonStrips"},{id:"boonStripsTime",label:"Boon Strips Time",field:"boonStripsTime",isTime:!0},{id:"boonStripDownContribution",label:"Boon Strip Down Contribution",field:"boonStripDownContribution"},{id:"boonStripDownContributionTime",label:"Boon Strip Down Contribution Time",field:"boonStripDownContributionTime",isTime:!0},{id:"stunBreak",label:"Stun Breaks",field:"stunBreak"},{id:"removedStunDuration",label:"Removed Stun Duration",field:"removedStunDuration",isTime:!0},{id:"resurrects",label:"Resurrects",field:"resurrects"},{id:"resurrectTime",label:"Resurrect Time",field:"resurrectTime",isTime:!0}],dt=["battle standard","glyph of renewal","glyph of the stars","illusion of life","spirit of nature","nature spirit","search and rescue","signet of mercy"],ft=new Set([10244]),mt=(t,o)=>{var m;if(ft.has(t))return!0;const i=(o==null?void 0:o[`s${t}`])||(o==null?void 0:o[`${t}`]),c=((m=i==null?void 0:i.name)==null?void 0:m.toLowerCase())||"";return dt.some(b=>c.includes(b))},gt=t=>{if(!t||!Number.isFinite(t))return"--:--";const o=Math.max(0,Math.round(t/1e3)),i=Math.floor(o/3600),c=Math.floor(o%3600/60),m=o%60;return i>0?`${i}:${String(c).padStart(2,"0")}:${String(m).padStart(2,"0")}`:`${c}:${String(m).padStart(2,"0")}`},Qe={Guardian:"#72C1D9",Dragonhunter:"#72C1D9",Firebrand:"#72C1D9",Willbender:"#72C1D9",Revenant:"#D16E5A",Herald:"#D16E5A",Renegade:"#D16E5A",Vindicator:"#D16E5A",Warrior:"#FFD166",Berserker:"#FFD166",Spellbreaker:"#FFD166",Bladesworn:"#FFD166",Engineer:"#D09C59",Scrapper:"#D09C59",Holosmith:"#D09C59",Mechanist:"#D09C59",Ranger:"#8CDC82",Druid:"#8CDC82",Soulbeast:"#8CDC82",Untamed:"#8CDC82",Thief:"#C08F95",Daredevil:"#C08F95",Deadeye:"#C08F95",Specter:"#C08F95",Elementalist:"#F68A87",Tempest:"#F68A87",Weaver:"#F68A87",Catalyst:"#F68A87",Mesmer:"#B679D5",Chronomancer:"#B679D5",Mirage:"#B679D5",Virtuoso:"#B679D5",Necromancer:"#52A76F",Reaper:"#52A76F",Scourge:"#52A76F",Harbinger:"#52A76F",Ritualist:"#52A76F",Luminary:"#72C1D9",Conduit:"#D16E5A",Paragon:"#FFD166",Amalgam:"#D09C59",Galeshot:"#8CDC82",Antiquary:"#C08F95",Evoker:"#F68A87",Troubadour:"#B679D5",Unknown:"#64748B"};function gn(t){return Qe[t]||Qe.Unknown}const pt=({logs:t,precomputedStats:o,mvpWeights:i,statsViewSettings:c,disruptionMethod:m})=>{const b=(()=>{const J=t.filter(q=>q.details&&q.details.players&&q.details.players.length>0);return console.log("[useStatsAggregation] Filtering logs:",{total:t.length,passed:J.length,statuses:t.map(q=>q.status),hasDetails:t.map(q=>!!q.details)}),J})(),P=c||tt,T=i||nt,E=(()=>{if(o)return o;const J=m||et,q=P.topSkillDamageSource||"target",X=P.topSkillsMetric||"damage",f=b.length;let C=0,R=0,h=0,k=0,se=0,F=0,W=0,j=0;const V=e=>{const s=((e==null?void 0:e.players)||[]).filter(L=>!L.notInSquad);let g=0,d=0,w=0,v=0;return s.forEach(L=>{var Y;const ie=(Y=L.defenses)==null?void 0:Y[0];if(!ie)return;const ue=Number(ie.downCount||0),ne=Number(ie.deadCount||0);g+=ue+ne,w+=ne}),s.forEach(L=>{!L.statsTargets||L.statsTargets.length===0||L.statsTargets.forEach(ie=>{const ue=ie==null?void 0:ie[0];if(!ue)return;const ne=Number(ue.downed||0),Y=Number(ue.killed||0);d+=ne+Y,v+=Y})}),{squadDownsDeaths:g,enemyDownsDeaths:d,squadDeaths:w,enemyDeaths:v}},O=e=>{const{squadDownsDeaths:n,enemyDownsDeaths:s}=V(e);return n>0||s>0?s>n:typeof(e==null?void 0:e.success)=="boolean"?e.success:!1},M=new Map,ce=new Set(["boonStripsTime","condiCleanseTime","condiCleanseTimeSelf"]),_={},y={},ae=new Map,Z={},ee={},B={},ve=new Map,pe=new Map,Ke=new Set(Object.keys(Qe)),Ge=["Guardian","Revenant","Warrior","Engineer","Ranger","Thief","Elementalist","Mesmer","Necromancer"],He=e=>{if(!e)return"Unknown";const n=String(e).replace(/\s\d+$/,"");if(Ke.has(n))return n;const s=n.toLowerCase();return Ge.find(d=>s.includes(d.toLowerCase()))||n||"Unknown"},Ct=e=>e!=null&&e.classification?e.classification==="Boon":!0;console.log("[useStatsAggregation] Starting aggregation loop",{validLogsCount:b.length}),b.forEach((e,n)=>{var xe,ye;const s=e.details;if(!s)return;const g=s.players;console.log(`[useStatsAggregation] Processing log ${n}:`,{playerCount:g==null?void 0:g.length,hasTargets:!!s.targets,firstPlayer:g!=null&&g[0]?{account:g[0].account,notInSquad:g[0].notInSquad}:"none"});const d=s.targets||[],w=s.combatReplayMetaData||{},v=(w==null?void 0:w.inchToPixel)>0?w.inchToPixel:1,L=(w==null?void 0:w.pollingRate)>0?w.pollingRate:1,ie=5e3,ue=a=>Array.isArray(a)?a.map(D=>Array.isArray(D)?[Number(D[0]),Number(D[1])]:null).filter(D=>!!D&&Number.isFinite(D[0])):[];let ne=[],Y=s.durationMS||0,Fe=!1;const Ce=g.find(a=>(a==null?void 0:a.hasCommanderTag)&&!(a!=null&&a.notInSquad));(xe=Ce==null?void 0:Ce.combatReplayData)!=null&&xe.positions&&(ne=Ce.combatReplayData.positions,ue(Ce.combatReplayData.dead).forEach(([D])=>{D>0&&(Fe=!0,Y=Math.min(Y,D))}));const Ie=a=>{var ge;const D=(ge=a.statsAll)==null?void 0:ge[0];if((D==null?void 0:D.distToCom)!==void 0&&(D==null?void 0:D.distToCom)!=="Infinity")return Math.round(Number(D.distToCom));if((D==null?void 0:D.stackDist)!==void 0)return Math.round(Number(D.stackDist))||0;if(a.hasCommanderTag)return 0;const A=a.combatReplayData;if(!(A!=null&&A.positions)||!ne.length)return 0;const ke=A.positions,u=ue(A.dead),x=ue(A.down),te=Math.floor((A.start||0)/L);let G=0;if(u.length&&x.length)for(const[re]of u){if(re<0)continue;const Pe=Math.max(0,Math.floor(re/L))-te;for(const[we,Me]of x){if(re!==Me)continue;const Ae=Fe&&we>Y?Math.max(1,Math.floor(Y/L)):Pe,le=Math.max(0,Math.min(Ae,ke.length,ne.length));if(le<=0)continue;let he=0;for(let me=0;me<le;me++){const[Ue,qe]=ke[me],[Le,Oe]=ne[me];he+=Math.hypot(Ue-Le,qe-Oe)}G=Math.round(he/le/v)}}return G},de=g.filter(a=>!a.notInSquad),sn=g.filter(a=>a.notInSquad);h+=de.length,k+=d.filter(a=>!a.isFake).length,Zn(g,{durationMS:s.durationMS,buffMap:s.buffMap});const{squadDeaths:S,enemyDeaths:K}=V(s);se+=S,F+=K,j+=S,W+=K,O(s)?C++:R++;const H=s.skillMap?Number((ye=Object.keys(s.skillMap).find(a=>{var D,A;return((A=(D=s.skillMap)==null?void 0:D[a])==null?void 0:A.name)==="Battle Standard"}))==null?void 0:ye.replace(/^s/,"")):null;g.forEach(a=>{var qe,Le,Oe,je,En,Fn,vn,Bn,Nn,In;if(a.notInSquad)return;const D=a.account||"Unknown",A=D!=="Unknown"?D:a.name||"Unknown",ke=a.name||"Unknown";M.has(A)||M.set(A,{name:ke,account:A,downContrib:0,cleanses:0,strips:0,stab:0,healing:0,barrier:0,cc:0,logsJoined:0,totalDist:0,distCount:0,dodges:0,downs:0,deaths:0,totalFightMs:0,offenseTotals:{},offenseRateWeights:{},defenseActiveMs:0,defenseTotals:{},supportActiveMs:0,supportTotals:{},healingActiveMs:0,healingTotals:{},profession:a.profession||"Unknown",professions:new Set,professionTimeMs:{},isCommander:!1,damage:0,dps:0,revives:0,outgoingConditions:{},incomingConditions:{}});const u=M.get(A);if(a.hasCommanderTag&&(u.isCommander=!0),a.profession&&a.profession!=="Unknown"){u.profession=a.profession,u.professions.add(a.profession);const r=Array.isArray(a.activeTimes)&&typeof a.activeTimes[0]=="number"?a.activeTimes[0]:s.durationMS||0;u.professionTimeMs[a.profession]=(u.professionTimeMs[a.profession]||0)+r}u.logsJoined++,u.downContrib+=Jn(a),u.cleanses+=Kn(a),u.strips+=Gn(a,J),u.healing+=Yn(a),u.barrier+=Qn(a),u.cc+=Xn(a,J),u.stab+=a.stabGeneration||0;const x=Ie(a);x<=ie&&(u.totalDist+=x,u.distCount++),(qe=a.defenses)!=null&&qe[0]&&(u.dodges+=a.defenses[0].dodgeCount||0,u.downs+=a.defenses[0].downCount||0,u.deaths+=a.defenses[0].deadCount||0),s.durationMS&&(u.totalFightMs+=s.durationMS);const te=Array.isArray(a.activeTimes)&&typeof a.activeTimes[0]=="number"?a.activeTimes[0]:s.durationMS||0;u.defenseActiveMs+=te,u.supportActiveMs+=te,u.healingActiveMs+=te,Array.isArray(a.buffUptimes)&&a.buffUptimes.length>0&&a.buffUptimes.forEach(r=>{var Pn,Rn,yn,Un;if(typeof(r==null?void 0:r.id)!="number")return;const l=`b${r.id}`,p=((Pn=s.buffMap)==null?void 0:Pn[l])||((Rn=s.buffMap)==null?void 0:Rn[String(r.id)]);if(!p||Ct(p))return;const I=Number(((Un=(yn=r.buffData)==null?void 0:yn[0])==null?void 0:Un.uptime)??0);if(!Number.isFinite(I)||I<=0)return;const Q=(p==null?void 0:p.stacking)??!1,Be=(Q?I:I/100)*te;if(!Number.isFinite(Be)||Be<=0)return;ve.has(l)||ve.set(l,{name:p==null?void 0:p.name,stacking:Q,icon:p==null?void 0:p.icon}),pe.has(l)||pe.set(l,new Map);const Re=pe.get(l),Ne=u.account||a.account||a.name||"Unknown";let De=Re.get(Ne);De||(De={account:Ne,profession:u.profession||a.profession||"Unknown",professions:new Set,professionTimeMs:{},totalMs:0,durationMs:0},Re.set(Ne,De));const _e=a.profession||u.profession;_e&&_e!=="Unknown"&&(De.professions.add(_e),De.professionTimeMs[_e]=(De.professionTimeMs[_e]||0)+te,De.profession=_e),De.totalMs+=Be,De.durationMs+=te}),(Le=a.defenses)!=null&&Le[0]&&ct.forEach(r=>{const l=Number(a.defenses[0][r.field]??0);Number.isFinite(l)&&(u.defenseTotals[r.id]=(u.defenseTotals[r.id]||0)+l)}),(Oe=a.support)!=null&&Oe[0]&&ut.forEach(r=>{let l=Number(a.support[0][r.field]??0);Number.isFinite(l)&&(ce.has(r.field)&&l>999999&&(l=0),u.supportTotals[r.id]=(u.supportTotals[r.id]||0)+l)});const G=(r,l)=>{Number.isFinite(l)&&(u.healingTotals[r]=(u.healingTotals[r]||0)+l)};if(Array.isArray(a.rotation)){let r=0;a.rotation.forEach(l=>{var I;if(!(l!=null&&l.id)||!mt(l.id,s.skillMap))return;const p=((I=l.skills)==null?void 0:I.length)||0;p>0&&(r+=p,G(`resUtility_s${l.id}`,p))}),r>0&&G("resUtility",r)}const ge=(je=a.statsAll)==null?void 0:je[0],re=(En=a.dpsAll)==null?void 0:En[0],Pe=(Fn=a.support)==null?void 0:Fn[0];if(lt.forEach(r=>{if(r.id==="downContributionPercent"||!r.field)return;let l=0,p=0;r.source==="dpsAll"&&re?l=Number(re[r.field]??0):r.source==="statsAll"&&ge?(l=Number(ge[r.field]??0),p=Number(ge[r.denomField||r.weightField||"connectedDamageCount"]??0)):r.source==="support"&&Pe?l=Number(Pe[r.field]??0):a.statsTargets&&a.statsTargets.forEach(I=>{I!=null&&I[0]&&(l+=Number(I[0][r.field]??0),p+=Number(I[0][r.denomField||r.weightField||"connectedDamageCount"]??0))}),Number.isFinite(l)&&(u.offenseTotals[r.id]=(u.offenseTotals[r.id]||0)+l,r.isRate&&p>0&&(u.offenseRateWeights[r.id]=(u.offenseRateWeights[r.id]||0)+p))}),a.targetDamageDist&&Number.isFinite(H)){const r=a.targetDamageDist.flatMap(l=>l||[]).flatMap(l=>l||[]).reduce((l,p)=>p!=null&&p.id&&p.id===H?l+((p==null?void 0:p.connectedHits)||0):l,0);u.offenseTotals.battleStandardHits=(u.offenseTotals.battleStandardHits||0)+r}u.revives+=((Bn=(vn=a.support)==null?void 0:vn[0])==null?void 0:Bn.resurrects)||0,re&&(u.damage+=re.damage||0,u.dps+=re.dps||0);const we=r=>{var Q,We,Be,Re;let l=`Skill ${r.id}`;const p=((Q=s.skillMap)==null?void 0:Q[`s${r.id}`])||((We=s.skillMap)==null?void 0:We[`${r.id}`]);let I=p==null?void 0:p.icon;if(p!=null&&p.name&&(l=p.name),l.startsWith("Skill ")){const Ne=ze(l,r.id,s.buffMap);Ne&&(l=Ne,I=((Re=(Be=s.buffMap)==null?void 0:Be[`b${r.id}`])==null?void 0:Re.icon)||I)}return{name:l,icon:I}},Me=r=>{if(!(r!=null&&r.id))return;const{name:l,icon:p}=we(r);_[r.id]||(_[r.id]={name:l,icon:p,damage:0,hits:0,downContribution:0}),_[r.id].name.startsWith("Skill ")&&!l.startsWith("Skill ")&&(_[r.id].name=l),!_[r.id].icon&&p&&(_[r.id].icon=p),_[r.id].damage+=r.totalDamage,_[r.id].hits+=r.connectedHits,_[r.id].downContribution+=Number(r.downContribution||0)},Ae=a.account||a.name||"Unknown",le=a.profession||"Unknown",he=`${Ae}|${le}`;let me=ae.get(he);me||(me={key:he,account:Ae,displayName:Ae,profession:le,professionList:[le],totalFightMs:0,skills:new Map},ae.set(he,me)),me.professionList.includes(le)||me.professionList.push(le),me.totalFightMs+=s.durationMS||0;const Ue=r=>{if(!(r!=null&&r.id))return;const{name:l,icon:p}=we(r),I=`s${r.id}`;let Q=me.skills.get(I);Q||(Q={id:I,name:l,icon:p,damage:0,downContribution:0},me.skills.set(I,Q)),Q.name.startsWith("Skill ")&&!l.startsWith("Skill ")&&(Q.name=l),!Q.icon&&p&&(Q.icon=p),Q.damage+=Number(r.totalDamage||0),Q.downContribution+=Number(r.downContribution||0)};q==="total"?(Nn=a.totalDamageDist)==null||Nn.forEach(r=>{r==null||r.forEach(l=>{Me(l),Ue(l)})}):(In=a.targetDamageDist)==null||In.forEach(r=>{r==null||r.forEach(l=>{l==null||l.forEach(p=>{Me(p),Ue(p)})})}),a.totalDamageTaken&&a.totalDamageTaken.forEach(r=>{r==null||r.forEach(l=>{var We,Be,Re,Ne;if(!(l!=null&&l.id))return;let p=`Skill ${l.id}`;const I=((We=s.skillMap)==null?void 0:We[`s${l.id}`])||((Be=s.skillMap)==null?void 0:Be[`${l.id}`]);let Q=I==null?void 0:I.icon;if(I!=null&&I.name&&(p=I.name),p.startsWith("Skill ")){const De=ze(p,l.id,s.buffMap);De&&(p=De,Q=((Ne=(Re=s.buffMap)==null?void 0:Re[`b${l.id}`])==null?void 0:Ne.icon)||Q)}y[l.id]||(y[l.id]={name:p,icon:Q,damage:0,hits:0}),(!y[l.id].name.startsWith("Skill ")||p.startsWith("Skill "))&&(y[l.id].name=p),!y[l.id].icon&&Q&&(y[l.id].icon=Q),y[l.id].damage+=l.totalDamage,y[l.id].hits+=l.hits})})}),sn.forEach(a=>{const D=He(a.profession||a.name);D&&(B[D]=(B[D]||0)+1)});const $=rt({players:g,targets:d,skillMap:s.skillMap,buffMap:s.buffMap,getPlayerKey:a=>a.account&&a.account!=="Unknown"?a.account:a.name||null}),fe=mn(s.buffMap);Object.entries($.playerConditions).forEach(([a,D])=>{const A=M.get(a);A&&Object.entries(D).forEach(([ke,u])=>{const x=A.outgoingConditions[ke]||{applications:0,damage:0,skills:{},icon:u.icon};x.applications+=Number(u.applications||0),x.damage+=Number(u.damage||0),u.applicationsFromBuffs&&(x.applicationsFromBuffs=(x.applicationsFromBuffs||0)+u.applicationsFromBuffs),u.applicationsFromBuffsActive&&(x.applicationsFromBuffsActive=(x.applicationsFromBuffsActive||0)+u.applicationsFromBuffsActive),Object.entries(u.skills||{}).forEach(([te,G])=>{const ge=x.skills[te]||{name:G.name,hits:0,damage:0,icon:G.icon};ge.hits+=Number(G.hits||0),ge.damage+=Number(G.damage||0),!ge.icon&&G.icon&&(ge.icon=G.icon),x.skills[te]=ge}),!x.icon&&u.icon&&(x.icon=u.icon),A.outgoingConditions[ke]=x})}),Object.entries($.summary).forEach(([a,D])=>{const A=Z[a]||{name:D.name||a,icon:D.icon,applications:0,damage:0};A.applications+=Number(D.applications||0),A.damage+=Number(D.damage||0),D.applicationsFromBuffs&&(A.applicationsFromBuffs=(A.applicationsFromBuffs||0)+D.applicationsFromBuffs),D.applicationsFromBuffsActive&&(A.applicationsFromBuffsActive=(A.applicationsFromBuffsActive||0)+D.applicationsFromBuffsActive),!A.icon&&D.icon&&(A.icon=D.icon),Z[a]=A}),de.forEach(a=>{const D=a.account&&a.account!=="Unknown"?a.account:a.name||"Unknown",A=M.get(D);!A||!a.totalDamageTaken||a.totalDamageTaken.forEach(ke=>ke==null?void 0:ke.forEach(u=>{var me,Ue,qe,Le,Oe,je;if(!(u!=null&&u.id))return;let x=`Skill ${u.id}`;const te=((me=s.skillMap)==null?void 0:me[`s${u.id}`])||((Ue=s.skillMap)==null?void 0:Ue[`${u.id}`]);te!=null&&te.name&&(x=te.name);const G=ze(x,u.id,s.buffMap);if(!G)return;const ge=(Le=(qe=s.buffMap)==null?void 0:qe[`b${u.id}`])==null?void 0:Le.name,re=fe.get(G)||((je=(Oe=s.buffMap)==null?void 0:Oe[`b${u.id}`])==null?void 0:je.icon),Pe=(te==null?void 0:te.icon)||re;x.startsWith("Skill ")&&(ge||G)&&(x=ge||G);const we=Number(u.hits??0),Me=Number(u.totalDamage??0),Ae=ee[G]||{name:G,icon:re,applications:0,damage:0};Ae.applications+=Number.isFinite(we)?we:0,Ae.damage+=Number.isFinite(Me)?Me:0,!Ae.icon&&re&&(Ae.icon=re),ee[G]=Ae;const le=A.incomingConditions[G]||{applications:0,damage:0,skills:{},icon:re};le.applications+=Number.isFinite(we)?we:0,le.damage+=Number.isFinite(Me)?Me:0;const he=le.skills[x]||{name:x,hits:0,damage:0,icon:Pe};he.hits+=Number.isFinite(we)?we:0,he.damage+=Number.isFinite(Me)?Me:0,!he.icon&&Pe&&(he.icon=Pe),le.skills[x]=he,!le.icon&&re&&(le.icon=re),A.incomingConditions[G]=le}))})});const ht=f>0?Math.round(h/f):0,Dt=f>0?Math.round(k/f):0,Tt=se>0?(F/se).toFixed(2):F>0?"∞":"0.00",St=W>0?(j/W).toFixed(2):j>0?"∞":"0.00",Tn=(e,n)=>{const g=e.filter(v=>Number.isFinite(v.value)&&(n?v.value>0:v.value>=0)).sort((v,L)=>{const ie=n?L.value-v.value:v.value-L.value;return ie!==0?ie:v.account.localeCompare(L.account)});let d=null,w=0;return g.map((v,L)=>((d===null||v.value!==d)&&(w=L+1,d=v.value),{rank:w,...v}))},en=Array.from(M.values()).map(e=>{const n=Array.from(e.professions).filter(s=>s!=="Unknown");if(e.professionList=n,n.length>0){let s=n[0],g=e.professionTimeMs[s]||0;n.forEach(d=>{const w=e.professionTimeMs[d]||0;w>g&&(g=w,s=d)}),e.profession=s}return{key:e.account,stat:e}}),Je=(e,n)=>{switch(n){case"downContrib":return e.downContrib;case"barrier":return e.barrier;case"healing":return e.healing;case"dodges":return e.dodges;case"strips":return e.strips;case"cleanses":return e.cleanses;case"cc":return e.cc;case"stability":return e.stab;case"revives":return e.revives;case"dps":return e.dps;case"damage":return e.damage;case"participation":return e.logsJoined;case"closestToTag":return!e.isCommander&&e.distCount>0?e.totalDist/e.distCount:Number.POSITIVE_INFINITY;default:return 0}},be=(e,n)=>Tn(en.map(({stat:s})=>({account:s.account,profession:s.profession,professionList:s.professionList,value:Je(s,e),count:s.logsJoined})),n),z={downContrib:be("downContrib",!0),barrier:be("barrier",!0),healing:be("healing",!0),dodges:be("dodges",!0),strips:be("strips",!0),cleanses:be("cleanses",!0),cc:be("cc",!0),stability:be("stability",!0),revives:be("revives",!0),participation:be("participation",!0),dps:be("dps",!0),damage:be("damage",!0),closestToTag:be("closestToTag",!1).filter(e=>Number.isFinite(e.value))},kt={downContrib:"downContrib",barrier:"barrier",healing:"healing",dodges:"dodges",strips:"strips",cleanses:"cleanses",cc:"cc",stability:"stability",closestToTag:"closestToTag"},U=e=>{const n=e==null?void 0:e[0];return{value:(n==null?void 0:n.value)??0,player:(n==null?void 0:n.account)??"-",count:(n==null?void 0:n.count)??0,profession:(n==null?void 0:n.profession)??"Unknown",professionList:(n==null?void 0:n.professionList)??[]}},Ee={maxDownContrib:U([]),maxBarrier:U([]),maxHealing:U([]),maxDodges:U([]),maxStrips:U([]),maxCleanses:U([]),maxCC:U([]),maxStab:U([]),closestToTag:U([])},Se={},wt=(e,n)=>{if(n==="closestToTag")return Je(e,n);const s=Math.max(1,(e.totalFightMs||0)/1e3);return Je(e,n)/s};Object.values(kt).forEach(e=>{const n=e!=="closestToTag";Se[e]=Tn(en.map(({stat:s})=>({account:s.account,profession:s.profession,professionList:s.professionList,value:wt(s,e),count:s.logsJoined})),n)}),Ee.maxDownContrib=U(Se.downContrib),Ee.maxBarrier=U(Se.barrier),Ee.maxHealing=U(Se.healing),Ee.maxDodges=U(Se.dodges),Ee.maxStrips=U(Se.strips),Ee.maxCleanses=U(Se.cleanses),Ee.maxCC=U(Se.cc),Ee.maxStab=U(Se.stability),Ee.closestToTag=U(Se.closestToTag);const Mt={maxDownContrib:U(z.downContrib),maxBarrier:U(z.barrier),maxHealing:U(z.healing),maxDodges:U(z.dodges),maxStrips:U(z.strips),maxCleanses:U(z.cleanses),maxCC:U(z.cc),maxStab:U(z.stability),closestToTag:U(z.closestToTag)};let Sn={player:"None",account:"None",score:-1,profession:"Unknown",professionList:[],color:"#64748b",topStats:[]},kn,wn,Mn=0;if(P!=null&&P.showMvp){const e=[];if(en.forEach(({stat:n})=>{let s=0;const g=[],d=(w,v,L,ie,ue=!0)=>{var Y,Fe;if(L<=0)return;const ne=((Y=v[0])==null?void 0:Y.value)||0;if(ne&&Number.isFinite(w)&&(ue?w>0:w<Number.POSITIVE_INFINITY)){const Ce=ue?w/ne:ne/w;s+=Ce*L;const Ie=((Fe=v.find(de=>de.account===n.account))==null?void 0:Fe.rank)||0;g.push({name:ie,ratio:Ce,val:w.toLocaleString(),rank:Ie})}};d(n.downContrib,z.downContrib,T.downContribution,"Down Contribution"),d(n.healing,z.healing,T.healing,"Healing"),d(n.cleanses,z.cleanses,T.cleanses,"Cleanses"),d(n.strips,z.strips,T.strips,"Strips"),d(n.stab,z.stability,T.stability,"Stability"),d(n.cc,z.cc,T.cc,"CC"),d(n.revives,z.revives,T.revives,"Revives"),d(Je(n,"closestToTag"),z.closestToTag,T.distanceToTag,"Distance to Tag",!1),d(n.logsJoined,z.participation,T.participation,"Participation"),d(n.dodges,z.dodges,T.dodging,"Dodging"),d(n.dps,z.dps,T.dps,"DPS"),d(n.damage,z.damage,T.damage,"Damage"),e.push({...n,score:s,contribs:g})}),e.sort((n,s)=>s.score-n.score),e[0]){const n=[...e[0].contribs].sort((s,g)=>g.ratio-s.ratio)[0];Sn={...e[0],player:e[0].name,reason:(n==null?void 0:n.name)||"Top Performance",topStats:e[0].contribs.slice(0,3)}}kn=e[1],wn=e[2],Mn=e.length>0?e.reduce((n,s)=>n+s.score,0)/e.length:0}const At=Object.values(_).sort((e,n)=>{const s=X==="downContribution"?e.downContribution:e.damage;return(X==="downContribution"?n.downContribution:n.damage)-s}).slice(0,25),Et=Object.values(y).sort((e,n)=>n.damage-e.damage).slice(0,25),Ft=e=>{const n=String(e).replace(/^Detailed\s*WvW\s*-\s*/i,"").replace(/^World\s*vs\s*World\s*-\s*/i,"").replace(/^WvW\s*-\s*/i,"").trim(),s=n.match(/^(Red|Blue|Green)\s+(?:Alpine|Desert)?\s*Borderlands$/i);return s?`${s[1]} Borderlands`:n||"Unknown"},An=(e,n)=>Ft((e==null?void 0:e.zone)||(e==null?void 0:e.mapName)||(e==null?void 0:e.map)||(e==null?void 0:e.location)||(e==null?void 0:e.fightName)||(n==null?void 0:n.fightName)||(n==null?void 0:n.encounterName)||"Unknown"),nn={};b.forEach(e=>{const n=An(e==null?void 0:e.details,e);nn[n]=(nn[n]||0)+1});const vt=Object.entries(nn).map(([e,n])=>{const s=String(e).trim(),g=/eternal battlegrounds|^ebg$/i.test(s);let d="#64748b";return g?d="#ffffff":/red/i.test(s)?d="#ef4444":/blue/i.test(s)?d="#3b82f6":/green/i.test(s)&&(d="#22c55e"),{name:e,value:n,color:d}}).sort((e,n)=>n.value-e.value),{boonTables:Bt}=Ln(b),Nt=b.map((e,n)=>{var g,d,w;const s=((g=e.details)==null?void 0:g.players)||[];return{index:n+1,label:`Log ${n+1}`,timestamp:((d=e.details)==null?void 0:d.uploadTime)||0,squadCount:s.filter(v=>!v.notInSquad).length,friendlyCount:s.length,enemies:((w=e.details)==null?void 0:w.targets).filter(v=>!v.isFake).length}}).sort((e,n)=>e.timestamp-n.timestamp),tn={};Array.from(M.values()).forEach(e=>{e.profession&&e.profession!=="Unknown"&&(tn[e.profession]=(tn[e.profession]||0)+1)});const It=Object.entries(tn).map(([e,n])=>({name:e,value:n,color:gn(e)})).sort((e,n)=>n.value-e.value),on={};Object.keys(B).length===0&&b.forEach(e=>{var n,s;(s=(n=e.details)==null?void 0:n.targets)==null||s.forEach(g=>{if(g.isFake)return;const d=g.profession&&g.profession!=="Unknown"?g.profession:g.name||g.id||"Unknown",w=He(d);on[w]=(on[w]||0)+1})});const Pt=Object.keys(B).length>0?B:on,Rt=Object.entries(Pt).map(([e,n])=>({name:e,value:n,color:gn(e)})).sort((e,n)=>n.value-e.value).slice(0,10),yt=b.map((e,n)=>({log:e,originalIndex:n})).sort((e,n)=>{var s,g;return(((s=e.log.details)==null?void 0:s.uploadTime)||0)-(((g=n.log.details)==null?void 0:g.uploadTime)||0)}).map(({log:e},n)=>{const s=e.details;if(!s)return null;const g=s.players||[],d=g.filter(S=>!S.notInSquad),w=g.filter(S=>S.notInSquad),v=s.targets||[],L=v.filter(S=>!S.isFake),ie=d.reduce((S,K)=>{var N,H;return S+(((H=(N=K.dpsAll)==null?void 0:N[0])==null?void 0:H.damage)||0)},0),ue=d.reduce((S,K)=>{var N,H;return S+(((H=(N=K.defenses)==null?void 0:N[0])==null?void 0:H.damageTaken)||0)},0),{enemyDeaths:ne,enemyDownsDeaths:Y}=V(s),Fe=O(s),Ce=s.uploadTime??e.uploadTime??0,Ie=An(s,e),de={red:0,green:0,blue:0},sn=(S,K)=>{if(S==null)return null;if(typeof S=="string"){const N=S.toLowerCase();return N.includes("red")?"red":N.includes("green")?"green":N.includes("blue")?"blue":N==="r"?"red":N==="g"?"green":N==="b"?"blue":null}if(typeof S=="number")if(K==="zeroBased"){if(S===0)return"red";if(S===1)return"green";if(S===2)return"blue"}else{if(S===1)return"red";if(S===2)return"green";if(S===3)return"blue"}return null};if(s.teamCounts&&typeof s.teamCounts=="object")de.red=Number(s.teamCounts.red||s.teamCounts.r||0),de.green=Number(s.teamCounts.green||s.teamCounts.g||0),de.blue=Number(s.teamCounts.blue||s.teamCounts.b||0);else{const S=[];v.forEach($=>{if($!=null&&$.isFake)return;const fe=$.teamID??$.team??$.teamColor;fe!=null&&S.push(fe)}),g.forEach($=>{if(!($!=null&&$.notInSquad))return;const fe=$.teamID??$.team??$.teamColor;fe!=null&&S.push(fe)});const K=new Set;S.forEach($=>{typeof $=="number"&&K.add($)});const N=K.has(0)?"zeroBased":K.has(3)?"oneBased":"zeroBased";if(S.forEach($=>{const fe=sn($,N);fe&&(de[fe]+=1)}),de.red+de.green+de.blue===0&&S.length>0){const $=new Map;S.forEach(xe=>{const ye=String(xe);$.set(ye,($.get(ye)||0)+1)});const fe=Array.from($.values()).sort((xe,ye)=>ye-xe);de.red=fe[0]||0,de.green=fe[1]||0,de.blue=fe[2]||0}}return{id:e.filePath||`fight-${n}`,label:e.encounterName||`Fight ${n+1}`,permalink:e.permalink,timestamp:Ce,mapName:Ie,duration:gt(s.durationMS),isWin:Fe,squadCount:d.length,allyCount:w.length,enemyCount:L.length,teamCounts:de,alliesDown:d.reduce((S,K)=>{var N,H;return S+(((H=(N=K.defenses)==null?void 0:N[0])==null?void 0:H.downCount)||0)},0),alliesDead:d.reduce((S,K)=>{var N,H;return S+(((H=(N=K.defenses)==null?void 0:N[0])==null?void 0:H.deadCount)||0)},0),alliesRevived:d.reduce((S,K)=>{var N,H;return S+(((H=(N=K.statsAll)==null?void 0:N[0])==null?void 0:H.saved)||0)},0),rallies:0,enemyDeaths:ne,enemyDowns:Math.max(0,Y-ne),totalOutgoingDamage:ie,totalIncomingDamage:ue,incomingBarrierAbsorbed:d.reduce((S,K)=>{var N,H;return S+(((H=(N=K.defenses)==null?void 0:N[0])==null?void 0:H.damageBarrier)||0)},0),outgoingBarrierAbsorbed:d.reduce((S,K)=>{var N,H;return S+(((H=(N=K.statsAll)==null?void 0:N[0])==null?void 0:H.damageBarrier)||0)},0)}}).filter(Boolean),Ut=Array.from(pe.entries()).map(([e,n])=>{const s=ve.get(e)||{},g=Array.from(n.values()).map(d=>{var ne;const w=Array.from(d.professions||[]).filter(Y=>Y&&Y!=="Unknown");let v=d.profession||"Unknown";if(w.length>0){v=w[0];let Y=((ne=d.professionTimeMs)==null?void 0:ne[v])||0;w.forEach(Fe=>{var Ie;const Ce=((Ie=d.professionTimeMs)==null?void 0:Ie[Fe])||0;Ce>Y&&(Y=Ce,v=Fe)})}const L=d.durationMs||0,ie=d.totalMs/1e3,ue=L>0?d.totalMs/L:0;return{account:d.account,profession:v,professionList:w,total:ie,perSecond:ue,duration:L/1e3}}).filter(d=>d.total>0||d.perSecond>0);return{id:e,name:s.name||e,icon:s.icon,rows:g}}).filter(e=>e.rows.length>0),qt=Array.from(ae.values()).map(e=>{const n=Array.from(e.skills.values()).sort((g,d)=>d.damage-g.damage),s=n.reduce((g,d)=>(g[d.id]=d,g),{});return{key:e.key,account:e.account,displayName:e.displayName,profession:e.profession,professionList:e.professionList,totalFightMs:e.totalFightMs,skills:n,skillMap:s}}).sort((e,n)=>e.displayName.localeCompare(n.displayName));return{total:f,wins:C,losses:R,avgSquadSize:ht,avgEnemies:Dt,squadKDR:Tt,enemyKDR:St,totalSquadKills:F,totalSquadDeaths:se,totalEnemyKills:j,totalEnemyDeaths:W,leaderboards:z,...Mt,outgoingConditionSummary:Object.values(Z).sort((e,n)=>n.damage-e.damage),incomingConditionSummary:Object.values(ee).sort((e,n)=>n.damage-e.damage),outgoingConditionPlayers:Array.from(M.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,conditions:e.outgoingConditions})),incomingConditionPlayers:Array.from(M.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,conditions:e.incomingConditions})),topSkills:At,topIncomingSkills:Et,playerSkillBreakdowns:qt,topSkillsMetric:X,mapData:vt,timelineData:Nt,boonTables:Bt,offensePlayers:Array.from(M.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,offenseTotals:e.offenseTotals,offenseRateWeights:e.offenseRateWeights,totalFightMs:e.totalFightMs})),defensePlayers:Array.from(M.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,defenseTotals:e.defenseTotals,activeMs:e.defenseActiveMs})),supportPlayers:Array.from(M.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,supportTotals:e.supportTotals,activeMs:e.supportActiveMs})),healingPlayers:Array.from(M.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,healingTotals:e.healingTotals,activeMs:e.healingActiveMs})),mvp:Sn,silver:kn,bronze:wn,squadClassData:It,enemyClassData:Rt,fightBreakdown:yt,specialTables:Ut,topStatsPerSecond:Ee,topStatsLeaderboardsPerSecond:Se,avgMvpScore:Mn}})(),oe=(()=>{const J=new Map,q=new Map,X=[],f=new Map,C=new Map;b.forEach(h=>{const k=h.details;if(!k)return;const se=k.skillMap||{},F=k.fightName||"Log",W=k.uploadTime??h.uploadTime??Date.now(),j={id:h.filePath||h.id||F,label:F,timestamp:W,skillEntries:{},playerActiveSeconds:{},durationSeconds:k.durationMS?k.durationMS/1e3:0};(k.players||[]).forEach(O=>{if(O.notInSquad)return;const M=O.account||O.name||"Unknown",ce=O.profession||"Unknown",_=`${M}|${ce}`;let y=q.get(_);y||(y={key:_,account:M,displayName:M,profession:ce,professionList:[ce],logs:0,totalActiveSeconds:0,skillTotals:{}},q.set(_,y)),y.logs++;const ae=(Array.isArray(O.activeTimes)?O.activeTimes[0]:0)/1e3;y.totalActiveSeconds=(y.totalActiveSeconds||0)+ae,j.playerActiveSeconds[_]=ae,(O.rotation||[]).forEach(Z=>{var Ke,Ge,He;if(!(Z!=null&&Z.id))return;const ee=((Ke=Z.skills)==null?void 0:Ke.length)||0;if(ee<=0)return;const B=`s${Z.id}`,ve=((Ge=se[B])==null?void 0:Ge.name)||`Skill ${Z.id}`,pe=(He=se[B])==null?void 0:He.icon;y.skillTotals[B]=(y.skillTotals[B]||0)+ee,J.set(B,(J.get(B)||0)+ee),f.set(B,ve),pe&&!C.has(B)&&C.set(B,pe),j.skillEntries[B]||(j.skillEntries[B]={name:ve,icon:pe,players:{}}),!j.skillEntries[B].icon&&pe&&(j.skillEntries[B].icon=pe),j.skillEntries[B].players[_]=(j.skillEntries[B].players[_]||0)+ee})}),X.push(j)});const R=Array.from(J.entries()).map(([h,k])=>({id:h,name:f.get(h)||h,total:k,icon:C.get(h)})).sort((h,k)=>k.total-h.total);return{logRecords:X,players:Array.from(q.values()),skillOptions:R,resUtilitySkills:[]}})();return{validLogs:b,stats:E,skillUsageData:oe}};let Te=null,$e=!1,pn=null,bn=0,Cn=0,Xe=null;const hn=t=>{if(!t||typeof t!="object")return t;const o=(c,m)=>{const b={};return m.forEach(P=>{c&&Object.prototype.hasOwnProperty.call(c,P)&&(b[P]=c[P])}),b},i=o(t,["players","targets","durationMS","uploadTime","fightName","success","teamCounts","combatReplayMetaData","skillMap","buffMap","encounterDuration"]);return Array.isArray(i.players)&&(i.players=i.players.map(c=>o(c,["name","display_name","character_name","profession","elite_spec","group","dpsAll","statsAll","dpsTargets","statsTargets","defenses","support","rotation","extHealingStats","extBarrierStats","squadBuffVolumes","selfBuffs","groupBuffs","squadBuffs","selfBuffsActive","groupBuffsActive","squadBuffsActive","buffUptimes","totalDamageDist","targetDamageDist","totalDamageTaken","combatReplayData","hasCommanderTag","notInSquad","account","activeTimes"]))),Array.isArray(i.targets)&&(i.targets=i.targets.map(c=>o(c,["id","name","isFake","dpsAll","statsAll","defenses","totalHealth","healthPercentBurned","enemyPlayer"]))),i},bt=t=>{if(!t||typeof t!="object")return t;const o={...t};return t.details?o.details=hn(t.details):o.details=hn(t),o},Dn=()=>{if(!$e||!Te)return;$e=!1,bn+=1;const t=Xe;Xe=null;const o=pt(Te);self.postMessage({type:"result",result:o,computeId:bn,logCount:Te.logs.length,token:Cn,completedAt:Date.now(),flushId:t})},Ze=()=>{pn===null&&(pn=setInterval(()=>{Dn()},5e3))};self.onmessage=t=>{var i,c,m,b;const o=t.data;if((o==null?void 0:o.type)==="reset"){Te={logs:[]},typeof o.token=="number"&&(Cn=o.token),$e=!0,Ze();return}if((o==null?void 0:o.type)==="settings"){Te={logs:(Te==null?void 0:Te.logs)||[],precomputedStats:(i=o.payload)==null?void 0:i.precomputedStats,mvpWeights:(c=o.payload)==null?void 0:c.mvpWeights,statsViewSettings:(m=o.payload)==null?void 0:m.statsViewSettings,disruptionMethod:(b=o.payload)==null?void 0:b.disruptionMethod},$e=!0,Ze();return}if((o==null?void 0:o.type)==="log"){Te||(Te={logs:[]}),Te.logs.push(bt(o.payload)),$e=!0,Ze();return}(o==null?void 0:o.type)==="flush"&&(typeof o.flushId=="number"&&(Xe=o.flushId),$e=!0,Dn())}})();
