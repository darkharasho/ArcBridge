(function(){"use strict";const zt=["selfBuffs","groupBuffs","squadBuffs"],Kt=o=>o!=null&&o.classification?o.classification==="Boon":!0,Gt=o=>`b${o}`,In=(o,s)=>{const r=Array.isArray(o==null?void 0:o.activeTimes)?o.activeTimes:[],C=typeof r[0]=="number"?r[0]:0;return C>0?C:s},yt=(o,s,r,C,w,v,ne)=>{const I=o==="selfBuffs"?1:Math.max(o==="groupBuffs"?v-1:ne-1,0);return!I||!w?{generationMs:0,wastedMs:0}:s?{generationMs:r*w*I,wastedMs:C*w*I}:{generationMs:r/100*w*I,wastedMs:C/100*w*I}},Pn=o=>{const s=new Map,r=new Map;return o.forEach(v=>{const ne=v.details;if(!ne)return;const I=ne.durationMS||0,oe=ne.buffMap||{};Object.entries(oe).forEach(([S,E])=>{if(!s.has(S)){s.set(S,E);return}const ie=s.get(S)||{},D={name:ie.name||E.name,stacking:ie.stacking??E.stacking,icon:ie.icon||E.icon,classification:ie.classification||E.classification};s.set(S,D)});const qe=(ne.players||[]).filter(S=>!S.notInSquad),ue=qe.length,ce=new Map;qe.forEach(S=>{const E=S.group??0;ce.set(E,(ce.get(E)||0)+1)}),qe.forEach(S=>{const E=S.account||S.name||S.character_name||"Unknown",ie=S.profession||"Unknown",D=S.group??0,W=ce.get(D)||1,j=In(S,I);r.has(E)||r.set(E,{account:E,profession:ie,professions:new Set,professionTimeMs:{},activeTimeMs:0,numFights:0,groupSupported:0,squadSupported:0,boons:{}});const V=r.get(E);V.profession=ie,ie!=="Unknown"&&(V.professions.add(ie),V.professionTimeMs[ie]=(V.professionTimeMs[ie]||0)+j),V.activeTimeMs+=j,V.numFights+=1,V.groupSupported+=W,V.squadSupported+=ue,zt.forEach(de=>{(S[de]||[]).forEach(Q=>{var ve,Pe,we,ye;if(typeof(Q==null?void 0:Q.id)!="number")return;const Be=Gt(Q.id),Me=oe[Be];if(!Kt(Me))return;const ge=(Me==null?void 0:Me.stacking)??!1,Oe=((Pe=(ve=Q.buffData)==null?void 0:ve[0])==null?void 0:Pe.generation)??0,me=((ye=(we=Q.buffData)==null?void 0:we[0])==null?void 0:ye.wasted)??0,{generationMs:pe,wastedMs:_e}=yt(de,ge,Oe,me,I,W,ue);!pe&&!_e||(s.has(Be)||s.set(Be,Me||{}),V.boons[Be]||(V.boons[Be]={selfBuffs:{generationMs:0,wastedMs:0},groupBuffs:{generationMs:0,wastedMs:0},squadBuffs:{generationMs:0,wastedMs:0}}),V.boons[Be][de].generationMs+=pe,V.boons[Be][de].wastedMs+=_e)})})})}),{boonTables:Array.from(s.keys()).filter(v=>Kt(s.get(v))).map(v=>{const ne=s.get(v)||{},I=[];return r.forEach(oe=>{var S;const Ue=oe.boons[v];if(!Ue||!zt.some(E=>Ue[E].generationMs>0||Ue[E].wastedMs>0))return;const ue=Array.from(oe.professions||[]).filter(E=>E&&E!=="Unknown");let ce=oe.profession;if(ue.length>0){ce=ue[0];let E=((S=oe.professionTimeMs)==null?void 0:S[ce])||0;ue.forEach(ie=>{var W;const D=((W=oe.professionTimeMs)==null?void 0:W[ie])||0;D>E&&(E=D,ce=ie)})}I.push({account:oe.account,profession:ce||"Unknown",professionList:ue,activeTimeMs:oe.activeTimeMs||1,numFights:oe.numFights||1,groupSupported:oe.groupSupported||1,squadSupported:oe.squadSupported||1,categories:{selfBuffs:{...Ue.selfBuffs},groupBuffs:{...Ue.groupBuffs},squadBuffs:{...Ue.squadBuffs}}})}),{id:v,name:ne.name||v,icon:ne.icon,stacking:ne.stacking??!1,rows:I}}).filter(v=>v.rows.length>0)}},Jt=(o,s,r,C,w,v,ne={})=>{var S,E,ie,D;const oe=((o==null?void 0:o[s])||[]).find(W=>W.id===r);if(!oe)return{generationMs:0,wastedMs:0};const Ue=ne[Gt(r)],qe=(Ue==null?void 0:Ue.stacking)??!1,ue=((E=(S=oe.buffData)==null?void 0:S[0])==null?void 0:E.generation)??0,ce=((D=(ie=oe.buffData)==null?void 0:ie[0])==null?void 0:D.wasted)??0;return yt(s,qe,ue,ce,C,w,v)};var Un={methods:{tiered:{tiers:{shortMs:500,mediumMs:1500,weights:{short:.5,medium:1,long:2}}}}};const Hn=Un,Pt="count",Ln=o=>(o||0)/1e3,$n=(o,s)=>{var w;if(!o)return 0;const r=(w=Hn.methods.tiered)==null?void 0:w.tiers;if(!r)return o;const C=s/Math.max(o,1);return C<=r.shortMs?o*r.weights.short:C<=r.mediumMs?o*r.weights.medium:o*r.weights.long},Yt=(o,s,r)=>r==="duration"?Ln(s):r==="tiered"?$n(o,s):o;function On(o,s=Pt){var v;const r=(v=o.statsAll)==null?void 0:v[0],C=Number((r==null?void 0:r.appliedCrowdControl)??0),w=Number((r==null?void 0:r.appliedCrowdControlDuration)??0);return Yt(C,w,s)}function _n(o,s){const r=(s==null?void 0:s.durationMS)||0,C=(s==null?void 0:s.buffMap)||{},w=o.filter(I=>!I.notInSquad),v=w.length,ne=new Map;w.forEach(I=>{const oe=I.group??0;ne.set(oe,(ne.get(oe)||0)+1)}),w.forEach(I=>{const oe=ne.get(I.group??0)||1,Ue=Jt(I,"selfBuffs",1122,r,oe,v,C),qe=Jt(I,"squadBuffs",1122,r,oe,v,C);I.stabGeneration=(Ue.generationMs+qe.generationMs)/1e3})}function Rn(o){if(!o.statsTargets)return 0;let s=0;for(const r of o.statsTargets)r&&r.length>0&&(s+=r[0].downContribution||0);return s}function qn(o){if(!o.extBarrierStats||!o.extBarrierStats.outgoingBarrierAllies)return 0;let s=0;for(const r of o.extBarrierStats.outgoingBarrierAllies)if(r)for(const C of r)C&&(s+=C.barrier||0);return s}function xn(o){if(!o.extHealingStats||!o.extHealingStats.outgoingHealingAllies)return 0;let s=0;for(const r of o.extHealingStats.outgoingHealingAllies)if(r)for(const C of r)C&&(s+=C.healing||0);return s}const Wn=o=>{var s,r,C,w;return(((r=(s=o.support)==null?void 0:s[0])==null?void 0:r.condiCleanse)||0)+(((w=(C=o.support)==null?void 0:C[0])==null?void 0:w.condiCleanseSelf)||0)},jn=(o,s=Pt)=>{var v;const r=(v=o.support)==null?void 0:v[0],C=Number((r==null?void 0:r.boonStrips)??0),w=Number((r==null?void 0:r.boonStripsTime)??0);return Yt(C,w,s)},Vn=o=>Rn(o),zn=o=>xn(o),Kn=o=>qn(o),Gn=(o,s=Pt)=>On(o,s),yn=(o,s)=>_n(o,s),Jn="count",Yn={downContribution:1,healing:1,cleanses:1,strips:1,stability:1,cc:.7,revives:.7,distanceToTag:.7,participation:.7,dodging:.4,dps:.2,damage:.2},Qn={showMvp:!0,topSkillDamageSource:"target",topSkillsMetric:"damage"},Qt=new Map([["bleeding","Bleeding"],["burning","Burning"],["confusion","Confusion"],["poison","Poison"],["torment","Torment"],["vulnerability","Vulnerability"],["weakness","Weakness"],["weakened","Weakness"],["blind","Blind"],["blinded","Blind"],["blinding","Blind"],["cripple","Cripple"],["crippled","Cripple"],["chill","Chill"],["chilled","Chill"],["immob","Immobilize"],["immobile","Immobilize"],["immobilized","Immobilize"],["slow","Slow"],["slowed","Slow"],["fear","Fear"],["feared","Fear"],["taunt","Taunt"],["taunted","Taunt"]]),Xn={Blind:"https://render.guildwars2.com/file/09770136BB76FD0DBE1CC4267DEED54774CB20F6/102837.png",Chill:"https://render.guildwars2.com/file/28C4EC547A3516AF0242E826772DA43A5EAC3DF3/102839.png",Cripple:"https://render.guildwars2.com/file/070325E519C178D502A8160523766070D30C0C19/102838.png",Fear:"https://render.guildwars2.com/file/30307A6E766D74B6EB09EDA12A4A2DE50E4D76F4/102869.png",Immobilize:"https://render.guildwars2.com/file/397A613651BFCA2832B6469CE34735580A2C120E/102844.png",Slow:"https://render.guildwars2.com/file/F60D1EF5271D7B9319610855676D320CD25F01C6/961397.png",Taunt:"https://render.guildwars2.com/file/02EED459AD65FAF7DF32A260E479C625070841B9/1228472.png",Vulnerability:"https://render.guildwars2.com/file/3A394C1A0A3257EB27A44842DDEEF0DF000E1241/102850.png",Weakness:"https://render.guildwars2.com/file/6CB0E64AF9AA292E332A38C1770CE577E2CDE0E8/102853.png"},ut=o=>{if(!o)return null;const s=o.trim().toLowerCase(),r=Qt.get(s);if(r)return r;const C=s.split(/[^a-z]+/).filter(Boolean);for(const w of C){const v=Qt.get(w);if(v)return v}return null},Zn=o=>ut(o),Xt=o=>{const s=new Map;return o&&(Object.values(o).forEach(r=>{if(!(r!=null&&r.icon)||!(r!=null&&r.name))return;const C=ut(r.name);C&&(s.has(C)||s.set(C,r.icon))}),Object.entries(Xn).forEach(([r,C])=>{s.has(r)||s.set(r,C)})),s},kt=(o,s,r)=>{var C;if(s&&r){const w=(C=r[`b${s}`])==null?void 0:C.name,v=ut(w);if(v)return v}return o?ut(o):null},eo=o=>{const s=(o==null?void 0:o.account)||"Unknown";return s&&s!=="Unknown"?s:(o==null?void 0:o.name)||"Unknown"||null},to=o=>{if(!o||o.length===0)return 0;let s=0,r=null;return o.forEach(C=>{const w=Number(C[1]??0);if(Number.isFinite(w)){if(r===null){r=w;return}w>r&&(s+=w-r),r=w}}),s},no=o=>{if(!o||o.length===0)return 0;let s=0;return o.forEach(r=>{const C=Number(r[0]??0),w=Number(r[1]??0);Number.isFinite(w)&&C!==0&&w>0&&(s+=1)}),s},oo=o=>{const{players:s,targets:r,skillMap:C,buffMap:w}=o,v=o.getPlayerKey||eo,ne=Xt(w),I={},oe={};s.forEach(S=>{if(S!=null&&S.notInSquad)return;const E=v(S);E&&(I[E]||(I[E]={}),S!=null&&S.totalDamageDist&&S.totalDamageDist.forEach(ie=>{ie&&ie.forEach(D=>{if(!D.id)return;let W=`Skill ${D.id}`,j;C&&(C[`s${D.id}`]?(W=C[`s${D.id}`].name||W,j=C[`s${D.id}`].icon||j):C[`${D.id}`]&&(W=C[`${D.id}`].name||W,j=C[`${D.id}`].icon||j));const V=kt(W,D.id,w);if(!V)return;const de=w==null?void 0:w[`b${D.id}`],$e=de==null?void 0:de.name,Q=ne.get(V)||(de==null?void 0:de.icon),Be=W.startsWith("Skill ")?$e||V:W,Me=j||(de==null?void 0:de.icon),ge=Number(D.connectedHits??0),Oe=Number(D.hits??0),me=ge>0?ge:Oe,pe=Number(D.totalDamage??0);if(!Number.isFinite(me)&&!Number.isFinite(pe))return;const _e=oe[V]||{name:V,icon:Q,applications:0,damage:0};_e.applications+=Number.isFinite(me)?me:0,_e.damage+=Number.isFinite(pe)?pe:0,!_e.icon&&Q&&(_e.icon=Q),oe[V]=_e;const ve=I[E][V]||{icon:Q,applications:0,damage:0,skills:{}};ve.applications+=Number.isFinite(me)?me:0,ve.damage+=Number.isFinite(pe)?pe:0;const Pe=ve.skills[Be]||{name:Be,hits:0,damage:0,icon:Me};Pe.hits+=Number.isFinite(me)?me:0,Pe.damage+=Number.isFinite(pe)?pe:0,!Pe.icon&&Me&&(Pe.icon=Me),ve.skills[Be]=Pe,!ve.icon&&Q&&(ve.icon=Q),I[E][V]=ve})}))});const Ue=new Map;s.forEach(S=>{if(S!=null&&S.notInSquad)return;const E=v(S);E&&S!=null&&S.name&&Ue.set(S.name,E)});let qe=0,ue=0,ce=0;return r.forEach(S=>{S!=null&&S.buffs&&S.buffs.forEach(E=>{const ie=Number(E==null?void 0:E.id);if(!Number.isFinite(ie))return;const D=w==null?void 0:w[`b${ie}`],W=ut(D==null?void 0:D.name);if(!W||D!=null&&D.classification&&D.classification!=="Condition")return;const j=W;if(!j)return;const V=E.statesPerSource||{};ce+=1,Object.entries(V).forEach(([de,$e])=>{var me;const Q=Ue.get(de);if(!Q)return;ue+=1;const Be=to($e),Me=no($e);qe+=Be;const ge=((me=I[Q])==null?void 0:me[j])||{applications:0,damage:0,skills:{}};ge.applicationsFromBuffs=(ge.applicationsFromBuffs||0)+Be,ge.applicationsFromBuffsActive=(ge.applicationsFromBuffsActive||0)+Me,I[Q]=I[Q]||{},I[Q][j]=ge;const Oe=oe[j]||{name:j,applications:0,damage:0};Oe.applicationsFromBuffs=(Oe.applicationsFromBuffs||0)+Be,Oe.applicationsFromBuffsActive=(Oe.applicationsFromBuffsActive||0)+Me,oe[j]=Oe})})}),Object.values(I).forEach(S=>{Object.values(S).forEach(E=>{typeof E.applicationsFromBuffs=="number"&&(E.applications=E.applicationsFromBuffs)})}),Object.values(oe).forEach(S=>{typeof S.applicationsFromBuffs=="number"&&(S.applications=S.applicationsFromBuffs)}),{playerConditions:I,summary:oe,meta:{buffStateApplicationsTotal:qe,targetBuffEntriesSeen:ce,buffStateSourcesSeen:ue}}},io=new Set(["Vulnerability","Weakness","Blind","Cripple","Chill","Immobilize","Slow","Fear","Taunt"]),so=[{id:"damage",label:"Damage",field:"damage",source:"dpsAll"},{id:"directDmg",label:"Direct Damage",field:"directDmg",source:"statsTargets"},{id:"connectedDamageCount",label:"Connected Damage Count",field:"connectedDamageCount",source:"statsTargets"},{id:"connectedDirectDamageCount",label:"Connected Direct Damage Count",field:"connectedDirectDamageCount",source:"statsTargets"},{id:"battleStandardHits",label:"Battle Standard Tracking"},{id:"criticalRate",label:"Critical Rate",field:"criticalRate",isRate:!0,isPercent:!0,denomField:"critableDirectDamageCount",source:"statsTargets"},{id:"criticalDmg",label:"Critical Damage",field:"criticalDmg",source:"statsTargets"},{id:"flankingRate",label:"Flanking Rate",field:"flankingRate",isRate:!0,isPercent:!0,denomField:"connectedDirectDamageCount",source:"statsTargets"},{id:"glanceRate",label:"Glance Rate",field:"glanceRate",isRate:!0,isPercent:!0,denomField:"connectedDirectDamageCount",source:"statsTargets"},{id:"missed",label:"Missed",field:"missed",source:"statsTargets"},{id:"evaded",label:"Evaded (enemy)",field:"evaded",source:"statsTargets"},{id:"blocked",label:"Blocked (enemy)",field:"blocked",source:"statsTargets"},{id:"interrupts",label:"Interrupts",field:"interrupts",source:"statsTargets"},{id:"invulned",label:"Invulned",field:"invulned",source:"statsTargets"},{id:"killed",label:"Killed",field:"killed",source:"statsTargets"},{id:"downed",label:"Downed",field:"downed",source:"statsTargets"},{id:"downContribution",label:"Down Contribution",field:"downContribution",source:"statsTargets"},{id:"downContributionPercent",label:"Down Contribution %",isRate:!0,isPercent:!0},{id:"againstDownedDamage",label:"Against Downed Damage",field:"againstDownedDamage",source:"statsTargets"},{id:"appliedCrowdControl",label:"Applied CC",field:"appliedCrowdControl",source:"statsTargets"},{id:"appliedCrowdControlDuration",label:"Applied CC Duration",field:"appliedCrowdControlDuration",source:"statsTargets"},{id:"appliedCrowdControlDownContribution",label:"Applied CC Down Contribution",field:"appliedCrowdControlDownContribution",source:"statsTargets"},{id:"appliedCrowdControlDurationDownContribution",label:"Applied CC Duration Down Contribution",field:"appliedCrowdControlDurationDownContribution",source:"statsTargets"},{id:"boonStrips",label:"Boon Strips",field:"boonStrips",source:"support"}],ao=[{id:"damageTaken",label:"Damage Taken",field:"damageTaken"},{id:"damageTakenCount",label:"Damage Taken Count",field:"damageTakenCount"},{id:"conditionDamageTaken",label:"Condition Damage Taken",field:"conditionDamageTaken"},{id:"conditionDamageTakenCount",label:"Condition Damage Taken Count",field:"conditionDamageTakenCount"},{id:"powerDamageTaken",label:"Power Damage Taken",field:"powerDamageTaken"},{id:"powerDamageTakenCount",label:"Power Damage Taken Count",field:"powerDamageTakenCount"},{id:"downedDamageTaken",label:"Downed Damage Taken",field:"downedDamageTaken"},{id:"downedDamageTakenCount",label:"Downed Damage Taken Count",field:"downedDamageTakenCount"},{id:"damageBarrier",label:"Damage Barrier",field:"damageBarrier"},{id:"damageBarrierCount",label:"Damage Barrier Count",field:"damageBarrierCount"},{id:"blockedCount",label:"Blocked Count",field:"blockedCount"},{id:"evadedCount",label:"Evaded Count",field:"evadedCount"},{id:"missedCount",label:"Missed Count",field:"missedCount"},{id:"dodgeCount",label:"Dodge Count",field:"dodgeCount"},{id:"invulnedCount",label:"Invulnerable Count",field:"invulnedCount"},{id:"interruptedCount",label:"Interrupted Count",field:"interruptedCount"},{id:"downCount",label:"Down Count",field:"downCount"},{id:"deadCount",label:"Death Count",field:"deadCount"},{id:"boonStrips",label:"Boon Strips (Incoming)",field:"boonStrips"},{id:"conditionCleanses",label:"Cleanses (Incoming)",field:"conditionCleanses"},{id:"receivedCrowdControl",label:"Crowd Control (Incoming)",field:"receivedCrowdControl"}],ro=[{id:"condiCleanse",label:"Condition Cleanses",field:"condiCleanse"},{id:"condiCleanseTime",label:"Condition Cleanse Time",field:"condiCleanseTime",isTime:!0},{id:"condiCleanseSelf",label:"Condition Cleanse Self",field:"condiCleanseSelf"},{id:"condiCleanseTimeSelf",label:"Condition Cleanse Time Self",field:"condiCleanseTimeSelf",isTime:!0},{id:"boonStrips",label:"Boon Strips",field:"boonStrips"},{id:"boonStripsTime",label:"Boon Strips Time",field:"boonStripsTime",isTime:!0},{id:"boonStripDownContribution",label:"Boon Strip Down Contribution",field:"boonStripDownContribution"},{id:"boonStripDownContributionTime",label:"Boon Strip Down Contribution Time",field:"boonStripDownContributionTime",isTime:!0},{id:"stunBreak",label:"Stun Breaks",field:"stunBreak"},{id:"removedStunDuration",label:"Removed Stun Duration",field:"removedStunDuration",isTime:!0},{id:"resurrects",label:"Resurrects",field:"resurrects"},{id:"resurrectTime",label:"Resurrect Time",field:"resurrectTime",isTime:!0}],co=["battle standard","glyph of renewal","glyph of the stars","illusion of life","spirit of nature","nature spirit","search and rescue","signet of mercy"],lo=new Set([10244]),uo=(o,s)=>{var w;if(lo.has(o))return!0;const r=(s==null?void 0:s[`s${o}`])||(s==null?void 0:s[`${o}`]),C=((w=r==null?void 0:r.name)==null?void 0:w.toLowerCase())||"";return co.some(v=>C.includes(v))},mo=o=>{if(!o||!Number.isFinite(o))return"--:--";const s=Math.max(0,Math.round(o/1e3)),r=Math.floor(s/3600),C=Math.floor(s%3600/60),w=s%60;return r>0?`${r}:${String(C).padStart(2,"0")}:${String(w).padStart(2,"0")}`:`${C}:${String(w).padStart(2,"0")}`},Dt={Guardian:"#72C1D9",Dragonhunter:"#72C1D9",Firebrand:"#72C1D9",Willbender:"#72C1D9",Revenant:"#D16E5A",Herald:"#D16E5A",Renegade:"#D16E5A",Vindicator:"#D16E5A",Warrior:"#FFD166",Berserker:"#FFD166",Spellbreaker:"#FFD166",Bladesworn:"#FFD166",Engineer:"#D09C59",Scrapper:"#D09C59",Holosmith:"#D09C59",Mechanist:"#D09C59",Ranger:"#8CDC82",Druid:"#8CDC82",Soulbeast:"#8CDC82",Untamed:"#8CDC82",Thief:"#C08F95",Daredevil:"#C08F95",Deadeye:"#C08F95",Specter:"#C08F95",Elementalist:"#F68A87",Tempest:"#F68A87",Weaver:"#F68A87",Catalyst:"#F68A87",Mesmer:"#B679D5",Chronomancer:"#B679D5",Mirage:"#B679D5",Virtuoso:"#B679D5",Necromancer:"#52A76F",Reaper:"#52A76F",Scourge:"#52A76F",Harbinger:"#52A76F",Ritualist:"#52A76F",Luminary:"#72C1D9",Conduit:"#D16E5A",Paragon:"#FFD166",Amalgam:"#D09C59",Galeshot:"#8CDC82",Antiquary:"#C08F95",Evoker:"#F68A87",Troubadour:"#B679D5",Unknown:"#64748B"};function Zt(o){return Dt[o]||Dt.Unknown}const fo=o=>{if(o==null||o==="")return 0;if(typeof o=="number")return!Number.isFinite(o)||o<=0?0:o>1e12?o:o*1e3;if(o instanceof Date){const ne=o.getTime();return Number.isFinite(ne)&&ne>0?ne:0}const s=String(o).trim();if(!s)return 0;const r=Number(s);if(Number.isFinite(r)&&r>0)return r>1e12?r:r*1e3;const C=Date.parse(s);if(Number.isFinite(C)&&C>0)return C;const w=s.replace(/([+-]\d{2})$/,"$1:00"),v=Date.parse(w);return Number.isFinite(v)&&v>0?v:0},Ze=(o,s)=>fo((o==null?void 0:o.uploadTime)??(s==null?void 0:s.uploadTime)??(o==null?void 0:o.timeStartStd)??(o==null?void 0:o.timeStart)??(o==null?void 0:o.timeEndStd)??(o==null?void 0:o.timeEnd)??(o==null?void 0:o.timeStartText)??(o==null?void 0:o.timeEndText)),go=({logs:o,precomputedStats:s,mvpWeights:r,statsViewSettings:C,disruptionMethod:w})=>{const v=(()=>{const ue=o.filter(ce=>ce.details&&ce.details.players&&ce.details.players.length>0);return console.log("[useStatsAggregation] Filtering logs:",{total:o.length,passed:ue.length,statuses:o.map(ce=>ce.status),hasDetails:o.map(ce=>!!ce.details)}),ue})(),ne=C||Qn,I=r||Yn,oe=ue=>{if(!ue||typeof ue!="object")return ue;const ce=Array.isArray(ue.fightBreakdown)?ue.fightBreakdown:null;if(!ce||ce.length===0)return ue;const S=new Map,E=new Map;o.forEach(D=>{var V;const W=(D==null?void 0:D.filePath)||(D==null?void 0:D.id);W&&S.set(String(W),D);const j=(D==null?void 0:D.permalink)||((V=D==null?void 0:D.details)==null?void 0:V.permalink);typeof j=="string"&&j.trim()&&E.set(j.trim(),D)});const ie=ce.map(D=>{if(!D||typeof D!="object"||Number(D.timestamp)>0)return D;const j=D.id?String(D.id):"",V=typeof D.permalink=="string"?D.permalink.trim():"",de=(j?S.get(j):void 0)||(V?E.get(V):void 0);if(!de)return D;const $e=Ze(de==null?void 0:de.details,de);return $e?{...D,timestamp:$e}:D});return{...ue,fightBreakdown:ie}},Ue=(()=>{if(s)return oe(s);const ue=w||Jn,ce=ne.topSkillDamageSource||"target",S=ne.topSkillsMetric||"damage",E=v.length;let ie=0,D=0,W=0,j=0,V=0,de=0,$e=0,Q=0;const Be=e=>{const n=((e==null?void 0:e.players)||[]).filter(F=>!F.notInSquad);let c=0,a=0,f=0,b=0;return n.forEach(F=>{var T;const k=(T=F.defenses)==null?void 0:T[0];if(!k)return;const d=Number(k.downCount||0),M=Number(k.deadCount||0);c+=d+M,f+=M}),n.forEach(F=>{!F.statsTargets||F.statsTargets.length===0||F.statsTargets.forEach(k=>{const d=k==null?void 0:k[0];if(!d)return;const M=Number(d.downed||0),T=Number(d.killed||0);a+=M+T,b+=T})}),{squadDownsDeaths:c,enemyDownsDeaths:a,squadDeaths:f,enemyDeaths:b}},Me=e=>{const{squadDownsDeaths:t,enemyDownsDeaths:n}=Be(e);return t>0||n>0?n>t:typeof(e==null?void 0:e.success)=="boolean"?e.success:!1},ge=new Map,Oe=new Set(["boonStripsTime","condiCleanseTime","condiCleanseTimeSelf"]),me={},pe={},_e=new Map,ve={},Pe={},we={},ye=new Map,Ke=new Map,St=new Set(Object.keys(Dt)),Tt=Object.keys(Dt).filter(e=>e&&e!=="Unknown").sort((e,t)=>t.length-e.length),At=["Guardian","Revenant","Warrior","Engineer","Ranger","Thief","Elementalist","Mesmer","Necromancer"],rt=e=>{if(!e)return"Unknown";const t=String(e).replace(/\s*\([^)]*\)\s*$/,"").replace(/\s*\[[^\]]*\]\s*$/,"").replace(/\s\d+$/,"").trim();if(St.has(t))return t;const n=t.toLowerCase();for(const a of Tt)if(n.includes(a.toLowerCase()))return a;return At.find(a=>n.includes(a.toLowerCase()))||t||"Unknown"},bo=e=>e!=null&&e.classification?e.classification==="Boon":!0,wt=new Map,Mt=new Map,dt=()=>({totalHits:0,blocked:0,evaded:0,glanced:0,missed:0,invulned:0,interrupted:0,totalMitigation:0,minMitigation:0}),q=e=>{const t=Number(e);return Number.isFinite(t)?t:0},an=e=>{const t=String(e).split("|"),n=t[0]||"Unknown",c=rt(t[1]||"Unknown"),a=t[2]||n||"Unknown";return{name:n,profession:c,account:a}},rn=(e,t,n)=>{let c=e.get(t);return c?n.profession&&!c.professionList.includes(n.profession)&&c.professionList.push(n.profession):(c={account:n.account,name:n.name,profession:n.profession,professionList:n.profession?[n.profession]:[],activeMs:0,mitigationTotals:dt()},e.set(t,c)),c},cn=(e,t,n)=>{let c=e.get(t);return c?n.profession&&!c.professionList.includes(n.profession)&&c.professionList.push(n.profession):(c={account:n.account,name:n.name,profession:n.profession,professionList:n.profession?[n.profession]:[],activeMs:0,mitigationTotals:dt(),minion:n.minion},e.set(t,c)),c},ln=(e,t)=>{e.totalHits+=q((t==null?void 0:t.skill_hits)??(t==null?void 0:t.skillHits)),e.blocked+=q(t==null?void 0:t.blocked),e.evaded+=q(t==null?void 0:t.evaded),e.glanced+=q(t==null?void 0:t.glanced),e.missed+=q(t==null?void 0:t.missed),e.invulned+=q(t==null?void 0:t.invulned),e.interrupted+=q(t==null?void 0:t.interrupted),e.totalMitigation+=q((t==null?void 0:t.avoided_damage)??(t==null?void 0:t.avoidedDamage)),e.minMitigation+=q((t==null?void 0:t.min_avoided_damage)??(t==null?void 0:t.minAvoidedDamage))},ho=e=>Object.values(e).some(t=>t>0);console.log("[useStatsAggregation] Starting aggregation loop",{validLogsCount:v.length});const vt=(e,t,n)=>{var f,b,F,k;const c=`s${e}`;if((f=t==null?void 0:t[c])!=null&&f.name)return t[c].name;if((b=t==null?void 0:t[String(e)])!=null&&b.name)return t[String(e)].name;const a=`b${e}`;return(F=n==null?void 0:n[a])!=null&&F.name?n[a].name:(k=n==null?void 0:n[String(e)])!=null&&k.name?n[String(e)].name:`Unknown Skill ${e}`},mt=new Map,tt=e=>{const t=mt.get(e);if(!t)return{hasSkill:!1,avg:1,min:1,hits:0};const n=t.connectedHits||0,c=n>0?t.totalDamage/n:0,a=t.minCount>0?t.minTotal/t.minCount:0;return{hasSkill:!0,avg:c,min:a,hits:n}},Nt="Ashtonlightstone.9145",un="Illusionary Warden",Lt=[],nt=[],$t=[],Ot=[],dn=new Map,mn=new Map,fn=(e,t,n)=>{const c=e.get(t)||dt();return c.totalHits+=n.totalHits,c.blocked+=n.blocked,c.evaded+=n.evaded,c.glanced+=n.glanced,c.missed+=n.missed,c.invulned+=n.invulned,c.interrupted+=n.interrupted,e.set(t,c),c};v.forEach(e=>{const t=e.details;if(!t)return;(t.targets||[]).forEach(c=>{const a=(c==null?void 0:c.totalDamageDist)||[],f=Array.isArray(a)?a[0]:null;f==null||f.forEach(b=>{if(!(b!=null&&b.id))return;const F=Number(b.id),k=mt.get(F)||{totalDamage:0,connectedHits:0,minTotal:0,minCount:0};k.totalDamage+=Number(b.totalDamage||0),k.connectedHits+=Number(b.connectedHits||0);const d=Number.isFinite(Number(b.min))?Number(b.min):0;k.minTotal+=d,k.minCount+=1,mt.set(F,k)})})}),v.forEach((e,t)=>{var Dn,Sn;const n=e.details;if(!n)return;const c=n.players;console.log(`[useStatsAggregation] Processing log ${t}:`,{playerCount:c==null?void 0:c.length,hasTargets:!!n.targets,firstPlayer:c!=null&&c[0]?{account:c[0].account,notInSquad:c[0].notInSquad}:"none"});const a=n.targets||[],f=n.skillMap||{},b=n.buffMap||{},F=new Map,k=new Map;a.forEach(i=>{const g=(i==null?void 0:i.totalDamageDist)||[],A=Array.isArray(g)?g[0]:null;A==null||A.forEach(O=>{var Z;if(!(O!=null&&O.id))return;const B=Number(O.id),h=((Z=f==null?void 0:f[B])==null?void 0:Z.name)||O.name||O.skillName||String(B),x=F.get(B)||{totalDamage:0,connectedHits:0,minTotal:0,minCount:0};x.totalDamage+=Number(O.totalDamage||0),x.connectedHits+=Number(O.connectedHits||0);const N=Number.isFinite(Number(O.min))?Number(O.min):0;x.minTotal+=N,x.minCount+=1,F.set(B,x);const L=k.get(h)||{totalDamage:0,connectedHits:0,minTotal:0,minCount:0};L.totalDamage+=Number(O.totalDamage||0),L.connectedHits+=Number(O.connectedHits||0);const ke=Number.isFinite(Number(O.min))?Number(O.min):0;L.minTotal+=ke,L.minCount+=1,k.set(h,L)})});const d=i=>{const g=F.get(i);if(!g||g.connectedHits<=0)return{avg:1,min:1};const A=g.connectedHits>0?g.totalDamage/g.connectedHits:0,O=g.minCount>0?g.minTotal/g.minCount:A;return{avg:A||1,min:O||1}},M=i=>{const g=k.get(i);if(!g||g.connectedHits<=0)return{avg:1,min:1};const A=g.connectedHits>0?g.totalDamage/g.connectedHits:0,O=g.minCount>0?g.minTotal/g.minCount:A;return{avg:A||1,min:O||1}},T=n.combatReplayMetaData||{},be=(T==null?void 0:T.inchToPixel)>0?T.inchToPixel:1,he=(T==null?void 0:T.pollingRate)>0?T.pollingRate:1,se=5e3,y=i=>Array.isArray(i)?i.map(g=>Array.isArray(g)?[Number(g[0]),Number(g[1])]:null).filter(g=>!!g&&Number.isFinite(g[0])):[];let He=[],J=n.durationMS||0,Ae=!1;const Ce=c.find(i=>(i==null?void 0:i.hasCommanderTag)&&!(i!=null&&i.notInSquad));(Dn=Ce==null?void 0:Ce.combatReplayData)!=null&&Dn.positions&&(He=Ce.combatReplayData.positions,y(Ce.combatReplayData.dead).forEach(([g])=>{g>0&&(Ae=!0,J=Math.min(J,g))}));const P=i=>{var L;const g=(L=i.statsAll)==null?void 0:L[0];if((g==null?void 0:g.distToCom)!==void 0&&(g==null?void 0:g.distToCom)!=="Infinity")return Math.round(Number(g.distToCom));if((g==null?void 0:g.stackDist)!==void 0)return Math.round(Number(g.stackDist))||0;if(i.hasCommanderTag)return 0;const A=i.combatReplayData;if(!(A!=null&&A.positions)||!He.length)return 0;const O=A.positions,B=y(A.dead),h=y(A.down),x=Math.floor((A.start||0)/he);let N=0;if(B.length&&h.length)for(const[ke]of B){if(ke<0)continue;const Z=Math.max(0,Math.floor(ke/he))-x;for(const[H,ee]of h){if(ke!==ee)continue;const R=Ae&&H>J?Math.max(1,Math.floor(J/he)):Z,fe=Math.max(0,Math.min(R,O.length,He.length));if(fe<=0)continue;let z=0;for(let Se=0;Se<fe;Se++){const[U,le]=O[Se],[re,te]=He[Se];z+=Math.hypot(U-re,le-te)}N=Math.round(z/fe/be)}}return N},ae=c.filter(i=>!i.notInSquad),ot=c.filter(i=>i.notInSquad);W+=ae.length,j+=a.filter(i=>!i.isFake).length,yn(c,{durationMS:n.durationMS,buffMap:n.buffMap});const{squadDeaths:u,enemyDeaths:K}=Be(n);V+=u,de+=K,Q+=u,$e+=K,Me(n)?ie++:D++;const X=n.skillMap?Number((Sn=Object.keys(n.skillMap).find(i=>{var g,A;return((A=(g=n.skillMap)==null?void 0:g[i])==null?void 0:A.name)==="Battle Standard"}))==null?void 0:Sn.replace(/^s/,"")):null;c.forEach((i,g)=>{var Je,Ye,it,st,Bt,ft,gt,Tn,An,wn,Mn,vn;if(i.notInSquad)return;const A=i.account||"Unknown",O=A!=="Unknown"?A:i.name||"Unknown",B=i.name||"Unknown";ge.has(O)||ge.set(O,{name:B,account:O,downContrib:0,cleanses:0,strips:0,stab:0,healing:0,barrier:0,cc:0,logsJoined:0,totalDist:0,distCount:0,dodges:0,downs:0,deaths:0,totalFightMs:0,offenseTotals:{},offenseRateWeights:{},defenseActiveMs:0,defenseTotals:{},supportActiveMs:0,supportTotals:{},healingActiveMs:0,healingTotals:{},profession:i.profession||"Unknown",professions:new Set,professionTimeMs:{},isCommander:!1,damage:0,dps:0,revives:0,outgoingConditions:{},incomingConditions:{}});const h=ge.get(O);if(i.hasCommanderTag&&(h.isCommander=!0),i.profession&&i.profession!=="Unknown"){h.profession=i.profession,h.professions.add(i.profession);const l=Array.isArray(i.activeTimes)&&typeof i.activeTimes[0]=="number"?i.activeTimes[0]:n.durationMS||0;h.professionTimeMs[i.profession]=(h.professionTimeMs[i.profession]||0)+l}h.logsJoined++,h.downContrib+=Vn(i),h.cleanses+=Wn(i),h.strips+=jn(i,ue),h.healing+=zn(i),h.barrier+=Kn(i),h.cc+=Gn(i,ue),h.stab+=i.stabGeneration||0;const x=P(i);x<=se&&(h.totalDist+=x,h.distCount++),(Je=i.defenses)!=null&&Je[0]&&(h.dodges+=i.defenses[0].dodgeCount||0,h.downs+=i.defenses[0].downCount||0,h.deaths+=i.defenses[0].deadCount||0),n.durationMS&&(h.totalFightMs+=n.durationMS);const N=Array.isArray(i.activeTimes)&&typeof i.activeTimes[0]=="number"?i.activeTimes[0]:n.durationMS||0;h.defenseActiveMs+=N,h.supportActiveMs+=N,h.healingActiveMs+=N,Array.isArray(i.buffUptimes)&&i.buffUptimes.length>0&&i.buffUptimes.forEach(l=>{var Nn,En,Fn,Bn;if(typeof(l==null?void 0:l.id)!="number")return;const m=`b${l.id}`,p=((Nn=n.buffMap)==null?void 0:Nn[m])||((En=n.buffMap)==null?void 0:En[String(l.id)]);if(!p||bo(p))return;const $=Number(((Bn=(Fn=l.buffData)==null?void 0:Fn[0])==null?void 0:Bn.uptime)??0);if(!Number.isFinite($)||$<=0)return;const Ee=(p==null?void 0:p.stacking)??!1,We=(Ee?$:$/100)*N;if(!Number.isFinite(We)||We<=0)return;const Ie=Zn(p==null?void 0:p.name);if(Ie&&io.has(Ie)&&(!(p!=null&&p.classification)||p.classification==="Condition")){const It=We/1e3,je=p==null?void 0:p.icon,pt=ve[Ie]||{name:Ie,icon:je,applications:0,damage:0};pt.applicationsFromUptime=(pt.applicationsFromUptime||0)+It,!pt.icon&&je&&(pt.icon=je),ve[Ie]=pt;const bt=h.outgoingConditions[Ie]||{applications:0,damage:0,skills:{},icon:je};bt.applicationsFromUptime=(bt.applicationsFromUptime||0)+It,!bt.icon&&je&&(bt.icon=je),h.outgoingConditions[Ie]=bt;const ht=Pe[Ie]||{name:Ie,icon:je,applications:0,damage:0};ht.applicationsFromUptime=(ht.applicationsFromUptime||0)+It,!ht.icon&&je&&(ht.icon=je),Pe[Ie]=ht;const Ct=h.incomingConditions[Ie]||{applications:0,damage:0,skills:{},icon:je};Ct.applicationsFromUptime=(Ct.applicationsFromUptime||0)+It,!Ct.icon&&je&&(Ct.icon=je),h.incomingConditions[Ie]=Ct}ye.has(m)||ye.set(m,{name:p==null?void 0:p.name,stacking:Ee,icon:p==null?void 0:p.icon}),Ke.has(m)||Ke.set(m,new Map);const et=Ke.get(m),ct=h.account||i.account||i.name||"Unknown";let Xe=et.get(ct);Xe||(Xe={account:ct,profession:h.profession||i.profession||"Unknown",professions:new Set,professionTimeMs:{},totalMs:0,durationMs:0},et.set(ct,Xe));const lt=i.profession||h.profession;lt&&lt!=="Unknown"&&(Xe.professions.add(lt),Xe.professionTimeMs[lt]=(Xe.professionTimeMs[lt]||0)+N,Xe.profession=lt),Xe.totalMs+=We,Xe.durationMs+=N}),(Ye=i.defenses)!=null&&Ye[0]&&ao.forEach(l=>{const m=Number(i.defenses[0][l.field]??0);Number.isFinite(m)&&(h.defenseTotals[l.id]=(h.defenseTotals[l.id]||0)+m)}),(it=i.support)!=null&&it[0]&&ro.forEach(l=>{let m=Number(i.support[0][l.field]??0);Number.isFinite(m)&&(Oe.has(l.field)&&m>999999&&(m=0),h.supportTotals[l.id]=(h.supportTotals[l.id]||0)+m)});const L=(l,m)=>{Number.isFinite(m)&&(h.healingTotals[l]=(h.healingTotals[l]||0)+m)},ke=(l,m)=>Array.isArray(l)?l.reduce((p,$)=>p+Number(($==null?void 0:$[m])??0),0):0,Z=(l,m,p)=>{if(!Number.isFinite(p)||p<=0)return;const $=c[m],Ee=m===g,Qe=$==null?void 0:$.notInSquad,We=!Qe,Ie=We&&($==null?void 0:$.group)!=null&&$.group===i.group;L(l,p),We&&L(`squad${l[0].toUpperCase()}${l.slice(1)}`,p),Ie&&L(`group${l[0].toUpperCase()}${l.slice(1)}`,p),Ee&&L(`self${l[0].toUpperCase()}${l.slice(1)}`,p),Qe&&L(`offSquad${l[0].toUpperCase()}${l.slice(1)}`,p)};if(Array.isArray(i.rotation)){let l=0;i.rotation.forEach(m=>{var $;if(!(m!=null&&m.id)||!uo(m.id,n.skillMap))return;const p=(($=m.skills)==null?void 0:$.length)||0;p>0&&(l+=p,L(`resUtility_s${m.id}`,p))}),l>0&&L("resUtility",l)}const H=(st=i.extHealingStats)==null?void 0:st.outgoingHealingAllies;Array.isArray(H)&&H.forEach((l,m)=>{const p=ke(l,"healing"),$=ke(l,"downedHealing");Z("healing",m,p),Z("downedHealing",m,$)});const ee=(Bt=i.extBarrierStats)==null?void 0:Bt.outgoingBarrierAllies;Array.isArray(ee)&&ee.forEach((l,m)=>{const p=ke(l,"barrier");Z("barrier",m,p)});const R=(ft=i.statsAll)==null?void 0:ft[0],fe=(gt=i.dpsAll)==null?void 0:gt[0],z=(Tn=i.support)==null?void 0:Tn[0];if(so.forEach(l=>{if(l.id==="downContributionPercent"||!l.field)return;let m=0,p=0;l.source==="dpsAll"&&fe?m=Number(fe[l.field]??0):l.source==="statsAll"&&R?(m=Number(R[l.field]??0),p=Number(R[l.denomField||l.weightField||"connectedDamageCount"]??0)):l.source==="support"&&z?m=Number(z[l.field]??0):i.statsTargets&&i.statsTargets.forEach($=>{$!=null&&$[0]&&(m+=Number($[0][l.field]??0),p+=Number($[0][l.denomField||l.weightField||"connectedDamageCount"]??0))}),Number.isFinite(m)&&(h.offenseTotals[l.id]=(h.offenseTotals[l.id]||0)+m,l.isRate&&p>0&&(h.offenseRateWeights[l.id]=(h.offenseRateWeights[l.id]||0)+p))}),i.targetDamageDist&&Number.isFinite(X)){const l=i.targetDamageDist.flatMap(m=>m||[]).flatMap(m=>m||[]).reduce((m,p)=>p!=null&&p.id&&p.id===X?m+((p==null?void 0:p.connectedHits)||0):m,0);h.offenseTotals.battleStandardHits=(h.offenseTotals.battleStandardHits||0)+l}h.revives+=((wn=(An=i.support)==null?void 0:An[0])==null?void 0:wn.resurrects)||0,fe&&(h.damage+=fe.damage||0,h.dps+=fe.dps||0);const Se=l=>{var Ee,Qe,We,Ie;let m=`Skill ${l.id}`;const p=((Ee=n.skillMap)==null?void 0:Ee[`s${l.id}`])||((Qe=n.skillMap)==null?void 0:Qe[`${l.id}`]);let $=p==null?void 0:p.icon;if(p!=null&&p.name&&(m=p.name),m.startsWith("Skill ")){const et=kt(m,l.id,n.buffMap);et&&(m=et,$=((Ie=(We=n.buffMap)==null?void 0:We[`b${l.id}`])==null?void 0:Ie.icon)||$)}return{name:m,icon:$}},U=l=>{if(!(l!=null&&l.id))return;const{name:m,icon:p}=Se(l);me[l.id]||(me[l.id]={name:m,icon:p,damage:0,hits:0,downContribution:0}),me[l.id].name.startsWith("Skill ")&&!m.startsWith("Skill ")&&(me[l.id].name=m),!me[l.id].icon&&p&&(me[l.id].icon=p),me[l.id].damage+=l.totalDamage,me[l.id].hits+=l.connectedHits,me[l.id].downContribution+=Number(l.downContribution||0)},le=i.account||i.name||"Unknown",re=i.profession||"Unknown",te=`${le}|${re}`;let De=_e.get(te);De||(De={key:te,account:le,displayName:le,profession:re,professionList:[re],totalFightMs:0,skills:new Map},_e.set(te,De)),De.professionList.includes(re)||De.professionList.push(re),De.totalFightMs+=n.durationMS||0;const Re=l=>{if(!(l!=null&&l.id))return;const{name:m,icon:p}=Se(l),$=`s${l.id}`;let Ee=De.skills.get($);Ee||(Ee={id:$,name:m,icon:p,damage:0,downContribution:0},De.skills.set($,Ee)),Ee.name.startsWith("Skill ")&&!m.startsWith("Skill ")&&(Ee.name=m),!Ee.icon&&p&&(Ee.icon=p),Ee.damage+=Number(l.totalDamage||0),Ee.downContribution+=Number(l.downContribution||0)};ce==="total"?(Mn=i.totalDamageDist)==null||Mn.forEach(l=>{l==null||l.forEach(m=>{U(m),Re(m)})}):(vn=i.targetDamageDist)==null||vn.forEach(l=>{l==null||l.forEach(m=>{m==null||m.forEach(p=>{U(p),Re(p)})})}),i.totalDamageTaken&&i.totalDamageTaken.forEach(l=>{l==null||l.forEach(m=>{var Qe,We,Ie,et;if(!(m!=null&&m.id))return;let p=`Skill ${m.id}`;const $=((Qe=n.skillMap)==null?void 0:Qe[`s${m.id}`])||((We=n.skillMap)==null?void 0:We[`${m.id}`]);let Ee=$==null?void 0:$.icon;if($!=null&&$.name&&(p=$.name),p.startsWith("Skill ")){const ct=kt(p,m.id,n.buffMap);ct&&(p=ct,Ee=((et=(Ie=n.buffMap)==null?void 0:Ie[`b${m.id}`])==null?void 0:et.icon)||Ee)}pe[m.id]||(pe[m.id]={name:p,icon:Ee,damage:0,hits:0}),(!pe[m.id].name.startsWith("Skill ")||p.startsWith("Skill "))&&(pe[m.id].name=p),!pe[m.id].icon&&Ee&&(pe[m.id].icon=Ee),pe[m.id].damage+=m.totalDamage,pe[m.id].hits+=m.hits})})}),ot.forEach(i=>{const g=rt(i.profession||i.name);g&&(we[g]=(we[g]||0)+1)});const G=oo({players:c,targets:a,skillMap:n.skillMap,buffMap:n.buffMap,getPlayerKey:i=>i.account&&i.account!=="Unknown"?i.account:i.name||null}),Y=Xt(n.buffMap);Object.entries(G.playerConditions).forEach(([i,g])=>{const A=ge.get(i);A&&Object.entries(g).forEach(([O,B])=>{const h=A.outgoingConditions[O]||{applications:0,damage:0,skills:{},icon:B.icon};h.applications+=Number(B.applications||0),h.damage+=Number(B.damage||0),B.applicationsFromBuffs&&(h.applicationsFromBuffs=(h.applicationsFromBuffs||0)+B.applicationsFromBuffs),B.applicationsFromBuffsActive&&(h.applicationsFromBuffsActive=(h.applicationsFromBuffsActive||0)+B.applicationsFromBuffsActive),Object.entries(B.skills||{}).forEach(([x,N])=>{const L=h.skills[x]||{name:N.name,hits:0,damage:0,icon:N.icon};L.hits+=Number(N.hits||0),L.damage+=Number(N.damage||0),!L.icon&&N.icon&&(L.icon=N.icon),h.skills[x]=L}),!h.icon&&B.icon&&(h.icon=B.icon),A.outgoingConditions[O]=h})}),Object.entries(G.summary).forEach(([i,g])=>{const A=ve[i]||{name:g.name||i,icon:g.icon,applications:0,damage:0};A.applications+=Number(g.applications||0),A.damage+=Number(g.damage||0),g.applicationsFromBuffs&&(A.applicationsFromBuffs=(A.applicationsFromBuffs||0)+g.applicationsFromBuffs),g.applicationsFromBuffsActive&&(A.applicationsFromBuffsActive=(A.applicationsFromBuffsActive||0)+g.applicationsFromBuffsActive),!A.icon&&g.icon&&(A.icon=g.icon),ve[i]=A}),ae.forEach(i=>{const g=i.account&&i.account!=="Unknown"?i.account:i.name||"Unknown",A=ge.get(g);!A||!i.totalDamageTaken||i.totalDamageTaken.forEach(O=>O==null?void 0:O.forEach(B=>{var Se,U,le,re,te,De;if(!(B!=null&&B.id))return;let h=`Skill ${B.id}`;const x=((Se=n.skillMap)==null?void 0:Se[`s${B.id}`])||((U=n.skillMap)==null?void 0:U[`${B.id}`]);x!=null&&x.name&&(h=x.name);const N=kt(h,B.id,n.buffMap);if(!N)return;const L=(re=(le=n.buffMap)==null?void 0:le[`b${B.id}`])==null?void 0:re.name,ke=Y.get(N)||((De=(te=n.buffMap)==null?void 0:te[`b${B.id}`])==null?void 0:De.icon),Z=(x==null?void 0:x.icon)||ke;h.startsWith("Skill ")&&(L||N)&&(h=L||N);const H=Number(B.hits??0),ee=Number(B.totalDamage??0),R=Pe[N]||{name:N,icon:ke,applications:0,damage:0};R.applications+=Number.isFinite(H)?H:0,R.damage+=Number.isFinite(ee)?ee:0,!R.icon&&ke&&(R.icon=ke),Pe[N]=R;const fe=A.incomingConditions[N]||{applications:0,damage:0,skills:{},icon:ke};fe.applications+=Number.isFinite(H)?H:0,fe.damage+=Number.isFinite(ee)?ee:0;const z=fe.skills[h]||{name:h,hits:0,damage:0,icon:Z};z.hits+=Number.isFinite(H)?H:0,z.damage+=Number.isFinite(ee)?ee:0,!z.icon&&Z&&(z.icon=Z),fe.skills[h]=z,!fe.icon&&ke&&(fe.icon=ke),A.incomingConditions[N]=fe}))});const Le=n.player_damage_mitigation||n.playerDamageMitigation,Ne=Le&&typeof Le=="object"&&Object.keys(Le).length>0;Ne&&Object.entries(Le).forEach(([i,g])=>{if(!g||typeof g!="object")return;const A=an(i),O=rn(wt,A.account,A);Object.values(g).forEach(B=>{q((B==null?void 0:B.avoided_damage)??(B==null?void 0:B.avoidedDamage))<=0||ln(O.mitigationTotals,B)})});const Ft=n.player_minion_damage_mitigation||n.playerMinionDamageMitigation,Vt=Ft&&typeof Ft=="object"&&Object.keys(Ft).length>0;Vt&&Object.entries(Ft).forEach(([i,g])=>{if(!g||typeof g!="object")return;const A=an(i);Object.entries(g).forEach(([O,B])=>{if(!B||typeof B!="object")return;const h=`${A.account}::${O}`,x=cn(Mt,h,{...A,minion:String(O||"Unknown")});Object.values(B).forEach(N=>{ln(x.mitigationTotals,N)})})}),(!Ne||!Vt)&&(Ne||ae.forEach(i=>{const g=(i==null?void 0:i.totalDamageTaken)||[];if(!Array.isArray(g)||g.length===0)return;const A=i.account||i.name||"Unknown",O={account:A,name:i.name||A,profession:rt(i.profession||"Unknown")};rn(wt,A,O);const B=n.skillMap||{},h=n.buffMap||{},x=Array.isArray(g)?g[0]:null;if(x==null||x.forEach(N=>{if(!(N!=null&&N.id))return;const L=q(N.blocked),ke=q(N.evaded),Z=q(N.glance??N.glanced),H=q(N.missed),ee=q(N.invulned),R=q(N.interrupted),fe=q(N.hits??N.connectedHits),z=Number(N.id),Se=vt(z,B,h);if(fn(dn,`${A}::${z}`,{totalHits:fe,blocked:L,evaded:ke,glanced:Z,missed:H,invulned:ee,interrupted:R}),A===Nt){const U=mt.get(z),le=tt(z),re=le.hasSkill?le.hits>0?le.avg:0:1,te=le.hasSkill?le.min||0:1,De=le.hits>0?Z*re/2+(L+ke+H+ee+R)*re:0,Re=le.hits>0?Z*te/2+(L+ke+H+ee+R)*te:0;$t.push({logId:e.filePath||e.id||t,skillId:N.id,skillName:Se,blocked:L,evaded:ke,glanced:Z,missed:H,invulned:ee,interrupted:R,totalAvoids:L+ke+Z+H+ee+R,avg:re,min:te,enemyHits:(U==null?void 0:U.connectedHits)??0,enemyTotalDmg:(U==null?void 0:U.totalDamage)??0,avoidDmg:De,avoidMinDmg:Re})}}),A===Nt){const N=(L,ke)=>{let Z=0,H=0,ee=0;if(!Array.isArray(L))return{total:Z,minTotal:H,hits:ee};for(const R of L){if(!(R!=null&&R.id))continue;const fe=q(R.blocked),z=q(R.evaded),Se=q(R.glance??R.glanced),U=q(R.missed),le=q(R.invulned),re=q(R.interrupted),te=vt(Number(R.id),f,b),De=ke(Number(R.id),te);(De.hits??0)>0&&(Z+=Se*De.avg/2+(fe+z+U+le+re)*De.avg,H+=Se*De.min/2+(fe+z+U+le+re)*De.min),ee+=q(R.hits??R.connectedHits)}return{total:Z,minTotal:H,hits:ee}};Ot.push({logId:e.filePath||e.id||t,variant:"current_global_name_taken0",...N(x,(L,ke)=>{const Z=tt(L),H=Z.hasSkill?Z.hits>0?Z.avg:0:1,ee=Z.hasSkill?Z.min||0:1;return{avg:H,min:ee,hits:Z.hits}})})}}),Vt||ae.forEach(i=>{const g=(i==null?void 0:i.minions)||[];if(!Array.isArray(g)||g.length===0)return;const A=i.account||i.name||"Unknown",O={account:A,name:i.name||A,profession:rt(i.profession||"Unknown")},B=n.skillMap||{},h=n.buffMap||{};g.forEach(x=>{const N=(x==null?void 0:x.totalDamageTakenDist)||[];if(!Array.isArray(N)||N.length===0)return;let L=String((x==null?void 0:x.name)||"Unknown").replace(/^Juvenile\s+/i,"")||"Unknown";L.toUpperCase().includes("UNKNOWN")&&(L="Unknown");const ke=`${A}::${L}`;cn(Mt,ke,{...O,minion:L});const Z=Array.isArray(N)?N[0]:null;if(Z==null||Z.forEach(H=>{if(!(H!=null&&H.id))return;const ee=q(H.blocked),R=q(H.evaded),fe=q(H.glance??H.glanced),z=q(H.missed),Se=q(H.invulned),U=q(H.interrupted),le=q(H.hits??H.connectedHits),re=Number(H.id),te=vt(re,B,h);if(fn(mn,`${ke}::${re}`,{totalHits:le,blocked:ee,evaded:R,glanced:fe,missed:z,invulned:Se,interrupted:U}),A===Nt&&L===un){const De=mt.get(re),Re=tt(re),Je=Re.hasSkill?Re.hits>0?Re.avg:0:1,Ye=Re.hasSkill?Re.min||0:1,it=Re.hits>0?fe*Je/2+(ee+R+z+Se+U)*Je:0,st=Re.hits>0?fe*Ye/2+(ee+R+z+Se+U)*Ye:0;Lt.push({logId:e.filePath||e.id||t,skillId:H.id,skillName:te,blocked:ee,evaded:R,glanced:fe,missed:z,invulned:Se,interrupted:U,totalAvoids:ee+R+fe+z+Se+U,avg:Je,min:Ye,enemyHits:(De==null?void 0:De.connectedHits)??0,enemyTotalDmg:(De==null?void 0:De.totalDamage)??0,avoidDmg:it,avoidMinDmg:st})}}),A===Nt&&L===un){const H=(z,Se)=>{let U=0,le=0,re=0;if(!Array.isArray(z))return{total:U,minTotal:le,hits:re};for(const te of z){if(!(te!=null&&te.id))continue;const De=q(te.blocked),Re=q(te.evaded),Je=q(te.glance??te.glanced),Ye=q(te.missed),it=q(te.invulned),st=q(te.interrupted),Bt=vt(Number(te.id),f,b),{avg:ft,min:gt}=Se(Number(te.id),Bt);q(te.hits??te.connectedHits)>0&&(U+=Je*ft/2+(De+Re+Ye+it+st)*ft,le+=Je*gt/2+(De+Re+Ye+it+st)*gt),re+=q(te.hits??te.connectedHits)}return{total:U,minTotal:le,hits:re}},ee=Array.isArray(N)?N[0]||[]:[],R=Array.isArray(N)?N.flat():[],fe=Array.isArray(x==null?void 0:x.totalDamageTaken)?x.totalDamageTaken[0]||[]:[];nt.push({logId:e.filePath||e.id||t,variant:"current_global_name_dist0",...H(ee,(z,Se)=>{const U=tt(z),le=U.hasSkill?U.hits>0?U.avg:0:1,re=U.hasSkill&&U.min||0;return{avg:le,min:re}})}),nt.push({logId:e.filePath||e.id||t,variant:"local_name_dist0",...H(ee,(z,Se)=>M(Se))}),nt.push({logId:e.filePath||e.id||t,variant:"local_id_dist0",...H(ee,z=>d(z))}),nt.push({logId:e.filePath||e.id||t,variant:"global_name_alllists",...H(R,(z,Se)=>{const U=tt(z),le=U.hasSkill?U.hits>0?U.avg:0:1,re=U.hasSkill&&U.min||0;return{avg:le,min:re}})}),nt.push({logId:e.filePath||e.id||t,variant:"global_name_taken0",...H(fe,(z,Se)=>{const U=tt(z),le=U.hasSkill?U.hits>0?U.avg:0:1,re=U.hasSkill&&U.min||0;return{avg:le,min:re}})})}})}))}),Lt.length>0&&(console.groupCollapsed("[Mitigation Debug] Ashtonlightstone.9145 / Illusionary Warden"),console.table(Lt),nt.length>0&&console.table(nt),console.groupEnd()),$t.length>0&&(console.groupCollapsed("[Mitigation Debug] Ashtonlightstone.9145 / Player"),console.table($t),Ot.length>0&&console.table(Ot),console.groupEnd());const gn=(e,t)=>{const n=new Map,c=a=>{let f=n.get(a);return f||(f=dt(),n.set(a,f)),f};t.forEach((a,f)=>{const b=f.lastIndexOf("::"),F=b>-1?f.slice(0,b):f,k=b>-1?Number(f.slice(b+2)):Number.NaN,d=Number.isFinite(k)?tt(k):{hasSkill:!1,avg:0,min:0,hits:0};if(!d.hasSkill||d.hits<=0)return;const M=d.avg,T=d.min,be=a.glanced*M/2+(a.blocked+a.evaded+a.missed+a.invulned+a.interrupted)*M,he=a.glanced*T/2+(a.blocked+a.evaded+a.missed+a.invulned+a.interrupted)*T;if(be<=0)return;const se=c(F);se.totalHits+=a.totalHits,se.blocked+=a.blocked,se.evaded+=a.evaded,se.glanced+=a.glanced,se.missed+=a.missed,se.invulned+=a.invulned,se.interrupted+=a.interrupted,se.totalMitigation+=be,se.minMitigation+=he}),e.forEach((a,f)=>{const b=n.get(f)||dt();a.mitigationTotals.totalHits=b.totalHits,a.mitigationTotals.blocked=b.blocked,a.mitigationTotals.evaded=b.evaded,a.mitigationTotals.glanced=b.glanced,a.mitigationTotals.missed=b.missed,a.mitigationTotals.invulned=b.invulned,a.mitigationTotals.interrupted=b.interrupted,a.mitigationTotals.totalMitigation=b.totalMitigation,a.mitigationTotals.minMitigation=b.minMitigation})};gn(wt,dn),gn(Mt,mn);const Co=E>0?Math.round(W/E):0,ko=E>0?Math.round(j/E):0,Do=V>0?(de/V).toFixed(2):de>0?"∞":"0.00",So=$e>0?(Q/$e).toFixed(2):Q>0?"∞":"0.00",pn=(e,t)=>{const c=e.filter(b=>Number.isFinite(b.value)&&(t?b.value>0:b.value>=0)).sort((b,F)=>{const k=t?F.value-b.value:b.value-F.value;return k!==0?k:b.account.localeCompare(F.account)});let a=null,f=0;return c.map((b,F)=>((a===null||b.value!==a)&&(f=F+1,a=b.value),{rank:f,...b}))},_t=Array.from(ge.values()).map(e=>{const t=Array.from(e.professions).filter(n=>n!=="Unknown");if(e.professionList=t,t.length>0){let n=t[0],c=e.professionTimeMs[n]||0;t.forEach(a=>{const f=e.professionTimeMs[a]||0;f>c&&(c=f,n=a)}),e.profession=n}return{key:e.account,stat:e}}),bn=e=>{const t=ge.get(e.account);if(!t){const a=e.professionList.length>0?e.professionList:e.profession?[e.profession]:[];return{...e,professionList:a}}const n=t.professionList&&t.professionList.length>0?t.professionList:Array.from(t.professions||[]).filter(a=>a&&a!=="Unknown"),c=t.profession||e.profession;return{...e,profession:c,professionList:n.length>0?n:c?[c]:[],activeMs:t.defenseActiveMs||t.totalFightMs||e.activeMs}},To=Array.from(wt.values()).map(bn).filter(e=>ho(e.mitigationTotals)).sort((e,t)=>e.account.localeCompare(t.account)),Ao=Array.from(Mt.values()).map(bn).filter(e=>e.mitigationTotals.totalMitigation>0).sort((e,t)=>{const n=e.account.localeCompare(t.account);return n!==0?n:String(e.minion||"").localeCompare(String(t.minion||""))}),Et=(e,t)=>{switch(t){case"downContrib":return e.downContrib;case"barrier":return e.barrier;case"healing":return e.healing;case"dodges":return e.dodges;case"strips":return e.strips;case"cleanses":return e.cleanses;case"cc":return e.cc;case"stability":return e.stab;case"revives":return e.revives;case"dps":return e.dps;case"damage":return e.damage;case"participation":return e.logsJoined;case"closestToTag":return!e.isCommander&&e.distCount>0?e.totalDist/e.distCount:Number.POSITIVE_INFINITY;default:return 0}},xe=(e,t)=>pn(_t.map(({stat:n})=>({account:n.account,profession:n.profession,professionList:n.professionList,value:Et(n,e),count:n.logsJoined})),t),Fe={downContrib:xe("downContrib",!0),barrier:xe("barrier",!0),healing:xe("healing",!0),dodges:xe("dodges",!0),strips:xe("strips",!0),cleanses:xe("cleanses",!0),cc:xe("cc",!0),stability:xe("stability",!0),revives:xe("revives",!0),participation:xe("participation",!0),dps:xe("dps",!0),damage:xe("damage",!0),closestToTag:xe("closestToTag",!1).filter(e=>Number.isFinite(e.value))},wo={downContrib:"downContrib",barrier:"barrier",healing:"healing",dodges:"dodges",strips:"strips",cleanses:"cleanses",cc:"cc",stability:"stability",closestToTag:"closestToTag"},Te=e=>{const t=e==null?void 0:e[0];return{value:(t==null?void 0:t.value)??0,player:(t==null?void 0:t.account)??"-",count:(t==null?void 0:t.count)??0,profession:(t==null?void 0:t.profession)??"Unknown",professionList:(t==null?void 0:t.professionList)??[]}},Ge={maxDownContrib:Te([]),maxBarrier:Te([]),maxHealing:Te([]),maxDodges:Te([]),maxStrips:Te([]),maxCleanses:Te([]),maxCC:Te([]),maxStab:Te([]),closestToTag:Te([])},ze={},Mo=(e,t)=>{if(t==="closestToTag")return Et(e,t);const n=Math.max(1,(e.totalFightMs||0)/1e3);return Et(e,t)/n};Object.values(wo).forEach(e=>{const t=e!=="closestToTag";ze[e]=pn(_t.map(({stat:n})=>({account:n.account,profession:n.profession,professionList:n.professionList,value:Mo(n,e),count:n.logsJoined})),t)}),Ge.maxDownContrib=Te(ze.downContrib),Ge.maxBarrier=Te(ze.barrier),Ge.maxHealing=Te(ze.healing),Ge.maxDodges=Te(ze.dodges),Ge.maxStrips=Te(ze.strips),Ge.maxCleanses=Te(ze.cleanses),Ge.maxCC=Te(ze.cc),Ge.maxStab=Te(ze.stability),Ge.closestToTag=Te(ze.closestToTag);const vo={maxDownContrib:Te(Fe.downContrib),maxBarrier:Te(Fe.barrier),maxHealing:Te(Fe.healing),maxDodges:Te(Fe.dodges),maxStrips:Te(Fe.strips),maxCleanses:Te(Fe.cleanses),maxCC:Te(Fe.cc),maxStab:Te(Fe.stability),closestToTag:Te(Fe.closestToTag)};let Rt={player:"None",account:"None",score:-1,profession:"Unknown",professionList:[],color:"#64748b",topStats:[]},hn,Cn,kn=0;if(ne!=null&&ne.showMvp){const e={"Down Contribution":"downContribution",Healing:"healing",Cleanses:"cleanses",Strips:"strips",Stability:"stability",CC:"cc",Revives:"revives","Distance to Tag":"distanceToTag",Participation:"participation",Dodging:"dodging",DPS:"dps",Damage:"damage"},t=f=>{const b=e[f];return b?Number(I[b]||0)>0:!1},n=[],c=f=>[...f||[]].filter(b=>t(b==null?void 0:b.name)).sort((b,F)=>F.ratio-b.ratio||b.rank-F.rank||b.name.localeCompare(F.name)).slice(0,3),a=f=>{var F;if(!f)return;const b=c(f.contribs);return{...f,player:f.name,reason:((F=b[0])==null?void 0:F.name)||"Top Performance",topStats:b}};_t.forEach(({stat:f})=>{let b=0;const F=[],k=(d,M,T,be,he=!0)=>{var y,He;if(T<=0)return;const se=((y=M[0])==null?void 0:y.value)||0;if(se&&Number.isFinite(d)&&(he?d>0:d<Number.POSITIVE_INFINITY)){const J=he?d/se:se/d;b+=J*T;const Ae=((He=M.find(Ce=>Ce.account===f.account))==null?void 0:He.rank)||0;F.push({name:be,ratio:J,val:d.toLocaleString(),rank:Ae})}};k(f.downContrib,Fe.downContrib,I.downContribution,"Down Contribution"),k(f.healing,Fe.healing,I.healing,"Healing"),k(f.cleanses,Fe.cleanses,I.cleanses,"Cleanses"),k(f.strips,Fe.strips,I.strips,"Strips"),k(f.stab,Fe.stability,I.stability,"Stability"),k(f.cc,Fe.cc,I.cc,"CC"),k(f.revives,Fe.revives,I.revives,"Revives"),k(Et(f,"closestToTag"),Fe.closestToTag,I.distanceToTag,"Distance to Tag",!1),k(f.logsJoined,Fe.participation,I.participation,"Participation"),k(f.dodges,Fe.dodges,I.dodging,"Dodging"),k(f.dps,Fe.dps,I.dps,"DPS"),k(f.damage,Fe.damage,I.damage,"Damage"),n.push({...f,score:b,contribs:F.filter(d=>t(d.name))})}),n.sort((f,b)=>b.score-f.score),n[0]&&n[0].score>0&&(Rt=a(n[0])||Rt),hn=a(n[1]),Cn=a(n[2]),kn=n.length>0?n.reduce((f,b)=>f+b.score,0)/n.length:0}const No=Object.values(me).sort((e,t)=>{const n=S==="downContribution"?e.downContribution:e.damage;return(S==="downContribution"?t.downContribution:t.damage)-n}).slice(0,25),Eo=Object.values(pe).sort((e,t)=>t.damage-e.damage).slice(0,25),Fo=e=>{const t=String(e).replace(/^Detailed\s*WvW\s*-\s*/i,"").replace(/^World\s*vs\s*World\s*-\s*/i,"").replace(/^WvW\s*-\s*/i,"").trim(),n=t.match(/^(Red|Blue|Green)\s+(?:Alpine|Desert)?\s*Borderlands$/i);return n?`${n[1]} Borderlands`:t||"Unknown"},qt=(e,t)=>Fo((e==null?void 0:e.zone)||(e==null?void 0:e.mapName)||(e==null?void 0:e.map)||(e==null?void 0:e.location)||(e==null?void 0:e.fightName)||(t==null?void 0:t.fightName)||(t==null?void 0:t.encounterName)||"Unknown"),Bo=(e,t)=>{const n=(t==null?void 0:t.permalink)||(e==null?void 0:e.permalink);if(typeof n=="string"&&n.trim().length>0)return n.trim();const c=e==null?void 0:e.uploadLinks;if(!Array.isArray(c))return"";for(const a of c){if(typeof a=="string"&&a.trim().length>0)return a.trim();if(a&&typeof a=="object"){const f=a.permalink||a.link||a.url||a.reportLink;if(typeof f=="string"&&f.trim().length>0)return f.trim()}}return""},xt={};v.forEach(e=>{const t=qt(e==null?void 0:e.details,e);xt[t]=(xt[t]||0)+1});const Io=Object.entries(xt).map(([e,t])=>{const n=String(e).trim(),c=/eternal battlegrounds|^ebg$/i.test(n);let a="#64748b";return c?a="#ffffff":/red/i.test(n)?a="#ef4444":/blue/i.test(n)?a="#3b82f6":/green/i.test(n)&&(a="#22c55e"),{name:e,value:t,color:a}}).sort((e,t)=>t.value-e.value),{boonTables:Po}=Pn(v),Uo=v.map((e,t)=>{var c,a;const n=((c=e.details)==null?void 0:c.players)||[];return{index:t+1,label:`Log ${t+1}`,timestamp:Ze(e.details,e),squadCount:n.filter(f=>!f.notInSquad).length,friendlyCount:n.length,enemies:((a=e.details)==null?void 0:a.targets).filter(f=>!f.isFake).length}}).sort((e,t)=>e.timestamp-t.timestamp),Wt={};Array.from(ge.values()).forEach(e=>{e.profession&&e.profession!=="Unknown"&&(Wt[e.profession]=(Wt[e.profession]||0)+1)});const Ho=Object.entries(Wt).map(([e,t])=>({name:e,value:t,color:Zt(e)})).sort((e,t)=>t.value-e.value),jt={};Object.keys(we).length===0&&v.forEach(e=>{var t,n;(n=(t=e.details)==null?void 0:t.targets)==null||n.forEach(c=>{if(c.isFake)return;const a=c.profession&&c.profession!=="Unknown"?c.profession:c.name||c.id||"Unknown",f=rt(a);jt[f]=(jt[f]||0)+1})});const Lo=Object.keys(we).length>0?we:jt,$o=Object.entries(Lo).map(([e,t])=>({name:e,value:t,color:Zt(e)})).sort((e,t)=>t.value-e.value),Oo=v.map((e,t)=>({log:e,originalIndex:t})).sort((e,t)=>Ze(e.log.details,e.log)-Ze(t.log.details,t.log)).map(({log:e},t)=>{const n=e.details;if(!n)return null;const c=n.players||[],a=c.filter(u=>!u.notInSquad),f=c.filter(u=>u.notInSquad),b=n.targets||[],F=b.filter(u=>!u.isFake),k=a.reduce((u,K)=>{var _,X;return u+(((X=(_=K.dpsAll)==null?void 0:_[0])==null?void 0:X.damage)||0)},0),d=a.reduce((u,K)=>{var _,X;return u+(((X=(_=K.defenses)==null?void 0:_[0])==null?void 0:X.damageTaken)||0)},0),{enemyDeaths:M,enemyDownsDeaths:T}=Be(n),be=Me(n),he=Ze(n,e),se=qt(n,e),y={red:0,green:0,blue:0},He=u=>{const K=Number(u);return Number.isFinite(K)?K:0},J=u=>{if(!u||typeof u!="object")return;const K=u.teamID??u.teamId??u.team??u.teamColor??u.team_color;if(K!=null)return K;const _=Object.keys(u).find(X=>/^team/i.test(X));return _?u[_]:void 0},Ae=(u,K)=>{if(u==null)return null;if(typeof u=="string"){const _=u.toLowerCase();return _.includes("red")?"red":_.includes("green")?"green":_.includes("blue")?"blue":_==="r"?"red":_==="g"?"green":_==="b"?"blue":null}if(typeof u=="number")if(K==="zeroBased"){if(u===0)return"red";if(u===1)return"green";if(u===2)return"blue"}else{if(u===1)return"red";if(u===2)return"green";if(u===3)return"blue"}return null},Ce=(u,K)=>{const _={};return u.forEach(X=>{const G=K(X),Y=rt(G);Y&&(_[Y]=(_[Y]||0)+1)}),_},P=Ce(a,u=>(u==null?void 0:u.profession)||(u==null?void 0:u.name)),ae=Ce(f,u=>(u==null?void 0:u.profession)||(u==null?void 0:u.name)),ot=Ce(F,u=>(u==null?void 0:u.profession)||(u==null?void 0:u.name)||(u==null?void 0:u.id));if(n.teamCounts&&typeof n.teamCounts=="object"){const u=n.teamCounts;y.red=He(u.red??u.r??u[0]??u[1]),y.green=He(u.green??u.g??u[1]??u[2]),y.blue=He(u.blue??u.b??u[2]??u[3])}else{const u=[];b.forEach(G=>{if(G!=null&&G.isFake)return;const Y=J(G);Y!=null&&u.push(Y)}),c.forEach(G=>{if(!(G!=null&&G.notInSquad))return;const Y=J(G);Y!=null&&u.push(Y)}),u.length===0&&c.forEach(G=>{const Y=J(G);Y!=null&&u.push(Y)});const K=new Set;u.forEach(G=>{typeof G=="number"&&K.add(G)});const _=K.has(0)?"zeroBased":K.has(3)?"oneBased":"zeroBased";if(u.forEach(G=>{const Y=Ae(G,_);Y&&(y[Y]+=1)}),y.red+y.green+y.blue===0&&u.length>0){const G=new Map;u.forEach(Le=>{const Ne=String(Le);G.set(Ne,(G.get(Ne)||0)+1)});const Y=Array.from(G.values()).sort((Le,Ne)=>Ne-Le);y.red=Y[0]||0,y.green=Y[1]||0,y.blue=Y[2]||0}y.red+y.green+y.blue===0&&(y.red=Math.max(F.length,c.filter(G=>G==null?void 0:G.notInSquad).length))}return{id:e.filePath||`fight-${t}`,label:e.encounterName||`Fight ${t+1}`,permalink:Bo(n,e),timestamp:he,mapName:se,duration:mo(n.durationMS),isWin:be,squadCount:a.length,allyCount:f.length,enemyCount:F.length,teamCounts:y,alliesDown:a.reduce((u,K)=>{var _,X;return u+(((X=(_=K.defenses)==null?void 0:_[0])==null?void 0:X.downCount)||0)},0),alliesDead:a.reduce((u,K)=>{var _,X;return u+(((X=(_=K.defenses)==null?void 0:_[0])==null?void 0:X.deadCount)||0)},0),alliesRevived:a.reduce((u,K)=>{var _,X;return Number(((X=(_=K.statsAll)==null?void 0:_[0])==null?void 0:X.saved)||0)>0?u+1:u},0),rallies:0,enemyDeaths:M,enemyDowns:Math.max(0,T-M),totalOutgoingDamage:k,totalIncomingDamage:d,incomingBarrierAbsorbed:a.reduce((u,K)=>{var _,X;return u+(((X=(_=K.defenses)==null?void 0:_[0])==null?void 0:X.damageBarrier)||0)},0),outgoingBarrierAbsorbed:a.reduce((u,K)=>{var G;const _=(G=K.extBarrierStats)==null?void 0:G.outgoingBarrier;if(!Array.isArray(_))return u;let X=0;return _.forEach(Y=>{if(Array.isArray(Y)){Y.forEach(Le=>{X+=Number((Le==null?void 0:Le.barrier)||0)});return}X+=Number((Y==null?void 0:Y.barrier)||0)}),u+X},0),squadClassCountsFight:P,allyClassCountsFight:ae,enemyClassCounts:ot}}).filter(Boolean),_o=(e,t)=>{const n=(t==null?void 0:t.skillMap)||{},c=(t==null?void 0:t.buffMap)||{};let a=0,f="";const b=k=>{const d=Number(k);if(!Number.isFinite(d))return String(k||"Unknown Skill");const M=(n==null?void 0:n[`s${d}`])||(n==null?void 0:n[`${d}`]);if(M!=null&&M.name)return String(M.name);const T=(c==null?void 0:c[`b${d}`])||(c==null?void 0:c[`${d}`]);return T!=null&&T.name?String(T.name):`Skill ${d}`},F=k=>{if(!k||typeof k!="object")return;const d=[Number(k.max),Number(k.maxDamage),Number(k.maxHit),Number(k.totalDamage)>0&&Number(k.connectedHits)>0?Number(k.totalDamage)/Number(k.connectedHits):0].filter(T=>Number.isFinite(T)),M=d.length>0?Math.max(...d):0;M>a&&(a=M,f=b(k.id))};return Array.isArray(e==null?void 0:e.totalDamageDist)&&e.totalDamageDist.forEach(k=>{Array.isArray(k)&&k.forEach(d=>F(d))}),Array.isArray(e==null?void 0:e.targetDamageDist)&&e.targetDamageDist.forEach(k=>{Array.isArray(k)&&k.forEach(d=>{Array.isArray(d)&&d.forEach(M=>F(M))})}),{peak:a,skillName:f||"Unknown Skill"}},Ro=(()=>{const e=d=>String(d||"").replace(/^Detailed\s*WvW\s*-\s*/i,"").replace(/^World\s*vs\s*World\s*-\s*/i,"").replace(/^WvW\s*-\s*/i,"").trim(),t=d=>e(d).toLowerCase().split(/[^a-z0-9]+/i).map(M=>M.trim()).filter(Boolean).map(M=>M.length>3&&M.endsWith("s")?M.slice(0,-1):M),n=(d,M)=>{const T=e(d),be=e(M);if(!be)return T;if(!T)return be;const he=t(T),se=t(be),y=new Set(he),He=new Set(se),J=se.length>0&&se.every(Ce=>y.has(Ce)),Ae=he.length>0&&he.every(Ce=>He.has(Ce));return J||Ae?T:`${T} - ${be}`},c=[],a=new Map,f=d=>{const M=J=>{if(!Array.isArray(J)||J.length===0)return[];const Ae=[];for(let Ce=0;Ce<J.length;Ce+=1){const P=Number(J[Ce]||0),ae=Ce>0?Number(J[Ce-1]||0):0;Ae.push(Math.max(0,P-ae))}return Ae},T=J=>{if(!Array.isArray(J))return[];const Ae=J.reduce((P,ae)=>Math.max(P,Array.isArray(ae)?ae.length:0),0);if(Ae<=0)return[];const Ce=new Array(Ae).fill(0);return J.forEach(P=>{if(Array.isArray(P))for(let ae=0;ae<Ae;ae+=1)Ce[ae]+=Number(P[ae]||0)}),Ce},be=J=>Array.isArray(J)?J.map(Ae=>Number(Ae||0)):null,se=(J=>{if(!Array.isArray(J)||J.length===0)return null;const Ae=J[0];if(!Array.isArray(Ae))return null;if(Array.isArray(Ae[0])&&Array.isArray(Ae[0][0]))return T(Ae);if(Array.isArray(Ae[0])&&!Array.isArray(Ae[0][0])){const Ce=J.map(P=>be(Array.isArray(P)?P[0]:null)).filter(P=>Array.isArray(P)&&P.length>0);if(Ce.length>0)return T(Ce)}return null})(d==null?void 0:d.targetDamage1S),y=Array.isArray(d==null?void 0:d.damage1S)&&Array.isArray(d.damage1S[0])?d.damage1S[0]:null,He=se||(Array.isArray(y)?y.map(J=>Number(J||0)):[]);return M(He)},b=(d,M)=>{if(!Array.isArray(d)||d.length===0||M<=0)return 0;let T=0,be=0;for(let he=0;he<d.length;he+=1)T+=Number(d[he]||0),he>=M&&(T-=Number(d[he-M]||0)),he>=M-1&&T>be&&(be=T);return Math.max(0,be)},F=(d,M)=>{if(!Array.isArray(d)||d.length===0||M<=0)return[];const T=[];for(let be=0;be<d.length;be+=M){const he=Math.min(be+M,d.length),se=d.slice(be,he).reduce((y,He)=>y+Number(He||0),0);T.push(se)}return T};v.map(d=>({log:d,ts:Ze(d==null?void 0:d.details,d)})).sort((d,M)=>d.ts-M.ts).forEach(({log:d},M)=>{const T=d==null?void 0:d.details;if(!T)return;const be=e(T.fightName||d.fightName||`Fight ${M+1}`),he=qt(T,d),se=n(be,String(he||"")),y={};(Array.isArray(T.players)?T.players:[]).forEach(P=>{if(P!=null&&P.notInSquad)return;const ae=String((P==null?void 0:P.account)||(P==null?void 0:P.name)||"Unknown"),ot=String((P==null?void 0:P.character_name)||(P==null?void 0:P.display_name)||(P==null?void 0:P.name)||""),u=String((P==null?void 0:P.profession)||"Unknown"),K=`${ae}|${u}`,_=_o(P,T),X=Number(_.peak||0),G=f(P),Y=Number(b(G,1)||0),Le=Number(b(G,5)||0);y[K]={hit:X,burst1s:Y,burst5s:Le,skillName:_.skillName,buckets5s:F(G,5)};const Ne=a.get(K)||{key:K,account:ae,displayName:ae,characterName:ot,profession:u,professionList:[u],logs:0,peakHit:0,peak1s:0,peak5s:0,peakFightLabel:"",peakSkillName:""};Ne.logs+=1,Ne.professionList.includes(u)||Ne.professionList.push(u),!Ne.characterName&&ot&&(Ne.characterName=ot),X>Ne.peakHit&&(Ne.peakHit=X,Ne.peakFightLabel=se,Ne.peakSkillName=_.skillName),Y>Ne.peak1s&&(Ne.peak1s=Y),Le>Ne.peak5s&&(Ne.peak5s=Le),a.set(K,Ne)});const J=Object.values(y).reduce((P,ae)=>Math.max(P,Number((ae==null?void 0:ae.hit)||0)),0),Ae=Object.values(y).reduce((P,ae)=>Math.max(P,Number((ae==null?void 0:ae.burst1s)||0)),0),Ce=Object.values(y).reduce((P,ae)=>Math.max(P,Number((ae==null?void 0:ae.burst5s)||0)),0);c.push({id:d.filePath||d.id||`fight-${M+1}`,shortLabel:`F${M+1}`,fullLabel:se,timestamp:Ze(T,d),values:y,maxHit:J,max1s:Ae,max5s:Ce})});const k=Array.from(a.values()).sort((d,M)=>M.peakHit!==d.peakHit?M.peakHit-d.peakHit:d.displayName.localeCompare(M.displayName));return{fights:c,players:k}})(),qo=Array.from(Ke.entries()).map(([e,t])=>{const n=ye.get(e)||{},c=Array.from(t.values()).map(a=>{var M;const f=Array.from(a.professions||[]).filter(T=>T&&T!=="Unknown");let b=a.profession||"Unknown";if(f.length>0){b=f[0];let T=((M=a.professionTimeMs)==null?void 0:M[b])||0;f.forEach(be=>{var se;const he=((se=a.professionTimeMs)==null?void 0:se[be])||0;he>T&&(T=he,b=be)})}const F=a.durationMs||0,k=a.totalMs/1e3,d=F>0?a.totalMs/F:0;return{account:a.account,profession:b,professionList:f,total:k,perSecond:d,duration:F/1e3}}).filter(a=>a.total>0||a.perSecond>0);return{id:e,name:n.name||e,icon:n.icon,rows:c}}).filter(e=>e.rows.length>0),xo=Array.from(_e.values()).map(e=>{const t=Array.from(e.skills.values()).sort((c,a)=>a.damage-c.damage),n=t.reduce((c,a)=>(c[a.id]=a,c),{});return{key:e.key,account:e.account,displayName:e.displayName,profession:e.profession,professionList:e.professionList,totalFightMs:e.totalFightMs,skills:t,skillMap:n}}).sort((e,t)=>e.displayName.localeCompare(t.displayName));return{total:E,wins:ie,losses:D,avgSquadSize:Co,avgEnemies:ko,squadKDR:Do,enemyKDR:So,totalSquadKills:de,totalSquadDeaths:V,totalEnemyKills:Q,totalEnemyDeaths:$e,leaderboards:Fe,...vo,outgoingConditionSummary:Object.values(ve).sort((e,t)=>t.damage-e.damage),incomingConditionSummary:Object.values(Pe).sort((e,t)=>t.damage-e.damage),outgoingConditionPlayers:Array.from(ge.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,conditions:e.outgoingConditions})),incomingConditionPlayers:Array.from(ge.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,conditions:e.incomingConditions})),topSkills:No,topIncomingSkills:Eo,playerSkillBreakdowns:xo,topSkillsMetric:S,mapData:Io,timelineData:Uo,boonTables:Po,offensePlayers:Array.from(ge.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,offenseTotals:e.offenseTotals,offenseRateWeights:e.offenseRateWeights,totalFightMs:e.totalFightMs})),defensePlayers:Array.from(ge.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,defenseTotals:e.defenseTotals,activeMs:e.defenseActiveMs})),damageMitigationPlayers:To,damageMitigationMinions:Ao,supportPlayers:Array.from(ge.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,supportTotals:e.supportTotals,activeMs:e.supportActiveMs})),healingPlayers:Array.from(ge.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,healingTotals:e.healingTotals,activeMs:e.healingActiveMs})),mvp:Rt,silver:hn,bronze:Cn,squadClassData:Ho,enemyClassData:$o,fightBreakdown:Oo,spikeDamage:Ro,specialTables:qo,topStatsPerSecond:Ge,topStatsLeaderboardsPerSecond:ze,avgMvpScore:kn}})(),qe=(()=>{const ue=new Map,ce=new Map,S=[],E=new Map,ie=new Map;v.forEach(W=>{const j=W.details;if(!j)return;const V=j.skillMap||{},de=j.fightName||"Log",$e=Ze(j,W)||Date.now(),Q={id:W.filePath||W.id||de,label:de,timestamp:$e,skillEntries:{},playerActiveSeconds:{},durationSeconds:j.durationMS?j.durationMS/1e3:0};(j.players||[]).forEach(Me=>{if(Me.notInSquad)return;const ge=Me.account||Me.name||"Unknown",Oe=Me.profession||"Unknown",me=`${ge}|${Oe}`;let pe=ce.get(me);pe||(pe={key:me,account:ge,displayName:ge,profession:Oe,professionList:[Oe],logs:0,totalActiveSeconds:0,skillTotals:{}},ce.set(me,pe)),pe.logs++;const _e=(Array.isArray(Me.activeTimes)?Me.activeTimes[0]:0)/1e3;pe.totalActiveSeconds=(pe.totalActiveSeconds||0)+_e,Q.playerActiveSeconds[me]=_e,(Me.rotation||[]).forEach(ve=>{var St,Tt,At;if(!(ve!=null&&ve.id))return;const Pe=((St=ve.skills)==null?void 0:St.length)||0;if(Pe<=0)return;const we=`s${ve.id}`,ye=((Tt=V[we])==null?void 0:Tt.name)||`Skill ${ve.id}`,Ke=(At=V[we])==null?void 0:At.icon;pe.skillTotals[we]=(pe.skillTotals[we]||0)+Pe,ue.set(we,(ue.get(we)||0)+Pe),E.set(we,ye),Ke&&!ie.has(we)&&ie.set(we,Ke),Q.skillEntries[we]||(Q.skillEntries[we]={name:ye,icon:Ke,players:{}}),!Q.skillEntries[we].icon&&Ke&&(Q.skillEntries[we].icon=Ke),Q.skillEntries[we].players[me]=(Q.skillEntries[we].players[me]||0)+Pe})}),S.push(Q)});const D=Array.from(ue.entries()).map(([W,j])=>({id:W,name:E.get(W)||W,total:j,icon:ie.get(W)})).sort((W,j)=>j.total-W.total);return{logRecords:S,players:Array.from(ce.values()),skillOptions:D,resUtilitySkills:[]}})();return{validLogs:v,stats:Ue,skillUsageData:qe}};let Ve=null,at=!1,en=null,tn=0,nn=0,Ut=null;const on=o=>{if(!o||typeof o!="object")return o;const s=(C,w)=>{const v={};return w.forEach(ne=>{C&&Object.prototype.hasOwnProperty.call(C,ne)&&(v[ne]=C[ne])}),v},r=s(o,["players","targets","durationMS","uploadTime","timeStart","timeStartStd","timeEnd","timeEndStd","fightName","success","teamCounts","combatReplayMetaData","skillMap","buffMap","encounterDuration","player_damage_mitigation","player_minion_damage_mitigation","playerDamageMitigation","playerMinionDamageMitigation"]);return Array.isArray(r.players)&&(r.players=r.players.map(C=>s(C,["name","display_name","character_name","profession","elite_spec","group","dpsAll","statsAll","dpsTargets","statsTargets","defenses","support","rotation","extHealingStats","extBarrierStats","squadBuffVolumes","selfBuffs","groupBuffs","squadBuffs","selfBuffsActive","groupBuffsActive","squadBuffsActive","buffUptimes","totalDamageDist","targetDamageDist","damage1S","targetDamage1S","totalDamageTaken","totalDamageTakenDist","minions","combatReplayData","hasCommanderTag","notInSquad","account","activeTimes"]))),Array.isArray(r.targets)&&(r.targets=r.targets.map(C=>s(C,["id","name","isFake","dpsAll","statsAll","defenses","totalHealth","healthPercentBurned","enemyPlayer","totalDamageDist"]))),r},po=o=>{if(!o||typeof o!="object")return o;const s={...o};return o.details?s.details=on(o.details):s.details=on(o),s},sn=()=>{if(!at||!Ve)return;at=!1,tn+=1;const o=Ut;Ut=null;const s=go(Ve);self.postMessage({type:"result",result:s,computeId:tn,logCount:Ve.logs.length,token:nn,completedAt:Date.now(),flushId:o})},Ht=()=>{en===null&&(en=setInterval(()=>{sn()},5e3))};self.onmessage=o=>{var r,C,w,v;const s=o.data;if((s==null?void 0:s.type)==="reset"){Ve={logs:[]},typeof s.token=="number"&&(nn=s.token),at=!0,Ht();return}if((s==null?void 0:s.type)==="settings"){Ve={logs:(Ve==null?void 0:Ve.logs)||[],precomputedStats:(r=s.payload)==null?void 0:r.precomputedStats,mvpWeights:(C=s.payload)==null?void 0:C.mvpWeights,statsViewSettings:(w=s.payload)==null?void 0:w.statsViewSettings,disruptionMethod:(v=s.payload)==null?void 0:v.disruptionMethod},at=!0,Ht();return}if((s==null?void 0:s.type)==="log"){Ve||(Ve={logs:[]}),Ve.logs.push(po(s.payload)),at=!0,Ht();return}(s==null?void 0:s.type)==="flush"&&(typeof s.flushId=="number"&&(Ut=s.flushId),at=!0,sn())}})();
