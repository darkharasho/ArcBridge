(function(){"use strict";const On=["selfBuffs","groupBuffs","squadBuffs"],Rn=o=>o!=null&&o.classification?o.classification==="Boon":!0,qn=o=>`b${o}`,wt=(o,s)=>{const r=Array.isArray(o==null?void 0:o.activeTimes)?o.activeTimes:[],b=typeof r[0]=="number"?r[0]:0;return b>0?b:s},xn=(o,s,r,b,k,S,V)=>{const A=o==="selfBuffs"?1:Math.max(o==="groupBuffs"?S-1:V-1,0);return!A||!k?{generationMs:0,wastedMs:0}:s?{generationMs:r*k*A,wastedMs:b*k*A}:{generationMs:r/100*k*A,wastedMs:b/100*k*A}},Mt=o=>{const s=new Map,r=new Map;return o.forEach(S=>{const V=S.details;if(!V)return;const A=V.durationMS||0,K=V.buffMap||{};Object.entries(K).forEach(([D,w])=>{if(!s.has(D)){s.set(D,w);return}const G=s.get(D)||{},C={name:G.name||w.name,stacking:G.stacking??w.stacking,icon:G.icon||w.icon,classification:G.classification||w.classification};s.set(D,C)});const Ne=(V.players||[]).filter(D=>!D.notInSquad),ne=Ne.length,Y=new Map;Ne.forEach(D=>{const w=D.group??0;Y.set(w,(Y.get(w)||0)+1)}),Ne.forEach(D=>{const w=D.account||D.name||D.character_name||"Unknown",G=D.profession||"Unknown",C=D.group??0,H=Y.get(C)||1,z=wt(D,A);r.has(w)||r.set(w,{account:w,profession:G,professions:new Set,professionTimeMs:{},activeTimeMs:0,numFights:0,groupSupported:0,squadSupported:0,boons:{}});const O=r.get(w);O.profession=G,G!=="Unknown"&&(O.professions.add(G),O.professionTimeMs[G]=(O.professionTimeMs[G]||0)+z),O.activeTimeMs+=z,O.numFights+=1,O.groupSupported+=H,O.squadSupported+=ne,On.forEach(Q=>{(D[Q]||[]).forEach(X=>{var De,Me,pe,Ve;if(typeof(X==null?void 0:X.id)!="number")return;const ke=qn(X.id),ge=K[ke];if(!Rn(ge))return;const ie=(ge==null?void 0:ge.stacking)??!1,Ie=((Me=(De=X.buffData)==null?void 0:De[0])==null?void 0:Me.generation)??0,de=((Ve=(pe=X.buffData)==null?void 0:pe[0])==null?void 0:Ve.wasted)??0,{generationMs:se,wastedMs:Ae}=xn(Q,ie,Ie,de,A,H,ne);!se&&!Ae||(s.has(ke)||s.set(ke,ge||{}),O.boons[ke]||(O.boons[ke]={selfBuffs:{generationMs:0,wastedMs:0},groupBuffs:{generationMs:0,wastedMs:0},squadBuffs:{generationMs:0,wastedMs:0}}),O.boons[ke][Q].generationMs+=se,O.boons[ke][Q].wastedMs+=Ae)})})})}),{boonTables:Array.from(s.keys()).filter(S=>Rn(s.get(S))).map(S=>{const V=s.get(S)||{},A=[];return r.forEach(K=>{var D;const Se=K.boons[S];if(!Se||!On.some(w=>Se[w].generationMs>0||Se[w].wastedMs>0))return;const ne=Array.from(K.professions||[]).filter(w=>w&&w!=="Unknown");let Y=K.profession;if(ne.length>0){Y=ne[0];let w=((D=K.professionTimeMs)==null?void 0:D[Y])||0;ne.forEach(G=>{var H;const C=((H=K.professionTimeMs)==null?void 0:H[G])||0;C>w&&(w=C,Y=G)})}A.push({account:K.account,profession:Y||"Unknown",professionList:ne,activeTimeMs:K.activeTimeMs||1,numFights:K.numFights||1,groupSupported:K.groupSupported||1,squadSupported:K.squadSupported||1,categories:{selfBuffs:{...Se.selfBuffs},groupBuffs:{...Se.groupBuffs},squadBuffs:{...Se.squadBuffs}}})}),{id:S,name:V.name||S,icon:V.icon,stacking:V.stacking??!1,rows:A}}).filter(S=>S.rows.length>0)}},jn=(o,s,r,b,k,S,V={})=>{var D,w,G,C;const K=((o==null?void 0:o[s])||[]).find(H=>H.id===r);if(!K)return{generationMs:0,wastedMs:0};const Se=V[qn(r)],Ne=(Se==null?void 0:Se.stacking)??!1,ne=((w=(D=K.buffData)==null?void 0:D[0])==null?void 0:w.generation)??0,Y=((C=(G=K.buffData)==null?void 0:G[0])==null?void 0:C.wasted)??0;return xn(s,Ne,ne,Y,b,k,S)};var At={methods:{tiered:{tiers:{shortMs:500,mediumMs:1500,weights:{short:.5,medium:1,long:2}}}}};const Et=At,wn="count",Nt=o=>(o||0)/1e3,Ft=(o,s)=>{var k;if(!o)return 0;const r=(k=Et.methods.tiered)==null?void 0:k.tiers;if(!r)return o;const b=s/Math.max(o,1);return b<=r.shortMs?o*r.weights.short:b<=r.mediumMs?o*r.weights.medium:o*r.weights.long},Wn=(o,s,r)=>r==="duration"?Nt(s):r==="tiered"?Ft(o,s):o;function Bt(o,s=wn){var S;const r=(S=o.statsAll)==null?void 0:S[0],b=Number((r==null?void 0:r.appliedCrowdControl)??0),k=Number((r==null?void 0:r.appliedCrowdControlDuration)??0);return Wn(b,k,s)}function It(o,s){const r=(s==null?void 0:s.durationMS)||0,b=(s==null?void 0:s.buffMap)||{},k=o.filter(A=>!A.notInSquad),S=k.length,V=new Map;k.forEach(A=>{const K=A.group??0;V.set(K,(V.get(K)||0)+1)}),k.forEach(A=>{const K=V.get(A.group??0)||1,Se=jn(A,"selfBuffs",1122,r,K,S,b),Ne=jn(A,"squadBuffs",1122,r,K,S,b);A.stabGeneration=(Se.generationMs+Ne.generationMs)/1e3})}function Pt(o){if(!o.statsTargets)return 0;let s=0;for(const r of o.statsTargets)r&&r.length>0&&(s+=r[0].downContribution||0);return s}function Ut(o){if(!o.extBarrierStats||!o.extBarrierStats.outgoingBarrierAllies)return 0;let s=0;for(const r of o.extBarrierStats.outgoingBarrierAllies)if(r)for(const b of r)b&&(s+=b.barrier||0);return s}function Ht(o){if(!o.extHealingStats||!o.extHealingStats.outgoingHealingAllies)return 0;let s=0;for(const r of o.extHealingStats.outgoingHealingAllies)if(r)for(const b of r)b&&(s+=b.healing||0);return s}const Lt=o=>{var s,r,b,k;return(((r=(s=o.support)==null?void 0:s[0])==null?void 0:r.condiCleanse)||0)+(((k=(b=o.support)==null?void 0:b[0])==null?void 0:k.condiCleanseSelf)||0)},_t=(o,s=wn)=>{var S;const r=(S=o.support)==null?void 0:S[0],b=Number((r==null?void 0:r.boonStrips)??0),k=Number((r==null?void 0:r.boonStripsTime)??0);return Wn(b,k,s)},$t=o=>Pt(o),Ot=o=>Ht(o),Rt=o=>Ut(o),qt=(o,s=wn)=>Bt(o,s),xt=(o,s)=>It(o,s),jt="count",Wt={downContribution:1,healing:1,cleanses:1,strips:1,stability:1,cc:.7,revives:.7,distanceToTag:.7,participation:.7,dodging:.4,dps:.2,damage:.2},Vt={showMvp:!0,topSkillDamageSource:"target",topSkillsMetric:"damage"},Vn=new Map([["bleeding","Bleeding"],["burning","Burning"],["confusion","Confusion"],["poison","Poison"],["torment","Torment"],["vulnerability","Vulnerability"],["weakness","Weakness"],["weakened","Weakness"],["blind","Blind"],["blinded","Blind"],["blinding","Blind"],["cripple","Cripple"],["crippled","Cripple"],["chill","Chill"],["chilled","Chill"],["immob","Immobilize"],["immobile","Immobilize"],["immobilized","Immobilize"],["slow","Slow"],["slowed","Slow"],["fear","Fear"],["feared","Fear"],["taunt","Taunt"],["taunted","Taunt"]]),Kt={Blind:"https://render.guildwars2.com/file/09770136BB76FD0DBE1CC4267DEED54774CB20F6/102837.png",Chill:"https://render.guildwars2.com/file/28C4EC547A3516AF0242E826772DA43A5EAC3DF3/102839.png",Cripple:"https://render.guildwars2.com/file/070325E519C178D502A8160523766070D30C0C19/102838.png",Fear:"https://render.guildwars2.com/file/30307A6E766D74B6EB09EDA12A4A2DE50E4D76F4/102869.png",Immobilize:"https://render.guildwars2.com/file/397A613651BFCA2832B6469CE34735580A2C120E/102844.png",Slow:"https://render.guildwars2.com/file/F60D1EF5271D7B9319610855676D320CD25F01C6/961397.png",Taunt:"https://render.guildwars2.com/file/02EED459AD65FAF7DF32A260E479C625070841B9/1228472.png",Vulnerability:"https://render.guildwars2.com/file/3A394C1A0A3257EB27A44842DDEEF0DF000E1241/102850.png",Weakness:"https://render.guildwars2.com/file/6CB0E64AF9AA292E332A38C1770CE577E2CDE0E8/102853.png"},dn=o=>{if(!o)return null;const s=o.trim().toLowerCase(),r=Vn.get(s);if(r)return r;const b=s.split(/[^a-z]+/).filter(Boolean);for(const k of b){const S=Vn.get(k);if(S)return S}return null},Kn=o=>{const s=new Map;return o&&(Object.values(o).forEach(r=>{if(!(r!=null&&r.icon)||!(r!=null&&r.name))return;const b=dn(r.name);b&&(s.has(b)||s.set(b,r.icon))}),Object.entries(Kt).forEach(([r,b])=>{s.has(r)||s.set(r,b)})),s},fn=(o,s,r)=>{var b;if(s&&r){const k=(b=r[`b${s}`])==null?void 0:b.name,S=dn(k);if(S)return S}return o?dn(o):null},Gt=o=>{const s=(o==null?void 0:o.account)||"Unknown";return s&&s!=="Unknown"?s:(o==null?void 0:o.name)||"Unknown"||null},zt=o=>{if(!o||o.length===0)return 0;let s=0,r=null;return o.forEach(b=>{const k=Number(b[1]??0);if(Number.isFinite(k)){if(r===null){r=k;return}k>r&&(s+=k-r),r=k}}),s},Jt=o=>{if(!o||o.length===0)return 0;let s=0;return o.forEach(r=>{const b=Number(r[0]??0),k=Number(r[1]??0);Number.isFinite(k)&&b!==0&&k>0&&(s+=1)}),s},yt=o=>{const{players:s,targets:r,skillMap:b,buffMap:k}=o,S=o.getPlayerKey||Gt,V=Kn(k),A={},K={};s.forEach(D=>{if(D!=null&&D.notInSquad)return;const w=S(D);w&&(A[w]||(A[w]={}),D!=null&&D.totalDamageDist&&D.totalDamageDist.forEach(G=>{G&&G.forEach(C=>{if(!C.id)return;let H=`Skill ${C.id}`,z;b&&(b[`s${C.id}`]?(H=b[`s${C.id}`].name||H,z=b[`s${C.id}`].icon||z):b[`${C.id}`]&&(H=b[`${C.id}`].name||H,z=b[`${C.id}`].icon||z));const O=fn(H,C.id,k);if(!O)return;const Q=k==null?void 0:k[`b${C.id}`],ve=Q==null?void 0:Q.name,X=V.get(O)||(Q==null?void 0:Q.icon),ke=H.startsWith("Skill ")?ve||O:H,ge=z||(Q==null?void 0:Q.icon),ie=Number(C.connectedHits??0),Ie=Number(C.hits??0),de=ie>0?ie:Ie,se=Number(C.totalDamage??0);if(!Number.isFinite(de)&&!Number.isFinite(se))return;const Ae=K[O]||{name:O,icon:X,applications:0,damage:0};Ae.applications+=Number.isFinite(de)?de:0,Ae.damage+=Number.isFinite(se)?se:0,!Ae.icon&&X&&(Ae.icon=X),K[O]=Ae;const De=A[w][O]||{icon:X,applications:0,damage:0,skills:{}};De.applications+=Number.isFinite(de)?de:0,De.damage+=Number.isFinite(se)?se:0;const Me=De.skills[ke]||{name:ke,hits:0,damage:0,icon:ge};Me.hits+=Number.isFinite(de)?de:0,Me.damage+=Number.isFinite(se)?se:0,!Me.icon&&ge&&(Me.icon=ge),De.skills[ke]=Me,!De.icon&&X&&(De.icon=X),A[w][O]=De})}))});const Se=new Map;s.forEach(D=>{if(D!=null&&D.notInSquad)return;const w=S(D);w&&D!=null&&D.name&&Se.set(D.name,w)});let Ne=0,ne=0,Y=0;return r.forEach(D=>{D!=null&&D.buffs&&D.buffs.forEach(w=>{const G=Number(w==null?void 0:w.id);if(!Number.isFinite(G))return;const C=k==null?void 0:k[`b${G}`];if((C==null?void 0:C.classification)!=="Condition")return;const H=(C==null?void 0:C.name)||dn(C==null?void 0:C.name);if(!H)return;const z=w.statesPerSource||{};Y+=1,Object.entries(z).forEach(([O,Q])=>{var Ie;const ve=Se.get(O);if(!ve)return;ne+=1;const X=zt(Q),ke=Jt(Q);Ne+=X;const ge=((Ie=A[ve])==null?void 0:Ie[H])||{applications:0,damage:0,skills:{}};ge.applicationsFromBuffs=(ge.applicationsFromBuffs||0)+X,ge.applicationsFromBuffsActive=(ge.applicationsFromBuffsActive||0)+ke,A[ve]=A[ve]||{},A[ve][H]=ge;const ie=K[H]||{name:H,applications:0,damage:0};ie.applicationsFromBuffs=(ie.applicationsFromBuffs||0)+X,ie.applicationsFromBuffsActive=(ie.applicationsFromBuffsActive||0)+ke,K[H]=ie})})}),Object.values(A).forEach(D=>{Object.values(D).forEach(w=>{typeof w.applicationsFromBuffs=="number"&&(w.applications=w.applicationsFromBuffs)})}),Object.values(K).forEach(D=>{typeof D.applicationsFromBuffs=="number"&&(D.applications=D.applicationsFromBuffs)}),{playerConditions:A,summary:K,meta:{buffStateApplicationsTotal:Ne,targetBuffEntriesSeen:Y,buffStateSourcesSeen:ne}}},Yt=[{id:"damage",label:"Damage",field:"damage",source:"dpsAll"},{id:"directDmg",label:"Direct Damage",field:"directDmg",source:"statsTargets"},{id:"connectedDamageCount",label:"Connected Damage Count",field:"connectedDamageCount",source:"statsTargets"},{id:"connectedDirectDamageCount",label:"Connected Direct Damage Count",field:"connectedDirectDamageCount",source:"statsTargets"},{id:"battleStandardHits",label:"Battle Standard Tracking"},{id:"criticalRate",label:"Critical Rate",field:"criticalRate",isRate:!0,isPercent:!0,denomField:"critableDirectDamageCount",source:"statsTargets"},{id:"criticalDmg",label:"Critical Damage",field:"criticalDmg",source:"statsTargets"},{id:"flankingRate",label:"Flanking Rate",field:"flankingRate",isRate:!0,isPercent:!0,denomField:"connectedDirectDamageCount",source:"statsTargets"},{id:"glanceRate",label:"Glance Rate",field:"glanceRate",isRate:!0,isPercent:!0,denomField:"connectedDirectDamageCount",source:"statsTargets"},{id:"missed",label:"Missed",field:"missed",source:"statsTargets"},{id:"evaded",label:"Evaded (enemy)",field:"evaded",source:"statsTargets"},{id:"blocked",label:"Blocked (enemy)",field:"blocked",source:"statsTargets"},{id:"interrupts",label:"Interrupts",field:"interrupts",source:"statsTargets"},{id:"invulned",label:"Invulned",field:"invulned",source:"statsTargets"},{id:"killed",label:"Killed",field:"killed",source:"statsTargets"},{id:"downed",label:"Downed",field:"downed",source:"statsTargets"},{id:"downContribution",label:"Down Contribution",field:"downContribution",source:"statsTargets"},{id:"downContributionPercent",label:"Down Contribution %",isRate:!0,isPercent:!0},{id:"againstDownedDamage",label:"Against Downed Damage",field:"againstDownedDamage",source:"statsTargets"},{id:"appliedCrowdControl",label:"Applied CC",field:"appliedCrowdControl",source:"statsTargets"},{id:"appliedCrowdControlDuration",label:"Applied CC Duration",field:"appliedCrowdControlDuration",source:"statsTargets"},{id:"appliedCrowdControlDownContribution",label:"Applied CC Down Contribution",field:"appliedCrowdControlDownContribution",source:"statsTargets"},{id:"appliedCrowdControlDurationDownContribution",label:"Applied CC Duration Down Contribution",field:"appliedCrowdControlDurationDownContribution",source:"statsTargets"},{id:"boonStrips",label:"Boon Strips",field:"boonStrips",source:"support"}],Qt=[{id:"damageTaken",label:"Damage Taken",field:"damageTaken"},{id:"damageTakenCount",label:"Damage Taken Count",field:"damageTakenCount"},{id:"conditionDamageTaken",label:"Condition Damage Taken",field:"conditionDamageTaken"},{id:"conditionDamageTakenCount",label:"Condition Damage Taken Count",field:"conditionDamageTakenCount"},{id:"powerDamageTaken",label:"Power Damage Taken",field:"powerDamageTaken"},{id:"powerDamageTakenCount",label:"Power Damage Taken Count",field:"powerDamageTakenCount"},{id:"downedDamageTaken",label:"Downed Damage Taken",field:"downedDamageTaken"},{id:"downedDamageTakenCount",label:"Downed Damage Taken Count",field:"downedDamageTakenCount"},{id:"damageBarrier",label:"Damage Barrier",field:"damageBarrier"},{id:"damageBarrierCount",label:"Damage Barrier Count",field:"damageBarrierCount"},{id:"blockedCount",label:"Blocked Count",field:"blockedCount"},{id:"evadedCount",label:"Evaded Count",field:"evadedCount"},{id:"missedCount",label:"Missed Count",field:"missedCount"},{id:"dodgeCount",label:"Dodge Count",field:"dodgeCount"},{id:"invulnedCount",label:"Invulnerable Count",field:"invulnedCount"},{id:"interruptedCount",label:"Interrupted Count",field:"interruptedCount"},{id:"downCount",label:"Down Count",field:"downCount"},{id:"deadCount",label:"Death Count",field:"deadCount"},{id:"boonStrips",label:"Boon Strips (Incoming)",field:"boonStrips"},{id:"conditionCleanses",label:"Cleanses (Incoming)",field:"conditionCleanses"},{id:"receivedCrowdControl",label:"Crowd Control (Incoming)",field:"receivedCrowdControl"}],Xt=[{id:"condiCleanse",label:"Condition Cleanses",field:"condiCleanse"},{id:"condiCleanseTime",label:"Condition Cleanse Time",field:"condiCleanseTime",isTime:!0},{id:"condiCleanseSelf",label:"Condition Cleanse Self",field:"condiCleanseSelf"},{id:"condiCleanseTimeSelf",label:"Condition Cleanse Time Self",field:"condiCleanseTimeSelf",isTime:!0},{id:"boonStrips",label:"Boon Strips",field:"boonStrips"},{id:"boonStripsTime",label:"Boon Strips Time",field:"boonStripsTime",isTime:!0},{id:"boonStripDownContribution",label:"Boon Strip Down Contribution",field:"boonStripDownContribution"},{id:"boonStripDownContributionTime",label:"Boon Strip Down Contribution Time",field:"boonStripDownContributionTime",isTime:!0},{id:"stunBreak",label:"Stun Breaks",field:"stunBreak"},{id:"removedStunDuration",label:"Removed Stun Duration",field:"removedStunDuration",isTime:!0},{id:"resurrects",label:"Resurrects",field:"resurrects"},{id:"resurrectTime",label:"Resurrect Time",field:"resurrectTime",isTime:!0}],Zt=["battle standard","glyph of renewal","glyph of the stars","illusion of life","spirit of nature","nature spirit","search and rescue","signet of mercy"],eo=new Set([10244]),no=(o,s)=>{var k;if(eo.has(o))return!0;const r=(s==null?void 0:s[`s${o}`])||(s==null?void 0:s[`${o}`]),b=((k=r==null?void 0:r.name)==null?void 0:k.toLowerCase())||"";return Zt.some(S=>b.includes(S))},to=o=>{if(!o||!Number.isFinite(o))return"--:--";const s=Math.max(0,Math.round(o/1e3)),r=Math.floor(s/3600),b=Math.floor(s%3600/60),k=s%60;return r>0?`${r}:${String(b).padStart(2,"0")}:${String(k).padStart(2,"0")}`:`${b}:${String(k).padStart(2,"0")}`},mn={Guardian:"#72C1D9",Dragonhunter:"#72C1D9",Firebrand:"#72C1D9",Willbender:"#72C1D9",Revenant:"#D16E5A",Herald:"#D16E5A",Renegade:"#D16E5A",Vindicator:"#D16E5A",Warrior:"#FFD166",Berserker:"#FFD166",Spellbreaker:"#FFD166",Bladesworn:"#FFD166",Engineer:"#D09C59",Scrapper:"#D09C59",Holosmith:"#D09C59",Mechanist:"#D09C59",Ranger:"#8CDC82",Druid:"#8CDC82",Soulbeast:"#8CDC82",Untamed:"#8CDC82",Thief:"#C08F95",Daredevil:"#C08F95",Deadeye:"#C08F95",Specter:"#C08F95",Elementalist:"#F68A87",Tempest:"#F68A87",Weaver:"#F68A87",Catalyst:"#F68A87",Mesmer:"#B679D5",Chronomancer:"#B679D5",Mirage:"#B679D5",Virtuoso:"#B679D5",Necromancer:"#52A76F",Reaper:"#52A76F",Scourge:"#52A76F",Harbinger:"#52A76F",Ritualist:"#52A76F",Luminary:"#72C1D9",Conduit:"#D16E5A",Paragon:"#FFD166",Amalgam:"#D09C59",Galeshot:"#8CDC82",Antiquary:"#C08F95",Evoker:"#F68A87",Troubadour:"#B679D5",Unknown:"#64748B"};function Gn(o){return mn[o]||mn.Unknown}const oo=o=>{if(o==null||o==="")return 0;if(typeof o=="number")return!Number.isFinite(o)||o<=0?0:o>1e12?o:o*1e3;if(o instanceof Date){const V=o.getTime();return Number.isFinite(V)&&V>0?V:0}const s=String(o).trim();if(!s)return 0;const r=Number(s);if(Number.isFinite(r)&&r>0)return r>1e12?r:r*1e3;const b=Date.parse(s);if(Number.isFinite(b)&&b>0)return b;const k=s.replace(/([+-]\d{2})$/,"$1:00"),S=Date.parse(k);return Number.isFinite(S)&&S>0?S:0},en=(o,s)=>oo((o==null?void 0:o.uploadTime)??(s==null?void 0:s.uploadTime)??(o==null?void 0:o.timeStartStd)??(o==null?void 0:o.timeStart)??(o==null?void 0:o.timeEndStd)??(o==null?void 0:o.timeEnd)??(o==null?void 0:o.timeStartText)??(o==null?void 0:o.timeEndText)),io=({logs:o,precomputedStats:s,mvpWeights:r,statsViewSettings:b,disruptionMethod:k})=>{const S=(()=>{const ne=o.filter(Y=>Y.details&&Y.details.players&&Y.details.players.length>0);return console.log("[useStatsAggregation] Filtering logs:",{total:o.length,passed:ne.length,statuses:o.map(Y=>Y.status),hasDetails:o.map(Y=>!!Y.details)}),ne})(),V=b||Vt,A=r||Wt,K=ne=>{if(!ne||typeof ne!="object")return ne;const Y=Array.isArray(ne.fightBreakdown)?ne.fightBreakdown:null;if(!Y||Y.length===0)return ne;const D=new Map,w=new Map;o.forEach(C=>{var O;const H=(C==null?void 0:C.filePath)||(C==null?void 0:C.id);H&&D.set(String(H),C);const z=(C==null?void 0:C.permalink)||((O=C==null?void 0:C.details)==null?void 0:O.permalink);typeof z=="string"&&z.trim()&&w.set(z.trim(),C)});const G=Y.map(C=>{if(!C||typeof C!="object"||Number(C.timestamp)>0)return C;const z=C.id?String(C.id):"",O=typeof C.permalink=="string"?C.permalink.trim():"",Q=(z?D.get(z):void 0)||(O?w.get(O):void 0);if(!Q)return C;const ve=en(Q==null?void 0:Q.details,Q);return ve?{...C,timestamp:ve}:C});return{...ne,fightBreakdown:G}},Se=(()=>{if(s)return K(s);const ne=k||jt,Y=V.topSkillDamageSource||"target",D=V.topSkillsMetric||"damage",w=S.length;let G=0,C=0,H=0,z=0,O=0,Q=0,ve=0,X=0;const ke=e=>{const t=((e==null?void 0:e.players)||[]).filter(F=>!F.notInSquad);let l=0,a=0,m=0,g=0;return t.forEach(F=>{var le;const B=(le=F.defenses)==null?void 0:le[0];if(!B)return;const me=Number(B.downCount||0),we=Number(B.deadCount||0);l+=me+we,m+=we}),t.forEach(F=>{!F.statsTargets||F.statsTargets.length===0||F.statsTargets.forEach(B=>{const me=B==null?void 0:B[0];if(!me)return;const we=Number(me.downed||0),le=Number(me.killed||0);a+=we+le,g+=le})}),{squadDownsDeaths:l,enemyDownsDeaths:a,squadDeaths:m,enemyDeaths:g}},ge=e=>{const{squadDownsDeaths:n,enemyDownsDeaths:t}=ke(e);return n>0||t>0?t>n:typeof(e==null?void 0:e.success)=="boolean"?e.success:!1},ie=new Map,Ie=new Set(["boonStripsTime","condiCleanseTime","condiCleanseTimeSelf"]),de={},se={},Ae=new Map,De={},Me={},pe={},Ve=new Map,xe=new Map,gn=new Set(Object.keys(mn)),pn=Object.keys(mn).filter(e=>e&&e!=="Unknown").sort((e,n)=>n.length-e.length),bn=["Guardian","Revenant","Warrior","Engineer","Ranger","Thief","Elementalist","Mesmer","Necromancer"],tn=e=>{if(!e)return"Unknown";const n=String(e).replace(/\s*\([^)]*\)\s*$/,"").replace(/\s*\[[^\]]*\]\s*$/,"").replace(/\s\d+$/,"").trim();if(gn.has(n))return n;const t=n.toLowerCase();for(const a of pn)if(t.includes(a.toLowerCase()))return a;return bn.find(a=>t.includes(a.toLowerCase()))||n||"Unknown"},ao=e=>e!=null&&e.classification?e.classification==="Boon":!0,hn=new Map,Cn=new Map,rn=()=>({totalHits:0,blocked:0,evaded:0,glanced:0,missed:0,invulned:0,interrupted:0,totalMitigation:0,minMitigation:0}),_=e=>{const n=Number(e);return Number.isFinite(n)?n:0},Xn=e=>{const n=String(e).split("|"),t=n[0]||"Unknown",l=tn(n[1]||"Unknown"),a=n[2]||t||"Unknown";return{name:t,profession:l,account:a}},Zn=(e,n,t)=>{let l=e.get(n);return l?t.profession&&!l.professionList.includes(t.profession)&&l.professionList.push(t.profession):(l={account:t.account,name:t.name,profession:t.profession,professionList:t.profession?[t.profession]:[],activeMs:0,mitigationTotals:rn()},e.set(n,l)),l},et=(e,n,t)=>{let l=e.get(n);return l?t.profession&&!l.professionList.includes(t.profession)&&l.professionList.push(t.profession):(l={account:t.account,name:t.name,profession:t.profession,professionList:t.profession?[t.profession]:[],activeMs:0,mitigationTotals:rn(),minion:t.minion},e.set(n,l)),l},nt=(e,n)=>{e.totalHits+=_((n==null?void 0:n.skill_hits)??(n==null?void 0:n.skillHits)),e.blocked+=_(n==null?void 0:n.blocked),e.evaded+=_(n==null?void 0:n.evaded),e.glanced+=_(n==null?void 0:n.glanced),e.missed+=_(n==null?void 0:n.missed),e.invulned+=_(n==null?void 0:n.invulned),e.interrupted+=_(n==null?void 0:n.interrupted),e.totalMitigation+=_((n==null?void 0:n.avoided_damage)??(n==null?void 0:n.avoidedDamage)),e.minMitigation+=_((n==null?void 0:n.min_avoided_damage)??(n==null?void 0:n.minAvoidedDamage))},ro=e=>Object.values(e).some(n=>n>0);console.log("[useStatsAggregation] Starting aggregation loop",{validLogsCount:S.length});const Dn=(e,n,t)=>{var m,g,F,B;const l=`s${e}`;if((m=n==null?void 0:n[l])!=null&&m.name)return n[l].name;if((g=n==null?void 0:n[String(e)])!=null&&g.name)return n[String(e)].name;const a=`b${e}`;return(F=t==null?void 0:t[a])!=null&&F.name?t[a].name:(B=t==null?void 0:t[String(e)])!=null&&B.name?t[String(e)].name:`Unknown Skill ${e}`},cn=new Map,Ye=e=>{const n=cn.get(e);if(!n)return{hasSkill:!1,avg:1,min:1,hits:0};const t=n.connectedHits||0,l=t>0?n.totalDamage/t:0,a=n.minCount>0?n.minTotal/n.minCount:0;return{hasSkill:!0,avg:l,min:a,hits:t}},Tn="Ashtonlightstone.9145",tt="Illusionary Warden",En=[],Qe=[],Nn=[],Fn=[],ot=new Map,it=new Map,st=(e,n,t)=>{const l=e.get(n)||rn();return l.totalHits+=t.totalHits,l.blocked+=t.blocked,l.evaded+=t.evaded,l.glanced+=t.glanced,l.missed+=t.missed,l.invulned+=t.invulned,l.interrupted+=t.interrupted,e.set(n,l),l};S.forEach(e=>{const n=e.details;if(!n)return;(n.targets||[]).forEach(l=>{const a=(l==null?void 0:l.totalDamageDist)||[],m=Array.isArray(a)?a[0]:null;m==null||m.forEach(g=>{if(!(g!=null&&g.id))return;const F=Number(g.id),B=cn.get(F)||{totalDamage:0,connectedHits:0,minTotal:0,minCount:0};B.totalDamage+=Number(g.totalDamage||0),B.connectedHits+=Number(g.connectedHits||0);const me=Number.isFinite(Number(g.min))?Number(g.min):0;B.minTotal+=me,B.minCount+=1,cn.set(F,B)})})}),S.forEach((e,n)=>{var mt,gt;const t=e.details;if(!t)return;const l=t.players;console.log(`[useStatsAggregation] Processing log ${n}:`,{playerCount:l==null?void 0:l.length,hasTargets:!!t.targets,firstPlayer:l!=null&&l[0]?{account:l[0].account,notInSquad:l[0].notInSquad}:"none"});const a=t.targets||[],m=t.skillMap||{},g=t.buffMap||{},F=new Map,B=new Map;a.forEach(i=>{const f=(i==null?void 0:i.totalDamageDist)||[],T=Array.isArray(f)?f[0]:null;T==null||T.forEach(U=>{var x;if(!(U!=null&&U.id))return;const M=Number(U.id),p=((x=m==null?void 0:m[M])==null?void 0:x.name)||U.name||U.skillName||String(M),$=F.get(M)||{totalDamage:0,connectedHits:0,minTotal:0,minCount:0};$.totalDamage+=Number(U.totalDamage||0),$.connectedHits+=Number(U.connectedHits||0);const v=Number.isFinite(Number(U.min))?Number(U.min):0;$.minTotal+=v,$.minCount+=1,F.set(M,$);const I=B.get(p)||{totalDamage:0,connectedHits:0,minTotal:0,minCount:0};I.totalDamage+=Number(U.totalDamage||0),I.connectedHits+=Number(U.connectedHits||0);const re=Number.isFinite(Number(U.min))?Number(U.min):0;I.minTotal+=re,I.minCount+=1,B.set(p,I)})});const me=i=>{const f=F.get(i);if(!f||f.connectedHits<=0)return{avg:1,min:1};const T=f.connectedHits>0?f.totalDamage/f.connectedHits:0,U=f.minCount>0?f.minTotal/f.minCount:T;return{avg:T||1,min:U||1}},we=i=>{const f=B.get(i);if(!f||f.connectedHits<=0)return{avg:1,min:1};const T=f.connectedHits>0?f.totalDamage/f.connectedHits:0,U=f.minCount>0?f.minTotal/f.minCount:T;return{avg:T||1,min:U||1}},le=t.combatReplayMetaData||{},$e=(le==null?void 0:le.inchToPixel)>0?le.inchToPixel:1,Be=(le==null?void 0:le.pollingRate)>0?le.pollingRate:1,Te=5e3,Ce=i=>Array.isArray(i)?i.map(f=>Array.isArray(f)?[Number(f[0]),Number(f[1])]:null).filter(f=>!!f&&Number.isFinite(f[0])):[];let Oe=[],Re=t.durationMS||0,on=!1;const qe=l.find(i=>(i==null?void 0:i.hasCommanderTag)&&!(i!=null&&i.notInSquad));(mt=qe==null?void 0:qe.combatReplayData)!=null&&mt.positions&&(Oe=qe.combatReplayData.positions,Ce(qe.combatReplayData.dead).forEach(([f])=>{f>0&&(on=!0,Re=Math.min(Re,f))}));const Ln=i=>{var I;const f=(I=i.statsAll)==null?void 0:I[0];if((f==null?void 0:f.distToCom)!==void 0&&(f==null?void 0:f.distToCom)!=="Infinity")return Math.round(Number(f.distToCom));if((f==null?void 0:f.stackDist)!==void 0)return Math.round(Number(f.stackDist))||0;if(i.hasCommanderTag)return 0;const T=i.combatReplayData;if(!(T!=null&&T.positions)||!Oe.length)return 0;const U=T.positions,M=Ce(T.dead),p=Ce(T.down),$=Math.floor((T.start||0)/Be);let v=0;if(M.length&&p.length)for(const[re]of M){if(re<0)continue;const x=Math.max(0,Math.floor(re/Be))-$;for(const[N,j]of p){if(re!==j)continue;const L=on&&N>Re?Math.max(1,Math.floor(Re/Be)):x,oe=Math.max(0,Math.min(L,U.length,Oe.length));if(oe<=0)continue;let q=0;for(let ue=0;ue<oe;ue++){const[E,ee]=U[ue],[y,W]=Oe[ue];q+=Math.hypot(E-y,ee-W)}v=Math.round(q/oe/$e)}}return v},sn=l.filter(i=>!i.notInSquad),_n=l.filter(i=>i.notInSquad);H+=sn.length,z+=a.filter(i=>!i.isFake).length,xt(l,{durationMS:t.durationMS,buffMap:t.buffMap});const{squadDeaths:u,enemyDeaths:Z}=ke(t);O+=u,Q+=Z,X+=u,ve+=Z,ge(t)?G++:C++;const ae=t.skillMap?Number((gt=Object.keys(t.skillMap).find(i=>{var f,T;return((T=(f=t.skillMap)==null?void 0:f[i])==null?void 0:T.name)==="Battle Standard"}))==null?void 0:gt.replace(/^s/,"")):null;l.forEach((i,f)=>{var Ke,Ge,Xe,Ze,vn,ln,un,pt,bt,ht,Ct,Dt;if(i.notInSquad)return;const T=i.account||"Unknown",U=T!=="Unknown"?T:i.name||"Unknown",M=i.name||"Unknown";ie.has(U)||ie.set(U,{name:M,account:U,downContrib:0,cleanses:0,strips:0,stab:0,healing:0,barrier:0,cc:0,logsJoined:0,totalDist:0,distCount:0,dodges:0,downs:0,deaths:0,totalFightMs:0,offenseTotals:{},offenseRateWeights:{},defenseActiveMs:0,defenseTotals:{},supportActiveMs:0,supportTotals:{},healingActiveMs:0,healingTotals:{},profession:i.profession||"Unknown",professions:new Set,professionTimeMs:{},isCommander:!1,damage:0,dps:0,revives:0,outgoingConditions:{},incomingConditions:{}});const p=ie.get(U);if(i.hasCommanderTag&&(p.isCommander=!0),i.profession&&i.profession!=="Unknown"){p.profession=i.profession,p.professions.add(i.profession);const c=Array.isArray(i.activeTimes)&&typeof i.activeTimes[0]=="number"?i.activeTimes[0]:t.durationMS||0;p.professionTimeMs[i.profession]=(p.professionTimeMs[i.profession]||0)+c}p.logsJoined++,p.downContrib+=$t(i),p.cleanses+=Lt(i),p.strips+=_t(i,ne),p.healing+=Ot(i),p.barrier+=Rt(i),p.cc+=qt(i,ne),p.stab+=i.stabGeneration||0;const $=Ln(i);$<=Te&&(p.totalDist+=$,p.distCount++),(Ke=i.defenses)!=null&&Ke[0]&&(p.dodges+=i.defenses[0].dodgeCount||0,p.downs+=i.defenses[0].downCount||0,p.deaths+=i.defenses[0].deadCount||0),t.durationMS&&(p.totalFightMs+=t.durationMS);const v=Array.isArray(i.activeTimes)&&typeof i.activeTimes[0]=="number"?i.activeTimes[0]:t.durationMS||0;p.defenseActiveMs+=v,p.supportActiveMs+=v,p.healingActiveMs+=v,Array.isArray(i.buffUptimes)&&i.buffUptimes.length>0&&i.buffUptimes.forEach(c=>{var Tt,kt,St,vt;if(typeof(c==null?void 0:c.id)!="number")return;const d=`b${c.id}`,h=((Tt=t.buffMap)==null?void 0:Tt[d])||((kt=t.buffMap)==null?void 0:kt[String(c.id)]);if(!h||ao(h))return;const P=Number(((vt=(St=c.buffData)==null?void 0:St[0])==null?void 0:vt.uptime)??0);if(!Number.isFinite(P)||P<=0)return;const be=(h==null?void 0:h.stacking)??!1,Ue=(be?P:P/100)*v;if(!Number.isFinite(Ue)||Ue<=0)return;Ve.has(d)||Ve.set(d,{name:h==null?void 0:h.name,stacking:be,icon:h==null?void 0:h.icon}),xe.has(d)||xe.set(d,new Map);const We=xe.get(d),Je=p.account||i.account||i.name||"Unknown";let He=We.get(Je);He||(He={account:Je,profession:p.profession||i.profession||"Unknown",professions:new Set,professionTimeMs:{},totalMs:0,durationMs:0},We.set(Je,He));const an=i.profession||p.profession;an&&an!=="Unknown"&&(He.professions.add(an),He.professionTimeMs[an]=(He.professionTimeMs[an]||0)+v,He.profession=an),He.totalMs+=Ue,He.durationMs+=v}),(Ge=i.defenses)!=null&&Ge[0]&&Qt.forEach(c=>{const d=Number(i.defenses[0][c.field]??0);Number.isFinite(d)&&(p.defenseTotals[c.id]=(p.defenseTotals[c.id]||0)+d)}),(Xe=i.support)!=null&&Xe[0]&&Xt.forEach(c=>{let d=Number(i.support[0][c.field]??0);Number.isFinite(d)&&(Ie.has(c.field)&&d>999999&&(d=0),p.supportTotals[c.id]=(p.supportTotals[c.id]||0)+d)});const I=(c,d)=>{Number.isFinite(d)&&(p.healingTotals[c]=(p.healingTotals[c]||0)+d)},re=(c,d)=>Array.isArray(c)?c.reduce((h,P)=>h+Number((P==null?void 0:P[d])??0),0):0,x=(c,d,h)=>{if(!Number.isFinite(h)||h<=0)return;const P=l[d],be=d===f,ze=P==null?void 0:P.notInSquad,Ue=!ze,We=Ue&&(P==null?void 0:P.group)!=null&&P.group===i.group;I(c,h),Ue&&I(`squad${c[0].toUpperCase()}${c.slice(1)}`,h),We&&I(`group${c[0].toUpperCase()}${c.slice(1)}`,h),be&&I(`self${c[0].toUpperCase()}${c.slice(1)}`,h),ze&&I(`offSquad${c[0].toUpperCase()}${c.slice(1)}`,h)};if(Array.isArray(i.rotation)){let c=0;i.rotation.forEach(d=>{var P;if(!(d!=null&&d.id)||!no(d.id,t.skillMap))return;const h=((P=d.skills)==null?void 0:P.length)||0;h>0&&(c+=h,I(`resUtility_s${d.id}`,h))}),c>0&&I("resUtility",c)}const N=(Ze=i.extHealingStats)==null?void 0:Ze.outgoingHealingAllies;Array.isArray(N)&&N.forEach((c,d)=>{const h=re(c,"healing"),P=re(c,"downedHealing");x("healing",d,h),x("downedHealing",d,P)});const j=(vn=i.extBarrierStats)==null?void 0:vn.outgoingBarrierAllies;Array.isArray(j)&&j.forEach((c,d)=>{const h=re(c,"barrier");x("barrier",d,h)});const L=(ln=i.statsAll)==null?void 0:ln[0],oe=(un=i.dpsAll)==null?void 0:un[0],q=(pt=i.support)==null?void 0:pt[0];if(Yt.forEach(c=>{if(c.id==="downContributionPercent"||!c.field)return;let d=0,h=0;c.source==="dpsAll"&&oe?d=Number(oe[c.field]??0):c.source==="statsAll"&&L?(d=Number(L[c.field]??0),h=Number(L[c.denomField||c.weightField||"connectedDamageCount"]??0)):c.source==="support"&&q?d=Number(q[c.field]??0):i.statsTargets&&i.statsTargets.forEach(P=>{P!=null&&P[0]&&(d+=Number(P[0][c.field]??0),h+=Number(P[0][c.denomField||c.weightField||"connectedDamageCount"]??0))}),Number.isFinite(d)&&(p.offenseTotals[c.id]=(p.offenseTotals[c.id]||0)+d,c.isRate&&h>0&&(p.offenseRateWeights[c.id]=(p.offenseRateWeights[c.id]||0)+h))}),i.targetDamageDist&&Number.isFinite(ae)){const c=i.targetDamageDist.flatMap(d=>d||[]).flatMap(d=>d||[]).reduce((d,h)=>h!=null&&h.id&&h.id===ae?d+((h==null?void 0:h.connectedHits)||0):d,0);p.offenseTotals.battleStandardHits=(p.offenseTotals.battleStandardHits||0)+c}p.revives+=((ht=(bt=i.support)==null?void 0:bt[0])==null?void 0:ht.resurrects)||0,oe&&(p.damage+=oe.damage||0,p.dps+=oe.dps||0);const ue=c=>{var be,ze,Ue,We;let d=`Skill ${c.id}`;const h=((be=t.skillMap)==null?void 0:be[`s${c.id}`])||((ze=t.skillMap)==null?void 0:ze[`${c.id}`]);let P=h==null?void 0:h.icon;if(h!=null&&h.name&&(d=h.name),d.startsWith("Skill ")){const Je=fn(d,c.id,t.buffMap);Je&&(d=Je,P=((We=(Ue=t.buffMap)==null?void 0:Ue[`b${c.id}`])==null?void 0:We.icon)||P)}return{name:d,icon:P}},E=c=>{if(!(c!=null&&c.id))return;const{name:d,icon:h}=ue(c);de[c.id]||(de[c.id]={name:d,icon:h,damage:0,hits:0,downContribution:0}),de[c.id].name.startsWith("Skill ")&&!d.startsWith("Skill ")&&(de[c.id].name=d),!de[c.id].icon&&h&&(de[c.id].icon=h),de[c.id].damage+=c.totalDamage,de[c.id].hits+=c.connectedHits,de[c.id].downContribution+=Number(c.downContribution||0)},ee=i.account||i.name||"Unknown",y=i.profession||"Unknown",W=`${ee}|${y}`;let ce=Ae.get(W);ce||(ce={key:W,account:ee,displayName:ee,profession:y,professionList:[y],totalFightMs:0,skills:new Map},Ae.set(W,ce)),ce.professionList.includes(y)||ce.professionList.push(y),ce.totalFightMs+=t.durationMS||0;const Ee=c=>{if(!(c!=null&&c.id))return;const{name:d,icon:h}=ue(c),P=`s${c.id}`;let be=ce.skills.get(P);be||(be={id:P,name:d,icon:h,damage:0,downContribution:0},ce.skills.set(P,be)),be.name.startsWith("Skill ")&&!d.startsWith("Skill ")&&(be.name=d),!be.icon&&h&&(be.icon=h),be.damage+=Number(c.totalDamage||0),be.downContribution+=Number(c.downContribution||0)};Y==="total"?(Ct=i.totalDamageDist)==null||Ct.forEach(c=>{c==null||c.forEach(d=>{E(d),Ee(d)})}):(Dt=i.targetDamageDist)==null||Dt.forEach(c=>{c==null||c.forEach(d=>{d==null||d.forEach(h=>{E(h),Ee(h)})})}),i.totalDamageTaken&&i.totalDamageTaken.forEach(c=>{c==null||c.forEach(d=>{var ze,Ue,We,Je;if(!(d!=null&&d.id))return;let h=`Skill ${d.id}`;const P=((ze=t.skillMap)==null?void 0:ze[`s${d.id}`])||((Ue=t.skillMap)==null?void 0:Ue[`${d.id}`]);let be=P==null?void 0:P.icon;if(P!=null&&P.name&&(h=P.name),h.startsWith("Skill ")){const He=fn(h,d.id,t.buffMap);He&&(h=He,be=((Je=(We=t.buffMap)==null?void 0:We[`b${d.id}`])==null?void 0:Je.icon)||be)}se[d.id]||(se[d.id]={name:h,icon:be,damage:0,hits:0}),(!se[d.id].name.startsWith("Skill ")||h.startsWith("Skill "))&&(se[d.id].name=h),!se[d.id].icon&&be&&(se[d.id].icon=be),se[d.id].damage+=d.totalDamage,se[d.id].hits+=d.hits})})}),_n.forEach(i=>{const f=tn(i.profession||i.name);f&&(pe[f]=(pe[f]||0)+1)});const J=yt({players:l,targets:a,skillMap:t.skillMap,buffMap:t.buffMap,getPlayerKey:i=>i.account&&i.account!=="Unknown"?i.account:i.name||null}),te=Kn(t.buffMap);Object.entries(J.playerConditions).forEach(([i,f])=>{const T=ie.get(i);T&&Object.entries(f).forEach(([U,M])=>{const p=T.outgoingConditions[U]||{applications:0,damage:0,skills:{},icon:M.icon};p.applications+=Number(M.applications||0),p.damage+=Number(M.damage||0),M.applicationsFromBuffs&&(p.applicationsFromBuffs=(p.applicationsFromBuffs||0)+M.applicationsFromBuffs),M.applicationsFromBuffsActive&&(p.applicationsFromBuffsActive=(p.applicationsFromBuffsActive||0)+M.applicationsFromBuffsActive),Object.entries(M.skills||{}).forEach(([$,v])=>{const I=p.skills[$]||{name:v.name,hits:0,damage:0,icon:v.icon};I.hits+=Number(v.hits||0),I.damage+=Number(v.damage||0),!I.icon&&v.icon&&(I.icon=v.icon),p.skills[$]=I}),!p.icon&&M.icon&&(p.icon=M.icon),T.outgoingConditions[U]=p})}),Object.entries(J.summary).forEach(([i,f])=>{const T=De[i]||{name:f.name||i,icon:f.icon,applications:0,damage:0};T.applications+=Number(f.applications||0),T.damage+=Number(f.damage||0),f.applicationsFromBuffs&&(T.applicationsFromBuffs=(T.applicationsFromBuffs||0)+f.applicationsFromBuffs),f.applicationsFromBuffsActive&&(T.applicationsFromBuffsActive=(T.applicationsFromBuffsActive||0)+f.applicationsFromBuffsActive),!T.icon&&f.icon&&(T.icon=f.icon),De[i]=T}),sn.forEach(i=>{const f=i.account&&i.account!=="Unknown"?i.account:i.name||"Unknown",T=ie.get(f);!T||!i.totalDamageTaken||i.totalDamageTaken.forEach(U=>U==null?void 0:U.forEach(M=>{var ue,E,ee,y,W,ce;if(!(M!=null&&M.id))return;let p=`Skill ${M.id}`;const $=((ue=t.skillMap)==null?void 0:ue[`s${M.id}`])||((E=t.skillMap)==null?void 0:E[`${M.id}`]);$!=null&&$.name&&(p=$.name);const v=fn(p,M.id,t.buffMap);if(!v)return;const I=(y=(ee=t.buffMap)==null?void 0:ee[`b${M.id}`])==null?void 0:y.name,re=te.get(v)||((ce=(W=t.buffMap)==null?void 0:W[`b${M.id}`])==null?void 0:ce.icon),x=($==null?void 0:$.icon)||re;p.startsWith("Skill ")&&(I||v)&&(p=I||v);const N=Number(M.hits??0),j=Number(M.totalDamage??0),L=Me[v]||{name:v,icon:re,applications:0,damage:0};L.applications+=Number.isFinite(N)?N:0,L.damage+=Number.isFinite(j)?j:0,!L.icon&&re&&(L.icon=re),Me[v]=L;const oe=T.incomingConditions[v]||{applications:0,damage:0,skills:{},icon:re};oe.applications+=Number.isFinite(N)?N:0,oe.damage+=Number.isFinite(j)?j:0;const q=oe.skills[p]||{name:p,hits:0,damage:0,icon:x};q.hits+=Number.isFinite(N)?N:0,q.damage+=Number.isFinite(j)?j:0,!q.icon&&x&&(q.icon=x),oe.skills[p]=q,!oe.icon&&re&&(oe.icon=re),T.incomingConditions[v]=oe}))});const Pe=t.player_damage_mitigation||t.playerDamageMitigation,ye=Pe&&typeof Pe=="object"&&Object.keys(Pe).length>0;ye&&Object.entries(Pe).forEach(([i,f])=>{if(!f||typeof f!="object")return;const T=Xn(i),U=Zn(hn,T.account,T);Object.values(f).forEach(M=>{_((M==null?void 0:M.avoided_damage)??(M==null?void 0:M.avoidedDamage))<=0||nt(U.mitigationTotals,M)})});const Sn=t.player_minion_damage_mitigation||t.playerMinionDamageMitigation,$n=Sn&&typeof Sn=="object"&&Object.keys(Sn).length>0;$n&&Object.entries(Sn).forEach(([i,f])=>{if(!f||typeof f!="object")return;const T=Xn(i);Object.entries(f).forEach(([U,M])=>{if(!M||typeof M!="object")return;const p=`${T.account}::${U}`,$=et(Cn,p,{...T,minion:String(U||"Unknown")});Object.values(M).forEach(v=>{nt($.mitigationTotals,v)})})}),(!ye||!$n)&&(ye||sn.forEach(i=>{const f=(i==null?void 0:i.totalDamageTaken)||[];if(!Array.isArray(f)||f.length===0)return;const T=i.account||i.name||"Unknown",U={account:T,name:i.name||T,profession:tn(i.profession||"Unknown")};Zn(hn,T,U);const M=t.skillMap||{},p=t.buffMap||{},$=Array.isArray(f)?f[0]:null;if($==null||$.forEach(v=>{if(!(v!=null&&v.id))return;const I=_(v.blocked),re=_(v.evaded),x=_(v.glance??v.glanced),N=_(v.missed),j=_(v.invulned),L=_(v.interrupted),oe=_(v.hits??v.connectedHits),q=Number(v.id),ue=Dn(q,M,p);if(st(ot,`${T}::${q}`,{totalHits:oe,blocked:I,evaded:re,glanced:x,missed:N,invulned:j,interrupted:L}),T===Tn){const E=cn.get(q),ee=Ye(q),y=ee.hasSkill?ee.hits>0?ee.avg:0:1,W=ee.hasSkill?ee.min||0:1,ce=ee.hits>0?x*y/2+(I+re+N+j+L)*y:0,Ee=ee.hits>0?x*W/2+(I+re+N+j+L)*W:0;Nn.push({logId:e.filePath||e.id||n,skillId:v.id,skillName:ue,blocked:I,evaded:re,glanced:x,missed:N,invulned:j,interrupted:L,totalAvoids:I+re+x+N+j+L,avg:y,min:W,enemyHits:(E==null?void 0:E.connectedHits)??0,enemyTotalDmg:(E==null?void 0:E.totalDamage)??0,avoidDmg:ce,avoidMinDmg:Ee})}}),T===Tn){const v=(I,re)=>{let x=0,N=0,j=0;if(!Array.isArray(I))return{total:x,minTotal:N,hits:j};for(const L of I){if(!(L!=null&&L.id))continue;const oe=_(L.blocked),q=_(L.evaded),ue=_(L.glance??L.glanced),E=_(L.missed),ee=_(L.invulned),y=_(L.interrupted),W=Dn(Number(L.id),m,g),ce=re(Number(L.id),W);(ce.hits??0)>0&&(x+=ue*ce.avg/2+(oe+q+E+ee+y)*ce.avg,N+=ue*ce.min/2+(oe+q+E+ee+y)*ce.min),j+=_(L.hits??L.connectedHits)}return{total:x,minTotal:N,hits:j}};Fn.push({logId:e.filePath||e.id||n,variant:"current_global_name_taken0",...v($,(I,re)=>{const x=Ye(I),N=x.hasSkill?x.hits>0?x.avg:0:1,j=x.hasSkill?x.min||0:1;return{avg:N,min:j,hits:x.hits}})})}}),$n||sn.forEach(i=>{const f=(i==null?void 0:i.minions)||[];if(!Array.isArray(f)||f.length===0)return;const T=i.account||i.name||"Unknown",U={account:T,name:i.name||T,profession:tn(i.profession||"Unknown")},M=t.skillMap||{},p=t.buffMap||{};f.forEach($=>{const v=($==null?void 0:$.totalDamageTakenDist)||[];if(!Array.isArray(v)||v.length===0)return;let I=String(($==null?void 0:$.name)||"Unknown").replace(/^Juvenile\s+/i,"")||"Unknown";I.toUpperCase().includes("UNKNOWN")&&(I="Unknown");const re=`${T}::${I}`;et(Cn,re,{...U,minion:I});const x=Array.isArray(v)?v[0]:null;if(x==null||x.forEach(N=>{if(!(N!=null&&N.id))return;const j=_(N.blocked),L=_(N.evaded),oe=_(N.glance??N.glanced),q=_(N.missed),ue=_(N.invulned),E=_(N.interrupted),ee=_(N.hits??N.connectedHits),y=Number(N.id),W=Dn(y,M,p);if(st(it,`${re}::${y}`,{totalHits:ee,blocked:j,evaded:L,glanced:oe,missed:q,invulned:ue,interrupted:E}),T===Tn&&I===tt){const ce=cn.get(y),Ee=Ye(y),Ke=Ee.hasSkill?Ee.hits>0?Ee.avg:0:1,Ge=Ee.hasSkill?Ee.min||0:1,Xe=Ee.hits>0?oe*Ke/2+(j+L+q+ue+E)*Ke:0,Ze=Ee.hits>0?oe*Ge/2+(j+L+q+ue+E)*Ge:0;En.push({logId:e.filePath||e.id||n,skillId:N.id,skillName:W,blocked:j,evaded:L,glanced:oe,missed:q,invulned:ue,interrupted:E,totalAvoids:j+L+oe+q+ue+E,avg:Ke,min:Ge,enemyHits:(ce==null?void 0:ce.connectedHits)??0,enemyTotalDmg:(ce==null?void 0:ce.totalDamage)??0,avoidDmg:Xe,avoidMinDmg:Ze})}}),T===Tn&&I===tt){const N=(q,ue)=>{let E=0,ee=0,y=0;if(!Array.isArray(q))return{total:E,minTotal:ee,hits:y};for(const W of q){if(!(W!=null&&W.id))continue;const ce=_(W.blocked),Ee=_(W.evaded),Ke=_(W.glance??W.glanced),Ge=_(W.missed),Xe=_(W.invulned),Ze=_(W.interrupted),vn=Dn(Number(W.id),m,g),{avg:ln,min:un}=ue(Number(W.id),vn);_(W.hits??W.connectedHits)>0&&(E+=Ke*ln/2+(ce+Ee+Ge+Xe+Ze)*ln,ee+=Ke*un/2+(ce+Ee+Ge+Xe+Ze)*un),y+=_(W.hits??W.connectedHits)}return{total:E,minTotal:ee,hits:y}},j=Array.isArray(v)?v[0]||[]:[],L=Array.isArray(v)?v.flat():[],oe=Array.isArray($==null?void 0:$.totalDamageTaken)?$.totalDamageTaken[0]||[]:[];Qe.push({logId:e.filePath||e.id||n,variant:"current_global_name_dist0",...N(j,(q,ue)=>{const E=Ye(q),ee=E.hasSkill?E.hits>0?E.avg:0:1,y=E.hasSkill&&E.min||0;return{avg:ee,min:y}})}),Qe.push({logId:e.filePath||e.id||n,variant:"local_name_dist0",...N(j,(q,ue)=>we(ue))}),Qe.push({logId:e.filePath||e.id||n,variant:"local_id_dist0",...N(j,q=>me(q))}),Qe.push({logId:e.filePath||e.id||n,variant:"global_name_alllists",...N(L,(q,ue)=>{const E=Ye(q),ee=E.hasSkill?E.hits>0?E.avg:0:1,y=E.hasSkill&&E.min||0;return{avg:ee,min:y}})}),Qe.push({logId:e.filePath||e.id||n,variant:"global_name_taken0",...N(oe,(q,ue)=>{const E=Ye(q),ee=E.hasSkill?E.hits>0?E.avg:0:1,y=E.hasSkill&&E.min||0;return{avg:ee,min:y}})})}})}))}),En.length>0&&(console.groupCollapsed("[Mitigation Debug] Ashtonlightstone.9145 / Illusionary Warden"),console.table(En),Qe.length>0&&console.table(Qe),console.groupEnd()),Nn.length>0&&(console.groupCollapsed("[Mitigation Debug] Ashtonlightstone.9145 / Player"),console.table(Nn),Fn.length>0&&console.table(Fn),console.groupEnd());const at=(e,n)=>{const t=new Map,l=a=>{let m=t.get(a);return m||(m=rn(),t.set(a,m)),m};n.forEach((a,m)=>{const g=m.lastIndexOf("::"),F=g>-1?m.slice(0,g):m,B=g>-1?Number(m.slice(g+2)):Number.NaN,me=Number.isFinite(B)?Ye(B):{hasSkill:!1,avg:0,min:0,hits:0};if(!me.hasSkill||me.hits<=0)return;const we=me.avg,le=me.min,$e=a.glanced*we/2+(a.blocked+a.evaded+a.missed+a.invulned+a.interrupted)*we,Be=a.glanced*le/2+(a.blocked+a.evaded+a.missed+a.invulned+a.interrupted)*le;if($e<=0)return;const Te=l(F);Te.totalHits+=a.totalHits,Te.blocked+=a.blocked,Te.evaded+=a.evaded,Te.glanced+=a.glanced,Te.missed+=a.missed,Te.invulned+=a.invulned,Te.interrupted+=a.interrupted,Te.totalMitigation+=$e,Te.minMitigation+=Be}),e.forEach((a,m)=>{const g=t.get(m)||rn();a.mitigationTotals.totalHits=g.totalHits,a.mitigationTotals.blocked=g.blocked,a.mitigationTotals.evaded=g.evaded,a.mitigationTotals.glanced=g.glanced,a.mitigationTotals.missed=g.missed,a.mitigationTotals.invulned=g.invulned,a.mitigationTotals.interrupted=g.interrupted,a.mitigationTotals.totalMitigation=g.totalMitigation,a.mitigationTotals.minMitigation=g.minMitigation})};at(hn,ot),at(Cn,it);const co=w>0?Math.round(H/w):0,lo=w>0?Math.round(z/w):0,uo=O>0?(Q/O).toFixed(2):Q>0?"∞":"0.00",fo=ve>0?(X/ve).toFixed(2):X>0?"∞":"0.00",rt=(e,n)=>{const l=e.filter(g=>Number.isFinite(g.value)&&(n?g.value>0:g.value>=0)).sort((g,F)=>{const B=n?F.value-g.value:g.value-F.value;return B!==0?B:g.account.localeCompare(F.account)});let a=null,m=0;return l.map((g,F)=>((a===null||g.value!==a)&&(m=F+1,a=g.value),{rank:m,...g}))},Bn=Array.from(ie.values()).map(e=>{const n=Array.from(e.professions).filter(t=>t!=="Unknown");if(e.professionList=n,n.length>0){let t=n[0],l=e.professionTimeMs[t]||0;n.forEach(a=>{const m=e.professionTimeMs[a]||0;m>l&&(l=m,t=a)}),e.profession=t}return{key:e.account,stat:e}}),ct=e=>{const n=ie.get(e.account);if(!n){const a=e.professionList.length>0?e.professionList:e.profession?[e.profession]:[];return{...e,professionList:a}}const t=n.professionList&&n.professionList.length>0?n.professionList:Array.from(n.professions||[]).filter(a=>a&&a!=="Unknown"),l=n.profession||e.profession;return{...e,profession:l,professionList:t.length>0?t:l?[l]:[],activeMs:n.defenseActiveMs||n.totalFightMs||e.activeMs}},mo=Array.from(hn.values()).map(ct).filter(e=>ro(e.mitigationTotals)).sort((e,n)=>e.account.localeCompare(n.account)),go=Array.from(Cn.values()).map(ct).filter(e=>e.mitigationTotals.totalMitigation>0).sort((e,n)=>{const t=e.account.localeCompare(n.account);return t!==0?t:String(e.minion||"").localeCompare(String(n.minion||""))}),kn=(e,n)=>{switch(n){case"downContrib":return e.downContrib;case"barrier":return e.barrier;case"healing":return e.healing;case"dodges":return e.dodges;case"strips":return e.strips;case"cleanses":return e.cleanses;case"cc":return e.cc;case"stability":return e.stab;case"revives":return e.revives;case"dps":return e.dps;case"damage":return e.damage;case"participation":return e.logsJoined;case"closestToTag":return!e.isCommander&&e.distCount>0?e.totalDist/e.distCount:Number.POSITIVE_INFINITY;default:return 0}},Fe=(e,n)=>rt(Bn.map(({stat:t})=>({account:t.account,profession:t.profession,professionList:t.professionList,value:kn(t,e),count:t.logsJoined})),n),he={downContrib:Fe("downContrib",!0),barrier:Fe("barrier",!0),healing:Fe("healing",!0),dodges:Fe("dodges",!0),strips:Fe("strips",!0),cleanses:Fe("cleanses",!0),cc:Fe("cc",!0),stability:Fe("stability",!0),revives:Fe("revives",!0),participation:Fe("participation",!0),dps:Fe("dps",!0),damage:Fe("damage",!0),closestToTag:Fe("closestToTag",!1).filter(e=>Number.isFinite(e.value))},po={downContrib:"downContrib",barrier:"barrier",healing:"healing",dodges:"dodges",strips:"strips",cleanses:"cleanses",cc:"cc",stability:"stability",closestToTag:"closestToTag"},fe=e=>{const n=e==null?void 0:e[0];return{value:(n==null?void 0:n.value)??0,player:(n==null?void 0:n.account)??"-",count:(n==null?void 0:n.count)??0,profession:(n==null?void 0:n.profession)??"Unknown",professionList:(n==null?void 0:n.professionList)??[]}},je={maxDownContrib:fe([]),maxBarrier:fe([]),maxHealing:fe([]),maxDodges:fe([]),maxStrips:fe([]),maxCleanses:fe([]),maxCC:fe([]),maxStab:fe([]),closestToTag:fe([])},_e={},bo=(e,n)=>{if(n==="closestToTag")return kn(e,n);const t=Math.max(1,(e.totalFightMs||0)/1e3);return kn(e,n)/t};Object.values(po).forEach(e=>{const n=e!=="closestToTag";_e[e]=rt(Bn.map(({stat:t})=>({account:t.account,profession:t.profession,professionList:t.professionList,value:bo(t,e),count:t.logsJoined})),n)}),je.maxDownContrib=fe(_e.downContrib),je.maxBarrier=fe(_e.barrier),je.maxHealing=fe(_e.healing),je.maxDodges=fe(_e.dodges),je.maxStrips=fe(_e.strips),je.maxCleanses=fe(_e.cleanses),je.maxCC=fe(_e.cc),je.maxStab=fe(_e.stability),je.closestToTag=fe(_e.closestToTag);const ho={maxDownContrib:fe(he.downContrib),maxBarrier:fe(he.barrier),maxHealing:fe(he.healing),maxDodges:fe(he.dodges),maxStrips:fe(he.strips),maxCleanses:fe(he.cleanses),maxCC:fe(he.cc),maxStab:fe(he.stability),closestToTag:fe(he.closestToTag)};let In={player:"None",account:"None",score:-1,profession:"Unknown",professionList:[],color:"#64748b",topStats:[]},lt,ut,dt=0;if(V!=null&&V.showMvp){const e={"Down Contribution":"downContribution",Healing:"healing",Cleanses:"cleanses",Strips:"strips",Stability:"stability",CC:"cc",Revives:"revives","Distance to Tag":"distanceToTag",Participation:"participation",Dodging:"dodging",DPS:"dps",Damage:"damage"},n=m=>{const g=e[m];return g?Number(A[g]||0)>0:!1},t=[],l=m=>[...m||[]].filter(g=>n(g==null?void 0:g.name)).sort((g,F)=>F.ratio-g.ratio||g.rank-F.rank||g.name.localeCompare(F.name)).slice(0,3),a=m=>{var F;if(!m)return;const g=l(m.contribs);return{...m,player:m.name,reason:((F=g[0])==null?void 0:F.name)||"Top Performance",topStats:g}};Bn.forEach(({stat:m})=>{let g=0;const F=[],B=(me,we,le,$e,Be=!0)=>{var Ce,Oe;if(le<=0)return;const Te=((Ce=we[0])==null?void 0:Ce.value)||0;if(Te&&Number.isFinite(me)&&(Be?me>0:me<Number.POSITIVE_INFINITY)){const Re=Be?me/Te:Te/me;g+=Re*le;const on=((Oe=we.find(qe=>qe.account===m.account))==null?void 0:Oe.rank)||0;F.push({name:$e,ratio:Re,val:me.toLocaleString(),rank:on})}};B(m.downContrib,he.downContrib,A.downContribution,"Down Contribution"),B(m.healing,he.healing,A.healing,"Healing"),B(m.cleanses,he.cleanses,A.cleanses,"Cleanses"),B(m.strips,he.strips,A.strips,"Strips"),B(m.stab,he.stability,A.stability,"Stability"),B(m.cc,he.cc,A.cc,"CC"),B(m.revives,he.revives,A.revives,"Revives"),B(kn(m,"closestToTag"),he.closestToTag,A.distanceToTag,"Distance to Tag",!1),B(m.logsJoined,he.participation,A.participation,"Participation"),B(m.dodges,he.dodges,A.dodging,"Dodging"),B(m.dps,he.dps,A.dps,"DPS"),B(m.damage,he.damage,A.damage,"Damage"),t.push({...m,score:g,contribs:F.filter(me=>n(me.name))})}),t.sort((m,g)=>g.score-m.score),t[0]&&t[0].score>0&&(In=a(t[0])||In),lt=a(t[1]),ut=a(t[2]),dt=t.length>0?t.reduce((m,g)=>m+g.score,0)/t.length:0}const Co=Object.values(de).sort((e,n)=>{const t=D==="downContribution"?e.downContribution:e.damage;return(D==="downContribution"?n.downContribution:n.damage)-t}).slice(0,25),Do=Object.values(se).sort((e,n)=>n.damage-e.damage).slice(0,25),To=e=>{const n=String(e).replace(/^Detailed\s*WvW\s*-\s*/i,"").replace(/^World\s*vs\s*World\s*-\s*/i,"").replace(/^WvW\s*-\s*/i,"").trim(),t=n.match(/^(Red|Blue|Green)\s+(?:Alpine|Desert)?\s*Borderlands$/i);return t?`${t[1]} Borderlands`:n||"Unknown"},ft=(e,n)=>To((e==null?void 0:e.zone)||(e==null?void 0:e.mapName)||(e==null?void 0:e.map)||(e==null?void 0:e.location)||(e==null?void 0:e.fightName)||(n==null?void 0:n.fightName)||(n==null?void 0:n.encounterName)||"Unknown"),ko=(e,n)=>{const t=(n==null?void 0:n.permalink)||(e==null?void 0:e.permalink);if(typeof t=="string"&&t.trim().length>0)return t.trim();const l=e==null?void 0:e.uploadLinks;if(!Array.isArray(l))return"";for(const a of l){if(typeof a=="string"&&a.trim().length>0)return a.trim();if(a&&typeof a=="object"){const m=a.permalink||a.link||a.url||a.reportLink;if(typeof m=="string"&&m.trim().length>0)return m.trim()}}return""},Pn={};S.forEach(e=>{const n=ft(e==null?void 0:e.details,e);Pn[n]=(Pn[n]||0)+1});const So=Object.entries(Pn).map(([e,n])=>{const t=String(e).trim(),l=/eternal battlegrounds|^ebg$/i.test(t);let a="#64748b";return l?a="#ffffff":/red/i.test(t)?a="#ef4444":/blue/i.test(t)?a="#3b82f6":/green/i.test(t)&&(a="#22c55e"),{name:e,value:n,color:a}}).sort((e,n)=>n.value-e.value),{boonTables:vo}=Mt(S),wo=S.map((e,n)=>{var l,a;const t=((l=e.details)==null?void 0:l.players)||[];return{index:n+1,label:`Log ${n+1}`,timestamp:en(e.details,e),squadCount:t.filter(m=>!m.notInSquad).length,friendlyCount:t.length,enemies:((a=e.details)==null?void 0:a.targets).filter(m=>!m.isFake).length}}).sort((e,n)=>e.timestamp-n.timestamp),Un={};Array.from(ie.values()).forEach(e=>{e.profession&&e.profession!=="Unknown"&&(Un[e.profession]=(Un[e.profession]||0)+1)});const Mo=Object.entries(Un).map(([e,n])=>({name:e,value:n,color:Gn(e)})).sort((e,n)=>n.value-e.value),Hn={};Object.keys(pe).length===0&&S.forEach(e=>{var n,t;(t=(n=e.details)==null?void 0:n.targets)==null||t.forEach(l=>{if(l.isFake)return;const a=l.profession&&l.profession!=="Unknown"?l.profession:l.name||l.id||"Unknown",m=tn(a);Hn[m]=(Hn[m]||0)+1})});const Ao=Object.keys(pe).length>0?pe:Hn,Eo=Object.entries(Ao).map(([e,n])=>({name:e,value:n,color:Gn(e)})).sort((e,n)=>n.value-e.value),No=S.map((e,n)=>({log:e,originalIndex:n})).sort((e,n)=>en(e.log.details,e.log)-en(n.log.details,n.log)).map(({log:e},n)=>{const t=e.details;if(!t)return null;const l=t.players||[],a=l.filter(u=>!u.notInSquad),m=l.filter(u=>u.notInSquad),g=t.targets||[],F=g.filter(u=>!u.isFake),B=a.reduce((u,Z)=>{var R,ae;return u+(((ae=(R=Z.dpsAll)==null?void 0:R[0])==null?void 0:ae.damage)||0)},0),me=a.reduce((u,Z)=>{var R,ae;return u+(((ae=(R=Z.defenses)==null?void 0:R[0])==null?void 0:ae.damageTaken)||0)},0),{enemyDeaths:we,enemyDownsDeaths:le}=ke(t),$e=ge(t),Be=en(t,e),Te=ft(t,e),Ce={red:0,green:0,blue:0},Oe=u=>{const Z=Number(u);return Number.isFinite(Z)?Z:0},Re=u=>{if(!u||typeof u!="object")return;const Z=u.teamID??u.teamId??u.team??u.teamColor??u.team_color;if(Z!=null)return Z;const R=Object.keys(u).find(ae=>/^team/i.test(ae));return R?u[R]:void 0},on=(u,Z)=>{if(u==null)return null;if(typeof u=="string"){const R=u.toLowerCase();return R.includes("red")?"red":R.includes("green")?"green":R.includes("blue")?"blue":R==="r"?"red":R==="g"?"green":R==="b"?"blue":null}if(typeof u=="number")if(Z==="zeroBased"){if(u===0)return"red";if(u===1)return"green";if(u===2)return"blue"}else{if(u===1)return"red";if(u===2)return"green";if(u===3)return"blue"}return null},qe=(u,Z)=>{const R={};return u.forEach(ae=>{const J=Z(ae),te=tn(J);te&&(R[te]=(R[te]||0)+1)}),R},Ln=qe(a,u=>(u==null?void 0:u.profession)||(u==null?void 0:u.name)),sn=qe(m,u=>(u==null?void 0:u.profession)||(u==null?void 0:u.name)),_n=qe(F,u=>(u==null?void 0:u.profession)||(u==null?void 0:u.name)||(u==null?void 0:u.id));if(t.teamCounts&&typeof t.teamCounts=="object"){const u=t.teamCounts;Ce.red=Oe(u.red??u.r??u[0]??u[1]),Ce.green=Oe(u.green??u.g??u[1]??u[2]),Ce.blue=Oe(u.blue??u.b??u[2]??u[3])}else{const u=[];g.forEach(J=>{if(J!=null&&J.isFake)return;const te=Re(J);te!=null&&u.push(te)}),l.forEach(J=>{if(!(J!=null&&J.notInSquad))return;const te=Re(J);te!=null&&u.push(te)}),u.length===0&&l.forEach(J=>{const te=Re(J);te!=null&&u.push(te)});const Z=new Set;u.forEach(J=>{typeof J=="number"&&Z.add(J)});const R=Z.has(0)?"zeroBased":Z.has(3)?"oneBased":"zeroBased";if(u.forEach(J=>{const te=on(J,R);te&&(Ce[te]+=1)}),Ce.red+Ce.green+Ce.blue===0&&u.length>0){const J=new Map;u.forEach(Pe=>{const ye=String(Pe);J.set(ye,(J.get(ye)||0)+1)});const te=Array.from(J.values()).sort((Pe,ye)=>ye-Pe);Ce.red=te[0]||0,Ce.green=te[1]||0,Ce.blue=te[2]||0}Ce.red+Ce.green+Ce.blue===0&&(Ce.red=Math.max(F.length,l.filter(J=>J==null?void 0:J.notInSquad).length))}return{id:e.filePath||`fight-${n}`,label:e.encounterName||`Fight ${n+1}`,permalink:ko(t,e),timestamp:Be,mapName:Te,duration:to(t.durationMS),isWin:$e,squadCount:a.length,allyCount:m.length,enemyCount:F.length,teamCounts:Ce,alliesDown:a.reduce((u,Z)=>{var R,ae;return u+(((ae=(R=Z.defenses)==null?void 0:R[0])==null?void 0:ae.downCount)||0)},0),alliesDead:a.reduce((u,Z)=>{var R,ae;return u+(((ae=(R=Z.defenses)==null?void 0:R[0])==null?void 0:ae.deadCount)||0)},0),alliesRevived:a.reduce((u,Z)=>{var R,ae;return Number(((ae=(R=Z.statsAll)==null?void 0:R[0])==null?void 0:ae.saved)||0)>0?u+1:u},0),rallies:0,enemyDeaths:we,enemyDowns:Math.max(0,le-we),totalOutgoingDamage:B,totalIncomingDamage:me,incomingBarrierAbsorbed:a.reduce((u,Z)=>{var R,ae;return u+(((ae=(R=Z.defenses)==null?void 0:R[0])==null?void 0:ae.damageBarrier)||0)},0),outgoingBarrierAbsorbed:a.reduce((u,Z)=>{var J;const R=(J=Z.extBarrierStats)==null?void 0:J.outgoingBarrier;if(!Array.isArray(R))return u;let ae=0;return R.forEach(te=>{if(Array.isArray(te)){te.forEach(Pe=>{ae+=Number((Pe==null?void 0:Pe.barrier)||0)});return}ae+=Number((te==null?void 0:te.barrier)||0)}),u+ae},0),squadClassCountsFight:Ln,allyClassCountsFight:sn,enemyClassCounts:_n}}).filter(Boolean),Fo=Array.from(xe.entries()).map(([e,n])=>{const t=Ve.get(e)||{},l=Array.from(n.values()).map(a=>{var we;const m=Array.from(a.professions||[]).filter(le=>le&&le!=="Unknown");let g=a.profession||"Unknown";if(m.length>0){g=m[0];let le=((we=a.professionTimeMs)==null?void 0:we[g])||0;m.forEach($e=>{var Te;const Be=((Te=a.professionTimeMs)==null?void 0:Te[$e])||0;Be>le&&(le=Be,g=$e)})}const F=a.durationMs||0,B=a.totalMs/1e3,me=F>0?a.totalMs/F:0;return{account:a.account,profession:g,professionList:m,total:B,perSecond:me,duration:F/1e3}}).filter(a=>a.total>0||a.perSecond>0);return{id:e,name:t.name||e,icon:t.icon,rows:l}}).filter(e=>e.rows.length>0),Bo=Array.from(Ae.values()).map(e=>{const n=Array.from(e.skills.values()).sort((l,a)=>a.damage-l.damage),t=n.reduce((l,a)=>(l[a.id]=a,l),{});return{key:e.key,account:e.account,displayName:e.displayName,profession:e.profession,professionList:e.professionList,totalFightMs:e.totalFightMs,skills:n,skillMap:t}}).sort((e,n)=>e.displayName.localeCompare(n.displayName));return{total:w,wins:G,losses:C,avgSquadSize:co,avgEnemies:lo,squadKDR:uo,enemyKDR:fo,totalSquadKills:Q,totalSquadDeaths:O,totalEnemyKills:X,totalEnemyDeaths:ve,leaderboards:he,...ho,outgoingConditionSummary:Object.values(De).sort((e,n)=>n.damage-e.damage),incomingConditionSummary:Object.values(Me).sort((e,n)=>n.damage-e.damage),outgoingConditionPlayers:Array.from(ie.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,conditions:e.outgoingConditions})),incomingConditionPlayers:Array.from(ie.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,conditions:e.incomingConditions})),topSkills:Co,topIncomingSkills:Do,playerSkillBreakdowns:Bo,topSkillsMetric:D,mapData:So,timelineData:wo,boonTables:vo,offensePlayers:Array.from(ie.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,offenseTotals:e.offenseTotals,offenseRateWeights:e.offenseRateWeights,totalFightMs:e.totalFightMs})),defensePlayers:Array.from(ie.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,defenseTotals:e.defenseTotals,activeMs:e.defenseActiveMs})),damageMitigationPlayers:mo,damageMitigationMinions:go,supportPlayers:Array.from(ie.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,supportTotals:e.supportTotals,activeMs:e.supportActiveMs})),healingPlayers:Array.from(ie.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,healingTotals:e.healingTotals,activeMs:e.healingActiveMs})),mvp:In,silver:lt,bronze:ut,squadClassData:Mo,enemyClassData:Eo,fightBreakdown:No,specialTables:Fo,topStatsPerSecond:je,topStatsLeaderboardsPerSecond:_e,avgMvpScore:dt}})(),Ne=(()=>{const ne=new Map,Y=new Map,D=[],w=new Map,G=new Map;S.forEach(H=>{const z=H.details;if(!z)return;const O=z.skillMap||{},Q=z.fightName||"Log",ve=en(z,H)||Date.now(),X={id:H.filePath||H.id||Q,label:Q,timestamp:ve,skillEntries:{},playerActiveSeconds:{},durationSeconds:z.durationMS?z.durationMS/1e3:0};(z.players||[]).forEach(ge=>{if(ge.notInSquad)return;const ie=ge.account||ge.name||"Unknown",Ie=ge.profession||"Unknown",de=`${ie}|${Ie}`;let se=Y.get(de);se||(se={key:de,account:ie,displayName:ie,profession:Ie,professionList:[Ie],logs:0,totalActiveSeconds:0,skillTotals:{}},Y.set(de,se)),se.logs++;const Ae=(Array.isArray(ge.activeTimes)?ge.activeTimes[0]:0)/1e3;se.totalActiveSeconds=(se.totalActiveSeconds||0)+Ae,X.playerActiveSeconds[de]=Ae,(ge.rotation||[]).forEach(De=>{var gn,pn,bn;if(!(De!=null&&De.id))return;const Me=((gn=De.skills)==null?void 0:gn.length)||0;if(Me<=0)return;const pe=`s${De.id}`,Ve=((pn=O[pe])==null?void 0:pn.name)||`Skill ${De.id}`,xe=(bn=O[pe])==null?void 0:bn.icon;se.skillTotals[pe]=(se.skillTotals[pe]||0)+Me,ne.set(pe,(ne.get(pe)||0)+Me),w.set(pe,Ve),xe&&!G.has(pe)&&G.set(pe,xe),X.skillEntries[pe]||(X.skillEntries[pe]={name:Ve,icon:xe,players:{}}),!X.skillEntries[pe].icon&&xe&&(X.skillEntries[pe].icon=xe),X.skillEntries[pe].players[de]=(X.skillEntries[pe].players[de]||0)+Me})}),D.push(X)});const C=Array.from(ne.entries()).map(([H,z])=>({id:H,name:w.get(H)||H,total:z,icon:G.get(H)})).sort((H,z)=>z.total-H.total);return{logRecords:D,players:Array.from(Y.values()),skillOptions:C,resUtilitySkills:[]}})();return{validLogs:S,stats:Se,skillUsageData:Ne}};let Le=null,nn=!1,zn=null,Jn=0,yn=0,Mn=null;const Yn=o=>{if(!o||typeof o!="object")return o;const s=(b,k)=>{const S={};return k.forEach(V=>{b&&Object.prototype.hasOwnProperty.call(b,V)&&(S[V]=b[V])}),S},r=s(o,["players","targets","durationMS","uploadTime","timeStart","timeStartStd","timeEnd","timeEndStd","fightName","success","teamCounts","combatReplayMetaData","skillMap","buffMap","encounterDuration","player_damage_mitigation","player_minion_damage_mitigation","playerDamageMitigation","playerMinionDamageMitigation"]);return Array.isArray(r.players)&&(r.players=r.players.map(b=>s(b,["name","display_name","character_name","profession","elite_spec","group","dpsAll","statsAll","dpsTargets","statsTargets","defenses","support","rotation","extHealingStats","extBarrierStats","squadBuffVolumes","selfBuffs","groupBuffs","squadBuffs","selfBuffsActive","groupBuffsActive","squadBuffsActive","buffUptimes","totalDamageDist","targetDamageDist","totalDamageTaken","totalDamageTakenDist","minions","combatReplayData","hasCommanderTag","notInSquad","account","activeTimes"]))),Array.isArray(r.targets)&&(r.targets=r.targets.map(b=>s(b,["id","name","isFake","dpsAll","statsAll","defenses","totalHealth","healthPercentBurned","enemyPlayer","totalDamageDist"]))),r},so=o=>{if(!o||typeof o!="object")return o;const s={...o};return o.details?s.details=Yn(o.details):s.details=Yn(o),s},Qn=()=>{if(!nn||!Le)return;nn=!1,Jn+=1;const o=Mn;Mn=null;const s=io(Le);self.postMessage({type:"result",result:s,computeId:Jn,logCount:Le.logs.length,token:yn,completedAt:Date.now(),flushId:o})},An=()=>{zn===null&&(zn=setInterval(()=>{Qn()},5e3))};self.onmessage=o=>{var r,b,k,S;const s=o.data;if((s==null?void 0:s.type)==="reset"){Le={logs:[]},typeof s.token=="number"&&(yn=s.token),nn=!0,An();return}if((s==null?void 0:s.type)==="settings"){Le={logs:(Le==null?void 0:Le.logs)||[],precomputedStats:(r=s.payload)==null?void 0:r.precomputedStats,mvpWeights:(b=s.payload)==null?void 0:b.mvpWeights,statsViewSettings:(k=s.payload)==null?void 0:k.statsViewSettings,disruptionMethod:(S=s.payload)==null?void 0:S.disruptionMethod},nn=!0,An();return}if((s==null?void 0:s.type)==="log"){Le||(Le={logs:[]}),Le.logs.push(so(s.payload)),nn=!0,An();return}(s==null?void 0:s.type)==="flush"&&(typeof s.flushId=="number"&&(Mn=s.flushId),nn=!0,Qn())}})();
