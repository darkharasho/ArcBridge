(function(){"use strict";const Kn=["selfBuffs","groupBuffs","squadBuffs"],Gn=o=>o!=null&&o.classification?o.classification==="Boon":!0,yn=o=>`b${o}`,It=(o,s)=>{const c=Array.isArray(o==null?void 0:o.activeTimes)?o.activeTimes:[],h=typeof c[0]=="number"?c[0]:0;return h>0?h:s},Jn=(o,s,c,h,S,v,Z)=>{const I=o==="selfBuffs"?1:Math.max(o==="groupBuffs"?v-1:Z-1,0);return!I||!S?{generationMs:0,wastedMs:0}:s?{generationMs:c*S*I,wastedMs:h*S*I}:{generationMs:c/100*S*I,wastedMs:h/100*S*I}},Pt=o=>{const s=new Map,c=new Map;return o.forEach(v=>{const Z=v.details;if(!Z)return;const I=Z.durationMS||0,ee=Z.buffMap||{};Object.entries(ee).forEach(([D,M])=>{if(!s.has(D)){s.set(D,M);return}const ne=s.get(D)||{},k={name:ne.name||M.name,stacking:ne.stacking??M.stacking,icon:ne.icon||M.icon,classification:ne.classification||M.classification};s.set(D,k)});const Oe=(Z.players||[]).filter(D=>!D.notInSquad),ae=Oe.length,ie=new Map;Oe.forEach(D=>{const M=D.group??0;ie.set(M,(ie.get(M)||0)+1)}),Oe.forEach(D=>{const M=D.account||D.name||D.character_name||"Unknown",ne=D.profession||"Unknown",k=D.group??0,W=ie.get(k)||1,j=It(D,I);c.has(M)||c.set(M,{account:M,profession:ne,professions:new Set,professionTimeMs:{},activeTimeMs:0,numFights:0,groupSupported:0,squadSupported:0,boons:{}});const V=c.get(M);V.profession=ne,ne!=="Unknown"&&(V.professions.add(ne),V.professionTimeMs[ne]=(V.professionTimeMs[ne]||0)+j),V.activeTimeMs+=j,V.numFights+=1,V.groupSupported+=W,V.squadSupported+=ae,Kn.forEach(re=>{(D[re]||[]).forEach(G=>{var ve,Fe,De,Ge;if(typeof(G==null?void 0:G.id)!="number")return;const Ne=yn(G.id),Ae=ee[Ne];if(!Gn(Ae))return;const de=(Ae==null?void 0:Ae.stacking)??!1,Ue=((Fe=(ve=G.buffData)==null?void 0:ve[0])==null?void 0:Fe.generation)??0,ce=((Ge=(De=G.buffData)==null?void 0:De[0])==null?void 0:Ge.wasted)??0,{generationMs:me,wastedMs:He}=Jn(re,de,Ue,ce,I,W,ae);!me&&!He||(s.has(Ne)||s.set(Ne,Ae||{}),V.boons[Ne]||(V.boons[Ne]={selfBuffs:{generationMs:0,wastedMs:0},groupBuffs:{generationMs:0,wastedMs:0},squadBuffs:{generationMs:0,wastedMs:0}}),V.boons[Ne][re].generationMs+=me,V.boons[Ne][re].wastedMs+=He)})})})}),{boonTables:Array.from(s.keys()).filter(v=>Gn(s.get(v))).map(v=>{const Z=s.get(v)||{},I=[];return c.forEach(ee=>{var D;const Be=ee.boons[v];if(!Be||!Kn.some(M=>Be[M].generationMs>0||Be[M].wastedMs>0))return;const ae=Array.from(ee.professions||[]).filter(M=>M&&M!=="Unknown");let ie=ee.profession;if(ae.length>0){ie=ae[0];let M=((D=ee.professionTimeMs)==null?void 0:D[ie])||0;ae.forEach(ne=>{var W;const k=((W=ee.professionTimeMs)==null?void 0:W[ne])||0;k>M&&(M=k,ie=ne)})}I.push({account:ee.account,profession:ie||"Unknown",professionList:ae,activeTimeMs:ee.activeTimeMs||1,numFights:ee.numFights||1,groupSupported:ee.groupSupported||1,squadSupported:ee.squadSupported||1,categories:{selfBuffs:{...Be.selfBuffs},groupBuffs:{...Be.groupBuffs},squadBuffs:{...Be.squadBuffs}}})}),{id:v,name:Z.name||v,icon:Z.icon,stacking:Z.stacking??!1,rows:I}}).filter(v=>v.rows.length>0)}},Yn=(o,s,c,h,S,v,Z={})=>{var D,M,ne,k;const ee=((o==null?void 0:o[s])||[]).find(W=>W.id===c);if(!ee)return{generationMs:0,wastedMs:0};const Be=Z[yn(c)],Oe=(Be==null?void 0:Be.stacking)??!1,ae=((M=(D=ee.buffData)==null?void 0:D[0])==null?void 0:M.generation)??0,ie=((k=(ne=ee.buffData)==null?void 0:ne[0])==null?void 0:k.wasted)??0;return Jn(s,Oe,ae,ie,h,S,v)};var Ut={methods:{tiered:{tiers:{shortMs:500,mediumMs:1500,weights:{short:.5,medium:1,long:2}}}}};const Ht=Ut,Un="count",Lt=o=>(o||0)/1e3,$t=(o,s)=>{var S;if(!o)return 0;const c=(S=Ht.methods.tiered)==null?void 0:S.tiers;if(!c)return o;const h=s/Math.max(o,1);return h<=c.shortMs?o*c.weights.short:h<=c.mediumMs?o*c.weights.medium:o*c.weights.long},Qn=(o,s,c)=>c==="duration"?Lt(s):c==="tiered"?$t(o,s):o;function Ot(o,s=Un){var v;const c=(v=o.statsAll)==null?void 0:v[0],h=Number((c==null?void 0:c.appliedCrowdControl)??0),S=Number((c==null?void 0:c.appliedCrowdControlDuration)??0);return Qn(h,S,s)}function _t(o,s){const c=(s==null?void 0:s.durationMS)||0,h=(s==null?void 0:s.buffMap)||{},S=o.filter(I=>!I.notInSquad),v=S.length,Z=new Map;S.forEach(I=>{const ee=I.group??0;Z.set(ee,(Z.get(ee)||0)+1)}),S.forEach(I=>{const ee=Z.get(I.group??0)||1,Be=Yn(I,"selfBuffs",1122,c,ee,v,h),Oe=Yn(I,"squadBuffs",1122,c,ee,v,h);I.stabGeneration=(Be.generationMs+Oe.generationMs)/1e3})}function Rt(o){if(!o.statsTargets)return 0;let s=0;for(const c of o.statsTargets)c&&c.length>0&&(s+=c[0].downContribution||0);return s}function qt(o){if(!o.extBarrierStats||!o.extBarrierStats.outgoingBarrierAllies)return 0;let s=0;for(const c of o.extBarrierStats.outgoingBarrierAllies)if(c)for(const h of c)h&&(s+=h.barrier||0);return s}function xt(o){if(!o.extHealingStats||!o.extHealingStats.outgoingHealingAllies)return 0;let s=0;for(const c of o.extHealingStats.outgoingHealingAllies)if(c)for(const h of c)h&&(s+=h.healing||0);return s}const Wt=o=>{var s,c,h,S;return(((c=(s=o.support)==null?void 0:s[0])==null?void 0:c.condiCleanse)||0)+(((S=(h=o.support)==null?void 0:h[0])==null?void 0:S.condiCleanseSelf)||0)},jt=(o,s=Un)=>{var v;const c=(v=o.support)==null?void 0:v[0],h=Number((c==null?void 0:c.boonStrips)??0),S=Number((c==null?void 0:c.boonStripsTime)??0);return Qn(h,S,s)},Vt=o=>Rt(o),zt=o=>xt(o),Kt=o=>qt(o),Gt=(o,s=Un)=>Ot(o,s),yt=(o,s)=>_t(o,s),Jt="count",Yt={downContribution:1,healing:1,cleanses:1,strips:1,stability:1,cc:.7,revives:.7,distanceToTag:.7,participation:.7,dodging:.4,dps:.2,damage:.2},Qt={showMvp:!0,topSkillDamageSource:"target",topSkillsMetric:"damage"},Xn=new Map([["bleeding","Bleeding"],["burning","Burning"],["confusion","Confusion"],["poison","Poison"],["torment","Torment"],["vulnerability","Vulnerability"],["weakness","Weakness"],["weakened","Weakness"],["blind","Blind"],["blinded","Blind"],["blinding","Blind"],["cripple","Cripple"],["crippled","Cripple"],["chill","Chill"],["chilled","Chill"],["immob","Immobilize"],["immobile","Immobilize"],["immobilized","Immobilize"],["slow","Slow"],["slowed","Slow"],["fear","Fear"],["feared","Fear"],["taunt","Taunt"],["taunted","Taunt"]]),Xt={Blind:"https://render.guildwars2.com/file/09770136BB76FD0DBE1CC4267DEED54774CB20F6/102837.png",Chill:"https://render.guildwars2.com/file/28C4EC547A3516AF0242E826772DA43A5EAC3DF3/102839.png",Cripple:"https://render.guildwars2.com/file/070325E519C178D502A8160523766070D30C0C19/102838.png",Fear:"https://render.guildwars2.com/file/30307A6E766D74B6EB09EDA12A4A2DE50E4D76F4/102869.png",Immobilize:"https://render.guildwars2.com/file/397A613651BFCA2832B6469CE34735580A2C120E/102844.png",Slow:"https://render.guildwars2.com/file/F60D1EF5271D7B9319610855676D320CD25F01C6/961397.png",Taunt:"https://render.guildwars2.com/file/02EED459AD65FAF7DF32A260E479C625070841B9/1228472.png",Vulnerability:"https://render.guildwars2.com/file/3A394C1A0A3257EB27A44842DDEEF0DF000E1241/102850.png",Weakness:"https://render.guildwars2.com/file/6CB0E64AF9AA292E332A38C1770CE577E2CDE0E8/102853.png"},dn=o=>{if(!o)return null;const s=o.trim().toLowerCase(),c=Xn.get(s);if(c)return c;const h=s.split(/[^a-z]+/).filter(Boolean);for(const S of h){const v=Xn.get(S);if(v)return v}return null},Zt=o=>dn(o),Zn=o=>{const s=new Map;return o&&(Object.values(o).forEach(c=>{if(!(c!=null&&c.icon)||!(c!=null&&c.name))return;const h=dn(c.name);h&&(s.has(h)||s.set(h,c.icon))}),Object.entries(Xt).forEach(([c,h])=>{s.has(c)||s.set(c,h)})),s},Dn=(o,s,c)=>{var h;if(s&&c){const S=(h=c[`b${s}`])==null?void 0:h.name,v=dn(S);if(v)return v}return o?dn(o):null},eo=o=>{const s=(o==null?void 0:o.account)||"Unknown";return s&&s!=="Unknown"?s:(o==null?void 0:o.name)||"Unknown"||null},no=o=>{if(!o||o.length===0)return 0;let s=0,c=null;return o.forEach(h=>{const S=Number(h[1]??0);if(Number.isFinite(S)){if(c===null){c=S;return}S>c&&(s+=S-c),c=S}}),s},to=o=>{if(!o||o.length===0)return 0;let s=0;return o.forEach(c=>{const h=Number(c[0]??0),S=Number(c[1]??0);Number.isFinite(S)&&h!==0&&S>0&&(s+=1)}),s},oo=o=>{const{players:s,targets:c,skillMap:h,buffMap:S}=o,v=o.getPlayerKey||eo,Z=Zn(S),I={},ee={};s.forEach(D=>{if(D!=null&&D.notInSquad)return;const M=v(D);M&&(I[M]||(I[M]={}),D!=null&&D.totalDamageDist&&D.totalDamageDist.forEach(ne=>{ne&&ne.forEach(k=>{if(!k.id)return;let W=`Skill ${k.id}`,j;h&&(h[`s${k.id}`]?(W=h[`s${k.id}`].name||W,j=h[`s${k.id}`].icon||j):h[`${k.id}`]&&(W=h[`${k.id}`].name||W,j=h[`${k.id}`].icon||j));const V=Dn(W,k.id,S);if(!V)return;const re=S==null?void 0:S[`b${k.id}`],Pe=re==null?void 0:re.name,G=Z.get(V)||(re==null?void 0:re.icon),Ne=W.startsWith("Skill ")?Pe||V:W,Ae=j||(re==null?void 0:re.icon),de=Number(k.connectedHits??0),Ue=Number(k.hits??0),ce=de>0?de:Ue,me=Number(k.totalDamage??0);if(!Number.isFinite(ce)&&!Number.isFinite(me))return;const He=ee[V]||{name:V,icon:G,applications:0,damage:0};He.applications+=Number.isFinite(ce)?ce:0,He.damage+=Number.isFinite(me)?me:0,!He.icon&&G&&(He.icon=G),ee[V]=He;const ve=I[M][V]||{icon:G,applications:0,damage:0,skills:{}};ve.applications+=Number.isFinite(ce)?ce:0,ve.damage+=Number.isFinite(me)?me:0;const Fe=ve.skills[Ne]||{name:Ne,hits:0,damage:0,icon:Ae};Fe.hits+=Number.isFinite(ce)?ce:0,Fe.damage+=Number.isFinite(me)?me:0,!Fe.icon&&Ae&&(Fe.icon=Ae),ve.skills[Ne]=Fe,!ve.icon&&G&&(ve.icon=G),I[M][V]=ve})}))});const Be=new Map;s.forEach(D=>{if(D!=null&&D.notInSquad)return;const M=v(D);M&&D!=null&&D.name&&Be.set(D.name,M)});let Oe=0,ae=0,ie=0;return c.forEach(D=>{D!=null&&D.buffs&&D.buffs.forEach(M=>{const ne=Number(M==null?void 0:M.id);if(!Number.isFinite(ne))return;const k=S==null?void 0:S[`b${ne}`],W=dn(k==null?void 0:k.name);if(!W||k!=null&&k.classification&&k.classification!=="Condition")return;const j=W;if(!j)return;const V=M.statesPerSource||{};ie+=1,Object.entries(V).forEach(([re,Pe])=>{var ce;const G=Be.get(re);if(!G)return;ae+=1;const Ne=no(Pe),Ae=to(Pe);Oe+=Ne;const de=((ce=I[G])==null?void 0:ce[j])||{applications:0,damage:0,skills:{}};de.applicationsFromBuffs=(de.applicationsFromBuffs||0)+Ne,de.applicationsFromBuffsActive=(de.applicationsFromBuffsActive||0)+Ae,I[G]=I[G]||{},I[G][j]=de;const Ue=ee[j]||{name:j,applications:0,damage:0};Ue.applicationsFromBuffs=(Ue.applicationsFromBuffs||0)+Ne,Ue.applicationsFromBuffsActive=(Ue.applicationsFromBuffsActive||0)+Ae,ee[j]=Ue})})}),Object.values(I).forEach(D=>{Object.values(D).forEach(M=>{typeof M.applicationsFromBuffs=="number"&&(M.applications=M.applicationsFromBuffs)})}),Object.values(ee).forEach(D=>{typeof D.applicationsFromBuffs=="number"&&(D.applications=D.applicationsFromBuffs)}),{playerConditions:I,summary:ee,meta:{buffStateApplicationsTotal:Oe,targetBuffEntriesSeen:ie,buffStateSourcesSeen:ae}}},io=new Set(["Vulnerability","Weakness","Blind","Cripple","Chill","Immobilize","Slow","Fear","Taunt"]),so=[{id:"damage",label:"Damage",field:"damage",source:"dpsAll"},{id:"directDmg",label:"Direct Damage",field:"directDmg",source:"statsTargets"},{id:"connectedDamageCount",label:"Connected Damage Count",field:"connectedDamageCount",source:"statsTargets"},{id:"connectedDirectDamageCount",label:"Connected Direct Damage Count",field:"connectedDirectDamageCount",source:"statsTargets"},{id:"battleStandardHits",label:"Battle Standard Tracking"},{id:"criticalRate",label:"Critical Rate",field:"criticalRate",isRate:!0,isPercent:!0,denomField:"critableDirectDamageCount",source:"statsTargets"},{id:"criticalDmg",label:"Critical Damage",field:"criticalDmg",source:"statsTargets"},{id:"flankingRate",label:"Flanking Rate",field:"flankingRate",isRate:!0,isPercent:!0,denomField:"connectedDirectDamageCount",source:"statsTargets"},{id:"glanceRate",label:"Glance Rate",field:"glanceRate",isRate:!0,isPercent:!0,denomField:"connectedDirectDamageCount",source:"statsTargets"},{id:"missed",label:"Missed",field:"missed",source:"statsTargets"},{id:"evaded",label:"Evaded (enemy)",field:"evaded",source:"statsTargets"},{id:"blocked",label:"Blocked (enemy)",field:"blocked",source:"statsTargets"},{id:"interrupts",label:"Interrupts",field:"interrupts",source:"statsTargets"},{id:"invulned",label:"Invulned",field:"invulned",source:"statsTargets"},{id:"killed",label:"Killed",field:"killed",source:"statsTargets"},{id:"downed",label:"Downed",field:"downed",source:"statsTargets"},{id:"downContribution",label:"Down Contribution",field:"downContribution",source:"statsTargets"},{id:"downContributionPercent",label:"Down Contribution %",isRate:!0,isPercent:!0},{id:"againstDownedDamage",label:"Against Downed Damage",field:"againstDownedDamage",source:"statsTargets"},{id:"appliedCrowdControl",label:"Applied CC",field:"appliedCrowdControl",source:"statsTargets"},{id:"appliedCrowdControlDuration",label:"Applied CC Duration",field:"appliedCrowdControlDuration",source:"statsTargets"},{id:"appliedCrowdControlDownContribution",label:"Applied CC Down Contribution",field:"appliedCrowdControlDownContribution",source:"statsTargets"},{id:"appliedCrowdControlDurationDownContribution",label:"Applied CC Duration Down Contribution",field:"appliedCrowdControlDurationDownContribution",source:"statsTargets"},{id:"boonStrips",label:"Boon Strips",field:"boonStrips",source:"support"}],ao=[{id:"damageTaken",label:"Damage Taken",field:"damageTaken"},{id:"damageTakenCount",label:"Damage Taken Count",field:"damageTakenCount"},{id:"conditionDamageTaken",label:"Condition Damage Taken",field:"conditionDamageTaken"},{id:"conditionDamageTakenCount",label:"Condition Damage Taken Count",field:"conditionDamageTakenCount"},{id:"powerDamageTaken",label:"Power Damage Taken",field:"powerDamageTaken"},{id:"powerDamageTakenCount",label:"Power Damage Taken Count",field:"powerDamageTakenCount"},{id:"downedDamageTaken",label:"Downed Damage Taken",field:"downedDamageTaken"},{id:"downedDamageTakenCount",label:"Downed Damage Taken Count",field:"downedDamageTakenCount"},{id:"damageBarrier",label:"Damage Barrier",field:"damageBarrier"},{id:"damageBarrierCount",label:"Damage Barrier Count",field:"damageBarrierCount"},{id:"blockedCount",label:"Blocked Count",field:"blockedCount"},{id:"evadedCount",label:"Evaded Count",field:"evadedCount"},{id:"missedCount",label:"Missed Count",field:"missedCount"},{id:"dodgeCount",label:"Dodge Count",field:"dodgeCount"},{id:"invulnedCount",label:"Invulnerable Count",field:"invulnedCount"},{id:"interruptedCount",label:"Interrupted Count",field:"interruptedCount"},{id:"downCount",label:"Down Count",field:"downCount"},{id:"deadCount",label:"Death Count",field:"deadCount"},{id:"boonStrips",label:"Boon Strips (Incoming)",field:"boonStrips"},{id:"conditionCleanses",label:"Cleanses (Incoming)",field:"conditionCleanses"},{id:"receivedCrowdControl",label:"Crowd Control (Incoming)",field:"receivedCrowdControl"}],ro=[{id:"condiCleanse",label:"Condition Cleanses",field:"condiCleanse"},{id:"condiCleanseTime",label:"Condition Cleanse Time",field:"condiCleanseTime",isTime:!0},{id:"condiCleanseSelf",label:"Condition Cleanse Self",field:"condiCleanseSelf"},{id:"condiCleanseTimeSelf",label:"Condition Cleanse Time Self",field:"condiCleanseTimeSelf",isTime:!0},{id:"boonStrips",label:"Boon Strips",field:"boonStrips"},{id:"boonStripsTime",label:"Boon Strips Time",field:"boonStripsTime",isTime:!0},{id:"boonStripDownContribution",label:"Boon Strip Down Contribution",field:"boonStripDownContribution"},{id:"boonStripDownContributionTime",label:"Boon Strip Down Contribution Time",field:"boonStripDownContributionTime",isTime:!0},{id:"stunBreak",label:"Stun Breaks",field:"stunBreak"},{id:"removedStunDuration",label:"Removed Stun Duration",field:"removedStunDuration",isTime:!0},{id:"resurrects",label:"Resurrects",field:"resurrects"},{id:"resurrectTime",label:"Resurrect Time",field:"resurrectTime",isTime:!0}],co=["battle standard","glyph of renewal","glyph of the stars","illusion of life","spirit of nature","nature spirit","search and rescue","signet of mercy"],lo=new Set([10244]),uo=(o,s)=>{var S;if(lo.has(o))return!0;const c=(s==null?void 0:s[`s${o}`])||(s==null?void 0:s[`${o}`]),h=((S=c==null?void 0:c.name)==null?void 0:S.toLowerCase())||"";return co.some(v=>h.includes(v))},mo=o=>{if(!o||!Number.isFinite(o))return"--:--";const s=Math.max(0,Math.round(o/1e3)),c=Math.floor(s/3600),h=Math.floor(s%3600/60),S=s%60;return c>0?`${c}:${String(h).padStart(2,"0")}:${String(S).padStart(2,"0")}`:`${h}:${String(S).padStart(2,"0")}`},Tn={Guardian:"#72C1D9",Dragonhunter:"#72C1D9",Firebrand:"#72C1D9",Willbender:"#72C1D9",Revenant:"#D16E5A",Herald:"#D16E5A",Renegade:"#D16E5A",Vindicator:"#D16E5A",Warrior:"#FFD166",Berserker:"#FFD166",Spellbreaker:"#FFD166",Bladesworn:"#FFD166",Engineer:"#D09C59",Scrapper:"#D09C59",Holosmith:"#D09C59",Mechanist:"#D09C59",Ranger:"#8CDC82",Druid:"#8CDC82",Soulbeast:"#8CDC82",Untamed:"#8CDC82",Thief:"#C08F95",Daredevil:"#C08F95",Deadeye:"#C08F95",Specter:"#C08F95",Elementalist:"#F68A87",Tempest:"#F68A87",Weaver:"#F68A87",Catalyst:"#F68A87",Mesmer:"#B679D5",Chronomancer:"#B679D5",Mirage:"#B679D5",Virtuoso:"#B679D5",Necromancer:"#52A76F",Reaper:"#52A76F",Scourge:"#52A76F",Harbinger:"#52A76F",Ritualist:"#52A76F",Luminary:"#72C1D9",Conduit:"#D16E5A",Paragon:"#FFD166",Amalgam:"#D09C59",Galeshot:"#8CDC82",Antiquary:"#C08F95",Evoker:"#F68A87",Troubadour:"#B679D5",Unknown:"#64748B"};function et(o){return Tn[o]||Tn.Unknown}const fo=o=>{if(o==null||o==="")return 0;if(typeof o=="number")return!Number.isFinite(o)||o<=0?0:o>1e12?o:o*1e3;if(o instanceof Date){const Z=o.getTime();return Number.isFinite(Z)&&Z>0?Z:0}const s=String(o).trim();if(!s)return 0;const c=Number(s);if(Number.isFinite(c)&&c>0)return c>1e12?c:c*1e3;const h=Date.parse(s);if(Number.isFinite(h)&&h>0)return h;const S=s.replace(/([+-]\d{2})$/,"$1:00"),v=Date.parse(S);return Number.isFinite(v)&&v>0?v:0},en=(o,s)=>fo((o==null?void 0:o.uploadTime)??(s==null?void 0:s.uploadTime)??(o==null?void 0:o.timeStartStd)??(o==null?void 0:o.timeStart)??(o==null?void 0:o.timeEndStd)??(o==null?void 0:o.timeEnd)??(o==null?void 0:o.timeStartText)??(o==null?void 0:o.timeEndText)),go=({logs:o,precomputedStats:s,mvpWeights:c,statsViewSettings:h,disruptionMethod:S})=>{const v=(()=>{const ae=o.filter(ie=>ie.details&&ie.details.players&&ie.details.players.length>0);return console.log("[useStatsAggregation] Filtering logs:",{total:o.length,passed:ae.length,statuses:o.map(ie=>ie.status),hasDetails:o.map(ie=>!!ie.details)}),ae})(),Z=h||Qt,I=c||Yt,ee=ae=>{if(!ae||typeof ae!="object")return ae;const ie=Array.isArray(ae.fightBreakdown)?ae.fightBreakdown:null;if(!ie||ie.length===0)return ae;const D=new Map,M=new Map;o.forEach(k=>{var V;const W=(k==null?void 0:k.filePath)||(k==null?void 0:k.id);W&&D.set(String(W),k);const j=(k==null?void 0:k.permalink)||((V=k==null?void 0:k.details)==null?void 0:V.permalink);typeof j=="string"&&j.trim()&&M.set(j.trim(),k)});const ne=ie.map(k=>{if(!k||typeof k!="object"||Number(k.timestamp)>0)return k;const j=k.id?String(k.id):"",V=typeof k.permalink=="string"?k.permalink.trim():"",re=(j?D.get(j):void 0)||(V?M.get(V):void 0);if(!re)return k;const Pe=en(re==null?void 0:re.details,re);return Pe?{...k,timestamp:Pe}:k});return{...ae,fightBreakdown:ne}},Be=(()=>{if(s)return ee(s);const ae=S||Jt,ie=Z.topSkillDamageSource||"target",D=Z.topSkillsMetric||"damage",M=v.length;let ne=0,k=0,W=0,j=0,V=0,re=0,Pe=0,G=0;const Ne=e=>{const t=((e==null?void 0:e.players)||[]).filter(N=>!N.notInSquad);let l=0,a=0,r=0,f=0;return t.forEach(N=>{var O;const C=(O=N.defenses)==null?void 0:O[0];if(!C)return;const E=Number(C.downCount||0),y=Number(C.deadCount||0);l+=E+y,r+=y}),t.forEach(N=>{!N.statsTargets||N.statsTargets.length===0||N.statsTargets.forEach(C=>{const E=C==null?void 0:C[0];if(!E)return;const y=Number(E.downed||0),O=Number(E.killed||0);a+=y+O,f+=O})}),{squadDownsDeaths:l,enemyDownsDeaths:a,squadDeaths:r,enemyDeaths:f}},Ae=e=>{const{squadDownsDeaths:n,enemyDownsDeaths:t}=Ne(e);return n>0||t>0?t>n:typeof(e==null?void 0:e.success)=="boolean"?e.success:!1},de=new Map,Ue=new Set(["boonStripsTime","condiCleanseTime","condiCleanseTimeSelf"]),ce={},me={},He=new Map,ve={},Fe={},De={},Ge=new Map,Ve=new Map,Sn=new Set(Object.keys(Tn)),An=Object.keys(Tn).filter(e=>e&&e!=="Unknown").sort((e,n)=>n.length-e.length),vn=["Guardian","Revenant","Warrior","Engineer","Ranger","Thief","Elementalist","Mesmer","Necromancer"],cn=e=>{if(!e)return"Unknown";const n=String(e).replace(/\s*\([^)]*\)\s*$/,"").replace(/\s*\[[^\]]*\]\s*$/,"").replace(/\s\d+$/,"").trim();if(Sn.has(n))return n;const t=n.toLowerCase();for(const a of An)if(t.includes(a.toLowerCase()))return a;return vn.find(a=>t.includes(a.toLowerCase()))||n||"Unknown"},bo=e=>e!=null&&e.classification?e.classification==="Boon":!0,wn=new Map,Mn=new Map,mn=()=>({totalHits:0,blocked:0,evaded:0,glanced:0,missed:0,invulned:0,interrupted:0,totalMitigation:0,minMitigation:0}),q=e=>{const n=Number(e);return Number.isFinite(n)?n:0},at=e=>{const n=String(e).split("|"),t=n[0]||"Unknown",l=cn(n[1]||"Unknown"),a=n[2]||t||"Unknown";return{name:t,profession:l,account:a}},rt=(e,n,t)=>{let l=e.get(n);return l?t.profession&&!l.professionList.includes(t.profession)&&l.professionList.push(t.profession):(l={account:t.account,name:t.name,profession:t.profession,professionList:t.profession?[t.profession]:[],activeMs:0,mitigationTotals:mn()},e.set(n,l)),l},ct=(e,n,t)=>{let l=e.get(n);return l?t.profession&&!l.professionList.includes(t.profession)&&l.professionList.push(t.profession):(l={account:t.account,name:t.name,profession:t.profession,professionList:t.profession?[t.profession]:[],activeMs:0,mitigationTotals:mn(),minion:t.minion},e.set(n,l)),l},lt=(e,n)=>{e.totalHits+=q((n==null?void 0:n.skill_hits)??(n==null?void 0:n.skillHits)),e.blocked+=q(n==null?void 0:n.blocked),e.evaded+=q(n==null?void 0:n.evaded),e.glanced+=q(n==null?void 0:n.glanced),e.missed+=q(n==null?void 0:n.missed),e.invulned+=q(n==null?void 0:n.invulned),e.interrupted+=q(n==null?void 0:n.interrupted),e.totalMitigation+=q((n==null?void 0:n.avoided_damage)??(n==null?void 0:n.avoidedDamage)),e.minMitigation+=q((n==null?void 0:n.min_avoided_damage)??(n==null?void 0:n.minAvoidedDamage))},ho=e=>Object.values(e).some(n=>n>0);console.log("[useStatsAggregation] Starting aggregation loop",{validLogsCount:v.length});const Nn=(e,n,t)=>{var r,f,N,C;const l=`s${e}`;if((r=n==null?void 0:n[l])!=null&&r.name)return n[l].name;if((f=n==null?void 0:n[String(e)])!=null&&f.name)return n[String(e)].name;const a=`b${e}`;return(N=t==null?void 0:t[a])!=null&&N.name?t[a].name:(C=t==null?void 0:t[String(e)])!=null&&C.name?t[String(e)].name:`Unknown Skill ${e}`},fn=new Map,nn=e=>{const n=fn.get(e);if(!n)return{hasSkill:!1,avg:1,min:1,hits:0};const t=n.connectedHits||0,l=t>0?n.totalDamage/t:0,a=n.minCount>0?n.minTotal/n.minCount:0;return{hasSkill:!0,avg:l,min:a,hits:t}},En="Ashtonlightstone.9145",ut="Illusionary Warden",$n=[],tn=[],On=[],_n=[],dt=new Map,mt=new Map,ft=(e,n,t)=>{const l=e.get(n)||mn();return l.totalHits+=t.totalHits,l.blocked+=t.blocked,l.evaded+=t.evaded,l.glanced+=t.glanced,l.missed+=t.missed,l.invulned+=t.invulned,l.interrupted+=t.interrupted,e.set(n,l),l};v.forEach(e=>{const n=e.details;if(!n)return;(n.targets||[]).forEach(l=>{const a=(l==null?void 0:l.totalDamageDist)||[],r=Array.isArray(a)?a[0]:null;r==null||r.forEach(f=>{if(!(f!=null&&f.id))return;const N=Number(f.id),C=fn.get(N)||{totalDamage:0,connectedHits:0,minTotal:0,minCount:0};C.totalDamage+=Number(f.totalDamage||0),C.connectedHits+=Number(f.connectedHits||0);const E=Number.isFinite(Number(f.min))?Number(f.min):0;C.minTotal+=E,C.minCount+=1,fn.set(N,C)})})}),v.forEach((e,n)=>{var Dt,Tt;const t=e.details;if(!t)return;const l=t.players;console.log(`[useStatsAggregation] Processing log ${n}:`,{playerCount:l==null?void 0:l.length,hasTargets:!!t.targets,firstPlayer:l!=null&&l[0]?{account:l[0].account,notInSquad:l[0].notInSquad}:"none"});const a=t.targets||[],r=t.skillMap||{},f=t.buffMap||{},N=new Map,C=new Map;a.forEach(i=>{const g=(i==null?void 0:i.totalDamageDist)||[],T=Array.isArray(g)?g[0]:null;T==null||T.forEach(_=>{var Y;if(!(_!=null&&_.id))return;const B=Number(_.id),b=((Y=r==null?void 0:r[B])==null?void 0:Y.name)||_.name||_.skillName||String(B),x=N.get(B)||{totalDamage:0,connectedHits:0,minTotal:0,minCount:0};x.totalDamage+=Number(_.totalDamage||0),x.connectedHits+=Number(_.connectedHits||0);const w=Number.isFinite(Number(_.min))?Number(_.min):0;x.minTotal+=w,x.minCount+=1,N.set(B,x);const L=C.get(b)||{totalDamage:0,connectedHits:0,minTotal:0,minCount:0};L.totalDamage+=Number(_.totalDamage||0),L.connectedHits+=Number(_.connectedHits||0);const pe=Number.isFinite(Number(_.min))?Number(_.min):0;L.minTotal+=pe,L.minCount+=1,C.set(b,L)})});const E=i=>{const g=N.get(i);if(!g||g.connectedHits<=0)return{avg:1,min:1};const T=g.connectedHits>0?g.totalDamage/g.connectedHits:0,_=g.minCount>0?g.minTotal/g.minCount:T;return{avg:T||1,min:_||1}},y=i=>{const g=C.get(i);if(!g||g.connectedHits<=0)return{avg:1,min:1};const T=g.connectedHits>0?g.totalDamage/g.connectedHits:0,_=g.minCount>0?g.minTotal/g.minCount:T;return{avg:T||1,min:_||1}},O=t.combatReplayMetaData||{},Le=(O==null?void 0:O.inchToPixel)>0?O.inchToPixel:1,Ie=(O==null?void 0:O.pollingRate)>0?O.pollingRate:1,Te=5e3,ke=i=>Array.isArray(i)?i.map(g=>Array.isArray(g)?[Number(g[0]),Number(g[1])]:null).filter(g=>!!g&&Number.isFinite(g[0])):[];let A=[],F=t.durationMS||0,fe=!1;const J=l.find(i=>(i==null?void 0:i.hasCommanderTag)&&!(i!=null&&i.notInSquad));(Dt=J==null?void 0:J.combatReplayData)!=null&&Dt.positions&&(A=J.combatReplayData.positions,ke(J.combatReplayData.dead).forEach(([g])=>{g>0&&(fe=!0,F=Math.min(F,g))}));const Se=i=>{var L;const g=(L=i.statsAll)==null?void 0:L[0];if((g==null?void 0:g.distToCom)!==void 0&&(g==null?void 0:g.distToCom)!=="Infinity")return Math.round(Number(g.distToCom));if((g==null?void 0:g.stackDist)!==void 0)return Math.round(Number(g.stackDist))||0;if(i.hasCommanderTag)return 0;const T=i.combatReplayData;if(!(T!=null&&T.positions)||!A.length)return 0;const _=T.positions,B=ke(T.dead),b=ke(T.down),x=Math.floor((T.start||0)/Ie);let w=0;if(B.length&&b.length)for(const[pe]of B){if(pe<0)continue;const Y=Math.max(0,Math.floor(pe/Ie))-x;for(const[H,Q]of b){if(pe!==Q)continue;const R=fe&&H>F?Math.max(1,Math.floor(F/Ie)):Y,ue=Math.max(0,Math.min(R,_.length,A.length));if(ue<=0)continue;let K=0;for(let he=0;he<ue;he++){const[P,se]=_[he],[oe,X]=A[he];K+=Math.hypot(P-oe,se-X)}w=Math.round(K/ue/Le)}}return w},Ke=l.filter(i=>!i.notInSquad),on=l.filter(i=>i.notInSquad);W+=Ke.length,j+=a.filter(i=>!i.isFake).length,yt(l,{durationMS:t.durationMS,buffMap:t.buffMap});const{squadDeaths:d,enemyDeaths:U}=Ne(t);V+=d,re+=U,G+=d,Pe+=U,Ae(t)?ne++:k++;const ge=t.skillMap?Number((Tt=Object.keys(t.skillMap).find(i=>{var g,T;return((T=(g=t.skillMap)==null?void 0:g[i])==null?void 0:T.name)==="Battle Standard"}))==null?void 0:Tt.replace(/^s/,"")):null;l.forEach((i,g)=>{var ye,Je,sn,an,In,gn,pn,St,At,vt,wt,Mt;if(i.notInSquad)return;const T=i.account||"Unknown",_=T!=="Unknown"?T:i.name||"Unknown",B=i.name||"Unknown";de.has(_)||de.set(_,{name:B,account:_,downContrib:0,cleanses:0,strips:0,stab:0,healing:0,barrier:0,cc:0,logsJoined:0,totalDist:0,distCount:0,dodges:0,downs:0,deaths:0,totalFightMs:0,offenseTotals:{},offenseRateWeights:{},defenseActiveMs:0,defenseTotals:{},supportActiveMs:0,supportTotals:{},healingActiveMs:0,healingTotals:{},profession:i.profession||"Unknown",professions:new Set,professionTimeMs:{},isCommander:!1,damage:0,dps:0,revives:0,outgoingConditions:{},incomingConditions:{}});const b=de.get(_);if(i.hasCommanderTag&&(b.isCommander=!0),i.profession&&i.profession!=="Unknown"){b.profession=i.profession,b.professions.add(i.profession);const u=Array.isArray(i.activeTimes)&&typeof i.activeTimes[0]=="number"?i.activeTimes[0]:t.durationMS||0;b.professionTimeMs[i.profession]=(b.professionTimeMs[i.profession]||0)+u}b.logsJoined++,b.downContrib+=Vt(i),b.cleanses+=Wt(i),b.strips+=jt(i,ae),b.healing+=zt(i),b.barrier+=Kt(i),b.cc+=Gt(i,ae),b.stab+=i.stabGeneration||0;const x=Se(i);x<=Te&&(b.totalDist+=x,b.distCount++),(ye=i.defenses)!=null&&ye[0]&&(b.dodges+=i.defenses[0].dodgeCount||0,b.downs+=i.defenses[0].downCount||0,b.deaths+=i.defenses[0].deadCount||0),t.durationMS&&(b.totalFightMs+=t.durationMS);const w=Array.isArray(i.activeTimes)&&typeof i.activeTimes[0]=="number"?i.activeTimes[0]:t.durationMS||0;b.defenseActiveMs+=w,b.supportActiveMs+=w,b.healingActiveMs+=w,Array.isArray(i.buffUptimes)&&i.buffUptimes.length>0&&i.buffUptimes.forEach(u=>{var Nt,Et,Ft,Bt;if(typeof(u==null?void 0:u.id)!="number")return;const m=`b${u.id}`,p=((Nt=t.buffMap)==null?void 0:Nt[m])||((Et=t.buffMap)==null?void 0:Et[String(u.id)]);if(!p||bo(p))return;const $=Number(((Bt=(Ft=u.buffData)==null?void 0:Ft[0])==null?void 0:Bt.uptime)??0);if(!Number.isFinite($)||$<=0)return;const we=(p==null?void 0:p.stacking)??!1,Re=(we?$:$/100)*w;if(!Number.isFinite(Re)||Re<=0)return;const Ee=Zt(p==null?void 0:p.name);if(Ee&&io.has(Ee)&&(!(p!=null&&p.classification)||p.classification==="Condition")){const Pn=Re/1e3,xe=p==null?void 0:p.icon,bn=ve[Ee]||{name:Ee,icon:xe,applications:0,damage:0};bn.applicationsFromUptime=(bn.applicationsFromUptime||0)+Pn,!bn.icon&&xe&&(bn.icon=xe),ve[Ee]=bn;const hn=b.outgoingConditions[Ee]||{applications:0,damage:0,skills:{},icon:xe};hn.applicationsFromUptime=(hn.applicationsFromUptime||0)+Pn,!hn.icon&&xe&&(hn.icon=xe),b.outgoingConditions[Ee]=hn;const Cn=Fe[Ee]||{name:Ee,icon:xe,applications:0,damage:0};Cn.applicationsFromUptime=(Cn.applicationsFromUptime||0)+Pn,!Cn.icon&&xe&&(Cn.icon=xe),Fe[Ee]=Cn;const kn=b.incomingConditions[Ee]||{applications:0,damage:0,skills:{},icon:xe};kn.applicationsFromUptime=(kn.applicationsFromUptime||0)+Pn,!kn.icon&&xe&&(kn.icon=xe),b.incomingConditions[Ee]=kn}Ge.has(m)||Ge.set(m,{name:p==null?void 0:p.name,stacking:we,icon:p==null?void 0:p.icon}),Ve.has(m)||Ve.set(m,new Map);const Ze=Ve.get(m),ln=b.account||i.account||i.name||"Unknown";let Qe=Ze.get(ln);Qe||(Qe={account:ln,profession:b.profession||i.profession||"Unknown",professions:new Set,professionTimeMs:{},totalMs:0,durationMs:0},Ze.set(ln,Qe));const un=i.profession||b.profession;un&&un!=="Unknown"&&(Qe.professions.add(un),Qe.professionTimeMs[un]=(Qe.professionTimeMs[un]||0)+w,Qe.profession=un),Qe.totalMs+=Re,Qe.durationMs+=w}),(Je=i.defenses)!=null&&Je[0]&&ao.forEach(u=>{const m=Number(i.defenses[0][u.field]??0);Number.isFinite(m)&&(b.defenseTotals[u.id]=(b.defenseTotals[u.id]||0)+m)}),(sn=i.support)!=null&&sn[0]&&ro.forEach(u=>{let m=Number(i.support[0][u.field]??0);Number.isFinite(m)&&(Ue.has(u.field)&&m>999999&&(m=0),b.supportTotals[u.id]=(b.supportTotals[u.id]||0)+m)});const L=(u,m)=>{Number.isFinite(m)&&(b.healingTotals[u]=(b.healingTotals[u]||0)+m)},pe=(u,m)=>Array.isArray(u)?u.reduce((p,$)=>p+Number(($==null?void 0:$[m])??0),0):0,Y=(u,m,p)=>{if(!Number.isFinite(p)||p<=0)return;const $=l[m],we=m===g,Ye=$==null?void 0:$.notInSquad,Re=!Ye,Ee=Re&&($==null?void 0:$.group)!=null&&$.group===i.group;L(u,p),Re&&L(`squad${u[0].toUpperCase()}${u.slice(1)}`,p),Ee&&L(`group${u[0].toUpperCase()}${u.slice(1)}`,p),we&&L(`self${u[0].toUpperCase()}${u.slice(1)}`,p),Ye&&L(`offSquad${u[0].toUpperCase()}${u.slice(1)}`,p)};if(Array.isArray(i.rotation)){let u=0;i.rotation.forEach(m=>{var $;if(!(m!=null&&m.id)||!uo(m.id,t.skillMap))return;const p=(($=m.skills)==null?void 0:$.length)||0;p>0&&(u+=p,L(`resUtility_s${m.id}`,p))}),u>0&&L("resUtility",u)}const H=(an=i.extHealingStats)==null?void 0:an.outgoingHealingAllies;Array.isArray(H)&&H.forEach((u,m)=>{const p=pe(u,"healing"),$=pe(u,"downedHealing");Y("healing",m,p),Y("downedHealing",m,$)});const Q=(In=i.extBarrierStats)==null?void 0:In.outgoingBarrierAllies;Array.isArray(Q)&&Q.forEach((u,m)=>{const p=pe(u,"barrier");Y("barrier",m,p)});const R=(gn=i.statsAll)==null?void 0:gn[0],ue=(pn=i.dpsAll)==null?void 0:pn[0],K=(St=i.support)==null?void 0:St[0];if(so.forEach(u=>{if(u.id==="downContributionPercent"||!u.field)return;let m=0,p=0;u.source==="dpsAll"&&ue?m=Number(ue[u.field]??0):u.source==="statsAll"&&R?(m=Number(R[u.field]??0),p=Number(R[u.denomField||u.weightField||"connectedDamageCount"]??0)):u.source==="support"&&K?m=Number(K[u.field]??0):i.statsTargets&&i.statsTargets.forEach($=>{$!=null&&$[0]&&(m+=Number($[0][u.field]??0),p+=Number($[0][u.denomField||u.weightField||"connectedDamageCount"]??0))}),Number.isFinite(m)&&(b.offenseTotals[u.id]=(b.offenseTotals[u.id]||0)+m,u.isRate&&p>0&&(b.offenseRateWeights[u.id]=(b.offenseRateWeights[u.id]||0)+p))}),i.targetDamageDist&&Number.isFinite(ge)){const u=i.targetDamageDist.flatMap(m=>m||[]).flatMap(m=>m||[]).reduce((m,p)=>p!=null&&p.id&&p.id===ge?m+((p==null?void 0:p.connectedHits)||0):m,0);b.offenseTotals.battleStandardHits=(b.offenseTotals.battleStandardHits||0)+u}b.revives+=((vt=(At=i.support)==null?void 0:At[0])==null?void 0:vt.resurrects)||0,ue&&(b.damage+=ue.damage||0,b.dps+=ue.dps||0);const he=u=>{var we,Ye,Re,Ee;let m=`Skill ${u.id}`;const p=((we=t.skillMap)==null?void 0:we[`s${u.id}`])||((Ye=t.skillMap)==null?void 0:Ye[`${u.id}`]);let $=p==null?void 0:p.icon;if(p!=null&&p.name&&(m=p.name),m.startsWith("Skill ")){const Ze=Dn(m,u.id,t.buffMap);Ze&&(m=Ze,$=((Ee=(Re=t.buffMap)==null?void 0:Re[`b${u.id}`])==null?void 0:Ee.icon)||$)}return{name:m,icon:$}},P=u=>{if(!(u!=null&&u.id))return;const{name:m,icon:p}=he(u);ce[u.id]||(ce[u.id]={name:m,icon:p,damage:0,hits:0,downContribution:0}),ce[u.id].name.startsWith("Skill ")&&!m.startsWith("Skill ")&&(ce[u.id].name=m),!ce[u.id].icon&&p&&(ce[u.id].icon=p),ce[u.id].damage+=u.totalDamage,ce[u.id].hits+=u.connectedHits,ce[u.id].downContribution+=Number(u.downContribution||0)},se=i.account||i.name||"Unknown",oe=i.profession||"Unknown",X=`${se}|${oe}`;let be=He.get(X);be||(be={key:X,account:se,displayName:se,profession:oe,professionList:[oe],totalFightMs:0,skills:new Map},He.set(X,be)),be.professionList.includes(oe)||be.professionList.push(oe),be.totalFightMs+=t.durationMS||0;const $e=u=>{if(!(u!=null&&u.id))return;const{name:m,icon:p}=he(u),$=`s${u.id}`;let we=be.skills.get($);we||(we={id:$,name:m,icon:p,damage:0,downContribution:0},be.skills.set($,we)),we.name.startsWith("Skill ")&&!m.startsWith("Skill ")&&(we.name=m),!we.icon&&p&&(we.icon=p),we.damage+=Number(u.totalDamage||0),we.downContribution+=Number(u.downContribution||0)};ie==="total"?(wt=i.totalDamageDist)==null||wt.forEach(u=>{u==null||u.forEach(m=>{P(m),$e(m)})}):(Mt=i.targetDamageDist)==null||Mt.forEach(u=>{u==null||u.forEach(m=>{m==null||m.forEach(p=>{P(p),$e(p)})})}),i.totalDamageTaken&&i.totalDamageTaken.forEach(u=>{u==null||u.forEach(m=>{var Ye,Re,Ee,Ze;if(!(m!=null&&m.id))return;let p=`Skill ${m.id}`;const $=((Ye=t.skillMap)==null?void 0:Ye[`s${m.id}`])||((Re=t.skillMap)==null?void 0:Re[`${m.id}`]);let we=$==null?void 0:$.icon;if($!=null&&$.name&&(p=$.name),p.startsWith("Skill ")){const ln=Dn(p,m.id,t.buffMap);ln&&(p=ln,we=((Ze=(Ee=t.buffMap)==null?void 0:Ee[`b${m.id}`])==null?void 0:Ze.icon)||we)}me[m.id]||(me[m.id]={name:p,icon:we,damage:0,hits:0}),(!me[m.id].name.startsWith("Skill ")||p.startsWith("Skill "))&&(me[m.id].name=p),!me[m.id].icon&&we&&(me[m.id].icon=we),me[m.id].damage+=m.totalDamage,me[m.id].hits+=m.hits})})}),on.forEach(i=>{const g=cn(i.profession||i.name);g&&(De[g]=(De[g]||0)+1)});const te=oo({players:l,targets:a,skillMap:t.skillMap,buffMap:t.buffMap,getPlayerKey:i=>i.account&&i.account!=="Unknown"?i.account:i.name||null}),le=Zn(t.buffMap);Object.entries(te.playerConditions).forEach(([i,g])=>{const T=de.get(i);T&&Object.entries(g).forEach(([_,B])=>{const b=T.outgoingConditions[_]||{applications:0,damage:0,skills:{},icon:B.icon};b.applications+=Number(B.applications||0),b.damage+=Number(B.damage||0),B.applicationsFromBuffs&&(b.applicationsFromBuffs=(b.applicationsFromBuffs||0)+B.applicationsFromBuffs),B.applicationsFromBuffsActive&&(b.applicationsFromBuffsActive=(b.applicationsFromBuffsActive||0)+B.applicationsFromBuffsActive),Object.entries(B.skills||{}).forEach(([x,w])=>{const L=b.skills[x]||{name:w.name,hits:0,damage:0,icon:w.icon};L.hits+=Number(w.hits||0),L.damage+=Number(w.damage||0),!L.icon&&w.icon&&(L.icon=w.icon),b.skills[x]=L}),!b.icon&&B.icon&&(b.icon=B.icon),T.outgoingConditions[_]=b})}),Object.entries(te.summary).forEach(([i,g])=>{const T=ve[i]||{name:g.name||i,icon:g.icon,applications:0,damage:0};T.applications+=Number(g.applications||0),T.damage+=Number(g.damage||0),g.applicationsFromBuffs&&(T.applicationsFromBuffs=(T.applicationsFromBuffs||0)+g.applicationsFromBuffs),g.applicationsFromBuffsActive&&(T.applicationsFromBuffsActive=(T.applicationsFromBuffsActive||0)+g.applicationsFromBuffsActive),!T.icon&&g.icon&&(T.icon=g.icon),ve[i]=T}),Ke.forEach(i=>{const g=i.account&&i.account!=="Unknown"?i.account:i.name||"Unknown",T=de.get(g);!T||!i.totalDamageTaken||i.totalDamageTaken.forEach(_=>_==null?void 0:_.forEach(B=>{var he,P,se,oe,X,be;if(!(B!=null&&B.id))return;let b=`Skill ${B.id}`;const x=((he=t.skillMap)==null?void 0:he[`s${B.id}`])||((P=t.skillMap)==null?void 0:P[`${B.id}`]);x!=null&&x.name&&(b=x.name);const w=Dn(b,B.id,t.buffMap);if(!w)return;const L=(oe=(se=t.buffMap)==null?void 0:se[`b${B.id}`])==null?void 0:oe.name,pe=le.get(w)||((be=(X=t.buffMap)==null?void 0:X[`b${B.id}`])==null?void 0:be.icon),Y=(x==null?void 0:x.icon)||pe;b.startsWith("Skill ")&&(L||w)&&(b=L||w);const H=Number(B.hits??0),Q=Number(B.totalDamage??0),R=Fe[w]||{name:w,icon:pe,applications:0,damage:0};R.applications+=Number.isFinite(H)?H:0,R.damage+=Number.isFinite(Q)?Q:0,!R.icon&&pe&&(R.icon=pe),Fe[w]=R;const ue=T.incomingConditions[w]||{applications:0,damage:0,skills:{},icon:pe};ue.applications+=Number.isFinite(H)?H:0,ue.damage+=Number.isFinite(Q)?Q:0;const K=ue.skills[b]||{name:b,hits:0,damage:0,icon:Y};K.hits+=Number.isFinite(H)?H:0,K.damage+=Number.isFinite(Q)?Q:0,!K.icon&&Y&&(K.icon=Y),ue.skills[b]=K,!ue.icon&&pe&&(ue.icon=pe),T.incomingConditions[w]=ue}))});const qe=t.player_damage_mitigation||t.playerDamageMitigation,Xe=qe&&typeof qe=="object"&&Object.keys(qe).length>0;Xe&&Object.entries(qe).forEach(([i,g])=>{if(!g||typeof g!="object")return;const T=at(i),_=rt(wn,T.account,T);Object.values(g).forEach(B=>{q((B==null?void 0:B.avoided_damage)??(B==null?void 0:B.avoidedDamage))<=0||lt(_.mitigationTotals,B)})});const Bn=t.player_minion_damage_mitigation||t.playerMinionDamageMitigation,zn=Bn&&typeof Bn=="object"&&Object.keys(Bn).length>0;zn&&Object.entries(Bn).forEach(([i,g])=>{if(!g||typeof g!="object")return;const T=at(i);Object.entries(g).forEach(([_,B])=>{if(!B||typeof B!="object")return;const b=`${T.account}::${_}`,x=ct(Mn,b,{...T,minion:String(_||"Unknown")});Object.values(B).forEach(w=>{lt(x.mitigationTotals,w)})})}),(!Xe||!zn)&&(Xe||Ke.forEach(i=>{const g=(i==null?void 0:i.totalDamageTaken)||[];if(!Array.isArray(g)||g.length===0)return;const T=i.account||i.name||"Unknown",_={account:T,name:i.name||T,profession:cn(i.profession||"Unknown")};rt(wn,T,_);const B=t.skillMap||{},b=t.buffMap||{},x=Array.isArray(g)?g[0]:null;if(x==null||x.forEach(w=>{if(!(w!=null&&w.id))return;const L=q(w.blocked),pe=q(w.evaded),Y=q(w.glance??w.glanced),H=q(w.missed),Q=q(w.invulned),R=q(w.interrupted),ue=q(w.hits??w.connectedHits),K=Number(w.id),he=Nn(K,B,b);if(ft(dt,`${T}::${K}`,{totalHits:ue,blocked:L,evaded:pe,glanced:Y,missed:H,invulned:Q,interrupted:R}),T===En){const P=fn.get(K),se=nn(K),oe=se.hasSkill?se.hits>0?se.avg:0:1,X=se.hasSkill?se.min||0:1,be=se.hits>0?Y*oe/2+(L+pe+H+Q+R)*oe:0,$e=se.hits>0?Y*X/2+(L+pe+H+Q+R)*X:0;On.push({logId:e.filePath||e.id||n,skillId:w.id,skillName:he,blocked:L,evaded:pe,glanced:Y,missed:H,invulned:Q,interrupted:R,totalAvoids:L+pe+Y+H+Q+R,avg:oe,min:X,enemyHits:(P==null?void 0:P.connectedHits)??0,enemyTotalDmg:(P==null?void 0:P.totalDamage)??0,avoidDmg:be,avoidMinDmg:$e})}}),T===En){const w=(L,pe)=>{let Y=0,H=0,Q=0;if(!Array.isArray(L))return{total:Y,minTotal:H,hits:Q};for(const R of L){if(!(R!=null&&R.id))continue;const ue=q(R.blocked),K=q(R.evaded),he=q(R.glance??R.glanced),P=q(R.missed),se=q(R.invulned),oe=q(R.interrupted),X=Nn(Number(R.id),r,f),be=pe(Number(R.id),X);(be.hits??0)>0&&(Y+=he*be.avg/2+(ue+K+P+se+oe)*be.avg,H+=he*be.min/2+(ue+K+P+se+oe)*be.min),Q+=q(R.hits??R.connectedHits)}return{total:Y,minTotal:H,hits:Q}};_n.push({logId:e.filePath||e.id||n,variant:"current_global_name_taken0",...w(x,(L,pe)=>{const Y=nn(L),H=Y.hasSkill?Y.hits>0?Y.avg:0:1,Q=Y.hasSkill?Y.min||0:1;return{avg:H,min:Q,hits:Y.hits}})})}}),zn||Ke.forEach(i=>{const g=(i==null?void 0:i.minions)||[];if(!Array.isArray(g)||g.length===0)return;const T=i.account||i.name||"Unknown",_={account:T,name:i.name||T,profession:cn(i.profession||"Unknown")},B=t.skillMap||{},b=t.buffMap||{};g.forEach(x=>{const w=(x==null?void 0:x.totalDamageTakenDist)||[];if(!Array.isArray(w)||w.length===0)return;let L=String((x==null?void 0:x.name)||"Unknown").replace(/^Juvenile\s+/i,"")||"Unknown";L.toUpperCase().includes("UNKNOWN")&&(L="Unknown");const pe=`${T}::${L}`;ct(Mn,pe,{..._,minion:L});const Y=Array.isArray(w)?w[0]:null;if(Y==null||Y.forEach(H=>{if(!(H!=null&&H.id))return;const Q=q(H.blocked),R=q(H.evaded),ue=q(H.glance??H.glanced),K=q(H.missed),he=q(H.invulned),P=q(H.interrupted),se=q(H.hits??H.connectedHits),oe=Number(H.id),X=Nn(oe,B,b);if(ft(mt,`${pe}::${oe}`,{totalHits:se,blocked:Q,evaded:R,glanced:ue,missed:K,invulned:he,interrupted:P}),T===En&&L===ut){const be=fn.get(oe),$e=nn(oe),ye=$e.hasSkill?$e.hits>0?$e.avg:0:1,Je=$e.hasSkill?$e.min||0:1,sn=$e.hits>0?ue*ye/2+(Q+R+K+he+P)*ye:0,an=$e.hits>0?ue*Je/2+(Q+R+K+he+P)*Je:0;$n.push({logId:e.filePath||e.id||n,skillId:H.id,skillName:X,blocked:Q,evaded:R,glanced:ue,missed:K,invulned:he,interrupted:P,totalAvoids:Q+R+ue+K+he+P,avg:ye,min:Je,enemyHits:(be==null?void 0:be.connectedHits)??0,enemyTotalDmg:(be==null?void 0:be.totalDamage)??0,avoidDmg:sn,avoidMinDmg:an})}}),T===En&&L===ut){const H=(K,he)=>{let P=0,se=0,oe=0;if(!Array.isArray(K))return{total:P,minTotal:se,hits:oe};for(const X of K){if(!(X!=null&&X.id))continue;const be=q(X.blocked),$e=q(X.evaded),ye=q(X.glance??X.glanced),Je=q(X.missed),sn=q(X.invulned),an=q(X.interrupted),In=Nn(Number(X.id),r,f),{avg:gn,min:pn}=he(Number(X.id),In);q(X.hits??X.connectedHits)>0&&(P+=ye*gn/2+(be+$e+Je+sn+an)*gn,se+=ye*pn/2+(be+$e+Je+sn+an)*pn),oe+=q(X.hits??X.connectedHits)}return{total:P,minTotal:se,hits:oe}},Q=Array.isArray(w)?w[0]||[]:[],R=Array.isArray(w)?w.flat():[],ue=Array.isArray(x==null?void 0:x.totalDamageTaken)?x.totalDamageTaken[0]||[]:[];tn.push({logId:e.filePath||e.id||n,variant:"current_global_name_dist0",...H(Q,(K,he)=>{const P=nn(K),se=P.hasSkill?P.hits>0?P.avg:0:1,oe=P.hasSkill&&P.min||0;return{avg:se,min:oe}})}),tn.push({logId:e.filePath||e.id||n,variant:"local_name_dist0",...H(Q,(K,he)=>y(he))}),tn.push({logId:e.filePath||e.id||n,variant:"local_id_dist0",...H(Q,K=>E(K))}),tn.push({logId:e.filePath||e.id||n,variant:"global_name_alllists",...H(R,(K,he)=>{const P=nn(K),se=P.hasSkill?P.hits>0?P.avg:0:1,oe=P.hasSkill&&P.min||0;return{avg:se,min:oe}})}),tn.push({logId:e.filePath||e.id||n,variant:"global_name_taken0",...H(ue,(K,he)=>{const P=nn(K),se=P.hasSkill?P.hits>0?P.avg:0:1,oe=P.hasSkill&&P.min||0;return{avg:se,min:oe}})})}})}))}),$n.length>0&&(console.groupCollapsed("[Mitigation Debug] Ashtonlightstone.9145 / Illusionary Warden"),console.table($n),tn.length>0&&console.table(tn),console.groupEnd()),On.length>0&&(console.groupCollapsed("[Mitigation Debug] Ashtonlightstone.9145 / Player"),console.table(On),_n.length>0&&console.table(_n),console.groupEnd());const gt=(e,n)=>{const t=new Map,l=a=>{let r=t.get(a);return r||(r=mn(),t.set(a,r)),r};n.forEach((a,r)=>{const f=r.lastIndexOf("::"),N=f>-1?r.slice(0,f):r,C=f>-1?Number(r.slice(f+2)):Number.NaN,E=Number.isFinite(C)?nn(C):{hasSkill:!1,avg:0,min:0,hits:0};if(!E.hasSkill||E.hits<=0)return;const y=E.avg,O=E.min,Le=a.glanced*y/2+(a.blocked+a.evaded+a.missed+a.invulned+a.interrupted)*y,Ie=a.glanced*O/2+(a.blocked+a.evaded+a.missed+a.invulned+a.interrupted)*O;if(Le<=0)return;const Te=l(N);Te.totalHits+=a.totalHits,Te.blocked+=a.blocked,Te.evaded+=a.evaded,Te.glanced+=a.glanced,Te.missed+=a.missed,Te.invulned+=a.invulned,Te.interrupted+=a.interrupted,Te.totalMitigation+=Le,Te.minMitigation+=Ie}),e.forEach((a,r)=>{const f=t.get(r)||mn();a.mitigationTotals.totalHits=f.totalHits,a.mitigationTotals.blocked=f.blocked,a.mitigationTotals.evaded=f.evaded,a.mitigationTotals.glanced=f.glanced,a.mitigationTotals.missed=f.missed,a.mitigationTotals.invulned=f.invulned,a.mitigationTotals.interrupted=f.interrupted,a.mitigationTotals.totalMitigation=f.totalMitigation,a.mitigationTotals.minMitigation=f.minMitigation})};gt(wn,dt),gt(Mn,mt);const Co=M>0?Math.round(W/M):0,ko=M>0?Math.round(j/M):0,Do=V>0?(re/V).toFixed(2):re>0?"∞":"0.00",To=Pe>0?(G/Pe).toFixed(2):G>0?"∞":"0.00",pt=(e,n)=>{const l=e.filter(f=>Number.isFinite(f.value)&&(n?f.value>0:f.value>=0)).sort((f,N)=>{const C=n?N.value-f.value:f.value-N.value;return C!==0?C:f.account.localeCompare(N.account)});let a=null,r=0;return l.map((f,N)=>((a===null||f.value!==a)&&(r=N+1,a=f.value),{rank:r,...f}))},Rn=Array.from(de.values()).map(e=>{const n=Array.from(e.professions).filter(t=>t!=="Unknown");if(e.professionList=n,n.length>0){let t=n[0],l=e.professionTimeMs[t]||0;n.forEach(a=>{const r=e.professionTimeMs[a]||0;r>l&&(l=r,t=a)}),e.profession=t}return{key:e.account,stat:e}}),bt=e=>{const n=de.get(e.account);if(!n){const a=e.professionList.length>0?e.professionList:e.profession?[e.profession]:[];return{...e,professionList:a}}const t=n.professionList&&n.professionList.length>0?n.professionList:Array.from(n.professions||[]).filter(a=>a&&a!=="Unknown"),l=n.profession||e.profession;return{...e,profession:l,professionList:t.length>0?t:l?[l]:[],activeMs:n.defenseActiveMs||n.totalFightMs||e.activeMs}},So=Array.from(wn.values()).map(bt).filter(e=>ho(e.mitigationTotals)).sort((e,n)=>e.account.localeCompare(n.account)),Ao=Array.from(Mn.values()).map(bt).filter(e=>e.mitigationTotals.totalMitigation>0).sort((e,n)=>{const t=e.account.localeCompare(n.account);return t!==0?t:String(e.minion||"").localeCompare(String(n.minion||""))}),Fn=(e,n)=>{switch(n){case"downContrib":return e.downContrib;case"barrier":return e.barrier;case"healing":return e.healing;case"dodges":return e.dodges;case"strips":return e.strips;case"cleanses":return e.cleanses;case"cc":return e.cc;case"stability":return e.stab;case"revives":return e.revives;case"dps":return e.dps;case"damage":return e.damage;case"participation":return e.logsJoined;case"closestToTag":return!e.isCommander&&e.distCount>0?e.totalDist/e.distCount:Number.POSITIVE_INFINITY;default:return 0}},_e=(e,n)=>pt(Rn.map(({stat:t})=>({account:t.account,profession:t.profession,professionList:t.professionList,value:Fn(t,e),count:t.logsJoined})),n),Me={downContrib:_e("downContrib",!0),barrier:_e("barrier",!0),healing:_e("healing",!0),dodges:_e("dodges",!0),strips:_e("strips",!0),cleanses:_e("cleanses",!0),cc:_e("cc",!0),stability:_e("stability",!0),revives:_e("revives",!0),participation:_e("participation",!0),dps:_e("dps",!0),damage:_e("damage",!0),closestToTag:_e("closestToTag",!1).filter(e=>Number.isFinite(e.value))},vo={downContrib:"downContrib",barrier:"barrier",healing:"healing",dodges:"dodges",strips:"strips",cleanses:"cleanses",cc:"cc",stability:"stability",closestToTag:"closestToTag"},Ce=e=>{const n=e==null?void 0:e[0];return{value:(n==null?void 0:n.value)??0,player:(n==null?void 0:n.account)??"-",count:(n==null?void 0:n.count)??0,profession:(n==null?void 0:n.profession)??"Unknown",professionList:(n==null?void 0:n.professionList)??[]}},ze={maxDownContrib:Ce([]),maxBarrier:Ce([]),maxHealing:Ce([]),maxDodges:Ce([]),maxStrips:Ce([]),maxCleanses:Ce([]),maxCC:Ce([]),maxStab:Ce([]),closestToTag:Ce([])},je={},wo=(e,n)=>{if(n==="closestToTag")return Fn(e,n);const t=Math.max(1,(e.totalFightMs||0)/1e3);return Fn(e,n)/t};Object.values(vo).forEach(e=>{const n=e!=="closestToTag";je[e]=pt(Rn.map(({stat:t})=>({account:t.account,profession:t.profession,professionList:t.professionList,value:wo(t,e),count:t.logsJoined})),n)}),ze.maxDownContrib=Ce(je.downContrib),ze.maxBarrier=Ce(je.barrier),ze.maxHealing=Ce(je.healing),ze.maxDodges=Ce(je.dodges),ze.maxStrips=Ce(je.strips),ze.maxCleanses=Ce(je.cleanses),ze.maxCC=Ce(je.cc),ze.maxStab=Ce(je.stability),ze.closestToTag=Ce(je.closestToTag);const Mo={maxDownContrib:Ce(Me.downContrib),maxBarrier:Ce(Me.barrier),maxHealing:Ce(Me.healing),maxDodges:Ce(Me.dodges),maxStrips:Ce(Me.strips),maxCleanses:Ce(Me.cleanses),maxCC:Ce(Me.cc),maxStab:Ce(Me.stability),closestToTag:Ce(Me.closestToTag)};let qn={player:"None",account:"None",score:-1,profession:"Unknown",professionList:[],color:"#64748b",topStats:[]},ht,Ct,kt=0;if(Z!=null&&Z.showMvp){const e={"Down Contribution":"downContribution",Healing:"healing",Cleanses:"cleanses",Strips:"strips",Stability:"stability",CC:"cc",Revives:"revives","Distance to Tag":"distanceToTag",Participation:"participation",Dodging:"dodging",DPS:"dps",Damage:"damage"},n=r=>{const f=e[r];return f?Number(I[f]||0)>0:!1},t=[],l=r=>[...r||[]].filter(f=>n(f==null?void 0:f.name)).sort((f,N)=>N.ratio-f.ratio||f.rank-N.rank||f.name.localeCompare(N.name)).slice(0,3),a=r=>{var N;if(!r)return;const f=l(r.contribs);return{...r,player:r.name,reason:((N=f[0])==null?void 0:N.name)||"Top Performance",topStats:f}};Rn.forEach(({stat:r})=>{let f=0;const N=[],C=(E,y,O,Le,Ie=!0)=>{var ke,A;if(O<=0)return;const Te=((ke=y[0])==null?void 0:ke.value)||0;if(Te&&Number.isFinite(E)&&(Ie?E>0:E<Number.POSITIVE_INFINITY)){const F=Ie?E/Te:Te/E;f+=F*O;const fe=((A=y.find(J=>J.account===r.account))==null?void 0:A.rank)||0;N.push({name:Le,ratio:F,val:E.toLocaleString(),rank:fe})}};C(r.downContrib,Me.downContrib,I.downContribution,"Down Contribution"),C(r.healing,Me.healing,I.healing,"Healing"),C(r.cleanses,Me.cleanses,I.cleanses,"Cleanses"),C(r.strips,Me.strips,I.strips,"Strips"),C(r.stab,Me.stability,I.stability,"Stability"),C(r.cc,Me.cc,I.cc,"CC"),C(r.revives,Me.revives,I.revives,"Revives"),C(Fn(r,"closestToTag"),Me.closestToTag,I.distanceToTag,"Distance to Tag",!1),C(r.logsJoined,Me.participation,I.participation,"Participation"),C(r.dodges,Me.dodges,I.dodging,"Dodging"),C(r.dps,Me.dps,I.dps,"DPS"),C(r.damage,Me.damage,I.damage,"Damage"),t.push({...r,score:f,contribs:N.filter(E=>n(E.name))})}),t.sort((r,f)=>f.score-r.score),t[0]&&t[0].score>0&&(qn=a(t[0])||qn),ht=a(t[1]),Ct=a(t[2]),kt=t.length>0?t.reduce((r,f)=>r+f.score,0)/t.length:0}const No=Object.values(ce).sort((e,n)=>{const t=D==="downContribution"?e.downContribution:e.damage;return(D==="downContribution"?n.downContribution:n.damage)-t}).slice(0,25),Eo=Object.values(me).sort((e,n)=>n.damage-e.damage).slice(0,25),Fo=e=>{const n=String(e).replace(/^Detailed\s*WvW\s*-\s*/i,"").replace(/^World\s*vs\s*World\s*-\s*/i,"").replace(/^WvW\s*-\s*/i,"").trim(),t=n.match(/^(Red|Blue|Green)\s+(?:Alpine|Desert)?\s*Borderlands$/i);return t?`${t[1]} Borderlands`:n||"Unknown"},xn=(e,n)=>Fo((e==null?void 0:e.zone)||(e==null?void 0:e.mapName)||(e==null?void 0:e.map)||(e==null?void 0:e.location)||(e==null?void 0:e.fightName)||(n==null?void 0:n.fightName)||(n==null?void 0:n.encounterName)||"Unknown"),Bo=(e,n)=>{const t=(n==null?void 0:n.permalink)||(e==null?void 0:e.permalink);if(typeof t=="string"&&t.trim().length>0)return t.trim();const l=e==null?void 0:e.uploadLinks;if(!Array.isArray(l))return"";for(const a of l){if(typeof a=="string"&&a.trim().length>0)return a.trim();if(a&&typeof a=="object"){const r=a.permalink||a.link||a.url||a.reportLink;if(typeof r=="string"&&r.trim().length>0)return r.trim()}}return""},Wn={};v.forEach(e=>{const n=xn(e==null?void 0:e.details,e);Wn[n]=(Wn[n]||0)+1});const Io=Object.entries(Wn).map(([e,n])=>{const t=String(e).trim(),l=/eternal battlegrounds|^ebg$/i.test(t);let a="#64748b";return l?a="#ffffff":/red/i.test(t)?a="#ef4444":/blue/i.test(t)?a="#3b82f6":/green/i.test(t)&&(a="#22c55e"),{name:e,value:n,color:a}}).sort((e,n)=>n.value-e.value),{boonTables:Po}=Pt(v),Uo=v.map((e,n)=>{var l,a;const t=((l=e.details)==null?void 0:l.players)||[];return{index:n+1,label:`Log ${n+1}`,timestamp:en(e.details,e),squadCount:t.filter(r=>!r.notInSquad).length,friendlyCount:t.length,enemies:((a=e.details)==null?void 0:a.targets).filter(r=>!r.isFake).length}}).sort((e,n)=>e.timestamp-n.timestamp),jn={};Array.from(de.values()).forEach(e=>{e.profession&&e.profession!=="Unknown"&&(jn[e.profession]=(jn[e.profession]||0)+1)});const Ho=Object.entries(jn).map(([e,n])=>({name:e,value:n,color:et(e)})).sort((e,n)=>n.value-e.value),Vn={};Object.keys(De).length===0&&v.forEach(e=>{var n,t;(t=(n=e.details)==null?void 0:n.targets)==null||t.forEach(l=>{if(l.isFake)return;const a=l.profession&&l.profession!=="Unknown"?l.profession:l.name||l.id||"Unknown",r=cn(a);Vn[r]=(Vn[r]||0)+1})});const Lo=Object.keys(De).length>0?De:Vn,$o=Object.entries(Lo).map(([e,n])=>({name:e,value:n,color:et(e)})).sort((e,n)=>n.value-e.value),Oo=v.map((e,n)=>({log:e,originalIndex:n})).sort((e,n)=>en(e.log.details,e.log)-en(n.log.details,n.log)).map(({log:e},n)=>{const t=e.details;if(!t)return null;const l=t.players||[],a=l.filter(d=>!d.notInSquad),r=l.filter(d=>d.notInSquad),f=t.targets||[],N=f.filter(d=>!d.isFake),C=a.reduce((d,U)=>{var z,ge;return d+(((ge=(z=U.dpsAll)==null?void 0:z[0])==null?void 0:ge.damage)||0)},0),E=a.reduce((d,U)=>{var z,ge;return d+(((ge=(z=U.defenses)==null?void 0:z[0])==null?void 0:ge.damageTaken)||0)},0),{enemyDeaths:y,enemyDownsDeaths:O}=Ne(t),Le=Ae(t),Ie=en(t,e),Te=xn(t,e),ke={red:0,green:0,blue:0},A=d=>{const U=Number(d);return Number.isFinite(U)?U:0},F=d=>{if(!d||typeof d!="object")return;const U=d.teamID??d.teamId??d.team??d.teamColor??d.team_color;if(U!=null)return U;const z=Object.keys(d).find(ge=>/^team/i.test(ge));return z?d[z]:void 0},fe=(d,U)=>{if(d==null)return null;if(typeof d=="string"){const z=d.toLowerCase();return z.includes("red")?"red":z.includes("green")?"green":z.includes("blue")?"blue":z==="r"?"red":z==="g"?"green":z==="b"?"blue":null}if(typeof d=="number")if(U==="zeroBased"){if(d===0)return"red";if(d===1)return"green";if(d===2)return"blue"}else{if(d===1)return"red";if(d===2)return"green";if(d===3)return"blue"}return null},J=(d,U)=>{const z={};return d.forEach(ge=>{const te=U(ge),le=cn(te);le&&(z[le]=(z[le]||0)+1)}),z},Se=J(a,d=>(d==null?void 0:d.profession)||(d==null?void 0:d.name)),Ke=J(r,d=>(d==null?void 0:d.profession)||(d==null?void 0:d.name)),on=J(N,d=>(d==null?void 0:d.profession)||(d==null?void 0:d.name)||(d==null?void 0:d.id));if(t.teamCounts&&typeof t.teamCounts=="object"){const d=t.teamCounts;ke.red=A(d.red??d.r??d[0]??d[1]),ke.green=A(d.green??d.g??d[1]??d[2]),ke.blue=A(d.blue??d.b??d[2]??d[3])}else{const d=[];f.forEach(te=>{if(te!=null&&te.isFake)return;const le=F(te);le!=null&&d.push(le)}),l.forEach(te=>{if(!(te!=null&&te.notInSquad))return;const le=F(te);le!=null&&d.push(le)}),d.length===0&&l.forEach(te=>{const le=F(te);le!=null&&d.push(le)});const U=new Set;d.forEach(te=>{typeof te=="number"&&U.add(te)});const z=U.has(0)?"zeroBased":U.has(3)?"oneBased":"zeroBased";if(d.forEach(te=>{const le=fe(te,z);le&&(ke[le]+=1)}),ke.red+ke.green+ke.blue===0&&d.length>0){const te=new Map;d.forEach(qe=>{const Xe=String(qe);te.set(Xe,(te.get(Xe)||0)+1)});const le=Array.from(te.values()).sort((qe,Xe)=>Xe-qe);ke.red=le[0]||0,ke.green=le[1]||0,ke.blue=le[2]||0}ke.red+ke.green+ke.blue===0&&(ke.red=Math.max(N.length,l.filter(te=>te==null?void 0:te.notInSquad).length))}return{id:e.filePath||`fight-${n}`,label:e.encounterName||`Fight ${n+1}`,permalink:Bo(t,e),timestamp:Ie,mapName:Te,duration:mo(t.durationMS),isWin:Le,squadCount:a.length,allyCount:r.length,enemyCount:N.length,teamCounts:ke,alliesDown:a.reduce((d,U)=>{var z,ge;return d+(((ge=(z=U.defenses)==null?void 0:z[0])==null?void 0:ge.downCount)||0)},0),alliesDead:a.reduce((d,U)=>{var z,ge;return d+(((ge=(z=U.defenses)==null?void 0:z[0])==null?void 0:ge.deadCount)||0)},0),alliesRevived:a.reduce((d,U)=>{var z,ge;return Number(((ge=(z=U.statsAll)==null?void 0:z[0])==null?void 0:ge.saved)||0)>0?d+1:d},0),rallies:0,enemyDeaths:y,enemyDowns:Math.max(0,O-y),totalOutgoingDamage:C,totalIncomingDamage:E,incomingBarrierAbsorbed:a.reduce((d,U)=>{var z,ge;return d+(((ge=(z=U.defenses)==null?void 0:z[0])==null?void 0:ge.damageBarrier)||0)},0),outgoingBarrierAbsorbed:a.reduce((d,U)=>{var te;const z=(te=U.extBarrierStats)==null?void 0:te.outgoingBarrier;if(!Array.isArray(z))return d;let ge=0;return z.forEach(le=>{if(Array.isArray(le)){le.forEach(qe=>{ge+=Number((qe==null?void 0:qe.barrier)||0)});return}ge+=Number((le==null?void 0:le.barrier)||0)}),d+ge},0),squadClassCountsFight:Se,allyClassCountsFight:Ke,enemyClassCounts:on}}).filter(Boolean),_o=(e,n)=>{const t=(n==null?void 0:n.skillMap)||{},l=(n==null?void 0:n.buffMap)||{};let a=0,r="";const f=C=>{const E=Number(C);if(!Number.isFinite(E))return String(C||"Unknown Skill");const y=(t==null?void 0:t[`s${E}`])||(t==null?void 0:t[`${E}`]);if(y!=null&&y.name)return String(y.name);const O=(l==null?void 0:l[`b${E}`])||(l==null?void 0:l[`${E}`]);return O!=null&&O.name?String(O.name):`Skill ${E}`},N=C=>{if(!C||typeof C!="object")return;const E=[Number(C.max),Number(C.maxDamage),Number(C.maxHit),Number(C.totalDamage)>0&&Number(C.connectedHits)>0?Number(C.totalDamage)/Number(C.connectedHits):0].filter(O=>Number.isFinite(O)),y=E.length>0?Math.max(...E):0;y>a&&(a=y,r=f(C.id))};return Array.isArray(e==null?void 0:e.totalDamageDist)&&e.totalDamageDist.forEach(C=>{Array.isArray(C)&&C.forEach(E=>N(E))}),Array.isArray(e==null?void 0:e.targetDamageDist)&&e.targetDamageDist.forEach(C=>{Array.isArray(C)&&C.forEach(E=>{Array.isArray(E)&&E.forEach(y=>N(y))})}),{peak:a,skillName:r||"Unknown Skill"}},Ro=(()=>{const e=r=>String(r||"").replace(/^Detailed\s*WvW\s*-\s*/i,"").replace(/^World\s*vs\s*World\s*-\s*/i,"").replace(/^WvW\s*-\s*/i,"").trim(),n=[],t=new Map,l=(r,f)=>{const N=A=>{if(!Array.isArray(A)||A.length===0)return[];const F=[];for(let fe=0;fe<A.length;fe+=1){const J=Number(A[fe]||0),Se=fe>0?Number(A[fe-1]||0):0;F.push(Math.max(0,J-Se))}return F},C=(A,F)=>{if(!Array.isArray(A)||A.length===0||F<=0)return 0;let fe=0,J=0;for(let Se=0;Se<A.length;Se+=1)fe+=Number(A[Se]||0),Se>=F&&(fe-=Number(A[Se-F]||0)),Se>=F-1&&fe>J&&(J=fe);return Math.max(0,J)},E=A=>{if(!Array.isArray(A))return[];const F=A.reduce((J,Se)=>Math.max(J,Array.isArray(Se)?Se.length:0),0);if(F<=0)return[];const fe=new Array(F).fill(0);return A.forEach(J=>{if(Array.isArray(J))for(let Se=0;Se<F;Se+=1)fe[Se]+=Number(J[Se]||0)}),fe},y=A=>Array.isArray(A)?A.map(F=>Number(F||0)):null,Le=(A=>{if(!Array.isArray(A)||A.length===0)return null;const F=A[0];if(!Array.isArray(F))return null;if(Array.isArray(F[0])&&Array.isArray(F[0][0]))return E(F);if(Array.isArray(F[0])&&!Array.isArray(F[0][0])){const fe=A.map(J=>y(Array.isArray(J)?J[0]:null)).filter(J=>Array.isArray(J)&&J.length>0);if(fe.length>0)return E(fe)}return null})(r==null?void 0:r.targetDamage1S),Ie=Array.isArray(r==null?void 0:r.damage1S)&&Array.isArray(r.damage1S[0])?r.damage1S[0]:null,Te=Le||(Array.isArray(Ie)?Ie.map(A=>Number(A||0)):[]),ke=N(Te);return C(ke,f)};v.map(r=>({log:r,ts:en(r==null?void 0:r.details,r)})).sort((r,f)=>r.ts-f.ts).forEach(({log:r},f)=>{const N=r==null?void 0:r.details;if(!N)return;const C=e(N.fightName||r.fightName||`Fight ${f+1}`),E=xn(N,r),y=E?`${C} - ${e(E)}`:C,O={};(Array.isArray(N.players)?N.players:[]).forEach(A=>{if(A!=null&&A.notInSquad)return;const F=String((A==null?void 0:A.account)||(A==null?void 0:A.name)||"Unknown"),fe=String((A==null?void 0:A.profession)||"Unknown"),J=`${F}|${fe}`,Se=_o(A,N),Ke=Number(Se.peak||0),on=Number(l(A,1)||0),d=Number(l(A,5)||0);O[J]={hit:Ke,burst1s:on,burst5s:d,skillName:Se.skillName};const U=t.get(J)||{key:J,account:F,displayName:F,profession:fe,professionList:[fe],logs:0,peakHit:0,peak1s:0,peak5s:0,peakFightLabel:"",peakSkillName:""};U.logs+=1,U.professionList.includes(fe)||U.professionList.push(fe),Ke>U.peakHit&&(U.peakHit=Ke,U.peakFightLabel=y,U.peakSkillName=Se.skillName),on>U.peak1s&&(U.peak1s=on),d>U.peak5s&&(U.peak5s=d),t.set(J,U)});const Ie=Object.values(O).reduce((A,F)=>Math.max(A,Number((F==null?void 0:F.hit)||0)),0),Te=Object.values(O).reduce((A,F)=>Math.max(A,Number((F==null?void 0:F.burst1s)||0)),0),ke=Object.values(O).reduce((A,F)=>Math.max(A,Number((F==null?void 0:F.burst5s)||0)),0);n.push({id:r.filePath||r.id||`fight-${f+1}`,shortLabel:`F${f+1}`,fullLabel:y,values:O,maxHit:Ie,max1s:Te,max5s:ke})});const a=Array.from(t.values()).sort((r,f)=>f.peakHit!==r.peakHit?f.peakHit-r.peakHit:r.displayName.localeCompare(f.displayName));return{fights:n,players:a}})(),qo=Array.from(Ve.entries()).map(([e,n])=>{const t=Ge.get(e)||{},l=Array.from(n.values()).map(a=>{var y;const r=Array.from(a.professions||[]).filter(O=>O&&O!=="Unknown");let f=a.profession||"Unknown";if(r.length>0){f=r[0];let O=((y=a.professionTimeMs)==null?void 0:y[f])||0;r.forEach(Le=>{var Te;const Ie=((Te=a.professionTimeMs)==null?void 0:Te[Le])||0;Ie>O&&(O=Ie,f=Le)})}const N=a.durationMs||0,C=a.totalMs/1e3,E=N>0?a.totalMs/N:0;return{account:a.account,profession:f,professionList:r,total:C,perSecond:E,duration:N/1e3}}).filter(a=>a.total>0||a.perSecond>0);return{id:e,name:t.name||e,icon:t.icon,rows:l}}).filter(e=>e.rows.length>0),xo=Array.from(He.values()).map(e=>{const n=Array.from(e.skills.values()).sort((l,a)=>a.damage-l.damage),t=n.reduce((l,a)=>(l[a.id]=a,l),{});return{key:e.key,account:e.account,displayName:e.displayName,profession:e.profession,professionList:e.professionList,totalFightMs:e.totalFightMs,skills:n,skillMap:t}}).sort((e,n)=>e.displayName.localeCompare(n.displayName));return{total:M,wins:ne,losses:k,avgSquadSize:Co,avgEnemies:ko,squadKDR:Do,enemyKDR:To,totalSquadKills:re,totalSquadDeaths:V,totalEnemyKills:G,totalEnemyDeaths:Pe,leaderboards:Me,...Mo,outgoingConditionSummary:Object.values(ve).sort((e,n)=>n.damage-e.damage),incomingConditionSummary:Object.values(Fe).sort((e,n)=>n.damage-e.damage),outgoingConditionPlayers:Array.from(de.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,conditions:e.outgoingConditions})),incomingConditionPlayers:Array.from(de.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,conditions:e.incomingConditions})),topSkills:No,topIncomingSkills:Eo,playerSkillBreakdowns:xo,topSkillsMetric:D,mapData:Io,timelineData:Uo,boonTables:Po,offensePlayers:Array.from(de.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,offenseTotals:e.offenseTotals,offenseRateWeights:e.offenseRateWeights,totalFightMs:e.totalFightMs})),defensePlayers:Array.from(de.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,defenseTotals:e.defenseTotals,activeMs:e.defenseActiveMs})),damageMitigationPlayers:So,damageMitigationMinions:Ao,supportPlayers:Array.from(de.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,supportTotals:e.supportTotals,activeMs:e.supportActiveMs})),healingPlayers:Array.from(de.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,healingTotals:e.healingTotals,activeMs:e.healingActiveMs})),mvp:qn,silver:ht,bronze:Ct,squadClassData:Ho,enemyClassData:$o,fightBreakdown:Oo,spikeDamage:Ro,specialTables:qo,topStatsPerSecond:ze,topStatsLeaderboardsPerSecond:je,avgMvpScore:kt}})(),Oe=(()=>{const ae=new Map,ie=new Map,D=[],M=new Map,ne=new Map;v.forEach(W=>{const j=W.details;if(!j)return;const V=j.skillMap||{},re=j.fightName||"Log",Pe=en(j,W)||Date.now(),G={id:W.filePath||W.id||re,label:re,timestamp:Pe,skillEntries:{},playerActiveSeconds:{},durationSeconds:j.durationMS?j.durationMS/1e3:0};(j.players||[]).forEach(Ae=>{if(Ae.notInSquad)return;const de=Ae.account||Ae.name||"Unknown",Ue=Ae.profession||"Unknown",ce=`${de}|${Ue}`;let me=ie.get(ce);me||(me={key:ce,account:de,displayName:de,profession:Ue,professionList:[Ue],logs:0,totalActiveSeconds:0,skillTotals:{}},ie.set(ce,me)),me.logs++;const He=(Array.isArray(Ae.activeTimes)?Ae.activeTimes[0]:0)/1e3;me.totalActiveSeconds=(me.totalActiveSeconds||0)+He,G.playerActiveSeconds[ce]=He,(Ae.rotation||[]).forEach(ve=>{var Sn,An,vn;if(!(ve!=null&&ve.id))return;const Fe=((Sn=ve.skills)==null?void 0:Sn.length)||0;if(Fe<=0)return;const De=`s${ve.id}`,Ge=((An=V[De])==null?void 0:An.name)||`Skill ${ve.id}`,Ve=(vn=V[De])==null?void 0:vn.icon;me.skillTotals[De]=(me.skillTotals[De]||0)+Fe,ae.set(De,(ae.get(De)||0)+Fe),M.set(De,Ge),Ve&&!ne.has(De)&&ne.set(De,Ve),G.skillEntries[De]||(G.skillEntries[De]={name:Ge,icon:Ve,players:{}}),!G.skillEntries[De].icon&&Ve&&(G.skillEntries[De].icon=Ve),G.skillEntries[De].players[ce]=(G.skillEntries[De].players[ce]||0)+Fe})}),D.push(G)});const k=Array.from(ae.entries()).map(([W,j])=>({id:W,name:M.get(W)||W,total:j,icon:ne.get(W)})).sort((W,j)=>j.total-W.total);return{logRecords:D,players:Array.from(ie.values()),skillOptions:k,resUtilitySkills:[]}})();return{validLogs:v,stats:Be,skillUsageData:Oe}};let We=null,rn=!1,nt=null,tt=0,ot=0,Hn=null;const it=o=>{if(!o||typeof o!="object")return o;const s=(h,S)=>{const v={};return S.forEach(Z=>{h&&Object.prototype.hasOwnProperty.call(h,Z)&&(v[Z]=h[Z])}),v},c=s(o,["players","targets","durationMS","uploadTime","timeStart","timeStartStd","timeEnd","timeEndStd","fightName","success","teamCounts","combatReplayMetaData","skillMap","buffMap","encounterDuration","player_damage_mitigation","player_minion_damage_mitigation","playerDamageMitigation","playerMinionDamageMitigation"]);return Array.isArray(c.players)&&(c.players=c.players.map(h=>s(h,["name","display_name","character_name","profession","elite_spec","group","dpsAll","statsAll","dpsTargets","statsTargets","defenses","support","rotation","extHealingStats","extBarrierStats","squadBuffVolumes","selfBuffs","groupBuffs","squadBuffs","selfBuffsActive","groupBuffsActive","squadBuffsActive","buffUptimes","totalDamageDist","targetDamageDist","damage1S","targetDamage1S","totalDamageTaken","totalDamageTakenDist","minions","combatReplayData","hasCommanderTag","notInSquad","account","activeTimes"]))),Array.isArray(c.targets)&&(c.targets=c.targets.map(h=>s(h,["id","name","isFake","dpsAll","statsAll","defenses","totalHealth","healthPercentBurned","enemyPlayer","totalDamageDist"]))),c},po=o=>{if(!o||typeof o!="object")return o;const s={...o};return o.details?s.details=it(o.details):s.details=it(o),s},st=()=>{if(!rn||!We)return;rn=!1,tt+=1;const o=Hn;Hn=null;const s=go(We);self.postMessage({type:"result",result:s,computeId:tt,logCount:We.logs.length,token:ot,completedAt:Date.now(),flushId:o})},Ln=()=>{nt===null&&(nt=setInterval(()=>{st()},5e3))};self.onmessage=o=>{var c,h,S,v;const s=o.data;if((s==null?void 0:s.type)==="reset"){We={logs:[]},typeof s.token=="number"&&(ot=s.token),rn=!0,Ln();return}if((s==null?void 0:s.type)==="settings"){We={logs:(We==null?void 0:We.logs)||[],precomputedStats:(c=s.payload)==null?void 0:c.precomputedStats,mvpWeights:(h=s.payload)==null?void 0:h.mvpWeights,statsViewSettings:(S=s.payload)==null?void 0:S.statsViewSettings,disruptionMethod:(v=s.payload)==null?void 0:v.disruptionMethod},rn=!0,Ln();return}if((s==null?void 0:s.type)==="log"){We||(We={logs:[]}),We.logs.push(po(s.payload)),rn=!0,Ln();return}(s==null?void 0:s.type)==="flush"&&(typeof s.flushId=="number"&&(Hn=s.flushId),rn=!0,st())}})();
