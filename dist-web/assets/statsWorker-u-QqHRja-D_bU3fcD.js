(function(){"use strict";const Xt=["selfBuffs","groupBuffs","squadBuffs"],Zt=i=>i!=null&&i.classification?i.classification==="Boon":!0,yt=i=>`b${i}`,zn=(i,c)=>{const f=Array.isArray(i==null?void 0:i.activeTimes)?i.activeTimes:[],E=typeof f[0]=="number"?f[0]:0;return E>0?E:c},en=(i,c,f,E,q,W,Se)=>{const ie=i==="selfBuffs"?1:Math.max(i==="groupBuffs"?W-1:Se-1,0);return!ie||!q?{generationMs:0,wastedMs:0}:c?{generationMs:f*q*ie,wastedMs:E*q*ie}:{generationMs:f/100*q*ie,wastedMs:E/100*q*ie}},Vn=i=>{const c=new Map,f=new Map;return i.forEach(W=>{const Se=W.details;if(!Se)return;const ie=Se.durationMS||0,Ce=Se.buffMap||{};Object.entries(Ce).forEach(([j,Y])=>{if(!c.has(j)){c.set(j,Y);return}const ke=c.get(j)||{},de={name:ke.name||Y.name,stacking:ke.stacking??Y.stacking,icon:ke.icon||Y.icon,classification:ke.classification||Y.classification};c.set(j,de)});const Je=(Se.players||[]).filter(j=>!j.notInSquad),Te=Je.length,De=new Map;Je.forEach(j=>{const Y=j.group??0;De.set(Y,(De.get(Y)||0)+1)}),Je.forEach(j=>{const Y=j.account||j.name||j.character_name||"Unknown",ke=j.profession||"Unknown",de=j.group??0,R=De.get(de)||1,ue=zn(j,ie);f.has(Y)||f.set(Y,{account:Y,profession:ke,professions:new Set,professionTimeMs:{},activeTimeMs:0,numFights:0,groupSupported:0,squadSupported:0,boons:{}});const fe=f.get(Y);fe.profession=ke,ke!=="Unknown"&&(fe.professions.add(ke),fe.professionTimeMs[ke]=(fe.professionTimeMs[ke]||0)+ue),fe.activeTimeMs+=ue,fe.numFights+=1,fe.groupSupported+=R,fe.squadSupported+=Te,Xt.forEach(pe=>{(j[pe]||[]).forEach(he=>{var Ue,Re,Pe,st;if(typeof(he==null?void 0:he.id)!="number")return;const He=yt(he.id),Ee=Ce[He];if(!Zt(Ee))return;const Ne=(Ee==null?void 0:Ee.stacking)??!1,ze=((Re=(Ue=he.buffData)==null?void 0:Ue[0])==null?void 0:Re.generation)??0,Ae=((st=(Pe=he.buffData)==null?void 0:Pe[0])==null?void 0:st.wasted)??0,{generationMs:Me,wastedMs:Ve}=en(pe,Ne,ze,Ae,ie,R,Te);!Me&&!Ve||(c.has(He)||c.set(He,Ee||{}),fe.boons[He]||(fe.boons[He]={selfBuffs:{generationMs:0,wastedMs:0},groupBuffs:{generationMs:0,wastedMs:0},squadBuffs:{generationMs:0,wastedMs:0}}),fe.boons[He][pe].generationMs+=Me,fe.boons[He][pe].wastedMs+=Ve)})})})}),{boonTables:Array.from(c.keys()).filter(W=>Zt(c.get(W))).map(W=>{const Se=c.get(W)||{},ie=[];return f.forEach(Ce=>{var j;const Oe=Ce.boons[W];if(!Oe||!Xt.some(Y=>Oe[Y].generationMs>0||Oe[Y].wastedMs>0))return;const Te=Array.from(Ce.professions||[]).filter(Y=>Y&&Y!=="Unknown");let De=Ce.profession;if(Te.length>0){De=Te[0];let Y=((j=Ce.professionTimeMs)==null?void 0:j[De])||0;Te.forEach(ke=>{var R;const de=((R=Ce.professionTimeMs)==null?void 0:R[ke])||0;de>Y&&(Y=de,De=ke)})}ie.push({account:Ce.account,profession:De||"Unknown",professionList:Te,activeTimeMs:Ce.activeTimeMs||1,numFights:Ce.numFights||1,groupSupported:Ce.groupSupported||1,squadSupported:Ce.squadSupported||1,categories:{selfBuffs:{...Oe.selfBuffs},groupBuffs:{...Oe.groupBuffs},squadBuffs:{...Oe.squadBuffs}}})}),{id:W,name:Se.name||W,icon:Se.icon,stacking:Se.stacking??!1,rows:ie}}).filter(W=>W.rows.length>0)}},tn=(i,c,f,E,q,W,Se={})=>{var j,Y,ke,de;const Ce=((i==null?void 0:i[c])||[]).find(R=>R.id===f);if(!Ce)return{generationMs:0,wastedMs:0};const Oe=Se[yt(f)],Je=(Oe==null?void 0:Oe.stacking)??!1,Te=((Y=(j=Ce.buffData)==null?void 0:j[0])==null?void 0:Y.generation)??0,De=((de=(ke=Ce.buffData)==null?void 0:ke[0])==null?void 0:de.wasted)??0;return en(c,Je,Te,De,E,q,W)};var Kn={methods:{tiered:{tiers:{shortMs:500,mediumMs:1500,weights:{short:.5,medium:1,long:2}}}}};const Gn=Kn,Ot="count",Yn=i=>(i||0)/1e3,Jn=(i,c)=>{var q;if(!i)return 0;const f=(q=Gn.methods.tiered)==null?void 0:q.tiers;if(!f)return i;const E=c/Math.max(i,1);return E<=f.shortMs?i*f.weights.short:E<=f.mediumMs?i*f.weights.medium:i*f.weights.long},nn=(i,c,f)=>f==="duration"?Yn(c):f==="tiered"?Jn(i,c):i;function Qn(i,c=Ot){var W;const f=(W=i.statsAll)==null?void 0:W[0],E=Number((f==null?void 0:f.appliedCrowdControl)??0),q=Number((f==null?void 0:f.appliedCrowdControlDuration)??0);return nn(E,q,c)}function Xn(i,c){const f=(c==null?void 0:c.durationMS)||0,E=(c==null?void 0:c.buffMap)||{},q=i.filter(ie=>!ie.notInSquad),W=q.length,Se=new Map;q.forEach(ie=>{const Ce=ie.group??0;Se.set(Ce,(Se.get(Ce)||0)+1)}),q.forEach(ie=>{const Ce=Se.get(ie.group??0)||1,Oe=tn(ie,"selfBuffs",1122,f,Ce,W,E),Je=tn(ie,"squadBuffs",1122,f,Ce,W,E);ie.stabGeneration=(Oe.generationMs+Je.generationMs)/1e3})}function Zn(i){if(!i.statsTargets)return 0;let c=0;for(const f of i.statsTargets)f&&f.length>0&&(c+=f[0].downContribution||0);return c}function yn(i){if(!i.extBarrierStats||!i.extBarrierStats.outgoingBarrierAllies)return 0;let c=0;for(const f of i.extBarrierStats.outgoingBarrierAllies)if(f)for(const E of f)E&&(c+=E.barrier||0);return c}function ei(i){if(!i.extHealingStats||!i.extHealingStats.outgoingHealingAllies)return 0;let c=0;for(const f of i.extHealingStats.outgoingHealingAllies)if(f)for(const E of f)E&&(c+=E.healing||0);return c}const ti=i=>{var c,f,E,q;return(((f=(c=i.support)==null?void 0:c[0])==null?void 0:f.condiCleanse)||0)+(((q=(E=i.support)==null?void 0:E[0])==null?void 0:q.condiCleanseSelf)||0)},ni=(i,c=Ot)=>{var W;const f=(W=i.support)==null?void 0:W[0],E=Number((f==null?void 0:f.boonStrips)??0),q=Number((f==null?void 0:f.boonStripsTime)??0);return nn(E,q,c)},ii=i=>Zn(i),oi=i=>ei(i),si=i=>yn(i),ai=(i,c=Ot)=>Qn(i,c),ri=(i,c)=>Xn(i,c),ci="count",li={downContribution:1,healing:1,cleanses:1,strips:1,stability:1,cc:.7,revives:.7,distanceToTag:.7,participation:.7,dodging:.4,dps:.2,damage:.2},ui={showMvp:!0,topSkillDamageSource:"target",topSkillsMetric:"damage"},on=new Map([["bleeding","Bleeding"],["burning","Burning"],["confusion","Confusion"],["poison","Poison"],["torment","Torment"],["vulnerability","Vulnerability"],["weakness","Weakness"],["weakened","Weakness"],["blind","Blind"],["blinded","Blind"],["blinding","Blind"],["cripple","Cripple"],["crippled","Cripple"],["chill","Chill"],["chilled","Chill"],["immob","Immobilize"],["immobile","Immobilize"],["immobilized","Immobilize"],["slow","Slow"],["slowed","Slow"],["fear","Fear"],["feared","Fear"],["taunt","Taunt"],["taunted","Taunt"]]),mi={Blind:"https://render.guildwars2.com/file/09770136BB76FD0DBE1CC4267DEED54774CB20F6/102837.png",Chill:"https://render.guildwars2.com/file/28C4EC547A3516AF0242E826772DA43A5EAC3DF3/102839.png",Cripple:"https://render.guildwars2.com/file/070325E519C178D502A8160523766070D30C0C19/102838.png",Fear:"https://render.guildwars2.com/file/30307A6E766D74B6EB09EDA12A4A2DE50E4D76F4/102869.png",Immobilize:"https://render.guildwars2.com/file/397A613651BFCA2832B6469CE34735580A2C120E/102844.png",Slow:"https://render.guildwars2.com/file/F60D1EF5271D7B9319610855676D320CD25F01C6/961397.png",Taunt:"https://render.guildwars2.com/file/02EED459AD65FAF7DF32A260E479C625070841B9/1228472.png",Vulnerability:"https://render.guildwars2.com/file/3A394C1A0A3257EB27A44842DDEEF0DF000E1241/102850.png",Weakness:"https://render.guildwars2.com/file/6CB0E64AF9AA292E332A38C1770CE577E2CDE0E8/102853.png"},pt=i=>{if(!i)return null;const c=i.trim().toLowerCase(),f=on.get(c);if(f)return f;const E=c.split(/[^a-z]+/).filter(Boolean);for(const q of E){const W=on.get(q);if(W)return W}return null},di=i=>pt(i),sn=i=>{const c=new Map;return i&&(Object.values(i).forEach(f=>{if(!(f!=null&&f.icon)||!(f!=null&&f.name))return;const E=pt(f.name);E&&(c.has(E)||c.set(E,f.icon))}),Object.entries(mi).forEach(([f,E])=>{c.has(f)||c.set(f,E)})),c},vt=(i,c,f)=>{var E;if(c&&f){const q=(E=f[`b${c}`])==null?void 0:E.name,W=pt(q);if(W)return W}return i?pt(i):null},fi=i=>{const c=(i==null?void 0:i.account)||"Unknown";return c&&c!=="Unknown"?c:(i==null?void 0:i.name)||"Unknown"||null},gi=i=>{if(!i||i.length===0)return 0;let c=0,f=null;return i.forEach(E=>{const q=Number(E[1]??0);if(Number.isFinite(q)){if(f===null){f=q;return}q>f&&(c+=q-f),f=q}}),c},pi=i=>{if(!i||i.length===0)return 0;let c=0;return i.forEach(f=>{const E=Number(f[0]??0),q=Number(f[1]??0);Number.isFinite(q)&&E!==0&&q>0&&(c+=1)}),c},hi=i=>{const{players:c,targets:f,skillMap:E,buffMap:q}=i,W=i.getPlayerKey||fi,Se=sn(q),ie={},Ce={};c.forEach(j=>{if(j!=null&&j.notInSquad)return;const Y=W(j);Y&&(ie[Y]||(ie[Y]={}),j!=null&&j.totalDamageDist&&j.totalDamageDist.forEach(ke=>{ke&&ke.forEach(de=>{if(!de.id)return;let R=`Skill ${de.id}`,ue;E&&(E[`s${de.id}`]?(R=E[`s${de.id}`].name||R,ue=E[`s${de.id}`].icon||ue):E[`${de.id}`]&&(R=E[`${de.id}`].name||R,ue=E[`${de.id}`].icon||ue));const fe=vt(R,de.id,q);if(!fe)return;const pe=q==null?void 0:q[`b${de.id}`],_e=pe==null?void 0:pe.name,he=Se.get(fe)||(pe==null?void 0:pe.icon),He=R.startsWith("Skill ")?_e||fe:R,Ee=ue||(pe==null?void 0:pe.icon),Ne=Number(de.connectedHits??0),ze=Number(de.hits??0),Ae=Ne>0?Ne:ze,Me=Number(de.totalDamage??0);if(!Number.isFinite(Ae)&&!Number.isFinite(Me))return;const Ve=Ce[fe]||{name:fe,icon:he,applications:0,damage:0};Ve.applications+=Number.isFinite(Ae)?Ae:0,Ve.damage+=Number.isFinite(Me)?Me:0,!Ve.icon&&he&&(Ve.icon=he),Ce[fe]=Ve;const Ue=ie[Y][fe]||{icon:he,applications:0,damage:0,skills:{}};Ue.applications+=Number.isFinite(Ae)?Ae:0,Ue.damage+=Number.isFinite(Me)?Me:0;const Re=Ue.skills[He]||{name:He,hits:0,damage:0,icon:Ee};Re.hits+=Number.isFinite(Ae)?Ae:0,Re.damage+=Number.isFinite(Me)?Me:0,!Re.icon&&Ee&&(Re.icon=Ee),Ue.skills[He]=Re,!Ue.icon&&he&&(Ue.icon=he),ie[Y][fe]=Ue})}))});const Oe=new Map;c.forEach(j=>{if(j!=null&&j.notInSquad)return;const Y=W(j);Y&&j!=null&&j.name&&Oe.set(j.name,Y)});let Je=0,Te=0,De=0;return f.forEach(j=>{j!=null&&j.buffs&&j.buffs.forEach(Y=>{const ke=Number(Y==null?void 0:Y.id);if(!Number.isFinite(ke))return;const de=q==null?void 0:q[`b${ke}`],R=pt(de==null?void 0:de.name);if(!R||de!=null&&de.classification&&de.classification!=="Condition")return;const ue=R;if(!ue)return;const fe=Y.statesPerSource||{};De+=1,Object.entries(fe).forEach(([pe,_e])=>{var Ae;const he=Oe.get(pe);if(!he)return;Te+=1;const He=gi(_e),Ee=pi(_e);Je+=He;const Ne=((Ae=ie[he])==null?void 0:Ae[ue])||{applications:0,damage:0,skills:{}};Ne.applicationsFromBuffs=(Ne.applicationsFromBuffs||0)+He,Ne.applicationsFromBuffsActive=(Ne.applicationsFromBuffsActive||0)+Ee,ie[he]=ie[he]||{},ie[he][ue]=Ne;const ze=Ce[ue]||{name:ue,applications:0,damage:0};ze.applicationsFromBuffs=(ze.applicationsFromBuffs||0)+He,ze.applicationsFromBuffsActive=(ze.applicationsFromBuffsActive||0)+Ee,Ce[ue]=ze})})}),Object.values(ie).forEach(j=>{Object.values(j).forEach(Y=>{typeof Y.applicationsFromBuffs=="number"&&(Y.applications=Y.applicationsFromBuffs)})}),Object.values(Ce).forEach(j=>{typeof j.applicationsFromBuffs=="number"&&(j.applications=j.applicationsFromBuffs)}),{playerConditions:ie,summary:Ce,meta:{buffStateApplicationsTotal:Je,targetBuffEntriesSeen:De,buffStateSourcesSeen:Te}}},bi=new Set(["Vulnerability","Weakness","Blind","Cripple","Chill","Immobilize","Slow","Fear","Taunt"]),ki=[{id:"damage",label:"Damage",field:"damage",source:"dpsAll"},{id:"directDmg",label:"Direct Damage",field:"directDmg",source:"statsTargets"},{id:"connectedDamageCount",label:"Connected Damage Count",field:"connectedDamageCount",source:"statsTargets"},{id:"connectedDirectDamageCount",label:"Connected Direct Damage Count",field:"connectedDirectDamageCount",source:"statsTargets"},{id:"battleStandardHits",label:"Battle Standard Tracking"},{id:"criticalRate",label:"Critical Rate",field:"criticalRate",isRate:!0,isPercent:!0,denomField:"critableDirectDamageCount",source:"statsTargets"},{id:"criticalDmg",label:"Critical Damage",field:"criticalDmg",source:"statsTargets"},{id:"flankingRate",label:"Flanking Rate",field:"flankingRate",isRate:!0,isPercent:!0,denomField:"connectedDirectDamageCount",source:"statsTargets"},{id:"glanceRate",label:"Glance Rate",field:"glanceRate",isRate:!0,isPercent:!0,denomField:"connectedDirectDamageCount",source:"statsTargets"},{id:"missed",label:"Missed",field:"missed",source:"statsTargets"},{id:"evaded",label:"Evaded (enemy)",field:"evaded",source:"statsTargets"},{id:"blocked",label:"Blocked (enemy)",field:"blocked",source:"statsTargets"},{id:"interrupts",label:"Interrupts",field:"interrupts",source:"statsTargets"},{id:"invulned",label:"Invulned",field:"invulned",source:"statsTargets"},{id:"killed",label:"Killed",field:"killed",source:"statsTargets"},{id:"downed",label:"Downed",field:"downed",source:"statsTargets"},{id:"downContribution",label:"Down Contribution",field:"downContribution",source:"statsTargets"},{id:"downContributionPercent",label:"Down Contribution %",isRate:!0,isPercent:!0},{id:"againstDownedDamage",label:"Against Downed Damage",field:"againstDownedDamage",source:"statsTargets"},{id:"appliedCrowdControl",label:"Applied CC",field:"appliedCrowdControl",source:"statsTargets"},{id:"appliedCrowdControlDuration",label:"Applied CC Duration",field:"appliedCrowdControlDuration",source:"statsTargets"},{id:"appliedCrowdControlDownContribution",label:"Applied CC Down Contribution",field:"appliedCrowdControlDownContribution",source:"statsTargets"},{id:"appliedCrowdControlDurationDownContribution",label:"Applied CC Duration Down Contribution",field:"appliedCrowdControlDurationDownContribution",source:"statsTargets"},{id:"boonStrips",label:"Boon Strips",field:"boonStrips",source:"support"}],Si=[{id:"damageTaken",label:"Damage Taken",field:"damageTaken"},{id:"damageTakenCount",label:"Damage Taken Count",field:"damageTakenCount"},{id:"conditionDamageTaken",label:"Condition Damage Taken",field:"conditionDamageTaken"},{id:"conditionDamageTakenCount",label:"Condition Damage Taken Count",field:"conditionDamageTakenCount"},{id:"powerDamageTaken",label:"Power Damage Taken",field:"powerDamageTaken"},{id:"powerDamageTakenCount",label:"Power Damage Taken Count",field:"powerDamageTakenCount"},{id:"downedDamageTaken",label:"Downed Damage Taken",field:"downedDamageTaken"},{id:"downedDamageTakenCount",label:"Downed Damage Taken Count",field:"downedDamageTakenCount"},{id:"damageBarrier",label:"Damage Barrier",field:"damageBarrier"},{id:"damageBarrierCount",label:"Damage Barrier Count",field:"damageBarrierCount"},{id:"blockedCount",label:"Blocked Count",field:"blockedCount"},{id:"evadedCount",label:"Evaded Count",field:"evadedCount"},{id:"missedCount",label:"Missed Count",field:"missedCount"},{id:"dodgeCount",label:"Dodge Count",field:"dodgeCount"},{id:"invulnedCount",label:"Invulnerable Count",field:"invulnedCount"},{id:"interruptedCount",label:"Interrupted Count",field:"interruptedCount"},{id:"downCount",label:"Down Count",field:"downCount"},{id:"deadCount",label:"Death Count",field:"deadCount"},{id:"boonStrips",label:"Boon Strips (Incoming)",field:"boonStrips"},{id:"conditionCleanses",label:"Cleanses (Incoming)",field:"conditionCleanses"},{id:"receivedCrowdControl",label:"Crowd Control (Incoming)",field:"receivedCrowdControl"}],Ci=[{id:"condiCleanse",label:"Condition Cleanses",field:"condiCleanse"},{id:"condiCleanseTime",label:"Condition Cleanse Time",field:"condiCleanseTime",isTime:!0},{id:"condiCleanseSelf",label:"Condition Cleanse Self",field:"condiCleanseSelf"},{id:"condiCleanseTimeSelf",label:"Condition Cleanse Time Self",field:"condiCleanseTimeSelf",isTime:!0},{id:"boonStrips",label:"Boon Strips",field:"boonStrips"},{id:"boonStripsTime",label:"Boon Strips Time",field:"boonStripsTime",isTime:!0},{id:"boonStripDownContribution",label:"Boon Strip Down Contribution",field:"boonStripDownContribution"},{id:"boonStripDownContributionTime",label:"Boon Strip Down Contribution Time",field:"boonStripDownContributionTime",isTime:!0},{id:"stunBreak",label:"Stun Breaks",field:"stunBreak"},{id:"removedStunDuration",label:"Removed Stun Duration",field:"removedStunDuration",isTime:!0},{id:"resurrects",label:"Resurrects",field:"resurrects"},{id:"resurrectTime",label:"Resurrect Time",field:"resurrectTime",isTime:!0}],Di=["battle standard","glyph of renewal","glyph of the stars","illusion of life","spirit of nature","nature spirit","search and rescue","signet of mercy"],Ni=new Set([10244]),Ai=(i,c)=>{var q;if(Ni.has(i))return!0;const f=(c==null?void 0:c[`s${i}`])||(c==null?void 0:c[`${i}`]),E=((q=f==null?void 0:f.name)==null?void 0:q.toLowerCase())||"";return Di.some(W=>E.includes(W))},an=i=>{if(!i||!Number.isFinite(i))return"--:--";const c=Math.max(0,Math.round(i/1e3)),f=Math.floor(c/3600),E=Math.floor(c%3600/60),q=c%60;return f>0?`${f}:${String(E).padStart(2,"0")}:${String(q).padStart(2,"0")}`:`${E}:${String(q).padStart(2,"0")}`},Ft={Guardian:"#72C1D9",Dragonhunter:"#72C1D9",Firebrand:"#72C1D9",Willbender:"#72C1D9",Revenant:"#D16E5A",Herald:"#D16E5A",Renegade:"#D16E5A",Vindicator:"#D16E5A",Warrior:"#FFD166",Berserker:"#FFD166",Spellbreaker:"#FFD166",Bladesworn:"#FFD166",Engineer:"#D09C59",Scrapper:"#D09C59",Holosmith:"#D09C59",Mechanist:"#D09C59",Ranger:"#8CDC82",Druid:"#8CDC82",Soulbeast:"#8CDC82",Untamed:"#8CDC82",Thief:"#C08F95",Daredevil:"#C08F95",Deadeye:"#C08F95",Specter:"#C08F95",Elementalist:"#F68A87",Tempest:"#F68A87",Weaver:"#F68A87",Catalyst:"#F68A87",Mesmer:"#B679D5",Chronomancer:"#B679D5",Mirage:"#B679D5",Virtuoso:"#B679D5",Necromancer:"#52A76F",Reaper:"#52A76F",Scourge:"#52A76F",Harbinger:"#52A76F",Ritualist:"#52A76F",Luminary:"#72C1D9",Conduit:"#D16E5A",Paragon:"#FFD166",Amalgam:"#D09C59",Galeshot:"#8CDC82",Antiquary:"#C08F95",Evoker:"#F68A87",Troubadour:"#B679D5",Unknown:"#64748B"};function rn(i){return Ft[i]||Ft.Unknown}const Ti=i=>{if(i==null||i==="")return 0;if(typeof i=="number")return!Number.isFinite(i)||i<=0?0:i>1e12?i:i*1e3;if(i instanceof Date){const Se=i.getTime();return Number.isFinite(Se)&&Se>0?Se:0}const c=String(i).trim();if(!c)return 0;const f=Number(c);if(Number.isFinite(f)&&f>0)return f>1e12?f:f*1e3;const E=Date.parse(c);if(Number.isFinite(E)&&E>0)return E;const q=c.replace(/([+-]\d{2})$/,"$1:00"),W=Date.parse(q);return Number.isFinite(W)&&W>0?W:0},Ge=(i,c)=>Ti((i==null?void 0:i.uploadTime)??(c==null?void 0:c.uploadTime)??(i==null?void 0:i.timeStartStd)??(i==null?void 0:i.timeStart)??(i==null?void 0:i.timeEndStd)??(i==null?void 0:i.timeEnd)??(i==null?void 0:i.timeStartText)??(i==null?void 0:i.timeEndText)),Mi=({logs:i,precomputedStats:c,mvpWeights:f,statsViewSettings:E,disruptionMethod:q})=>{const W=(()=>{const Te=i.filter(De=>De.details&&De.details.players&&De.details.players.length>0);return console.log("[useStatsAggregation] Filtering logs:",{total:i.length,passed:Te.length,statuses:i.map(De=>De.status),hasDetails:i.map(De=>!!De.details)}),Te})(),Se=E||ui,ie=f||li,Ce=Te=>{if(!Te||typeof Te!="object")return Te;const De=Array.isArray(Te.fightBreakdown)?Te.fightBreakdown:null;if(!De||De.length===0)return Te;const j=R=>Array.isArray(R)&&R.some(ue=>ue&&Number(ue.count)>0),Y=new Map,ke=new Map;i.forEach(R=>{var pe;const ue=(R==null?void 0:R.filePath)||(R==null?void 0:R.id);ue&&Y.set(String(ue),R);const fe=(R==null?void 0:R.permalink)||((pe=R==null?void 0:R.details)==null?void 0:pe.permalink);typeof fe=="string"&&fe.trim()&&ke.set(fe.trim(),R)});const de=De.map(R=>{var He;if(!R||typeof R!="object")return R;const ue=R.id?String(R.id):"",fe=typeof R.permalink=="string"?R.permalink.trim():"",pe=(ue?Y.get(ue):void 0)||(fe?ke.get(fe):void 0);if(!pe)return R;let _e=R;if(Number(R.timestamp)<=0){const Ee=Ge(pe==null?void 0:pe.details,pe);Ee&&(_e={..._e,timestamp:Ee})}const he=(He=pe==null?void 0:pe.details)==null?void 0:He.teamBreakdown;return j(he)&&(_e={..._e,teamBreakdown:he}),_e});return{...Te,fightBreakdown:de}},Oe=(()=>{if(c)return Ce(c);const Te=q||ci,De=Se.topSkillDamageSource||"target",j=Se.topSkillsMetric||"damage",Y=W.length;let ke=0,de=0,R=0,ue=0,fe=0,pe=0,_e=0,he=0;const He=e=>{const n=((e==null?void 0:e.players)||[]).filter($=>!$.notInSquad);let u=0,a=0,D=0,d=0;return n.forEach($=>{var re;const O=(re=$.defenses)==null?void 0:re[0];if(!O)return;const V=Number(O.downCount||0),se=Number(O.deadCount||0);u+=V+se,D+=se}),n.forEach($=>{!$.statsTargets||$.statsTargets.length===0||$.statsTargets.forEach(O=>{const V=O==null?void 0:O[0];if(!V)return;const se=Number(V.downed||0),re=Number(V.killed||0);a+=se+re,d+=re})}),{squadDownsDeaths:u,enemyDownsDeaths:a,squadDeaths:D,enemyDeaths:d}},Ee=e=>{const{squadDownsDeaths:t,enemyDownsDeaths:n}=He(e);return t>0||n>0?n>t:typeof(e==null?void 0:e.success)=="boolean"?e.success:!1},Ne=new Map,ze=new Set(["boonStripsTime","condiCleanseTime","condiCleanseTimeSelf"]),Ae={},Me={},Ve=new Map,Ue={},Re={},Pe={},st=new Map,tt=new Map,Et=new Set(Object.keys(Ft)),Bt=Object.keys(Ft).filter(e=>e&&e!=="Unknown").sort((e,t)=>t.length-e.length),It=["Guardian","Revenant","Warrior","Engineer","Ranger","Thief","Elementalist","Mesmer","Necromancer"],at=e=>{if(!e)return"Unknown";const t=String(e).replace(/\s*\([^)]*\)\s*$/,"").replace(/\s*\[[^\]]*\]\s*$/,"").replace(/\s\d+$/,"").trim();if(Et.has(t))return t;const n=t.toLowerCase();for(const a of Bt)if(n.includes(a.toLowerCase()))return a;return It.find(a=>n.includes(a.toLowerCase()))||t||"Unknown"},vi=e=>e!=null&&e.classification?e.classification==="Boon":!0,Pt=new Map,Ht=new Map,ht=()=>({totalHits:0,blocked:0,evaded:0,glanced:0,missed:0,invulned:0,interrupted:0,totalMitigation:0,minMitigation:0}),me=e=>{const t=Number(e);return Number.isFinite(t)?t:0},fn=e=>{const t=String(e).split("|"),n=t[0]||"Unknown",u=at(t[1]||"Unknown"),a=t[2]||n||"Unknown";return{name:n,profession:u,account:a}},gn=(e,t,n)=>{let u=e.get(t);return u?n.profession&&!u.professionList.includes(n.profession)&&u.professionList.push(n.profession):(u={account:n.account,name:n.name,profession:n.profession,professionList:n.profession?[n.profession]:[],activeMs:0,mitigationTotals:ht()},e.set(t,u)),u},pn=(e,t,n)=>{let u=e.get(t);return u?n.profession&&!u.professionList.includes(n.profession)&&u.professionList.push(n.profession):(u={account:n.account,name:n.name,profession:n.profession,professionList:n.profession?[n.profession]:[],activeMs:0,mitigationTotals:ht(),minion:n.minion},e.set(t,u)),u},hn=(e,t)=>{e.totalHits+=me((t==null?void 0:t.skill_hits)??(t==null?void 0:t.skillHits)),e.blocked+=me(t==null?void 0:t.blocked),e.evaded+=me(t==null?void 0:t.evaded),e.glanced+=me(t==null?void 0:t.glanced),e.missed+=me(t==null?void 0:t.missed),e.invulned+=me(t==null?void 0:t.invulned),e.interrupted+=me(t==null?void 0:t.interrupted),e.totalMitigation+=me((t==null?void 0:t.avoided_damage)??(t==null?void 0:t.avoidedDamage)),e.minMitigation+=me((t==null?void 0:t.min_avoided_damage)??(t==null?void 0:t.minAvoidedDamage))},Fi=e=>Object.values(e).some(t=>t>0);console.log("[useStatsAggregation] Starting aggregation loop",{validLogsCount:W.length});const Ut=(e,t,n)=>{var D,d,$,O;const u=`s${e}`;if((D=t==null?void 0:t[u])!=null&&D.name)return t[u].name;if((d=t==null?void 0:t[String(e)])!=null&&d.name)return t[String(e)].name;const a=`b${e}`;return($=n==null?void 0:n[a])!=null&&$.name?n[a].name:(O=n==null?void 0:n[String(e)])!=null&&O.name?n[String(e)].name:`Unknown Skill ${e}`},bt=new Map,rt=e=>{const t=bt.get(e);if(!t)return{hasSkill:!1,avg:1,min:1,hits:0};const n=t.connectedHits||0,u=n>0?t.totalDamage/n:0,a=t.minCount>0?t.minTotal/t.minCount:0;return{hasSkill:!0,avg:u,min:a,hits:n}},xt="Ashtonlightstone.9145",bn="Illusionary Warden",Wt=[],ct=[],jt=[],zt=[],kn=new Map,Sn=new Map,Cn=(e,t,n)=>{const u=e.get(t)||ht();return u.totalHits+=n.totalHits,u.blocked+=n.blocked,u.evaded+=n.evaded,u.glanced+=n.glanced,u.missed+=n.missed,u.invulned+=n.invulned,u.interrupted+=n.interrupted,e.set(t,u),u};W.forEach(e=>{const t=e.details;if(!t)return;(t.targets||[]).forEach(u=>{const a=(u==null?void 0:u.totalDamageDist)||[],D=Array.isArray(a)?a[0]:null;D==null||D.forEach(d=>{if(!(d!=null&&d.id))return;const $=Number(d.id),O=bt.get($)||{totalDamage:0,connectedHits:0,minTotal:0,minCount:0};O.totalDamage+=Number(d.totalDamage||0),O.connectedHits+=Number(d.connectedHits||0);const V=Number.isFinite(Number(d.min))?Number(d.min):0;O.minTotal+=V,O.minCount+=1,bt.set($,O)})})}),W.forEach((e,t)=>{var ge,$e;const n=e.details;if(!n)return;const u=n.players;console.log(`[useStatsAggregation] Processing log ${t}:`,{playerCount:u==null?void 0:u.length,hasTargets:!!n.targets,firstPlayer:u!=null&&u[0]?{account:u[0].account,notInSquad:u[0].notInSquad}:"none"});const a=n.targets||[],D=n.skillMap||{},d=n.buffMap||{},$=new Map,O=new Map;a.forEach(o=>{const h=(o==null?void 0:o.totalDamageDist)||[],P=Array.isArray(h)?h[0]:null;P==null||P.forEach(ee=>{var X;if(!(ee!=null&&ee.id))return;const K=Number(ee.id),s=((X=D==null?void 0:D[K])==null?void 0:X.name)||ee.name||ee.skillName||String(K),N=$.get(K)||{totalDamage:0,connectedHits:0,minTotal:0,minCount:0};N.totalDamage+=Number(ee.totalDamage||0),N.connectedHits+=Number(ee.connectedHits||0);const A=Number.isFinite(Number(ee.min))?Number(ee.min):0;N.minTotal+=A,N.minCount+=1,$.set(K,N);const H=O.get(s)||{totalDamage:0,connectedHits:0,minTotal:0,minCount:0};H.totalDamage+=Number(ee.totalDamage||0),H.connectedHits+=Number(ee.connectedHits||0);const te=Number.isFinite(Number(ee.min))?Number(ee.min):0;H.minTotal+=te,H.minCount+=1,O.set(s,H)})});const V=o=>{const h=$.get(o);if(!h||h.connectedHits<=0)return{avg:1,min:1};const P=h.connectedHits>0?h.totalDamage/h.connectedHits:0,ee=h.minCount>0?h.minTotal/h.minCount:P;return{avg:P||1,min:ee||1}},se=o=>{const h=O.get(o);if(!h||h.connectedHits<=0)return{avg:1,min:1};const P=h.connectedHits>0?h.totalDamage/h.connectedHits:0,ee=h.minCount>0?h.minTotal/h.minCount:P;return{avg:P||1,min:ee||1}},re=n.combatReplayMetaData||{},Be=(re==null?void 0:re.inchToPixel)>0?re.inchToPixel:1,v=(re==null?void 0:re.pollingRate)>0?re.pollingRate:1,w=5e3,L=o=>Array.isArray(o)?o.map(h=>Array.isArray(h)?[Number(h[0]),Number(h[1])]:null).filter(h=>!!h&&Number.isFinite(h[0])):[];let y=[],ce=n.durationMS||0,l=!1;const m=u.find(o=>(o==null?void 0:o.hasCommanderTag)&&!(o!=null&&o.notInSquad));(ge=m==null?void 0:m.combatReplayData)!=null&&ge.positions&&(y=m.combatReplayData.positions,L(m.combatReplayData.dead).forEach(([h])=>{h>0&&(l=!0,ce=Math.min(ce,h))}));const S=o=>{var H;const h=(H=o.statsAll)==null?void 0:H[0];if((h==null?void 0:h.distToCom)!==void 0&&(h==null?void 0:h.distToCom)!=="Infinity")return Math.round(Number(h.distToCom));if((h==null?void 0:h.stackDist)!==void 0)return Math.round(Number(h.stackDist))||0;if(o.hasCommanderTag)return 0;const P=o.combatReplayData;if(!(P!=null&&P.positions)||!y.length)return 0;const ee=P.positions,K=L(P.dead),s=L(P.down),N=Math.floor((P.start||0)/v);let A=0;if(K.length&&s.length)for(const[te]of K){if(te<0)continue;const X=Math.max(0,Math.floor(te/v))-N;for(const[_,Q]of s){if(te!==Q)continue;const ne=l&&_>ce?Math.max(1,Math.floor(ce/v)):X,oe=Math.max(0,Math.min(ne,ee.length,y.length));if(oe<=0)continue;let Z=0;for(let J=0;J<oe;J++){const[p,I]=ee[J],[z,G]=y[J];Z+=Math.hypot(p-z,I-G)}A=Math.round(Z/oe/Be)}}return A},b=u.filter(o=>!o.notInSquad);R+=b.length,ue+=a.filter(o=>!o.isFake).length,ri(u,{durationMS:n.durationMS,buffMap:n.buffMap});const{squadDeaths:F,enemyDeaths:r}=He(n);fe+=F,pe+=r,he+=F,_e+=r,Ee(n)?ke++:de++;const B=n.skillMap?Number(($e=Object.keys(n.skillMap).find(o=>{var h,P;return((P=(h=n.skillMap)==null?void 0:h[o])==null?void 0:P.name)==="Battle Standard"}))==null?void 0:$e.replace(/^s/,"")):null;u.forEach((o,h)=>{var lt,ut,Lt,St,Ct,En,Bn,In,Pn,Hn,Un,xn,$n;if(o.notInSquad)return;const P=o.account||"Unknown",ee=P!=="Unknown"?P:o.name||"Unknown",K=o.name||"Unknown";Ne.has(ee)||Ne.set(ee,{name:K,account:ee,characterNames:new Set,downContrib:0,cleanses:0,strips:0,stab:0,healing:0,barrier:0,cc:0,logsJoined:0,totalDist:0,distCount:0,dodges:0,downs:0,deaths:0,totalFightMs:0,offenseTotals:{},offenseRateWeights:{},defenseActiveMs:0,defenseTotals:{},supportActiveMs:0,supportTotals:{},healingActiveMs:0,healingTotals:{},profession:o.profession||"Unknown",professions:new Set,professionTimeMs:{},squadActiveMs:0,firstSeenFightTs:0,lastSeenFightTs:0,lastSeenFightDurationMs:0,isCommander:!1,damage:0,dps:0,revives:0,outgoingConditions:{},incomingConditions:{}});const s=Ne.get(ee);if(o.hasCommanderTag&&(s.isCommander=!0),K!=="Unknown"&&s.characterNames.add(String(K)),o.profession&&o.profession!=="Unknown"){s.profession=o.profession,s.professions.add(o.profession);const g=Array.isArray(o.activeTimes)&&typeof o.activeTimes[0]=="number"?o.activeTimes[0]:n.durationMS||0;s.professionTimeMs[o.profession]=(s.professionTimeMs[o.profession]||0)+g}s.logsJoined++,s.downContrib+=ii(o),s.cleanses+=ti(o),s.strips+=ni(o,Te),s.healing+=oi(o),s.barrier+=si(o),s.cc+=ai(o,Te),s.stab+=o.stabGeneration||0;const N=S(o);N<=w&&(s.totalDist+=N,s.distCount++),(lt=o.defenses)!=null&&lt[0]&&(s.dodges+=o.defenses[0].dodgeCount||0,s.downs+=o.defenses[0].downCount||0,s.deaths+=o.defenses[0].deadCount||0),n.durationMS&&(s.totalFightMs+=n.durationMS);const A=Array.isArray(o.activeTimes)&&typeof o.activeTimes[0]=="number"?o.activeTimes[0]:n.durationMS||0;s.squadActiveMs+=A;const H=Ge(n,e),te=Number((n==null?void 0:n.durationMS)||0);H>0&&((s.firstSeenFightTs<=0||H<s.firstSeenFightTs)&&(s.firstSeenFightTs=H),s.lastSeenFightTs<=0||H>s.lastSeenFightTs?(s.lastSeenFightTs=H,s.lastSeenFightDurationMs=te):H===s.lastSeenFightTs&&te>s.lastSeenFightDurationMs&&(s.lastSeenFightDurationMs=te)),s.defenseActiveMs+=A,s.supportActiveMs+=A,s.healingActiveMs+=A,Array.isArray(o.buffUptimes)&&o.buffUptimes.length>0&&o.buffUptimes.forEach(g=>{var Rn,On,_n,qn,Wn,jn;if(typeof(g==null?void 0:g.id)!="number")return;const T=`b${g.id}`,M=((Rn=n.buffMap)==null?void 0:Rn[T])||((On=n.buffMap)==null?void 0:On[String(g.id)]);if(!M||vi(M))return;const x=Number(((qn=(_n=g.buffData)==null?void 0:_n[0])==null?void 0:qn.uptime)??0),ae=Number(((jn=(Wn=g.buffData)==null?void 0:Wn[0])==null?void 0:jn.presence)??0);if((!Number.isFinite(x)||x<=0)&&(!Number.isFinite(ae)||ae<=0))return;const Le=(M==null?void 0:M.stacking)??!1,Ye=(Le?Number.isFinite(x)?x:0:Number.isFinite(x)?x/100:0)*A,it=Le?ae:x,ft=Math.min(Math.max(Number.isFinite(it)?it:0,0),100)/100*A,Dt=Number.isFinite(Ye)&&Ye>0,Nt=Number.isFinite(ft)&&ft>0;if(!Dt&&!Nt)return;const Xe=di(M==null?void 0:M.name);if(Xe&&bi.has(Xe)&&(!(M!=null&&M.classification)||M.classification==="Condition")){const Rt=Ye/1e3,Ze=M==null?void 0:M.icon,At=Ue[Xe]||{name:Xe,icon:Ze,applications:0,damage:0};At.applicationsFromUptime=(At.applicationsFromUptime||0)+Rt,!At.icon&&Ze&&(At.icon=Ze),Ue[Xe]=At;const Tt=s.outgoingConditions[Xe]||{applications:0,damage:0,skills:{},icon:Ze};Tt.applicationsFromUptime=(Tt.applicationsFromUptime||0)+Rt,!Tt.icon&&Ze&&(Tt.icon=Ze),s.outgoingConditions[Xe]=Tt;const Mt=Re[Xe]||{name:Xe,icon:Ze,applications:0,damage:0};Mt.applicationsFromUptime=(Mt.applicationsFromUptime||0)+Rt,!Mt.icon&&Ze&&(Mt.icon=Ze),Re[Xe]=Mt;const wt=s.incomingConditions[Xe]||{applications:0,damage:0,skills:{},icon:Ze};wt.applicationsFromUptime=(wt.applicationsFromUptime||0)+Rt,!wt.icon&&Ze&&(wt.icon=Ze),s.incomingConditions[Xe]=wt}st.has(T)||st.set(T,{name:M==null?void 0:M.name,stacking:Le,icon:M==null?void 0:M.icon}),tt.has(T)||tt.set(T,new Map);const Ln=tt.get(T),Qt=s.account||o.account||o.name||"Unknown";let ot=Ln.get(Qt);ot||(ot={account:Qt,profession:s.profession||o.profession||"Unknown",professions:new Set,professionTimeMs:{},totalMs:0,uptimeMs:0,durationMs:0},Ln.set(Qt,ot));const gt=o.profession||s.profession;gt&&gt!=="Unknown"&&(ot.professions.add(gt),ot.professionTimeMs[gt]=(ot.professionTimeMs[gt]||0)+A,ot.profession=gt),ot.totalMs+=Dt?Ye:0,ot.uptimeMs+=Nt?ft:0,ot.durationMs+=A}),(ut=o.defenses)!=null&&ut[0]&&Si.forEach(g=>{const T=Number(o.defenses[0][g.field]??0);Number.isFinite(T)&&(s.defenseTotals[g.id]=(s.defenseTotals[g.id]||0)+T)}),(Lt=o.support)!=null&&Lt[0]&&Ci.forEach(g=>{let T=Number(o.support[0][g.field]??0);Number.isFinite(T)&&(ze.has(g.field)&&T>999999&&(T=0),s.supportTotals[g.id]=(s.supportTotals[g.id]||0)+T)});const X=(g,T)=>{Number.isFinite(T)&&(s.healingTotals[g]=(s.healingTotals[g]||0)+T)},_=(g,T)=>Array.isArray(g)?g.reduce((M,x)=>M+Number((x==null?void 0:x[T])??0),0):0,Q=(g,T,M)=>{if(!Number.isFinite(M)||M<=0)return;const x=u[T],ae=T===h,Le=x==null?void 0:x.notInSquad,je=!Le,Ye=je&&(x==null?void 0:x.group)!=null&&x.group===o.group;X(g,M),je&&X(`squad${g[0].toUpperCase()}${g.slice(1)}`,M),Ye&&X(`group${g[0].toUpperCase()}${g.slice(1)}`,M),ae&&X(`self${g[0].toUpperCase()}${g.slice(1)}`,M),Le&&X(`offSquad${g[0].toUpperCase()}${g.slice(1)}`,M)};if(Array.isArray(o.rotation)){let g=0;o.rotation.forEach(T=>{var x;if(!(T!=null&&T.id)||!Ai(T.id,n.skillMap))return;const M=((x=T.skills)==null?void 0:x.length)||0;M>0&&(g+=M,X(`resUtility_s${T.id}`,M))}),g>0&&X("resUtility",g)}const ne=(St=o.extHealingStats)==null?void 0:St.outgoingHealingAllies;Array.isArray(ne)&&ne.forEach((g,T)=>{const M=_(g,"healing"),x=_(g,"downedHealing");Q("healing",T,M),Q("downedHealing",T,x)});const oe=(Ct=o.extBarrierStats)==null?void 0:Ct.outgoingBarrierAllies;Array.isArray(oe)&&oe.forEach((g,T)=>{const M=_(g,"barrier");Q("barrier",T,M)});const Z=(En=o.statsAll)==null?void 0:En[0],J=(Bn=o.dpsAll)==null?void 0:Bn[0],p=(In=o.support)==null?void 0:In[0];if(ki.forEach(g=>{if(g.id==="downContributionPercent"||!g.field)return;let T=0,M=0;g.source==="dpsAll"&&J?T=Number(J[g.field]??0):g.source==="statsAll"&&Z?(T=Number(Z[g.field]??0),M=Number(Z[g.denomField||g.weightField||"connectedDamageCount"]??0)):g.source==="support"&&p?T=Number(p[g.field]??0):o.statsTargets&&o.statsTargets.forEach(x=>{x!=null&&x[0]&&(T+=Number(x[0][g.field]??0),M+=Number(x[0][g.denomField||g.weightField||"connectedDamageCount"]??0))}),Number.isFinite(T)&&(s.offenseTotals[g.id]=(s.offenseTotals[g.id]||0)+T,g.isRate&&M>0&&(s.offenseRateWeights[g.id]=(s.offenseRateWeights[g.id]||0)+M))}),o.targetDamageDist&&Number.isFinite(B)){const g=o.targetDamageDist.flatMap(T=>T||[]).flatMap(T=>T||[]).reduce((T,M)=>M!=null&&M.id&&M.id===B?T+((M==null?void 0:M.connectedHits)||0):T,0);s.offenseTotals.battleStandardHits=(s.offenseTotals.battleStandardHits||0)+g}s.revives+=((Hn=(Pn=o.support)==null?void 0:Pn[0])==null?void 0:Hn.resurrects)||0,J&&(s.damage+=J.damage||0,s.dps+=J.dps||0);const I=g=>{var ae,Le,je,Ye;let T=`Skill ${g.id}`;const M=((ae=n.skillMap)==null?void 0:ae[`s${g.id}`])||((Le=n.skillMap)==null?void 0:Le[`${g.id}`]);let x=M==null?void 0:M.icon;if(M!=null&&M.name&&(T=M.name),T.startsWith("Skill ")){const it=vt(T,g.id,n.buffMap);it&&(T=it,x=((Ye=(je=n.buffMap)==null?void 0:je[`b${g.id}`])==null?void 0:Ye.icon)||x)}return{name:T,icon:x}},z=g=>{if(!(g!=null&&g.id))return;const{name:T,icon:M}=I(g);Ae[g.id]||(Ae[g.id]={name:T,icon:M,damage:0,hits:0,downContribution:0}),Ae[g.id].name.startsWith("Skill ")&&!T.startsWith("Skill ")&&(Ae[g.id].name=T),!Ae[g.id].icon&&M&&(Ae[g.id].icon=M),Ae[g.id].damage+=g.totalDamage,Ae[g.id].hits+=g.connectedHits,Ae[g.id].downContribution+=Number(g.downContribution||0)},G=o.account||o.name||"Unknown",be=o.profession||"Unknown",ve=`${G}|${be}`;let We=Ve.get(ve);We||(We={key:ve,account:G,displayName:G,profession:be,professionList:[be],totalFightMs:0,skills:new Map},Ve.set(ve,We)),We.professionList.includes(be)||We.professionList.push(be),We.totalFightMs+=n.durationMS||0;const Ke=g=>{if(!(g!=null&&g.id))return;const{name:T,icon:M}=I(g),x=`s${g.id}`;let ae=We.skills.get(x);ae||(ae={id:x,name:T,icon:M,damage:0,downContribution:0},We.skills.set(x,ae)),ae.name.startsWith("Skill ")&&!T.startsWith("Skill ")&&(ae.name=T),!ae.icon&&M&&(ae.icon=M),ae.damage+=Number(g.totalDamage||0),ae.downContribution+=Number(g.downContribution||0)};if(De==="total")(Un=o.totalDamageDist)==null||Un.forEach(g=>{g==null||g.forEach(T=>{z(T),Ke(T)})});else{const g=new Map;(xn=o.targetDamageDist)==null||xn.forEach(M=>{M==null||M.forEach(x=>{x==null||x.forEach(ae=>{const Le=Number(ae==null?void 0:ae.id);if(Number.isFinite(Le)){const je=g.get(Le)||{damage:0,hits:0,downContribution:0};je.damage+=Number((ae==null?void 0:ae.totalDamage)||0),je.hits+=Number((ae==null?void 0:ae.connectedHits)||0),je.downContribution+=Number((ae==null?void 0:ae.downContribution)||0),g.set(Le,je)}z(ae),Ke(ae)})})}),!(n!=null&&n.detailedWvW)&&(($n=o.totalDamageDist)==null||$n.forEach(M=>{M==null||M.forEach(x=>{const ae=Number(x==null?void 0:x.id);if(!Number.isFinite(ae))return;const Le=g.get(ae);if(!Le){z(x),Ke(x);return}const je=Number((x==null?void 0:x.totalDamage)||0),Ye=Number((x==null?void 0:x.connectedHits)||0),it=Number((x==null?void 0:x.downContribution)||0),dt=je-Number(Le.damage||0),ft=Ye-Number(Le.hits||0),Dt=it-Number(Le.downContribution||0);if(dt<=0&&ft<=0&&Dt<=0)return;const Nt={...x,totalDamage:Math.max(0,dt),connectedHits:Math.max(0,ft),downContribution:Math.max(0,Dt)};z(Nt),Ke(Nt)})}))}o.totalDamageTaken&&o.totalDamageTaken.forEach(g=>{g==null||g.forEach(T=>{var Le,je,Ye,it;if(!(T!=null&&T.id))return;let M=`Skill ${T.id}`;const x=((Le=n.skillMap)==null?void 0:Le[`s${T.id}`])||((je=n.skillMap)==null?void 0:je[`${T.id}`]);let ae=x==null?void 0:x.icon;if(x!=null&&x.name&&(M=x.name),M.startsWith("Skill ")){const dt=vt(M,T.id,n.buffMap);dt&&(M=dt,ae=((it=(Ye=n.buffMap)==null?void 0:Ye[`b${T.id}`])==null?void 0:it.icon)||ae)}Me[T.id]||(Me[T.id]={name:M,icon:ae,damage:0,hits:0}),(!Me[T.id].name.startsWith("Skill ")||M.startsWith("Skill "))&&(Me[T.id].name=M),!Me[T.id].icon&&ae&&(Me[T.id].icon=ae),Me[T.id].damage+=T.totalDamage,Me[T.id].hits+=T.hits})})}),a.forEach(o=>{if(o!=null&&o.isFake)return;const h=at((o==null?void 0:o.profession)||(o==null?void 0:o.name)||(o==null?void 0:o.id));h&&(Pe[h]=(Pe[h]||0)+1)});const k=hi({players:u,targets:a,skillMap:n.skillMap,buffMap:n.buffMap,getPlayerKey:o=>o.account&&o.account!=="Unknown"?o.account:o.name||null}),U=sn(n.buffMap);Object.entries(k.playerConditions).forEach(([o,h])=>{const P=Ne.get(o);P&&Object.entries(h).forEach(([ee,K])=>{const s=P.outgoingConditions[ee]||{applications:0,damage:0,skills:{},icon:K.icon};s.applications+=Number(K.applications||0),s.damage+=Number(K.damage||0),K.applicationsFromBuffs&&(s.applicationsFromBuffs=(s.applicationsFromBuffs||0)+K.applicationsFromBuffs),K.applicationsFromBuffsActive&&(s.applicationsFromBuffsActive=(s.applicationsFromBuffsActive||0)+K.applicationsFromBuffsActive),Object.entries(K.skills||{}).forEach(([N,A])=>{const H=s.skills[N]||{name:A.name,hits:0,damage:0,icon:A.icon};H.hits+=Number(A.hits||0),H.damage+=Number(A.damage||0),!H.icon&&A.icon&&(H.icon=A.icon),s.skills[N]=H}),!s.icon&&K.icon&&(s.icon=K.icon),P.outgoingConditions[ee]=s})}),Object.entries(k.summary).forEach(([o,h])=>{const P=Ue[o]||{name:h.name||o,icon:h.icon,applications:0,damage:0};P.applications+=Number(h.applications||0),P.damage+=Number(h.damage||0),h.applicationsFromBuffs&&(P.applicationsFromBuffs=(P.applicationsFromBuffs||0)+h.applicationsFromBuffs),h.applicationsFromBuffsActive&&(P.applicationsFromBuffsActive=(P.applicationsFromBuffsActive||0)+h.applicationsFromBuffsActive),!P.icon&&h.icon&&(P.icon=h.icon),Ue[o]=P}),b.forEach(o=>{const h=o.account&&o.account!=="Unknown"?o.account:o.name||"Unknown",P=Ne.get(h);!P||!o.totalDamageTaken||o.totalDamageTaken.forEach(ee=>ee==null?void 0:ee.forEach(K=>{var J,p,I,z,G,be;if(!(K!=null&&K.id))return;let s=`Skill ${K.id}`;const N=((J=n.skillMap)==null?void 0:J[`s${K.id}`])||((p=n.skillMap)==null?void 0:p[`${K.id}`]);N!=null&&N.name&&(s=N.name);const A=vt(s,K.id,n.buffMap);if(!A)return;const H=(z=(I=n.buffMap)==null?void 0:I[`b${K.id}`])==null?void 0:z.name,te=U.get(A)||((be=(G=n.buffMap)==null?void 0:G[`b${K.id}`])==null?void 0:be.icon),X=(N==null?void 0:N.icon)||te;s.startsWith("Skill ")&&(H||A)&&(s=H||A);const _=Number(K.hits??0),Q=Number(K.totalDamage??0),ne=Re[A]||{name:A,icon:te,applications:0,damage:0};ne.applications+=Number.isFinite(_)?_:0,ne.damage+=Number.isFinite(Q)?Q:0,!ne.icon&&te&&(ne.icon=te),Re[A]=ne;const oe=P.incomingConditions[A]||{applications:0,damage:0,skills:{},icon:te};oe.applications+=Number.isFinite(_)?_:0,oe.damage+=Number.isFinite(Q)?Q:0;const Z=oe.skills[s]||{name:s,hits:0,damage:0,icon:X};Z.hits+=Number.isFinite(_)?_:0,Z.damage+=Number.isFinite(Q)?Q:0,!Z.icon&&X&&(Z.icon=X),oe.skills[s]=Z,!oe.icon&&te&&(oe.icon=te),P.incomingConditions[A]=oe}))});const le=n.player_damage_mitigation||n.playerDamageMitigation,Ie=le&&typeof le=="object"&&Object.keys(le).length>0;Ie&&Object.entries(le).forEach(([o,h])=>{if(!h||typeof h!="object")return;const P=fn(o),ee=gn(Pt,P.account,P);Object.values(h).forEach(K=>{me((K==null?void 0:K.avoided_damage)??(K==null?void 0:K.avoidedDamage))<=0||hn(ee.mitigationTotals,K)})});const we=n.player_minion_damage_mitigation||n.playerMinionDamageMitigation,qe=we&&typeof we=="object"&&Object.keys(we).length>0;qe&&Object.entries(we).forEach(([o,h])=>{if(!h||typeof h!="object")return;const P=fn(o);Object.entries(h).forEach(([ee,K])=>{if(!K||typeof K!="object")return;const s=`${P.account}::${ee}`,N=pn(Ht,s,{...P,minion:String(ee||"Unknown")});Object.values(K).forEach(A=>{hn(N.mitigationTotals,A)})})}),(!Ie||!qe)&&(Ie||b.forEach(o=>{const h=(o==null?void 0:o.totalDamageTaken)||[];if(!Array.isArray(h)||h.length===0)return;const P=o.account||o.name||"Unknown",ee={account:P,name:o.name||P,profession:at(o.profession||"Unknown")};gn(Pt,P,ee);const K=n.skillMap||{},s=n.buffMap||{},N=Array.isArray(h)?h[0]:null;if(N==null||N.forEach(A=>{if(!(A!=null&&A.id))return;const H=me(A.blocked),te=me(A.evaded),X=me(A.glance??A.glanced),_=me(A.missed),Q=me(A.invulned),ne=me(A.interrupted),oe=me(A.hits??A.connectedHits),Z=Number(A.id),J=Ut(Z,K,s);if(Cn(kn,`${P}::${Z}`,{totalHits:oe,blocked:H,evaded:te,glanced:X,missed:_,invulned:Q,interrupted:ne}),P===xt){const p=bt.get(Z),I=rt(Z),z=I.hasSkill?I.hits>0?I.avg:0:1,G=I.hasSkill?I.min||0:1,be=I.hits>0?X*z/2+(H+te+_+Q+ne)*z:0,ve=I.hits>0?X*G/2+(H+te+_+Q+ne)*G:0;jt.push({logId:e.filePath||e.id||t,skillId:A.id,skillName:J,blocked:H,evaded:te,glanced:X,missed:_,invulned:Q,interrupted:ne,totalAvoids:H+te+X+_+Q+ne,avg:z,min:G,enemyHits:(p==null?void 0:p.connectedHits)??0,enemyTotalDmg:(p==null?void 0:p.totalDamage)??0,avoidDmg:be,avoidMinDmg:ve})}}),P===xt){const A=(H,te)=>{let X=0,_=0,Q=0;if(!Array.isArray(H))return{total:X,minTotal:_,hits:Q};for(const ne of H){if(!(ne!=null&&ne.id))continue;const oe=me(ne.blocked),Z=me(ne.evaded),J=me(ne.glance??ne.glanced),p=me(ne.missed),I=me(ne.invulned),z=me(ne.interrupted),G=Ut(Number(ne.id),D,d),be=te(Number(ne.id),G);(be.hits??0)>0&&(X+=J*be.avg/2+(oe+Z+p+I+z)*be.avg,_+=J*be.min/2+(oe+Z+p+I+z)*be.min),Q+=me(ne.hits??ne.connectedHits)}return{total:X,minTotal:_,hits:Q}};zt.push({logId:e.filePath||e.id||t,variant:"current_global_name_taken0",...A(N,(H,te)=>{const X=rt(H),_=X.hasSkill?X.hits>0?X.avg:0:1,Q=X.hasSkill?X.min||0:1;return{avg:_,min:Q,hits:X.hits}})})}}),qe||b.forEach(o=>{const h=(o==null?void 0:o.minions)||[];if(!Array.isArray(h)||h.length===0)return;const P=o.account||o.name||"Unknown",ee={account:P,name:o.name||P,profession:at(o.profession||"Unknown")},K=n.skillMap||{},s=n.buffMap||{};h.forEach(N=>{const A=(N==null?void 0:N.totalDamageTakenDist)||[];if(!Array.isArray(A)||A.length===0)return;let H=String((N==null?void 0:N.name)||"Unknown").replace(/^Juvenile\s+/i,"")||"Unknown";H.toUpperCase().includes("UNKNOWN")&&(H="Unknown");const te=`${P}::${H}`;pn(Ht,te,{...ee,minion:H});const X=Array.isArray(A)?A[0]:null;if(X==null||X.forEach(_=>{if(!(_!=null&&_.id))return;const Q=me(_.blocked),ne=me(_.evaded),oe=me(_.glance??_.glanced),Z=me(_.missed),J=me(_.invulned),p=me(_.interrupted),I=me(_.hits??_.connectedHits),z=Number(_.id),G=Ut(z,K,s);if(Cn(Sn,`${te}::${z}`,{totalHits:I,blocked:Q,evaded:ne,glanced:oe,missed:Z,invulned:J,interrupted:p}),P===xt&&H===bn){const be=bt.get(z),ve=rt(z),We=ve.hasSkill?ve.hits>0?ve.avg:0:1,Ke=ve.hasSkill?ve.min||0:1,lt=ve.hits>0?oe*We/2+(Q+ne+Z+J+p)*We:0,ut=ve.hits>0?oe*Ke/2+(Q+ne+Z+J+p)*Ke:0;Wt.push({logId:e.filePath||e.id||t,skillId:_.id,skillName:G,blocked:Q,evaded:ne,glanced:oe,missed:Z,invulned:J,interrupted:p,totalAvoids:Q+ne+oe+Z+J+p,avg:We,min:Ke,enemyHits:(be==null?void 0:be.connectedHits)??0,enemyTotalDmg:(be==null?void 0:be.totalDamage)??0,avoidDmg:lt,avoidMinDmg:ut})}}),P===xt&&H===bn){const _=(Z,J)=>{let p=0,I=0,z=0;if(!Array.isArray(Z))return{total:p,minTotal:I,hits:z};for(const G of Z){if(!(G!=null&&G.id))continue;const be=me(G.blocked),ve=me(G.evaded),We=me(G.glance??G.glanced),Ke=me(G.missed),lt=me(G.invulned),ut=me(G.interrupted),Lt=Ut(Number(G.id),D,d),{avg:St,min:Ct}=J(Number(G.id),Lt);me(G.hits??G.connectedHits)>0&&(p+=We*St/2+(be+ve+Ke+lt+ut)*St,I+=We*Ct/2+(be+ve+Ke+lt+ut)*Ct),z+=me(G.hits??G.connectedHits)}return{total:p,minTotal:I,hits:z}},Q=Array.isArray(A)?A[0]||[]:[],ne=Array.isArray(A)?A.flat():[],oe=Array.isArray(N==null?void 0:N.totalDamageTaken)?N.totalDamageTaken[0]||[]:[];ct.push({logId:e.filePath||e.id||t,variant:"current_global_name_dist0",..._(Q,(Z,J)=>{const p=rt(Z),I=p.hasSkill?p.hits>0?p.avg:0:1,z=p.hasSkill&&p.min||0;return{avg:I,min:z}})}),ct.push({logId:e.filePath||e.id||t,variant:"local_name_dist0",..._(Q,(Z,J)=>se(J))}),ct.push({logId:e.filePath||e.id||t,variant:"local_id_dist0",..._(Q,Z=>V(Z))}),ct.push({logId:e.filePath||e.id||t,variant:"global_name_alllists",..._(ne,(Z,J)=>{const p=rt(Z),I=p.hasSkill?p.hits>0?p.avg:0:1,z=p.hasSkill&&p.min||0;return{avg:I,min:z}})}),ct.push({logId:e.filePath||e.id||t,variant:"global_name_taken0",..._(oe,(Z,J)=>{const p=rt(Z),I=p.hasSkill?p.hits>0?p.avg:0:1,z=p.hasSkill&&p.min||0;return{avg:I,min:z}})})}})}))}),Wt.length>0&&(console.groupCollapsed("[Mitigation Debug] Ashtonlightstone.9145 / Illusionary Warden"),console.table(Wt),ct.length>0&&console.table(ct),console.groupEnd()),jt.length>0&&(console.groupCollapsed("[Mitigation Debug] Ashtonlightstone.9145 / Player"),console.table(jt),zt.length>0&&console.table(zt),console.groupEnd());const Dn=(e,t)=>{const n=new Map,u=a=>{let D=n.get(a);return D||(D=ht(),n.set(a,D)),D};t.forEach((a,D)=>{const d=D.lastIndexOf("::"),$=d>-1?D.slice(0,d):D,O=d>-1?Number(D.slice(d+2)):Number.NaN,V=Number.isFinite(O)?rt(O):{hasSkill:!1,avg:0,min:0,hits:0};if(!V.hasSkill||V.hits<=0)return;const se=V.avg,re=V.min,Be=a.glanced*se/2+(a.blocked+a.evaded+a.missed+a.invulned+a.interrupted)*se,v=a.glanced*re/2+(a.blocked+a.evaded+a.missed+a.invulned+a.interrupted)*re;if(Be<=0)return;const w=u($);w.totalHits+=a.totalHits,w.blocked+=a.blocked,w.evaded+=a.evaded,w.glanced+=a.glanced,w.missed+=a.missed,w.invulned+=a.invulned,w.interrupted+=a.interrupted,w.totalMitigation+=Be,w.minMitigation+=v}),e.forEach((a,D)=>{const d=n.get(D)||ht();a.mitigationTotals.totalHits=d.totalHits,a.mitigationTotals.blocked=d.blocked,a.mitigationTotals.evaded=d.evaded,a.mitigationTotals.glanced=d.glanced,a.mitigationTotals.missed=d.missed,a.mitigationTotals.invulned=d.invulned,a.mitigationTotals.interrupted=d.interrupted,a.mitigationTotals.totalMitigation=d.totalMitigation,a.mitigationTotals.minMitigation=d.minMitigation})};Dn(Pt,kn),Dn(Ht,Sn);const Ei=Y>0?Math.round(R/Y):0,Bi=Y>0?Math.round(ue/Y):0,Ii=fe>0?(pe/fe).toFixed(2):pe>0?"∞":"0.00",Pi=_e>0?(he/_e).toFixed(2):he>0?"∞":"0.00",Nn=(e,t)=>{const u=e.filter(d=>Number.isFinite(d.value)&&(t?d.value>0:d.value>=0)).sort((d,$)=>{const O=t?$.value-d.value:d.value-$.value;return O!==0?O:d.account.localeCompare($.account)});let a=null,D=0;return u.map((d,$)=>((a===null||d.value!==a)&&(D=$+1,a=d.value),{rank:D,...d}))},Vt=Array.from(Ne.values()).map(e=>{const t=Array.from(e.professions).filter(n=>n!=="Unknown");if(e.professionList=t,t.length>0){let n=t[0],u=e.professionTimeMs[n]||0;t.forEach(a=>{const D=e.professionTimeMs[a]||0;D>u&&(u=D,n=a)}),e.profession=n}return{key:e.account,stat:e}}),An=e=>{const t=Ne.get(e.account);if(!t){const a=e.professionList.length>0?e.professionList:e.profession?[e.profession]:[];return{...e,professionList:a}}const n=t.professionList&&t.professionList.length>0?t.professionList:Array.from(t.professions||[]).filter(a=>a&&a!=="Unknown"),u=t.profession||e.profession;return{...e,profession:u,professionList:n.length>0?n:u?[u]:[],activeMs:t.defenseActiveMs||t.totalFightMs||e.activeMs}},Hi=Array.from(Pt.values()).map(An).filter(e=>Fi(e.mitigationTotals)).sort((e,t)=>e.account.localeCompare(t.account)),Ui=Array.from(Ht.values()).map(An).filter(e=>e.mitigationTotals.totalMitigation>0).sort((e,t)=>{const n=e.account.localeCompare(t.account);return n!==0?n:String(e.minion||"").localeCompare(String(t.minion||""))}),$t=(e,t)=>{switch(t){case"downContrib":return e.downContrib;case"barrier":return e.barrier;case"healing":return e.healing;case"dodges":return e.dodges;case"strips":return e.strips;case"cleanses":return e.cleanses;case"cc":return e.cc;case"stability":return e.stab;case"revives":return e.revives;case"dps":return e.dps;case"damage":return e.damage;case"participation":return e.logsJoined;case"closestToTag":return!e.isCommander&&e.distCount>0?e.totalDist/e.distCount:Number.POSITIVE_INFINITY;default:return 0}},Qe=(e,t)=>Nn(Vt.map(({stat:n})=>({account:n.account,profession:n.profession,professionList:n.professionList,value:$t(n,e),count:n.logsJoined})),t),xe={downContrib:Qe("downContrib",!0),barrier:Qe("barrier",!0),healing:Qe("healing",!0),dodges:Qe("dodges",!0),strips:Qe("strips",!0),cleanses:Qe("cleanses",!0),cc:Qe("cc",!0),stability:Qe("stability",!0),revives:Qe("revives",!0),participation:Qe("participation",!0),dps:Qe("dps",!0),damage:Qe("damage",!0),closestToTag:Qe("closestToTag",!1).filter(e=>Number.isFinite(e.value))},xi={downContrib:"downContrib",barrier:"barrier",healing:"healing",dodges:"dodges",strips:"strips",cleanses:"cleanses",cc:"cc",stability:"stability",closestToTag:"closestToTag"},Fe=e=>{const t=e==null?void 0:e[0];return{value:(t==null?void 0:t.value)??0,player:(t==null?void 0:t.account)??"-",count:(t==null?void 0:t.count)??0,profession:(t==null?void 0:t.profession)??"Unknown",professionList:(t==null?void 0:t.professionList)??[]}},nt={maxDownContrib:Fe([]),maxBarrier:Fe([]),maxHealing:Fe([]),maxDodges:Fe([]),maxStrips:Fe([]),maxCleanses:Fe([]),maxCC:Fe([]),maxStab:Fe([]),closestToTag:Fe([])},et={},$i=(e,t)=>{if(t==="closestToTag")return $t(e,t);const n=Math.max(1,(e.totalFightMs||0)/1e3);return $t(e,t)/n};Object.values(xi).forEach(e=>{const t=e!=="closestToTag";et[e]=Nn(Vt.map(({stat:n})=>({account:n.account,profession:n.profession,professionList:n.professionList,value:$i(n,e),count:n.logsJoined})),t)}),nt.maxDownContrib=Fe(et.downContrib),nt.maxBarrier=Fe(et.barrier),nt.maxHealing=Fe(et.healing),nt.maxDodges=Fe(et.dodges),nt.maxStrips=Fe(et.strips),nt.maxCleanses=Fe(et.cleanses),nt.maxCC=Fe(et.cc),nt.maxStab=Fe(et.stability),nt.closestToTag=Fe(et.closestToTag);const Li={maxDownContrib:Fe(xe.downContrib),maxBarrier:Fe(xe.barrier),maxHealing:Fe(xe.healing),maxDodges:Fe(xe.dodges),maxStrips:Fe(xe.strips),maxCleanses:Fe(xe.cleanses),maxCC:Fe(xe.cc),maxStab:Fe(xe.stability),closestToTag:Fe(xe.closestToTag)};let Kt={player:"None",account:"None",score:-1,profession:"Unknown",professionList:[],color:"#64748b",topStats:[]},Tn,Mn,wn=0;if(Se!=null&&Se.showMvp){const e={"Down Contribution":"downContribution",Healing:"healing",Cleanses:"cleanses",Strips:"strips",Stability:"stability",CC:"cc",Revives:"revives","Distance to Tag":"distanceToTag",Participation:"participation",Dodging:"dodging",DPS:"dps",Damage:"damage"},t=D=>{const d=e[D];return d?Number(ie[d]||0)>0:!1},n=[],u=D=>[...D||[]].filter(d=>t(d==null?void 0:d.name)).sort((d,$)=>$.ratio-d.ratio||d.rank-$.rank||d.name.localeCompare($.name)).slice(0,3),a=D=>{var $;if(!D)return;const d=u(D.contribs);return{...D,player:D.name,reason:(($=d[0])==null?void 0:$.name)||"Top Performance",topStats:d}};Vt.forEach(({stat:D})=>{let d=0;const $=[],O=(V,se,re,Be,v=!0)=>{var L,y;if(re<=0)return;const w=((L=se[0])==null?void 0:L.value)||0;if(w&&Number.isFinite(V)&&(v?V>0:V<Number.POSITIVE_INFINITY)){const ce=v?V/w:w/V;d+=ce*re;const l=((y=se.find(m=>m.account===D.account))==null?void 0:y.rank)||0;$.push({name:Be,ratio:ce,val:V.toLocaleString(),rank:l})}};O(D.downContrib,xe.downContrib,ie.downContribution,"Down Contribution"),O(D.healing,xe.healing,ie.healing,"Healing"),O(D.cleanses,xe.cleanses,ie.cleanses,"Cleanses"),O(D.strips,xe.strips,ie.strips,"Strips"),O(D.stab,xe.stability,ie.stability,"Stability"),O(D.cc,xe.cc,ie.cc,"CC"),O(D.revives,xe.revives,ie.revives,"Revives"),O($t(D,"closestToTag"),xe.closestToTag,ie.distanceToTag,"Distance to Tag",!1),O(D.logsJoined,xe.participation,ie.participation,"Participation"),O(D.dodges,xe.dodges,ie.dodging,"Dodging"),O(D.dps,xe.dps,ie.dps,"DPS"),O(D.damage,xe.damage,ie.damage,"Damage"),n.push({...D,score:d,contribs:$.filter(V=>t(V.name))})}),n.sort((D,d)=>d.score-D.score),n[0]&&n[0].score>0&&(Kt=a(n[0])||Kt),Tn=a(n[1]),Mn=a(n[2]),wn=n.length>0?n.reduce((D,d)=>D+d.score,0)/n.length:0}const vn=Object.values(Ae).sort((e,t)=>t.damage-e.damage||t.hits-e.hits||String(e.name||"").localeCompare(String(t.name||""))).slice(0,25),Fn=Object.values(Ae).sort((e,t)=>t.downContribution-e.downContribution||t.hits-e.hits||String(e.name||"").localeCompare(String(t.name||""))).slice(0,25),Ri=j==="downContribution"?Fn:vn,Oi=Object.values(Me).sort((e,t)=>t.damage-e.damage).slice(0,25),_i=e=>{const t=String(e).replace(/^Detailed\s*WvW\s*-\s*/i,"").replace(/^World\s*vs\s*World\s*-\s*/i,"").replace(/^WvW\s*-\s*/i,"").trim(),n=t.match(/^(Red|Blue|Green)\s+(?:Alpine|Desert)?\s*Borderlands$/i);return n?`${n[1]} Borderlands`:t||"Unknown"},kt=(e,t)=>_i((e==null?void 0:e.zone)||(e==null?void 0:e.mapName)||(e==null?void 0:e.map)||(e==null?void 0:e.location)||(e==null?void 0:e.fightName)||(t==null?void 0:t.fightName)||(t==null?void 0:t.encounterName)||"Unknown"),qi=(e,t)=>{const n=(t==null?void 0:t.permalink)||(e==null?void 0:e.permalink);if(typeof n=="string"&&n.trim().length>0)return n.trim();const u=e==null?void 0:e.uploadLinks;if(!Array.isArray(u))return"";for(const a of u){if(typeof a=="string"&&a.trim().length>0)return a.trim();if(a&&typeof a=="object"){const D=a.permalink||a.link||a.url||a.reportLink;if(typeof D=="string"&&D.trim().length>0)return D.trim()}}return""},Gt={};W.forEach(e=>{const t=kt(e==null?void 0:e.details,e);Gt[t]=(Gt[t]||0)+1});const Wi=Object.entries(Gt).map(([e,t])=>{const n=String(e).trim(),u=/eternal battlegrounds|^ebg$/i.test(n);let a="#64748b";return u?a="#ffffff":/red/i.test(n)?a="#ef4444":/blue/i.test(n)?a="#3b82f6":/green/i.test(n)&&(a="#22c55e"),{name:e,value:t,color:a}}).sort((e,t)=>t.value-e.value),{boonTables:ji}=Vn(W),zi=W.map((e,t)=>{var u,a;const n=((u=e.details)==null?void 0:u.players)||[];return{index:t+1,label:`Log ${t+1}`,timestamp:Ge(e.details,e),squadCount:n.filter(D=>!D.notInSquad).length,friendlyCount:n.length,enemies:((a=e.details)==null?void 0:a.targets).filter(D=>!D.isFake).length}}).sort((e,t)=>e.timestamp-t.timestamp),Yt={};Array.from(Ne.values()).forEach(e=>{e.profession&&e.profession!=="Unknown"&&(Yt[e.profession]=(Yt[e.profession]||0)+1)});const Vi=Object.entries(Yt).map(([e,t])=>({name:e,value:t,color:rn(e)})).sort((e,t)=>t.value-e.value),Jt={};Object.keys(Pe).length===0&&W.forEach(e=>{var t,n;(n=(t=e.details)==null?void 0:t.targets)==null||n.forEach(u=>{if(u.isFake)return;const a=u.profession&&u.profession!=="Unknown"?u.profession:u.name||u.id||"Unknown",D=at(a);Jt[D]=(Jt[D]||0)+1})});const Ki=Object.keys(Pe).length>0?Pe:Jt,Gi=Object.entries(Ki).map(([e,t])=>({name:e,value:t,color:rn(e)})).sort((e,t)=>t.value-e.value),Yi=W.map((e,t)=>({log:e,originalIndex:t})).sort((e,t)=>Ge(e.log.details,e.log)-Ge(t.log.details,t.log)).map(({log:e},t)=>{const n=e.details;if(!n)return null;const u=n.players||[],a=u.filter(r=>!r.notInSquad),D=u.filter(r=>r.notInSquad),$=(n.targets||[]).filter(r=>!r.isFake),O=a.reduce((r,C)=>{var B,k;return r+(((k=(B=C.dpsAll)==null?void 0:B[0])==null?void 0:k.damage)||0)},0),V=a.reduce((r,C)=>{var B,k;return r+(((k=(B=C.defenses)==null?void 0:B[0])==null?void 0:k.damageTaken)||0)},0),{enemyDeaths:se,enemyDownsDeaths:re}=He(n),Be=Ee(n),v=Ge(n,e),w=kt(n,e),L=r=>{if(!r||typeof r!="object")return;const C=r.teamID??r.teamId??r.team??r.teamColor??r.team_color;if(C!=null)return C;const B=Object.keys(r).find(k=>/^team/i.test(k));return B?r[B]:void 0},y=(r,C)=>{const B={};return r.forEach(k=>{const U=C(k),le=at(U);le&&(B[le]=(B[le]||0)+1)}),B},ce=y(a,r=>(r==null?void 0:r.profession)||(r==null?void 0:r.name)),l=y(D,r=>(r==null?void 0:r.profession)||(r==null?void 0:r.name)),m=y($,r=>(r==null?void 0:r.profession)||(r==null?void 0:r.name)||(r==null?void 0:r.id)),S=new Set;a.forEach(r=>{const C=L(r);C!=null&&S.add(String(C))});const b=new Map;$.forEach(r=>{if((r==null?void 0:r.enemyPlayer)===!1)return;const C=L(r);if(C==null)return;const B=String(C);S.has(B)||b.set(B,(b.get(B)||0)+1)});const F=Array.from(b.entries()).sort((r,C)=>{const B=C[1]-r[1];return B!==0?B:r[0].localeCompare(C[0],void 0,{numeric:!0})}).slice(0,3).map(([r,C])=>({teamId:r,count:C}));return{id:e.filePath||`fight-${t}`,label:e.encounterName||`Fight ${t+1}`,permalink:qi(n,e),timestamp:v,mapName:w,duration:an(n.durationMS),isWin:Be,squadCount:a.length,allyCount:D.length,enemyCount:$.length,teamBreakdown:F,alliesDown:a.reduce((r,C)=>{var B,k;return r+(((k=(B=C.defenses)==null?void 0:B[0])==null?void 0:k.downCount)||0)},0),alliesDead:a.reduce((r,C)=>{var B,k;return r+(((k=(B=C.defenses)==null?void 0:B[0])==null?void 0:k.deadCount)||0)},0),alliesRevived:a.reduce((r,C)=>{var B,k;return Number(((k=(B=C.statsAll)==null?void 0:B[0])==null?void 0:k.saved)||0)>0?r+1:r},0),rallies:0,enemyDeaths:se,enemyDowns:Math.max(0,re-se),totalOutgoingDamage:O,totalIncomingDamage:V,incomingBarrierAbsorbed:a.reduce((r,C)=>{var B,k;return r+(((k=(B=C.defenses)==null?void 0:B[0])==null?void 0:k.damageBarrier)||0)},0),outgoingBarrierAbsorbed:a.reduce((r,C)=>{var U;const B=(U=C.extBarrierStats)==null?void 0:U.outgoingBarrier;if(!Array.isArray(B))return r;let k=0;return B.forEach(le=>{if(Array.isArray(le)){le.forEach(Ie=>{k+=Number((Ie==null?void 0:Ie.barrier)||0)});return}k+=Number((le==null?void 0:le.barrier)||0)}),r+k},0),squadClassCountsFight:ce,allyClassCountsFight:l,enemyClassCounts:m}}).filter(Boolean),Ji=Array.from(Ne.values()).map(e=>{const t=Object.entries(e.professionTimeMs||{}).map(([n,u])=>({profession:n,timeMs:Number(u||0)})).filter(n=>n.profession&&n.profession!=="Unknown"&&n.timeMs>0).sort((n,u)=>{const a=u.timeMs-n.timeMs;return a!==0?a:n.profession.localeCompare(u.profession)});return{account:e.account||"Unknown",characterNames:Array.from(e.characterNames||[]).filter(Boolean).sort((n,u)=>n.localeCompare(u)),classTimes:t,combatTimeMs:Number(e.squadActiveMs||e.totalFightMs||0),squadTimeMs:(()=>{const n=Number(e.firstSeenFightTs||0),u=Number(e.lastSeenFightTs||0),a=Math.max(0,Number(e.lastSeenFightDurationMs||0));return n>0&&u>0?Math.max(0,u+a-n):Number(e.squadActiveMs||e.totalFightMs||0)})()}}).filter(e=>e.account&&e.account!=="Unknown").sort((e,t)=>{const n=t.squadTimeMs-e.squadTimeMs;return n!==0?n:String(e.account).localeCompare(String(t.account))}),Qi=W.map(e=>e).sort((e,t)=>Ge(e.details,e)-Ge(t.details,t)).map((e,t)=>{const n=e==null?void 0:e.details,u=Array.isArray(n==null?void 0:n.players)?n.players.filter(d=>!(d!=null&&d.notInSquad)):[],a=new Map;u.forEach(d=>{const $=Number(d==null?void 0:d.group),O=Number.isFinite($)&&$>0?$:0;a.has(O)||a.set(O,{party:O,players:[],classCounts:{}});const V=at((d==null?void 0:d.profession)||(d==null?void 0:d.name)||"Unknown"),se=String((d==null?void 0:d.account)||"Unknown"),re=String((d==null?void 0:d.name)||(d==null?void 0:d.character_name)||""),Be=!!(d!=null&&d.hasCommanderTag),v=a.get(O);v.players.push({account:se,characterName:re,profession:V,isCommander:Be}),v.classCounts[V]=(v.classCounts[V]||0)+1});const D=Array.from(a.values()).map(d=>({...d,players:d.players.sort(($,O)=>{const V=+!!O.isCommander-+!!$.isCommander;if(V!==0)return V;const se=String($.profession).localeCompare(String(O.profession));return se!==0?se:String($.account).localeCompare(String(O.account))})})).sort((d,$)=>d.party===0&&$.party!==0?1:$.party===0&&d.party!==0?-1:d.party-$.party);return{id:String((e==null?void 0:e.filePath)||(e==null?void 0:e.id)||`fight-${t+1}`),label:`F${t+1}`,timestamp:Ge(n,e),mapName:kt(n,e),duration:an(Number((n==null?void 0:n.durationMS)||0)),parties:D}}),Xi=(e,t)=>{const n=(t==null?void 0:t.skillMap)||{},u=(t==null?void 0:t.buffMap)||{};let a=0,D="";const d=V=>{const se=Number(V);if(!Number.isFinite(se))return String(V||"Unknown Skill");const re=(n==null?void 0:n[`s${se}`])||(n==null?void 0:n[`${se}`]);if(re!=null&&re.name)return String(re.name);const Be=(u==null?void 0:u[`b${se}`])||(u==null?void 0:u[`${se}`]);return Be!=null&&Be.name?String(Be.name):`Skill ${se}`},$=V=>{if(!V||typeof V!="object")return;const se=[Number(V.max),Number(V.maxDamage),Number(V.maxHit)].filter(Be=>Number.isFinite(Be)),re=se.length>0?Math.max(...se):0;re>a&&(a=re,D=d(V.id))};let O=!1;return Array.isArray(e==null?void 0:e.targetDamageDist)&&e.targetDamageDist.forEach(V=>{Array.isArray(V)&&V.forEach(se=>{Array.isArray(se)&&se.forEach(re=>{O=!0,$(re)})})}),(!O||a<=0)&&Array.isArray(e==null?void 0:e.totalDamageDist)&&e.totalDamageDist.forEach(V=>{Array.isArray(V)&&V.forEach(se=>$(se))}),{peak:a,skillName:D||"Unknown Skill"}},Zi=(()=>{const e=v=>String(v||"").replace(/^Detailed\s*WvW\s*-\s*/i,"").replace(/^World\s*vs\s*World\s*-\s*/i,"").replace(/^WvW\s*-\s*/i,"").trim(),t=v=>e(v).toLowerCase().split(/[^a-z0-9]+/i).map(w=>w.trim()).filter(Boolean).map(w=>w.length>3&&w.endsWith("s")?w.slice(0,-1):w),n=(v,w)=>{const L=e(v),y=e(w);if(!y)return L;if(!L)return y;const ce=t(L),l=t(y),m=new Set(ce),S=new Set(l),b=l.length>0&&l.every(r=>m.has(r)),F=ce.length>0&&ce.every(r=>S.has(r));return b||F?L:`${L} - ${y}`},u=[],a=new Map,D=v=>{const w=b=>{if(!Array.isArray(b)||b.length===0)return[];const F=[];for(let r=0;r<b.length;r+=1){const C=Number(b[r]||0),B=r>0?Number(b[r-1]||0):0;F.push(Math.max(0,C-B))}return F},L=b=>{if(!Array.isArray(b))return[];const F=b.reduce((C,B)=>Math.max(C,Array.isArray(B)?B.length:0),0);if(F<=0)return[];const r=new Array(F).fill(0);return b.forEach(C=>{if(Array.isArray(C))for(let B=0;B<F;B+=1)r[B]+=Number(C[B]||0)}),r},y=b=>Array.isArray(b)?b.map(F=>Number(F||0)):null,l=(b=>{if(!Array.isArray(b)||b.length===0)return null;const F=b[0];if(!Array.isArray(F))return null;if(Array.isArray(F[0])&&Array.isArray(F[0][0]))return L(F);if(Array.isArray(F[0])&&!Array.isArray(F[0][0])){const r=b.map(C=>y(Array.isArray(C)?C[0]:null)).filter(C=>Array.isArray(C)&&C.length>0);if(r.length>0)return L(r)}return null})(v==null?void 0:v.targetDamage1S),m=Array.isArray(v==null?void 0:v.damage1S)&&Array.isArray(v.damage1S[0])?v.damage1S[0]:null,S=l||(Array.isArray(m)?m.map(b=>Number(b||0)):[]);return w(S)},d=(v,w)=>{if(!Array.isArray(v)||v.length===0||w<=0)return 0;let L=0,y=0;for(let ce=0;ce<v.length;ce+=1)L+=Number(v[ce]||0),ce>=w&&(L-=Number(v[ce-w]||0)),ce>=w-1&&L>y&&(y=L);return Math.max(0,y)},$=(v,w)=>{if(!Array.isArray(v)||v.length===0||w<=0)return[];const L=[];for(let y=0;y<v.length;y+=w){const ce=Math.min(y+w,v.length),l=v.slice(y,ce).reduce((m,S)=>m+Number(S||0),0);L.push(l)}return L},O=(v,w)=>{const L=Number(v);if(!Number.isFinite(L))return{name:String(v||"Unknown Skill"),icon:void 0};const y=(w==null?void 0:w.skillMap)||{},ce=(w==null?void 0:w.buffMap)||{},l=(y==null?void 0:y[`s${L}`])||(y==null?void 0:y[`${L}`]);if(l!=null&&l.name)return{name:String(l.name),icon:l==null?void 0:l.icon};const m=(ce==null?void 0:ce[`b${L}`])||(ce==null?void 0:ce[`${L}`]);return m!=null&&m.name?{name:String(m.name),icon:m==null?void 0:m.icon}:{name:`Skill ${L}`,icon:void 0}},V=v=>Array.isArray(v)?v.map(w=>Array.isArray(w)?[Number(w[0]),Number(w[1])]:w&&typeof w=="object"?[Number(w.time),Number(w.value)]:null).filter(w=>!!w&&Number.isFinite(w[0])&&w[0]>=0):[],se=(v,w,L,y,ce)=>{if(!v.length||y<=0)return[];const l=Math.max(y*5e3,ce||0),m=U=>U.reduce((le,Ie)=>Ie>=0&&Ie<=l+2e3?le+1:le,0),S=v.map(U=>Number(U||0)).filter(U=>Number.isFinite(U)&&U>=0);if(!S.length)return[];const b=[S],F=S.reduce((U,le)=>Math.max(U,le),0),r=S.reduce((U,le)=>Math.min(U,le),Number.POSITIVE_INFINITY);F>l*20&&b.push(S.map(U=>U/1e3)),F<=l*2&&r>=0&&F>0&&F<Math.max(120,y*5+10)&&b.push(S.map(U=>U*1e3));let C=S,B=0,k=-1;return b.forEach(U=>{const le=U.reduce((we,qe)=>Math.min(we,qe),Number.POSITIVE_INFINITY),Ie=new Set([0,...w,...L]);if(Number.isFinite(le)&&l>0&&le>l){const we=Math.floor(le/l)*l;Ie.add(we),Ie.add(Math.max(0,we-l))}Ie.forEach(we=>{const qe=U.map($e=>$e-we),ge=m(qe);ge>k&&(k=ge,B=we,C=U)})}),C.map(U=>U-B).filter(U=>Number.isFinite(U)&&U>=0)},re=(v,w,L,y,ce)=>{const l=se(v,w,L,y,ce);return Array.from(new Set(l.map(m=>Math.floor(m/5e3)).filter(m=>Number.isFinite(m)&&m>=0&&m<y)))};W.map(v=>({log:v,ts:Ge(v==null?void 0:v.details,v)})).sort((v,w)=>v.ts-w.ts).forEach(({log:v},w)=>{const L=v==null?void 0:v.details;if(!L)return;const y=e(L.fightName||v.fightName||`Fight ${w+1}`),ce=kt(L,v),l=n(y,String(ce||"")),m={},S=Array.isArray(L.players)?L.players:[],b=S.flatMap(k=>{const U=k==null?void 0:k.combatReplayData;return Array.isArray(U)?U.map(le=>Number(le==null?void 0:le.start)):[Number(U==null?void 0:U.start)]}).filter(k=>Number.isFinite(k)&&k>=0);S.forEach(k=>{if(k!=null&&k.notInSquad)return;const U=String((k==null?void 0:k.account)||(k==null?void 0:k.name)||"Unknown"),le=String((k==null?void 0:k.character_name)||(k==null?void 0:k.display_name)||(k==null?void 0:k.name)||""),Ie=String((k==null?void 0:k.profession)||"Unknown"),we=`${U}|${Ie}`,qe=Xi(k,L),ge=Number(qe.peak||0),$e=D(k),o=Number(d($e,1)||0),h=Number(d($e,5)||0),P=Number(d($e,30)||0),ee=Math.max(0,Math.ceil(Number((L==null?void 0:L.durationMS)||0)/5e3)),K=Math.max(0,Math.ceil($e.length/5)),s=Math.max(ee,K),N=$($e,5),A=Array.from({length:s},(p,I)=>Number(N[I]||0)),H=new Map,te=p=>{if(!p||typeof p!="object"||p.indirectDamage)return;const I=Number(p.totalDamage||0);if(!Number.isFinite(I)||I<=0)return;const z=Number(p.connectedHits||p.hits||0),G=O(p.id,L),be=G.name,ve=H.get(be)||{skillName:be,damage:0,hits:0,icon:G.icon};ve.damage+=I,ve.hits+=Number.isFinite(z)?z:0,!ve.icon&&G.icon&&(ve.icon=G.icon),H.set(be,ve)},X=new Map;Array.isArray(k==null?void 0:k.targetDamageDist)&&k.targetDamageDist.forEach(p=>{Array.isArray(p)&&p.forEach(I=>{Array.isArray(I)&&I.forEach(z=>{const G=Number(z==null?void 0:z.id),be=Number((z==null?void 0:z.totalDamage)||0);if(Number.isFinite(G)){const ve=X.get(G)||{damage:0,hits:0};ve.damage+=Number.isFinite(be)?be:0,ve.hits+=Number((z==null?void 0:z.connectedHits)||(z==null?void 0:z.hits)||0),X.set(G,ve)}te(z)})})}),!(L!=null&&L.detailedWvW)&&Array.isArray(k==null?void 0:k.totalDamageDist)&&k.totalDamageDist.forEach(p=>{Array.isArray(p)&&p.forEach(I=>{const z=Number(I==null?void 0:I.id);if(!Number.isFinite(z)){te(I);return}const G=X.get(z);if(!G){te(I);return}const be=Number((I==null?void 0:I.totalDamage)||0),ve=Number((I==null?void 0:I.connectedHits)||(I==null?void 0:I.hits)||0),We=be-Number(G.damage||0),Ke=ve-Number(G.hits||0);We<=0&&Ke<=0||te({...I,totalDamage:Math.max(0,We),connectedHits:Math.max(0,Ke),hits:Math.max(0,Ke)})})});const Q=(()=>{const p=k==null?void 0:k.combatReplayData;return Array.isArray(p)?p.filter(I=>I&&typeof I=="object"):p&&typeof p=="object"?[p]:[]})(),ne=Q.map(p=>Number(p==null?void 0:p.start)).filter(p=>Number.isFinite(p)&&p>=0),oe=Q.flatMap(p=>V(p==null?void 0:p.down).map(([I])=>Number(I||0))),Z=Q.flatMap(p=>V(p==null?void 0:p.dead).map(([I])=>Number(I||0)));m[we]={hit:ge,burst1s:o,burst5s:h,burst30s:P,skillName:qe.skillName,buckets5s:A,downIndices5s:re(oe,ne,b,s,Number((L==null?void 0:L.durationMS)||0)),deathIndices5s:re(Z,ne,b,s,Number((L==null?void 0:L.durationMS)||0)),skillRows:Array.from(H.values()).sort((p,I)=>I.damage-p.damage).slice(0,50)};const J=a.get(we)||{key:we,account:U,displayName:U,characterName:le,profession:Ie,professionList:[Ie],logs:0,peakHit:0,peak1s:0,peak5s:0,peak30s:0,peakFightLabel:"",peakSkillName:""};J.logs+=1,J.professionList.includes(Ie)||J.professionList.push(Ie),!J.characterName&&le&&(J.characterName=le),ge>J.peakHit&&(J.peakHit=ge,J.peakFightLabel=l,J.peakSkillName=qe.skillName),o>J.peak1s&&(J.peak1s=o),h>J.peak5s&&(J.peak5s=h),P>J.peak30s&&(J.peak30s=P),a.set(we,J)});const F=Object.values(m).reduce((k,U)=>Math.max(k,Number((U==null?void 0:U.hit)||0)),0),r=Object.values(m).reduce((k,U)=>Math.max(k,Number((U==null?void 0:U.burst1s)||0)),0),C=Object.values(m).reduce((k,U)=>Math.max(k,Number((U==null?void 0:U.burst5s)||0)),0),B=Object.values(m).reduce((k,U)=>Math.max(k,Number((U==null?void 0:U.burst30s)||0)),0);u.push({id:v.filePath||v.id||`fight-${w+1}`,shortLabel:`F${w+1}`,fullLabel:l,timestamp:Ge(L,v),values:m,maxHit:F,max1s:r,max5s:C,max30s:B})});const Be=Array.from(a.values()).sort((v,w)=>w.peakHit!==v.peakHit?w.peakHit-v.peakHit:v.displayName.localeCompare(w.displayName));return{fights:u,players:Be}})(),yi=(()=>{const e=l=>String(l||"").replace(/^Detailed\s*WvW\s*-\s*/i,"").replace(/^World\s*vs\s*World\s*-\s*/i,"").replace(/^WvW\s*-\s*/i,"").trim(),t=l=>e(l).toLowerCase().split(/[^a-z0-9]+/i).map(m=>m.trim()).filter(Boolean).map(m=>m.length>3&&m.endsWith("s")?m.slice(0,-1):m),n=(l,m)=>{const S=e(l),b=e(m);if(!b)return S;if(!S)return b;const F=t(S),r=t(b),C=new Set(F),B=new Set(r),k=r.length>0&&r.every(le=>C.has(le)),U=F.length>0&&F.every(le=>B.has(le));return k||U?S:`${S} - ${b}`},u=[],a=new Map,D=(l,m)=>{const S=Number(l);if(!Number.isFinite(S))return{name:String(l||"Unknown Skill"),icon:void 0};const b=(m==null?void 0:m.skillMap)||{},F=(m==null?void 0:m.buffMap)||{},r=(b==null?void 0:b[`s${S}`])||(b==null?void 0:b[`${S}`]);if(r!=null&&r.name)return{name:String(r.name),icon:r==null?void 0:r.icon};const C=(F==null?void 0:F[`b${S}`])||(F==null?void 0:F[`${S}`]);return C!=null&&C.name?{name:String(C.name),icon:C==null?void 0:C.icon}:{name:`Skill ${S}`,icon:void 0}},d=(l,m)=>{let S=0,b="";const F=r=>{if(!r||typeof r!="object"||r.indirectDamage)return;const C=[Number(r.max),Number(r.maxDamage),Number(r.maxHit)].filter(k=>Number.isFinite(k)),B=C.length>0?Math.max(...C):0;B>S&&(S=B,b=D(r.id,m).name)};return Array.isArray(l==null?void 0:l.totalDamageDist)&&l.totalDamageDist.forEach(r=>{Array.isArray(r)&&r.forEach(C=>F(C))}),Array.isArray(l==null?void 0:l.targetDamageDist)&&l.targetDamageDist.forEach(r=>{Array.isArray(r)&&r.forEach(C=>{Array.isArray(C)&&C.forEach(B=>F(B))})}),{peak:S,skillName:b||"Unknown Skill"}},$=l=>{if(!Array.isArray(l)||l.length===0)return[];const m=[];for(let S=0;S<l.length;S+=1){const b=Number(l[S]||0),F=S>0?Number(l[S-1]||0):0;m.push(Math.max(0,b-F))}return m},O=l=>{if(!Array.isArray(l)||l.length===0)return[];const m=l.reduce((b,F)=>Math.max(b,Array.isArray(F)?F.length:0),0);if(m<=0)return[];const S=new Array(m).fill(0);return l.forEach(b=>{if(Array.isArray(b))for(let F=0;F<m;F+=1)S[F]+=Number(b[F]||0)}),S},V=l=>{if(!Array.isArray(l)||l.length===0)return[];const m=l[0];if(typeof m=="number")return l.map(S=>Number(S||0));if(Array.isArray(m)&&m.length>0){if(typeof m[0]=="number")return m.map(S=>Number(S||0));if(Array.isArray(m[0])){const S=m.map(b=>Array.isArray(b)?b.map(F=>Number(F||0)):null).filter(b=>Array.isArray(b)&&b.length>0);if(S.length>0)return O(S)}}return[]},se=l=>{const m=V(l==null?void 0:l.powerDamage1S),S=V(l==null?void 0:l.damage1S),b=m.length>0?m:S;return $(b)},re=(l,m)=>{const S=l==null?void 0:l.targetPowerDamage1S;if(!Array.isArray(S)||!Array.isArray(S[m]))return[];const b=S[m];if(!Array.isArray(b)||b.length===0)return[];if(typeof b[0]=="number")return b.map(F=>Number(F||0));if(Array.isArray(b[0])&&!Array.isArray(b[0][0]))return b[0].map(F=>Number(F||0));if(Array.isArray(b[0])&&Array.isArray(b[0][0])){const r=b[0].map(C=>Array.isArray(C)?C.map(B=>Number(B||0)):null).filter(C=>Array.isArray(C)&&C.length>0);return O(r)}return[]},Be=(l,m)=>{if(!Array.isArray(l)||l.length===0||m<=0)return 0;let S=0,b=0;for(let F=0;F<l.length;F+=1)S+=Number(l[F]||0),F>=m&&(S-=Number(l[F-m]||0)),F>=m-1&&S>b&&(b=S);return Math.max(0,b)},v=(l,m)=>{if(!Array.isArray(l)||l.length===0||m<=0)return[];const S=[];for(let b=0;b<l.length;b+=m){const F=Math.min(b+m,l.length),r=l.slice(b,F).reduce((C,B)=>C+Number(B||0),0);S.push(r)}return S},w=l=>Array.isArray(l)?l.map(m=>Array.isArray(m)?[Number(m[0]),Number(m[1])]:m&&typeof m=="object"?[Number(m.time),Number(m.value)]:null).filter(m=>!!m&&Number.isFinite(m[0])&&m[0]>=0):[],L=(l,m,S,b,F)=>{if(!l.length||b<=0)return[];const r=Math.max(b*5e3,F||0),C=ge=>ge.reduce(($e,o)=>o>=0&&o<=r+2e3?$e+1:$e,0),B=l.map(ge=>Number(ge||0)).filter(ge=>Number.isFinite(ge)&&ge>=0);if(!B.length)return[];const k=[B],U=B.reduce((ge,$e)=>Math.max(ge,$e),0),le=B.reduce((ge,$e)=>Math.min(ge,$e),Number.POSITIVE_INFINITY);U>r*20&&k.push(B.map(ge=>ge/1e3)),U<=r*2&&le>=0&&U>0&&U<Math.max(120,b*5+10)&&k.push(B.map(ge=>ge*1e3));let Ie=B,we=0,qe=-1;return k.forEach(ge=>{const $e=ge.reduce((h,P)=>Math.min(h,P),Number.POSITIVE_INFINITY),o=new Set([0,...m,...S]);if(Number.isFinite($e)&&r>0&&$e>r){const h=Math.floor($e/r)*r;o.add(h),o.add(Math.max(0,h-r))}o.forEach(h=>{const P=ge.map(K=>K-h),ee=C(P);ee>qe&&(qe=ee,we=h,Ie=ge)})}),Ie.map(ge=>ge-we).filter(ge=>Number.isFinite(ge)&&ge>=0)},y=(l,m,S,b,F)=>{const r=L(l,m,S,b,F);return Array.from(new Set(r.map(C=>Math.floor(C/5e3)).filter(C=>Number.isFinite(C)&&C>=0&&C<b)))};W.map(l=>({log:l,ts:Ge(l==null?void 0:l.details,l)})).sort((l,m)=>l.ts-m.ts).forEach(({log:l},m)=>{const S=l==null?void 0:l.details;if(!S)return;const b=e(S.fightName||l.fightName||`Fight ${m+1}`),F=kt(S,l),r=n(b,String(F||"")),C={},k=(Array.isArray(S.players)?S.players:[]).filter(s=>!(s!=null&&s.notInSquad)),U=k.flatMap(s=>{const N=s==null?void 0:s.combatReplayData;return Array.isArray(N)?N.map(A=>Number(A==null?void 0:A.start)):[Number(N==null?void 0:N.start)]}).filter(s=>Number.isFinite(s)&&s>=0),le=k.flatMap(s=>{const N=s==null?void 0:s.combatReplayData;return(Array.isArray(N)?N:N?[N]:[]).flatMap(H=>w(H==null?void 0:H.down).map(([te])=>Number(te||0)))}),Ie=k.flatMap(s=>{const N=s==null?void 0:s.combatReplayData;return(Array.isArray(N)?N:N?[N]:[]).flatMap(H=>w(H==null?void 0:H.dead).map(([te])=>Number(te||0)))}),we=new Map,qe=new Map,ge=new Map;(Array.isArray(S.targets)?S.targets:[]).forEach((s,N)=>{if(!s||s.isFake||!s.enemyPlayer)return;const A=at((s==null?void 0:s.profession)||(s==null?void 0:s.name)||(s==null?void 0:s.id))||"Unknown";ge.set(A,(ge.get(A)||0)+1);const H=qe.get(A)||new Map;Array.isArray(s==null?void 0:s.totalDamageDist)&&s.totalDamageDist.forEach(oe=>{Array.isArray(oe)&&oe.forEach(Z=>{if(!Z||typeof Z!="object"||Z.indirectDamage)return;const J=Number(Z.totalDamage||0);if(!Number.isFinite(J)||J<=0)return;const p=Number(Z.connectedHits||Z.hits||0),I=D(Z.id,S),z=I.name,G=H.get(z)||{skillName:z,damage:0,hits:0,icon:I.icon};G.damage+=J,G.hits+=Number.isFinite(p)?p:0,!G.icon&&I.icon&&(G.icon=I.icon),H.set(z,G)})}),qe.set(A,H);const te=O(k.map(oe=>re(oe,N))),X=te.length>0?$(te):se(s),_=d(s,S);let Q=we.get(A);Q||(Q={perSecond:[],hit:0,skillName:""},we.set(A,Q)),X.length>Q.perSecond.length&&(Q.perSecond.length=X.length);for(let oe=0;oe<X.length;oe+=1)Q.perSecond[oe]=Number(Q.perSecond[oe]||0)+Number(X[oe]||0);const ne=Number(_.peak||0);ne>Q.hit&&(Q.hit=ne,Q.skillName=_.skillName||"Unknown Skill")});const o=Array.from(we.values()).some(s=>Array.isArray(s.perSecond)&&s.perSecond.some(N=>Number(N||0)>0));if(we.size===0||!o){const s=O(k.map(A=>{const H=V(A==null?void 0:A.powerDamageTaken1S);return $(H)})),N=Array.from(ge.values()).reduce((A,H)=>A+Number(H||0),0);s.length>0&&N>0&&ge.forEach((A,H)=>{const te=Number(A||0)/N,X=s.map(Q=>Number(Q||0)*te),_=we.get(H);we.set(H,{perSecond:X,hit:Number((_==null?void 0:_.hit)||0),skillName:String((_==null?void 0:_.skillName)||"")})})}we.forEach((s,N)=>{var I;const A=N,H=Number(s.hit||0),te=Number(Be(s.perSecond,1)||0),X=Number(Be(s.perSecond,5)||0),_=Number(Be(s.perSecond,30)||0),Q=Math.max(0,Math.ceil(Number((S==null?void 0:S.durationMS)||0)/5e3)),ne=Math.max(0,Math.ceil(s.perSecond.length/5)),oe=Math.max(Q,ne),Z=v(s.perSecond,5),J=Array.from({length:oe},(z,G)=>Number(Z[G]||0));C[A]={hit:H,burst1s:te,burst5s:X,burst30s:_,skillName:s.skillName||"Unknown Skill",buckets5s:J,downIndices5s:y(le,[],U,oe,Number((S==null?void 0:S.durationMS)||0)),deathIndices5s:y(Ie,[],U,oe,Number((S==null?void 0:S.durationMS)||0)),skillRows:Array.from(((I=qe.get(N))==null?void 0:I.values())||[]).sort((z,G)=>G.damage-z.damage).slice(0,50)};const p=a.get(A)||{key:A,account:N,displayName:N,characterName:"",profession:N,professionList:[N],logs:0,peakHit:0,peak1s:0,peak5s:0,peak30s:0,peakFightLabel:"",peakSkillName:""};p.logs+=1,H>p.peakHit&&(p.peakHit=H,p.peakFightLabel=r,p.peakSkillName=s.skillName||"Unknown Skill"),te>p.peak1s&&(p.peak1s=te),X>p.peak5s&&(p.peak5s=X),_>p.peak30s&&(p.peak30s=_),a.set(A,p)});const h=Object.values(C).reduce((s,N)=>Math.max(s,Number((N==null?void 0:N.hit)||0)),0),P=Object.values(C).reduce((s,N)=>Math.max(s,Number((N==null?void 0:N.burst1s)||0)),0),ee=Object.values(C).reduce((s,N)=>Math.max(s,Number((N==null?void 0:N.burst5s)||0)),0),K=Object.values(C).reduce((s,N)=>Math.max(s,Number((N==null?void 0:N.burst30s)||0)),0);u.push({id:l.filePath||l.id||`fight-${m+1}`,shortLabel:`F${m+1}`,fullLabel:r,timestamp:Ge(S,l),values:C,maxHit:h,max1s:P,max5s:ee,max30s:K})});const ce=Array.from(a.values()).sort((l,m)=>m.peakHit!==l.peakHit?m.peakHit-l.peakHit:l.displayName.localeCompare(m.displayName));return{fights:u,players:ce}})(),eo=Array.from(tt.entries()).map(([e,t])=>{const n=st.get(e)||{},u=Array.from(t.values()).map(a=>{var Be,v;const D=Array.from(a.professions||[]).filter(w=>w&&w!=="Unknown");let d=a.profession||"Unknown";if(D.length>0){d=D[0];let w=((Be=a.professionTimeMs)==null?void 0:Be[d])||0;D.forEach(L=>{var ce;const y=((ce=a.professionTimeMs)==null?void 0:ce[L])||0;y>w&&(w=y,d=L)})}const $=a.durationMs||0,O=a.totalMs/1e3,V=$>0?a.totalMs/$:0,se=((v=Ne.get(a.account))==null?void 0:v.supportActiveMs)||$,re=se>0?a.uptimeMs/se:0;return{account:a.account,profession:d,professionList:D,total:O,perSecond:V,uptimePerSecond:re,duration:$/1e3}}).filter(a=>a.total>0||a.perSecond>0);return{id:e,name:n.name||e,icon:n.icon,rows:u}}).filter(e=>e.rows.length>0),to=Array.from(Ve.values()).map(e=>{const t=Array.from(e.skills.values()).sort((u,a)=>a.damage-u.damage),n=t.reduce((u,a)=>(u[a.id]=a,u),{});return{key:e.key,account:e.account,displayName:e.displayName,profession:e.profession,professionList:e.professionList,totalFightMs:e.totalFightMs,skills:t,skillMap:n}}).sort((e,t)=>e.displayName.localeCompare(t.displayName));return{total:Y,wins:ke,losses:de,avgSquadSize:Ei,avgEnemies:Bi,squadKDR:Ii,enemyKDR:Pi,totalSquadKills:pe,totalSquadDeaths:fe,totalEnemyKills:he,totalEnemyDeaths:_e,leaderboards:xe,...Li,outgoingConditionSummary:Object.values(Ue).sort((e,t)=>t.damage-e.damage),incomingConditionSummary:Object.values(Re).sort((e,t)=>t.damage-e.damage),outgoingConditionPlayers:Array.from(Ne.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,conditions:e.outgoingConditions})),incomingConditionPlayers:Array.from(Ne.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,conditions:e.incomingConditions})),topSkills:Ri,topIncomingSkills:Oi,topSkillsByDamage:vn,topSkillsByDownContribution:Fn,playerSkillBreakdowns:to,topSkillsMetric:j,mapData:Wi,timelineData:zi,boonTables:ji,offensePlayers:Array.from(Ne.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,offenseTotals:e.offenseTotals,offenseRateWeights:e.offenseRateWeights,totalFightMs:e.totalFightMs})),defensePlayers:Array.from(Ne.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,defenseTotals:e.defenseTotals,activeMs:e.defenseActiveMs})),damageMitigationPlayers:Hi,damageMitigationMinions:Ui,supportPlayers:Array.from(Ne.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,supportTotals:e.supportTotals,activeMs:e.supportActiveMs})),healingPlayers:Array.from(Ne.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,healingTotals:e.healingTotals,activeMs:e.healingActiveMs})),mvp:Kt,silver:Tn,bronze:Mn,squadClassData:Vi,enemyClassData:Gi,fightBreakdown:Yi,attendanceData:Ji,squadCompByFight:Qi,spikeDamage:Zi,incomingStrikeDamage:yi,specialTables:eo,topStatsPerSecond:nt,topStatsLeaderboardsPerSecond:et,avgMvpScore:wn}})(),Je=(()=>{const Te=new Map,De=new Map,j=[],Y=new Map,ke=new Map;W.forEach(R=>{const ue=R.details;if(!ue)return;const fe=ue.skillMap||{},pe=ue.fightName||"Log",_e=Ge(ue,R)||Date.now(),he={id:R.filePath||R.id||pe,label:pe,timestamp:_e,skillEntries:{},playerActiveSeconds:{},durationSeconds:ue.durationMS?ue.durationMS/1e3:0};(ue.players||[]).forEach(Ee=>{if(Ee.notInSquad)return;const Ne=Ee.account||Ee.name||"Unknown",ze=Ee.profession||"Unknown",Ae=`${Ne}|${ze}`;let Me=De.get(Ae);Me||(Me={key:Ae,account:Ne,displayName:Ne,profession:ze,professionList:[ze],logs:0,totalActiveSeconds:0,skillTotals:{}},De.set(Ae,Me)),Me.logs++;const Ve=(Array.isArray(Ee.activeTimes)?Ee.activeTimes[0]:0)/1e3;Me.totalActiveSeconds=(Me.totalActiveSeconds||0)+Ve,he.playerActiveSeconds[Ae]=Ve,(Ee.rotation||[]).forEach(Ue=>{var Et,Bt,It;if(!(Ue!=null&&Ue.id))return;const Re=((Et=Ue.skills)==null?void 0:Et.length)||0;if(Re<=0)return;const Pe=`s${Ue.id}`,st=((Bt=fe[Pe])==null?void 0:Bt.name)||`Skill ${Ue.id}`,tt=(It=fe[Pe])==null?void 0:It.icon;Me.skillTotals[Pe]=(Me.skillTotals[Pe]||0)+Re,Te.set(Pe,(Te.get(Pe)||0)+Re),Y.set(Pe,st),tt&&!ke.has(Pe)&&ke.set(Pe,tt),he.skillEntries[Pe]||(he.skillEntries[Pe]={name:st,icon:tt,players:{}}),!he.skillEntries[Pe].icon&&tt&&(he.skillEntries[Pe].icon=tt),he.skillEntries[Pe].players[Ae]=(he.skillEntries[Pe].players[Ae]||0)+Re})}),j.push(he)});const de=Array.from(Te.entries()).map(([R,ue])=>({id:R,name:Y.get(R)||R,total:ue,icon:ke.get(R)})).sort((R,ue)=>ue.total-R.total);return{logRecords:j,players:Array.from(De.values()),skillOptions:de,resUtilitySkills:[]}})();return{validLogs:W,stats:Oe,skillUsageData:Je}};let ye=null,mt=!1,cn=null,ln=0,un=0,_t=null;const mn=i=>{if(!i||typeof i!="object")return i;const c=(E,q)=>{const W={};return q.forEach(Se=>{E&&Object.prototype.hasOwnProperty.call(E,Se)&&(W[Se]=E[Se])}),W},f=c(i,["players","targets","durationMS","uploadTime","timeStart","timeStartStd","timeEnd","timeEndStd","fightName","zone","mapName","map","location","permalink","uploadLinks","success","teamBreakdown","teamCounts","combatReplayMetaData","skillMap","buffMap","encounterDuration","player_damage_mitigation","player_minion_damage_mitigation","playerDamageMitigation","playerMinionDamageMitigation"]);return Array.isArray(f.players)&&(f.players=f.players.map(E=>c(E,["name","display_name","character_name","profession","elite_spec","group","dpsAll","statsAll","dpsTargets","statsTargets","defenses","support","rotation","extHealingStats","extBarrierStats","squadBuffVolumes","selfBuffs","groupBuffs","squadBuffs","selfBuffsActive","groupBuffsActive","squadBuffsActive","buffUptimes","totalDamageDist","targetDamageDist","damage1S","targetDamage1S","powerDamageTaken1S","targetPowerDamage1S","totalDamageTaken","totalDamageTakenDist","minions","combatReplayData","hasCommanderTag","notInSquad","account","activeTimes","teamID","teamId","team","teamColor","team_color"]))),Array.isArray(f.targets)&&(f.targets=f.targets.map(E=>c(E,["id","name","isFake","dpsAll","statsAll","defenses","totalHealth","healthPercentBurned","enemyPlayer","totalDamageDist","powerDamage1S","damage1S","profession","teamID","teamId","team","teamColor","team_color"]))),f},wi=i=>{if(!i||typeof i!="object")return i;const c={...i};return i.details?c.details=mn(i.details):c.details=mn(i),c},dn=()=>{if(!mt||!ye)return;mt=!1,ln+=1;const i=_t;_t=null;const c=Mi(ye);self.postMessage({type:"result",result:c,computeId:ln,logCount:ye.logs.length,token:un,completedAt:Date.now(),flushId:i})},qt=()=>{cn===null&&(cn=setInterval(()=>{dn()},5e3))};self.onmessage=i=>{var f,E,q,W;const c=i.data;if((c==null?void 0:c.type)==="reset"){ye={logs:[]},typeof c.token=="number"&&(un=c.token),mt=!0,qt();return}if((c==null?void 0:c.type)==="settings"){ye={logs:(ye==null?void 0:ye.logs)||[],precomputedStats:(f=c.payload)==null?void 0:f.precomputedStats,mvpWeights:(E=c.payload)==null?void 0:E.mvpWeights,statsViewSettings:(q=c.payload)==null?void 0:q.statsViewSettings,disruptionMethod:(W=c.payload)==null?void 0:W.disruptionMethod},mt=!0,qt();return}if((c==null?void 0:c.type)==="log"){ye||(ye={logs:[]}),ye.logs.push(wi(c.payload)),mt=!0,qt();return}(c==null?void 0:c.type)==="flush"&&(typeof c.flushId=="number"&&(_t=c.flushId),mt=!0,dn())}})();
