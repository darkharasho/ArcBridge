(function(){"use strict";const un=["selfBuffs","groupBuffs","squadBuffs"],dn=n=>n!=null&&n.classification?n.classification==="Boon":!0,fn=n=>`b${n}`,$n=(n,o)=>{const a=Array.isArray(n==null?void 0:n.activeTimes)?n.activeTimes:[],f=typeof a[0]=="number"?a[0]:0;return f>0?f:o},mn=(n,o,a,f,h,D,B)=>{const w=n==="selfBuffs"?1:Math.max(n==="groupBuffs"?D-1:B-1,0);return!w||!h?{generationMs:0,wastedMs:0}:o?{generationMs:a*h*w,wastedMs:f*h*w}:{generationMs:a/100*h*w,wastedMs:f/100*h*w}},xn=n=>{const o=new Map,a=new Map;return n.forEach(D=>{const B=D.details;if(!B)return;const w=B.durationMS||0,N=B.buffMap||{};Object.entries(N).forEach(([C,T])=>{if(!o.has(C)){o.set(C,T);return}const I=o.get(C)||{},p={name:I.name||T.name,stacking:I.stacking??T.stacking,icon:I.icon||T.icon,classification:I.classification||T.classification};o.set(C,p)});const de=(B.players||[]).filter(C=>!C.notInSquad),U=de.length,y=new Map;de.forEach(C=>{const T=C.group??0;y.set(T,(y.get(T)||0)+1)}),de.forEach(C=>{const T=C.account||C.name||C.character_name||"Unknown",I=C.profession||"Unknown",p=C.group??0,A=y.get(p)||1,P=$n(C,w);a.has(T)||a.set(T,{account:T,profession:I,professions:new Set,professionTimeMs:{},activeTimeMs:0,numFights:0,groupSupported:0,squadSupported:0,boons:{}});const F=a.get(T);F.profession=I,I!=="Unknown"&&(F.professions.add(I),F.professionTimeMs[I]=(F.professionTimeMs[I]||0)+P),F.activeTimeMs+=P,F.numFights+=1,F.groupSupported+=A,F.squadSupported+=U,un.forEach(R=>{(C[R]||[]).forEach(q=>{var Y,ie,z,Ae;if(typeof(q==null?void 0:q.id)!="number")return;const ee=fn(q.id),V=N[ee];if(!dn(V))return;const _=(V==null?void 0:V.stacking)??!1,pe=((ie=(Y=q.buffData)==null?void 0:Y[0])==null?void 0:ie.generation)??0,j=((Ae=(z=q.buffData)==null?void 0:z[0])==null?void 0:Ae.wasted)??0,{generationMs:$,wastedMs:le}=mn(R,_,pe,j,w,A,U);!$&&!le||(o.has(ee)||o.set(ee,V||{}),F.boons[ee]||(F.boons[ee]={selfBuffs:{generationMs:0,wastedMs:0},groupBuffs:{generationMs:0,wastedMs:0},squadBuffs:{generationMs:0,wastedMs:0}}),F.boons[ee][R].generationMs+=$,F.boons[ee][R].wastedMs+=le)})})})}),{boonTables:Array.from(o.keys()).filter(D=>dn(o.get(D))).map(D=>{const B=o.get(D)||{},w=[];return a.forEach(N=>{var C;const te=N.boons[D];if(!te||!un.some(T=>te[T].generationMs>0||te[T].wastedMs>0))return;const U=Array.from(N.professions||[]).filter(T=>T&&T!=="Unknown");let y=N.profession;if(U.length>0){y=U[0];let T=((C=N.professionTimeMs)==null?void 0:C[y])||0;U.forEach(I=>{var A;const p=((A=N.professionTimeMs)==null?void 0:A[I])||0;p>T&&(T=p,y=I)})}w.push({account:N.account,profession:y||"Unknown",professionList:U,activeTimeMs:N.activeTimeMs||1,numFights:N.numFights||1,groupSupported:N.groupSupported||1,squadSupported:N.squadSupported||1,categories:{selfBuffs:{...te.selfBuffs},groupBuffs:{...te.groupBuffs},squadBuffs:{...te.squadBuffs}}})}),{id:D,name:B.name||D,icon:B.icon,stacking:B.stacking??!1,rows:w}}).filter(D=>D.rows.length>0)}},pn=(n,o,a,f,h,D,B={})=>{var C,T,I,p;const N=((n==null?void 0:n[o])||[]).find(A=>A.id===a);if(!N)return{generationMs:0,wastedMs:0};const te=B[fn(a)],de=(te==null?void 0:te.stacking)??!1,U=((T=(C=N.buffData)==null?void 0:C[0])==null?void 0:T.generation)??0,y=((p=(I=N.buffData)==null?void 0:I[0])==null?void 0:p.wasted)??0;return mn(o,de,U,y,f,h,D)};var Wn={methods:{tiered:{tiers:{shortMs:500,mediumMs:1500,weights:{short:.5,medium:1,long:2}}}}};const _n=Wn,Ze="count",jn=n=>(n||0)/1e3,Hn=(n,o)=>{var h;if(!n)return 0;const a=(h=_n.methods.tiered)==null?void 0:h.tiers;if(!a)return n;const f=o/Math.max(n,1);return f<=a.shortMs?n*a.weights.short:f<=a.mediumMs?n*a.weights.medium:n*a.weights.long},gn=(n,o,a)=>a==="duration"?jn(o):a==="tiered"?Hn(n,o):n;function Vn(n,o=Ze){var D;const a=(D=n.statsAll)==null?void 0:D[0],f=Number((a==null?void 0:a.appliedCrowdControl)??0),h=Number((a==null?void 0:a.appliedCrowdControlDuration)??0);return gn(f,h,o)}function zn(n,o){const a=(o==null?void 0:o.durationMS)||0,f=(o==null?void 0:o.buffMap)||{},h=n.filter(w=>!w.notInSquad),D=h.length,B=new Map;h.forEach(w=>{const N=w.group??0;B.set(N,(B.get(N)||0)+1)}),h.forEach(w=>{const N=B.get(w.group??0)||1,te=pn(w,"selfBuffs",1122,a,N,D,f),de=pn(w,"squadBuffs",1122,a,N,D,f);w.stabGeneration=(te.generationMs+de.generationMs)/1e3})}function Kn(n){if(!n.statsTargets)return 0;let o=0;for(const a of n.statsTargets)a&&a.length>0&&(o+=a[0].downContribution||0);return o}function Gn(n){if(!n.extBarrierStats||!n.extBarrierStats.outgoingBarrierAllies)return 0;let o=0;for(const a of n.extBarrierStats.outgoingBarrierAllies)if(a)for(const f of a)f&&(o+=f.barrier||0);return o}function Jn(n){if(!n.extHealingStats||!n.extHealingStats.outgoingHealingAllies)return 0;let o=0;for(const a of n.extHealingStats.outgoingHealingAllies)if(a)for(const f of a)f&&(o+=f.healing||0);return o}const Yn=n=>{var o,a,f,h;return(((a=(o=n.support)==null?void 0:o[0])==null?void 0:a.condiCleanse)||0)+(((h=(f=n.support)==null?void 0:f[0])==null?void 0:h.condiCleanseSelf)||0)},Qn=(n,o=Ze)=>{var D;const a=(D=n.support)==null?void 0:D[0],f=Number((a==null?void 0:a.boonStrips)??0),h=Number((a==null?void 0:a.boonStripsTime)??0);return gn(f,h,o)},Xn=n=>Kn(n),Zn=n=>Jn(n),et=n=>Gn(n),nt=(n,o=Ze)=>Vn(n,o),tt=(n,o)=>zn(n,o),ot="count",st={downContribution:1,healing:1,cleanses:1,strips:1,stability:1,cc:.7,revives:.7,distanceToTag:.7,participation:.7,dodging:.4,dps:.2,damage:.2},it={showMvp:!0,topSkillDamageSource:"target",topSkillsMetric:"damage"},bn=new Map([["bleeding","Bleeding"],["burning","Burning"],["confusion","Confusion"],["poison","Poison"],["torment","Torment"],["vulnerability","Vulnerability"],["weakness","Weakness"],["weakened","Weakness"],["blind","Blind"],["blinded","Blind"],["blinding","Blind"],["cripple","Cripple"],["crippled","Cripple"],["chill","Chill"],["chilled","Chill"],["immob","Immobilize"],["immobile","Immobilize"],["immobilized","Immobilize"],["slow","Slow"],["slowed","Slow"],["fear","Fear"],["feared","Fear"],["taunt","Taunt"],["taunted","Taunt"]]),at={Blind:"https://render.guildwars2.com/file/09770136BB76FD0DBE1CC4267DEED54774CB20F6/102837.png",Chill:"https://render.guildwars2.com/file/28C4EC547A3516AF0242E826772DA43A5EAC3DF3/102839.png",Cripple:"https://render.guildwars2.com/file/070325E519C178D502A8160523766070D30C0C19/102838.png",Fear:"https://render.guildwars2.com/file/30307A6E766D74B6EB09EDA12A4A2DE50E4D76F4/102869.png",Immobilize:"https://render.guildwars2.com/file/397A613651BFCA2832B6469CE34735580A2C120E/102844.png",Slow:"https://render.guildwars2.com/file/F60D1EF5271D7B9319610855676D320CD25F01C6/961397.png",Taunt:"https://render.guildwars2.com/file/02EED459AD65FAF7DF32A260E479C625070841B9/1228472.png",Vulnerability:"https://render.guildwars2.com/file/3A394C1A0A3257EB27A44842DDEEF0DF000E1241/102850.png",Weakness:"https://render.guildwars2.com/file/6CB0E64AF9AA292E332A38C1770CE577E2CDE0E8/102853.png"},He=n=>{if(!n)return null;const o=n.trim().toLowerCase(),a=bn.get(o);if(a)return a;const f=o.split(/[^a-z]+/).filter(Boolean);for(const h of f){const D=bn.get(h);if(D)return D}return null},Cn=n=>{const o=new Map;return n&&(Object.values(n).forEach(a=>{if(!(a!=null&&a.icon)||!(a!=null&&a.name))return;const f=He(a.name);f&&(o.has(f)||o.set(f,a.icon))}),Object.entries(at).forEach(([a,f])=>{o.has(a)||o.set(a,f)})),o},Ve=(n,o,a)=>{var f;if(o&&a){const h=(f=a[`b${o}`])==null?void 0:f.name,D=He(h);if(D)return D}return n?He(n):null},rt=n=>{const o=(n==null?void 0:n.account)||"Unknown";return o&&o!=="Unknown"?o:(n==null?void 0:n.name)||"Unknown"||null},ct=n=>{if(!n||n.length===0)return 0;let o=0,a=null;return n.forEach(f=>{const h=Number(f[1]??0);if(Number.isFinite(h)){if(a===null){a=h;return}h>a&&(o+=h-a),a=h}}),o},lt=n=>{if(!n||n.length===0)return 0;let o=0;return n.forEach(a=>{const f=Number(a[0]??0),h=Number(a[1]??0);Number.isFinite(h)&&f!==0&&h>0&&(o+=1)}),o},ut=n=>{const{players:o,targets:a,skillMap:f,buffMap:h}=n,D=n.getPlayerKey||rt,B=Cn(h),w={},N={};o.forEach(C=>{if(C!=null&&C.notInSquad)return;const T=D(C);T&&(w[T]||(w[T]={}),C!=null&&C.totalDamageDist&&C.totalDamageDist.forEach(I=>{I&&I.forEach(p=>{if(!p.id)return;let A=`Skill ${p.id}`,P;f&&(f[`s${p.id}`]?(A=f[`s${p.id}`].name||A,P=f[`s${p.id}`].icon||P):f[`${p.id}`]&&(A=f[`${p.id}`].name||A,P=f[`${p.id}`].icon||P));const F=Ve(A,p.id,h);if(!F)return;const R=h==null?void 0:h[`b${p.id}`],oe=R==null?void 0:R.name,q=B.get(F)||(R==null?void 0:R.icon),ee=A.startsWith("Skill ")?oe||F:A,V=P||(R==null?void 0:R.icon),_=Number(p.connectedHits??0),pe=Number(p.hits??0),j=_>0?_:pe,$=Number(p.totalDamage??0);if(!Number.isFinite(j)&&!Number.isFinite($))return;const le=N[F]||{name:F,icon:q,applications:0,damage:0};le.applications+=Number.isFinite(j)?j:0,le.damage+=Number.isFinite($)?$:0,!le.icon&&q&&(le.icon=q),N[F]=le;const Y=w[T][F]||{icon:q,applications:0,damage:0,skills:{}};Y.applications+=Number.isFinite(j)?j:0,Y.damage+=Number.isFinite($)?$:0;const ie=Y.skills[ee]||{name:ee,hits:0,damage:0,icon:V};ie.hits+=Number.isFinite(j)?j:0,ie.damage+=Number.isFinite($)?$:0,!ie.icon&&V&&(ie.icon=V),Y.skills[ee]=ie,!Y.icon&&q&&(Y.icon=q),w[T][F]=Y})}))});const te=new Map;o.forEach(C=>{if(C!=null&&C.notInSquad)return;const T=D(C);T&&C!=null&&C.name&&te.set(C.name,T)});let de=0,U=0,y=0;return a.forEach(C=>{C!=null&&C.buffs&&C.buffs.forEach(T=>{const I=Number(T==null?void 0:T.id);if(!Number.isFinite(I))return;const p=h==null?void 0:h[`b${I}`];if((p==null?void 0:p.classification)!=="Condition")return;const A=(p==null?void 0:p.name)||He(p==null?void 0:p.name);if(!A)return;const P=T.statesPerSource||{};y+=1,Object.entries(P).forEach(([F,R])=>{var pe;const oe=te.get(F);if(!oe)return;U+=1;const q=ct(R),ee=lt(R);de+=q;const V=((pe=w[oe])==null?void 0:pe[A])||{applications:0,damage:0,skills:{}};V.applicationsFromBuffs=(V.applicationsFromBuffs||0)+q,V.applicationsFromBuffsActive=(V.applicationsFromBuffsActive||0)+ee,w[oe]=w[oe]||{},w[oe][A]=V;const _=N[A]||{name:A,applications:0,damage:0};_.applicationsFromBuffs=(_.applicationsFromBuffs||0)+q,_.applicationsFromBuffsActive=(_.applicationsFromBuffsActive||0)+ee,N[A]=_})})}),Object.values(w).forEach(C=>{Object.values(C).forEach(T=>{typeof T.applicationsFromBuffs=="number"&&(T.applications=T.applicationsFromBuffs)})}),Object.values(N).forEach(C=>{typeof C.applicationsFromBuffs=="number"&&(C.applications=C.applicationsFromBuffs)}),{playerConditions:w,summary:N,meta:{buffStateApplicationsTotal:de,targetBuffEntriesSeen:y,buffStateSourcesSeen:U}}},dt=[{id:"damage",label:"Damage",field:"damage",source:"dpsAll"},{id:"directDmg",label:"Direct Damage",field:"directDmg",source:"statsTargets"},{id:"connectedDamageCount",label:"Connected Damage Count",field:"connectedDamageCount",source:"statsTargets"},{id:"connectedDirectDamageCount",label:"Connected Direct Damage Count",field:"connectedDirectDamageCount",source:"statsTargets"},{id:"battleStandardHits",label:"Battle Standard Tracking"},{id:"criticalRate",label:"Critical Rate",field:"criticalRate",isRate:!0,isPercent:!0,denomField:"critableDirectDamageCount",source:"statsTargets"},{id:"criticalDmg",label:"Critical Damage",field:"criticalDmg",source:"statsTargets"},{id:"flankingRate",label:"Flanking Rate",field:"flankingRate",isRate:!0,isPercent:!0,denomField:"connectedDirectDamageCount",source:"statsTargets"},{id:"glanceRate",label:"Glance Rate",field:"glanceRate",isRate:!0,isPercent:!0,denomField:"connectedDirectDamageCount",source:"statsTargets"},{id:"missed",label:"Missed",field:"missed",source:"statsTargets"},{id:"evaded",label:"Evaded (enemy)",field:"evaded",source:"statsTargets"},{id:"blocked",label:"Blocked (enemy)",field:"blocked",source:"statsTargets"},{id:"interrupts",label:"Interrupts",field:"interrupts",source:"statsTargets"},{id:"invulned",label:"Invulned",field:"invulned",source:"statsTargets"},{id:"killed",label:"Killed",field:"killed",source:"statsTargets"},{id:"downed",label:"Downed",field:"downed",source:"statsTargets"},{id:"downContribution",label:"Down Contribution",field:"downContribution",source:"statsTargets"},{id:"downContributionPercent",label:"Down Contribution %",isRate:!0,isPercent:!0},{id:"againstDownedDamage",label:"Against Downed Damage",field:"againstDownedDamage",source:"statsTargets"},{id:"appliedCrowdControl",label:"Applied CC",field:"appliedCrowdControl",source:"statsTargets"},{id:"appliedCrowdControlDuration",label:"Applied CC Duration",field:"appliedCrowdControlDuration",source:"statsTargets"},{id:"appliedCrowdControlDownContribution",label:"Applied CC Down Contribution",field:"appliedCrowdControlDownContribution",source:"statsTargets"},{id:"appliedCrowdControlDurationDownContribution",label:"Applied CC Duration Down Contribution",field:"appliedCrowdControlDurationDownContribution",source:"statsTargets"},{id:"boonStrips",label:"Boon Strips",field:"boonStrips",source:"support"}],ft=[{id:"damageTaken",label:"Damage Taken",field:"damageTaken"},{id:"damageTakenCount",label:"Damage Taken Count",field:"damageTakenCount"},{id:"conditionDamageTaken",label:"Condition Damage Taken",field:"conditionDamageTaken"},{id:"conditionDamageTakenCount",label:"Condition Damage Taken Count",field:"conditionDamageTakenCount"},{id:"powerDamageTaken",label:"Power Damage Taken",field:"powerDamageTaken"},{id:"powerDamageTakenCount",label:"Power Damage Taken Count",field:"powerDamageTakenCount"},{id:"downedDamageTaken",label:"Downed Damage Taken",field:"downedDamageTaken"},{id:"downedDamageTakenCount",label:"Downed Damage Taken Count",field:"downedDamageTakenCount"},{id:"damageBarrier",label:"Damage Barrier",field:"damageBarrier"},{id:"damageBarrierCount",label:"Damage Barrier Count",field:"damageBarrierCount"},{id:"blockedCount",label:"Blocked Count",field:"blockedCount"},{id:"evadedCount",label:"Evaded Count",field:"evadedCount"},{id:"missedCount",label:"Missed Count",field:"missedCount"},{id:"dodgeCount",label:"Dodge Count",field:"dodgeCount"},{id:"invulnedCount",label:"Invulnerable Count",field:"invulnedCount"},{id:"interruptedCount",label:"Interrupted Count",field:"interruptedCount"},{id:"downCount",label:"Down Count",field:"downCount"},{id:"deadCount",label:"Death Count",field:"deadCount"},{id:"boonStrips",label:"Boon Strips (Incoming)",field:"boonStrips"},{id:"conditionCleanses",label:"Cleanses (Incoming)",field:"conditionCleanses"},{id:"receivedCrowdControl",label:"Crowd Control (Incoming)",field:"receivedCrowdControl"}],mt=[{id:"condiCleanse",label:"Condition Cleanses",field:"condiCleanse"},{id:"condiCleanseTime",label:"Condition Cleanse Time",field:"condiCleanseTime",isTime:!0},{id:"condiCleanseSelf",label:"Condition Cleanse Self",field:"condiCleanseSelf"},{id:"condiCleanseTimeSelf",label:"Condition Cleanse Time Self",field:"condiCleanseTimeSelf",isTime:!0},{id:"boonStrips",label:"Boon Strips",field:"boonStrips"},{id:"boonStripsTime",label:"Boon Strips Time",field:"boonStripsTime",isTime:!0},{id:"boonStripDownContribution",label:"Boon Strip Down Contribution",field:"boonStripDownContribution"},{id:"boonStripDownContributionTime",label:"Boon Strip Down Contribution Time",field:"boonStripDownContributionTime",isTime:!0},{id:"stunBreak",label:"Stun Breaks",field:"stunBreak"},{id:"removedStunDuration",label:"Removed Stun Duration",field:"removedStunDuration",isTime:!0},{id:"resurrects",label:"Resurrects",field:"resurrects"},{id:"resurrectTime",label:"Resurrect Time",field:"resurrectTime",isTime:!0}],pt=["battle standard","glyph of renewal","glyph of the stars","illusion of life","spirit of nature","nature spirit","search and rescue","signet of mercy"],gt=new Set([10244]),bt=(n,o)=>{var h;if(gt.has(n))return!0;const a=(o==null?void 0:o[`s${n}`])||(o==null?void 0:o[`${n}`]),f=((h=a==null?void 0:a.name)==null?void 0:h.toLowerCase())||"";return pt.some(D=>f.includes(D))},Ct=n=>{if(!n||!Number.isFinite(n))return"--:--";const o=Math.max(0,Math.round(n/1e3)),a=Math.floor(o/3600),f=Math.floor(o%3600/60),h=o%60;return a>0?`${a}:${String(f).padStart(2,"0")}:${String(h).padStart(2,"0")}`:`${f}:${String(h).padStart(2,"0")}`},ze={Guardian:"#72C1D9",Dragonhunter:"#72C1D9",Firebrand:"#72C1D9",Willbender:"#72C1D9",Revenant:"#D16E5A",Herald:"#D16E5A",Renegade:"#D16E5A",Vindicator:"#D16E5A",Warrior:"#FFD166",Berserker:"#FFD166",Spellbreaker:"#FFD166",Bladesworn:"#FFD166",Engineer:"#D09C59",Scrapper:"#D09C59",Holosmith:"#D09C59",Mechanist:"#D09C59",Ranger:"#8CDC82",Druid:"#8CDC82",Soulbeast:"#8CDC82",Untamed:"#8CDC82",Thief:"#C08F95",Daredevil:"#C08F95",Deadeye:"#C08F95",Specter:"#C08F95",Elementalist:"#F68A87",Tempest:"#F68A87",Weaver:"#F68A87",Catalyst:"#F68A87",Mesmer:"#B679D5",Chronomancer:"#B679D5",Mirage:"#B679D5",Virtuoso:"#B679D5",Necromancer:"#52A76F",Reaper:"#52A76F",Scourge:"#52A76F",Harbinger:"#52A76F",Ritualist:"#52A76F",Luminary:"#72C1D9",Conduit:"#D16E5A",Paragon:"#FFD166",Amalgam:"#D09C59",Galeshot:"#8CDC82",Antiquary:"#C08F95",Evoker:"#F68A87",Troubadour:"#B679D5",Unknown:"#64748B"};function hn(n){return ze[n]||ze.Unknown}const ht=n=>{if(n==null||n==="")return 0;if(typeof n=="number")return!Number.isFinite(n)||n<=0?0:n>1e12?n:n*1e3;if(n instanceof Date){const B=n.getTime();return Number.isFinite(B)&&B>0?B:0}const o=String(n).trim();if(!o)return 0;const a=Number(o);if(Number.isFinite(a)&&a>0)return a>1e12?a:a*1e3;const f=Date.parse(o);if(Number.isFinite(f)&&f>0)return f;const h=o.replace(/([+-]\d{2})$/,"$1:00"),D=Date.parse(h);return Number.isFinite(D)&&D>0?D:0},Ue=(n,o)=>ht((n==null?void 0:n.uploadTime)??(o==null?void 0:o.uploadTime)??(n==null?void 0:n.timeStartStd)??(n==null?void 0:n.timeStart)??(n==null?void 0:n.timeEndStd)??(n==null?void 0:n.timeEnd)??(n==null?void 0:n.timeStartText)??(n==null?void 0:n.timeEndText)),Dt=({logs:n,precomputedStats:o,mvpWeights:a,statsViewSettings:f,disruptionMethod:h})=>{const D=(()=>{const U=n.filter(y=>y.details&&y.details.players&&y.details.players.length>0);return console.log("[useStatsAggregation] Filtering logs:",{total:n.length,passed:U.length,statuses:n.map(y=>y.status),hasDetails:n.map(y=>!!y.details)}),U})(),B=f||it,w=a||st,N=U=>{if(!U||typeof U!="object")return U;const y=Array.isArray(U.fightBreakdown)?U.fightBreakdown:null;if(!y||y.length===0)return U;const C=new Map,T=new Map;n.forEach(p=>{var F;const A=(p==null?void 0:p.filePath)||(p==null?void 0:p.id);A&&C.set(String(A),p);const P=(p==null?void 0:p.permalink)||((F=p==null?void 0:p.details)==null?void 0:F.permalink);typeof P=="string"&&P.trim()&&T.set(P.trim(),p)});const I=y.map(p=>{if(!p||typeof p!="object"||Number(p.timestamp)>0)return p;const P=p.id?String(p.id):"",F=typeof p.permalink=="string"?p.permalink.trim():"",R=(P?C.get(P):void 0)||(F?T.get(F):void 0);if(!R)return p;const oe=Ue(R==null?void 0:R.details,R);return oe?{...p,timestamp:oe}:p});return{...U,fightBreakdown:I}},te=(()=>{if(o)return N(o);const U=h||ot,y=B.topSkillDamageSource||"target",C=B.topSkillsMetric||"damage",T=D.length;let I=0,p=0,A=0,P=0,F=0,R=0,oe=0,q=0;const ee=e=>{const s=((e==null?void 0:e.players)||[]).filter(v=>!v.notInSquad);let k=0,m=0,g=0,M=0;return s.forEach(v=>{var Q;const x=(Q=v.defenses)==null?void 0:Q[0];if(!x)return;const G=Number(x.downCount||0),se=Number(x.deadCount||0);k+=G+se,g+=se}),s.forEach(v=>{!v.statsTargets||v.statsTargets.length===0||v.statsTargets.forEach(x=>{const G=x==null?void 0:x[0];if(!G)return;const se=Number(G.downed||0),Q=Number(G.killed||0);m+=se+Q,M+=Q})}),{squadDownsDeaths:k,enemyDownsDeaths:m,squadDeaths:g,enemyDeaths:M}},V=e=>{const{squadDownsDeaths:i,enemyDownsDeaths:s}=ee(e);return i>0||s>0?s>i:typeof(e==null?void 0:e.success)=="boolean"?e.success:!1},_=new Map,pe=new Set(["boonStripsTime","condiCleanseTime","condiCleanseTimeSelf"]),j={},$={},le=new Map,Y={},ie={},z={},Ae=new Map,ke=new Map,Ke=new Set(Object.keys(ze)),Ge=Object.keys(ze).filter(e=>e&&e!=="Unknown").sort((e,i)=>i.length-e.length),Je=["Guardian","Revenant","Warrior","Engineer","Ranger","Thief","Elementalist","Mesmer","Necromancer"],tn=e=>{if(!e)return"Unknown";const i=String(e).replace(/\s*\([^)]*\)\s*$/,"").replace(/\s*\[[^\]]*\]\s*$/,"").replace(/\s\d+$/,"").trim();if(Ke.has(i))return i;const s=i.toLowerCase();for(const m of Ge)if(s.includes(m.toLowerCase()))return m;return Je.find(m=>s.includes(m.toLowerCase()))||i||"Unknown"},St=e=>e!=null&&e.classification?e.classification==="Boon":!0;console.log("[useStatsAggregation] Starting aggregation loop",{validLogsCount:D.length}),D.forEach((e,i)=>{var r,L;const s=e.details;if(!s)return;const k=s.players;console.log(`[useStatsAggregation] Processing log ${i}:`,{playerCount:k==null?void 0:k.length,hasTargets:!!s.targets,firstPlayer:k!=null&&k[0]?{account:k[0].account,notInSquad:k[0].notInSquad}:"none"});const m=s.targets||[],g=s.combatReplayMetaData||{},M=(g==null?void 0:g.inchToPixel)>0?g.inchToPixel:1,v=(g==null?void 0:g.pollingRate)>0?g.pollingRate:1,x=5e3,G=t=>Array.isArray(t)?t.map(d=>Array.isArray(d)?[Number(d[0]),Number(d[1])]:null).filter(d=>!!d&&Number.isFinite(d[0])):[];let se=[],Q=s.durationMS||0,Ee=!1;const me=k.find(t=>(t==null?void 0:t.hasCommanderTag)&&!(t!=null&&t.notInSquad));(r=me==null?void 0:me.combatReplayData)!=null&&r.positions&&(se=me.combatReplayData.positions,G(me.combatReplayData.dead).forEach(([d])=>{d>0&&(Ee=!0,Q=Math.min(Q,d))}));const Me=t=>{var ue;const d=(ue=t.statsAll)==null?void 0:ue[0];if((d==null?void 0:d.distToCom)!==void 0&&(d==null?void 0:d.distToCom)!=="Infinity")return Math.round(Number(d.distToCom));if((d==null?void 0:d.stackDist)!==void 0)return Math.round(Number(d.stackDist))||0;if(t.hasCommanderTag)return 0;const b=t.combatReplayData;if(!(b!=null&&b.positions)||!se.length)return 0;const E=b.positions,u=G(b.dead),O=G(b.down),ne=Math.floor((b.start||0)/v);let J=0;if(u.length&&O.length)for(const[ae]of u){if(ae<0)continue;const Ie=Math.max(0,Math.floor(ae/v))-ne;for(const[De,Te]of O){if(ae!==Te)continue;const Se=Ee&&De>Q?Math.max(1,Math.floor(Q/v)):Ie,re=Math.max(0,Math.min(Se,E.length,se.length));if(re<=0)continue;let ge=0;for(let ce=0;ce<re;ce++){const[ye,Re]=E[ce],[qe,Le]=se[ce];ge+=Math.hypot(ye-qe,Re-Le)}J=Math.round(ge/re/M)}}return J},X=k.filter(t=>!t.notInSquad),Ne=k.filter(t=>t.notInSquad);A+=X.length,P+=m.filter(t=>!t.isFake).length,tt(k,{durationMS:s.durationMS,buffMap:s.buffMap});const{squadDeaths:Fe,enemyDeaths:$e}=ee(s);F+=Fe,R+=$e,q+=Fe,oe+=$e,V(s)?I++:p++;const Qe=s.skillMap?Number((L=Object.keys(s.skillMap).find(t=>{var d,b;return((b=(d=s.skillMap)==null?void 0:d[t])==null?void 0:b.name)==="Battle Standard"}))==null?void 0:L.replace(/^s/,"")):null;k.forEach(t=>{var Re,qe,Le,je,Bn,Nn,In,Pn,yn,Rn;if(t.notInSquad)return;const d=t.account||"Unknown",b=d!=="Unknown"?d:t.name||"Unknown",E=t.name||"Unknown";_.has(b)||_.set(b,{name:E,account:b,downContrib:0,cleanses:0,strips:0,stab:0,healing:0,barrier:0,cc:0,logsJoined:0,totalDist:0,distCount:0,dodges:0,downs:0,deaths:0,totalFightMs:0,offenseTotals:{},offenseRateWeights:{},defenseActiveMs:0,defenseTotals:{},supportActiveMs:0,supportTotals:{},healingActiveMs:0,healingTotals:{},profession:t.profession||"Unknown",professions:new Set,professionTimeMs:{},isCommander:!1,damage:0,dps:0,revives:0,outgoingConditions:{},incomingConditions:{}});const u=_.get(b);if(t.hasCommanderTag&&(u.isCommander=!0),t.profession&&t.profession!=="Unknown"){u.profession=t.profession,u.professions.add(t.profession);const c=Array.isArray(t.activeTimes)&&typeof t.activeTimes[0]=="number"?t.activeTimes[0]:s.durationMS||0;u.professionTimeMs[t.profession]=(u.professionTimeMs[t.profession]||0)+c}u.logsJoined++,u.downContrib+=Xn(t),u.cleanses+=Yn(t),u.strips+=Qn(t,U),u.healing+=Zn(t),u.barrier+=et(t),u.cc+=nt(t,U),u.stab+=t.stabGeneration||0;const O=Me(t);O<=x&&(u.totalDist+=O,u.distCount++),(Re=t.defenses)!=null&&Re[0]&&(u.dodges+=t.defenses[0].dodgeCount||0,u.downs+=t.defenses[0].downCount||0,u.deaths+=t.defenses[0].deadCount||0),s.durationMS&&(u.totalFightMs+=s.durationMS);const ne=Array.isArray(t.activeTimes)&&typeof t.activeTimes[0]=="number"?t.activeTimes[0]:s.durationMS||0;u.defenseActiveMs+=ne,u.supportActiveMs+=ne,u.healingActiveMs+=ne,Array.isArray(t.buffUptimes)&&t.buffUptimes.length>0&&t.buffUptimes.forEach(c=>{var qn,Ln,Un,On;if(typeof(c==null?void 0:c.id)!="number")return;const l=`b${c.id}`,S=((qn=s.buffMap)==null?void 0:qn[l])||((Ln=s.buffMap)==null?void 0:Ln[String(c.id)]);if(!S||St(S))return;const W=Number(((On=(Un=c.buffData)==null?void 0:Un[0])==null?void 0:On.uptime)??0);if(!Number.isFinite(W)||W<=0)return;const Z=(S==null?void 0:S.stacking)??!1,ve=(Z?W:W/100)*ne;if(!Number.isFinite(ve)||ve<=0)return;Ae.has(l)||Ae.set(l,{name:S==null?void 0:S.name,stacking:Z,icon:S==null?void 0:S.icon}),ke.has(l)||ke.set(l,new Map);const Pe=ke.get(l),Be=u.account||t.account||t.name||"Unknown";let be=Pe.get(Be);be||(be={account:Be,profession:u.profession||t.profession||"Unknown",professions:new Set,professionTimeMs:{},totalMs:0,durationMs:0},Pe.set(Be,be));const _e=t.profession||u.profession;_e&&_e!=="Unknown"&&(be.professions.add(_e),be.professionTimeMs[_e]=(be.professionTimeMs[_e]||0)+ne,be.profession=_e),be.totalMs+=ve,be.durationMs+=ne}),(qe=t.defenses)!=null&&qe[0]&&ft.forEach(c=>{const l=Number(t.defenses[0][c.field]??0);Number.isFinite(l)&&(u.defenseTotals[c.id]=(u.defenseTotals[c.id]||0)+l)}),(Le=t.support)!=null&&Le[0]&&mt.forEach(c=>{let l=Number(t.support[0][c.field]??0);Number.isFinite(l)&&(pe.has(c.field)&&l>999999&&(l=0),u.supportTotals[c.id]=(u.supportTotals[c.id]||0)+l)});const J=(c,l)=>{Number.isFinite(l)&&(u.healingTotals[c]=(u.healingTotals[c]||0)+l)};if(Array.isArray(t.rotation)){let c=0;t.rotation.forEach(l=>{var W;if(!(l!=null&&l.id)||!bt(l.id,s.skillMap))return;const S=((W=l.skills)==null?void 0:W.length)||0;S>0&&(c+=S,J(`resUtility_s${l.id}`,S))}),c>0&&J("resUtility",c)}const ue=(je=t.statsAll)==null?void 0:je[0],ae=(Bn=t.dpsAll)==null?void 0:Bn[0],Ie=(Nn=t.support)==null?void 0:Nn[0];if(dt.forEach(c=>{if(c.id==="downContributionPercent"||!c.field)return;let l=0,S=0;c.source==="dpsAll"&&ae?l=Number(ae[c.field]??0):c.source==="statsAll"&&ue?(l=Number(ue[c.field]??0),S=Number(ue[c.denomField||c.weightField||"connectedDamageCount"]??0)):c.source==="support"&&Ie?l=Number(Ie[c.field]??0):t.statsTargets&&t.statsTargets.forEach(W=>{W!=null&&W[0]&&(l+=Number(W[0][c.field]??0),S+=Number(W[0][c.denomField||c.weightField||"connectedDamageCount"]??0))}),Number.isFinite(l)&&(u.offenseTotals[c.id]=(u.offenseTotals[c.id]||0)+l,c.isRate&&S>0&&(u.offenseRateWeights[c.id]=(u.offenseRateWeights[c.id]||0)+S))}),t.targetDamageDist&&Number.isFinite(Qe)){const c=t.targetDamageDist.flatMap(l=>l||[]).flatMap(l=>l||[]).reduce((l,S)=>S!=null&&S.id&&S.id===Qe?l+((S==null?void 0:S.connectedHits)||0):l,0);u.offenseTotals.battleStandardHits=(u.offenseTotals.battleStandardHits||0)+c}u.revives+=((Pn=(In=t.support)==null?void 0:In[0])==null?void 0:Pn.resurrects)||0,ae&&(u.damage+=ae.damage||0,u.dps+=ae.dps||0);const De=c=>{var Z,We,ve,Pe;let l=`Skill ${c.id}`;const S=((Z=s.skillMap)==null?void 0:Z[`s${c.id}`])||((We=s.skillMap)==null?void 0:We[`${c.id}`]);let W=S==null?void 0:S.icon;if(S!=null&&S.name&&(l=S.name),l.startsWith("Skill ")){const Be=Ve(l,c.id,s.buffMap);Be&&(l=Be,W=((Pe=(ve=s.buffMap)==null?void 0:ve[`b${c.id}`])==null?void 0:Pe.icon)||W)}return{name:l,icon:W}},Te=c=>{if(!(c!=null&&c.id))return;const{name:l,icon:S}=De(c);j[c.id]||(j[c.id]={name:l,icon:S,damage:0,hits:0,downContribution:0}),j[c.id].name.startsWith("Skill ")&&!l.startsWith("Skill ")&&(j[c.id].name=l),!j[c.id].icon&&S&&(j[c.id].icon=S),j[c.id].damage+=c.totalDamage,j[c.id].hits+=c.connectedHits,j[c.id].downContribution+=Number(c.downContribution||0)},Se=t.account||t.name||"Unknown",re=t.profession||"Unknown",ge=`${Se}|${re}`;let ce=le.get(ge);ce||(ce={key:ge,account:Se,displayName:Se,profession:re,professionList:[re],totalFightMs:0,skills:new Map},le.set(ge,ce)),ce.professionList.includes(re)||ce.professionList.push(re),ce.totalFightMs+=s.durationMS||0;const ye=c=>{if(!(c!=null&&c.id))return;const{name:l,icon:S}=De(c),W=`s${c.id}`;let Z=ce.skills.get(W);Z||(Z={id:W,name:l,icon:S,damage:0,downContribution:0},ce.skills.set(W,Z)),Z.name.startsWith("Skill ")&&!l.startsWith("Skill ")&&(Z.name=l),!Z.icon&&S&&(Z.icon=S),Z.damage+=Number(c.totalDamage||0),Z.downContribution+=Number(c.downContribution||0)};y==="total"?(yn=t.totalDamageDist)==null||yn.forEach(c=>{c==null||c.forEach(l=>{Te(l),ye(l)})}):(Rn=t.targetDamageDist)==null||Rn.forEach(c=>{c==null||c.forEach(l=>{l==null||l.forEach(S=>{Te(S),ye(S)})})}),t.totalDamageTaken&&t.totalDamageTaken.forEach(c=>{c==null||c.forEach(l=>{var We,ve,Pe,Be;if(!(l!=null&&l.id))return;let S=`Skill ${l.id}`;const W=((We=s.skillMap)==null?void 0:We[`s${l.id}`])||((ve=s.skillMap)==null?void 0:ve[`${l.id}`]);let Z=W==null?void 0:W.icon;if(W!=null&&W.name&&(S=W.name),S.startsWith("Skill ")){const be=Ve(S,l.id,s.buffMap);be&&(S=be,Z=((Be=(Pe=s.buffMap)==null?void 0:Pe[`b${l.id}`])==null?void 0:Be.icon)||Z)}$[l.id]||($[l.id]={name:S,icon:Z,damage:0,hits:0}),(!$[l.id].name.startsWith("Skill ")||S.startsWith("Skill "))&&($[l.id].name=S),!$[l.id].icon&&Z&&($[l.id].icon=Z),$[l.id].damage+=l.totalDamage,$[l.id].hits+=l.hits})})}),Ne.forEach(t=>{const d=tn(t.profession||t.name);d&&(z[d]=(z[d]||0)+1)});const Xe=ut({players:k,targets:m,skillMap:s.skillMap,buffMap:s.buffMap,getPlayerKey:t=>t.account&&t.account!=="Unknown"?t.account:t.name||null}),ln=Cn(s.buffMap);Object.entries(Xe.playerConditions).forEach(([t,d])=>{const b=_.get(t);b&&Object.entries(d).forEach(([E,u])=>{const O=b.outgoingConditions[E]||{applications:0,damage:0,skills:{},icon:u.icon};O.applications+=Number(u.applications||0),O.damage+=Number(u.damage||0),u.applicationsFromBuffs&&(O.applicationsFromBuffs=(O.applicationsFromBuffs||0)+u.applicationsFromBuffs),u.applicationsFromBuffsActive&&(O.applicationsFromBuffsActive=(O.applicationsFromBuffsActive||0)+u.applicationsFromBuffsActive),Object.entries(u.skills||{}).forEach(([ne,J])=>{const ue=O.skills[ne]||{name:J.name,hits:0,damage:0,icon:J.icon};ue.hits+=Number(J.hits||0),ue.damage+=Number(J.damage||0),!ue.icon&&J.icon&&(ue.icon=J.icon),O.skills[ne]=ue}),!O.icon&&u.icon&&(O.icon=u.icon),b.outgoingConditions[E]=O})}),Object.entries(Xe.summary).forEach(([t,d])=>{const b=Y[t]||{name:d.name||t,icon:d.icon,applications:0,damage:0};b.applications+=Number(d.applications||0),b.damage+=Number(d.damage||0),d.applicationsFromBuffs&&(b.applicationsFromBuffs=(b.applicationsFromBuffs||0)+d.applicationsFromBuffs),d.applicationsFromBuffsActive&&(b.applicationsFromBuffsActive=(b.applicationsFromBuffsActive||0)+d.applicationsFromBuffsActive),!b.icon&&d.icon&&(b.icon=d.icon),Y[t]=b}),X.forEach(t=>{const d=t.account&&t.account!=="Unknown"?t.account:t.name||"Unknown",b=_.get(d);!b||!t.totalDamageTaken||t.totalDamageTaken.forEach(E=>E==null?void 0:E.forEach(u=>{var ce,ye,Re,qe,Le,je;if(!(u!=null&&u.id))return;let O=`Skill ${u.id}`;const ne=((ce=s.skillMap)==null?void 0:ce[`s${u.id}`])||((ye=s.skillMap)==null?void 0:ye[`${u.id}`]);ne!=null&&ne.name&&(O=ne.name);const J=Ve(O,u.id,s.buffMap);if(!J)return;const ue=(qe=(Re=s.buffMap)==null?void 0:Re[`b${u.id}`])==null?void 0:qe.name,ae=ln.get(J)||((je=(Le=s.buffMap)==null?void 0:Le[`b${u.id}`])==null?void 0:je.icon),Ie=(ne==null?void 0:ne.icon)||ae;O.startsWith("Skill ")&&(ue||J)&&(O=ue||J);const De=Number(u.hits??0),Te=Number(u.totalDamage??0),Se=ie[J]||{name:J,icon:ae,applications:0,damage:0};Se.applications+=Number.isFinite(De)?De:0,Se.damage+=Number.isFinite(Te)?Te:0,!Se.icon&&ae&&(Se.icon=ae),ie[J]=Se;const re=b.incomingConditions[J]||{applications:0,damage:0,skills:{},icon:ae};re.applications+=Number.isFinite(De)?De:0,re.damage+=Number.isFinite(Te)?Te:0;const ge=re.skills[O]||{name:O,hits:0,damage:0,icon:Ie};ge.hits+=Number.isFinite(De)?De:0,ge.damage+=Number.isFinite(Te)?Te:0,!ge.icon&&Ie&&(ge.icon=Ie),re.skills[O]=ge,!re.icon&&ae&&(re.icon=ae),b.incomingConditions[J]=re}))})});const kt=T>0?Math.round(A/T):0,wt=T>0?Math.round(P/T):0,Mt=F>0?(R/F).toFixed(2):R>0?"∞":"0.00",At=oe>0?(q/oe).toFixed(2):q>0?"∞":"0.00",Mn=(e,i)=>{const k=e.filter(M=>Number.isFinite(M.value)&&(i?M.value>0:M.value>=0)).sort((M,v)=>{const x=i?v.value-M.value:M.value-v.value;return x!==0?x:M.account.localeCompare(v.account)});let m=null,g=0;return k.map((M,v)=>((m===null||M.value!==m)&&(g=v+1,m=M.value),{rank:g,...M}))},on=Array.from(_.values()).map(e=>{const i=Array.from(e.professions).filter(s=>s!=="Unknown");if(e.professionList=i,i.length>0){let s=i[0],k=e.professionTimeMs[s]||0;i.forEach(m=>{const g=e.professionTimeMs[m]||0;g>k&&(k=g,s=m)}),e.profession=s}return{key:e.account,stat:e}}),Ye=(e,i)=>{switch(i){case"downContrib":return e.downContrib;case"barrier":return e.barrier;case"healing":return e.healing;case"dodges":return e.dodges;case"strips":return e.strips;case"cleanses":return e.cleanses;case"cc":return e.cc;case"stability":return e.stab;case"revives":return e.revives;case"dps":return e.dps;case"damage":return e.damage;case"participation":return e.logsJoined;case"closestToTag":return!e.isCommander&&e.distCount>0?e.totalDist/e.distCount:Number.POSITIVE_INFINITY;default:return 0}},fe=(e,i)=>Mn(on.map(({stat:s})=>({account:s.account,profession:s.profession,professionList:s.professionList,value:Ye(s,e),count:s.logsJoined})),i),K={downContrib:fe("downContrib",!0),barrier:fe("barrier",!0),healing:fe("healing",!0),dodges:fe("dodges",!0),strips:fe("strips",!0),cleanses:fe("cleanses",!0),cc:fe("cc",!0),stability:fe("stability",!0),revives:fe("revives",!0),participation:fe("participation",!0),dps:fe("dps",!0),damage:fe("damage",!0),closestToTag:fe("closestToTag",!1).filter(e=>Number.isFinite(e.value))},Et={downContrib:"downContrib",barrier:"barrier",healing:"healing",dodges:"dodges",strips:"strips",cleanses:"cleanses",cc:"cc",stability:"stability",closestToTag:"closestToTag"},H=e=>{const i=e==null?void 0:e[0];return{value:(i==null?void 0:i.value)??0,player:(i==null?void 0:i.account)??"-",count:(i==null?void 0:i.count)??0,profession:(i==null?void 0:i.profession)??"Unknown",professionList:(i==null?void 0:i.professionList)??[]}},we={maxDownContrib:H([]),maxBarrier:H([]),maxHealing:H([]),maxDodges:H([]),maxStrips:H([]),maxCleanses:H([]),maxCC:H([]),maxStab:H([]),closestToTag:H([])},he={},Ft=(e,i)=>{if(i==="closestToTag")return Ye(e,i);const s=Math.max(1,(e.totalFightMs||0)/1e3);return Ye(e,i)/s};Object.values(Et).forEach(e=>{const i=e!=="closestToTag";he[e]=Mn(on.map(({stat:s})=>({account:s.account,profession:s.profession,professionList:s.professionList,value:Ft(s,e),count:s.logsJoined})),i)}),we.maxDownContrib=H(he.downContrib),we.maxBarrier=H(he.barrier),we.maxHealing=H(he.healing),we.maxDodges=H(he.dodges),we.maxStrips=H(he.strips),we.maxCleanses=H(he.cleanses),we.maxCC=H(he.cc),we.maxStab=H(he.stability),we.closestToTag=H(he.closestToTag);const vt={maxDownContrib:H(K.downContrib),maxBarrier:H(K.barrier),maxHealing:H(K.healing),maxDodges:H(K.dodges),maxStrips:H(K.strips),maxCleanses:H(K.cleanses),maxCC:H(K.cc),maxStab:H(K.stability),closestToTag:H(K.closestToTag)};let sn={player:"None",account:"None",score:-1,profession:"Unknown",professionList:[],color:"#64748b",topStats:[]},An,En,Fn=0;if(B!=null&&B.showMvp){const e={"Down Contribution":"downContribution",Healing:"healing",Cleanses:"cleanses",Strips:"strips",Stability:"stability",CC:"cc",Revives:"revives","Distance to Tag":"distanceToTag",Participation:"participation",Dodging:"dodging",DPS:"dps",Damage:"damage"},i=g=>{const M=e[g];return M?Number(w[M]||0)>0:!1},s=[],k=g=>[...g||[]].filter(M=>i(M==null?void 0:M.name)).sort((M,v)=>v.ratio-M.ratio||M.rank-v.rank||M.name.localeCompare(v.name)).slice(0,3),m=g=>{var v;if(!g)return;const M=k(g.contribs);return{...g,player:g.name,reason:((v=M[0])==null?void 0:v.name)||"Top Performance",topStats:M}};on.forEach(({stat:g})=>{let M=0;const v=[],x=(G,se,Q,Ee,me=!0)=>{var X,Ne;if(Q<=0)return;const Me=((X=se[0])==null?void 0:X.value)||0;if(Me&&Number.isFinite(G)&&(me?G>0:G<Number.POSITIVE_INFINITY)){const Fe=me?G/Me:Me/G;M+=Fe*Q;const $e=((Ne=se.find(xe=>xe.account===g.account))==null?void 0:Ne.rank)||0;v.push({name:Ee,ratio:Fe,val:G.toLocaleString(),rank:$e})}};x(g.downContrib,K.downContrib,w.downContribution,"Down Contribution"),x(g.healing,K.healing,w.healing,"Healing"),x(g.cleanses,K.cleanses,w.cleanses,"Cleanses"),x(g.strips,K.strips,w.strips,"Strips"),x(g.stab,K.stability,w.stability,"Stability"),x(g.cc,K.cc,w.cc,"CC"),x(g.revives,K.revives,w.revives,"Revives"),x(Ye(g,"closestToTag"),K.closestToTag,w.distanceToTag,"Distance to Tag",!1),x(g.logsJoined,K.participation,w.participation,"Participation"),x(g.dodges,K.dodges,w.dodging,"Dodging"),x(g.dps,K.dps,w.dps,"DPS"),x(g.damage,K.damage,w.damage,"Damage"),s.push({...g,score:M,contribs:v.filter(G=>i(G.name))})}),s.sort((g,M)=>M.score-g.score),s[0]&&s[0].score>0&&(sn=m(s[0])||sn),An=m(s[1]),En=m(s[2]),Fn=s.length>0?s.reduce((g,M)=>g+M.score,0)/s.length:0}const Bt=Object.values(j).sort((e,i)=>{const s=C==="downContribution"?e.downContribution:e.damage;return(C==="downContribution"?i.downContribution:i.damage)-s}).slice(0,25),Nt=Object.values($).sort((e,i)=>i.damage-e.damage).slice(0,25),It=e=>{const i=String(e).replace(/^Detailed\s*WvW\s*-\s*/i,"").replace(/^World\s*vs\s*World\s*-\s*/i,"").replace(/^WvW\s*-\s*/i,"").trim(),s=i.match(/^(Red|Blue|Green)\s+(?:Alpine|Desert)?\s*Borderlands$/i);return s?`${s[1]} Borderlands`:i||"Unknown"},vn=(e,i)=>It((e==null?void 0:e.zone)||(e==null?void 0:e.mapName)||(e==null?void 0:e.map)||(e==null?void 0:e.location)||(e==null?void 0:e.fightName)||(i==null?void 0:i.fightName)||(i==null?void 0:i.encounterName)||"Unknown"),Pt=(e,i)=>{const s=(i==null?void 0:i.permalink)||(e==null?void 0:e.permalink);if(typeof s=="string"&&s.trim().length>0)return s.trim();const k=e==null?void 0:e.uploadLinks;if(!Array.isArray(k))return"";for(const m of k){if(typeof m=="string"&&m.trim().length>0)return m.trim();if(m&&typeof m=="object"){const g=m.permalink||m.link||m.url||m.reportLink;if(typeof g=="string"&&g.trim().length>0)return g.trim()}}return""},an={};D.forEach(e=>{const i=vn(e==null?void 0:e.details,e);an[i]=(an[i]||0)+1});const yt=Object.entries(an).map(([e,i])=>{const s=String(e).trim(),k=/eternal battlegrounds|^ebg$/i.test(s);let m="#64748b";return k?m="#ffffff":/red/i.test(s)?m="#ef4444":/blue/i.test(s)?m="#3b82f6":/green/i.test(s)&&(m="#22c55e"),{name:e,value:i,color:m}}).sort((e,i)=>i.value-e.value),{boonTables:Rt}=xn(D),qt=D.map((e,i)=>{var k,m;const s=((k=e.details)==null?void 0:k.players)||[];return{index:i+1,label:`Log ${i+1}`,timestamp:Ue(e.details,e),squadCount:s.filter(g=>!g.notInSquad).length,friendlyCount:s.length,enemies:((m=e.details)==null?void 0:m.targets).filter(g=>!g.isFake).length}}).sort((e,i)=>e.timestamp-i.timestamp),rn={};Array.from(_.values()).forEach(e=>{e.profession&&e.profession!=="Unknown"&&(rn[e.profession]=(rn[e.profession]||0)+1)});const Lt=Object.entries(rn).map(([e,i])=>({name:e,value:i,color:hn(e)})).sort((e,i)=>i.value-e.value),cn={};Object.keys(z).length===0&&D.forEach(e=>{var i,s;(s=(i=e.details)==null?void 0:i.targets)==null||s.forEach(k=>{if(k.isFake)return;const m=k.profession&&k.profession!=="Unknown"?k.profession:k.name||k.id||"Unknown",g=tn(m);cn[g]=(cn[g]||0)+1})});const Ut=Object.keys(z).length>0?z:cn,Ot=Object.entries(Ut).map(([e,i])=>({name:e,value:i,color:hn(e)})).sort((e,i)=>i.value-e.value),$t=D.map((e,i)=>({log:e,originalIndex:i})).sort((e,i)=>Ue(e.log.details,e.log)-Ue(i.log.details,i.log)).map(({log:e},i)=>{const s=e.details;if(!s)return null;const k=s.players||[],m=k.filter(r=>!r.notInSquad),g=k.filter(r=>r.notInSquad),M=s.targets||[],v=M.filter(r=>!r.isFake),x=m.reduce((r,L)=>{var t,d;return r+(((d=(t=L.dpsAll)==null?void 0:t[0])==null?void 0:d.damage)||0)},0),G=m.reduce((r,L)=>{var t,d;return r+(((d=(t=L.defenses)==null?void 0:t[0])==null?void 0:d.damageTaken)||0)},0),{enemyDeaths:se,enemyDownsDeaths:Q}=ee(s),Ee=V(s),me=Ue(s,e),Me=vn(s,e),X={red:0,green:0,blue:0},Ne=r=>{const L=Number(r);return Number.isFinite(L)?L:0},Fe=r=>{if(!r||typeof r!="object")return;const L=r.teamID??r.teamId??r.team??r.teamColor??r.team_color;if(L!=null)return L;const t=Object.keys(r).find(d=>/^team/i.test(d));return t?r[t]:void 0},$e=(r,L)=>{if(r==null)return null;if(typeof r=="string"){const t=r.toLowerCase();return t.includes("red")?"red":t.includes("green")?"green":t.includes("blue")?"blue":t==="r"?"red":t==="g"?"green":t==="b"?"blue":null}if(typeof r=="number")if(L==="zeroBased"){if(r===0)return"red";if(r===1)return"green";if(r===2)return"blue"}else{if(r===1)return"red";if(r===2)return"green";if(r===3)return"blue"}return null},xe=(r,L)=>{const t={};return r.forEach(d=>{const b=L(d),E=tn(b);E&&(t[E]=(t[E]||0)+1)}),t},Qe=xe(m,r=>(r==null?void 0:r.profession)||(r==null?void 0:r.name)),Xe=xe(g,r=>(r==null?void 0:r.profession)||(r==null?void 0:r.name)),ln=xe(v,r=>(r==null?void 0:r.profession)||(r==null?void 0:r.name)||(r==null?void 0:r.id));if(s.teamCounts&&typeof s.teamCounts=="object"){const r=s.teamCounts;X.red=Ne(r.red??r.r??r[0]??r[1]),X.green=Ne(r.green??r.g??r[1]??r[2]),X.blue=Ne(r.blue??r.b??r[2]??r[3])}else{const r=[];M.forEach(b=>{if(b!=null&&b.isFake)return;const E=Fe(b);E!=null&&r.push(E)}),k.forEach(b=>{if(!(b!=null&&b.notInSquad))return;const E=Fe(b);E!=null&&r.push(E)}),r.length===0&&k.forEach(b=>{const E=Fe(b);E!=null&&r.push(E)});const L=new Set;r.forEach(b=>{typeof b=="number"&&L.add(b)});const t=L.has(0)?"zeroBased":L.has(3)?"oneBased":"zeroBased";if(r.forEach(b=>{const E=$e(b,t);E&&(X[E]+=1)}),X.red+X.green+X.blue===0&&r.length>0){const b=new Map;r.forEach(u=>{const O=String(u);b.set(O,(b.get(O)||0)+1)});const E=Array.from(b.values()).sort((u,O)=>O-u);X.red=E[0]||0,X.green=E[1]||0,X.blue=E[2]||0}X.red+X.green+X.blue===0&&(X.red=Math.max(v.length,k.filter(b=>b==null?void 0:b.notInSquad).length))}return{id:e.filePath||`fight-${i}`,label:e.encounterName||`Fight ${i+1}`,permalink:Pt(s,e),timestamp:me,mapName:Me,duration:Ct(s.durationMS),isWin:Ee,squadCount:m.length,allyCount:g.length,enemyCount:v.length,teamCounts:X,alliesDown:m.reduce((r,L)=>{var t,d;return r+(((d=(t=L.defenses)==null?void 0:t[0])==null?void 0:d.downCount)||0)},0),alliesDead:m.reduce((r,L)=>{var t,d;return r+(((d=(t=L.defenses)==null?void 0:t[0])==null?void 0:d.deadCount)||0)},0),alliesRevived:m.reduce((r,L)=>{var t,d;return Number(((d=(t=L.statsAll)==null?void 0:t[0])==null?void 0:d.saved)||0)>0?r+1:r},0),rallies:0,enemyDeaths:se,enemyDowns:Math.max(0,Q-se),totalOutgoingDamage:x,totalIncomingDamage:G,incomingBarrierAbsorbed:m.reduce((r,L)=>{var t,d;return r+(((d=(t=L.defenses)==null?void 0:t[0])==null?void 0:d.damageBarrier)||0)},0),outgoingBarrierAbsorbed:m.reduce((r,L)=>{var b;const t=(b=L.extBarrierStats)==null?void 0:b.outgoingBarrier;if(!Array.isArray(t))return r;let d=0;return t.forEach(E=>{if(Array.isArray(E)){E.forEach(u=>{d+=Number((u==null?void 0:u.barrier)||0)});return}d+=Number((E==null?void 0:E.barrier)||0)}),r+d},0),squadClassCountsFight:Qe,allyClassCountsFight:Xe,enemyClassCounts:ln}}).filter(Boolean),xt=Array.from(ke.entries()).map(([e,i])=>{const s=Ae.get(e)||{},k=Array.from(i.values()).map(m=>{var se;const g=Array.from(m.professions||[]).filter(Q=>Q&&Q!=="Unknown");let M=m.profession||"Unknown";if(g.length>0){M=g[0];let Q=((se=m.professionTimeMs)==null?void 0:se[M])||0;g.forEach(Ee=>{var Me;const me=((Me=m.professionTimeMs)==null?void 0:Me[Ee])||0;me>Q&&(Q=me,M=Ee)})}const v=m.durationMs||0,x=m.totalMs/1e3,G=v>0?m.totalMs/v:0;return{account:m.account,profession:M,professionList:g,total:x,perSecond:G,duration:v/1e3}}).filter(m=>m.total>0||m.perSecond>0);return{id:e,name:s.name||e,icon:s.icon,rows:k}}).filter(e=>e.rows.length>0),Wt=Array.from(le.values()).map(e=>{const i=Array.from(e.skills.values()).sort((k,m)=>m.damage-k.damage),s=i.reduce((k,m)=>(k[m.id]=m,k),{});return{key:e.key,account:e.account,displayName:e.displayName,profession:e.profession,professionList:e.professionList,totalFightMs:e.totalFightMs,skills:i,skillMap:s}}).sort((e,i)=>e.displayName.localeCompare(i.displayName));return{total:T,wins:I,losses:p,avgSquadSize:kt,avgEnemies:wt,squadKDR:Mt,enemyKDR:At,totalSquadKills:R,totalSquadDeaths:F,totalEnemyKills:q,totalEnemyDeaths:oe,leaderboards:K,...vt,outgoingConditionSummary:Object.values(Y).sort((e,i)=>i.damage-e.damage),incomingConditionSummary:Object.values(ie).sort((e,i)=>i.damage-e.damage),outgoingConditionPlayers:Array.from(_.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,conditions:e.outgoingConditions})),incomingConditionPlayers:Array.from(_.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,conditions:e.incomingConditions})),topSkills:Bt,topIncomingSkills:Nt,playerSkillBreakdowns:Wt,topSkillsMetric:C,mapData:yt,timelineData:qt,boonTables:Rt,offensePlayers:Array.from(_.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,offenseTotals:e.offenseTotals,offenseRateWeights:e.offenseRateWeights,totalFightMs:e.totalFightMs})),defensePlayers:Array.from(_.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,defenseTotals:e.defenseTotals,activeMs:e.defenseActiveMs})),supportPlayers:Array.from(_.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,supportTotals:e.supportTotals,activeMs:e.supportActiveMs})),healingPlayers:Array.from(_.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,healingTotals:e.healingTotals,activeMs:e.healingActiveMs})),mvp:sn,silver:An,bronze:En,squadClassData:Lt,enemyClassData:Ot,fightBreakdown:$t,specialTables:xt,topStatsPerSecond:we,topStatsLeaderboardsPerSecond:he,avgMvpScore:Fn}})(),de=(()=>{const U=new Map,y=new Map,C=[],T=new Map,I=new Map;D.forEach(A=>{const P=A.details;if(!P)return;const F=P.skillMap||{},R=P.fightName||"Log",oe=Ue(P,A)||Date.now(),q={id:A.filePath||A.id||R,label:R,timestamp:oe,skillEntries:{},playerActiveSeconds:{},durationSeconds:P.durationMS?P.durationMS/1e3:0};(P.players||[]).forEach(V=>{if(V.notInSquad)return;const _=V.account||V.name||"Unknown",pe=V.profession||"Unknown",j=`${_}|${pe}`;let $=y.get(j);$||($={key:j,account:_,displayName:_,profession:pe,professionList:[pe],logs:0,totalActiveSeconds:0,skillTotals:{}},y.set(j,$)),$.logs++;const le=(Array.isArray(V.activeTimes)?V.activeTimes[0]:0)/1e3;$.totalActiveSeconds=($.totalActiveSeconds||0)+le,q.playerActiveSeconds[j]=le,(V.rotation||[]).forEach(Y=>{var Ke,Ge,Je;if(!(Y!=null&&Y.id))return;const ie=((Ke=Y.skills)==null?void 0:Ke.length)||0;if(ie<=0)return;const z=`s${Y.id}`,Ae=((Ge=F[z])==null?void 0:Ge.name)||`Skill ${Y.id}`,ke=(Je=F[z])==null?void 0:Je.icon;$.skillTotals[z]=($.skillTotals[z]||0)+ie,U.set(z,(U.get(z)||0)+ie),T.set(z,Ae),ke&&!I.has(z)&&I.set(z,ke),q.skillEntries[z]||(q.skillEntries[z]={name:Ae,icon:ke,players:{}}),!q.skillEntries[z].icon&&ke&&(q.skillEntries[z].icon=ke),q.skillEntries[z].players[j]=(q.skillEntries[z].players[j]||0)+ie})}),C.push(q)});const p=Array.from(U.entries()).map(([A,P])=>({id:A,name:T.get(A)||A,total:P,icon:I.get(A)})).sort((A,P)=>P.total-A.total);return{logRecords:C,players:Array.from(y.values()),skillOptions:p,resUtilitySkills:[]}})();return{validLogs:D,stats:te,skillUsageData:de}};let Ce=null,Oe=!1,Dn=null,Tn=0,Sn=0,en=null;const kn=n=>{if(!n||typeof n!="object")return n;const o=(f,h)=>{const D={};return h.forEach(B=>{f&&Object.prototype.hasOwnProperty.call(f,B)&&(D[B]=f[B])}),D},a=o(n,["players","targets","durationMS","uploadTime","timeStart","timeStartStd","timeEnd","timeEndStd","fightName","success","teamCounts","combatReplayMetaData","skillMap","buffMap","encounterDuration"]);return Array.isArray(a.players)&&(a.players=a.players.map(f=>o(f,["name","display_name","character_name","profession","elite_spec","group","dpsAll","statsAll","dpsTargets","statsTargets","defenses","support","rotation","extHealingStats","extBarrierStats","squadBuffVolumes","selfBuffs","groupBuffs","squadBuffs","selfBuffsActive","groupBuffsActive","squadBuffsActive","buffUptimes","totalDamageDist","targetDamageDist","totalDamageTaken","combatReplayData","hasCommanderTag","notInSquad","account","activeTimes"]))),Array.isArray(a.targets)&&(a.targets=a.targets.map(f=>o(f,["id","name","isFake","dpsAll","statsAll","defenses","totalHealth","healthPercentBurned","enemyPlayer"]))),a},Tt=n=>{if(!n||typeof n!="object")return n;const o={...n};return n.details?o.details=kn(n.details):o.details=kn(n),o},wn=()=>{if(!Oe||!Ce)return;Oe=!1,Tn+=1;const n=en;en=null;const o=Dt(Ce);self.postMessage({type:"result",result:o,computeId:Tn,logCount:Ce.logs.length,token:Sn,completedAt:Date.now(),flushId:n})},nn=()=>{Dn===null&&(Dn=setInterval(()=>{wn()},5e3))};self.onmessage=n=>{var a,f,h,D;const o=n.data;if((o==null?void 0:o.type)==="reset"){Ce={logs:[]},typeof o.token=="number"&&(Sn=o.token),Oe=!0,nn();return}if((o==null?void 0:o.type)==="settings"){Ce={logs:(Ce==null?void 0:Ce.logs)||[],precomputedStats:(a=o.payload)==null?void 0:a.precomputedStats,mvpWeights:(f=o.payload)==null?void 0:f.mvpWeights,statsViewSettings:(h=o.payload)==null?void 0:h.statsViewSettings,disruptionMethod:(D=o.payload)==null?void 0:D.disruptionMethod},Oe=!0,nn();return}if((o==null?void 0:o.type)==="log"){Ce||(Ce={logs:[]}),Ce.logs.push(Tt(o.payload)),Oe=!0,nn();return}(o==null?void 0:o.type)==="flush"&&(typeof o.flushId=="number"&&(en=o.flushId),Oe=!0,wn())}})();
