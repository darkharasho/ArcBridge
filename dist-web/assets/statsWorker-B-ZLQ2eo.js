(function(){"use strict";const Gt=["selfBuffs","groupBuffs","squadBuffs"],Jt=o=>o!=null&&o.classification?o.classification==="Boon":!0,Yt=o=>`b${o}`,In=(o,s)=>{const c=Array.isArray(o==null?void 0:o.activeTimes)?o.activeTimes:[],C=typeof c[0]=="number"?c[0]:0;return C>0?C:s},Qt=(o,s,c,C,w,I,ie)=>{const _=o==="selfBuffs"?1:Math.max(o==="groupBuffs"?I-1:ie-1,0);return!_||!w?{generationMs:0,wastedMs:0}:s?{generationMs:c*w*_,wastedMs:C*w*_}:{generationMs:c/100*w*_,wastedMs:C/100*w*_}},Pn=o=>{const s=new Map,c=new Map;return o.forEach(I=>{const ie=I.details;if(!ie)return;const _=ie.durationMS||0,se=ie.buffMap||{};Object.entries(se).forEach(([M,P])=>{if(!s.has(M)){s.set(M,P);return}const ae=s.get(M)||{},S={name:ae.name||P.name,stacking:ae.stacking??P.stacking,icon:ae.icon||P.icon,classification:ae.classification||P.classification};s.set(M,S)});const qe=(ie.players||[]).filter(M=>!M.notInSquad),ge=qe.length,le=new Map;qe.forEach(M=>{const P=M.group??0;le.set(P,(le.get(P)||0)+1)}),qe.forEach(M=>{const P=M.account||M.name||M.character_name||"Unknown",ae=M.profession||"Unknown",S=M.group??0,Y=le.get(S)||1,Q=In(M,_);c.has(P)||c.set(P,{account:P,profession:ae,professions:new Set,professionTimeMs:{},activeTimeMs:0,numFights:0,groupSupported:0,squadSupported:0,boons:{}});const X=c.get(P);X.profession=ae,ae!=="Unknown"&&(X.professions.add(ae),X.professionTimeMs[ae]=(X.professionTimeMs[ae]||0)+Q),X.activeTimeMs+=Q,X.numFights+=1,X.groupSupported+=Y,X.squadSupported+=ge,Gt.forEach(pe=>{(M[pe]||[]).forEach(te=>{var Ee,He,Ne,Qe;if(typeof(te==null?void 0:te.id)!="number")return;const Pe=Yt(te.id),ve=se[Pe];if(!Jt(ve))return;const Ce=(ve==null?void 0:ve.stacking)??!1,_e=((He=(Ee=te.buffData)==null?void 0:Ee[0])==null?void 0:He.generation)??0,be=((Qe=(Ne=te.buffData)==null?void 0:Ne[0])==null?void 0:Qe.wasted)??0,{generationMs:ke,wastedMs:Re}=Qt(pe,Ce,_e,be,_,Y,ge);!ke&&!Re||(s.has(Pe)||s.set(Pe,ve||{}),X.boons[Pe]||(X.boons[Pe]={selfBuffs:{generationMs:0,wastedMs:0},groupBuffs:{generationMs:0,wastedMs:0},squadBuffs:{generationMs:0,wastedMs:0}}),X.boons[Pe][pe].generationMs+=ke,X.boons[Pe][pe].wastedMs+=Re)})})})}),{boonTables:Array.from(s.keys()).filter(I=>Jt(s.get(I))).map(I=>{const ie=s.get(I)||{},_=[];return c.forEach(se=>{var M;const Le=se.boons[I];if(!Le||!Gt.some(P=>Le[P].generationMs>0||Le[P].wastedMs>0))return;const ge=Array.from(se.professions||[]).filter(P=>P&&P!=="Unknown");let le=se.profession;if(ge.length>0){le=ge[0];let P=((M=se.professionTimeMs)==null?void 0:M[le])||0;ge.forEach(ae=>{var Y;const S=((Y=se.professionTimeMs)==null?void 0:Y[ae])||0;S>P&&(P=S,le=ae)})}_.push({account:se.account,profession:le||"Unknown",professionList:ge,activeTimeMs:se.activeTimeMs||1,numFights:se.numFights||1,groupSupported:se.groupSupported||1,squadSupported:se.squadSupported||1,categories:{selfBuffs:{...Le.selfBuffs},groupBuffs:{...Le.groupBuffs},squadBuffs:{...Le.squadBuffs}}})}),{id:I,name:ie.name||I,icon:ie.icon,stacking:ie.stacking??!1,rows:_}}).filter(I=>I.rows.length>0)}},Xt=(o,s,c,C,w,I,ie={})=>{var M,P,ae,S;const se=((o==null?void 0:o[s])||[]).find(Y=>Y.id===c);if(!se)return{generationMs:0,wastedMs:0};const Le=ie[Yt(c)],qe=(Le==null?void 0:Le.stacking)??!1,ge=((P=(M=se.buffData)==null?void 0:M[0])==null?void 0:P.generation)??0,le=((S=(ae=se.buffData)==null?void 0:ae[0])==null?void 0:S.wasted)??0;return Qt(s,qe,ge,le,C,w,I)};var Un={methods:{tiered:{tiers:{shortMs:500,mediumMs:1500,weights:{short:.5,medium:1,long:2}}}}};const Hn=Un,Lt="count",Ln=o=>(o||0)/1e3,$n=(o,s)=>{var w;if(!o)return 0;const c=(w=Hn.methods.tiered)==null?void 0:w.tiers;if(!c)return o;const C=s/Math.max(o,1);return C<=c.shortMs?o*c.weights.short:C<=c.mediumMs?o*c.weights.medium:o*c.weights.long},Zt=(o,s,c)=>c==="duration"?Ln(s):c==="tiered"?$n(o,s):o;function On(o,s=Lt){var I;const c=(I=o.statsAll)==null?void 0:I[0],C=Number((c==null?void 0:c.appliedCrowdControl)??0),w=Number((c==null?void 0:c.appliedCrowdControlDuration)??0);return Zt(C,w,s)}function _n(o,s){const c=(s==null?void 0:s.durationMS)||0,C=(s==null?void 0:s.buffMap)||{},w=o.filter(_=>!_.notInSquad),I=w.length,ie=new Map;w.forEach(_=>{const se=_.group??0;ie.set(se,(ie.get(se)||0)+1)}),w.forEach(_=>{const se=ie.get(_.group??0)||1,Le=Xt(_,"selfBuffs",1122,c,se,I,C),qe=Xt(_,"squadBuffs",1122,c,se,I,C);_.stabGeneration=(Le.generationMs+qe.generationMs)/1e3})}function Rn(o){if(!o.statsTargets)return 0;let s=0;for(const c of o.statsTargets)c&&c.length>0&&(s+=c[0].downContribution||0);return s}function xn(o){if(!o.extBarrierStats||!o.extBarrierStats.outgoingBarrierAllies)return 0;let s=0;for(const c of o.extBarrierStats.outgoingBarrierAllies)if(c)for(const C of c)C&&(s+=C.barrier||0);return s}function qn(o){if(!o.extHealingStats||!o.extHealingStats.outgoingHealingAllies)return 0;let s=0;for(const c of o.extHealingStats.outgoingHealingAllies)if(c)for(const C of c)C&&(s+=C.healing||0);return s}const jn=o=>{var s,c,C,w;return(((c=(s=o.support)==null?void 0:s[0])==null?void 0:c.condiCleanse)||0)+(((w=(C=o.support)==null?void 0:C[0])==null?void 0:w.condiCleanseSelf)||0)},Wn=(o,s=Lt)=>{var I;const c=(I=o.support)==null?void 0:I[0],C=Number((c==null?void 0:c.boonStrips)??0),w=Number((c==null?void 0:c.boonStripsTime)??0);return Zt(C,w,s)},Vn=o=>Rn(o),zn=o=>qn(o),Kn=o=>xn(o),Gn=(o,s=Lt)=>On(o,s),Jn=(o,s)=>_n(o,s),Yn="count",Qn={downContribution:1,healing:1,cleanses:1,strips:1,stability:1,cc:.7,revives:.7,distanceToTag:.7,participation:.7,dodging:.4,dps:.2,damage:.2},Xn={showMvp:!0,topSkillDamageSource:"target",topSkillsMetric:"damage"},yt=new Map([["bleeding","Bleeding"],["burning","Burning"],["confusion","Confusion"],["poison","Poison"],["torment","Torment"],["vulnerability","Vulnerability"],["weakness","Weakness"],["weakened","Weakness"],["blind","Blind"],["blinded","Blind"],["blinding","Blind"],["cripple","Cripple"],["crippled","Cripple"],["chill","Chill"],["chilled","Chill"],["immob","Immobilize"],["immobile","Immobilize"],["immobilized","Immobilize"],["slow","Slow"],["slowed","Slow"],["fear","Fear"],["feared","Fear"],["taunt","Taunt"],["taunted","Taunt"]]),Zn={Blind:"https://render.guildwars2.com/file/09770136BB76FD0DBE1CC4267DEED54774CB20F6/102837.png",Chill:"https://render.guildwars2.com/file/28C4EC547A3516AF0242E826772DA43A5EAC3DF3/102839.png",Cripple:"https://render.guildwars2.com/file/070325E519C178D502A8160523766070D30C0C19/102838.png",Fear:"https://render.guildwars2.com/file/30307A6E766D74B6EB09EDA12A4A2DE50E4D76F4/102869.png",Immobilize:"https://render.guildwars2.com/file/397A613651BFCA2832B6469CE34735580A2C120E/102844.png",Slow:"https://render.guildwars2.com/file/F60D1EF5271D7B9319610855676D320CD25F01C6/961397.png",Taunt:"https://render.guildwars2.com/file/02EED459AD65FAF7DF32A260E479C625070841B9/1228472.png",Vulnerability:"https://render.guildwars2.com/file/3A394C1A0A3257EB27A44842DDEEF0DF000E1241/102850.png",Weakness:"https://render.guildwars2.com/file/6CB0E64AF9AA292E332A38C1770CE577E2CDE0E8/102853.png"},ft=o=>{if(!o)return null;const s=o.trim().toLowerCase(),c=yt.get(s);if(c)return c;const C=s.split(/[^a-z]+/).filter(Boolean);for(const w of C){const I=yt.get(w);if(I)return I}return null},yn=o=>ft(o),en=o=>{const s=new Map;return o&&(Object.values(o).forEach(c=>{if(!(c!=null&&c.icon)||!(c!=null&&c.name))return;const C=ft(c.name);C&&(s.has(C)||s.set(C,c.icon))}),Object.entries(Zn).forEach(([c,C])=>{s.has(c)||s.set(c,C)})),s},Tt=(o,s,c)=>{var C;if(s&&c){const w=(C=c[`b${s}`])==null?void 0:C.name,I=ft(w);if(I)return I}return o?ft(o):null},eo=o=>{const s=(o==null?void 0:o.account)||"Unknown";return s&&s!=="Unknown"?s:(o==null?void 0:o.name)||"Unknown"||null},to=o=>{if(!o||o.length===0)return 0;let s=0,c=null;return o.forEach(C=>{const w=Number(C[1]??0);if(Number.isFinite(w)){if(c===null){c=w;return}w>c&&(s+=w-c),c=w}}),s},no=o=>{if(!o||o.length===0)return 0;let s=0;return o.forEach(c=>{const C=Number(c[0]??0),w=Number(c[1]??0);Number.isFinite(w)&&C!==0&&w>0&&(s+=1)}),s},oo=o=>{const{players:s,targets:c,skillMap:C,buffMap:w}=o,I=o.getPlayerKey||eo,ie=en(w),_={},se={};s.forEach(M=>{if(M!=null&&M.notInSquad)return;const P=I(M);P&&(_[P]||(_[P]={}),M!=null&&M.totalDamageDist&&M.totalDamageDist.forEach(ae=>{ae&&ae.forEach(S=>{if(!S.id)return;let Y=`Skill ${S.id}`,Q;C&&(C[`s${S.id}`]?(Y=C[`s${S.id}`].name||Y,Q=C[`s${S.id}`].icon||Q):C[`${S.id}`]&&(Y=C[`${S.id}`].name||Y,Q=C[`${S.id}`].icon||Q));const X=Tt(Y,S.id,w);if(!X)return;const pe=w==null?void 0:w[`b${S.id}`],Oe=pe==null?void 0:pe.name,te=ie.get(X)||(pe==null?void 0:pe.icon),Pe=Y.startsWith("Skill ")?Oe||X:Y,ve=Q||(pe==null?void 0:pe.icon),Ce=Number(S.connectedHits??0),_e=Number(S.hits??0),be=Ce>0?Ce:_e,ke=Number(S.totalDamage??0);if(!Number.isFinite(be)&&!Number.isFinite(ke))return;const Re=se[X]||{name:X,icon:te,applications:0,damage:0};Re.applications+=Number.isFinite(be)?be:0,Re.damage+=Number.isFinite(ke)?ke:0,!Re.icon&&te&&(Re.icon=te),se[X]=Re;const Ee=_[P][X]||{icon:te,applications:0,damage:0,skills:{}};Ee.applications+=Number.isFinite(be)?be:0,Ee.damage+=Number.isFinite(ke)?ke:0;const He=Ee.skills[Pe]||{name:Pe,hits:0,damage:0,icon:ve};He.hits+=Number.isFinite(be)?be:0,He.damage+=Number.isFinite(ke)?ke:0,!He.icon&&ve&&(He.icon=ve),Ee.skills[Pe]=He,!Ee.icon&&te&&(Ee.icon=te),_[P][X]=Ee})}))});const Le=new Map;s.forEach(M=>{if(M!=null&&M.notInSquad)return;const P=I(M);P&&M!=null&&M.name&&Le.set(M.name,P)});let qe=0,ge=0,le=0;return c.forEach(M=>{M!=null&&M.buffs&&M.buffs.forEach(P=>{const ae=Number(P==null?void 0:P.id);if(!Number.isFinite(ae))return;const S=w==null?void 0:w[`b${ae}`],Y=ft(S==null?void 0:S.name);if(!Y||S!=null&&S.classification&&S.classification!=="Condition")return;const Q=Y;if(!Q)return;const X=P.statesPerSource||{};le+=1,Object.entries(X).forEach(([pe,Oe])=>{var be;const te=Le.get(pe);if(!te)return;ge+=1;const Pe=to(Oe),ve=no(Oe);qe+=Pe;const Ce=((be=_[te])==null?void 0:be[Q])||{applications:0,damage:0,skills:{}};Ce.applicationsFromBuffs=(Ce.applicationsFromBuffs||0)+Pe,Ce.applicationsFromBuffsActive=(Ce.applicationsFromBuffsActive||0)+ve,_[te]=_[te]||{},_[te][Q]=Ce;const _e=se[Q]||{name:Q,applications:0,damage:0};_e.applicationsFromBuffs=(_e.applicationsFromBuffs||0)+Pe,_e.applicationsFromBuffsActive=(_e.applicationsFromBuffsActive||0)+ve,se[Q]=_e})})}),Object.values(_).forEach(M=>{Object.values(M).forEach(P=>{typeof P.applicationsFromBuffs=="number"&&(P.applications=P.applicationsFromBuffs)})}),Object.values(se).forEach(M=>{typeof M.applicationsFromBuffs=="number"&&(M.applications=M.applicationsFromBuffs)}),{playerConditions:_,summary:se,meta:{buffStateApplicationsTotal:qe,targetBuffEntriesSeen:le,buffStateSourcesSeen:ge}}},io=new Set(["Vulnerability","Weakness","Blind","Cripple","Chill","Immobilize","Slow","Fear","Taunt"]),so=[{id:"damage",label:"Damage",field:"damage",source:"dpsAll"},{id:"directDmg",label:"Direct Damage",field:"directDmg",source:"statsTargets"},{id:"connectedDamageCount",label:"Connected Damage Count",field:"connectedDamageCount",source:"statsTargets"},{id:"connectedDirectDamageCount",label:"Connected Direct Damage Count",field:"connectedDirectDamageCount",source:"statsTargets"},{id:"battleStandardHits",label:"Battle Standard Tracking"},{id:"criticalRate",label:"Critical Rate",field:"criticalRate",isRate:!0,isPercent:!0,denomField:"critableDirectDamageCount",source:"statsTargets"},{id:"criticalDmg",label:"Critical Damage",field:"criticalDmg",source:"statsTargets"},{id:"flankingRate",label:"Flanking Rate",field:"flankingRate",isRate:!0,isPercent:!0,denomField:"connectedDirectDamageCount",source:"statsTargets"},{id:"glanceRate",label:"Glance Rate",field:"glanceRate",isRate:!0,isPercent:!0,denomField:"connectedDirectDamageCount",source:"statsTargets"},{id:"missed",label:"Missed",field:"missed",source:"statsTargets"},{id:"evaded",label:"Evaded (enemy)",field:"evaded",source:"statsTargets"},{id:"blocked",label:"Blocked (enemy)",field:"blocked",source:"statsTargets"},{id:"interrupts",label:"Interrupts",field:"interrupts",source:"statsTargets"},{id:"invulned",label:"Invulned",field:"invulned",source:"statsTargets"},{id:"killed",label:"Killed",field:"killed",source:"statsTargets"},{id:"downed",label:"Downed",field:"downed",source:"statsTargets"},{id:"downContribution",label:"Down Contribution",field:"downContribution",source:"statsTargets"},{id:"downContributionPercent",label:"Down Contribution %",isRate:!0,isPercent:!0},{id:"againstDownedDamage",label:"Against Downed Damage",field:"againstDownedDamage",source:"statsTargets"},{id:"appliedCrowdControl",label:"Applied CC",field:"appliedCrowdControl",source:"statsTargets"},{id:"appliedCrowdControlDuration",label:"Applied CC Duration",field:"appliedCrowdControlDuration",source:"statsTargets"},{id:"appliedCrowdControlDownContribution",label:"Applied CC Down Contribution",field:"appliedCrowdControlDownContribution",source:"statsTargets"},{id:"appliedCrowdControlDurationDownContribution",label:"Applied CC Duration Down Contribution",field:"appliedCrowdControlDurationDownContribution",source:"statsTargets"},{id:"boonStrips",label:"Boon Strips",field:"boonStrips",source:"support"}],ao=[{id:"damageTaken",label:"Damage Taken",field:"damageTaken"},{id:"damageTakenCount",label:"Damage Taken Count",field:"damageTakenCount"},{id:"conditionDamageTaken",label:"Condition Damage Taken",field:"conditionDamageTaken"},{id:"conditionDamageTakenCount",label:"Condition Damage Taken Count",field:"conditionDamageTakenCount"},{id:"powerDamageTaken",label:"Power Damage Taken",field:"powerDamageTaken"},{id:"powerDamageTakenCount",label:"Power Damage Taken Count",field:"powerDamageTakenCount"},{id:"downedDamageTaken",label:"Downed Damage Taken",field:"downedDamageTaken"},{id:"downedDamageTakenCount",label:"Downed Damage Taken Count",field:"downedDamageTakenCount"},{id:"damageBarrier",label:"Damage Barrier",field:"damageBarrier"},{id:"damageBarrierCount",label:"Damage Barrier Count",field:"damageBarrierCount"},{id:"blockedCount",label:"Blocked Count",field:"blockedCount"},{id:"evadedCount",label:"Evaded Count",field:"evadedCount"},{id:"missedCount",label:"Missed Count",field:"missedCount"},{id:"dodgeCount",label:"Dodge Count",field:"dodgeCount"},{id:"invulnedCount",label:"Invulnerable Count",field:"invulnedCount"},{id:"interruptedCount",label:"Interrupted Count",field:"interruptedCount"},{id:"downCount",label:"Down Count",field:"downCount"},{id:"deadCount",label:"Death Count",field:"deadCount"},{id:"boonStrips",label:"Boon Strips (Incoming)",field:"boonStrips"},{id:"conditionCleanses",label:"Cleanses (Incoming)",field:"conditionCleanses"},{id:"receivedCrowdControl",label:"Crowd Control (Incoming)",field:"receivedCrowdControl"}],ro=[{id:"condiCleanse",label:"Condition Cleanses",field:"condiCleanse"},{id:"condiCleanseTime",label:"Condition Cleanse Time",field:"condiCleanseTime",isTime:!0},{id:"condiCleanseSelf",label:"Condition Cleanse Self",field:"condiCleanseSelf"},{id:"condiCleanseTimeSelf",label:"Condition Cleanse Time Self",field:"condiCleanseTimeSelf",isTime:!0},{id:"boonStrips",label:"Boon Strips",field:"boonStrips"},{id:"boonStripsTime",label:"Boon Strips Time",field:"boonStripsTime",isTime:!0},{id:"boonStripDownContribution",label:"Boon Strip Down Contribution",field:"boonStripDownContribution"},{id:"boonStripDownContributionTime",label:"Boon Strip Down Contribution Time",field:"boonStripDownContributionTime",isTime:!0},{id:"stunBreak",label:"Stun Breaks",field:"stunBreak"},{id:"removedStunDuration",label:"Removed Stun Duration",field:"removedStunDuration",isTime:!0},{id:"resurrects",label:"Resurrects",field:"resurrects"},{id:"resurrectTime",label:"Resurrect Time",field:"resurrectTime",isTime:!0}],co=["battle standard","glyph of renewal","glyph of the stars","illusion of life","spirit of nature","nature spirit","search and rescue","signet of mercy"],lo=new Set([10244]),uo=(o,s)=>{var w;if(lo.has(o))return!0;const c=(s==null?void 0:s[`s${o}`])||(s==null?void 0:s[`${o}`]),C=((w=c==null?void 0:c.name)==null?void 0:w.toLowerCase())||"";return co.some(I=>C.includes(I))},mo=o=>{if(!o||!Number.isFinite(o))return"--:--";const s=Math.max(0,Math.round(o/1e3)),c=Math.floor(s/3600),C=Math.floor(s%3600/60),w=s%60;return c>0?`${c}:${String(C).padStart(2,"0")}:${String(w).padStart(2,"0")}`:`${C}:${String(w).padStart(2,"0")}`},At={Guardian:"#72C1D9",Dragonhunter:"#72C1D9",Firebrand:"#72C1D9",Willbender:"#72C1D9",Revenant:"#D16E5A",Herald:"#D16E5A",Renegade:"#D16E5A",Vindicator:"#D16E5A",Warrior:"#FFD166",Berserker:"#FFD166",Spellbreaker:"#FFD166",Bladesworn:"#FFD166",Engineer:"#D09C59",Scrapper:"#D09C59",Holosmith:"#D09C59",Mechanist:"#D09C59",Ranger:"#8CDC82",Druid:"#8CDC82",Soulbeast:"#8CDC82",Untamed:"#8CDC82",Thief:"#C08F95",Daredevil:"#C08F95",Deadeye:"#C08F95",Specter:"#C08F95",Elementalist:"#F68A87",Tempest:"#F68A87",Weaver:"#F68A87",Catalyst:"#F68A87",Mesmer:"#B679D5",Chronomancer:"#B679D5",Mirage:"#B679D5",Virtuoso:"#B679D5",Necromancer:"#52A76F",Reaper:"#52A76F",Scourge:"#52A76F",Harbinger:"#52A76F",Ritualist:"#52A76F",Luminary:"#72C1D9",Conduit:"#D16E5A",Paragon:"#FFD166",Amalgam:"#D09C59",Galeshot:"#8CDC82",Antiquary:"#C08F95",Evoker:"#F68A87",Troubadour:"#B679D5",Unknown:"#64748B"};function tn(o){return At[o]||At.Unknown}const fo=o=>{if(o==null||o==="")return 0;if(typeof o=="number")return!Number.isFinite(o)||o<=0?0:o>1e12?o:o*1e3;if(o instanceof Date){const ie=o.getTime();return Number.isFinite(ie)&&ie>0?ie:0}const s=String(o).trim();if(!s)return 0;const c=Number(s);if(Number.isFinite(c)&&c>0)return c>1e12?c:c*1e3;const C=Date.parse(s);if(Number.isFinite(C)&&C>0)return C;const w=s.replace(/([+-]\d{2})$/,"$1:00"),I=Date.parse(w);return Number.isFinite(I)&&I>0?I:0},nt=(o,s)=>fo((o==null?void 0:o.uploadTime)??(s==null?void 0:s.uploadTime)??(o==null?void 0:o.timeStartStd)??(o==null?void 0:o.timeStart)??(o==null?void 0:o.timeEndStd)??(o==null?void 0:o.timeEnd)??(o==null?void 0:o.timeStartText)??(o==null?void 0:o.timeEndText)),go=({logs:o,precomputedStats:s,mvpWeights:c,statsViewSettings:C,disruptionMethod:w})=>{const I=(()=>{const ge=o.filter(le=>le.details&&le.details.players&&le.details.players.length>0);return console.log("[useStatsAggregation] Filtering logs:",{total:o.length,passed:ge.length,statuses:o.map(le=>le.status),hasDetails:o.map(le=>!!le.details)}),ge})(),ie=C||Xn,_=c||Qn,se=ge=>{if(!ge||typeof ge!="object")return ge;const le=Array.isArray(ge.fightBreakdown)?ge.fightBreakdown:null;if(!le||le.length===0)return ge;const M=new Map,P=new Map;o.forEach(S=>{var X;const Y=(S==null?void 0:S.filePath)||(S==null?void 0:S.id);Y&&M.set(String(Y),S);const Q=(S==null?void 0:S.permalink)||((X=S==null?void 0:S.details)==null?void 0:X.permalink);typeof Q=="string"&&Q.trim()&&P.set(Q.trim(),S)});const ae=le.map(S=>{if(!S||typeof S!="object"||Number(S.timestamp)>0)return S;const Q=S.id?String(S.id):"",X=typeof S.permalink=="string"?S.permalink.trim():"",pe=(Q?M.get(Q):void 0)||(X?P.get(X):void 0);if(!pe)return S;const Oe=nt(pe==null?void 0:pe.details,pe);return Oe?{...S,timestamp:Oe}:S});return{...ge,fightBreakdown:ae}},Le=(()=>{if(s)return se(s);const ge=w||Yn,le=ie.topSkillDamageSource||"target",M=ie.topSkillsMetric||"damage",P=I.length;let ae=0,S=0,Y=0,Q=0,X=0,pe=0,Oe=0,te=0;const Pe=e=>{const n=((e==null?void 0:e.players)||[]).filter($=>!$.notInSquad);let l=0,a=0,f=0,h=0;return n.forEach($=>{var Z;const D=(Z=$.defenses)==null?void 0:Z[0];if(!D)return;const x=Number(D.downCount||0),ue=Number(D.deadCount||0);l+=x+ue,f+=ue}),n.forEach($=>{!$.statsTargets||$.statsTargets.length===0||$.statsTargets.forEach(D=>{const x=D==null?void 0:D[0];if(!x)return;const ue=Number(x.downed||0),Z=Number(x.killed||0);a+=ue+Z,h+=Z})}),{squadDownsDeaths:l,enemyDownsDeaths:a,squadDeaths:f,enemyDeaths:h}},ve=e=>{const{squadDownsDeaths:t,enemyDownsDeaths:n}=Pe(e);return t>0||n>0?n>t:typeof(e==null?void 0:e.success)=="boolean"?e.success:!1},Ce=new Map,_e=new Set(["boonStripsTime","condiCleanseTime","condiCleanseTimeSelf"]),be={},ke={},Re=new Map,Ee={},He={},Ne={},Qe=new Map,Je=new Map,Mt=new Set(Object.keys(At)),Nt=Object.keys(At).filter(e=>e&&e!=="Unknown").sort((e,t)=>t.length-e.length),wt=["Guardian","Revenant","Warrior","Engineer","Ranger","Thief","Elementalist","Mesmer","Necromancer"],lt=e=>{if(!e)return"Unknown";const t=String(e).replace(/\s*\([^)]*\)\s*$/,"").replace(/\s*\[[^\]]*\]\s*$/,"").replace(/\s\d+$/,"").trim();if(Mt.has(t))return t;const n=t.toLowerCase();for(const a of Nt)if(n.includes(a.toLowerCase()))return a;return wt.find(a=>n.includes(a.toLowerCase()))||t||"Unknown"},bo=e=>e!=null&&e.classification?e.classification==="Boon":!0,vt=new Map,Et=new Map,gt=()=>({totalHits:0,blocked:0,evaded:0,glanced:0,missed:0,invulned:0,interrupted:0,totalMitigation:0,minMitigation:0}),J=e=>{const t=Number(e);return Number.isFinite(t)?t:0},cn=e=>{const t=String(e).split("|"),n=t[0]||"Unknown",l=lt(t[1]||"Unknown"),a=t[2]||n||"Unknown";return{name:n,profession:l,account:a}},ln=(e,t,n)=>{let l=e.get(t);return l?n.profession&&!l.professionList.includes(n.profession)&&l.professionList.push(n.profession):(l={account:n.account,name:n.name,profession:n.profession,professionList:n.profession?[n.profession]:[],activeMs:0,mitigationTotals:gt()},e.set(t,l)),l},un=(e,t,n)=>{let l=e.get(t);return l?n.profession&&!l.professionList.includes(n.profession)&&l.professionList.push(n.profession):(l={account:n.account,name:n.name,profession:n.profession,professionList:n.profession?[n.profession]:[],activeMs:0,mitigationTotals:gt(),minion:n.minion},e.set(t,l)),l},dn=(e,t)=>{e.totalHits+=J((t==null?void 0:t.skill_hits)??(t==null?void 0:t.skillHits)),e.blocked+=J(t==null?void 0:t.blocked),e.evaded+=J(t==null?void 0:t.evaded),e.glanced+=J(t==null?void 0:t.glanced),e.missed+=J(t==null?void 0:t.missed),e.invulned+=J(t==null?void 0:t.invulned),e.interrupted+=J(t==null?void 0:t.interrupted),e.totalMitigation+=J((t==null?void 0:t.avoided_damage)??(t==null?void 0:t.avoidedDamage)),e.minMitigation+=J((t==null?void 0:t.min_avoided_damage)??(t==null?void 0:t.minAvoidedDamage))},ho=e=>Object.values(e).some(t=>t>0);console.log("[useStatsAggregation] Starting aggregation loop",{validLogsCount:I.length});const Ft=(e,t,n)=>{var f,h,$,D;const l=`s${e}`;if((f=t==null?void 0:t[l])!=null&&f.name)return t[l].name;if((h=t==null?void 0:t[String(e)])!=null&&h.name)return t[String(e)].name;const a=`b${e}`;return($=n==null?void 0:n[a])!=null&&$.name?n[a].name:(D=n==null?void 0:n[String(e)])!=null&&D.name?n[String(e)].name:`Unknown Skill ${e}`},pt=new Map,it=e=>{const t=pt.get(e);if(!t)return{hasSkill:!1,avg:1,min:1,hits:0};const n=t.connectedHits||0,l=n>0?t.totalDamage/n:0,a=t.minCount>0?t.minTotal/t.minCount:0;return{hasSkill:!0,avg:l,min:a,hits:n}},Bt="Ashtonlightstone.9145",mn="Illusionary Warden",_t=[],st=[],Rt=[],xt=[],fn=new Map,gn=new Map,pn=(e,t,n)=>{const l=e.get(t)||gt();return l.totalHits+=n.totalHits,l.blocked+=n.blocked,l.evaded+=n.evaded,l.glanced+=n.glanced,l.missed+=n.missed,l.invulned+=n.invulned,l.interrupted+=n.interrupted,e.set(t,l),l};I.forEach(e=>{const t=e.details;if(!t)return;(t.targets||[]).forEach(l=>{const a=(l==null?void 0:l.totalDamageDist)||[],f=Array.isArray(a)?a[0]:null;f==null||f.forEach(h=>{if(!(h!=null&&h.id))return;const $=Number(h.id),D=pt.get($)||{totalDamage:0,connectedHits:0,minTotal:0,minCount:0};D.totalDamage+=Number(h.totalDamage||0),D.connectedHits+=Number(h.connectedHits||0);const x=Number.isFinite(Number(h.min))?Number(h.min):0;D.minTotal+=x,D.minCount+=1,pt.set($,D)})})}),I.forEach((e,t)=>{var ut,Pt;const n=e.details;if(!n)return;const l=n.players;console.log(`[useStatsAggregation] Processing log ${t}:`,{playerCount:l==null?void 0:l.length,hasTargets:!!n.targets,firstPlayer:l!=null&&l[0]?{account:l[0].account,notInSquad:l[0].notInSquad}:"none"});const a=n.targets||[],f=n.skillMap||{},h=n.buffMap||{},$=new Map,D=new Map;a.forEach(i=>{const m=(i==null?void 0:i.totalDamageDist)||[],A=Array.isArray(m)?m[0]:null;A==null||A.forEach(q=>{var z;if(!(q!=null&&q.id))return;const U=Number(q.id),p=((z=f==null?void 0:f[U])==null?void 0:z.name)||q.name||q.skillName||String(U),K=$.get(U)||{totalDamage:0,connectedHits:0,minTotal:0,minCount:0};K.totalDamage+=Number(q.totalDamage||0),K.connectedHits+=Number(q.connectedHits||0);const F=Number.isFinite(Number(q.min))?Number(q.min):0;K.minTotal+=F,K.minCount+=1,$.set(U,K);const B=D.get(p)||{totalDamage:0,connectedHits:0,minTotal:0,minCount:0};B.totalDamage+=Number(q.totalDamage||0),B.connectedHits+=Number(q.connectedHits||0);const H=Number.isFinite(Number(q.min))?Number(q.min):0;B.minTotal+=H,B.minCount+=1,D.set(p,B)})});const x=i=>{const m=$.get(i);if(!m||m.connectedHits<=0)return{avg:1,min:1};const A=m.connectedHits>0?m.totalDamage/m.connectedHits:0,q=m.minCount>0?m.minTotal/m.minCount:A;return{avg:A||1,min:q||1}},ue=i=>{const m=D.get(i);if(!m||m.connectedHits<=0)return{avg:1,min:1};const A=m.connectedHits>0?m.totalDamage/m.connectedHits:0,q=m.minCount>0?m.minTotal/m.minCount:A;return{avg:A||1,min:q||1}},Z=n.combatReplayMetaData||{},k=(Z==null?void 0:Z.inchToPixel)>0?Z.inchToPixel:1,v=(Z==null?void 0:Z.pollingRate)>0?Z.pollingRate:1,E=5e3,O=i=>Array.isArray(i)?i.map(m=>Array.isArray(m)?[Number(m[0]),Number(m[1])]:null).filter(m=>!!m&&Number.isFinite(m[0])):[];let de=[],ee=n.durationMS||0,Me=!1;const Se=l.find(i=>(i==null?void 0:i.hasCommanderTag)&&!(i!=null&&i.notInSquad));(ut=Se==null?void 0:Se.combatReplayData)!=null&&ut.positions&&(de=Se.combatReplayData.positions,O(Se.combatReplayData.dead).forEach(([m])=>{m>0&&(Me=!0,ee=Math.min(ee,m))}));const re=i=>{var B;const m=(B=i.statsAll)==null?void 0:B[0];if((m==null?void 0:m.distToCom)!==void 0&&(m==null?void 0:m.distToCom)!=="Infinity")return Math.round(Number(m.distToCom));if((m==null?void 0:m.stackDist)!==void 0)return Math.round(Number(m.stackDist))||0;if(i.hasCommanderTag)return 0;const A=i.combatReplayData;if(!(A!=null&&A.positions)||!de.length)return 0;const q=A.positions,U=O(A.dead),p=O(A.down),K=Math.floor((A.start||0)/v);let F=0;if(U.length&&p.length)for(const[H]of U){if(H<0)continue;const z=Math.max(0,Math.floor(H/v))-K;for(const[j,ne]of p){if(H!==ne)continue;const G=Me&&j>ee?Math.max(1,Math.floor(ee/v)):z,he=Math.max(0,Math.min(G,q.length,de.length));if(he<=0)continue;let y=0;for(let Te=0;Te<he;Te++){const[R,fe]=q[Te],[ce,oe]=de[Te];y+=Math.hypot(R-ce,fe-oe)}F=Math.round(y/he/k)}}return F},me=l.filter(i=>!i.notInSquad),Fe=l.filter(i=>i.notInSquad);Y+=me.length,Q+=a.filter(i=>!i.isFake).length,Jn(l,{durationMS:n.durationMS,buffMap:n.buffMap});const{squadDeaths:r,enemyDeaths:g}=Pe(n);X+=r,pe+=g,te+=r,Oe+=g,ve(n)?ae++:S++;const N=n.skillMap?Number((Pt=Object.keys(n.skillMap).find(i=>{var m,A;return((A=(m=n.skillMap)==null?void 0:m[i])==null?void 0:A.name)==="Battle Standard"}))==null?void 0:Pt.replace(/^s/,"")):null;l.forEach((i,m)=>{var Ze,ye,at,rt,Ut,bt,ht,Tn,An,Mn,Nn,wn;if(i.notInSquad)return;const A=i.account||"Unknown",q=A!=="Unknown"?A:i.name||"Unknown",U=i.name||"Unknown";Ce.has(q)||Ce.set(q,{name:U,account:q,downContrib:0,cleanses:0,strips:0,stab:0,healing:0,barrier:0,cc:0,logsJoined:0,totalDist:0,distCount:0,dodges:0,downs:0,deaths:0,totalFightMs:0,offenseTotals:{},offenseRateWeights:{},defenseActiveMs:0,defenseTotals:{},supportActiveMs:0,supportTotals:{},healingActiveMs:0,healingTotals:{},profession:i.profession||"Unknown",professions:new Set,professionTimeMs:{},isCommander:!1,damage:0,dps:0,revives:0,outgoingConditions:{},incomingConditions:{}});const p=Ce.get(q);if(i.hasCommanderTag&&(p.isCommander=!0),i.profession&&i.profession!=="Unknown"){p.profession=i.profession,p.professions.add(i.profession);const u=Array.isArray(i.activeTimes)&&typeof i.activeTimes[0]=="number"?i.activeTimes[0]:n.durationMS||0;p.professionTimeMs[i.profession]=(p.professionTimeMs[i.profession]||0)+u}p.logsJoined++,p.downContrib+=Vn(i),p.cleanses+=jn(i),p.strips+=Wn(i,ge),p.healing+=zn(i),p.barrier+=Kn(i),p.cc+=Gn(i,ge),p.stab+=i.stabGeneration||0;const K=re(i);K<=E&&(p.totalDist+=K,p.distCount++),(Ze=i.defenses)!=null&&Ze[0]&&(p.dodges+=i.defenses[0].dodgeCount||0,p.downs+=i.defenses[0].downCount||0,p.deaths+=i.defenses[0].deadCount||0),n.durationMS&&(p.totalFightMs+=n.durationMS);const F=Array.isArray(i.activeTimes)&&typeof i.activeTimes[0]=="number"?i.activeTimes[0]:n.durationMS||0;p.defenseActiveMs+=F,p.supportActiveMs+=F,p.healingActiveMs+=F,Array.isArray(i.buffUptimes)&&i.buffUptimes.length>0&&i.buffUptimes.forEach(u=>{var vn,En,Fn,Bn;if(typeof(u==null?void 0:u.id)!="number")return;const d=`b${u.id}`,b=((vn=n.buffMap)==null?void 0:vn[d])||((En=n.buffMap)==null?void 0:En[String(u.id)]);if(!b||bo(b))return;const W=Number(((Bn=(Fn=u.buffData)==null?void 0:Fn[0])==null?void 0:Bn.uptime)??0);if(!Number.isFinite(W)||W<=0)return;const Be=(b==null?void 0:b.stacking)??!1,We=(Be?W:W/100)*F;if(!Number.isFinite(We)||We<=0)return;const Ue=yn(b==null?void 0:b.name);if(Ue&&io.has(Ue)&&(!(b!=null&&b.classification)||b.classification==="Condition")){const Ht=We/1e3,ze=b==null?void 0:b.icon,Ct=Ee[Ue]||{name:Ue,icon:ze,applications:0,damage:0};Ct.applicationsFromUptime=(Ct.applicationsFromUptime||0)+Ht,!Ct.icon&&ze&&(Ct.icon=ze),Ee[Ue]=Ct;const kt=p.outgoingConditions[Ue]||{applications:0,damage:0,skills:{},icon:ze};kt.applicationsFromUptime=(kt.applicationsFromUptime||0)+Ht,!kt.icon&&ze&&(kt.icon=ze),p.outgoingConditions[Ue]=kt;const Dt=He[Ue]||{name:Ue,icon:ze,applications:0,damage:0};Dt.applicationsFromUptime=(Dt.applicationsFromUptime||0)+Ht,!Dt.icon&&ze&&(Dt.icon=ze),He[Ue]=Dt;const St=p.incomingConditions[Ue]||{applications:0,damage:0,skills:{},icon:ze};St.applicationsFromUptime=(St.applicationsFromUptime||0)+Ht,!St.icon&&ze&&(St.icon=ze),p.incomingConditions[Ue]=St}Qe.has(d)||Qe.set(d,{name:b==null?void 0:b.name,stacking:Be,icon:b==null?void 0:b.icon}),Je.has(d)||Je.set(d,new Map);const ot=Je.get(d),dt=p.account||i.account||i.name||"Unknown";let tt=ot.get(dt);tt||(tt={account:dt,profession:p.profession||i.profession||"Unknown",professions:new Set,professionTimeMs:{},totalMs:0,durationMs:0},ot.set(dt,tt));const mt=i.profession||p.profession;mt&&mt!=="Unknown"&&(tt.professions.add(mt),tt.professionTimeMs[mt]=(tt.professionTimeMs[mt]||0)+F,tt.profession=mt),tt.totalMs+=We,tt.durationMs+=F}),(ye=i.defenses)!=null&&ye[0]&&ao.forEach(u=>{const d=Number(i.defenses[0][u.field]??0);Number.isFinite(d)&&(p.defenseTotals[u.id]=(p.defenseTotals[u.id]||0)+d)}),(at=i.support)!=null&&at[0]&&ro.forEach(u=>{let d=Number(i.support[0][u.field]??0);Number.isFinite(d)&&(_e.has(u.field)&&d>999999&&(d=0),p.supportTotals[u.id]=(p.supportTotals[u.id]||0)+d)});const B=(u,d)=>{Number.isFinite(d)&&(p.healingTotals[u]=(p.healingTotals[u]||0)+d)},H=(u,d)=>Array.isArray(u)?u.reduce((b,W)=>b+Number((W==null?void 0:W[d])??0),0):0,z=(u,d,b)=>{if(!Number.isFinite(b)||b<=0)return;const W=l[d],Be=d===m,et=W==null?void 0:W.notInSquad,We=!et,Ue=We&&(W==null?void 0:W.group)!=null&&W.group===i.group;B(u,b),We&&B(`squad${u[0].toUpperCase()}${u.slice(1)}`,b),Ue&&B(`group${u[0].toUpperCase()}${u.slice(1)}`,b),Be&&B(`self${u[0].toUpperCase()}${u.slice(1)}`,b),et&&B(`offSquad${u[0].toUpperCase()}${u.slice(1)}`,b)};if(Array.isArray(i.rotation)){let u=0;i.rotation.forEach(d=>{var W;if(!(d!=null&&d.id)||!uo(d.id,n.skillMap))return;const b=((W=d.skills)==null?void 0:W.length)||0;b>0&&(u+=b,B(`resUtility_s${d.id}`,b))}),u>0&&B("resUtility",u)}const j=(rt=i.extHealingStats)==null?void 0:rt.outgoingHealingAllies;Array.isArray(j)&&j.forEach((u,d)=>{const b=H(u,"healing"),W=H(u,"downedHealing");z("healing",d,b),z("downedHealing",d,W)});const ne=(Ut=i.extBarrierStats)==null?void 0:Ut.outgoingBarrierAllies;Array.isArray(ne)&&ne.forEach((u,d)=>{const b=H(u,"barrier");z("barrier",d,b)});const G=(bt=i.statsAll)==null?void 0:bt[0],he=(ht=i.dpsAll)==null?void 0:ht[0],y=(Tn=i.support)==null?void 0:Tn[0];if(so.forEach(u=>{if(u.id==="downContributionPercent"||!u.field)return;let d=0,b=0;u.source==="dpsAll"&&he?d=Number(he[u.field]??0):u.source==="statsAll"&&G?(d=Number(G[u.field]??0),b=Number(G[u.denomField||u.weightField||"connectedDamageCount"]??0)):u.source==="support"&&y?d=Number(y[u.field]??0):i.statsTargets&&i.statsTargets.forEach(W=>{W!=null&&W[0]&&(d+=Number(W[0][u.field]??0),b+=Number(W[0][u.denomField||u.weightField||"connectedDamageCount"]??0))}),Number.isFinite(d)&&(p.offenseTotals[u.id]=(p.offenseTotals[u.id]||0)+d,u.isRate&&b>0&&(p.offenseRateWeights[u.id]=(p.offenseRateWeights[u.id]||0)+b))}),i.targetDamageDist&&Number.isFinite(N)){const u=i.targetDamageDist.flatMap(d=>d||[]).flatMap(d=>d||[]).reduce((d,b)=>b!=null&&b.id&&b.id===N?d+((b==null?void 0:b.connectedHits)||0):d,0);p.offenseTotals.battleStandardHits=(p.offenseTotals.battleStandardHits||0)+u}p.revives+=((Mn=(An=i.support)==null?void 0:An[0])==null?void 0:Mn.resurrects)||0,he&&(p.damage+=he.damage||0,p.dps+=he.dps||0);const Te=u=>{var Be,et,We,Ue;let d=`Skill ${u.id}`;const b=((Be=n.skillMap)==null?void 0:Be[`s${u.id}`])||((et=n.skillMap)==null?void 0:et[`${u.id}`]);let W=b==null?void 0:b.icon;if(b!=null&&b.name&&(d=b.name),d.startsWith("Skill ")){const ot=Tt(d,u.id,n.buffMap);ot&&(d=ot,W=((Ue=(We=n.buffMap)==null?void 0:We[`b${u.id}`])==null?void 0:Ue.icon)||W)}return{name:d,icon:W}},R=u=>{if(!(u!=null&&u.id))return;const{name:d,icon:b}=Te(u);be[u.id]||(be[u.id]={name:d,icon:b,damage:0,hits:0,downContribution:0}),be[u.id].name.startsWith("Skill ")&&!d.startsWith("Skill ")&&(be[u.id].name=d),!be[u.id].icon&&b&&(be[u.id].icon=b),be[u.id].damage+=u.totalDamage,be[u.id].hits+=u.connectedHits,be[u.id].downContribution+=Number(u.downContribution||0)},fe=i.account||i.name||"Unknown",ce=i.profession||"Unknown",oe=`${fe}|${ce}`;let De=Re.get(oe);De||(De={key:oe,account:fe,displayName:fe,profession:ce,professionList:[ce],totalFightMs:0,skills:new Map},Re.set(oe,De)),De.professionList.includes(ce)||De.professionList.push(ce),De.totalFightMs+=n.durationMS||0;const xe=u=>{if(!(u!=null&&u.id))return;const{name:d,icon:b}=Te(u),W=`s${u.id}`;let Be=De.skills.get(W);Be||(Be={id:W,name:d,icon:b,damage:0,downContribution:0},De.skills.set(W,Be)),Be.name.startsWith("Skill ")&&!d.startsWith("Skill ")&&(Be.name=d),!Be.icon&&b&&(Be.icon=b),Be.damage+=Number(u.totalDamage||0),Be.downContribution+=Number(u.downContribution||0)};le==="total"?(Nn=i.totalDamageDist)==null||Nn.forEach(u=>{u==null||u.forEach(d=>{R(d),xe(d)})}):(wn=i.targetDamageDist)==null||wn.forEach(u=>{u==null||u.forEach(d=>{d==null||d.forEach(b=>{R(b),xe(b)})})}),i.totalDamageTaken&&i.totalDamageTaken.forEach(u=>{u==null||u.forEach(d=>{var et,We,Ue,ot;if(!(d!=null&&d.id))return;let b=`Skill ${d.id}`;const W=((et=n.skillMap)==null?void 0:et[`s${d.id}`])||((We=n.skillMap)==null?void 0:We[`${d.id}`]);let Be=W==null?void 0:W.icon;if(W!=null&&W.name&&(b=W.name),b.startsWith("Skill ")){const dt=Tt(b,d.id,n.buffMap);dt&&(b=dt,Be=((ot=(Ue=n.buffMap)==null?void 0:Ue[`b${d.id}`])==null?void 0:ot.icon)||Be)}ke[d.id]||(ke[d.id]={name:b,icon:Be,damage:0,hits:0}),(!ke[d.id].name.startsWith("Skill ")||b.startsWith("Skill "))&&(ke[d.id].name=b),!ke[d.id].icon&&Be&&(ke[d.id].icon=Be),ke[d.id].damage+=d.totalDamage,ke[d.id].hits+=d.hits})})}),Fe.forEach(i=>{const m=lt(i.profession||i.name);m&&(Ne[m]=(Ne[m]||0)+1)});const L=oo({players:l,targets:a,skillMap:n.skillMap,buffMap:n.buffMap,getPlayerKey:i=>i.account&&i.account!=="Unknown"?i.account:i.name||null}),V=en(n.buffMap);Object.entries(L.playerConditions).forEach(([i,m])=>{const A=Ce.get(i);A&&Object.entries(m).forEach(([q,U])=>{const p=A.outgoingConditions[q]||{applications:0,damage:0,skills:{},icon:U.icon};p.applications+=Number(U.applications||0),p.damage+=Number(U.damage||0),U.applicationsFromBuffs&&(p.applicationsFromBuffs=(p.applicationsFromBuffs||0)+U.applicationsFromBuffs),U.applicationsFromBuffsActive&&(p.applicationsFromBuffsActive=(p.applicationsFromBuffsActive||0)+U.applicationsFromBuffsActive),Object.entries(U.skills||{}).forEach(([K,F])=>{const B=p.skills[K]||{name:F.name,hits:0,damage:0,icon:F.icon};B.hits+=Number(F.hits||0),B.damage+=Number(F.damage||0),!B.icon&&F.icon&&(B.icon=F.icon),p.skills[K]=B}),!p.icon&&U.icon&&(p.icon=U.icon),A.outgoingConditions[q]=p})}),Object.entries(L.summary).forEach(([i,m])=>{const A=Ee[i]||{name:m.name||i,icon:m.icon,applications:0,damage:0};A.applications+=Number(m.applications||0),A.damage+=Number(m.damage||0),m.applicationsFromBuffs&&(A.applicationsFromBuffs=(A.applicationsFromBuffs||0)+m.applicationsFromBuffs),m.applicationsFromBuffsActive&&(A.applicationsFromBuffsActive=(A.applicationsFromBuffsActive||0)+m.applicationsFromBuffsActive),!A.icon&&m.icon&&(A.icon=m.icon),Ee[i]=A}),me.forEach(i=>{const m=i.account&&i.account!=="Unknown"?i.account:i.name||"Unknown",A=Ce.get(m);!A||!i.totalDamageTaken||i.totalDamageTaken.forEach(q=>q==null?void 0:q.forEach(U=>{var Te,R,fe,ce,oe,De;if(!(U!=null&&U.id))return;let p=`Skill ${U.id}`;const K=((Te=n.skillMap)==null?void 0:Te[`s${U.id}`])||((R=n.skillMap)==null?void 0:R[`${U.id}`]);K!=null&&K.name&&(p=K.name);const F=Tt(p,U.id,n.buffMap);if(!F)return;const B=(ce=(fe=n.buffMap)==null?void 0:fe[`b${U.id}`])==null?void 0:ce.name,H=V.get(F)||((De=(oe=n.buffMap)==null?void 0:oe[`b${U.id}`])==null?void 0:De.icon),z=(K==null?void 0:K.icon)||H;p.startsWith("Skill ")&&(B||F)&&(p=B||F);const j=Number(U.hits??0),ne=Number(U.totalDamage??0),G=He[F]||{name:F,icon:H,applications:0,damage:0};G.applications+=Number.isFinite(j)?j:0,G.damage+=Number.isFinite(ne)?ne:0,!G.icon&&H&&(G.icon=H),He[F]=G;const he=A.incomingConditions[F]||{applications:0,damage:0,skills:{},icon:H};he.applications+=Number.isFinite(j)?j:0,he.damage+=Number.isFinite(ne)?ne:0;const y=he.skills[p]||{name:p,hits:0,damage:0,icon:z};y.hits+=Number.isFinite(j)?j:0,y.damage+=Number.isFinite(ne)?ne:0,!y.icon&&z&&(y.icon=z),he.skills[p]=y,!he.icon&&H&&(he.icon=H),A.incomingConditions[F]=he}))});const we=n.player_damage_mitigation||n.playerDamageMitigation,$e=we&&typeof we=="object"&&Object.keys(we).length>0;$e&&Object.entries(we).forEach(([i,m])=>{if(!m||typeof m!="object")return;const A=cn(i),q=ln(vt,A.account,A);Object.values(m).forEach(U=>{J((U==null?void 0:U.avoided_damage)??(U==null?void 0:U.avoidedDamage))<=0||dn(q.mitigationTotals,U)})});const Ve=n.player_minion_damage_mitigation||n.playerMinionDamageMitigation,Xe=Ve&&typeof Ve=="object"&&Object.keys(Ve).length>0;Xe&&Object.entries(Ve).forEach(([i,m])=>{if(!m||typeof m!="object")return;const A=cn(i);Object.entries(m).forEach(([q,U])=>{if(!U||typeof U!="object")return;const p=`${A.account}::${q}`,K=un(Et,p,{...A,minion:String(q||"Unknown")});Object.values(U).forEach(F=>{dn(K.mitigationTotals,F)})})}),(!$e||!Xe)&&($e||me.forEach(i=>{const m=(i==null?void 0:i.totalDamageTaken)||[];if(!Array.isArray(m)||m.length===0)return;const A=i.account||i.name||"Unknown",q={account:A,name:i.name||A,profession:lt(i.profession||"Unknown")};ln(vt,A,q);const U=n.skillMap||{},p=n.buffMap||{},K=Array.isArray(m)?m[0]:null;if(K==null||K.forEach(F=>{if(!(F!=null&&F.id))return;const B=J(F.blocked),H=J(F.evaded),z=J(F.glance??F.glanced),j=J(F.missed),ne=J(F.invulned),G=J(F.interrupted),he=J(F.hits??F.connectedHits),y=Number(F.id),Te=Ft(y,U,p);if(pn(fn,`${A}::${y}`,{totalHits:he,blocked:B,evaded:H,glanced:z,missed:j,invulned:ne,interrupted:G}),A===Bt){const R=pt.get(y),fe=it(y),ce=fe.hasSkill?fe.hits>0?fe.avg:0:1,oe=fe.hasSkill?fe.min||0:1,De=fe.hits>0?z*ce/2+(B+H+j+ne+G)*ce:0,xe=fe.hits>0?z*oe/2+(B+H+j+ne+G)*oe:0;Rt.push({logId:e.filePath||e.id||t,skillId:F.id,skillName:Te,blocked:B,evaded:H,glanced:z,missed:j,invulned:ne,interrupted:G,totalAvoids:B+H+z+j+ne+G,avg:ce,min:oe,enemyHits:(R==null?void 0:R.connectedHits)??0,enemyTotalDmg:(R==null?void 0:R.totalDamage)??0,avoidDmg:De,avoidMinDmg:xe})}}),A===Bt){const F=(B,H)=>{let z=0,j=0,ne=0;if(!Array.isArray(B))return{total:z,minTotal:j,hits:ne};for(const G of B){if(!(G!=null&&G.id))continue;const he=J(G.blocked),y=J(G.evaded),Te=J(G.glance??G.glanced),R=J(G.missed),fe=J(G.invulned),ce=J(G.interrupted),oe=Ft(Number(G.id),f,h),De=H(Number(G.id),oe);(De.hits??0)>0&&(z+=Te*De.avg/2+(he+y+R+fe+ce)*De.avg,j+=Te*De.min/2+(he+y+R+fe+ce)*De.min),ne+=J(G.hits??G.connectedHits)}return{total:z,minTotal:j,hits:ne}};xt.push({logId:e.filePath||e.id||t,variant:"current_global_name_taken0",...F(K,(B,H)=>{const z=it(B),j=z.hasSkill?z.hits>0?z.avg:0:1,ne=z.hasSkill?z.min||0:1;return{avg:j,min:ne,hits:z.hits}})})}}),Xe||me.forEach(i=>{const m=(i==null?void 0:i.minions)||[];if(!Array.isArray(m)||m.length===0)return;const A=i.account||i.name||"Unknown",q={account:A,name:i.name||A,profession:lt(i.profession||"Unknown")},U=n.skillMap||{},p=n.buffMap||{};m.forEach(K=>{const F=(K==null?void 0:K.totalDamageTakenDist)||[];if(!Array.isArray(F)||F.length===0)return;let B=String((K==null?void 0:K.name)||"Unknown").replace(/^Juvenile\s+/i,"")||"Unknown";B.toUpperCase().includes("UNKNOWN")&&(B="Unknown");const H=`${A}::${B}`;un(Et,H,{...q,minion:B});const z=Array.isArray(F)?F[0]:null;if(z==null||z.forEach(j=>{if(!(j!=null&&j.id))return;const ne=J(j.blocked),G=J(j.evaded),he=J(j.glance??j.glanced),y=J(j.missed),Te=J(j.invulned),R=J(j.interrupted),fe=J(j.hits??j.connectedHits),ce=Number(j.id),oe=Ft(ce,U,p);if(pn(gn,`${H}::${ce}`,{totalHits:fe,blocked:ne,evaded:G,glanced:he,missed:y,invulned:Te,interrupted:R}),A===Bt&&B===mn){const De=pt.get(ce),xe=it(ce),Ze=xe.hasSkill?xe.hits>0?xe.avg:0:1,ye=xe.hasSkill?xe.min||0:1,at=xe.hits>0?he*Ze/2+(ne+G+y+Te+R)*Ze:0,rt=xe.hits>0?he*ye/2+(ne+G+y+Te+R)*ye:0;_t.push({logId:e.filePath||e.id||t,skillId:j.id,skillName:oe,blocked:ne,evaded:G,glanced:he,missed:y,invulned:Te,interrupted:R,totalAvoids:ne+G+he+y+Te+R,avg:Ze,min:ye,enemyHits:(De==null?void 0:De.connectedHits)??0,enemyTotalDmg:(De==null?void 0:De.totalDamage)??0,avoidDmg:at,avoidMinDmg:rt})}}),A===Bt&&B===mn){const j=(y,Te)=>{let R=0,fe=0,ce=0;if(!Array.isArray(y))return{total:R,minTotal:fe,hits:ce};for(const oe of y){if(!(oe!=null&&oe.id))continue;const De=J(oe.blocked),xe=J(oe.evaded),Ze=J(oe.glance??oe.glanced),ye=J(oe.missed),at=J(oe.invulned),rt=J(oe.interrupted),Ut=Ft(Number(oe.id),f,h),{avg:bt,min:ht}=Te(Number(oe.id),Ut);J(oe.hits??oe.connectedHits)>0&&(R+=Ze*bt/2+(De+xe+ye+at+rt)*bt,fe+=Ze*ht/2+(De+xe+ye+at+rt)*ht),ce+=J(oe.hits??oe.connectedHits)}return{total:R,minTotal:fe,hits:ce}},ne=Array.isArray(F)?F[0]||[]:[],G=Array.isArray(F)?F.flat():[],he=Array.isArray(K==null?void 0:K.totalDamageTaken)?K.totalDamageTaken[0]||[]:[];st.push({logId:e.filePath||e.id||t,variant:"current_global_name_dist0",...j(ne,(y,Te)=>{const R=it(y),fe=R.hasSkill?R.hits>0?R.avg:0:1,ce=R.hasSkill&&R.min||0;return{avg:fe,min:ce}})}),st.push({logId:e.filePath||e.id||t,variant:"local_name_dist0",...j(ne,(y,Te)=>ue(Te))}),st.push({logId:e.filePath||e.id||t,variant:"local_id_dist0",...j(ne,y=>x(y))}),st.push({logId:e.filePath||e.id||t,variant:"global_name_alllists",...j(G,(y,Te)=>{const R=it(y),fe=R.hasSkill?R.hits>0?R.avg:0:1,ce=R.hasSkill&&R.min||0;return{avg:fe,min:ce}})}),st.push({logId:e.filePath||e.id||t,variant:"global_name_taken0",...j(he,(y,Te)=>{const R=it(y),fe=R.hasSkill?R.hits>0?R.avg:0:1,ce=R.hasSkill&&R.min||0;return{avg:fe,min:ce}})})}})}))}),_t.length>0&&(console.groupCollapsed("[Mitigation Debug] Ashtonlightstone.9145 / Illusionary Warden"),console.table(_t),st.length>0&&console.table(st),console.groupEnd()),Rt.length>0&&(console.groupCollapsed("[Mitigation Debug] Ashtonlightstone.9145 / Player"),console.table(Rt),xt.length>0&&console.table(xt),console.groupEnd());const bn=(e,t)=>{const n=new Map,l=a=>{let f=n.get(a);return f||(f=gt(),n.set(a,f)),f};t.forEach((a,f)=>{const h=f.lastIndexOf("::"),$=h>-1?f.slice(0,h):f,D=h>-1?Number(f.slice(h+2)):Number.NaN,x=Number.isFinite(D)?it(D):{hasSkill:!1,avg:0,min:0,hits:0};if(!x.hasSkill||x.hits<=0)return;const ue=x.avg,Z=x.min,k=a.glanced*ue/2+(a.blocked+a.evaded+a.missed+a.invulned+a.interrupted)*ue,v=a.glanced*Z/2+(a.blocked+a.evaded+a.missed+a.invulned+a.interrupted)*Z;if(k<=0)return;const E=l($);E.totalHits+=a.totalHits,E.blocked+=a.blocked,E.evaded+=a.evaded,E.glanced+=a.glanced,E.missed+=a.missed,E.invulned+=a.invulned,E.interrupted+=a.interrupted,E.totalMitigation+=k,E.minMitigation+=v}),e.forEach((a,f)=>{const h=n.get(f)||gt();a.mitigationTotals.totalHits=h.totalHits,a.mitigationTotals.blocked=h.blocked,a.mitigationTotals.evaded=h.evaded,a.mitigationTotals.glanced=h.glanced,a.mitigationTotals.missed=h.missed,a.mitigationTotals.invulned=h.invulned,a.mitigationTotals.interrupted=h.interrupted,a.mitigationTotals.totalMitigation=h.totalMitigation,a.mitigationTotals.minMitigation=h.minMitigation})};bn(vt,fn),bn(Et,gn);const Co=P>0?Math.round(Y/P):0,ko=P>0?Math.round(Q/P):0,Do=X>0?(pe/X).toFixed(2):pe>0?"∞":"0.00",So=Oe>0?(te/Oe).toFixed(2):te>0?"∞":"0.00",hn=(e,t)=>{const l=e.filter(h=>Number.isFinite(h.value)&&(t?h.value>0:h.value>=0)).sort((h,$)=>{const D=t?$.value-h.value:h.value-$.value;return D!==0?D:h.account.localeCompare($.account)});let a=null,f=0;return l.map((h,$)=>((a===null||h.value!==a)&&(f=$+1,a=h.value),{rank:f,...h}))},qt=Array.from(Ce.values()).map(e=>{const t=Array.from(e.professions).filter(n=>n!=="Unknown");if(e.professionList=t,t.length>0){let n=t[0],l=e.professionTimeMs[n]||0;t.forEach(a=>{const f=e.professionTimeMs[a]||0;f>l&&(l=f,n=a)}),e.profession=n}return{key:e.account,stat:e}}),Cn=e=>{const t=Ce.get(e.account);if(!t){const a=e.professionList.length>0?e.professionList:e.profession?[e.profession]:[];return{...e,professionList:a}}const n=t.professionList&&t.professionList.length>0?t.professionList:Array.from(t.professions||[]).filter(a=>a&&a!=="Unknown"),l=t.profession||e.profession;return{...e,profession:l,professionList:n.length>0?n:l?[l]:[],activeMs:t.defenseActiveMs||t.totalFightMs||e.activeMs}},To=Array.from(vt.values()).map(Cn).filter(e=>ho(e.mitigationTotals)).sort((e,t)=>e.account.localeCompare(t.account)),Ao=Array.from(Et.values()).map(Cn).filter(e=>e.mitigationTotals.totalMitigation>0).sort((e,t)=>{const n=e.account.localeCompare(t.account);return n!==0?n:String(e.minion||"").localeCompare(String(t.minion||""))}),It=(e,t)=>{switch(t){case"downContrib":return e.downContrib;case"barrier":return e.barrier;case"healing":return e.healing;case"dodges":return e.dodges;case"strips":return e.strips;case"cleanses":return e.cleanses;case"cc":return e.cc;case"stability":return e.stab;case"revives":return e.revives;case"dps":return e.dps;case"damage":return e.damage;case"participation":return e.logsJoined;case"closestToTag":return!e.isCommander&&e.distCount>0?e.totalDist/e.distCount:Number.POSITIVE_INFINITY;default:return 0}},je=(e,t)=>hn(qt.map(({stat:n})=>({account:n.account,profession:n.profession,professionList:n.professionList,value:It(n,e),count:n.logsJoined})),t),Ie={downContrib:je("downContrib",!0),barrier:je("barrier",!0),healing:je("healing",!0),dodges:je("dodges",!0),strips:je("strips",!0),cleanses:je("cleanses",!0),cc:je("cc",!0),stability:je("stability",!0),revives:je("revives",!0),participation:je("participation",!0),dps:je("dps",!0),damage:je("damage",!0),closestToTag:je("closestToTag",!1).filter(e=>Number.isFinite(e.value))},Mo={downContrib:"downContrib",barrier:"barrier",healing:"healing",dodges:"dodges",strips:"strips",cleanses:"cleanses",cc:"cc",stability:"stability",closestToTag:"closestToTag"},Ae=e=>{const t=e==null?void 0:e[0];return{value:(t==null?void 0:t.value)??0,player:(t==null?void 0:t.account)??"-",count:(t==null?void 0:t.count)??0,profession:(t==null?void 0:t.profession)??"Unknown",professionList:(t==null?void 0:t.professionList)??[]}},Ye={maxDownContrib:Ae([]),maxBarrier:Ae([]),maxHealing:Ae([]),maxDodges:Ae([]),maxStrips:Ae([]),maxCleanses:Ae([]),maxCC:Ae([]),maxStab:Ae([]),closestToTag:Ae([])},Ge={},No=(e,t)=>{if(t==="closestToTag")return It(e,t);const n=Math.max(1,(e.totalFightMs||0)/1e3);return It(e,t)/n};Object.values(Mo).forEach(e=>{const t=e!=="closestToTag";Ge[e]=hn(qt.map(({stat:n})=>({account:n.account,profession:n.profession,professionList:n.professionList,value:No(n,e),count:n.logsJoined})),t)}),Ye.maxDownContrib=Ae(Ge.downContrib),Ye.maxBarrier=Ae(Ge.barrier),Ye.maxHealing=Ae(Ge.healing),Ye.maxDodges=Ae(Ge.dodges),Ye.maxStrips=Ae(Ge.strips),Ye.maxCleanses=Ae(Ge.cleanses),Ye.maxCC=Ae(Ge.cc),Ye.maxStab=Ae(Ge.stability),Ye.closestToTag=Ae(Ge.closestToTag);const wo={maxDownContrib:Ae(Ie.downContrib),maxBarrier:Ae(Ie.barrier),maxHealing:Ae(Ie.healing),maxDodges:Ae(Ie.dodges),maxStrips:Ae(Ie.strips),maxCleanses:Ae(Ie.cleanses),maxCC:Ae(Ie.cc),maxStab:Ae(Ie.stability),closestToTag:Ae(Ie.closestToTag)};let jt={player:"None",account:"None",score:-1,profession:"Unknown",professionList:[],color:"#64748b",topStats:[]},kn,Dn,Sn=0;if(ie!=null&&ie.showMvp){const e={"Down Contribution":"downContribution",Healing:"healing",Cleanses:"cleanses",Strips:"strips",Stability:"stability",CC:"cc",Revives:"revives","Distance to Tag":"distanceToTag",Participation:"participation",Dodging:"dodging",DPS:"dps",Damage:"damage"},t=f=>{const h=e[f];return h?Number(_[h]||0)>0:!1},n=[],l=f=>[...f||[]].filter(h=>t(h==null?void 0:h.name)).sort((h,$)=>$.ratio-h.ratio||h.rank-$.rank||h.name.localeCompare($.name)).slice(0,3),a=f=>{var $;if(!f)return;const h=l(f.contribs);return{...f,player:f.name,reason:(($=h[0])==null?void 0:$.name)||"Top Performance",topStats:h}};qt.forEach(({stat:f})=>{let h=0;const $=[],D=(x,ue,Z,k,v=!0)=>{var O,de;if(Z<=0)return;const E=((O=ue[0])==null?void 0:O.value)||0;if(E&&Number.isFinite(x)&&(v?x>0:x<Number.POSITIVE_INFINITY)){const ee=v?x/E:E/x;h+=ee*Z;const Me=((de=ue.find(Se=>Se.account===f.account))==null?void 0:de.rank)||0;$.push({name:k,ratio:ee,val:x.toLocaleString(),rank:Me})}};D(f.downContrib,Ie.downContrib,_.downContribution,"Down Contribution"),D(f.healing,Ie.healing,_.healing,"Healing"),D(f.cleanses,Ie.cleanses,_.cleanses,"Cleanses"),D(f.strips,Ie.strips,_.strips,"Strips"),D(f.stab,Ie.stability,_.stability,"Stability"),D(f.cc,Ie.cc,_.cc,"CC"),D(f.revives,Ie.revives,_.revives,"Revives"),D(It(f,"closestToTag"),Ie.closestToTag,_.distanceToTag,"Distance to Tag",!1),D(f.logsJoined,Ie.participation,_.participation,"Participation"),D(f.dodges,Ie.dodges,_.dodging,"Dodging"),D(f.dps,Ie.dps,_.dps,"DPS"),D(f.damage,Ie.damage,_.damage,"Damage"),n.push({...f,score:h,contribs:$.filter(x=>t(x.name))})}),n.sort((f,h)=>h.score-f.score),n[0]&&n[0].score>0&&(jt=a(n[0])||jt),kn=a(n[1]),Dn=a(n[2]),Sn=n.length>0?n.reduce((f,h)=>f+h.score,0)/n.length:0}const vo=Object.values(be).sort((e,t)=>{const n=M==="downContribution"?e.downContribution:e.damage;return(M==="downContribution"?t.downContribution:t.damage)-n}).slice(0,25),Eo=Object.values(ke).sort((e,t)=>t.damage-e.damage).slice(0,25),Fo=e=>{const t=String(e).replace(/^Detailed\s*WvW\s*-\s*/i,"").replace(/^World\s*vs\s*World\s*-\s*/i,"").replace(/^WvW\s*-\s*/i,"").trim(),n=t.match(/^(Red|Blue|Green)\s+(?:Alpine|Desert)?\s*Borderlands$/i);return n?`${n[1]} Borderlands`:t||"Unknown"},Wt=(e,t)=>Fo((e==null?void 0:e.zone)||(e==null?void 0:e.mapName)||(e==null?void 0:e.map)||(e==null?void 0:e.location)||(e==null?void 0:e.fightName)||(t==null?void 0:t.fightName)||(t==null?void 0:t.encounterName)||"Unknown"),Bo=(e,t)=>{const n=(t==null?void 0:t.permalink)||(e==null?void 0:e.permalink);if(typeof n=="string"&&n.trim().length>0)return n.trim();const l=e==null?void 0:e.uploadLinks;if(!Array.isArray(l))return"";for(const a of l){if(typeof a=="string"&&a.trim().length>0)return a.trim();if(a&&typeof a=="object"){const f=a.permalink||a.link||a.url||a.reportLink;if(typeof f=="string"&&f.trim().length>0)return f.trim()}}return""},Vt={};I.forEach(e=>{const t=Wt(e==null?void 0:e.details,e);Vt[t]=(Vt[t]||0)+1});const Io=Object.entries(Vt).map(([e,t])=>{const n=String(e).trim(),l=/eternal battlegrounds|^ebg$/i.test(n);let a="#64748b";return l?a="#ffffff":/red/i.test(n)?a="#ef4444":/blue/i.test(n)?a="#3b82f6":/green/i.test(n)&&(a="#22c55e"),{name:e,value:t,color:a}}).sort((e,t)=>t.value-e.value),{boonTables:Po}=Pn(I),Uo=I.map((e,t)=>{var l,a;const n=((l=e.details)==null?void 0:l.players)||[];return{index:t+1,label:`Log ${t+1}`,timestamp:nt(e.details,e),squadCount:n.filter(f=>!f.notInSquad).length,friendlyCount:n.length,enemies:((a=e.details)==null?void 0:a.targets).filter(f=>!f.isFake).length}}).sort((e,t)=>e.timestamp-t.timestamp),zt={};Array.from(Ce.values()).forEach(e=>{e.profession&&e.profession!=="Unknown"&&(zt[e.profession]=(zt[e.profession]||0)+1)});const Ho=Object.entries(zt).map(([e,t])=>({name:e,value:t,color:tn(e)})).sort((e,t)=>t.value-e.value),Kt={};Object.keys(Ne).length===0&&I.forEach(e=>{var t,n;(n=(t=e.details)==null?void 0:t.targets)==null||n.forEach(l=>{if(l.isFake)return;const a=l.profession&&l.profession!=="Unknown"?l.profession:l.name||l.id||"Unknown",f=lt(a);Kt[f]=(Kt[f]||0)+1})});const Lo=Object.keys(Ne).length>0?Ne:Kt,$o=Object.entries(Lo).map(([e,t])=>({name:e,value:t,color:tn(e)})).sort((e,t)=>t.value-e.value),Oo=I.map((e,t)=>({log:e,originalIndex:t})).sort((e,t)=>nt(e.log.details,e.log)-nt(t.log.details,t.log)).map(({log:e},t)=>{const n=e.details;if(!n)return null;const l=n.players||[],a=l.filter(r=>!r.notInSquad),f=l.filter(r=>r.notInSquad),h=n.targets||[],$=h.filter(r=>!r.isFake),D=a.reduce((r,g)=>{var T,N;return r+(((N=(T=g.dpsAll)==null?void 0:T[0])==null?void 0:N.damage)||0)},0),x=a.reduce((r,g)=>{var T,N;return r+(((N=(T=g.defenses)==null?void 0:T[0])==null?void 0:N.damageTaken)||0)},0),{enemyDeaths:ue,enemyDownsDeaths:Z}=Pe(n),k=ve(n),v=nt(n,e),E=Wt(n,e),O={red:0,green:0,blue:0},de=r=>{const g=Number(r);return Number.isFinite(g)?g:0},ee=r=>{if(!r||typeof r!="object")return;const g=r.teamID??r.teamId??r.team??r.teamColor??r.team_color;if(g!=null)return g;const T=Object.keys(r).find(N=>/^team/i.test(N));return T?r[T]:void 0},Me=(r,g)=>{if(r==null)return null;if(typeof r=="string"){const T=r.toLowerCase();return T.includes("red")?"red":T.includes("green")?"green":T.includes("blue")?"blue":T==="r"?"red":T==="g"?"green":T==="b"?"blue":null}if(typeof r=="number")if(g==="zeroBased"){if(r===0)return"red";if(r===1)return"green";if(r===2)return"blue"}else{if(r===1)return"red";if(r===2)return"green";if(r===3)return"blue"}return null},Se=(r,g)=>{const T={};return r.forEach(N=>{const L=g(N),V=lt(L);V&&(T[V]=(T[V]||0)+1)}),T},re=Se(a,r=>(r==null?void 0:r.profession)||(r==null?void 0:r.name)),me=Se(f,r=>(r==null?void 0:r.profession)||(r==null?void 0:r.name)),Fe=Se($,r=>(r==null?void 0:r.profession)||(r==null?void 0:r.name)||(r==null?void 0:r.id));if(n.teamCounts&&typeof n.teamCounts=="object"){const r=n.teamCounts;O.red=de(r.red??r.r??r[0]??r[1]),O.green=de(r.green??r.g??r[1]??r[2]),O.blue=de(r.blue??r.b??r[2]??r[3])}else{const r=[];h.forEach(L=>{if(L!=null&&L.isFake)return;const V=ee(L);V!=null&&r.push(V)}),l.forEach(L=>{if(!(L!=null&&L.notInSquad))return;const V=ee(L);V!=null&&r.push(V)}),r.length===0&&l.forEach(L=>{const V=ee(L);V!=null&&r.push(V)});const g=new Set;r.forEach(L=>{typeof L=="number"&&g.add(L)});const T=g.has(0)?"zeroBased":g.has(3)?"oneBased":"zeroBased";if(r.forEach(L=>{const V=Me(L,T);V&&(O[V]+=1)}),O.red+O.green+O.blue===0&&r.length>0){const L=new Map;r.forEach(we=>{const $e=String(we);L.set($e,(L.get($e)||0)+1)});const V=Array.from(L.values()).sort((we,$e)=>$e-we);O.red=V[0]||0,O.green=V[1]||0,O.blue=V[2]||0}O.red+O.green+O.blue===0&&(O.red=Math.max($.length,l.filter(L=>L==null?void 0:L.notInSquad).length))}return{id:e.filePath||`fight-${t}`,label:e.encounterName||`Fight ${t+1}`,permalink:Bo(n,e),timestamp:v,mapName:E,duration:mo(n.durationMS),isWin:k,squadCount:a.length,allyCount:f.length,enemyCount:$.length,teamCounts:O,alliesDown:a.reduce((r,g)=>{var T,N;return r+(((N=(T=g.defenses)==null?void 0:T[0])==null?void 0:N.downCount)||0)},0),alliesDead:a.reduce((r,g)=>{var T,N;return r+(((N=(T=g.defenses)==null?void 0:T[0])==null?void 0:N.deadCount)||0)},0),alliesRevived:a.reduce((r,g)=>{var T,N;return Number(((N=(T=g.statsAll)==null?void 0:T[0])==null?void 0:N.saved)||0)>0?r+1:r},0),rallies:0,enemyDeaths:ue,enemyDowns:Math.max(0,Z-ue),totalOutgoingDamage:D,totalIncomingDamage:x,incomingBarrierAbsorbed:a.reduce((r,g)=>{var T,N;return r+(((N=(T=g.defenses)==null?void 0:T[0])==null?void 0:N.damageBarrier)||0)},0),outgoingBarrierAbsorbed:a.reduce((r,g)=>{var L;const T=(L=g.extBarrierStats)==null?void 0:L.outgoingBarrier;if(!Array.isArray(T))return r;let N=0;return T.forEach(V=>{if(Array.isArray(V)){V.forEach(we=>{N+=Number((we==null?void 0:we.barrier)||0)});return}N+=Number((V==null?void 0:V.barrier)||0)}),r+N},0),squadClassCountsFight:re,allyClassCountsFight:me,enemyClassCounts:Fe}}).filter(Boolean),_o=(e,t)=>{const n=(t==null?void 0:t.skillMap)||{},l=(t==null?void 0:t.buffMap)||{};let a=0,f="";const h=D=>{const x=Number(D);if(!Number.isFinite(x))return String(D||"Unknown Skill");const ue=(n==null?void 0:n[`s${x}`])||(n==null?void 0:n[`${x}`]);if(ue!=null&&ue.name)return String(ue.name);const Z=(l==null?void 0:l[`b${x}`])||(l==null?void 0:l[`${x}`]);return Z!=null&&Z.name?String(Z.name):`Skill ${x}`},$=D=>{if(!D||typeof D!="object")return;const x=[Number(D.max),Number(D.maxDamage),Number(D.maxHit),Number(D.totalDamage)>0&&Number(D.connectedHits)>0?Number(D.totalDamage)/Number(D.connectedHits):0].filter(Z=>Number.isFinite(Z)),ue=x.length>0?Math.max(...x):0;ue>a&&(a=ue,f=h(D.id))};return Array.isArray(e==null?void 0:e.totalDamageDist)&&e.totalDamageDist.forEach(D=>{Array.isArray(D)&&D.forEach(x=>$(x))}),Array.isArray(e==null?void 0:e.targetDamageDist)&&e.targetDamageDist.forEach(D=>{Array.isArray(D)&&D.forEach(x=>{Array.isArray(x)&&x.forEach(ue=>$(ue))})}),{peak:a,skillName:f||"Unknown Skill"}},Ro=(()=>{const e=k=>String(k||"").replace(/^Detailed\s*WvW\s*-\s*/i,"").replace(/^World\s*vs\s*World\s*-\s*/i,"").replace(/^WvW\s*-\s*/i,"").trim(),t=k=>e(k).toLowerCase().split(/[^a-z0-9]+/i).map(v=>v.trim()).filter(Boolean).map(v=>v.length>3&&v.endsWith("s")?v.slice(0,-1):v),n=(k,v)=>{const E=e(k),O=e(v);if(!O)return E;if(!E)return O;const de=t(E),ee=t(O),Me=new Set(de),Se=new Set(ee),re=ee.length>0&&ee.every(Fe=>Me.has(Fe)),me=de.length>0&&de.every(Fe=>Se.has(Fe));return re||me?E:`${E} - ${O}`},l=[],a=new Map,f=k=>{const v=re=>{if(!Array.isArray(re)||re.length===0)return[];const me=[];for(let Fe=0;Fe<re.length;Fe+=1){const r=Number(re[Fe]||0),g=Fe>0?Number(re[Fe-1]||0):0;me.push(Math.max(0,r-g))}return me},E=re=>{if(!Array.isArray(re))return[];const me=re.reduce((r,g)=>Math.max(r,Array.isArray(g)?g.length:0),0);if(me<=0)return[];const Fe=new Array(me).fill(0);return re.forEach(r=>{if(Array.isArray(r))for(let g=0;g<me;g+=1)Fe[g]+=Number(r[g]||0)}),Fe},O=re=>Array.isArray(re)?re.map(me=>Number(me||0)):null,ee=(re=>{if(!Array.isArray(re)||re.length===0)return null;const me=re[0];if(!Array.isArray(me))return null;if(Array.isArray(me[0])&&Array.isArray(me[0][0]))return E(me);if(Array.isArray(me[0])&&!Array.isArray(me[0][0])){const Fe=re.map(r=>O(Array.isArray(r)?r[0]:null)).filter(r=>Array.isArray(r)&&r.length>0);if(Fe.length>0)return E(Fe)}return null})(k==null?void 0:k.targetDamage1S),Me=Array.isArray(k==null?void 0:k.damage1S)&&Array.isArray(k.damage1S[0])?k.damage1S[0]:null,Se=ee||(Array.isArray(Me)?Me.map(re=>Number(re||0)):[]);return v(Se)},h=(k,v)=>{if(!Array.isArray(k)||k.length===0||v<=0)return 0;let E=0,O=0;for(let de=0;de<k.length;de+=1)E+=Number(k[de]||0),de>=v&&(E-=Number(k[de-v]||0)),de>=v-1&&E>O&&(O=E);return Math.max(0,O)},$=(k,v)=>{if(!Array.isArray(k)||k.length===0||v<=0)return[];const E=[];for(let O=0;O<k.length;O+=v){const de=Math.min(O+v,k.length),ee=k.slice(O,de).reduce((Me,Se)=>Me+Number(Se||0),0);E.push(ee)}return E},D=k=>Array.isArray(k)?k.map(v=>Array.isArray(v)?[Number(v[0]),Number(v[1])]:v&&typeof v=="object"?[Number(v.time),Number(v.value)]:null).filter(v=>!!v&&Number.isFinite(v[0])&&v[0]>=0):[],x=(k,v,E,O,de)=>{if(!k.length||O<=0)return[];const ee=Math.max(O*5e3,de||0),Me=N=>N.reduce((L,V)=>V>=0&&V<=ee+2e3?L+1:L,0),Se=k.map(N=>Number(N||0)).filter(N=>Number.isFinite(N)&&N>=0);if(!Se.length)return[];const re=[Se],me=Se.reduce((N,L)=>Math.max(N,L),0),Fe=Se.reduce((N,L)=>Math.min(N,L),Number.POSITIVE_INFINITY);me>ee*20&&re.push(Se.map(N=>N/1e3)),me<=ee*2&&Fe>=0&&me>0&&me<Math.max(120,O*5+10)&&re.push(Se.map(N=>N*1e3));let r=Se,g=0,T=-1;return re.forEach(N=>{const L=N.reduce((we,$e)=>Math.min(we,$e),Number.POSITIVE_INFINITY),V=new Set([0,...v,...E]);if(Number.isFinite(L)&&ee>0&&L>ee){const we=Math.floor(L/ee)*ee;V.add(we),V.add(Math.max(0,we-ee))}V.forEach(we=>{const $e=N.map(Xe=>Xe-we),Ve=Me($e);Ve>T&&(T=Ve,g=we,r=N)})}),r.map(N=>N-g).filter(N=>Number.isFinite(N)&&N>=0)},ue=(k,v,E,O,de)=>{const ee=x(k,v,E,O,de);return Array.from(new Set(ee.map(Me=>Math.floor(Me/5e3)).filter(Me=>Number.isFinite(Me)&&Me>=0&&Me<O)))};I.map(k=>({log:k,ts:nt(k==null?void 0:k.details,k)})).sort((k,v)=>k.ts-v.ts).forEach(({log:k},v)=>{const E=k==null?void 0:k.details;if(!E)return;const O=e(E.fightName||k.fightName||`Fight ${v+1}`),de=Wt(E,k),ee=n(O,String(de||"")),Me={},Se=Array.isArray(E.players)?E.players:[],re=Se.flatMap(g=>{const T=g==null?void 0:g.combatReplayData;return Array.isArray(T)?T.map(N=>Number(N==null?void 0:N.start)):[Number(T==null?void 0:T.start)]}).filter(g=>Number.isFinite(g)&&g>=0);Se.forEach(g=>{if(g!=null&&g.notInSquad)return;const T=String((g==null?void 0:g.account)||(g==null?void 0:g.name)||"Unknown"),N=String((g==null?void 0:g.character_name)||(g==null?void 0:g.display_name)||(g==null?void 0:g.name)||""),L=String((g==null?void 0:g.profession)||"Unknown"),V=`${T}|${L}`,we=_o(g,E),$e=Number(we.peak||0),Ve=f(g),Xe=Number(h(Ve,1)||0),ut=Number(h(Ve,5)||0),Pt=Math.max(0,Math.ceil(Number((E==null?void 0:E.durationMS)||0)/5e3)),i=Math.max(0,Math.ceil(Ve.length/5)),m=Math.max(Pt,i),A=$(Ve,5),q=Array.from({length:m},(H,z)=>Number(A[z]||0)),U=(()=>{const H=g==null?void 0:g.combatReplayData;return Array.isArray(H)?H.filter(z=>z&&typeof z=="object"):H&&typeof H=="object"?[H]:[]})(),p=U.map(H=>Number(H==null?void 0:H.start)).filter(H=>Number.isFinite(H)&&H>=0),K=U.flatMap(H=>D(H==null?void 0:H.down).map(([z])=>Number(z||0))),F=U.flatMap(H=>D(H==null?void 0:H.dead).map(([z])=>Number(z||0)));Me[V]={hit:$e,burst1s:Xe,burst5s:ut,skillName:we.skillName,buckets5s:q,downIndices5s:ue(K,p,re,m,Number((E==null?void 0:E.durationMS)||0)),deathIndices5s:ue(F,p,re,m,Number((E==null?void 0:E.durationMS)||0))};const B=a.get(V)||{key:V,account:T,displayName:T,characterName:N,profession:L,professionList:[L],logs:0,peakHit:0,peak1s:0,peak5s:0,peakFightLabel:"",peakSkillName:""};B.logs+=1,B.professionList.includes(L)||B.professionList.push(L),!B.characterName&&N&&(B.characterName=N),$e>B.peakHit&&(B.peakHit=$e,B.peakFightLabel=ee,B.peakSkillName=we.skillName),Xe>B.peak1s&&(B.peak1s=Xe),ut>B.peak5s&&(B.peak5s=ut),a.set(V,B)});const me=Object.values(Me).reduce((g,T)=>Math.max(g,Number((T==null?void 0:T.hit)||0)),0),Fe=Object.values(Me).reduce((g,T)=>Math.max(g,Number((T==null?void 0:T.burst1s)||0)),0),r=Object.values(Me).reduce((g,T)=>Math.max(g,Number((T==null?void 0:T.burst5s)||0)),0);l.push({id:k.filePath||k.id||`fight-${v+1}`,shortLabel:`F${v+1}`,fullLabel:ee,timestamp:nt(E,k),values:Me,maxHit:me,max1s:Fe,max5s:r})});const Z=Array.from(a.values()).sort((k,v)=>v.peakHit!==k.peakHit?v.peakHit-k.peakHit:k.displayName.localeCompare(v.displayName));return{fights:l,players:Z}})(),xo=Array.from(Je.entries()).map(([e,t])=>{const n=Qe.get(e)||{},l=Array.from(t.values()).map(a=>{var ue;const f=Array.from(a.professions||[]).filter(Z=>Z&&Z!=="Unknown");let h=a.profession||"Unknown";if(f.length>0){h=f[0];let Z=((ue=a.professionTimeMs)==null?void 0:ue[h])||0;f.forEach(k=>{var E;const v=((E=a.professionTimeMs)==null?void 0:E[k])||0;v>Z&&(Z=v,h=k)})}const $=a.durationMs||0,D=a.totalMs/1e3,x=$>0?a.totalMs/$:0;return{account:a.account,profession:h,professionList:f,total:D,perSecond:x,duration:$/1e3}}).filter(a=>a.total>0||a.perSecond>0);return{id:e,name:n.name||e,icon:n.icon,rows:l}}).filter(e=>e.rows.length>0),qo=Array.from(Re.values()).map(e=>{const t=Array.from(e.skills.values()).sort((l,a)=>a.damage-l.damage),n=t.reduce((l,a)=>(l[a.id]=a,l),{});return{key:e.key,account:e.account,displayName:e.displayName,profession:e.profession,professionList:e.professionList,totalFightMs:e.totalFightMs,skills:t,skillMap:n}}).sort((e,t)=>e.displayName.localeCompare(t.displayName));return{total:P,wins:ae,losses:S,avgSquadSize:Co,avgEnemies:ko,squadKDR:Do,enemyKDR:So,totalSquadKills:pe,totalSquadDeaths:X,totalEnemyKills:te,totalEnemyDeaths:Oe,leaderboards:Ie,...wo,outgoingConditionSummary:Object.values(Ee).sort((e,t)=>t.damage-e.damage),incomingConditionSummary:Object.values(He).sort((e,t)=>t.damage-e.damage),outgoingConditionPlayers:Array.from(Ce.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,conditions:e.outgoingConditions})),incomingConditionPlayers:Array.from(Ce.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,conditions:e.incomingConditions})),topSkills:vo,topIncomingSkills:Eo,playerSkillBreakdowns:qo,topSkillsMetric:M,mapData:Io,timelineData:Uo,boonTables:Po,offensePlayers:Array.from(Ce.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,offenseTotals:e.offenseTotals,offenseRateWeights:e.offenseRateWeights,totalFightMs:e.totalFightMs})),defensePlayers:Array.from(Ce.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,defenseTotals:e.defenseTotals,activeMs:e.defenseActiveMs})),damageMitigationPlayers:To,damageMitigationMinions:Ao,supportPlayers:Array.from(Ce.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,supportTotals:e.supportTotals,activeMs:e.supportActiveMs})),healingPlayers:Array.from(Ce.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,healingTotals:e.healingTotals,activeMs:e.healingActiveMs})),mvp:jt,silver:kn,bronze:Dn,squadClassData:Ho,enemyClassData:$o,fightBreakdown:Oo,spikeDamage:Ro,specialTables:xo,topStatsPerSecond:Ye,topStatsLeaderboardsPerSecond:Ge,avgMvpScore:Sn}})(),qe=(()=>{const ge=new Map,le=new Map,M=[],P=new Map,ae=new Map;I.forEach(Y=>{const Q=Y.details;if(!Q)return;const X=Q.skillMap||{},pe=Q.fightName||"Log",Oe=nt(Q,Y)||Date.now(),te={id:Y.filePath||Y.id||pe,label:pe,timestamp:Oe,skillEntries:{},playerActiveSeconds:{},durationSeconds:Q.durationMS?Q.durationMS/1e3:0};(Q.players||[]).forEach(ve=>{if(ve.notInSquad)return;const Ce=ve.account||ve.name||"Unknown",_e=ve.profession||"Unknown",be=`${Ce}|${_e}`;let ke=le.get(be);ke||(ke={key:be,account:Ce,displayName:Ce,profession:_e,professionList:[_e],logs:0,totalActiveSeconds:0,skillTotals:{}},le.set(be,ke)),ke.logs++;const Re=(Array.isArray(ve.activeTimes)?ve.activeTimes[0]:0)/1e3;ke.totalActiveSeconds=(ke.totalActiveSeconds||0)+Re,te.playerActiveSeconds[be]=Re,(ve.rotation||[]).forEach(Ee=>{var Mt,Nt,wt;if(!(Ee!=null&&Ee.id))return;const He=((Mt=Ee.skills)==null?void 0:Mt.length)||0;if(He<=0)return;const Ne=`s${Ee.id}`,Qe=((Nt=X[Ne])==null?void 0:Nt.name)||`Skill ${Ee.id}`,Je=(wt=X[Ne])==null?void 0:wt.icon;ke.skillTotals[Ne]=(ke.skillTotals[Ne]||0)+He,ge.set(Ne,(ge.get(Ne)||0)+He),P.set(Ne,Qe),Je&&!ae.has(Ne)&&ae.set(Ne,Je),te.skillEntries[Ne]||(te.skillEntries[Ne]={name:Qe,icon:Je,players:{}}),!te.skillEntries[Ne].icon&&Je&&(te.skillEntries[Ne].icon=Je),te.skillEntries[Ne].players[be]=(te.skillEntries[Ne].players[be]||0)+He})}),M.push(te)});const S=Array.from(ge.entries()).map(([Y,Q])=>({id:Y,name:P.get(Y)||Y,total:Q,icon:ae.get(Y)})).sort((Y,Q)=>Q.total-Y.total);return{logRecords:M,players:Array.from(le.values()),skillOptions:S,resUtilitySkills:[]}})();return{validLogs:I,stats:Le,skillUsageData:qe}};let Ke=null,ct=!1,nn=null,on=0,sn=0,$t=null;const an=o=>{if(!o||typeof o!="object")return o;const s=(C,w)=>{const I={};return w.forEach(ie=>{C&&Object.prototype.hasOwnProperty.call(C,ie)&&(I[ie]=C[ie])}),I},c=s(o,["players","targets","durationMS","uploadTime","timeStart","timeStartStd","timeEnd","timeEndStd","fightName","success","teamCounts","combatReplayMetaData","skillMap","buffMap","encounterDuration","player_damage_mitigation","player_minion_damage_mitigation","playerDamageMitigation","playerMinionDamageMitigation"]);return Array.isArray(c.players)&&(c.players=c.players.map(C=>s(C,["name","display_name","character_name","profession","elite_spec","group","dpsAll","statsAll","dpsTargets","statsTargets","defenses","support","rotation","extHealingStats","extBarrierStats","squadBuffVolumes","selfBuffs","groupBuffs","squadBuffs","selfBuffsActive","groupBuffsActive","squadBuffsActive","buffUptimes","totalDamageDist","targetDamageDist","damage1S","targetDamage1S","totalDamageTaken","totalDamageTakenDist","minions","combatReplayData","hasCommanderTag","notInSquad","account","activeTimes"]))),Array.isArray(c.targets)&&(c.targets=c.targets.map(C=>s(C,["id","name","isFake","dpsAll","statsAll","defenses","totalHealth","healthPercentBurned","enemyPlayer","totalDamageDist"]))),c},po=o=>{if(!o||typeof o!="object")return o;const s={...o};return o.details?s.details=an(o.details):s.details=an(o),s},rn=()=>{if(!ct||!Ke)return;ct=!1,on+=1;const o=$t;$t=null;const s=go(Ke);self.postMessage({type:"result",result:s,computeId:on,logCount:Ke.logs.length,token:sn,completedAt:Date.now(),flushId:o})},Ot=()=>{nn===null&&(nn=setInterval(()=>{rn()},5e3))};self.onmessage=o=>{var c,C,w,I;const s=o.data;if((s==null?void 0:s.type)==="reset"){Ke={logs:[]},typeof s.token=="number"&&(sn=s.token),ct=!0,Ot();return}if((s==null?void 0:s.type)==="settings"){Ke={logs:(Ke==null?void 0:Ke.logs)||[],precomputedStats:(c=s.payload)==null?void 0:c.precomputedStats,mvpWeights:(C=s.payload)==null?void 0:C.mvpWeights,statsViewSettings:(w=s.payload)==null?void 0:w.statsViewSettings,disruptionMethod:(I=s.payload)==null?void 0:I.disruptionMethod},ct=!0,Ot();return}if((s==null?void 0:s.type)==="log"){Ke||(Ke={logs:[]}),Ke.logs.push(po(s.payload)),ct=!0,Ot();return}(s==null?void 0:s.type)==="flush"&&(typeof s.flushId=="number"&&($t=s.flushId),ct=!0,rn())}})();
