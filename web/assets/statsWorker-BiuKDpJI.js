(function(){"use strict";const Zt=["selfBuffs","groupBuffs","squadBuffs"],yt=n=>n!=null&&n.classification?n.classification==="Boon":!0,en=n=>`b${n}`,Hn=(n,r)=>{const h=Array.isArray(n==null?void 0:n.activeTimes)?n.activeTimes:[],O=typeof h[0]=="number"?h[0]:0;return O>0?O:r},tn=(n,r,h,O,z,I,pe)=>{const Z=n==="selfBuffs"?1:Math.max(n==="groupBuffs"?I-1:pe-1,0);return!Z||!z?{generationMs:0,wastedMs:0}:r?{generationMs:h*z*Z,wastedMs:O*z*Z}:{generationMs:h/100*z*Z,wastedMs:O/100*z*Z}},jn=n=>{const r=new Map,h=new Map;return n.forEach(I=>{const pe=I.details;if(!pe)return;const Z=pe.durationMS||0,ae=pe.buffMap||{};Object.entries(ae).forEach(([J,ie])=>{if(!r.has(J)){r.set(J,ie);return}const de=r.get(J)||{},oe={name:de.name||ie.name,stacking:de.stacking??ie.stacking,icon:de.icon||ie.icon,classification:de.classification||ie.classification};r.set(J,oe)});const Ve=(pe.players||[]).filter(J=>!J.notInSquad),je=Ve.length,Re=new Map;Ve.forEach(J=>{const ie=J.group??0;Re.set(ie,(Re.get(ie)||0)+1)}),Ve.forEach(J=>{const ie=J.account||J.name||J.character_name||"Unknown",de=J.profession||"Unknown",oe=J.group??0,we=Re.get(oe)||1,Ie=Hn(J,Z);h.has(ie)||h.set(ie,{account:ie,profession:de,professions:new Set,professionTimeMs:{},activeTimeMs:0,numFights:0,groupSupported:0,squadSupported:0,boons:{}});const re=h.get(ie);re.profession=de,de!=="Unknown"&&(re.professions.add(de),re.professionTimeMs[de]=(re.professionTimeMs[de]||0)+Ie),re.activeTimeMs+=Ie,re.numFights+=1,re.groupSupported+=we,re.squadSupported+=je,Zt.forEach(De=>{(J[De]||[]).forEach(k=>{var Ce,Oe,We,Ge;if(typeof(k==null?void 0:k.id)!="number")return;const ce=en(k.id),fe=ae[ce];if(!yt(fe))return;const Ne=(fe==null?void 0:fe.stacking)??!1,Se=((Oe=(Ce=k.buffData)==null?void 0:Ce[0])==null?void 0:Oe.generation)??0,me=((Ge=(We=k.buffData)==null?void 0:We[0])==null?void 0:Ge.wasted)??0,{generationMs:_e,wastedMs:ge}=tn(De,Ne,Se,me,Z,we,je);!_e&&!ge||(r.has(ce)||r.set(ce,fe||{}),re.boons[ce]||(re.boons[ce]={selfBuffs:{generationMs:0,wastedMs:0},groupBuffs:{generationMs:0,wastedMs:0},squadBuffs:{generationMs:0,wastedMs:0}}),re.boons[ce][De].generationMs+=_e,re.boons[ce][De].wastedMs+=ge)})})})}),{boonTables:Array.from(r.keys()).filter(I=>yt(r.get(I))).map(I=>{const pe=r.get(I)||{},Z=[];return h.forEach(ae=>{var J;const he=ae.boons[I];if(!he||!Zt.some(ie=>he[ie].generationMs>0||he[ie].wastedMs>0))return;const je=Array.from(ae.professions||[]).filter(ie=>ie&&ie!=="Unknown");let Re=ae.profession;if(je.length>0){Re=je[0];let ie=((J=ae.professionTimeMs)==null?void 0:J[Re])||0;je.forEach(de=>{var we;const oe=((we=ae.professionTimeMs)==null?void 0:we[de])||0;oe>ie&&(ie=oe,Re=de)})}Z.push({account:ae.account,profession:Re||"Unknown",professionList:je,activeTimeMs:ae.activeTimeMs||1,numFights:ae.numFights||1,groupSupported:ae.groupSupported||1,squadSupported:ae.squadSupported||1,categories:{selfBuffs:{...he.selfBuffs},groupBuffs:{...he.groupBuffs},squadBuffs:{...he.squadBuffs}}})}),{id:I,name:pe.name||I,icon:pe.icon,stacking:pe.stacking??!1,rows:Z}}).filter(I=>I.rows.length>0)}},$t=(n,r,h,O,z,I,pe={})=>{var J,ie,de,oe;const ae=((n==null?void 0:n[r])||[]).find(we=>we.id===h);if(!ae)return{generationMs:0,wastedMs:0};const he=pe[en(h)],Ve=(he==null?void 0:he.stacking)??!1,je=((ie=(J=ae.buffData)==null?void 0:J[0])==null?void 0:ie.generation)??0,Re=((oe=(de=ae.buffData)==null?void 0:de[0])==null?void 0:oe.wasted)??0;return tn(r,Ve,je,Re,O,z,I)};var Wn={methods:{tiered:{tiers:{shortMs:500,mediumMs:1500,weights:{short:.5,medium:1,long:2}}}}};const zn=Wn,Ot="count",Vn=n=>(n||0)/1e3,Kn=(n,r)=>{var z;if(!n)return 0;const h=(z=zn.methods.tiered)==null?void 0:z.tiers;if(!h)return n;const O=r/Math.max(n,1);return O<=h.shortMs?n*h.weights.short:O<=h.mediumMs?n*h.weights.medium:n*h.weights.long},nn=(n,r,h)=>h==="duration"?Vn(r):h==="tiered"?Kn(n,r):n;function Gn(n,r=Ot){var I;const h=(I=n.statsAll)==null?void 0:I[0],O=Number((h==null?void 0:h.appliedCrowdControl)??0),z=Number((h==null?void 0:h.appliedCrowdControlDuration)??0);return nn(O,z,r)}function Jn(n,r){const h=(r==null?void 0:r.durationMS)||0,O=(r==null?void 0:r.buffMap)||{},z=n.filter(Z=>!Z.notInSquad),I=z.length,pe=new Map;z.forEach(Z=>{const ae=Z.group??0;pe.set(ae,(pe.get(ae)||0)+1)}),z.forEach(Z=>{const ae=pe.get(Z.group??0)||1,he=$t(Z,"selfBuffs",1122,h,ae,I,O),Ve=$t(Z,"squadBuffs",1122,h,ae,I,O);Z.stabGeneration=(he.generationMs+Ve.generationMs)/1e3})}function Yn(n){if(!n.statsTargets)return 0;let r=0;for(const h of n.statsTargets)h&&h.length>0&&(r+=h[0].downContribution||0);return r}function Qn(n){if(!n.extBarrierStats||!n.extBarrierStats.outgoingBarrierAllies)return 0;let r=0;for(const h of n.extBarrierStats.outgoingBarrierAllies)if(h)for(const O of h)O&&(r+=O.barrier||0);return r}function Xn(n){if(!n.extHealingStats||!n.extHealingStats.outgoingHealingAllies)return 0;let r=0;for(const h of n.extHealingStats.outgoingHealingAllies)if(h)for(const O of h)O&&(r+=O.healing||0);return r}const sn=n=>{var r,h,O,z;return(((h=(r=n.support)==null?void 0:r[0])==null?void 0:h.condiCleanse)||0)+(((z=(O=n.support)==null?void 0:O[0])==null?void 0:z.condiCleanseSelf)||0)},on=(n,r=Ot)=>{var I;const h=(I=n.support)==null?void 0:I[0],O=Number((h==null?void 0:h.boonStrips)??0),z=Number((h==null?void 0:h.boonStripsTime)??0);return nn(O,z,r)},an=n=>Yn(n),rn=n=>Xn(n),cn=n=>Qn(n),un=(n,r=Ot)=>Gn(n,r),Zn=(n,r)=>Jn(n,r),yn="count",ei={downContribution:1,healing:1,cleanses:1,strips:1,stability:1,cc:.7,revives:.7,distanceToTag:.7,participation:.7,dodging:.4,dps:.2,damage:.2},ti={showMvp:!0,topSkillDamageSource:"target",topSkillsMetric:"damage"},mn=new Map([["bleeding","Bleeding"],["burning","Burning"],["confusion","Confusion"],["poison","Poison"],["torment","Torment"],["vulnerability","Vulnerability"],["weakness","Weakness"],["weakened","Weakness"],["blind","Blind"],["blinded","Blind"],["blinding","Blind"],["cripple","Cripple"],["crippled","Cripple"],["chill","Chill"],["chilled","Chill"],["immob","Immobilize"],["immobile","Immobilize"],["immobilized","Immobilize"],["slow","Slow"],["slowed","Slow"],["fear","Fear"],["feared","Fear"],["taunt","Taunt"],["taunted","Taunt"]]),ni={Blind:"https://render.guildwars2.com/file/09770136BB76FD0DBE1CC4267DEED54774CB20F6/102837.png",Chill:"https://render.guildwars2.com/file/28C4EC547A3516AF0242E826772DA43A5EAC3DF3/102839.png",Cripple:"https://render.guildwars2.com/file/070325E519C178D502A8160523766070D30C0C19/102838.png",Fear:"https://render.guildwars2.com/file/30307A6E766D74B6EB09EDA12A4A2DE50E4D76F4/102869.png",Immobilize:"https://render.guildwars2.com/file/397A613651BFCA2832B6469CE34735580A2C120E/102844.png",Slow:"https://render.guildwars2.com/file/F60D1EF5271D7B9319610855676D320CD25F01C6/961397.png",Taunt:"https://render.guildwars2.com/file/02EED459AD65FAF7DF32A260E479C625070841B9/1228472.png",Vulnerability:"https://render.guildwars2.com/file/3A394C1A0A3257EB27A44842DDEEF0DF000E1241/102850.png",Weakness:"https://render.guildwars2.com/file/6CB0E64AF9AA292E332A38C1770CE577E2CDE0E8/102853.png"},pt=n=>{if(!n)return null;const r=n.trim().toLowerCase(),h=mn.get(r);if(h)return h;const O=r.split(/[^a-z]+/).filter(Boolean);for(const z of O){const I=mn.get(z);if(I)return I}return null},ii=n=>pt(n),ln=n=>{const r=new Map;return n&&(Object.values(n).forEach(h=>{if(!(h!=null&&h.icon)||!(h!=null&&h.name))return;const O=pt(h.name);O&&(r.has(O)||r.set(O,h.icon))}),Object.entries(ni).forEach(([h,O])=>{r.has(h)||r.set(h,O)})),r},wt=(n,r,h)=>{var O;if(r&&h){const z=(O=h[`b${r}`])==null?void 0:O.name,I=pt(z);if(I)return I}return n?pt(n):null},si=n=>{const r=(n==null?void 0:n.account)||"Unknown";return r&&r!=="Unknown"?r:(n==null?void 0:n.name)||"Unknown"||null},oi=n=>{if(!n||n.length===0)return 0;let r=0,h=null;return n.forEach(O=>{const z=Number(O[1]??0);if(Number.isFinite(z)){if(h===null){h=z;return}z>h&&(r+=z-h),h=z}}),r},ai=n=>{if(!n||n.length===0)return 0;let r=0;return n.forEach(h=>{const O=Number(h[0]??0),z=Number(h[1]??0);Number.isFinite(z)&&O!==0&&z>0&&(r+=1)}),r},ri=n=>{const{players:r,targets:h,skillMap:O,buffMap:z}=n,I=n.getPlayerKey||si,pe=ln(z),Z={},ae={};r.forEach(J=>{if(J!=null&&J.notInSquad)return;const ie=I(J);ie&&(Z[ie]||(Z[ie]={}),J!=null&&J.totalDamageDist&&J.totalDamageDist.forEach(de=>{de&&de.forEach(oe=>{if(!oe.id)return;let we=`Skill ${oe.id}`,Ie;O&&(O[`s${oe.id}`]?(we=O[`s${oe.id}`].name||we,Ie=O[`s${oe.id}`].icon||Ie):O[`${oe.id}`]&&(we=O[`${oe.id}`].name||we,Ie=O[`${oe.id}`].icon||Ie));const re=wt(we,oe.id,z);if(!re)return;const De=z==null?void 0:z[`b${oe.id}`],Qe=De==null?void 0:De.name,k=pe.get(re)||(De==null?void 0:De.icon),ce=we.startsWith("Skill ")?Qe||re:we,fe=Ie||(De==null?void 0:De.icon),Ne=Number(oe.connectedHits??0),Se=Number(oe.hits??0),me=Ne>0?Ne:Se,_e=Number(oe.totalDamage??0);if(!Number.isFinite(me)&&!Number.isFinite(_e))return;const ge=ae[re]||{name:re,icon:k,applications:0,damage:0};ge.applications+=Number.isFinite(me)?me:0,ge.damage+=Number.isFinite(_e)?_e:0,!ge.icon&&k&&(ge.icon=k),ae[re]=ge;const Ce=Z[ie][re]||{icon:k,applications:0,damage:0,skills:{}};Ce.applications+=Number.isFinite(me)?me:0,Ce.damage+=Number.isFinite(_e)?_e:0;const Oe=Ce.skills[ce]||{name:ce,hits:0,damage:0,icon:fe};Oe.hits+=Number.isFinite(me)?me:0,Oe.damage+=Number.isFinite(_e)?_e:0,!Oe.icon&&fe&&(Oe.icon=fe),Ce.skills[ce]=Oe,!Ce.icon&&k&&(Ce.icon=k),Z[ie][re]=Ce})}))});const he=new Map;r.forEach(J=>{if(J!=null&&J.notInSquad)return;const ie=I(J);ie&&J!=null&&J.name&&he.set(J.name,ie)});let Ve=0,je=0,Re=0;return h.forEach(J=>{J!=null&&J.buffs&&J.buffs.forEach(ie=>{const de=Number(ie==null?void 0:ie.id);if(!Number.isFinite(de))return;const oe=z==null?void 0:z[`b${de}`],we=pt(oe==null?void 0:oe.name);if(!we||oe!=null&&oe.classification&&oe.classification!=="Condition")return;const Ie=we;if(!Ie)return;const re=ie.statesPerSource||{};Re+=1,Object.entries(re).forEach(([De,Qe])=>{var me;const k=he.get(De);if(!k)return;je+=1;const ce=oi(Qe),fe=ai(Qe);Ve+=ce;const Ne=((me=Z[k])==null?void 0:me[Ie])||{applications:0,damage:0,skills:{}};Ne.applicationsFromBuffs=(Ne.applicationsFromBuffs||0)+ce,Ne.applicationsFromBuffsActive=(Ne.applicationsFromBuffsActive||0)+fe,Z[k]=Z[k]||{},Z[k][Ie]=Ne;const Se=ae[Ie]||{name:Ie,applications:0,damage:0};Se.applicationsFromBuffs=(Se.applicationsFromBuffs||0)+ce,Se.applicationsFromBuffsActive=(Se.applicationsFromBuffsActive||0)+fe,ae[Ie]=Se})})}),Object.values(Z).forEach(J=>{Object.values(J).forEach(ie=>{typeof ie.applicationsFromBuffs=="number"&&(ie.applications=ie.applicationsFromBuffs)})}),Object.values(ae).forEach(J=>{typeof J.applicationsFromBuffs=="number"&&(J.applications=J.applicationsFromBuffs)}),{playerConditions:Z,summary:ae,meta:{buffStateApplicationsTotal:Ve,targetBuffEntriesSeen:Re,buffStateSourcesSeen:je}}},ci=new Set(["Vulnerability","Weakness","Blind","Cripple","Chill","Immobilize","Slow","Fear","Taunt"]),ui=[{id:"damage",label:"Damage",field:"damage",source:"dpsAll"},{id:"directDmg",label:"Direct Damage",field:"directDmg",source:"statsTargets"},{id:"connectedDamageCount",label:"Connected Damage Count",field:"connectedDamageCount",source:"statsTargets"},{id:"connectedDirectDamageCount",label:"Connected Direct Damage Count",field:"connectedDirectDamageCount",source:"statsTargets"},{id:"battleStandardHits",label:"Battle Standard Tracking"},{id:"criticalRate",label:"Critical Rate",field:"criticalRate",isRate:!0,isPercent:!0,denomField:"critableDirectDamageCount",source:"statsTargets"},{id:"criticalDmg",label:"Critical Damage",field:"criticalDmg",source:"statsTargets"},{id:"flankingRate",label:"Flanking Rate",field:"flankingRate",isRate:!0,isPercent:!0,denomField:"connectedDirectDamageCount",source:"statsTargets"},{id:"glanceRate",label:"Glance Rate",field:"glanceRate",isRate:!0,isPercent:!0,denomField:"connectedDirectDamageCount",source:"statsTargets"},{id:"missed",label:"Missed",field:"missed",source:"statsTargets"},{id:"evaded",label:"Evaded (enemy)",field:"evaded",source:"statsTargets"},{id:"blocked",label:"Blocked (enemy)",field:"blocked",source:"statsTargets"},{id:"interrupts",label:"Interrupts",field:"interrupts",source:"statsTargets"},{id:"invulned",label:"Invulned",field:"invulned",source:"statsTargets"},{id:"killed",label:"Killed",field:"killed",source:"statsTargets"},{id:"downed",label:"Downed",field:"downed",source:"statsTargets"},{id:"downContribution",label:"Down Contribution",field:"downContribution",source:"statsTargets"},{id:"downContributionPercent",label:"Down Contribution %",isRate:!0,isPercent:!0},{id:"againstDownedDamage",label:"Against Downed Damage",field:"againstDownedDamage",source:"statsTargets"},{id:"appliedCrowdControl",label:"Applied CC",field:"appliedCrowdControl",source:"statsTargets"},{id:"appliedCrowdControlDuration",label:"Applied CC Duration",field:"appliedCrowdControlDuration",source:"statsTargets"},{id:"appliedCrowdControlDownContribution",label:"Applied CC Down Contribution",field:"appliedCrowdControlDownContribution",source:"statsTargets"},{id:"appliedCrowdControlDurationDownContribution",label:"Applied CC Duration Down Contribution",field:"appliedCrowdControlDurationDownContribution",source:"statsTargets"},{id:"boonStrips",label:"Boon Strips",field:"boonStrips",source:"support"}],mi=[{id:"damageTaken",label:"Damage Taken",field:"damageTaken"},{id:"minionDamageTaken",label:"Minion Damage Taken"},{id:"damageTakenCount",label:"Damage Taken Count",field:"damageTakenCount"},{id:"conditionDamageTaken",label:"Condition Damage Taken",field:"conditionDamageTaken"},{id:"conditionDamageTakenCount",label:"Condition Damage Taken Count",field:"conditionDamageTakenCount"},{id:"powerDamageTaken",label:"Power Damage Taken",field:"powerDamageTaken"},{id:"powerDamageTakenCount",label:"Power Damage Taken Count",field:"powerDamageTakenCount"},{id:"downedDamageTaken",label:"Downed Damage Taken",field:"downedDamageTaken"},{id:"downedDamageTakenCount",label:"Downed Damage Taken Count",field:"downedDamageTakenCount"},{id:"damageBarrier",label:"Damage Barrier",field:"damageBarrier"},{id:"damageBarrierCount",label:"Damage Barrier Count",field:"damageBarrierCount"},{id:"blockedCount",label:"Blocked Count",field:"blockedCount"},{id:"evadedCount",label:"Evaded Count",field:"evadedCount"},{id:"missedCount",label:"Missed Count",field:"missedCount"},{id:"dodgeCount",label:"Dodge Count",field:"dodgeCount"},{id:"invulnedCount",label:"Invulnerable Count",field:"invulnedCount"},{id:"interruptedCount",label:"Interrupted Count",field:"interruptedCount"},{id:"downCount",label:"Down Count",field:"downCount"},{id:"deadCount",label:"Death Count",field:"deadCount"},{id:"boonStrips",label:"Boon Strips (Incoming)",field:"boonStrips"},{id:"conditionCleanses",label:"Cleanses (Incoming)",field:"conditionCleanses"},{id:"receivedCrowdControl",label:"Crowd Control (Incoming)",field:"receivedCrowdControl"}],li=[{id:"condiCleanse",label:"Condition Cleanses",field:"condiCleanse"},{id:"condiCleanseTime",label:"Condition Cleanse Time",field:"condiCleanseTime",isTime:!0},{id:"condiCleanseSelf",label:"Condition Cleanse Self",field:"condiCleanseSelf"},{id:"condiCleanseTimeSelf",label:"Condition Cleanse Time Self",field:"condiCleanseTimeSelf",isTime:!0},{id:"boonStrips",label:"Boon Strips",field:"boonStrips"},{id:"boonStripsTime",label:"Boon Strips Time",field:"boonStripsTime",isTime:!0},{id:"boonStripDownContribution",label:"Boon Strip Down Contribution",field:"boonStripDownContribution"},{id:"boonStripDownContributionTime",label:"Boon Strip Down Contribution Time",field:"boonStripDownContributionTime",isTime:!0},{id:"stunBreak",label:"Stun Breaks",field:"stunBreak"},{id:"removedStunDuration",label:"Removed Stun Duration",field:"removedStunDuration",isTime:!0},{id:"resurrects",label:"Resurrects",field:"resurrects"},{id:"resurrectTime",label:"Resurrect Time",field:"resurrectTime",isTime:!0}],fi=["battle standard","glyph of renewal","glyph of the stars","illusion of life","spirit of nature","nature spirit","search and rescue","signet of mercy"],di=new Set([10244]),gi=(n,r)=>{var z;if(di.has(n))return!0;const h=(r==null?void 0:r[`s${n}`])||(r==null?void 0:r[`${n}`]),O=((z=h==null?void 0:h.name)==null?void 0:z.toLowerCase())||"";return fi.some(I=>O.includes(I))},Tt=n=>{if(!n||!Number.isFinite(n))return"--:--";const r=Math.max(0,Math.round(n/1e3)),h=Math.floor(r/3600),O=Math.floor(r%3600/60),z=r%60;return h>0?`${h}:${String(O).padStart(2,"0")}:${String(z).padStart(2,"0")}`:`${O}:${String(z).padStart(2,"0")}`},Ft={Guardian:"#72C1D9",Dragonhunter:"#72C1D9",Firebrand:"#72C1D9",Willbender:"#72C1D9",Revenant:"#D16E5A",Herald:"#D16E5A",Renegade:"#D16E5A",Vindicator:"#D16E5A",Warrior:"#FFD166",Berserker:"#FFD166",Spellbreaker:"#FFD166",Bladesworn:"#FFD166",Engineer:"#D09C59",Scrapper:"#D09C59",Holosmith:"#D09C59",Mechanist:"#D09C59",Ranger:"#8CDC82",Druid:"#8CDC82",Soulbeast:"#8CDC82",Untamed:"#8CDC82",Thief:"#C08F95",Daredevil:"#C08F95",Deadeye:"#C08F95",Specter:"#C08F95",Elementalist:"#F68A87",Tempest:"#F68A87",Weaver:"#F68A87",Catalyst:"#F68A87",Mesmer:"#B679D5",Chronomancer:"#B679D5",Mirage:"#B679D5",Virtuoso:"#B679D5",Necromancer:"#52A76F",Reaper:"#52A76F",Scourge:"#52A76F",Harbinger:"#52A76F",Ritualist:"#52A76F",Luminary:"#72C1D9",Conduit:"#D16E5A",Paragon:"#FFD166",Amalgam:"#D09C59",Galeshot:"#8CDC82",Antiquary:"#C08F95",Evoker:"#F68A87",Troubadour:"#B679D5",Unknown:"#64748B"};function fn(n){return Ft[n]||Ft.Unknown}const bi=n=>{if(n==null||n==="")return 0;if(typeof n=="number")return!Number.isFinite(n)||n<=0?0:n>1e12?n:n*1e3;if(n instanceof Date){const pe=n.getTime();return Number.isFinite(pe)&&pe>0?pe:0}const r=String(n).trim();if(!r)return 0;const h=Number(r);if(Number.isFinite(h)&&h>0)return h>1e12?h:h*1e3;const O=Date.parse(r);if(Number.isFinite(O)&&O>0)return O;const z=r.replace(/([+-]\d{2})$/,"$1:00"),I=Date.parse(z);return Number.isFinite(I)&&I>0?I:0},ze=(n,r)=>bi((n==null?void 0:n.uploadTime)??(r==null?void 0:r.uploadTime)??(n==null?void 0:n.timeStartStd)??(n==null?void 0:n.timeStart)??(n==null?void 0:n.timeEndStd)??(n==null?void 0:n.timeEnd)??(n==null?void 0:n.timeStartText)??(n==null?void 0:n.timeEndText)),pi=({logs:n,precomputedStats:r,mvpWeights:h,statsViewSettings:O,disruptionMethod:z,includePlayerSkillMap:I})=>{const pe=J=>{var de;return(Array.isArray((de=J==null?void 0:J.details)==null?void 0:de.players)?J.details.players:[]).length>0},Z=n.filter(J=>pe(J)),ae=O||ti,he=h||ei,Ve=J=>{if(!J||typeof J!="object")return J;const ie=Array.isArray(J.fightBreakdown)?J.fightBreakdown:null;if(!ie||ie.length===0)return J;const de=k=>Array.isArray(k)&&k.some(ce=>ce&&Number(ce.count)>0),oe=new Map,we=new Map;n.forEach(k=>{var Ne;const ce=(k==null?void 0:k.filePath)||(k==null?void 0:k.id);ce&&oe.set(String(ce),k);const fe=(k==null?void 0:k.permalink)||((Ne=k==null?void 0:k.details)==null?void 0:Ne.permalink);typeof fe=="string"&&fe.trim()&&we.set(fe.trim(),k)});const Ie=ie.map(k=>{var _e;if(!k||typeof k!="object")return k;const ce=k.id?String(k.id):"",fe=typeof k.permalink=="string"?k.permalink.trim():"",Ne=(ce?oe.get(ce):void 0)||(fe?we.get(fe):void 0);if(!Ne)return k;let Se=k;if(Number(k.timestamp)<=0){const ge=ze(Ne==null?void 0:Ne.details,Ne);ge&&(Se={...Se,timestamp:ge})}const me=(_e=Ne==null?void 0:Ne.details)==null?void 0:_e.teamBreakdown;return de(me)&&(Se={...Se,teamBreakdown:me}),Se}),re=Array.isArray(J.fightDiffMode)?J.fightDiffMode:[],Qe=re.some(k=>Array.isArray(k==null?void 0:k.targetFocus)&&k.targetFocus.some(ce=>Number((ce==null?void 0:ce.damage)||0)>0||Number((ce==null?void 0:ce.hits)||0)>0))?re:Ie.map((k,ce)=>{const fe=k&&typeof k.enemyClassCounts=="object"&&k.enemyClassCounts?k.enemyClassCounts:{},Ne=Object.entries(fe).map(([He,Ke])=>({label:String(He||"Unknown"),count:Number(Ke||0)})).filter(He=>He.count>0).sort((He,Ke)=>Ke.count-He.count||He.label.localeCompare(Ke.label)),Se=Ne.reduce((He,Ke)=>He+Ke.count,0),me=Ne.map(He=>({label:He.label,damage:He.count,hits:0,share:Se>0?He.count/Se:0})),_e=Number((k==null?void 0:k.enemyDowns)||0),ge=Number((k==null?void 0:k.enemyDeaths)||0),Ce=Number((k==null?void 0:k.alliesDown)||0),Oe=Number((k==null?void 0:k.alliesDead)||0),We=Number((k==null?void 0:k.totalOutgoingDamage)||0),Ge=Number((k==null?void 0:k.totalIncomingDamage)||0),Le=[{metricId:"winFlag",metricLabel:"Win (1) / Loss (0)",higherIsBetter:!0,value:k!=null&&k.isWin?1:0},{metricId:"squadCount",metricLabel:"Squad Size",higherIsBetter:!0,value:Number((k==null?void 0:k.squadCount)||0)},{metricId:"enemyCount",metricLabel:"Enemy Count",higherIsBetter:!1,value:Number((k==null?void 0:k.enemyCount)||0)},{metricId:"squadKdr",metricLabel:"Squad KDR",higherIsBetter:!0,value:Oe>0?ge/Oe:ge},{metricId:"enemyDeaths",metricLabel:"Enemy Deaths",higherIsBetter:!0,value:ge},{metricId:"enemyDowns",metricLabel:"Enemy Downs",higherIsBetter:!0,value:_e},{metricId:"squadDeaths",metricLabel:"Squad Deaths",higherIsBetter:!1,value:Oe},{metricId:"squadDowns",metricLabel:"Squad Downs",higherIsBetter:!1,value:Ce},{metricId:"damageDelta",metricLabel:"Damage Delta",higherIsBetter:!0,value:We-Ge},{metricId:"outgoingDamage",metricLabel:"Outgoing Damage",higherIsBetter:!0,value:We},{metricId:"incomingDamage",metricLabel:"Incoming Damage",higherIsBetter:!1,value:Ge},{metricId:"barrierIncomingAbsorb",metricLabel:"Barrier Absorption (Incoming)",higherIsBetter:!0,value:Number((k==null?void 0:k.incomingBarrierAbsorbed)||0)},{metricId:"enemyBarrierAbsorb",metricLabel:"Enemy Barrier Absorption",higherIsBetter:!1,value:Number((k==null?void 0:k.outgoingBarrierAbsorbed)||0)},{metricId:"alliesRevived",metricLabel:"Allies Revived (Players)",higherIsBetter:!0,value:Number((k==null?void 0:k.alliesRevived)||0)}];return{id:String((k==null?void 0:k.id)||`fight-${ce+1}`),shortLabel:`F${ce+1}`,fullLabel:`${String((k==null?void 0:k.mapName)||(k==null?void 0:k.label)||"Unknown Map")} • ${String((k==null?void 0:k.duration)||"--:--")}`,mapName:String((k==null?void 0:k.mapName)||""),timestamp:Number((k==null?void 0:k.timestamp)||0),duration:String((k==null?void 0:k.duration)||"--:--"),isWin:!!(k!=null&&k.isWin),targetFocus:me,squadMetrics:Le}});return{...J,fightBreakdown:Ie,fightDiffMode:Qe}},je=(()=>{if(r)return Ve(r);const J=z||yn,ie=ae.topSkillDamageSource||"target",de=ae.topSkillsMetric||"damage",oe=Z.length;let we=0,Ie=0,re=0,De=0,Qe=0,k=0,ce=0,fe=0;const Ne=e=>{const s=((e==null?void 0:e.players)||[]).filter(Y=>!Y.notInSquad);let M=0,a=0,L=0,D=0;return s.forEach(Y=>{var B;const K=(B=Y.defenses)==null?void 0:B[0];if(!K)return;const ee=Number(K.downCount||0),te=Number(K.deadCount||0);M+=ee+te,L+=te}),s.forEach(Y=>{!Y.statsTargets||Y.statsTargets.length===0||Y.statsTargets.forEach(K=>{const ee=K==null?void 0:K[0];if(!ee)return;const te=Number(ee.downed||0),B=Number(ee.killed||0);a+=te+B,D+=B})}),{squadDownsDeaths:M,enemyDownsDeaths:a,squadDeaths:L,enemyDeaths:D}},Se=e=>{const{squadDownsDeaths:t,enemyDownsDeaths:s}=Ne(e);return t>0||s>0?s>t:typeof(e==null?void 0:e.success)=="boolean"?e.success:!1},me=new Map,_e=new Set(["boonStripsTime","condiCleanseTime","condiCleanseTimeSelf"]),ge={},Ce={},Oe=new Map,We={},Ge={},Le={},He=new Map,Ke=new Map,vt=new Set(Object.keys(Ft)),It=Object.keys(Ft).filter(e=>e&&e!=="Unknown").sort((e,t)=>t.length-e.length),Lt=["Guardian","Revenant","Warrior","Engineer","Ranger","Thief","Elementalist","Mesmer","Necromancer"],tt=e=>{if(!e)return"Unknown";const t=String(e).replace(/\s*\([^)]*\)\s*$/,"").replace(/\s*\[[^\]]*\]\s*$/,"").replace(/\s\d+$/,"").trim();if(vt.has(t))return t;const s=t.toLowerCase();for(const a of It)if(s.includes(a.toLowerCase()))return a;return Lt.find(a=>s.includes(a.toLowerCase()))||t||"Unknown"},Ci=e=>e!=null&&e.classification?e.classification==="Boon":!0,xt=new Map,Pt=new Map,kt=()=>({totalHits:0,blocked:0,evaded:0,glanced:0,missed:0,invulned:0,interrupted:0,totalMitigation:0,minMitigation:0}),ve=e=>{const t=Number(e);return Number.isFinite(t)?t:0},kn=e=>{const t=String(e).split("|"),s=t[0]||"Unknown",M=tt(t[1]||"Unknown"),a=t[2]||s||"Unknown";return{name:s,profession:M,account:a}},Dn=(e,t,s)=>{let M=e.get(t);return M?s.profession&&!M.professionList.includes(s.profession)&&M.professionList.push(s.profession):(M={account:s.account,name:s.name,profession:s.profession,professionList:s.profession?[s.profession]:[],activeMs:0,mitigationTotals:kt()},e.set(t,M)),M},Nn=(e,t,s)=>{let M=e.get(t);return M?s.profession&&!M.professionList.includes(s.profession)&&M.professionList.push(s.profession):(M={account:s.account,name:s.name,profession:s.profession,professionList:s.profession?[s.profession]:[],activeMs:0,mitigationTotals:kt(),minion:s.minion},e.set(t,M)),M},Sn=(e,t)=>{e.totalHits+=ve((t==null?void 0:t.skill_hits)??(t==null?void 0:t.skillHits)),e.blocked+=ve(t==null?void 0:t.blocked),e.evaded+=ve(t==null?void 0:t.evaded),e.glanced+=ve(t==null?void 0:t.glanced),e.missed+=ve(t==null?void 0:t.missed),e.invulned+=ve(t==null?void 0:t.invulned),e.interrupted+=ve(t==null?void 0:t.interrupted),e.totalMitigation+=ve((t==null?void 0:t.avoided_damage)??(t==null?void 0:t.avoidedDamage)),e.minMitigation+=ve((t==null?void 0:t.min_avoided_damage)??(t==null?void 0:t.minAvoidedDamage))},Ai=e=>Object.values(e).some(t=>t>0),Wt=new Map,Mi=e=>{const t=Wt.get(e);if(!t)return{hasSkill:!1,avg:1,min:1,hits:0};const s=t.connectedHits||0,M=s>0?t.totalDamage/s:0,a=t.minCount>0?t.minTotal/t.minCount:0;return{hasSkill:!0,avg:M,min:a,hits:s}},Cn=new Map,An=new Map,Mn=(e,t,s)=>{const M=e.get(t)||kt();return M.totalHits+=s.totalHits,M.blocked+=s.blocked,M.evaded+=s.evaded,M.glanced+=s.glanced,M.missed+=s.missed,M.invulned+=s.invulned,M.interrupted+=s.interrupted,e.set(t,M),M};Z.forEach(e=>{const t=e.details;if(!t)return;(t.targets||[]).forEach(M=>{const a=(M==null?void 0:M.totalDamageDist)||[],L=Array.isArray(a)?a[0]:null;L==null||L.forEach(D=>{if(!(D!=null&&D.id))return;const Y=Number(D.id),K=Wt.get(Y)||{totalDamage:0,connectedHits:0,minTotal:0,minCount:0};K.totalDamage+=Number(D.totalDamage||0),K.connectedHits+=Number(D.connectedHits||0);const ee=Number.isFinite(Number(D.min))?Number(D.min):0;K.minTotal+=ee,K.minCount+=1,Wt.set(Y,K)})})}),Z.forEach(e=>{var q,j;const t=e.details;if(!t)return;const s=t.players,M=t.targets||[],a=t.combatReplayMetaData||{},L=(a==null?void 0:a.inchToPixel)>0?a.inchToPixel:1,D=(a==null?void 0:a.pollingRate)>0?a.pollingRate:1,Y=5e3,K=o=>Array.isArray(o)?o.map(c=>Array.isArray(c)?[Number(c[0]),Number(c[1])]:null).filter(c=>!!c&&Number.isFinite(c[0])):[];let ee=[],te=t.durationMS||0,B=!1;const N=s.find(o=>(o==null?void 0:o.hasCommanderTag)&&!(o!=null&&o.notInSquad));(q=N==null?void 0:N.combatReplayData)!=null&&q.positions&&(ee=N.combatReplayData.positions,K(N.combatReplayData.dead).forEach(([c])=>{c>0&&(B=!0,te=Math.min(te,c))}));const H=o=>{var p;const c=(p=o.statsAll)==null?void 0:p[0];if((c==null?void 0:c.distToCom)!==void 0&&(c==null?void 0:c.distToCom)!=="Infinity")return Math.round(Number(c.distToCom));if((c==null?void 0:c.stackDist)!==void 0)return Math.round(Number(c.stackDist))||0;if(o.hasCommanderTag)return 0;const _=o.combatReplayData;if(!(_!=null&&_.positions)||!ee.length)return 0;const Q=_.positions,m=K(_.dead),i=K(_.down),ne=Math.floor((_.start||0)/D);let l=0;if(m.length&&i.length)for(const[R]of m){if(R<0)continue;const G=Math.max(0,Math.floor(R/D))-ne;for(const[P,A]of i){if(R!==A)continue;const $=B&&P>te?Math.max(1,Math.floor(te/D)):G,W=Math.max(0,Math.min($,Q.length,ee.length));if(W<=0)continue;let y=0;for(let se=0;se<W;se++){const[le,ke]=Q[se],[Ae,xe]=ee[se];y+=Math.hypot(le-Ae,ke-xe)}l=Math.round(y/W/L)}}return l},d=s.filter(o=>!o.notInSquad);re+=d.length,De+=M.filter(o=>!o.isFake).length,Zn(s,{durationMS:t.durationMS,buffMap:t.buffMap});const{squadDeaths:x,enemyDeaths:U}=Ne(t);Qe+=x,k+=U,fe+=x,ce+=U,Se(t)?we++:Ie++;const f=t.skillMap?Number((j=Object.keys(t.skillMap).find(o=>{var c,_;return((_=(c=t.skillMap)==null?void 0:c[o])==null?void 0:_.name)==="Battle Standard"}))==null?void 0:j.replace(/^s/,"")):null;s.forEach((o,c)=>{var Xe,Ue,Je,lt,ut,_t,ft,mt,dt,Qt,gt,Dt,Ut;if(o.notInSquad)return;const _=o.account||"Unknown",Q=_!=="Unknown"?_:o.name||"Unknown",m=o.name||"Unknown";me.has(Q)||me.set(Q,{name:m,account:Q,characterNames:new Set,downContrib:0,cleanses:0,strips:0,stab:0,healing:0,barrier:0,cc:0,logsJoined:0,totalDist:0,distCount:0,dodges:0,downs:0,deaths:0,totalFightMs:0,offenseTotals:{},offenseRateWeights:{},defenseActiveMs:0,defenseTotals:{},defenseMinionDamageTaken:{},supportActiveMs:0,supportTotals:{},healingActiveMs:0,healingTotals:{},profession:o.profession||"Unknown",professions:new Set,professionTimeMs:{},squadActiveMs:0,firstSeenFightTs:0,lastSeenFightTs:0,lastSeenFightDurationMs:0,isCommander:!1,damage:0,dps:0,revives:0,outgoingConditions:{},incomingConditions:{}});const i=me.get(Q);if(o.hasCommanderTag&&(i.isCommander=!0),m!=="Unknown"&&i.characterNames.add(String(m)),o.profession&&o.profession!=="Unknown"){i.profession=o.profession,i.professions.add(o.profession);const E=Array.isArray(o.activeTimes)&&typeof o.activeTimes[0]=="number"?o.activeTimes[0]:t.durationMS||0;i.professionTimeMs[o.profession]=(i.professionTimeMs[o.profession]||0)+E}i.logsJoined++,i.downContrib+=an(o),i.cleanses+=sn(o),i.strips+=on(o,J),i.healing+=rn(o),i.barrier+=cn(o),i.cc+=un(o,J),i.stab+=o.stabGeneration||0;const ne=H(o);ne<=Y&&(i.totalDist+=ne,i.distCount++),(Xe=o.defenses)!=null&&Xe[0]&&(i.dodges+=o.defenses[0].dodgeCount||0,i.downs+=o.defenses[0].downCount||0,i.deaths+=o.defenses[0].deadCount||0),t.durationMS&&(i.totalFightMs+=t.durationMS);const l=Array.isArray(o.activeTimes)&&typeof o.activeTimes[0]=="number"?o.activeTimes[0]:t.durationMS||0;i.squadActiveMs+=l;const p=ze(t,e),R=Number((t==null?void 0:t.durationMS)||0);if(p>0&&((i.firstSeenFightTs<=0||p<i.firstSeenFightTs)&&(i.firstSeenFightTs=p),i.lastSeenFightTs<=0||p>i.lastSeenFightTs?(i.lastSeenFightTs=p,i.lastSeenFightDurationMs=R):p===i.lastSeenFightTs&&R>i.lastSeenFightDurationMs&&(i.lastSeenFightDurationMs=R)),i.defenseActiveMs+=l,i.supportActiveMs+=l,i.healingActiveMs+=l,Array.isArray(o.buffUptimes)&&o.buffUptimes.length>0&&o.buffUptimes.forEach(E=>{var qn,_n,Un,Rn,$n,On;if(typeof(E==null?void 0:E.id)!="number")return;const F=`b${E.id}`,g=((qn=t.buffMap)==null?void 0:qn[F])||((_n=t.buffMap)==null?void 0:_n[String(E.id)]);if(!g||Ci(g))return;const C=Number(((Rn=(Un=E.buffData)==null?void 0:Un[0])==null?void 0:Rn.uptime)??0),V=Number(((On=($n=E.buffData)==null?void 0:$n[0])==null?void 0:On.presence)??0);if((!Number.isFinite(C)||C<=0)&&(!Number.isFinite(V)||V<=0))return;const ue=(g==null?void 0:g.stacking)??!1,Fe=(ue?Number.isFinite(C)?C:0:Number.isFinite(C)?C/100:0)*l,Be=ue?V:C,Ye=Math.min(Math.max(Number.isFinite(Be)?Be:0,0),100)/100*l,et=Number.isFinite(Fe)&&Fe>0,Nt=Number.isFinite(Ye)&&Ye>0;if(!et&&!Nt)return;const it=ii(g==null?void 0:g.name);if(it&&ci.has(it)&&(!(g!=null&&g.classification)||g.classification==="Condition")){const Rt=Fe/1e3,st=g==null?void 0:g.icon,St=We[it]||{name:it,icon:st,applications:0,damage:0};St.applicationsFromUptime=(St.applicationsFromUptime||0)+Rt,!St.icon&&st&&(St.icon=st),We[it]=St;const Ct=i.outgoingConditions[it]||{applications:0,damage:0,skills:{},icon:st};Ct.applicationsFromUptime=(Ct.applicationsFromUptime||0)+Rt,!Ct.icon&&st&&(Ct.icon=st),i.outgoingConditions[it]=Ct;const At=Ge[it]||{name:it,icon:st,applications:0,damage:0};At.applicationsFromUptime=(At.applicationsFromUptime||0)+Rt,!At.icon&&st&&(At.icon=st),Ge[it]=At;const Mt=i.incomingConditions[it]||{applications:0,damage:0,skills:{},icon:st};Mt.applicationsFromUptime=(Mt.applicationsFromUptime||0)+Rt,!Mt.icon&&st&&(Mt.icon=st),i.incomingConditions[it]=Mt}He.has(F)||He.set(F,{name:g==null?void 0:g.name,stacking:ue,icon:g==null?void 0:g.icon}),Ke.has(F)||Ke.set(F,new Map);const Pn=Ke.get(F),Xt=i.account||o.account||o.name||"Unknown";let rt=Pn.get(Xt);rt||(rt={account:Xt,profession:i.profession||o.profession||"Unknown",professions:new Set,professionTimeMs:{},totalMs:0,uptimeMs:0,durationMs:0},Pn.set(Xt,rt));const bt=o.profession||i.profession;bt&&bt!=="Unknown"&&(rt.professions.add(bt),rt.professionTimeMs[bt]=(rt.professionTimeMs[bt]||0)+l,rt.profession=bt),rt.totalMs+=et?Fe:0,rt.uptimeMs+=Nt?Ye:0,rt.durationMs+=l}),(Ue=o.defenses)!=null&&Ue[0]){const E=C=>{let V=String(C||"Unknown").replace(/^Juvenile\s+/i,"")||"Unknown";return V.toUpperCase().includes("UNKNOWN")&&(V="Unknown"),V},g=(()=>{const C=Array.isArray(o==null?void 0:o.minions)?o.minions:[];if(C.length===0)return{total:0,byMinion:{}};let V=0;const ue={};return C.forEach(be=>{const Fe=Array.isArray(be==null?void 0:be.totalDamageTakenDist)?be.totalDamageTakenDist:[],Be=Array.isArray(Fe[0])?Fe[0]:[],nt=E(be==null?void 0:be.name);Be.forEach(Ye=>{const et=Number((Ye==null?void 0:Ye.totalDamage)??(Ye==null?void 0:Ye.damageTaken)??0);Number.isFinite(et)&&(V+=et,ue[nt]=(ue[nt]||0)+et)})}),{total:V,byMinion:ue}})();g.byMinion&&typeof g.byMinion=="object"&&Object.entries(g.byMinion).forEach(([C,V])=>{const ue=Number(V||0);!Number.isFinite(ue)||ue<=0||(i.defenseMinionDamageTaken[C]=(i.defenseMinionDamageTaken[C]||0)+ue)}),mi.forEach(C=>{const V=C.id==="minionDamageTaken"?g.total:Number(o.defenses[0][C.field]??0);Number.isFinite(V)&&(i.defenseTotals[C.id]=(i.defenseTotals[C.id]||0)+V)})}(Je=o.support)!=null&&Je[0]&&li.forEach(E=>{let F=Number(o.support[0][E.field]??0);Number.isFinite(F)&&(_e.has(E.field)&&F>999999&&(F=0),i.supportTotals[E.id]=(i.supportTotals[E.id]||0)+F)});const G=(E,F)=>{Number.isFinite(F)&&(i.healingTotals[E]=(i.healingTotals[E]||0)+F)},P=(E,F)=>Array.isArray(E)?E.reduce((g,C)=>g+Number((C==null?void 0:C[F])??0),0):0,A=(E,F,g)=>{if(!Number.isFinite(g)||g<=0)return;const C=s[F],V=F===c,ue=C==null?void 0:C.notInSquad,be=!ue,Fe=be&&(C==null?void 0:C.group)!=null&&C.group===o.group;G(E,g),be&&G(`squad${E[0].toUpperCase()}${E.slice(1)}`,g),Fe&&G(`group${E[0].toUpperCase()}${E.slice(1)}`,g),V&&G(`self${E[0].toUpperCase()}${E.slice(1)}`,g),ue&&G(`offSquad${E[0].toUpperCase()}${E.slice(1)}`,g)};if(Array.isArray(o.rotation)){let E=0;o.rotation.forEach(F=>{var C;if(!(F!=null&&F.id)||!gi(F.id,t.skillMap))return;const g=((C=F.skills)==null?void 0:C.length)||0;g>0&&(E+=g,G(`resUtility_s${F.id}`,g))}),E>0&&G("resUtility",E)}const $=(lt=o.extHealingStats)==null?void 0:lt.outgoingHealingAllies;Array.isArray($)&&$.forEach((E,F)=>{const g=P(E,"healing"),C=P(E,"downedHealing");A("healing",F,g),A("downedHealing",F,C)});const W=(ut=o.extBarrierStats)==null?void 0:ut.outgoingBarrierAllies;Array.isArray(W)&&W.forEach((E,F)=>{const g=P(E,"barrier");A("barrier",F,g)});const y=(_t=o.statsAll)==null?void 0:_t[0],se=(ft=o.dpsAll)==null?void 0:ft[0],le=(mt=o.support)==null?void 0:mt[0];if(ui.forEach(E=>{if(E.id==="downContributionPercent"||!E.field)return;let F=0,g=0;E.source==="dpsAll"&&se?F=Number(se[E.field]??0):E.source==="statsAll"&&y?(F=Number(y[E.field]??0),g=Number(y[E.denomField||E.weightField||"connectedDamageCount"]??0)):E.source==="support"&&le?F=Number(le[E.field]??0):o.statsTargets&&o.statsTargets.forEach(C=>{C!=null&&C[0]&&(F+=Number(C[0][E.field]??0),g+=Number(C[0][E.denomField||E.weightField||"connectedDamageCount"]??0))}),Number.isFinite(F)&&(i.offenseTotals[E.id]=(i.offenseTotals[E.id]||0)+F,E.isRate&&g>0&&(i.offenseRateWeights[E.id]=(i.offenseRateWeights[E.id]||0)+g))}),o.targetDamageDist&&Number.isFinite(f)){const E=o.targetDamageDist.flatMap(F=>F||[]).flatMap(F=>F||[]).reduce((F,g)=>g!=null&&g.id&&g.id===f?F+((g==null?void 0:g.connectedHits)||0):F,0);i.offenseTotals.battleStandardHits=(i.offenseTotals.battleStandardHits||0)+E}i.revives+=((Qt=(dt=o.support)==null?void 0:dt[0])==null?void 0:Qt.resurrects)||0,se&&(i.damage+=se.damage||0,i.dps+=se.dps||0);const ke=E=>{var V,ue,be,Fe;let F=`Skill ${E.id}`;const g=((V=t.skillMap)==null?void 0:V[`s${E.id}`])||((ue=t.skillMap)==null?void 0:ue[`${E.id}`]);let C=g==null?void 0:g.icon;if(g!=null&&g.name&&(F=g.name),F.startsWith("Skill ")){const Be=wt(F,E.id,t.buffMap);Be&&(F=Be,C=((Fe=(be=t.buffMap)==null?void 0:be[`b${E.id}`])==null?void 0:Fe.icon)||C)}return{name:F,icon:C}},Ae=E=>{if(!(E!=null&&E.id))return;const{name:F,icon:g}=ke(E);ge[E.id]||(ge[E.id]={name:F,icon:g,damage:0,hits:0,downContribution:0}),ge[E.id].name.startsWith("Skill ")&&!F.startsWith("Skill ")&&(ge[E.id].name=F),!ge[E.id].icon&&g&&(ge[E.id].icon=g),ge[E.id].damage+=E.totalDamage,ge[E.id].hits+=E.connectedHits,ge[E.id].downContribution+=Number(E.downContribution||0)},xe=o.account||o.name||"Unknown",Me=o.profession||"Unknown",$e=`${xe}|${Me}`;let qe=Oe.get($e);qe||(qe={key:$e,account:xe,displayName:xe,profession:Me,professionList:[Me],totalFightMs:0,skills:new Map},Oe.set($e,qe)),qe.professionList.includes(Me)||qe.professionList.push(Me),qe.totalFightMs+=t.durationMS||0;const Ee=E=>{if(!(E!=null&&E.id))return;const{name:F,icon:g}=ke(E),C=`s${E.id}`;let V=qe.skills.get(C);V||(V={id:C,name:F,icon:g,damage:0,downContribution:0},qe.skills.set(C,V)),V.name.startsWith("Skill ")&&!F.startsWith("Skill ")&&(V.name=F),!V.icon&&g&&(V.icon=g),V.damage+=Number(E.totalDamage||0),V.downContribution+=Number(E.downContribution||0)};if(ie==="total")(gt=o.totalDamageDist)==null||gt.forEach(E=>{E==null||E.forEach(F=>{Ae(F),Ee(F)})});else{const E=new Map;(Dt=o.targetDamageDist)==null||Dt.forEach(g=>{g==null||g.forEach(C=>{C==null||C.forEach(V=>{const ue=Number(V==null?void 0:V.id);if(Number.isFinite(ue)){const be=E.get(ue)||{damage:0,hits:0,downContribution:0};be.damage+=Number((V==null?void 0:V.totalDamage)||0),be.hits+=Number((V==null?void 0:V.connectedHits)||0),be.downContribution+=Number((V==null?void 0:V.downContribution)||0),E.set(ue,be)}Ae(V),Ee(V)})})}),!(t!=null&&t.detailedWvW)&&((Ut=o.totalDamageDist)==null||Ut.forEach(g=>{g==null||g.forEach(C=>{const V=Number(C==null?void 0:C.id);if(!Number.isFinite(V))return;const ue=E.get(V);if(!ue){Ae(C),Ee(C);return}const be=Number((C==null?void 0:C.totalDamage)||0),Fe=Number((C==null?void 0:C.connectedHits)||0),Be=Number((C==null?void 0:C.downContribution)||0),nt=be-Number(ue.damage||0),Ye=Fe-Number(ue.hits||0),et=Be-Number(ue.downContribution||0);if(nt<=0&&Ye<=0&&et<=0)return;const Nt={...C,totalDamage:Math.max(0,nt),connectedHits:Math.max(0,Ye),downContribution:Math.max(0,et)};Ae(Nt),Ee(Nt)})}))}o.totalDamageTaken&&o.totalDamageTaken.forEach(E=>{E==null||E.forEach(F=>{var ue,be,Fe,Be;if(!(F!=null&&F.id))return;let g=`Skill ${F.id}`;const C=((ue=t.skillMap)==null?void 0:ue[`s${F.id}`])||((be=t.skillMap)==null?void 0:be[`${F.id}`]);let V=C==null?void 0:C.icon;if(C!=null&&C.name&&(g=C.name),g.startsWith("Skill ")){const nt=wt(g,F.id,t.buffMap);nt&&(g=nt,V=((Be=(Fe=t.buffMap)==null?void 0:Fe[`b${F.id}`])==null?void 0:Be.icon)||V)}Ce[F.id]||(Ce[F.id]={name:g,icon:V,damage:0,hits:0}),(!Ce[F.id].name.startsWith("Skill ")||g.startsWith("Skill "))&&(Ce[F.id].name=g),!Ce[F.id].icon&&V&&(Ce[F.id].icon=V),Ce[F.id].damage+=F.totalDamage,Ce[F.id].hits+=F.hits})})}),M.forEach(o=>{if(o!=null&&o.isFake)return;const c=tt((o==null?void 0:o.profession)||(o==null?void 0:o.name)||(o==null?void 0:o.id));c&&(Le[c]=(Le[c]||0)+1)});const b=ri({players:s,targets:M,skillMap:t.skillMap,buffMap:t.buffMap,getPlayerKey:o=>o.account&&o.account!=="Unknown"?o.account:o.name||null}),S=ln(t.buffMap);Object.entries(b.playerConditions).forEach(([o,c])=>{const _=me.get(o);_&&Object.entries(c).forEach(([Q,m])=>{const i=_.outgoingConditions[Q]||{applications:0,damage:0,skills:{},icon:m.icon};i.applications+=Number(m.applications||0),i.damage+=Number(m.damage||0),m.applicationsFromBuffs&&(i.applicationsFromBuffs=(i.applicationsFromBuffs||0)+m.applicationsFromBuffs),m.applicationsFromBuffsActive&&(i.applicationsFromBuffsActive=(i.applicationsFromBuffsActive||0)+m.applicationsFromBuffsActive),Object.entries(m.skills||{}).forEach(([ne,l])=>{const p=i.skills[ne]||{name:l.name,hits:0,damage:0,icon:l.icon};p.hits+=Number(l.hits||0),p.damage+=Number(l.damage||0),!p.icon&&l.icon&&(p.icon=l.icon),i.skills[ne]=p}),!i.icon&&m.icon&&(i.icon=m.icon),_.outgoingConditions[Q]=i})}),Object.entries(b.summary).forEach(([o,c])=>{const _=We[o]||{name:c.name||o,icon:c.icon,applications:0,damage:0};_.applications+=Number(c.applications||0),_.damage+=Number(c.damage||0),c.applicationsFromBuffs&&(_.applicationsFromBuffs=(_.applicationsFromBuffs||0)+c.applicationsFromBuffs),c.applicationsFromBuffsActive&&(_.applicationsFromBuffsActive=(_.applicationsFromBuffsActive||0)+c.applicationsFromBuffsActive),!_.icon&&c.icon&&(_.icon=c.icon),We[o]=_}),d.forEach(o=>{const c=o.account&&o.account!=="Unknown"?o.account:o.name||"Unknown",_=me.get(c);!_||!o.totalDamageTaken||o.totalDamageTaken.forEach(Q=>Q==null?void 0:Q.forEach(m=>{var se,le,ke,Ae,xe,Me;if(!(m!=null&&m.id))return;let i=`Skill ${m.id}`;const ne=((se=t.skillMap)==null?void 0:se[`s${m.id}`])||((le=t.skillMap)==null?void 0:le[`${m.id}`]);ne!=null&&ne.name&&(i=ne.name);const l=wt(i,m.id,t.buffMap);if(!l)return;const p=(Ae=(ke=t.buffMap)==null?void 0:ke[`b${m.id}`])==null?void 0:Ae.name,R=S.get(l)||((Me=(xe=t.buffMap)==null?void 0:xe[`b${m.id}`])==null?void 0:Me.icon),G=(ne==null?void 0:ne.icon)||R;i.startsWith("Skill ")&&(p||l)&&(i=p||l);const P=Number(m.hits??0),A=Number(m.totalDamage??0),$=Ge[l]||{name:l,icon:R,applications:0,damage:0};$.applications+=Number.isFinite(P)?P:0,$.damage+=Number.isFinite(A)?A:0,!$.icon&&R&&($.icon=R),Ge[l]=$;const W=_.incomingConditions[l]||{applications:0,damage:0,skills:{},icon:R};W.applications+=Number.isFinite(P)?P:0,W.damage+=Number.isFinite(A)?A:0;const y=W.skills[i]||{name:i,hits:0,damage:0,icon:G};y.hits+=Number.isFinite(P)?P:0,y.damage+=Number.isFinite(A)?A:0,!y.icon&&G&&(y.icon=G),W.skills[i]=y,!W.icon&&R&&(W.icon=R),_.incomingConditions[l]=W}))});const w=t.player_damage_mitigation||t.playerDamageMitigation,T=w&&typeof w=="object"&&Object.keys(w).length>0;T&&Object.entries(w).forEach(([o,c])=>{if(!c||typeof c!="object")return;const _=kn(o),Q=Dn(xt,_.account,_);Object.values(c).forEach(m=>{ve((m==null?void 0:m.avoided_damage)??(m==null?void 0:m.avoidedDamage))<=0||Sn(Q.mitigationTotals,m)})});const v=t.player_minion_damage_mitigation||t.playerMinionDamageMitigation,u=v&&typeof v=="object"&&Object.keys(v).length>0;u&&Object.entries(v).forEach(([o,c])=>{if(!c||typeof c!="object")return;const _=kn(o);Object.entries(c).forEach(([Q,m])=>{if(!m||typeof m!="object")return;const i=`${_.account}::${Q}`,ne=Nn(Pt,i,{..._,minion:String(Q||"Unknown")});Object.values(m).forEach(l=>{Sn(ne.mitigationTotals,l)})})}),(!T||!u)&&(T||d.forEach(o=>{const c=(o==null?void 0:o.totalDamageTaken)||[];if(!Array.isArray(c)||c.length===0)return;const _=o.account||o.name||"Unknown",Q={account:_,name:o.name||_,profession:tt(o.profession||"Unknown")};Dn(xt,_,Q);const m=Array.isArray(c)?c[0]:null;m==null||m.forEach(i=>{if(!(i!=null&&i.id))return;const ne=ve(i.blocked),l=ve(i.evaded),p=ve(i.glance??i.glanced),R=ve(i.missed),G=ve(i.invulned),P=ve(i.interrupted),A=ve(i.hits??i.connectedHits),$=Number(i.id);Mn(Cn,`${_}::${$}`,{totalHits:A,blocked:ne,evaded:l,glanced:p,missed:R,invulned:G,interrupted:P})})}),u||d.forEach(o=>{const c=(o==null?void 0:o.minions)||[];if(!Array.isArray(c)||c.length===0)return;const _=o.account||o.name||"Unknown",Q={account:_,name:o.name||_,profession:tt(o.profession||"Unknown")};c.forEach(m=>{const i=(m==null?void 0:m.totalDamageTakenDist)||[];if(!Array.isArray(i)||i.length===0)return;let ne=String((m==null?void 0:m.name)||"Unknown").replace(/^Juvenile\s+/i,"")||"Unknown";ne.toUpperCase().includes("UNKNOWN")&&(ne="Unknown");const l=`${_}::${ne}`;Nn(Pt,l,{...Q,minion:ne});const p=Array.isArray(i)?i[0]:null;p==null||p.forEach(R=>{if(!(R!=null&&R.id))return;const G=ve(R.blocked),P=ve(R.evaded),A=ve(R.glance??R.glanced),$=ve(R.missed),W=ve(R.invulned),y=ve(R.interrupted),se=ve(R.hits??R.connectedHits),le=Number(R.id);Mn(An,`${l}::${le}`,{totalHits:se,blocked:G,evaded:P,glanced:A,missed:$,invulned:W,interrupted:y})})})}))});const wn=(e,t)=>{const s=new Map,M=a=>{let L=s.get(a);return L||(L=kt(),s.set(a,L)),L};t.forEach((a,L)=>{const D=L.lastIndexOf("::"),Y=D>-1?L.slice(0,D):L,K=D>-1?Number(L.slice(D+2)):Number.NaN,ee=Number.isFinite(K)?Mi(K):{hasSkill:!1,avg:0,min:0,hits:0};if(!ee.hasSkill||ee.hits<=0)return;const te=ee.avg,B=ee.min,N=a.glanced*te/2+(a.blocked+a.evaded+a.missed+a.invulned+a.interrupted)*te,H=a.glanced*B/2+(a.blocked+a.evaded+a.missed+a.invulned+a.interrupted)*B;if(N<=0)return;const d=M(Y);d.totalHits+=a.totalHits,d.blocked+=a.blocked,d.evaded+=a.evaded,d.glanced+=a.glanced,d.missed+=a.missed,d.invulned+=a.invulned,d.interrupted+=a.interrupted,d.totalMitigation+=N,d.minMitigation+=H}),e.forEach((a,L)=>{const D=s.get(L)||kt();a.mitigationTotals.totalHits=D.totalHits,a.mitigationTotals.blocked=D.blocked,a.mitigationTotals.evaded=D.evaded,a.mitigationTotals.glanced=D.glanced,a.mitigationTotals.missed=D.missed,a.mitigationTotals.invulned=D.invulned,a.mitigationTotals.interrupted=D.interrupted,a.mitigationTotals.totalMitigation=D.totalMitigation,a.mitigationTotals.minMitigation=D.minMitigation})};wn(xt,Cn),wn(Pt,An);const wi=oe>0?Math.round(re/oe):0,Ti=oe>0?Math.round(De/oe):0,Fi=Qe>0?(k/Qe).toFixed(2):k>0?"∞":"0.00",Bi=ce>0?(fe/ce).toFixed(2):fe>0?"∞":"0.00",Tn=(e,t)=>{const M=e.filter(D=>Number.isFinite(D.value)&&(t?D.value>0:D.value>=0)).sort((D,Y)=>{const K=t?Y.value-D.value:D.value-Y.value;return K!==0?K:D.account.localeCompare(Y.account)});let a=null,L=0;return M.map((D,Y)=>((a===null||D.value!==a)&&(L=Y+1,a=D.value),{rank:L,...D}))},zt=Array.from(me.values()).map(e=>{const t=Array.from(e.professions).filter(s=>s!=="Unknown");if(e.professionList=t,t.length>0){let s=t[0],M=e.professionTimeMs[s]||0;t.forEach(a=>{const L=e.professionTimeMs[a]||0;L>M&&(M=L,s=a)}),e.profession=s}return{key:e.account,stat:e}}),Fn=e=>{const t=me.get(e.account);if(!t){const a=e.professionList.length>0?e.professionList:e.profession?[e.profession]:[];return{...e,professionList:a}}const s=t.professionList&&t.professionList.length>0?t.professionList:Array.from(t.professions||[]).filter(a=>a&&a!=="Unknown"),M=t.profession||e.profession;return{...e,profession:M,professionList:s.length>0?s:M?[M]:[],activeMs:t.defenseActiveMs||t.totalFightMs||e.activeMs}},Ei=Array.from(xt.values()).map(Fn).filter(e=>Ai(e.mitigationTotals)).sort((e,t)=>e.account.localeCompare(t.account)),vi=Array.from(Pt.values()).map(Fn).filter(e=>e.mitigationTotals.totalMitigation>0).sort((e,t)=>{const s=e.account.localeCompare(t.account);return s!==0?s:String(e.minion||"").localeCompare(String(t.minion||""))}),qt=(e,t)=>{switch(t){case"downContrib":return e.downContrib;case"barrier":return e.barrier;case"healing":return e.healing;case"dodges":return e.dodges;case"strips":return e.strips;case"cleanses":return e.cleanses;case"cc":return e.cc;case"stability":return e.stab;case"revives":return e.revives;case"dps":return e.dps;case"damage":return e.damage;case"participation":return e.logsJoined;case"closestToTag":return!e.isCommander&&e.distCount>0?e.totalDist/e.distCount:Number.POSITIVE_INFINITY;default:return 0}},ye=(e,t)=>Tn(zt.map(({stat:s})=>({account:s.account,profession:s.profession,professionList:s.professionList,value:qt(s,e),count:s.logsJoined})),t),Pe={downContrib:ye("downContrib",!0),barrier:ye("barrier",!0),healing:ye("healing",!0),dodges:ye("dodges",!0),strips:ye("strips",!0),cleanses:ye("cleanses",!0),cc:ye("cc",!0),stability:ye("stability",!0),revives:ye("revives",!0),participation:ye("participation",!0),dps:ye("dps",!0),damage:ye("damage",!0),closestToTag:ye("closestToTag",!1).filter(e=>Number.isFinite(e.value))},Ii={downContrib:"downContrib",barrier:"barrier",healing:"healing",dodges:"dodges",strips:"strips",cleanses:"cleanses",cc:"cc",stability:"stability",closestToTag:"closestToTag"},Te=e=>{const t=e==null?void 0:e[0];return{value:(t==null?void 0:t.value)??0,player:(t==null?void 0:t.account)??"-",count:(t==null?void 0:t.count)??0,profession:(t==null?void 0:t.profession)??"Unknown",professionList:(t==null?void 0:t.professionList)??[]}},at={maxDownContrib:Te([]),maxBarrier:Te([]),maxHealing:Te([]),maxDodges:Te([]),maxStrips:Te([]),maxCleanses:Te([]),maxCC:Te([]),maxStab:Te([]),closestToTag:Te([])},ot={},Li=(e,t)=>{if(t==="closestToTag")return qt(e,t);const s=Math.max(1,(e.totalFightMs||0)/1e3);return qt(e,t)/s};Object.values(Ii).forEach(e=>{const t=e!=="closestToTag";ot[e]=Tn(zt.map(({stat:s})=>({account:s.account,profession:s.profession,professionList:s.professionList,value:Li(s,e),count:s.logsJoined})),t)}),at.maxDownContrib=Te(ot.downContrib),at.maxBarrier=Te(ot.barrier),at.maxHealing=Te(ot.healing),at.maxDodges=Te(ot.dodges),at.maxStrips=Te(ot.strips),at.maxCleanses=Te(ot.cleanses),at.maxCC=Te(ot.cc),at.maxStab=Te(ot.stability),at.closestToTag=Te(ot.closestToTag);const xi={maxDownContrib:Te(Pe.downContrib),maxBarrier:Te(Pe.barrier),maxHealing:Te(Pe.healing),maxDodges:Te(Pe.dodges),maxStrips:Te(Pe.strips),maxCleanses:Te(Pe.cleanses),maxCC:Te(Pe.cc),maxStab:Te(Pe.stability),closestToTag:Te(Pe.closestToTag)};let Vt={player:"None",account:"None",score:-1,profession:"Unknown",professionList:[],color:"#64748b",topStats:[]},Bn,En,vn=0;if(ae!=null&&ae.showMvp){const e={"Down Contribution":"downContribution",Healing:"healing",Cleanses:"cleanses",Strips:"strips",Stability:"stability",CC:"cc",Revives:"revives","Distance to Tag":"distanceToTag",Participation:"participation",Dodging:"dodging",DPS:"dps",Damage:"damage"},t=L=>{const D=e[L];return D?Number(he[D]||0)>0:!1},s=[],M=L=>[...L||[]].filter(D=>t(D==null?void 0:D.name)).sort((D,Y)=>Y.ratio-D.ratio||D.rank-Y.rank||D.name.localeCompare(Y.name)).slice(0,3),a=L=>{var Y;if(!L)return;const D=M(L.contribs);return{...L,player:L.name,reason:((Y=D[0])==null?void 0:Y.name)||"Top Performance",topStats:D}};zt.forEach(({stat:L})=>{let D=0;const Y=[],K=(ee,te,B,N,H=!0)=>{var x,U;if(B<=0)return;const d=((x=te[0])==null?void 0:x.value)||0;if(d&&Number.isFinite(ee)&&(H?ee>0:ee<Number.POSITIVE_INFINITY)){const X=H?ee/d:d/ee;D+=X*B;const f=((U=te.find(b=>b.account===L.account))==null?void 0:U.rank)||0;Y.push({name:N,ratio:X,val:ee.toLocaleString(),rank:f})}};K(L.downContrib,Pe.downContrib,he.downContribution,"Down Contribution"),K(L.healing,Pe.healing,he.healing,"Healing"),K(L.cleanses,Pe.cleanses,he.cleanses,"Cleanses"),K(L.strips,Pe.strips,he.strips,"Strips"),K(L.stab,Pe.stability,he.stability,"Stability"),K(L.cc,Pe.cc,he.cc,"CC"),K(L.revives,Pe.revives,he.revives,"Revives"),K(qt(L,"closestToTag"),Pe.closestToTag,he.distanceToTag,"Distance to Tag",!1),K(L.logsJoined,Pe.participation,he.participation,"Participation"),K(L.dodges,Pe.dodges,he.dodging,"Dodging"),K(L.dps,Pe.dps,he.dps,"DPS"),K(L.damage,Pe.damage,he.damage,"Damage"),s.push({...L,score:D,contribs:Y.filter(ee=>t(ee.name))})}),s.sort((L,D)=>D.score-L.score),s[0]&&s[0].score>0&&(Vt=a(s[0])||Vt),Bn=a(s[1]),En=a(s[2]),vn=s.length>0?s.reduce((L,D)=>L+D.score,0)/s.length:0}const In=Object.values(ge).sort((e,t)=>t.damage-e.damage||t.hits-e.hits||String(e.name||"").localeCompare(String(t.name||""))).slice(0,25),Ln=Object.values(ge).sort((e,t)=>t.downContribution-e.downContribution||t.hits-e.hits||String(e.name||"").localeCompare(String(t.name||""))).slice(0,25),Pi=de==="downContribution"?Ln:In,qi=Object.values(Ce).sort((e,t)=>t.damage-e.damage).slice(0,25),_i=e=>{const t=String(e).replace(/^Detailed\s*WvW\s*-\s*/i,"").replace(/^World\s*vs\s*World\s*-\s*/i,"").replace(/^WvW\s*-\s*/i,"").trim(),s=t.match(/^(Red|Blue|Green)\s+(?:Alpine|Desert)?\s*Borderlands$/i);return s?`${s[1]} Borderlands`:t||"Unknown"},ct=(e,t)=>_i((e==null?void 0:e.zone)||(e==null?void 0:e.mapName)||(e==null?void 0:e.map)||(e==null?void 0:e.location)||(e==null?void 0:e.fightName)||(t==null?void 0:t.fightName)||(t==null?void 0:t.encounterName)||"Unknown"),Ui=(e,t)=>{const s=(t==null?void 0:t.permalink)||(e==null?void 0:e.permalink);if(typeof s=="string"&&s.trim().length>0)return s.trim();const M=e==null?void 0:e.uploadLinks;if(!Array.isArray(M))return"";for(const a of M){if(typeof a=="string"&&a.trim().length>0)return a.trim();if(a&&typeof a=="object"){const L=a.permalink||a.link||a.url||a.reportLink;if(typeof L=="string"&&L.trim().length>0)return L.trim()}}return""},Ri=(e,t)=>{const s=Number((e==null?void 0:e.durationMS)||0);return s>0?Tt(s):(typeof(t==null?void 0:t.encounterDuration)=="string"?t.encounterDuration.trim():"")||"--:--"},xn=(e,t)=>{if((Array.isArray(e==null?void 0:e.players)?e.players:[]).length>0)return Se(e);if(typeof(e==null?void 0:e.success)=="boolean")return e.success;const M=t==null?void 0:t.dashboardSummary;if(M&&typeof M=="object"){if(M.isWin===!0)return!0;if(M.isWin===!1)return!1}return null},$i=(e,t)=>{var D,Y;const s=ze((D=e.log)==null?void 0:D.details,e.log),M=ze((Y=t.log)==null?void 0:Y.details,t.log),a=s>0,L=M>0;return a&&L&&s!==M?s-M:a!==L?a?-1:1:e.originalIndex-t.originalIndex},Kt=n.map((e,t)=>({log:e,originalIndex:t})).sort($i),Oi=Kt.filter(({log:e})=>pe(e)),Gt={};Z.forEach(e=>{const t=ct(e==null?void 0:e.details,e);Gt[t]=(Gt[t]||0)+1});const Hi=Object.entries(Gt).map(([e,t])=>{const s=String(e).trim(),M=/eternal battlegrounds|^ebg$/i.test(s);let a="#64748b";return M?a="#ffffff":/red/i.test(s)?a="#ef4444":/blue/i.test(s)?a="#3b82f6":/green/i.test(s)&&(a="#22c55e"),{name:e,value:t,color:a}}).sort((e,t)=>t.value-e.value),{boonTables:ji}=jn(Z),Wi=(()=>{const e=B=>String(B||"").replace(/^Detailed\s*WvW\s*-\s*/i,"").replace(/^World\s*vs\s*World\s*-\s*/i,"").replace(/^WvW\s*-\s*/i,"").trim(),t=B=>e(B).toLowerCase().split(/[^a-z0-9]+/i).map(N=>N.trim()).filter(Boolean).map(N=>N.length>3&&N.endsWith("s")?N.slice(0,-1):N),s=(B,N)=>{const H=e(B),d=e(N);if(!d)return H;if(!H)return d;const x=t(H),U=t(d),X=new Set(x),f=new Set(U),b=U.length>0&&U.every(w=>X.has(w)),S=x.length>0&&x.every(w=>f.has(w));return b||S?H:`${H} - ${d}`},M=new Map,a=(B,N)=>{if(!M.has(B))M.set(B,{id:B,name:String((N==null?void 0:N.name)||B),icon:N==null?void 0:N.icon,stacking:!!(N!=null&&N.stacking),players:new Map,fights:[]});else if(N){const H=M.get(B);(!H.name||H.name===B)&&(N!=null&&N.name)&&(H.name=String(N.name)),!H.icon&&(N!=null&&N.icon)&&(H.icon=String(N.icon)),!H.stacking&&(N!=null&&N.stacking)&&(H.stacking=!0)}return M.get(B)},L=B=>Array.isArray(B)?B.map(N=>Array.isArray(N)?[Number(N[0]),Number(N[1])]:N&&typeof N=="object"?[Number(N.time),Number(N.value)]:null).filter(N=>!!N&&Number.isFinite(N[0])&&Number.isFinite(N[1])&&N[0]>=0).sort((N,H)=>N[0]-H[0]):[],D=(B,N,H)=>{const d=B.get(N)||[];d.length<H&&(d.length=H);for(let x=0;x<H;x+=1)Number.isFinite(d[x])||(d[x]=0);return B.set(N,d),d},Y=(B,N,H,d,x)=>{if(!N||N==="__all__"||d<=0)return;const U=L(H);if(U.length===0)return;const X=D(B,N,d),f=Math.max(1,Number(x||0),d*5e3),b=v=>Math.max(0,Math.min(f,Number(v||0))),S=(v,u,q)=>{if(!Number.isFinite(q)||q<=0)return;let j=b(v);const o=b(u);if(!(o<=j))for(;j<o;){const c=Math.max(0,Math.min(d-1,Math.floor(j/5e3))),_=Math.min(o,(c+1)*5e3),Q=Math.max(0,_-j);Q>0&&(X[c]=Number(X[c]||0)+Q*q),j=_}};let w=b(U[0][0]),T=Math.max(0,Number(U[0][1]||0));for(let v=1;v<U.length;v+=1){const[u,q]=U[v],j=b(u);S(w,j,T),w=j,T=Math.max(0,Number(q||0))}S(w,f,T)},K=(B,N,H)=>{const d=Array.from({length:H},(X,f)=>Number((B==null?void 0:B[f])||0)),x=d.reduce((X,f)=>X+Number(f||0),0);if(!Number.isFinite(N)||N<=0)return d.map(()=>0);if(!Number.isFinite(x)||x<=0){const X=N/Math.max(1,H);return d.map(()=>X)}const U=N/x;return d.map(X=>Number(X||0)*U)},ee=()=>({selfBuffs:0,groupBuffs:0,squadBuffs:0,totalBuffs:0}),te=(B,N,H)=>{const d=Math.max(0,Number(H||0));d&&(B[N]=Number(B[N]||0)+d,(N==="selfBuffs"||N==="squadBuffs")&&(B.totalBuffs=Number(B.totalBuffs||0)+d))};return Z.map(B=>({log:B,ts:ze(B==null?void 0:B.details,B)})).sort((B,N)=>B.ts-N.ts).forEach(({log:B},N)=>{const H=B==null?void 0:B.details;if(!H)return;const x=(Array.isArray(H.players)?H.players:[]).filter(c=>!(c!=null&&c.notInSquad)),U=x.length;if(U<=0)return;const X=Math.max(0,Number((H==null?void 0:H.durationMS)||0)),f=Math.max(1,Math.ceil(Math.max(1,X)/5e3)),b=H!=null&&H.buffMap&&typeof H.buffMap=="object"?H.buffMap:{},S=new Map,w=new Map;x.forEach(c=>{const _=Number((c==null?void 0:c.group)??0);w.set(_,(w.get(_)||0)+1);const m=String((c==null?void 0:c.account)||(c==null?void 0:c.name)||"Unknown");[c==null?void 0:c.name,c==null?void 0:c.display_name,c==null?void 0:c.character_name,c==null?void 0:c.account].map(i=>String(i||"").trim()).filter(Boolean).forEach(i=>S.set(i,m))});const T=e(H.fightName||B.fightName||`Fight ${N+1}`),v=ct(H,B),u=s(T,String(v||"")),q=new Map,j=new Map,o=new Map;x.forEach(c=>{const _=String((c==null?void 0:c.account)||(c==null?void 0:c.name)||"Unknown"),Q=String((c==null?void 0:c.profession)||"Unknown"),m=_,i=Number((c==null?void 0:c.group)??0),ne=Math.max(1,Number(w.get(i)||1));["selfBuffs","groupBuffs","squadBuffs"].forEach(p=>{(Array.isArray(c==null?void 0:c[p])?c[p]:[]).forEach(G=>{var Xe;const P=Number(G==null?void 0:G.id);if(!Number.isFinite(P))return;const A=`b${P}`,$=b[A]||{},W=String(($==null?void 0:$.classification)||"");if(W&&W!=="Boon")return;const y=Number(((Xe=$t(c,p,P,X,ne,U,b))==null?void 0:Xe.generationMs)||0);if(!Number.isFinite(y)||y<=0)return;const se=a(A,$),le=se.players.get(m)||{key:m,account:_,displayName:_,profession:Q,professionList:Q&&Q!=="Unknown"?[Q]:[],logs:0,totals:ee()};Q&&Q!=="Unknown"&&!le.professionList.includes(Q)&&le.professionList.push(Q),(!le.profession||le.profession==="Unknown")&&Q&&Q!=="Unknown"&&(le.profession=Q);const ke=o.get(A)||new Set;ke.has(m)||(ke.add(m),le.logs+=1,o.set(A,ke)),te(le.totals,p,y),se.players.set(m,le);const Ae=se.players.get("__all__")||{key:"__all__",account:"All",displayName:"All",profession:"All",professionList:[],logs:0,totals:ee()};te(Ae.totals,p,y),se.players.set("__all__",Ae);const xe=q.get(A)||new Map,Me=xe.get(m)||ee();te(Me,p,y),xe.set(m,Me);const $e=xe.get("__all__")||ee();te($e,p,y),xe.set("__all__",$e),q.set(A,xe);const qe=Array.isArray(c==null?void 0:c.buffUptimes)?c.buffUptimes.find(Ue=>Number(Ue==null?void 0:Ue.id)===P):null,Ee=qe!=null&&qe.statesPerSource&&typeof qe.statesPerSource=="object"?qe.statesPerSource:null;if(Ee){const Ue=j.get(A)||new Map;Object.entries(Ee).forEach(([Je,lt])=>{const ut=S.get(String(Je||"").trim());ut&&Y(Ue,ut,lt,f,X)}),j.set(A,Ue)}})})}),q.forEach((c,_)=>{const Q=M.get(_);if(!Q)return;const m=j.get(_)||new Map,i={};let ne=Array.from({length:f},()=>0),l=0;c.forEach((P,A)=>{const $={selfBuffs:Number((P==null?void 0:P.selfBuffs)||0),groupBuffs:Number((P==null?void 0:P.groupBuffs)||0),squadBuffs:Number((P==null?void 0:P.squadBuffs)||0),totalBuffs:Number((P==null?void 0:P.totalBuffs)||0)},W=Math.max(0,Number($.totalBuffs||0));if(!Number.isFinite(W)||W<=0)return;const y=m.get(A)||[],se=K(y,W,f);i[A]={total:W,totals:$,bucketWeights5s:Array.from({length:f},(le,ke)=>Number(y[ke]||0)),buckets5s:se},A!=="__all__"&&(W>l&&(l=W),ne=ne.map((le,ke)=>Number(le||0)+Number(se[ke]||0)))});const p=c.get("__all__"),R=Number((p==null?void 0:p.totalBuffs)||0);if(R>0&&(i.__all__={total:R,totals:{selfBuffs:Number((p==null?void 0:p.selfBuffs)||0),groupBuffs:Number((p==null?void 0:p.groupBuffs)||0),squadBuffs:Number((p==null?void 0:p.squadBuffs)||0),totalBuffs:Number((p==null?void 0:p.totalBuffs)||0)},bucketWeights5s:Array.from({length:f},(P,A)=>Number((m.get("__all__")||[])[A]||0)),buckets5s:ne.some(P=>Number(P||0)>0)?ne:K(m.get("__all__")||[],R,f)}),Object.keys(i).length===0)return;const G=Q.players.get("__all__");G&&(G.logs+=1,Q.players.set("__all__",G)),Q.fights.push({id:B.filePath||B.id||`fight-${N+1}`,shortLabel:`F${N+1}`,fullLabel:u,timestamp:ze(H,B),durationMs:X,values:i,maxTotal:l})})}),Array.from(M.values()).map(B=>({id:B.id,name:B.name||B.id,icon:B.icon,stacking:B.stacking,players:Array.from(B.players.values()).sort((N,H)=>{var x,U;if(N.key==="__all__")return-1;if(H.key==="__all__")return 1;const d=Number(((x=H.totals)==null?void 0:x.totalBuffs)||0)-Number(((U=N.totals)==null?void 0:U.totalBuffs)||0);return d!==0?d:String(N.displayName||"").localeCompare(String(H.displayName||""))}),fights:[...B.fights].sort((N,H)=>N.timestamp>0&&H.timestamp>0&&N.timestamp!==H.timestamp?N.timestamp-H.timestamp:N.shortLabel.localeCompare(H.shortLabel,void 0,{numeric:!0}))})).filter(B=>B.players.length>0&&B.fights.length>0).sort((B,N)=>String(B.name||"").localeCompare(String(N.name||"")))})(),zi=Kt.map(({log:e})=>{const t=e==null?void 0:e.details,s=Array.isArray(t==null?void 0:t.players)?t.players:[],M=Array.isArray(t==null?void 0:t.targets)?t.targets:[],a=e!=null&&e.dashboardSummary&&typeof e.dashboardSummary=="object"?e.dashboardSummary:null,L=s.filter(N=>!N.notInSquad),D=M.filter(N=>!N.isFake),Y=Math.max(0,Number((a==null?void 0:a.squadCount)||0)),K=Math.max(0,Number((a==null?void 0:a.enemyCount)||0)),ee=L.length>0?L.length:Y,te=D.length>0?D.length:K,B=s.length>0?s.length:ee;return{timestamp:ze(t,e),squadCount:ee,friendlyCount:B,enemies:te,isWin:xn(t,e)}}).map((e,t)=>({...e,index:t+1,label:`Log ${t+1}`})),Jt={};Array.from(me.values()).forEach(e=>{e.profession&&e.profession!=="Unknown"&&(Jt[e.profession]=(Jt[e.profession]||0)+1)});const Vi=Object.entries(Jt).map(([e,t])=>({name:e,value:t,color:fn(e)})).sort((e,t)=>t.value-e.value),Yt={};Object.keys(Le).length===0&&Z.forEach(e=>{var t,s;(s=(t=e.details)==null?void 0:t.targets)==null||s.forEach(M=>{if(M.isFake)return;const a=M.profession&&M.profession!=="Unknown"?M.profession:M.name||M.id||"Unknown",L=tt(a);Yt[L]=(Yt[L]||0)+1})});const Ki=Object.keys(Le).length>0?Le:Yt,Gi=Object.entries(Ki).map(([e,t])=>({name:e,value:t,color:fn(e)})).sort((e,t)=>t.value-e.value),Ji=Kt.map(({log:e},t)=>{const s=e==null?void 0:e.details,M=Array.isArray(s==null?void 0:s.players)?s.players:[],a=M.filter(u=>!u.notInSquad),L=M.filter(u=>u.notInSquad),Y=(Array.isArray(s==null?void 0:s.targets)?s.targets:[]).filter(u=>!u.isFake),K=e!=null&&e.dashboardSummary&&typeof e.dashboardSummary=="object"?e.dashboardSummary:null,ee=a.reduce((u,q)=>{var j,o;return u+(((o=(j=q.dpsAll)==null?void 0:j[0])==null?void 0:o.damage)||0)},0),te=a.reduce((u,q)=>{var j,o;return u+(((o=(j=q.defenses)==null?void 0:j[0])==null?void 0:o.damageTaken)||0)},0),{enemyDeaths:B,enemyDownsDeaths:N}=Ne(s),H=xn(s,e),d=ze(s,e),x=ct(s,e),U=u=>{if(!u||typeof u!="object")return;const q=u.teamID??u.teamId??u.team??u.teamColor??u.team_color;if(q!=null)return q;const j=Object.keys(u).find(o=>/^team/i.test(o));return j?u[j]:void 0},X=(u,q)=>{const j={};return u.forEach(o=>{const c=q(o),_=tt(c);_&&(j[_]=(j[_]||0)+1)}),j},f=X(a,u=>(u==null?void 0:u.profession)||(u==null?void 0:u.name)),b=X(L,u=>(u==null?void 0:u.profession)||(u==null?void 0:u.name)),S=X(Y,u=>(u==null?void 0:u.profession)||(u==null?void 0:u.name)||(u==null?void 0:u.id)),w=new Set;a.forEach(u=>{const q=U(u);q!=null&&w.add(String(q))});const T=new Map;Y.forEach(u=>{if((u==null?void 0:u.enemyPlayer)===!1)return;const q=U(u);if(q==null)return;const j=String(q);w.has(j)||T.set(j,(T.get(j)||0)+1)});const v=Array.from(T.entries()).sort((u,q)=>{const j=q[1]-u[1];return j!==0?j:u[0].localeCompare(q[0],void 0,{numeric:!0})}).slice(0,3).map(([u,q])=>({teamId:u,count:q}));return{id:e.filePath||`fight-${t}`,label:e.encounterName||`Fight ${t+1}`,permalink:Ui(s,e),timestamp:d,mapName:x,duration:Ri(s,e),isWin:H,squadCount:a.length>0?a.length:Math.max(0,Number((K==null?void 0:K.squadCount)||0)),allyCount:L.length,enemyCount:Y.length>0?Y.length:Math.max(0,Number((K==null?void 0:K.enemyCount)||0)),teamBreakdown:v,alliesDown:a.reduce((u,q)=>{var j,o;return u+(((o=(j=q.defenses)==null?void 0:j[0])==null?void 0:o.downCount)||0)},0),alliesDead:a.length>0?a.reduce((u,q)=>{var j,o;return u+(((o=(j=q.defenses)==null?void 0:j[0])==null?void 0:o.deadCount)||0)},0):Math.max(0,Number((K==null?void 0:K.squadDeaths)||0)),alliesRevived:a.reduce((u,q)=>{var j,o;return Number(((o=(j=q.statsAll)==null?void 0:j[0])==null?void 0:o.saved)||0)>0?u+1:u},0),rallies:0,enemyDeaths:Y.length>0||a.length>0?B:Math.max(0,Number((K==null?void 0:K.enemyDeaths)||0)),enemyDowns:Math.max(0,N-B),totalOutgoingDamage:ee,totalIncomingDamage:te,incomingBarrierAbsorbed:a.reduce((u,q)=>{var j,o;return u+(((o=(j=q.defenses)==null?void 0:j[0])==null?void 0:o.damageBarrier)||0)},0),outgoingBarrierAbsorbed:a.reduce((u,q)=>{var c;const j=(c=q.extBarrierStats)==null?void 0:c.outgoingBarrier;if(!Array.isArray(j))return u;let o=0;return j.forEach(_=>{if(Array.isArray(_)){_.forEach(Q=>{o+=Number((Q==null?void 0:Q.barrier)||0)});return}o+=Number((_==null?void 0:_.barrier)||0)}),u+o},0),squadClassCountsFight:f,allyClassCountsFight:b,enemyClassCounts:S}}),Yi=Oi.map(({log:e},t)=>{const s=e.details;if(!s)return null;const a=(Array.isArray(s.players)?s.players:[]).filter(l=>!l.notInSquad),L=Array.isArray(s.targets)?s.targets:[],D=ze(s,e),Y=ct(s,e),K=Number(s.durationMS||0),{squadDownsDeaths:ee,enemyDownsDeaths:te,squadDeaths:B,enemyDeaths:N}=Ne(s),H=new Map,d=(l,p,R)=>{const G=H.get(l)||{label:l,damage:0,hits:0};G.damage+=p,G.hits+=R,H.set(l,G)};if(a.forEach(l=>{(Array.isArray(l==null?void 0:l.statsTargets)?l.statsTargets:[]).forEach((R,G)=>{const P=Array.isArray(R)?R[0]:R,A=Number((P==null?void 0:P.damage)??(P==null?void 0:P.totalDmg)??(P==null?void 0:P.connectedDmg)??0),$=Number((P==null?void 0:P.connectedHits)??(P==null?void 0:P.connectedDamageCount)??(P==null?void 0:P.hits)??0);if(A<=0&&$<=0)return;const W=L[G];if(W!=null&&W.isFake)return;const y=(W==null?void 0:W.profession)||(W==null?void 0:W.name)||(W==null?void 0:W.id)||`Target ${G+1}`,se=tt(y);d(se||String(y),A,$)})}),H.size===0){const l=new Map,p=R=>{if(!Array.isArray(R)||R.length===0)return[];const G=R[0];if(Array.isArray(G)&&Array.isArray(G[0])){if(typeof G[0][0]=="number")return G;if(Array.isArray(G[0])&&typeof G[0][0]=="number")return R.map(P=>Array.isArray(P)?P[0]||[]:[])}return[]};a.forEach(R=>{p(R==null?void 0:R.targetDamage1S).forEach((P,A)=>{if(!Array.isArray(P)||P.length===0)return;const $=P.map(y=>Number(y)).filter(y=>Number.isFinite(y)&&y>=0);if($.length===0)return;const W=Math.max(0,$[$.length-1]||0);W<=0||l.set(A,(l.get(A)||0)+W)})}),l.forEach((R,G)=>{if(R<=0)return;const P=L[G];if(P!=null&&P.isFake)return;const A=(P==null?void 0:P.profession)||(P==null?void 0:P.name)||(P==null?void 0:P.id)||`Target ${G+1}`,$=tt(A);d($||String(A),R,0)})}if(H.size===0&&L.forEach((l,p)=>{if(l!=null&&l.isFake)return;const R=Array.isArray(l==null?void 0:l.totalDamageTaken)?l.totalDamageTaken:Array.isArray(l==null?void 0:l.totalDamageDist)?l.totalDamageDist:[];let G=0,P=0;if(R.forEach(W=>{G+=Number((W==null?void 0:W.totalDamage)||(W==null?void 0:W.damage)||0),P+=Number((W==null?void 0:W.connectedHits)||(W==null?void 0:W.hits)||0)}),G<=0&&Number((l==null?void 0:l.damageTaken)||0)>0&&(G=Number(l.damageTaken||0)),G<=0&&P<=0)return;const A=(l==null?void 0:l.profession)||(l==null?void 0:l.name)||(l==null?void 0:l.id)||`Target ${p+1}`,$=tt(A);d($||String(A),G,P)}),H.size===0){const l=new Map;L.forEach((p,R)=>{if(p!=null&&p.isFake)return;const G=(p==null?void 0:p.profession)||(p==null?void 0:p.name)||(p==null?void 0:p.id)||`Target ${R+1}`,P=tt(G)||String(G);l.set(P,(l.get(P)||0)+1)}),l.forEach((p,R)=>{p>0&&d(R,p,0)})}const x=Array.from(H.values()).sort((l,p)=>p.damage-l.damage||p.hits-l.hits||l.label.localeCompare(p.label)),U=x.reduce((l,p)=>l+p.damage,0),X=x.map(l=>({label:l.label,damage:l.damage,hits:l.hits,share:U>0?l.damage/U:0})),f=L.filter(l=>!(l!=null&&l.isFake)).length,b=a.length,S=a.reduce((l,p)=>{var R,G;return l+Number(((G=(R=p==null?void 0:p.dpsAll)==null?void 0:R[0])==null?void 0:G.damage)||0)},0),w=a.reduce((l,p)=>{var R,G;return l+Number(((G=(R=p==null?void 0:p.defenses)==null?void 0:R[0])==null?void 0:G.damageTaken)||0)},0),T=a.reduce((l,p)=>{var R,G;return l+Number(((G=(R=p==null?void 0:p.defenses)==null?void 0:R[0])==null?void 0:G.damageBarrier)||0)},0),v=a.reduce((l,p)=>{var P;const R=(P=p==null?void 0:p.extBarrierStats)==null?void 0:P.outgoingBarrier;if(!Array.isArray(R))return l;let G=0;return R.forEach(A=>{Array.isArray(A)?A.forEach($=>{G+=Number(($==null?void 0:$.barrier)||0)}):G+=Number((A==null?void 0:A.barrier)||0)}),l+G},0),u=a.reduce((l,p)=>{var R,G;return Number(((G=(R=p==null?void 0:p.statsAll)==null?void 0:R[0])==null?void 0:G.saved)||0)>0?l+1:l},0),q=a.reduce((l,p)=>l+Number(sn(p)||0),0),j=a.reduce((l,p)=>l+Number(on(p)||0),0),o=a.reduce((l,p)=>l+Number((p==null?void 0:p.stabGeneration)||0),0),c=a.reduce((l,p)=>l+Number(rn(p)||0),0),_=a.reduce((l,p)=>l+Number(cn(p)||0),0),Q=a.reduce((l,p)=>l+Number(un(p)||0),0),m=a.reduce((l,p)=>l+Number(an(p)||0),0),i=B>0?N/B:N,ne=[{metricId:"winFlag",metricLabel:"Win (1) / Loss (0)",higherIsBetter:!0,value:Se(s)?1:0},{metricId:"squadCount",metricLabel:"Squad Size",higherIsBetter:!0,value:b},{metricId:"enemyCount",metricLabel:"Enemy Count",higherIsBetter:!1,value:f},{metricId:"squadKdr",metricLabel:"Squad KDR",higherIsBetter:!0,value:i},{metricId:"enemyDeaths",metricLabel:"Enemy Deaths",higherIsBetter:!0,value:N},{metricId:"enemyDowns",metricLabel:"Enemy Downs",higherIsBetter:!0,value:Math.max(0,te-N)},{metricId:"squadDeaths",metricLabel:"Squad Deaths",higherIsBetter:!1,value:B},{metricId:"squadDowns",metricLabel:"Squad Downs",higherIsBetter:!1,value:Math.max(0,ee-B)},{metricId:"damageDelta",metricLabel:"Damage Delta",higherIsBetter:!0,value:S-w},{metricId:"outgoingDamage",metricLabel:"Outgoing Damage",higherIsBetter:!0,value:S},{metricId:"incomingDamage",metricLabel:"Incoming Damage",higherIsBetter:!1,value:w},{metricId:"cleanses",metricLabel:"Squad Cleanses",higherIsBetter:!0,value:q},{metricId:"strips",metricLabel:"Squad Strips",higherIsBetter:!0,value:j},{metricId:"stability",metricLabel:"Squad Stability",higherIsBetter:!0,value:o},{metricId:"healing",metricLabel:"Squad Healing",higherIsBetter:!0,value:c},{metricId:"barrierOut",metricLabel:"Squad Barrier Out",higherIsBetter:!0,value:_},{metricId:"barrierIncomingAbsorb",metricLabel:"Barrier Absorption (Incoming)",higherIsBetter:!0,value:T},{metricId:"enemyBarrierAbsorb",metricLabel:"Enemy Barrier Absorption",higherIsBetter:!1,value:v},{metricId:"cc",metricLabel:"Squad CC",higherIsBetter:!0,value:Q},{metricId:"downContrib",metricLabel:"Squad Down Contribution",higherIsBetter:!0,value:m},{metricId:"alliesRevived",metricLabel:"Allies Revived (Players)",higherIsBetter:!0,value:u}];return{id:e.filePath||e.id||`fight-${t+1}`,shortLabel:`F${t+1}`,fullLabel:`${Y||e.encounterName||"Unknown Map"} • ${Tt(K)}`,mapName:Y,timestamp:D,duration:Tt(K),isWin:Se(s),targetFocus:X,squadMetrics:ne}}).filter(Boolean),Qi=Array.from(me.values()).map(e=>{const t=Object.entries(e.professionTimeMs||{}).map(([s,M])=>({profession:s,timeMs:Number(M||0)})).filter(s=>s.profession&&s.profession!=="Unknown"&&s.timeMs>0).sort((s,M)=>{const a=M.timeMs-s.timeMs;return a!==0?a:s.profession.localeCompare(M.profession)});return{account:e.account||"Unknown",characterNames:Array.from(e.characterNames||[]).filter(Boolean).sort((s,M)=>s.localeCompare(M)),classTimes:t,combatTimeMs:Number(e.squadActiveMs||e.totalFightMs||0),squadTimeMs:(()=>{const s=Number(e.firstSeenFightTs||0),M=Number(e.lastSeenFightTs||0),a=Math.max(0,Number(e.lastSeenFightDurationMs||0));return s>0&&M>0?Math.max(0,M+a-s):Number(e.squadActiveMs||e.totalFightMs||0)})()}}).filter(e=>e.account&&e.account!=="Unknown").sort((e,t)=>{const s=t.squadTimeMs-e.squadTimeMs;return s!==0?s:String(e.account).localeCompare(String(t.account))}),Xi=Z.map(e=>e).sort((e,t)=>ze(e.details,e)-ze(t.details,t)).map((e,t)=>{const s=e==null?void 0:e.details,M=Array.isArray(s==null?void 0:s.players)?s.players.filter(D=>!(D!=null&&D.notInSquad)):[],a=new Map;M.forEach(D=>{const Y=Number(D==null?void 0:D.group),K=Number.isFinite(Y)&&Y>0?Y:0;a.has(K)||a.set(K,{party:K,players:[],classCounts:{}});const ee=tt((D==null?void 0:D.profession)||(D==null?void 0:D.name)||"Unknown"),te=String((D==null?void 0:D.account)||"Unknown"),B=String((D==null?void 0:D.name)||(D==null?void 0:D.character_name)||""),N=!!(D!=null&&D.hasCommanderTag),H=a.get(K);H.players.push({account:te,characterName:B,profession:ee,isCommander:N}),H.classCounts[ee]=(H.classCounts[ee]||0)+1});const L=Array.from(a.values()).map(D=>({...D,players:D.players.sort((Y,K)=>{const ee=+!!K.isCommander-+!!Y.isCommander;if(ee!==0)return ee;const te=String(Y.profession).localeCompare(String(K.profession));return te!==0?te:String(Y.account).localeCompare(String(K.account))})})).sort((D,Y)=>D.party===0&&Y.party!==0?1:Y.party===0&&D.party!==0?-1:D.party-Y.party);return{id:String((e==null?void 0:e.filePath)||(e==null?void 0:e.id)||`fight-${t+1}`),label:`F${t+1}`,timestamp:ze(s,e),mapName:ct(s,e),duration:Tt(Number((s==null?void 0:s.durationMS)||0)),parties:L}}),Zi=(e,t)=>{const s=(t==null?void 0:t.skillMap)||{},M=(t==null?void 0:t.buffMap)||{};let a=0,L=0,D="";const Y=te=>{const B=Number(te);if(!Number.isFinite(B))return String(te||"Unknown Skill");const N=(s==null?void 0:s[`s${B}`])||(s==null?void 0:s[`${B}`]);if(N!=null&&N.name)return String(N.name);const H=(M==null?void 0:M[`b${B}`])||(M==null?void 0:M[`${B}`]);return H!=null&&H.name?String(H.name):`Skill ${B}`},K=te=>{if(!te||typeof te!="object")return;const B=[Number(te.max),Number(te.maxDamage),Number(te.maxHit)].filter(d=>Number.isFinite(d)),N=B.length>0?Math.max(...B):0;N>a&&(a=N,D=Y(te.id));const H=Number(te.downContribution||0);H>L&&(L=H)};let ee=!1;return Array.isArray(e==null?void 0:e.targetDamageDist)&&e.targetDamageDist.forEach(te=>{Array.isArray(te)&&te.forEach(B=>{Array.isArray(B)&&B.forEach(N=>{ee=!0,K(N)})})}),(!ee||a<=0)&&Array.isArray(e==null?void 0:e.totalDamageDist)&&e.totalDamageDist.forEach(te=>{Array.isArray(te)&&te.forEach(B=>K(B))}),{peak:a,peakDownContribution:L,skillName:D||"Unknown Skill"}},yi=(()=>{const e=d=>String(d||"").replace(/^Detailed\s*WvW\s*-\s*/i,"").replace(/^World\s*vs\s*World\s*-\s*/i,"").replace(/^WvW\s*-\s*/i,"").trim(),t=d=>e(d).toLowerCase().split(/[^a-z0-9]+/i).map(x=>x.trim()).filter(Boolean).map(x=>x.length>3&&x.endsWith("s")?x.slice(0,-1):x),s=(d,x)=>{const U=e(d),X=e(x);if(!X)return U;if(!U)return X;const f=t(U),b=t(X),S=new Set(f),w=new Set(b),T=b.length>0&&b.every(u=>S.has(u)),v=f.length>0&&f.every(u=>w.has(u));return T||v?U:`${U} - ${X}`},M=[],a=new Map,L=d=>{const x=T=>{if(!Array.isArray(T)||T.length===0)return[];const v=[];for(let u=0;u<T.length;u+=1){const q=Number(T[u]||0),j=u>0?Number(T[u-1]||0):0;v.push(Math.max(0,q-j))}return v},U=T=>{if(!Array.isArray(T))return[];const v=T.reduce((q,j)=>Math.max(q,Array.isArray(j)?j.length:0),0);if(v<=0)return[];const u=new Array(v).fill(0);return T.forEach(q=>{if(Array.isArray(q))for(let j=0;j<v;j+=1)u[j]+=Number(q[j]||0)}),u},X=T=>Array.isArray(T)?T.map(v=>Number(v||0)):null,b=(T=>{if(!Array.isArray(T)||T.length===0)return null;const v=T[0];if(!Array.isArray(v))return null;if(Array.isArray(v[0])&&Array.isArray(v[0][0]))return U(v);if(Array.isArray(v[0])&&!Array.isArray(v[0][0])){const u=T.map(q=>X(Array.isArray(q)?q[0]:null)).filter(q=>Array.isArray(q)&&q.length>0);if(u.length>0)return U(u)}return null})(d==null?void 0:d.targetDamage1S),S=Array.isArray(d==null?void 0:d.damage1S)&&Array.isArray(d.damage1S[0])?d.damage1S[0]:null,w=b||(Array.isArray(S)?S.map(T=>Number(T||0)):[]);return x(w)},D=(d,x)=>{if(!Array.isArray(d)||d.length===0||x<=0)return 0;let U=0,X=0;for(let f=0;f<d.length;f+=1)U+=Number(d[f]||0),f>=x&&(U-=Number(d[f-x]||0)),f>=x-1&&U>X&&(X=U);return Math.max(0,X)},Y=(d,x)=>{if(!Array.isArray(d)||d.length===0||x<=0)return[];const U=[];for(let X=0;X<d.length;X+=x){const f=Math.min(X+x,d.length),b=d.slice(X,f).reduce((S,w)=>S+Number(w||0),0);U.push(b)}return U},K=(d,x)=>{let U=0,X=0;const f=new Map,b=w=>{if(!w||typeof w!="object"||w.indirectDamage)return;const T=Number(w.totalDamage||0),v=Number(w.downContribution||0);!Number.isFinite(T)&&!Number.isFinite(v)||(U+=Number.isFinite(T)?T:0,X+=Number.isFinite(v)?v:0)};return Array.isArray(d==null?void 0:d.targetDamageDist)&&d.targetDamageDist.forEach(w=>{Array.isArray(w)&&w.forEach(T=>{Array.isArray(T)&&T.forEach(v=>{const u=Number(v==null?void 0:v.id);if(Number.isFinite(u)){const q=f.get(u)||{damage:0,downContribution:0};q.damage+=Number((v==null?void 0:v.totalDamage)||0),q.downContribution+=Number((v==null?void 0:v.downContribution)||0),f.set(u,q)}b(v)})})}),!(x!=null&&x.detailedWvW)&&Array.isArray(d==null?void 0:d.totalDamageDist)&&d.totalDamageDist.forEach(w=>{Array.isArray(w)&&w.forEach(T=>{const v=Number(T==null?void 0:T.id);if(!Number.isFinite(v)){b(T);return}const u=f.get(v);if(!u){b(T);return}const q=Number((T==null?void 0:T.totalDamage)||0)-Number(u.damage||0),j=Number((T==null?void 0:T.downContribution)||0)-Number(u.downContribution||0);q<=0&&j<=0||b({...T,totalDamage:Math.max(0,q),downContribution:Math.max(0,j)})})}),{damageTotal:Math.max(0,U),downContributionTotal:Math.max(0,X)}},ee=(d,x)=>{const U=Number(d);if(!Number.isFinite(U))return{name:String(d||"Unknown Skill"),icon:void 0};const X=(x==null?void 0:x.skillMap)||{},f=(x==null?void 0:x.buffMap)||{},b=(X==null?void 0:X[`s${U}`])||(X==null?void 0:X[`${U}`]);if(b!=null&&b.name)return{name:String(b.name),icon:b==null?void 0:b.icon};const S=(f==null?void 0:f[`b${U}`])||(f==null?void 0:f[`${U}`]);return S!=null&&S.name?{name:String(S.name),icon:S==null?void 0:S.icon}:{name:`Skill ${U}`,icon:void 0}},te=d=>Array.isArray(d)?d.map(x=>Array.isArray(x)?[Number(x[0]),Number(x[1])]:x&&typeof x=="object"?[Number(x.time),Number(x.value)]:null).filter(x=>!!x&&Number.isFinite(x[0])&&x[0]>=0):[],B=(d,x,U,X,f)=>{if(!d.length||X<=0)return[];const b=Math.max(X*5e3,f||0),S=c=>c.reduce((_,Q)=>Q>=0&&Q<=b+2e3?_+1:_,0),w=d.map(c=>Number(c||0)).filter(c=>Number.isFinite(c)&&c>=0);if(!w.length)return[];const T=[w],v=w.reduce((c,_)=>Math.max(c,_),0),u=w.reduce((c,_)=>Math.min(c,_),Number.POSITIVE_INFINITY);v>b*20&&T.push(w.map(c=>c/1e3)),v<=b*2&&u>=0&&v>0&&v<Math.max(120,X*5+10)&&T.push(w.map(c=>c*1e3));let q=w,j=0,o=-1;return T.forEach(c=>{const _=c.reduce((m,i)=>Math.min(m,i),Number.POSITIVE_INFINITY),Q=new Set([0,...x,...U]);if(Number.isFinite(_)&&b>0&&_>b){const m=Math.floor(_/b)*b;Q.add(m),Q.add(Math.max(0,m-b))}Q.forEach(m=>{const i=c.map(l=>l-m),ne=S(i);ne>o&&(o=ne,j=m,q=c)})}),q.map(c=>c-j).filter(c=>Number.isFinite(c)&&c>=0)},N=(d,x,U,X,f)=>{const b=B(d,x,U,X,f);return Array.from(new Set(b.map(S=>Math.floor(S/5e3)).filter(S=>Number.isFinite(S)&&S>=0&&S<X)))};Z.map(d=>({log:d,ts:ze(d==null?void 0:d.details,d)})).sort((d,x)=>d.ts-x.ts).forEach(({log:d},x)=>{const U=d==null?void 0:d.details;if(!U)return;const X=e(U.fightName||d.fightName||`Fight ${x+1}`),f=ct(U,d),b=s(X,String(f||"")),S={},w=Array.isArray(U.players)?U.players:[],T=w.flatMap(m=>{const i=m==null?void 0:m.combatReplayData;return Array.isArray(i)?i.map(ne=>Number(ne==null?void 0:ne.start)):[Number(i==null?void 0:i.start)]}).filter(m=>Number.isFinite(m)&&m>=0);w.forEach(m=>{if(m!=null&&m.notInSquad)return;const i=String((m==null?void 0:m.account)||(m==null?void 0:m.name)||"Unknown"),ne=String((m==null?void 0:m.character_name)||(m==null?void 0:m.display_name)||(m==null?void 0:m.name)||""),l=String((m==null?void 0:m.profession)||"Unknown"),p=`${i}|${l}`,R=Zi(m,U),G=Number(R.peak||0),P=Number(R.peakDownContribution||0),A=L(m),{damageTotal:$,downContributionTotal:W}=K(m,U),y=$>0?Math.min(1,Math.max(0,W/$)):0,se=A.map(g=>Number(g||0)*y),le=Number(D(A,1)||0),ke=Number(D(A,5)||0),Ae=Number(D(A,30)||0),xe=Number(D(se,1)||0),Me=Number(D(se,5)||0),$e=Number(D(se,30)||0),qe=Math.max(0,Math.ceil(Number((U==null?void 0:U.durationMS)||0)/5e3)),Ee=Math.max(0,Math.ceil(A.length/5)),Xe=Math.max(0,Math.ceil(se.length/5)),Ue=Math.max(qe,Ee,Xe),Je=Y(A,5),lt=Y(se,5),ut=Array.from({length:Ue},(g,C)=>Number(Je[C]||0)),_t=Array.from({length:Ue},(g,C)=>Number(lt[C]||0)),ft=new Map,mt=g=>{if(!g||typeof g!="object"||g.indirectDamage)return;const C=Number(g.totalDamage||0),V=Number(g.downContribution||0);if((!Number.isFinite(C)||C<=0)&&(!Number.isFinite(V)||V<=0))return;const ue=Number(g.connectedHits||g.hits||0),be=ee(g.id,U),Fe=be.name,Be=ft.get(Fe)||{skillName:Fe,damage:0,downContribution:0,hits:0,icon:be.icon};Be.damage+=Number.isFinite(C)?C:0,Be.downContribution+=Number.isFinite(V)?V:0,Be.hits+=Number.isFinite(ue)?ue:0,!Be.icon&&be.icon&&(Be.icon=be.icon),ft.set(Fe,Be)},dt=new Map;Array.isArray(m==null?void 0:m.targetDamageDist)&&m.targetDamageDist.forEach(g=>{Array.isArray(g)&&g.forEach(C=>{Array.isArray(C)&&C.forEach(V=>{const ue=Number(V==null?void 0:V.id),be=Number((V==null?void 0:V.totalDamage)||0),Fe=Number((V==null?void 0:V.downContribution)||0);if(Number.isFinite(ue)){const Be=dt.get(ue)||{damage:0,downContribution:0,hits:0};Be.damage+=Number.isFinite(be)?be:0,Be.downContribution+=Number.isFinite(Fe)?Fe:0,Be.hits+=Number((V==null?void 0:V.connectedHits)||(V==null?void 0:V.hits)||0),dt.set(ue,Be)}mt(V)})})}),!(U!=null&&U.detailedWvW)&&Array.isArray(m==null?void 0:m.totalDamageDist)&&m.totalDamageDist.forEach(g=>{Array.isArray(g)&&g.forEach(C=>{const V=Number(C==null?void 0:C.id);if(!Number.isFinite(V)){mt(C);return}const ue=dt.get(V);if(!ue){mt(C);return}const be=Number((C==null?void 0:C.totalDamage)||0),Fe=Number((C==null?void 0:C.downContribution)||0),Be=Number((C==null?void 0:C.connectedHits)||(C==null?void 0:C.hits)||0),nt=be-Number(ue.damage||0),Ye=Fe-Number(ue.downContribution||0),et=Be-Number(ue.hits||0);nt<=0&&Ye<=0&&et<=0||mt({...C,totalDamage:Math.max(0,nt),downContribution:Math.max(0,Ye),connectedHits:Math.max(0,et),hits:Math.max(0,et)})})});const gt=(()=>{const g=m==null?void 0:m.combatReplayData;return Array.isArray(g)?g.filter(C=>C&&typeof C=="object"):g&&typeof g=="object"?[g]:[]})(),Dt=gt.map(g=>Number(g==null?void 0:g.start)).filter(g=>Number.isFinite(g)&&g>=0),Ut=gt.flatMap(g=>te(g==null?void 0:g.down).map(([C])=>Number(C||0))),E=gt.flatMap(g=>te(g==null?void 0:g.dead).map(([C])=>Number(C||0)));S[p]={hit:G,burst1s:le,burst5s:ke,burst30s:Ae,hitDown:P,burst1sDown:xe,burst5sDown:Me,burst30sDown:$e,skillName:R.skillName,buckets5s:ut,buckets5sDown:_t,downIndices5s:N(Ut,Dt,T,Ue,Number((U==null?void 0:U.durationMS)||0)),deathIndices5s:N(E,Dt,T,Ue,Number((U==null?void 0:U.durationMS)||0)),skillRows:Array.from(ft.values()).sort((g,C)=>C.damage-g.damage).slice(0,50)};const F=a.get(p)||{key:p,account:i,displayName:i,characterName:ne,profession:l,professionList:[l],logs:0,peakHit:0,peak1s:0,peak5s:0,peak30s:0,peakHitDown:0,peak1sDown:0,peak5sDown:0,peak30sDown:0,peakFightLabel:"",peakSkillName:""};F.logs+=1,F.professionList.includes(l)||F.professionList.push(l),!F.characterName&&ne&&(F.characterName=ne),G>F.peakHit&&(F.peakHit=G,F.peakFightLabel=b,F.peakSkillName=R.skillName),le>F.peak1s&&(F.peak1s=le),ke>F.peak5s&&(F.peak5s=ke),Ae>F.peak30s&&(F.peak30s=Ae),P>F.peakHitDown&&(F.peakHitDown=P),xe>F.peak1sDown&&(F.peak1sDown=xe),Me>F.peak5sDown&&(F.peak5sDown=Me),$e>F.peak30sDown&&(F.peak30sDown=$e),a.set(p,F)});const v=Object.values(S).reduce((m,i)=>Math.max(m,Number((i==null?void 0:i.hit)||0)),0),u=Object.values(S).reduce((m,i)=>Math.max(m,Number((i==null?void 0:i.burst1s)||0)),0),q=Object.values(S).reduce((m,i)=>Math.max(m,Number((i==null?void 0:i.burst5s)||0)),0),j=Object.values(S).reduce((m,i)=>Math.max(m,Number((i==null?void 0:i.burst30s)||0)),0),o=Object.values(S).reduce((m,i)=>Math.max(m,Number((i==null?void 0:i.hitDown)||0)),0),c=Object.values(S).reduce((m,i)=>Math.max(m,Number((i==null?void 0:i.burst1sDown)||0)),0),_=Object.values(S).reduce((m,i)=>Math.max(m,Number((i==null?void 0:i.burst5sDown)||0)),0),Q=Object.values(S).reduce((m,i)=>Math.max(m,Number((i==null?void 0:i.burst30sDown)||0)),0);M.push({id:d.filePath||d.id||`fight-${x+1}`,shortLabel:`F${x+1}`,fullLabel:b,timestamp:ze(U,d),values:S,maxHit:v,max1s:u,max5s:q,max30s:j,maxHitDown:o,max1sDown:c,max5sDown:_,max30sDown:Q})});const H=Array.from(a.values()).sort((d,x)=>x.peakHit!==d.peakHit?x.peakHit-d.peakHit:d.displayName.localeCompare(x.displayName));return{fights:M,players:H}})(),es=(()=>{const e=f=>String(f||"").replace(/^Detailed\s*WvW\s*-\s*/i,"").replace(/^World\s*vs\s*World\s*-\s*/i,"").replace(/^WvW\s*-\s*/i,"").trim(),t=f=>e(f).toLowerCase().split(/[^a-z0-9]+/i).map(b=>b.trim()).filter(Boolean).map(b=>b.length>3&&b.endsWith("s")?b.slice(0,-1):b),s=(f,b)=>{const S=e(f),w=e(b);if(!w)return S;if(!S)return w;const T=t(S),v=t(w),u=new Set(T),q=new Set(v),j=v.length>0&&v.every(c=>u.has(c)),o=T.length>0&&T.every(c=>q.has(c));return j||o?S:`${S} - ${w}`},M=[],a=new Map,L=(f,b)=>{const S=Number(f);if(!Number.isFinite(S))return{name:String(f||"Unknown Skill"),icon:void 0};const w=(b==null?void 0:b.skillMap)||{},T=(b==null?void 0:b.buffMap)||{},v=(w==null?void 0:w[`s${S}`])||(w==null?void 0:w[`${S}`]);if(v!=null&&v.name)return{name:String(v.name),icon:v==null?void 0:v.icon};const u=(T==null?void 0:T[`b${S}`])||(T==null?void 0:T[`${S}`]);return u!=null&&u.name?{name:String(u.name),icon:u==null?void 0:u.icon}:{name:`Skill ${S}`,icon:void 0}},D=(f,b)=>{let S=0,w="";const T=v=>{if(!v||typeof v!="object"||v.indirectDamage)return;const u=[Number(v.max),Number(v.maxDamage),Number(v.maxHit)].filter(j=>Number.isFinite(j)),q=u.length>0?Math.max(...u):0;q>S&&(S=q,w=L(v.id,b).name)};return Array.isArray(f==null?void 0:f.totalDamageDist)&&f.totalDamageDist.forEach(v=>{Array.isArray(v)&&v.forEach(u=>T(u))}),Array.isArray(f==null?void 0:f.targetDamageDist)&&f.targetDamageDist.forEach(v=>{Array.isArray(v)&&v.forEach(u=>{Array.isArray(u)&&u.forEach(q=>T(q))})}),{peak:S,skillName:w||"Unknown Skill"}},Y=f=>{if(!Array.isArray(f)||f.length===0)return[];const b=[];for(let S=0;S<f.length;S+=1){const w=Number(f[S]||0),T=S>0?Number(f[S-1]||0):0;b.push(Math.max(0,w-T))}return b},K=f=>{if(!Array.isArray(f)||f.length===0)return[];const b=f.reduce((w,T)=>Math.max(w,Array.isArray(T)?T.length:0),0);if(b<=0)return[];const S=new Array(b).fill(0);return f.forEach(w=>{if(Array.isArray(w))for(let T=0;T<b;T+=1)S[T]+=Number(w[T]||0)}),S},ee=f=>{if(!Array.isArray(f)||f.length===0)return[];const b=f[0];if(typeof b=="number")return f.map(S=>Number(S||0));if(Array.isArray(b)&&b.length>0){if(typeof b[0]=="number")return b.map(S=>Number(S||0));if(Array.isArray(b[0])){const S=b.map(w=>Array.isArray(w)?w.map(T=>Number(T||0)):null).filter(w=>Array.isArray(w)&&w.length>0);if(S.length>0)return K(S)}}return[]},te=f=>{const b=ee(f==null?void 0:f.powerDamage1S),S=ee(f==null?void 0:f.damage1S),w=b.length>0?b:S;return Y(w)},B=(f,b)=>{const S=f==null?void 0:f.targetPowerDamage1S;if(!Array.isArray(S)||!Array.isArray(S[b]))return[];const w=S[b];if(!Array.isArray(w)||w.length===0)return[];if(typeof w[0]=="number")return w.map(T=>Number(T||0));if(Array.isArray(w[0])&&!Array.isArray(w[0][0]))return w[0].map(T=>Number(T||0));if(Array.isArray(w[0])&&Array.isArray(w[0][0])){const v=w[0].map(u=>Array.isArray(u)?u.map(q=>Number(q||0)):null).filter(u=>Array.isArray(u)&&u.length>0);return K(v)}return[]},N=(f,b)=>{if(!Array.isArray(f)||f.length===0||b<=0)return 0;let S=0,w=0;for(let T=0;T<f.length;T+=1)S+=Number(f[T]||0),T>=b&&(S-=Number(f[T-b]||0)),T>=b-1&&S>w&&(w=S);return Math.max(0,w)},H=(f,b)=>{if(!Array.isArray(f)||f.length===0||b<=0)return[];const S=[];for(let w=0;w<f.length;w+=b){const T=Math.min(w+b,f.length),v=f.slice(w,T).reduce((u,q)=>u+Number(q||0),0);S.push(v)}return S},d=f=>Array.isArray(f)?f.map(b=>Array.isArray(b)?[Number(b[0]),Number(b[1])]:b&&typeof b=="object"?[Number(b.time),Number(b.value)]:null).filter(b=>!!b&&Number.isFinite(b[0])&&b[0]>=0):[],x=(f,b,S,w,T)=>{if(!f.length||w<=0)return[];const v=Math.max(w*5e3,T||0),u=i=>i.reduce((ne,l)=>l>=0&&l<=v+2e3?ne+1:ne,0),q=f.map(i=>Number(i||0)).filter(i=>Number.isFinite(i)&&i>=0);if(!q.length)return[];const j=[q],o=q.reduce((i,ne)=>Math.max(i,ne),0),c=q.reduce((i,ne)=>Math.min(i,ne),Number.POSITIVE_INFINITY);o>v*20&&j.push(q.map(i=>i/1e3)),o<=v*2&&c>=0&&o>0&&o<Math.max(120,w*5+10)&&j.push(q.map(i=>i*1e3));let _=q,Q=0,m=-1;return j.forEach(i=>{const ne=i.reduce((p,R)=>Math.min(p,R),Number.POSITIVE_INFINITY),l=new Set([0,...b,...S]);if(Number.isFinite(ne)&&v>0&&ne>v){const p=Math.floor(ne/v)*v;l.add(p),l.add(Math.max(0,p-v))}l.forEach(p=>{const R=i.map(P=>P-p),G=u(R);G>m&&(m=G,Q=p,_=i)})}),_.map(i=>i-Q).filter(i=>Number.isFinite(i)&&i>=0)},U=(f,b,S,w,T)=>{const v=x(f,b,S,w,T);return Array.from(new Set(v.map(u=>Math.floor(u/5e3)).filter(u=>Number.isFinite(u)&&u>=0&&u<w)))};Z.map(f=>({log:f,ts:ze(f==null?void 0:f.details,f)})).sort((f,b)=>f.ts-b.ts).forEach(({log:f},b)=>{const S=f==null?void 0:f.details;if(!S)return;const w=e(S.fightName||f.fightName||`Fight ${b+1}`),T=ct(S,f),v=s(w,String(T||"")),u={},j=(Array.isArray(S.players)?S.players:[]).filter(A=>!(A!=null&&A.notInSquad)),o=j.flatMap(A=>{const $=A==null?void 0:A.combatReplayData;return Array.isArray($)?$.map(W=>Number(W==null?void 0:W.start)):[Number($==null?void 0:$.start)]}).filter(A=>Number.isFinite(A)&&A>=0),c=j.flatMap(A=>{const $=A==null?void 0:A.combatReplayData;return(Array.isArray($)?$:$?[$]:[]).flatMap(y=>d(y==null?void 0:y.down).map(([se])=>Number(se||0)))}),_=j.flatMap(A=>{const $=A==null?void 0:A.combatReplayData;return(Array.isArray($)?$:$?[$]:[]).flatMap(y=>d(y==null?void 0:y.dead).map(([se])=>Number(se||0)))}),Q=new Map,m=new Map,i=new Map;(Array.isArray(S.targets)?S.targets:[]).forEach((A,$)=>{if(!A||A.isFake||!A.enemyPlayer)return;const W=tt((A==null?void 0:A.profession)||(A==null?void 0:A.name)||(A==null?void 0:A.id))||"Unknown";i.set(W,(i.get(W)||0)+1);const y=m.get(W)||new Map;Array.isArray(A==null?void 0:A.totalDamageDist)&&A.totalDamageDist.forEach(Me=>{Array.isArray(Me)&&Me.forEach($e=>{if(!$e||typeof $e!="object"||$e.indirectDamage)return;const qe=Number($e.totalDamage||0);if(!Number.isFinite(qe)||qe<=0)return;const Ee=Number($e.connectedHits||$e.hits||0),Xe=L($e.id,S),Ue=Xe.name,Je=y.get(Ue)||{skillName:Ue,damage:0,hits:0,icon:Xe.icon};Je.damage+=qe,Je.hits+=Number.isFinite(Ee)?Ee:0,!Je.icon&&Xe.icon&&(Je.icon=Xe.icon),y.set(Ue,Je)})}),m.set(W,y);const se=K(j.map(Me=>B(Me,$))),le=se.length>0?Y(se):te(A),ke=D(A,S);let Ae=Q.get(W);Ae||(Ae={perSecond:[],hit:0,skillName:""},Q.set(W,Ae)),le.length>Ae.perSecond.length&&(Ae.perSecond.length=le.length);for(let Me=0;Me<le.length;Me+=1)Ae.perSecond[Me]=Number(Ae.perSecond[Me]||0)+Number(le[Me]||0);const xe=Number(ke.peak||0);xe>Ae.hit&&(Ae.hit=xe,Ae.skillName=ke.skillName||"Unknown Skill")});const l=Array.from(Q.values()).some(A=>Array.isArray(A.perSecond)&&A.perSecond.some($=>Number($||0)>0));if(Q.size===0||!l){const A=K(j.map(W=>{const y=ee(W==null?void 0:W.powerDamageTaken1S);return Y(y)})),$=Array.from(i.values()).reduce((W,y)=>W+Number(y||0),0);A.length>0&&$>0&&i.forEach((W,y)=>{const se=Number(W||0)/$,le=A.map(Ae=>Number(Ae||0)*se),ke=Q.get(y);Q.set(y,{perSecond:le,hit:Number((ke==null?void 0:ke.hit)||0),skillName:String((ke==null?void 0:ke.skillName)||"")})})}Q.forEach((A,$)=>{var Xe;const W=$,y=Number(A.hit||0),se=Number(N(A.perSecond,1)||0),le=Number(N(A.perSecond,5)||0),ke=Number(N(A.perSecond,30)||0),Ae=Math.max(0,Math.ceil(Number((S==null?void 0:S.durationMS)||0)/5e3)),xe=Math.max(0,Math.ceil(A.perSecond.length/5)),Me=Math.max(Ae,xe),$e=H(A.perSecond,5),qe=Array.from({length:Me},(Ue,Je)=>Number($e[Je]||0));u[W]={hit:y,burst1s:se,burst5s:le,burst30s:ke,skillName:A.skillName||"Unknown Skill",buckets5s:qe,downIndices5s:U(c,[],o,Me,Number((S==null?void 0:S.durationMS)||0)),deathIndices5s:U(_,[],o,Me,Number((S==null?void 0:S.durationMS)||0)),skillRows:Array.from(((Xe=m.get($))==null?void 0:Xe.values())||[]).sort((Ue,Je)=>Je.damage-Ue.damage).slice(0,50)};const Ee=a.get(W)||{key:W,account:$,displayName:$,characterName:"",profession:$,professionList:[$],logs:0,peakHit:0,peak1s:0,peak5s:0,peak30s:0,peakFightLabel:"",peakSkillName:""};Ee.logs+=1,y>Ee.peakHit&&(Ee.peakHit=y,Ee.peakFightLabel=v,Ee.peakSkillName=A.skillName||"Unknown Skill"),se>Ee.peak1s&&(Ee.peak1s=se),le>Ee.peak5s&&(Ee.peak5s=le),ke>Ee.peak30s&&(Ee.peak30s=ke),a.set(W,Ee)});const p=Object.values(u).reduce((A,$)=>Math.max(A,Number(($==null?void 0:$.hit)||0)),0),R=Object.values(u).reduce((A,$)=>Math.max(A,Number(($==null?void 0:$.burst1s)||0)),0),G=Object.values(u).reduce((A,$)=>Math.max(A,Number(($==null?void 0:$.burst5s)||0)),0),P=Object.values(u).reduce((A,$)=>Math.max(A,Number(($==null?void 0:$.burst30s)||0)),0);M.push({id:f.filePath||f.id||`fight-${b+1}`,shortLabel:`F${b+1}`,fullLabel:v,timestamp:ze(S,f),values:u,maxHit:p,max1s:R,max5s:G,max30s:P})});const X=Array.from(a.values()).sort((f,b)=>b.peakHit!==f.peakHit?b.peakHit-f.peakHit:f.displayName.localeCompare(b.displayName));return{fights:M,players:X}})(),ts=Array.from(Ke.entries()).map(([e,t])=>{const s=He.get(e)||{},M=Array.from(t.values()).map(a=>{var N,H;const L=Array.from(a.professions||[]).filter(d=>d&&d!=="Unknown");let D=a.profession||"Unknown";if(L.length>0){D=L[0];let d=((N=a.professionTimeMs)==null?void 0:N[D])||0;L.forEach(x=>{var X;const U=((X=a.professionTimeMs)==null?void 0:X[x])||0;U>d&&(d=U,D=x)})}const Y=a.durationMs||0,K=a.totalMs/1e3,ee=Y>0?a.totalMs/Y:0,te=((H=me.get(a.account))==null?void 0:H.supportActiveMs)||Y,B=te>0?a.uptimeMs/te:0;return{account:a.account,profession:D,professionList:L,total:K,perSecond:ee,uptimePerSecond:B,duration:Y/1e3}}).filter(a=>a.total>0||a.perSecond>0);return{id:e,name:s.name||e,icon:s.icon,rows:M}}).filter(e=>e.rows.length>0),ns=Array.from(Oe.values()).map(e=>{const t=Array.from(e.skills.values()).sort((M,a)=>a.damage-M.damage);return{key:e.key,account:e.account,displayName:e.displayName,profession:e.profession,professionList:e.professionList,totalFightMs:e.totalFightMs,skills:t}}).sort((e,t)=>e.displayName.localeCompare(t.displayName));return{total:oe,wins:we,losses:Ie,avgSquadSize:wi,avgEnemies:Ti,squadKDR:Fi,enemyKDR:Bi,totalSquadKills:k,totalSquadDeaths:Qe,totalEnemyKills:fe,totalEnemyDeaths:ce,leaderboards:Pe,...xi,outgoingConditionSummary:Object.values(We).sort((e,t)=>t.damage-e.damage),incomingConditionSummary:Object.values(Ge).sort((e,t)=>t.damage-e.damage),outgoingConditionPlayers:Array.from(me.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,conditions:e.outgoingConditions})),incomingConditionPlayers:Array.from(me.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,conditions:e.incomingConditions})),topSkills:Pi,topIncomingSkills:qi,topSkillsByDamage:In,topSkillsByDownContribution:Ln,playerSkillBreakdowns:ns,topSkillsMetric:de,mapData:Hi,timelineData:zi,boonTables:ji,boonTimeline:Wi,offensePlayers:Array.from(me.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,offenseTotals:e.offenseTotals,offenseRateWeights:e.offenseRateWeights,totalFightMs:e.totalFightMs})),defensePlayers:Array.from(me.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,defenseTotals:e.defenseTotals,activeMs:e.defenseActiveMs,minionDamageTakenByMinion:e.defenseMinionDamageTaken})),damageMitigationPlayers:Ei,damageMitigationMinions:vi,supportPlayers:Array.from(me.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,supportTotals:e.supportTotals,activeMs:e.supportActiveMs})),healingPlayers:Array.from(me.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,healingTotals:e.healingTotals,activeMs:e.healingActiveMs})),mvp:Vt,silver:Bn,bronze:En,squadClassData:Vi,enemyClassData:Gi,fightBreakdown:Ji,fightDiffMode:Yi,attendanceData:Qi,squadCompByFight:Xi,spikeDamage:yi,incomingStrikeDamage:es,specialTables:ts,topStatsPerSecond:at,topStatsLeaderboardsPerSecond:ot,avgMvpScore:vn}})(),Re=(()=>{const J=new Map,ie=new Map,de=[],oe=new Map,we=new Map;Z.forEach(re=>{const De=re.details;if(!De)return;const Qe=De.skillMap||{},k=De.fightName||"Log",ce=ze(De,re)||Date.now(),fe={id:re.filePath||re.id||k,label:k,timestamp:ce,skillEntries:{},playerActiveSeconds:{},durationSeconds:De.durationMS?De.durationMS/1e3:0};(De.players||[]).forEach(Se=>{if(Se.notInSquad)return;const me=Se.account||Se.name||"Unknown",_e=Se.profession||"Unknown",ge=`${me}|${_e}`;let Ce=ie.get(ge);Ce||(Ce={key:ge,account:me,displayName:me,profession:_e,professionList:[_e],logs:0,totalActiveSeconds:0,skillTotals:{}},ie.set(ge,Ce)),Ce.logs++;const Oe=(Array.isArray(Se.activeTimes)?Se.activeTimes[0]:0)/1e3;Ce.totalActiveSeconds=(Ce.totalActiveSeconds||0)+Oe,fe.playerActiveSeconds[ge]=Oe,(Se.rotation||[]).forEach(We=>{var vt,It,Lt;if(!(We!=null&&We.id))return;const Ge=((vt=We.skills)==null?void 0:vt.length)||0;if(Ge<=0)return;const Le=`s${We.id}`,He=((It=Qe[Le])==null?void 0:It.name)||`Skill ${We.id}`,Ke=(Lt=Qe[Le])==null?void 0:Lt.icon;Ce.skillTotals[Le]=(Ce.skillTotals[Le]||0)+Ge,J.set(Le,(J.get(Le)||0)+Ge),oe.set(Le,He),Ke&&!we.has(Le)&&we.set(Le,Ke),fe.skillEntries[Le]||(fe.skillEntries[Le]={name:He,icon:Ke,players:{}}),!fe.skillEntries[Le].icon&&Ke&&(fe.skillEntries[Le].icon=Ke),fe.skillEntries[Le].players[ge]=(fe.skillEntries[Le].players[ge]||0)+Ge})}),de.push(fe)});const Ie=Array.from(J.entries()).map(([re,De])=>({id:re,name:oe.get(re)||re,total:De,icon:we.get(re)})).sort((re,De)=>De.total-re.total);return{logRecords:de,players:Array.from(ie.values()),skillOptions:Ie,resUtilitySkills:[]}})();return{validLogs:Z,stats:je,skillUsageData:Re}},ht=(n,r)=>{const h={};return r.forEach(O=>{n&&Object.prototype.hasOwnProperty.call(n,O)&&(h[O]=n[O])}),h},dn=n=>!!(n&&n.__statsPruned===!0),gn=(n,r)=>{if(!n||typeof n!="object")return n;const h={};return Object.entries(n).forEach(([O,z])=>{if(!z||typeof z!="object")return;const I={};typeof z.name=="string"&&(I.name=z.name),typeof z.icon=="string"&&(I.icon=z.icon),r!=null&&r.includeClassification&&typeof z.classification=="string"&&(I.classification=z.classification),r!=null&&r.includeStacking&&(typeof z.stacking=="boolean"?I.stacking=z.stacking:typeof z.stacking=="number"&&(I.stacking=!!z.stacking)),Object.keys(I).length>0&&(h[O]=I)}),h},bn=n=>{var h;const r=(h=n==null?void 0:n.statsAll)==null?void 0:h[0];return!r||typeof r!="object"?!1:r.distToCom!==void 0&&r.distToCom!=="Infinity"||r.stackDist!==void 0},hi=(n,r)=>{const h=O=>{if(!O||typeof O!="object")return null;const z=ht(O,["start","down","dead"]);return r&&Array.isArray(O.positions)&&(z.positions=O.positions),z};return Array.isArray(n)?n.map(O=>h(O)).filter(O=>!!O):n&&typeof n=="object"?h(n):n},pn=n=>{if(!n||typeof n!="object")return n;const r=ht(n,["players","targets","durationMS","uploadTime","timeStart","timeStartStd","timeEnd","timeEndStd","fightName","zone","mapName","map","location","permalink","uploadLinks","success","teamBreakdown","teamCounts","combatReplayMetaData","skillMap","buffMap","encounterDuration","player_damage_mitigation","player_minion_damage_mitigation","playerDamageMitigation","playerMinionDamageMitigation"]);if(r.skillMap=gn(r.skillMap,{includeClassification:!1,includeStacking:!1}),r.buffMap=gn(r.buffMap,{includeClassification:!0,includeStacking:!0}),Array.isArray(r.players)){const h=n.players,z=h.filter(I=>!(I!=null&&I.notInSquad)).some(I=>!(I!=null&&I.hasCommanderTag)&&!bn(I));r.players=h.map(I=>{const pe=ht(I,["name","display_name","character_name","profession","elite_spec","group","dpsAll","statsAll","dpsTargets","statsTargets","defenses","support","rotation","extHealingStats","extBarrierStats","squadBuffVolumes","selfBuffs","groupBuffs","squadBuffs","selfBuffsActive","groupBuffsActive","squadBuffsActive","buffUptimes","totalDamageDist","targetDamageDist","damage1S","targetDamage1S","powerDamageTaken1S","targetPowerDamage1S","totalDamageTaken","totalDamageTakenDist","hasCommanderTag","notInSquad","account","activeTimes","teamID","teamId","team","teamColor","team_color"]),Z=Array.isArray(I==null?void 0:I.minions)?I.minions:[];pe.minions=Z.map(he=>ht(he,["name","totalDamageTakenDist"]));const ae=z&&((I==null?void 0:I.hasCommanderTag)&&!(I!=null&&I.notInSquad)||!(I!=null&&I.notInSquad)&&!bn(I));return pe.combatReplayData=hi(I==null?void 0:I.combatReplayData,ae),pe})}return Array.isArray(r.targets)&&(r.targets=r.targets.map(h=>ht(h,["id","name","isFake","dpsAll","statsAll","defenses","totalHealth","healthPercentBurned","enemyPlayer","totalDamageDist","totalDamageTaken","totalDamageTakenDist","damageTaken","powerDamage1S","damage1S","profession","teamID","teamId","team","teamColor","team_color"]))),r},ki=n=>{if(!n||typeof n!="object"||dn(n))return n;const r={...n};return n.details?r.details=pn(n.details):r.details=pn(n),r.__statsPruned=!0,r};let Ze=null,hn=0,Ht=0,Bt=null,Et=0,jt=0;const Di=n=>typeof(n==null?void 0:n.token)=="number"&&n.token!==Ht,Ni=n=>{const r=n==null?void 0:n.stats;if(!r||typeof r!="object")return{spikeSkillRowsRemoved:0,incomingSkillRowsRemoved:0,playerSkillMapsRemoved:0};const h=Z=>{let ae=0;return(Array.isArray(Z==null?void 0:Z.fights)?Z.fights:[]).forEach(Ve=>{if(!Ve||typeof Ve!="object")return;const je=Ve.values;!je||typeof je!="object"||Object.values(je).forEach(Re=>{!Re||typeof Re!="object"||Array.isArray(Re.skillRows)&&(delete Re.skillRows,ae+=1)})}),ae},O=h(r.spikeDamage),z=h(r.incomingStrikeDamage);let I=0;return(Array.isArray(r.playerSkillBreakdowns)?r.playerSkillBreakdowns:[]).forEach(Z=>{!Z||typeof Z!="object"||Z.skillMap&&typeof Z.skillMap=="object"&&(delete Z.skillMap,I+=1)}),{spikeSkillRowsRemoved:O,incomingSkillRowsRemoved:z,playerSkillMapsRemoved:I}},Si=()=>{var pe,Z;if(!Ze)return;hn+=1;const n=Bt;Bt=null;const r=performance.now(),h=pi({...Ze,includePlayerSkillMap:!1}),O=Ni(h),z=Math.max(0,performance.now()-r),I=h==null?void 0:h.stats;self.postMessage({type:"result",result:h,computeId:hn,logCount:Ze.logs.length,token:Ht,completedAt:Date.now(),flushId:n,diagnostics:{computeMs:z,logsInPayload:Ze.logs.length,expectedLogCount:Et,droppedLogMessages:jt,transferStripStats:O,counts:{playerSkillBreakdowns:Array.isArray(I==null?void 0:I.playerSkillBreakdowns)?I.playerSkillBreakdowns.length:0,spikeFights:Array.isArray((pe=I==null?void 0:I.spikeDamage)==null?void 0:pe.fights)?I.spikeDamage.fights.length:0,incomingStrikeFights:Array.isArray((Z=I==null?void 0:I.incomingStrikeDamage)==null?void 0:Z.fights)?I.incomingStrikeDamage.fights.length:0}}})};self.onmessage=n=>{var h,O,z,I;const r=n.data;if((r==null?void 0:r.type)==="reset"){Ze={logs:[]},typeof r.token=="number"&&(Ht=r.token),Et=Math.max(0,Number(r.totalLogs||0)),jt=0,Bt=null;return}if(!Di(r)){if((r==null?void 0:r.type)==="settings"){Ze={logs:(Ze==null?void 0:Ze.logs)||[],precomputedStats:(h=r.payload)==null?void 0:h.precomputedStats,mvpWeights:(O=r.payload)==null?void 0:O.mvpWeights,statsViewSettings:(z=r.payload)==null?void 0:z.statsViewSettings,disruptionMethod:(I=r.payload)==null?void 0:I.disruptionMethod};return}if((r==null?void 0:r.type)==="log"){if(Ze||(Ze={logs:[]}),Et>0&&Ze.logs.length>=Et){jt+=1;return}Ze.logs.push(dn(r.payload)?r.payload:ki(r.payload));return}(r==null?void 0:r.type)==="flush"&&(typeof r.flushId=="number"&&(Bt=r.flushId),Si())}}})();
