(function(){"use strict";const Xt=["selfBuffs","groupBuffs","squadBuffs"],Zt=i=>i!=null&&i.classification?i.classification==="Boon":!0,yt=i=>`b${i}`,On=(i,c)=>{const m=Array.isArray(i==null?void 0:i.activeTimes)?i.activeTimes:[],B=typeof m[0]=="number"?m[0]:0;return B>0?B:c},en=(i,c,m,B,O,W,Se)=>{const oe=i==="selfBuffs"?1:Math.max(i==="groupBuffs"?W-1:Se-1,0);return!oe||!O?{generationMs:0,wastedMs:0}:c?{generationMs:m*O*oe,wastedMs:B*O*oe}:{generationMs:m/100*O*oe,wastedMs:B/100*O*oe}},_n=i=>{const c=new Map,m=new Map;return i.forEach(W=>{const Se=W.details;if(!Se)return;const oe=Se.durationMS||0,Ce=Se.buffMap||{};Object.entries(Ce).forEach(([R,V])=>{if(!c.has(R)){c.set(R,V);return}const ke=c.get(R)||{},me={name:ke.name||V.name,stacking:ke.stacking??V.stacking,icon:ke.icon||V.icon,classification:ke.classification||V.classification};c.set(R,me)});const Ke=(Se.players||[]).filter(R=>!R.notInSquad),Ne=Ke.length,De=new Map;Ke.forEach(R=>{const V=R.group??0;De.set(V,(De.get(V)||0)+1)}),Ke.forEach(R=>{const V=R.account||R.name||R.character_name||"Unknown",ke=R.profession||"Unknown",me=R.group??0,L=De.get(me)||1,ce=On(R,oe);m.has(V)||m.set(V,{account:V,profession:ke,professions:new Set,professionTimeMs:{},activeTimeMs:0,numFights:0,groupSupported:0,squadSupported:0,boons:{}});const de=m.get(V);de.profession=ke,ke!=="Unknown"&&(de.professions.add(ke),de.professionTimeMs[ke]=(de.professionTimeMs[ke]||0)+ce),de.activeTimeMs+=ce,de.numFights+=1,de.groupSupported+=L,de.squadSupported+=Ne,Xt.forEach(he=>{(R[he]||[]).forEach(be=>{var Ue,Re,Ie,st;if(typeof(be==null?void 0:be.id)!="number")return;const He=yt(be.id),Fe=Ce[He];if(!Zt(Fe))return;const Ae=(Fe==null?void 0:Fe.stacking)??!1,je=((Re=(Ue=be.buffData)==null?void 0:Ue[0])==null?void 0:Re.generation)??0,Te=((st=(Ie=be.buffData)==null?void 0:Ie[0])==null?void 0:st.wasted)??0,{generationMs:Me,wastedMs:Ve}=en(he,Ae,je,Te,oe,L,Ne);!Me&&!Ve||(c.has(He)||c.set(He,Fe||{}),de.boons[He]||(de.boons[He]={selfBuffs:{generationMs:0,wastedMs:0},groupBuffs:{generationMs:0,wastedMs:0},squadBuffs:{generationMs:0,wastedMs:0}}),de.boons[He][he].generationMs+=Me,de.boons[He][he].wastedMs+=Ve)})})})}),{boonTables:Array.from(c.keys()).filter(W=>Zt(c.get(W))).map(W=>{const Se=c.get(W)||{},oe=[];return m.forEach(Ce=>{var R;const Oe=Ce.boons[W];if(!Oe||!Xt.some(V=>Oe[V].generationMs>0||Oe[V].wastedMs>0))return;const Ne=Array.from(Ce.professions||[]).filter(V=>V&&V!=="Unknown");let De=Ce.profession;if(Ne.length>0){De=Ne[0];let V=((R=Ce.professionTimeMs)==null?void 0:R[De])||0;Ne.forEach(ke=>{var L;const me=((L=Ce.professionTimeMs)==null?void 0:L[ke])||0;me>V&&(V=me,De=ke)})}oe.push({account:Ce.account,profession:De||"Unknown",professionList:Ne,activeTimeMs:Ce.activeTimeMs||1,numFights:Ce.numFights||1,groupSupported:Ce.groupSupported||1,squadSupported:Ce.squadSupported||1,categories:{selfBuffs:{...Oe.selfBuffs},groupBuffs:{...Oe.groupBuffs},squadBuffs:{...Oe.squadBuffs}}})}),{id:W,name:Se.name||W,icon:Se.icon,stacking:Se.stacking??!1,rows:oe}}).filter(W=>W.rows.length>0)}},tn=(i,c,m,B,O,W,Se={})=>{var R,V,ke,me;const Ce=((i==null?void 0:i[c])||[]).find(L=>L.id===m);if(!Ce)return{generationMs:0,wastedMs:0};const Oe=Se[yt(m)],Ke=(Oe==null?void 0:Oe.stacking)??!1,Ne=((V=(R=Ce.buffData)==null?void 0:R[0])==null?void 0:V.generation)??0,De=((me=(ke=Ce.buffData)==null?void 0:ke[0])==null?void 0:me.wasted)??0;return en(c,Ke,Ne,De,B,O,W)};var qn={methods:{tiered:{tiers:{shortMs:500,mediumMs:1500,weights:{short:.5,medium:1,long:2}}}}};const Wn=qn,Ot="count",jn=i=>(i||0)/1e3,Vn=(i,c)=>{var O;if(!i)return 0;const m=(O=Wn.methods.tiered)==null?void 0:O.tiers;if(!m)return i;const B=c/Math.max(i,1);return B<=m.shortMs?i*m.weights.short:B<=m.mediumMs?i*m.weights.medium:i*m.weights.long},nn=(i,c,m)=>m==="duration"?jn(c):m==="tiered"?Vn(i,c):i;function zn(i,c=Ot){var W;const m=(W=i.statsAll)==null?void 0:W[0],B=Number((m==null?void 0:m.appliedCrowdControl)??0),O=Number((m==null?void 0:m.appliedCrowdControlDuration)??0);return nn(B,O,c)}function Kn(i,c){const m=(c==null?void 0:c.durationMS)||0,B=(c==null?void 0:c.buffMap)||{},O=i.filter(oe=>!oe.notInSquad),W=O.length,Se=new Map;O.forEach(oe=>{const Ce=oe.group??0;Se.set(Ce,(Se.get(Ce)||0)+1)}),O.forEach(oe=>{const Ce=Se.get(oe.group??0)||1,Oe=tn(oe,"selfBuffs",1122,m,Ce,W,B),Ke=tn(oe,"squadBuffs",1122,m,Ce,W,B);oe.stabGeneration=(Oe.generationMs+Ke.generationMs)/1e3})}function Gn(i){if(!i.statsTargets)return 0;let c=0;for(const m of i.statsTargets)m&&m.length>0&&(c+=m[0].downContribution||0);return c}function Yn(i){if(!i.extBarrierStats||!i.extBarrierStats.outgoingBarrierAllies)return 0;let c=0;for(const m of i.extBarrierStats.outgoingBarrierAllies)if(m)for(const B of m)B&&(c+=B.barrier||0);return c}function Jn(i){if(!i.extHealingStats||!i.extHealingStats.outgoingHealingAllies)return 0;let c=0;for(const m of i.extHealingStats.outgoingHealingAllies)if(m)for(const B of m)B&&(c+=B.healing||0);return c}const Qn=i=>{var c,m,B,O;return(((m=(c=i.support)==null?void 0:c[0])==null?void 0:m.condiCleanse)||0)+(((O=(B=i.support)==null?void 0:B[0])==null?void 0:O.condiCleanseSelf)||0)},Xn=(i,c=Ot)=>{var W;const m=(W=i.support)==null?void 0:W[0],B=Number((m==null?void 0:m.boonStrips)??0),O=Number((m==null?void 0:m.boonStripsTime)??0);return nn(B,O,c)},Zn=i=>Gn(i),yn=i=>Jn(i),ei=i=>Yn(i),ti=(i,c=Ot)=>zn(i,c),ni=(i,c)=>Kn(i,c),ii="count",oi={downContribution:1,healing:1,cleanses:1,strips:1,stability:1,cc:.7,revives:.7,distanceToTag:.7,participation:.7,dodging:.4,dps:.2,damage:.2},si={showMvp:!0,topSkillDamageSource:"target",topSkillsMetric:"damage"},on=new Map([["bleeding","Bleeding"],["burning","Burning"],["confusion","Confusion"],["poison","Poison"],["torment","Torment"],["vulnerability","Vulnerability"],["weakness","Weakness"],["weakened","Weakness"],["blind","Blind"],["blinded","Blind"],["blinding","Blind"],["cripple","Cripple"],["crippled","Cripple"],["chill","Chill"],["chilled","Chill"],["immob","Immobilize"],["immobile","Immobilize"],["immobilized","Immobilize"],["slow","Slow"],["slowed","Slow"],["fear","Fear"],["feared","Fear"],["taunt","Taunt"],["taunted","Taunt"]]),ai={Blind:"https://render.guildwars2.com/file/09770136BB76FD0DBE1CC4267DEED54774CB20F6/102837.png",Chill:"https://render.guildwars2.com/file/28C4EC547A3516AF0242E826772DA43A5EAC3DF3/102839.png",Cripple:"https://render.guildwars2.com/file/070325E519C178D502A8160523766070D30C0C19/102838.png",Fear:"https://render.guildwars2.com/file/30307A6E766D74B6EB09EDA12A4A2DE50E4D76F4/102869.png",Immobilize:"https://render.guildwars2.com/file/397A613651BFCA2832B6469CE34735580A2C120E/102844.png",Slow:"https://render.guildwars2.com/file/F60D1EF5271D7B9319610855676D320CD25F01C6/961397.png",Taunt:"https://render.guildwars2.com/file/02EED459AD65FAF7DF32A260E479C625070841B9/1228472.png",Vulnerability:"https://render.guildwars2.com/file/3A394C1A0A3257EB27A44842DDEEF0DF000E1241/102850.png",Weakness:"https://render.guildwars2.com/file/6CB0E64AF9AA292E332A38C1770CE577E2CDE0E8/102853.png"},pt=i=>{if(!i)return null;const c=i.trim().toLowerCase(),m=on.get(c);if(m)return m;const B=c.split(/[^a-z]+/).filter(Boolean);for(const O of B){const W=on.get(O);if(W)return W}return null},ri=i=>pt(i),sn=i=>{const c=new Map;return i&&(Object.values(i).forEach(m=>{if(!(m!=null&&m.icon)||!(m!=null&&m.name))return;const B=pt(m.name);B&&(c.has(B)||c.set(B,m.icon))}),Object.entries(ai).forEach(([m,B])=>{c.has(m)||c.set(m,B)})),c},wt=(i,c,m)=>{var B;if(c&&m){const O=(B=m[`b${c}`])==null?void 0:B.name,W=pt(O);if(W)return W}return i?pt(i):null},ci=i=>{const c=(i==null?void 0:i.account)||"Unknown";return c&&c!=="Unknown"?c:(i==null?void 0:i.name)||"Unknown"||null},li=i=>{if(!i||i.length===0)return 0;let c=0,m=null;return i.forEach(B=>{const O=Number(B[1]??0);if(Number.isFinite(O)){if(m===null){m=O;return}O>m&&(c+=O-m),m=O}}),c},ui=i=>{if(!i||i.length===0)return 0;let c=0;return i.forEach(m=>{const B=Number(m[0]??0),O=Number(m[1]??0);Number.isFinite(O)&&B!==0&&O>0&&(c+=1)}),c},mi=i=>{const{players:c,targets:m,skillMap:B,buffMap:O}=i,W=i.getPlayerKey||ci,Se=sn(O),oe={},Ce={};c.forEach(R=>{if(R!=null&&R.notInSquad)return;const V=W(R);V&&(oe[V]||(oe[V]={}),R!=null&&R.totalDamageDist&&R.totalDamageDist.forEach(ke=>{ke&&ke.forEach(me=>{if(!me.id)return;let L=`Skill ${me.id}`,ce;B&&(B[`s${me.id}`]?(L=B[`s${me.id}`].name||L,ce=B[`s${me.id}`].icon||ce):B[`${me.id}`]&&(L=B[`${me.id}`].name||L,ce=B[`${me.id}`].icon||ce));const de=wt(L,me.id,O);if(!de)return;const he=O==null?void 0:O[`b${me.id}`],_e=he==null?void 0:he.name,be=Se.get(de)||(he==null?void 0:he.icon),He=L.startsWith("Skill ")?_e||de:L,Fe=ce||(he==null?void 0:he.icon),Ae=Number(me.connectedHits??0),je=Number(me.hits??0),Te=Ae>0?Ae:je,Me=Number(me.totalDamage??0);if(!Number.isFinite(Te)&&!Number.isFinite(Me))return;const Ve=Ce[de]||{name:de,icon:be,applications:0,damage:0};Ve.applications+=Number.isFinite(Te)?Te:0,Ve.damage+=Number.isFinite(Me)?Me:0,!Ve.icon&&be&&(Ve.icon=be),Ce[de]=Ve;const Ue=oe[V][de]||{icon:be,applications:0,damage:0,skills:{}};Ue.applications+=Number.isFinite(Te)?Te:0,Ue.damage+=Number.isFinite(Me)?Me:0;const Re=Ue.skills[He]||{name:He,hits:0,damage:0,icon:Fe};Re.hits+=Number.isFinite(Te)?Te:0,Re.damage+=Number.isFinite(Me)?Me:0,!Re.icon&&Fe&&(Re.icon=Fe),Ue.skills[He]=Re,!Ue.icon&&be&&(Ue.icon=be),oe[V][de]=Ue})}))});const Oe=new Map;c.forEach(R=>{if(R!=null&&R.notInSquad)return;const V=W(R);V&&R!=null&&R.name&&Oe.set(R.name,V)});let Ke=0,Ne=0,De=0;return m.forEach(R=>{R!=null&&R.buffs&&R.buffs.forEach(V=>{const ke=Number(V==null?void 0:V.id);if(!Number.isFinite(ke))return;const me=O==null?void 0:O[`b${ke}`],L=pt(me==null?void 0:me.name);if(!L||me!=null&&me.classification&&me.classification!=="Condition")return;const ce=L;if(!ce)return;const de=V.statesPerSource||{};De+=1,Object.entries(de).forEach(([he,_e])=>{var Te;const be=Oe.get(he);if(!be)return;Ne+=1;const He=li(_e),Fe=ui(_e);Ke+=He;const Ae=((Te=oe[be])==null?void 0:Te[ce])||{applications:0,damage:0,skills:{}};Ae.applicationsFromBuffs=(Ae.applicationsFromBuffs||0)+He,Ae.applicationsFromBuffsActive=(Ae.applicationsFromBuffsActive||0)+Fe,oe[be]=oe[be]||{},oe[be][ce]=Ae;const je=Ce[ce]||{name:ce,applications:0,damage:0};je.applicationsFromBuffs=(je.applicationsFromBuffs||0)+He,je.applicationsFromBuffsActive=(je.applicationsFromBuffsActive||0)+Fe,Ce[ce]=je})})}),Object.values(oe).forEach(R=>{Object.values(R).forEach(V=>{typeof V.applicationsFromBuffs=="number"&&(V.applications=V.applicationsFromBuffs)})}),Object.values(Ce).forEach(R=>{typeof R.applicationsFromBuffs=="number"&&(R.applications=R.applicationsFromBuffs)}),{playerConditions:oe,summary:Ce,meta:{buffStateApplicationsTotal:Ke,targetBuffEntriesSeen:De,buffStateSourcesSeen:Ne}}},di=new Set(["Vulnerability","Weakness","Blind","Cripple","Chill","Immobilize","Slow","Fear","Taunt"]),fi=[{id:"damage",label:"Damage",field:"damage",source:"dpsAll"},{id:"directDmg",label:"Direct Damage",field:"directDmg",source:"statsTargets"},{id:"connectedDamageCount",label:"Connected Damage Count",field:"connectedDamageCount",source:"statsTargets"},{id:"connectedDirectDamageCount",label:"Connected Direct Damage Count",field:"connectedDirectDamageCount",source:"statsTargets"},{id:"battleStandardHits",label:"Battle Standard Tracking"},{id:"criticalRate",label:"Critical Rate",field:"criticalRate",isRate:!0,isPercent:!0,denomField:"critableDirectDamageCount",source:"statsTargets"},{id:"criticalDmg",label:"Critical Damage",field:"criticalDmg",source:"statsTargets"},{id:"flankingRate",label:"Flanking Rate",field:"flankingRate",isRate:!0,isPercent:!0,denomField:"connectedDirectDamageCount",source:"statsTargets"},{id:"glanceRate",label:"Glance Rate",field:"glanceRate",isRate:!0,isPercent:!0,denomField:"connectedDirectDamageCount",source:"statsTargets"},{id:"missed",label:"Missed",field:"missed",source:"statsTargets"},{id:"evaded",label:"Evaded (enemy)",field:"evaded",source:"statsTargets"},{id:"blocked",label:"Blocked (enemy)",field:"blocked",source:"statsTargets"},{id:"interrupts",label:"Interrupts",field:"interrupts",source:"statsTargets"},{id:"invulned",label:"Invulned",field:"invulned",source:"statsTargets"},{id:"killed",label:"Killed",field:"killed",source:"statsTargets"},{id:"downed",label:"Downed",field:"downed",source:"statsTargets"},{id:"downContribution",label:"Down Contribution",field:"downContribution",source:"statsTargets"},{id:"downContributionPercent",label:"Down Contribution %",isRate:!0,isPercent:!0},{id:"againstDownedDamage",label:"Against Downed Damage",field:"againstDownedDamage",source:"statsTargets"},{id:"appliedCrowdControl",label:"Applied CC",field:"appliedCrowdControl",source:"statsTargets"},{id:"appliedCrowdControlDuration",label:"Applied CC Duration",field:"appliedCrowdControlDuration",source:"statsTargets"},{id:"appliedCrowdControlDownContribution",label:"Applied CC Down Contribution",field:"appliedCrowdControlDownContribution",source:"statsTargets"},{id:"appliedCrowdControlDurationDownContribution",label:"Applied CC Duration Down Contribution",field:"appliedCrowdControlDurationDownContribution",source:"statsTargets"},{id:"boonStrips",label:"Boon Strips",field:"boonStrips",source:"support"}],gi=[{id:"damageTaken",label:"Damage Taken",field:"damageTaken"},{id:"damageTakenCount",label:"Damage Taken Count",field:"damageTakenCount"},{id:"conditionDamageTaken",label:"Condition Damage Taken",field:"conditionDamageTaken"},{id:"conditionDamageTakenCount",label:"Condition Damage Taken Count",field:"conditionDamageTakenCount"},{id:"powerDamageTaken",label:"Power Damage Taken",field:"powerDamageTaken"},{id:"powerDamageTakenCount",label:"Power Damage Taken Count",field:"powerDamageTakenCount"},{id:"downedDamageTaken",label:"Downed Damage Taken",field:"downedDamageTaken"},{id:"downedDamageTakenCount",label:"Downed Damage Taken Count",field:"downedDamageTakenCount"},{id:"damageBarrier",label:"Damage Barrier",field:"damageBarrier"},{id:"damageBarrierCount",label:"Damage Barrier Count",field:"damageBarrierCount"},{id:"blockedCount",label:"Blocked Count",field:"blockedCount"},{id:"evadedCount",label:"Evaded Count",field:"evadedCount"},{id:"missedCount",label:"Missed Count",field:"missedCount"},{id:"dodgeCount",label:"Dodge Count",field:"dodgeCount"},{id:"invulnedCount",label:"Invulnerable Count",field:"invulnedCount"},{id:"interruptedCount",label:"Interrupted Count",field:"interruptedCount"},{id:"downCount",label:"Down Count",field:"downCount"},{id:"deadCount",label:"Death Count",field:"deadCount"},{id:"boonStrips",label:"Boon Strips (Incoming)",field:"boonStrips"},{id:"conditionCleanses",label:"Cleanses (Incoming)",field:"conditionCleanses"},{id:"receivedCrowdControl",label:"Crowd Control (Incoming)",field:"receivedCrowdControl"}],pi=[{id:"condiCleanse",label:"Condition Cleanses",field:"condiCleanse"},{id:"condiCleanseTime",label:"Condition Cleanse Time",field:"condiCleanseTime",isTime:!0},{id:"condiCleanseSelf",label:"Condition Cleanse Self",field:"condiCleanseSelf"},{id:"condiCleanseTimeSelf",label:"Condition Cleanse Time Self",field:"condiCleanseTimeSelf",isTime:!0},{id:"boonStrips",label:"Boon Strips",field:"boonStrips"},{id:"boonStripsTime",label:"Boon Strips Time",field:"boonStripsTime",isTime:!0},{id:"boonStripDownContribution",label:"Boon Strip Down Contribution",field:"boonStripDownContribution"},{id:"boonStripDownContributionTime",label:"Boon Strip Down Contribution Time",field:"boonStripDownContributionTime",isTime:!0},{id:"stunBreak",label:"Stun Breaks",field:"stunBreak"},{id:"removedStunDuration",label:"Removed Stun Duration",field:"removedStunDuration",isTime:!0},{id:"resurrects",label:"Resurrects",field:"resurrects"},{id:"resurrectTime",label:"Resurrect Time",field:"resurrectTime",isTime:!0}],hi=["battle standard","glyph of renewal","glyph of the stars","illusion of life","spirit of nature","nature spirit","search and rescue","signet of mercy"],bi=new Set([10244]),ki=(i,c)=>{var O;if(bi.has(i))return!0;const m=(c==null?void 0:c[`s${i}`])||(c==null?void 0:c[`${i}`]),B=((O=m==null?void 0:m.name)==null?void 0:O.toLowerCase())||"";return hi.some(W=>B.includes(W))},Si=i=>{if(!i||!Number.isFinite(i))return"--:--";const c=Math.max(0,Math.round(i/1e3)),m=Math.floor(c/3600),B=Math.floor(c%3600/60),O=c%60;return m>0?`${m}:${String(B).padStart(2,"0")}:${String(O).padStart(2,"0")}`:`${B}:${String(O).padStart(2,"0")}`},vt={Guardian:"#72C1D9",Dragonhunter:"#72C1D9",Firebrand:"#72C1D9",Willbender:"#72C1D9",Revenant:"#D16E5A",Herald:"#D16E5A",Renegade:"#D16E5A",Vindicator:"#D16E5A",Warrior:"#FFD166",Berserker:"#FFD166",Spellbreaker:"#FFD166",Bladesworn:"#FFD166",Engineer:"#D09C59",Scrapper:"#D09C59",Holosmith:"#D09C59",Mechanist:"#D09C59",Ranger:"#8CDC82",Druid:"#8CDC82",Soulbeast:"#8CDC82",Untamed:"#8CDC82",Thief:"#C08F95",Daredevil:"#C08F95",Deadeye:"#C08F95",Specter:"#C08F95",Elementalist:"#F68A87",Tempest:"#F68A87",Weaver:"#F68A87",Catalyst:"#F68A87",Mesmer:"#B679D5",Chronomancer:"#B679D5",Mirage:"#B679D5",Virtuoso:"#B679D5",Necromancer:"#52A76F",Reaper:"#52A76F",Scourge:"#52A76F",Harbinger:"#52A76F",Ritualist:"#52A76F",Luminary:"#72C1D9",Conduit:"#D16E5A",Paragon:"#FFD166",Amalgam:"#D09C59",Galeshot:"#8CDC82",Antiquary:"#C08F95",Evoker:"#F68A87",Troubadour:"#B679D5",Unknown:"#64748B"};function an(i){return vt[i]||vt.Unknown}const Ci=i=>{if(i==null||i==="")return 0;if(typeof i=="number")return!Number.isFinite(i)||i<=0?0:i>1e12?i:i*1e3;if(i instanceof Date){const Se=i.getTime();return Number.isFinite(Se)&&Se>0?Se:0}const c=String(i).trim();if(!c)return 0;const m=Number(c);if(Number.isFinite(m)&&m>0)return m>1e12?m:m*1e3;const B=Date.parse(c);if(Number.isFinite(B)&&B>0)return B;const O=c.replace(/([+-]\d{2})$/,"$1:00"),W=Date.parse(O);return Number.isFinite(W)&&W>0?W:0},et=(i,c)=>Ci((i==null?void 0:i.uploadTime)??(c==null?void 0:c.uploadTime)??(i==null?void 0:i.timeStartStd)??(i==null?void 0:i.timeStart)??(i==null?void 0:i.timeEndStd)??(i==null?void 0:i.timeEnd)??(i==null?void 0:i.timeStartText)??(i==null?void 0:i.timeEndText)),Di=({logs:i,precomputedStats:c,mvpWeights:m,statsViewSettings:B,disruptionMethod:O})=>{const W=(()=>{const Ne=i.filter(De=>De.details&&De.details.players&&De.details.players.length>0);return console.log("[useStatsAggregation] Filtering logs:",{total:i.length,passed:Ne.length,statuses:i.map(De=>De.status),hasDetails:i.map(De=>!!De.details)}),Ne})(),Se=B||si,oe=m||oi,Ce=Ne=>{if(!Ne||typeof Ne!="object")return Ne;const De=Array.isArray(Ne.fightBreakdown)?Ne.fightBreakdown:null;if(!De||De.length===0)return Ne;const R=L=>Array.isArray(L)&&L.some(ce=>ce&&Number(ce.count)>0),V=new Map,ke=new Map;i.forEach(L=>{var he;const ce=(L==null?void 0:L.filePath)||(L==null?void 0:L.id);ce&&V.set(String(ce),L);const de=(L==null?void 0:L.permalink)||((he=L==null?void 0:L.details)==null?void 0:he.permalink);typeof de=="string"&&de.trim()&&ke.set(de.trim(),L)});const me=De.map(L=>{var He;if(!L||typeof L!="object")return L;const ce=L.id?String(L.id):"",de=typeof L.permalink=="string"?L.permalink.trim():"",he=(ce?V.get(ce):void 0)||(de?ke.get(de):void 0);if(!he)return L;let _e=L;if(Number(L.timestamp)<=0){const Fe=et(he==null?void 0:he.details,he);Fe&&(_e={..._e,timestamp:Fe})}const be=(He=he==null?void 0:he.details)==null?void 0:He.teamBreakdown;return R(be)&&(_e={..._e,teamBreakdown:be}),_e});return{...Ne,fightBreakdown:me}},Oe=(()=>{if(c)return Ce(c);const Ne=O||ii,De=Se.topSkillDamageSource||"target",R=Se.topSkillsMetric||"damage",V=W.length;let ke=0,me=0,L=0,ce=0,de=0,he=0,_e=0,be=0;const He=e=>{const n=((e==null?void 0:e.players)||[]).filter(K=>!K.notInSquad);let f=0,r=0,C=0,M=0;return n.forEach(K=>{var ue;const G=(ue=K.defenses)==null?void 0:ue[0];if(!G)return;const Q=Number(G.downCount||0),pe=Number(G.deadCount||0);f+=Q+pe,C+=pe}),n.forEach(K=>{!K.statsTargets||K.statsTargets.length===0||K.statsTargets.forEach(G=>{const Q=G==null?void 0:G[0];if(!Q)return;const pe=Number(Q.downed||0),ue=Number(Q.killed||0);r+=pe+ue,M+=ue})}),{squadDownsDeaths:f,enemyDownsDeaths:r,squadDeaths:C,enemyDeaths:M}},Fe=e=>{const{squadDownsDeaths:t,enemyDownsDeaths:n}=He(e);return t>0||n>0?n>t:typeof(e==null?void 0:e.success)=="boolean"?e.success:!1},Ae=new Map,je=new Set(["boonStripsTime","condiCleanseTime","condiCleanseTimeSelf"]),Te={},Me={},Ve=new Map,Ue={},Re={},Ie={},st=new Map,tt=new Map,Et=new Set(Object.keys(vt)),Ft=Object.keys(vt).filter(e=>e&&e!=="Unknown").sort((e,t)=>t.length-e.length),Bt=["Guardian","Revenant","Warrior","Engineer","Ranger","Thief","Elementalist","Mesmer","Necromancer"],at=e=>{if(!e)return"Unknown";const t=String(e).replace(/\s*\([^)]*\)\s*$/,"").replace(/\s*\[[^\]]*\]\s*$/,"").replace(/\s\d+$/,"").trim();if(Et.has(t))return t;const n=t.toLowerCase();for(const r of Ft)if(n.includes(r.toLowerCase()))return r;return Bt.find(r=>n.includes(r.toLowerCase()))||t||"Unknown"},Ai=e=>e!=null&&e.classification?e.classification==="Boon":!0,It=new Map,Pt=new Map,ht=()=>({totalHits:0,blocked:0,evaded:0,glanced:0,missed:0,invulned:0,interrupted:0,totalMitigation:0,minMitigation:0}),le=e=>{const t=Number(e);return Number.isFinite(t)?t:0},dn=e=>{const t=String(e).split("|"),n=t[0]||"Unknown",f=at(t[1]||"Unknown"),r=t[2]||n||"Unknown";return{name:n,profession:f,account:r}},fn=(e,t,n)=>{let f=e.get(t);return f?n.profession&&!f.professionList.includes(n.profession)&&f.professionList.push(n.profession):(f={account:n.account,name:n.name,profession:n.profession,professionList:n.profession?[n.profession]:[],activeMs:0,mitigationTotals:ht()},e.set(t,f)),f},gn=(e,t,n)=>{let f=e.get(t);return f?n.profession&&!f.professionList.includes(n.profession)&&f.professionList.push(n.profession):(f={account:n.account,name:n.name,profession:n.profession,professionList:n.profession?[n.profession]:[],activeMs:0,mitigationTotals:ht(),minion:n.minion},e.set(t,f)),f},pn=(e,t)=>{e.totalHits+=le((t==null?void 0:t.skill_hits)??(t==null?void 0:t.skillHits)),e.blocked+=le(t==null?void 0:t.blocked),e.evaded+=le(t==null?void 0:t.evaded),e.glanced+=le(t==null?void 0:t.glanced),e.missed+=le(t==null?void 0:t.missed),e.invulned+=le(t==null?void 0:t.invulned),e.interrupted+=le(t==null?void 0:t.interrupted),e.totalMitigation+=le((t==null?void 0:t.avoided_damage)??(t==null?void 0:t.avoidedDamage)),e.minMitigation+=le((t==null?void 0:t.min_avoided_damage)??(t==null?void 0:t.minAvoidedDamage))},Ti=e=>Object.values(e).some(t=>t>0);console.log("[useStatsAggregation] Starting aggregation loop",{validLogsCount:W.length});const Ht=(e,t,n)=>{var C,M,K,G;const f=`s${e}`;if((C=t==null?void 0:t[f])!=null&&C.name)return t[f].name;if((M=t==null?void 0:t[String(e)])!=null&&M.name)return t[String(e)].name;const r=`b${e}`;return(K=n==null?void 0:n[r])!=null&&K.name?n[r].name:(G=n==null?void 0:n[String(e)])!=null&&G.name?n[String(e)].name:`Unknown Skill ${e}`},bt=new Map,rt=e=>{const t=bt.get(e);if(!t)return{hasSkill:!1,avg:1,min:1,hits:0};const n=t.connectedHits||0,f=n>0?t.totalDamage/n:0,r=t.minCount>0?t.minTotal/t.minCount:0;return{hasSkill:!0,avg:f,min:r,hits:n}},Ut="Ashtonlightstone.9145",hn="Illusionary Warden",Wt=[],ct=[],jt=[],Vt=[],bn=new Map,kn=new Map,Sn=(e,t,n)=>{const f=e.get(t)||ht();return f.totalHits+=n.totalHits,f.blocked+=n.blocked,f.evaded+=n.evaded,f.glanced+=n.glanced,f.missed+=n.missed,f.invulned+=n.invulned,f.interrupted+=n.interrupted,e.set(t,f),f};W.forEach(e=>{const t=e.details;if(!t)return;(t.targets||[]).forEach(f=>{const r=(f==null?void 0:f.totalDamageDist)||[],C=Array.isArray(r)?r[0]:null;C==null||C.forEach(M=>{if(!(M!=null&&M.id))return;const K=Number(M.id),G=bt.get(K)||{totalDamage:0,connectedHits:0,minTotal:0,minCount:0};G.totalDamage+=Number(M.totalDamage||0),G.connectedHits+=Number(M.connectedHits||0);const Q=Number.isFinite(Number(M.min))?Number(M.min):0;G.minTotal+=Q,G.minCount+=1,bt.set(K,G)})})}),W.forEach((e,t)=>{var fe,$e;const n=e.details;if(!n)return;const f=n.players;console.log(`[useStatsAggregation] Processing log ${t}:`,{playerCount:f==null?void 0:f.length,hasTargets:!!n.targets,firstPlayer:f!=null&&f[0]?{account:f[0].account,notInSquad:f[0].notInSquad}:"none"});const r=n.targets||[],C=n.skillMap||{},M=n.buffMap||{},K=new Map,G=new Map;r.forEach(o=>{const p=(o==null?void 0:o.totalDamageDist)||[],P=Array.isArray(p)?p[0]:null;P==null||P.forEach(Z=>{var ee;if(!(Z!=null&&Z.id))return;const z=Number(Z.id),s=((ee=C==null?void 0:C[z])==null?void 0:ee.name)||Z.name||Z.skillName||String(z),D=K.get(z)||{totalDamage:0,connectedHits:0,minTotal:0,minCount:0};D.totalDamage+=Number(Z.totalDamage||0),D.connectedHits+=Number(Z.connectedHits||0);const A=Number.isFinite(Number(Z.min))?Number(Z.min):0;D.minTotal+=A,D.minCount+=1,K.set(z,D);const H=G.get(s)||{totalDamage:0,connectedHits:0,minTotal:0,minCount:0};H.totalDamage+=Number(Z.totalDamage||0),H.connectedHits+=Number(Z.connectedHits||0);const ne=Number.isFinite(Number(Z.min))?Number(Z.min):0;H.minTotal+=ne,H.minCount+=1,G.set(s,H)})});const Q=o=>{const p=K.get(o);if(!p||p.connectedHits<=0)return{avg:1,min:1};const P=p.connectedHits>0?p.totalDamage/p.connectedHits:0,Z=p.minCount>0?p.minTotal/p.minCount:P;return{avg:P||1,min:Z||1}},pe=o=>{const p=G.get(o);if(!p||p.connectedHits<=0)return{avg:1,min:1};const P=p.connectedHits>0?p.totalDamage/p.connectedHits:0,Z=p.minCount>0?p.minTotal/p.minCount:P;return{avg:P||1,min:Z||1}},ue=n.combatReplayMetaData||{},Pe=(ue==null?void 0:ue.inchToPixel)>0?ue.inchToPixel:1,E=(ue==null?void 0:ue.pollingRate)>0?ue.pollingRate:1,w=5e3,$=o=>Array.isArray(o)?o.map(p=>Array.isArray(p)?[Number(p[0]),Number(p[1])]:null).filter(p=>!!p&&Number.isFinite(p[0])):[];let X=[],ae=n.durationMS||0,l=!1;const u=f.find(o=>(o==null?void 0:o.hasCommanderTag)&&!(o!=null&&o.notInSquad));(fe=u==null?void 0:u.combatReplayData)!=null&&fe.positions&&(X=u.combatReplayData.positions,$(u.combatReplayData.dead).forEach(([p])=>{p>0&&(l=!0,ae=Math.min(ae,p))}));const k=o=>{var H;const p=(H=o.statsAll)==null?void 0:H[0];if((p==null?void 0:p.distToCom)!==void 0&&(p==null?void 0:p.distToCom)!=="Infinity")return Math.round(Number(p.distToCom));if((p==null?void 0:p.stackDist)!==void 0)return Math.round(Number(p.stackDist))||0;if(o.hasCommanderTag)return 0;const P=o.combatReplayData;if(!(P!=null&&P.positions)||!X.length)return 0;const Z=P.positions,z=$(P.dead),s=$(P.down),D=Math.floor((P.start||0)/E);let A=0;if(z.length&&s.length)for(const[ne]of z){if(ne<0)continue;const ee=Math.max(0,Math.floor(ne/E))-D;for(const[_,Y]of s){if(ne!==Y)continue;const te=l&&_>ae?Math.max(1,Math.floor(ae/E)):ee,ie=Math.max(0,Math.min(te,Z.length,X.length));if(ie<=0)continue;let y=0;for(let J=0;J<ie;J++){const[g,F]=Z[J],[q,j]=X[J];y+=Math.hypot(g-q,F-j)}A=Math.round(y/ie/Pe)}}return A},h=f.filter(o=>!o.notInSquad);L+=h.length,ce+=r.filter(o=>!o.isFake).length,ni(f,{durationMS:n.durationMS,buffMap:n.buffMap});const{squadDeaths:v,enemyDeaths:a}=He(n);de+=v,he+=a,be+=v,_e+=a,Fe(n)?ke++:me++;const I=n.skillMap?Number(($e=Object.keys(n.skillMap).find(o=>{var p,P;return((P=(p=n.skillMap)==null?void 0:p[o])==null?void 0:P.name)==="Battle Standard"}))==null?void 0:$e.replace(/^s/,"")):null;f.forEach((o,p)=>{var Je,Ye,lt,ut,Lt,kt,St,wn,vn,En,Fn,Bn,In;if(o.notInSquad)return;const P=o.account||"Unknown",Z=P!=="Unknown"?P:o.name||"Unknown",z=o.name||"Unknown";Ae.has(Z)||Ae.set(Z,{name:z,account:Z,downContrib:0,cleanses:0,strips:0,stab:0,healing:0,barrier:0,cc:0,logsJoined:0,totalDist:0,distCount:0,dodges:0,downs:0,deaths:0,totalFightMs:0,offenseTotals:{},offenseRateWeights:{},defenseActiveMs:0,defenseTotals:{},supportActiveMs:0,supportTotals:{},healingActiveMs:0,healingTotals:{},profession:o.profession||"Unknown",professions:new Set,professionTimeMs:{},isCommander:!1,damage:0,dps:0,revives:0,outgoingConditions:{},incomingConditions:{}});const s=Ae.get(Z);if(o.hasCommanderTag&&(s.isCommander=!0),o.profession&&o.profession!=="Unknown"){s.profession=o.profession,s.professions.add(o.profession);const d=Array.isArray(o.activeTimes)&&typeof o.activeTimes[0]=="number"?o.activeTimes[0]:n.durationMS||0;s.professionTimeMs[o.profession]=(s.professionTimeMs[o.profession]||0)+d}s.logsJoined++,s.downContrib+=Zn(o),s.cleanses+=Qn(o),s.strips+=Xn(o,Ne),s.healing+=yn(o),s.barrier+=ei(o),s.cc+=ti(o,Ne),s.stab+=o.stabGeneration||0;const D=k(o);D<=w&&(s.totalDist+=D,s.distCount++),(Je=o.defenses)!=null&&Je[0]&&(s.dodges+=o.defenses[0].dodgeCount||0,s.downs+=o.defenses[0].downCount||0,s.deaths+=o.defenses[0].deadCount||0),n.durationMS&&(s.totalFightMs+=n.durationMS);const A=Array.isArray(o.activeTimes)&&typeof o.activeTimes[0]=="number"?o.activeTimes[0]:n.durationMS||0;s.defenseActiveMs+=A,s.supportActiveMs+=A,s.healingActiveMs+=A,Array.isArray(o.buffUptimes)&&o.buffUptimes.length>0&&o.buffUptimes.forEach(d=>{var Hn,Un,xn,$n,Ln,Rn;if(typeof(d==null?void 0:d.id)!="number")return;const N=`b${d.id}`,T=((Hn=n.buffMap)==null?void 0:Hn[N])||((Un=n.buffMap)==null?void 0:Un[String(d.id)]);if(!T||Ai(T))return;const x=Number((($n=(xn=d.buffData)==null?void 0:xn[0])==null?void 0:$n.uptime)??0),se=Number(((Rn=(Ln=d.buffData)==null?void 0:Ln[0])==null?void 0:Rn.presence)??0);if((!Number.isFinite(x)||x<=0)&&(!Number.isFinite(se)||se<=0))return;const Le=(T==null?void 0:T.stacking)??!1,ze=(Le?Number.isFinite(x)?x:0:Number.isFinite(x)?x/100:0)*A,it=Le?se:x,ft=Math.min(Math.max(Number.isFinite(it)?it:0,0),100)/100*A,Ct=Number.isFinite(ze)&&ze>0,Dt=Number.isFinite(ft)&&ft>0;if(!Ct&&!Dt)return;const Qe=ri(T==null?void 0:T.name);if(Qe&&di.has(Qe)&&(!(T!=null&&T.classification)||T.classification==="Condition")){const Rt=ze/1e3,Xe=T==null?void 0:T.icon,Nt=Ue[Qe]||{name:Qe,icon:Xe,applications:0,damage:0};Nt.applicationsFromUptime=(Nt.applicationsFromUptime||0)+Rt,!Nt.icon&&Xe&&(Nt.icon=Xe),Ue[Qe]=Nt;const At=s.outgoingConditions[Qe]||{applications:0,damage:0,skills:{},icon:Xe};At.applicationsFromUptime=(At.applicationsFromUptime||0)+Rt,!At.icon&&Xe&&(At.icon=Xe),s.outgoingConditions[Qe]=At;const Tt=Re[Qe]||{name:Qe,icon:Xe,applications:0,damage:0};Tt.applicationsFromUptime=(Tt.applicationsFromUptime||0)+Rt,!Tt.icon&&Xe&&(Tt.icon=Xe),Re[Qe]=Tt;const Mt=s.incomingConditions[Qe]||{applications:0,damage:0,skills:{},icon:Xe};Mt.applicationsFromUptime=(Mt.applicationsFromUptime||0)+Rt,!Mt.icon&&Xe&&(Mt.icon=Xe),s.incomingConditions[Qe]=Mt}st.has(N)||st.set(N,{name:T==null?void 0:T.name,stacking:Le,icon:T==null?void 0:T.icon}),tt.has(N)||tt.set(N,new Map);const Pn=tt.get(N),Qt=s.account||o.account||o.name||"Unknown";let ot=Pn.get(Qt);ot||(ot={account:Qt,profession:s.profession||o.profession||"Unknown",professions:new Set,professionTimeMs:{},totalMs:0,uptimeMs:0,durationMs:0},Pn.set(Qt,ot));const gt=o.profession||s.profession;gt&&gt!=="Unknown"&&(ot.professions.add(gt),ot.professionTimeMs[gt]=(ot.professionTimeMs[gt]||0)+A,ot.profession=gt),ot.totalMs+=Ct?ze:0,ot.uptimeMs+=Dt?ft:0,ot.durationMs+=A}),(Ye=o.defenses)!=null&&Ye[0]&&gi.forEach(d=>{const N=Number(o.defenses[0][d.field]??0);Number.isFinite(N)&&(s.defenseTotals[d.id]=(s.defenseTotals[d.id]||0)+N)}),(lt=o.support)!=null&&lt[0]&&pi.forEach(d=>{let N=Number(o.support[0][d.field]??0);Number.isFinite(N)&&(je.has(d.field)&&N>999999&&(N=0),s.supportTotals[d.id]=(s.supportTotals[d.id]||0)+N)});const H=(d,N)=>{Number.isFinite(N)&&(s.healingTotals[d]=(s.healingTotals[d]||0)+N)},ne=(d,N)=>Array.isArray(d)?d.reduce((T,x)=>T+Number((x==null?void 0:x[N])??0),0):0,ee=(d,N,T)=>{if(!Number.isFinite(T)||T<=0)return;const x=f[N],se=N===p,Le=x==null?void 0:x.notInSquad,We=!Le,ze=We&&(x==null?void 0:x.group)!=null&&x.group===o.group;H(d,T),We&&H(`squad${d[0].toUpperCase()}${d.slice(1)}`,T),ze&&H(`group${d[0].toUpperCase()}${d.slice(1)}`,T),se&&H(`self${d[0].toUpperCase()}${d.slice(1)}`,T),Le&&H(`offSquad${d[0].toUpperCase()}${d.slice(1)}`,T)};if(Array.isArray(o.rotation)){let d=0;o.rotation.forEach(N=>{var x;if(!(N!=null&&N.id)||!ki(N.id,n.skillMap))return;const T=((x=N.skills)==null?void 0:x.length)||0;T>0&&(d+=T,H(`resUtility_s${N.id}`,T))}),d>0&&H("resUtility",d)}const _=(ut=o.extHealingStats)==null?void 0:ut.outgoingHealingAllies;Array.isArray(_)&&_.forEach((d,N)=>{const T=ne(d,"healing"),x=ne(d,"downedHealing");ee("healing",N,T),ee("downedHealing",N,x)});const Y=(Lt=o.extBarrierStats)==null?void 0:Lt.outgoingBarrierAllies;Array.isArray(Y)&&Y.forEach((d,N)=>{const T=ne(d,"barrier");ee("barrier",N,T)});const te=(kt=o.statsAll)==null?void 0:kt[0],ie=(St=o.dpsAll)==null?void 0:St[0],y=(wn=o.support)==null?void 0:wn[0];if(fi.forEach(d=>{if(d.id==="downContributionPercent"||!d.field)return;let N=0,T=0;d.source==="dpsAll"&&ie?N=Number(ie[d.field]??0):d.source==="statsAll"&&te?(N=Number(te[d.field]??0),T=Number(te[d.denomField||d.weightField||"connectedDamageCount"]??0)):d.source==="support"&&y?N=Number(y[d.field]??0):o.statsTargets&&o.statsTargets.forEach(x=>{x!=null&&x[0]&&(N+=Number(x[0][d.field]??0),T+=Number(x[0][d.denomField||d.weightField||"connectedDamageCount"]??0))}),Number.isFinite(N)&&(s.offenseTotals[d.id]=(s.offenseTotals[d.id]||0)+N,d.isRate&&T>0&&(s.offenseRateWeights[d.id]=(s.offenseRateWeights[d.id]||0)+T))}),o.targetDamageDist&&Number.isFinite(I)){const d=o.targetDamageDist.flatMap(N=>N||[]).flatMap(N=>N||[]).reduce((N,T)=>T!=null&&T.id&&T.id===I?N+((T==null?void 0:T.connectedHits)||0):N,0);s.offenseTotals.battleStandardHits=(s.offenseTotals.battleStandardHits||0)+d}s.revives+=((En=(vn=o.support)==null?void 0:vn[0])==null?void 0:En.resurrects)||0,ie&&(s.damage+=ie.damage||0,s.dps+=ie.dps||0);const J=d=>{var se,Le,We,ze;let N=`Skill ${d.id}`;const T=((se=n.skillMap)==null?void 0:se[`s${d.id}`])||((Le=n.skillMap)==null?void 0:Le[`${d.id}`]);let x=T==null?void 0:T.icon;if(T!=null&&T.name&&(N=T.name),N.startsWith("Skill ")){const it=wt(N,d.id,n.buffMap);it&&(N=it,x=((ze=(We=n.buffMap)==null?void 0:We[`b${d.id}`])==null?void 0:ze.icon)||x)}return{name:N,icon:x}},g=d=>{if(!(d!=null&&d.id))return;const{name:N,icon:T}=J(d);Te[d.id]||(Te[d.id]={name:N,icon:T,damage:0,hits:0,downContribution:0}),Te[d.id].name.startsWith("Skill ")&&!N.startsWith("Skill ")&&(Te[d.id].name=N),!Te[d.id].icon&&T&&(Te[d.id].icon=T),Te[d.id].damage+=d.totalDamage,Te[d.id].hits+=d.connectedHits,Te[d.id].downContribution+=Number(d.downContribution||0)},F=o.account||o.name||"Unknown",q=o.profession||"Unknown",j=`${F}|${q}`;let ge=Ve.get(j);ge||(ge={key:j,account:F,displayName:F,profession:q,professionList:[q],totalFightMs:0,skills:new Map},Ve.set(j,ge)),ge.professionList.includes(q)||ge.professionList.push(q),ge.totalFightMs+=n.durationMS||0;const we=d=>{if(!(d!=null&&d.id))return;const{name:N,icon:T}=J(d),x=`s${d.id}`;let se=ge.skills.get(x);se||(se={id:x,name:N,icon:T,damage:0,downContribution:0},ge.skills.set(x,se)),se.name.startsWith("Skill ")&&!N.startsWith("Skill ")&&(se.name=N),!se.icon&&T&&(se.icon=T),se.damage+=Number(d.totalDamage||0),se.downContribution+=Number(d.downContribution||0)};if(De==="total")(Fn=o.totalDamageDist)==null||Fn.forEach(d=>{d==null||d.forEach(N=>{g(N),we(N)})});else{const d=new Map;(Bn=o.targetDamageDist)==null||Bn.forEach(T=>{T==null||T.forEach(x=>{x==null||x.forEach(se=>{const Le=Number(se==null?void 0:se.id);if(Number.isFinite(Le)){const We=d.get(Le)||{damage:0,hits:0,downContribution:0};We.damage+=Number((se==null?void 0:se.totalDamage)||0),We.hits+=Number((se==null?void 0:se.connectedHits)||0),We.downContribution+=Number((se==null?void 0:se.downContribution)||0),d.set(Le,We)}g(se),we(se)})})}),!(n!=null&&n.detailedWvW)&&((In=o.totalDamageDist)==null||In.forEach(T=>{T==null||T.forEach(x=>{const se=Number(x==null?void 0:x.id);if(!Number.isFinite(se))return;const Le=d.get(se);if(!Le){g(x),we(x);return}const We=Number((x==null?void 0:x.totalDamage)||0),ze=Number((x==null?void 0:x.connectedHits)||0),it=Number((x==null?void 0:x.downContribution)||0),dt=We-Number(Le.damage||0),ft=ze-Number(Le.hits||0),Ct=it-Number(Le.downContribution||0);if(dt<=0&&ft<=0&&Ct<=0)return;const Dt={...x,totalDamage:Math.max(0,dt),connectedHits:Math.max(0,ft),downContribution:Math.max(0,Ct)};g(Dt),we(Dt)})}))}o.totalDamageTaken&&o.totalDamageTaken.forEach(d=>{d==null||d.forEach(N=>{var Le,We,ze,it;if(!(N!=null&&N.id))return;let T=`Skill ${N.id}`;const x=((Le=n.skillMap)==null?void 0:Le[`s${N.id}`])||((We=n.skillMap)==null?void 0:We[`${N.id}`]);let se=x==null?void 0:x.icon;if(x!=null&&x.name&&(T=x.name),T.startsWith("Skill ")){const dt=wt(T,N.id,n.buffMap);dt&&(T=dt,se=((it=(ze=n.buffMap)==null?void 0:ze[`b${N.id}`])==null?void 0:it.icon)||se)}Me[N.id]||(Me[N.id]={name:T,icon:se,damage:0,hits:0}),(!Me[N.id].name.startsWith("Skill ")||T.startsWith("Skill "))&&(Me[N.id].name=T),!Me[N.id].icon&&se&&(Me[N.id].icon=se),Me[N.id].damage+=N.totalDamage,Me[N.id].hits+=N.hits})})}),r.forEach(o=>{if(o!=null&&o.isFake)return;const p=at((o==null?void 0:o.profession)||(o==null?void 0:o.name)||(o==null?void 0:o.id));p&&(Ie[p]=(Ie[p]||0)+1)});const b=mi({players:f,targets:r,skillMap:n.skillMap,buffMap:n.buffMap,getPlayerKey:o=>o.account&&o.account!=="Unknown"?o.account:o.name||null}),U=sn(n.buffMap);Object.entries(b.playerConditions).forEach(([o,p])=>{const P=Ae.get(o);P&&Object.entries(p).forEach(([Z,z])=>{const s=P.outgoingConditions[Z]||{applications:0,damage:0,skills:{},icon:z.icon};s.applications+=Number(z.applications||0),s.damage+=Number(z.damage||0),z.applicationsFromBuffs&&(s.applicationsFromBuffs=(s.applicationsFromBuffs||0)+z.applicationsFromBuffs),z.applicationsFromBuffsActive&&(s.applicationsFromBuffsActive=(s.applicationsFromBuffsActive||0)+z.applicationsFromBuffsActive),Object.entries(z.skills||{}).forEach(([D,A])=>{const H=s.skills[D]||{name:A.name,hits:0,damage:0,icon:A.icon};H.hits+=Number(A.hits||0),H.damage+=Number(A.damage||0),!H.icon&&A.icon&&(H.icon=A.icon),s.skills[D]=H}),!s.icon&&z.icon&&(s.icon=z.icon),P.outgoingConditions[Z]=s})}),Object.entries(b.summary).forEach(([o,p])=>{const P=Ue[o]||{name:p.name||o,icon:p.icon,applications:0,damage:0};P.applications+=Number(p.applications||0),P.damage+=Number(p.damage||0),p.applicationsFromBuffs&&(P.applicationsFromBuffs=(P.applicationsFromBuffs||0)+p.applicationsFromBuffs),p.applicationsFromBuffsActive&&(P.applicationsFromBuffsActive=(P.applicationsFromBuffsActive||0)+p.applicationsFromBuffsActive),!P.icon&&p.icon&&(P.icon=p.icon),Ue[o]=P}),h.forEach(o=>{const p=o.account&&o.account!=="Unknown"?o.account:o.name||"Unknown",P=Ae.get(p);!P||!o.totalDamageTaken||o.totalDamageTaken.forEach(Z=>Z==null?void 0:Z.forEach(z=>{var J,g,F,q,j,ge;if(!(z!=null&&z.id))return;let s=`Skill ${z.id}`;const D=((J=n.skillMap)==null?void 0:J[`s${z.id}`])||((g=n.skillMap)==null?void 0:g[`${z.id}`]);D!=null&&D.name&&(s=D.name);const A=wt(s,z.id,n.buffMap);if(!A)return;const H=(q=(F=n.buffMap)==null?void 0:F[`b${z.id}`])==null?void 0:q.name,ne=U.get(A)||((ge=(j=n.buffMap)==null?void 0:j[`b${z.id}`])==null?void 0:ge.icon),ee=(D==null?void 0:D.icon)||ne;s.startsWith("Skill ")&&(H||A)&&(s=H||A);const _=Number(z.hits??0),Y=Number(z.totalDamage??0),te=Re[A]||{name:A,icon:ne,applications:0,damage:0};te.applications+=Number.isFinite(_)?_:0,te.damage+=Number.isFinite(Y)?Y:0,!te.icon&&ne&&(te.icon=ne),Re[A]=te;const ie=P.incomingConditions[A]||{applications:0,damage:0,skills:{},icon:ne};ie.applications+=Number.isFinite(_)?_:0,ie.damage+=Number.isFinite(Y)?Y:0;const y=ie.skills[s]||{name:s,hits:0,damage:0,icon:ee};y.hits+=Number.isFinite(_)?_:0,y.damage+=Number.isFinite(Y)?Y:0,!y.icon&&ee&&(y.icon=ee),ie.skills[s]=y,!ie.icon&&ne&&(ie.icon=ne),P.incomingConditions[A]=ie}))});const re=n.player_damage_mitigation||n.playerDamageMitigation,Be=re&&typeof re=="object"&&Object.keys(re).length>0;Be&&Object.entries(re).forEach(([o,p])=>{if(!p||typeof p!="object")return;const P=dn(o),Z=fn(It,P.account,P);Object.values(p).forEach(z=>{le((z==null?void 0:z.avoided_damage)??(z==null?void 0:z.avoidedDamage))<=0||pn(Z.mitigationTotals,z)})});const ve=n.player_minion_damage_mitigation||n.playerMinionDamageMitigation,qe=ve&&typeof ve=="object"&&Object.keys(ve).length>0;qe&&Object.entries(ve).forEach(([o,p])=>{if(!p||typeof p!="object")return;const P=dn(o);Object.entries(p).forEach(([Z,z])=>{if(!z||typeof z!="object")return;const s=`${P.account}::${Z}`,D=gn(Pt,s,{...P,minion:String(Z||"Unknown")});Object.values(z).forEach(A=>{pn(D.mitigationTotals,A)})})}),(!Be||!qe)&&(Be||h.forEach(o=>{const p=(o==null?void 0:o.totalDamageTaken)||[];if(!Array.isArray(p)||p.length===0)return;const P=o.account||o.name||"Unknown",Z={account:P,name:o.name||P,profession:at(o.profession||"Unknown")};fn(It,P,Z);const z=n.skillMap||{},s=n.buffMap||{},D=Array.isArray(p)?p[0]:null;if(D==null||D.forEach(A=>{if(!(A!=null&&A.id))return;const H=le(A.blocked),ne=le(A.evaded),ee=le(A.glance??A.glanced),_=le(A.missed),Y=le(A.invulned),te=le(A.interrupted),ie=le(A.hits??A.connectedHits),y=Number(A.id),J=Ht(y,z,s);if(Sn(bn,`${P}::${y}`,{totalHits:ie,blocked:H,evaded:ne,glanced:ee,missed:_,invulned:Y,interrupted:te}),P===Ut){const g=bt.get(y),F=rt(y),q=F.hasSkill?F.hits>0?F.avg:0:1,j=F.hasSkill?F.min||0:1,ge=F.hits>0?ee*q/2+(H+ne+_+Y+te)*q:0,we=F.hits>0?ee*j/2+(H+ne+_+Y+te)*j:0;jt.push({logId:e.filePath||e.id||t,skillId:A.id,skillName:J,blocked:H,evaded:ne,glanced:ee,missed:_,invulned:Y,interrupted:te,totalAvoids:H+ne+ee+_+Y+te,avg:q,min:j,enemyHits:(g==null?void 0:g.connectedHits)??0,enemyTotalDmg:(g==null?void 0:g.totalDamage)??0,avoidDmg:ge,avoidMinDmg:we})}}),P===Ut){const A=(H,ne)=>{let ee=0,_=0,Y=0;if(!Array.isArray(H))return{total:ee,minTotal:_,hits:Y};for(const te of H){if(!(te!=null&&te.id))continue;const ie=le(te.blocked),y=le(te.evaded),J=le(te.glance??te.glanced),g=le(te.missed),F=le(te.invulned),q=le(te.interrupted),j=Ht(Number(te.id),C,M),ge=ne(Number(te.id),j);(ge.hits??0)>0&&(ee+=J*ge.avg/2+(ie+y+g+F+q)*ge.avg,_+=J*ge.min/2+(ie+y+g+F+q)*ge.min),Y+=le(te.hits??te.connectedHits)}return{total:ee,minTotal:_,hits:Y}};Vt.push({logId:e.filePath||e.id||t,variant:"current_global_name_taken0",...A(D,(H,ne)=>{const ee=rt(H),_=ee.hasSkill?ee.hits>0?ee.avg:0:1,Y=ee.hasSkill?ee.min||0:1;return{avg:_,min:Y,hits:ee.hits}})})}}),qe||h.forEach(o=>{const p=(o==null?void 0:o.minions)||[];if(!Array.isArray(p)||p.length===0)return;const P=o.account||o.name||"Unknown",Z={account:P,name:o.name||P,profession:at(o.profession||"Unknown")},z=n.skillMap||{},s=n.buffMap||{};p.forEach(D=>{const A=(D==null?void 0:D.totalDamageTakenDist)||[];if(!Array.isArray(A)||A.length===0)return;let H=String((D==null?void 0:D.name)||"Unknown").replace(/^Juvenile\s+/i,"")||"Unknown";H.toUpperCase().includes("UNKNOWN")&&(H="Unknown");const ne=`${P}::${H}`;gn(Pt,ne,{...Z,minion:H});const ee=Array.isArray(A)?A[0]:null;if(ee==null||ee.forEach(_=>{if(!(_!=null&&_.id))return;const Y=le(_.blocked),te=le(_.evaded),ie=le(_.glance??_.glanced),y=le(_.missed),J=le(_.invulned),g=le(_.interrupted),F=le(_.hits??_.connectedHits),q=Number(_.id),j=Ht(q,z,s);if(Sn(kn,`${ne}::${q}`,{totalHits:F,blocked:Y,evaded:te,glanced:ie,missed:y,invulned:J,interrupted:g}),P===Ut&&H===hn){const ge=bt.get(q),we=rt(q),Je=we.hasSkill?we.hits>0?we.avg:0:1,Ye=we.hasSkill?we.min||0:1,lt=we.hits>0?ie*Je/2+(Y+te+y+J+g)*Je:0,ut=we.hits>0?ie*Ye/2+(Y+te+y+J+g)*Ye:0;Wt.push({logId:e.filePath||e.id||t,skillId:_.id,skillName:j,blocked:Y,evaded:te,glanced:ie,missed:y,invulned:J,interrupted:g,totalAvoids:Y+te+ie+y+J+g,avg:Je,min:Ye,enemyHits:(ge==null?void 0:ge.connectedHits)??0,enemyTotalDmg:(ge==null?void 0:ge.totalDamage)??0,avoidDmg:lt,avoidMinDmg:ut})}}),P===Ut&&H===hn){const _=(y,J)=>{let g=0,F=0,q=0;if(!Array.isArray(y))return{total:g,minTotal:F,hits:q};for(const j of y){if(!(j!=null&&j.id))continue;const ge=le(j.blocked),we=le(j.evaded),Je=le(j.glance??j.glanced),Ye=le(j.missed),lt=le(j.invulned),ut=le(j.interrupted),Lt=Ht(Number(j.id),C,M),{avg:kt,min:St}=J(Number(j.id),Lt);le(j.hits??j.connectedHits)>0&&(g+=Je*kt/2+(ge+we+Ye+lt+ut)*kt,F+=Je*St/2+(ge+we+Ye+lt+ut)*St),q+=le(j.hits??j.connectedHits)}return{total:g,minTotal:F,hits:q}},Y=Array.isArray(A)?A[0]||[]:[],te=Array.isArray(A)?A.flat():[],ie=Array.isArray(D==null?void 0:D.totalDamageTaken)?D.totalDamageTaken[0]||[]:[];ct.push({logId:e.filePath||e.id||t,variant:"current_global_name_dist0",..._(Y,(y,J)=>{const g=rt(y),F=g.hasSkill?g.hits>0?g.avg:0:1,q=g.hasSkill&&g.min||0;return{avg:F,min:q}})}),ct.push({logId:e.filePath||e.id||t,variant:"local_name_dist0",..._(Y,(y,J)=>pe(J))}),ct.push({logId:e.filePath||e.id||t,variant:"local_id_dist0",..._(Y,y=>Q(y))}),ct.push({logId:e.filePath||e.id||t,variant:"global_name_alllists",..._(te,(y,J)=>{const g=rt(y),F=g.hasSkill?g.hits>0?g.avg:0:1,q=g.hasSkill&&g.min||0;return{avg:F,min:q}})}),ct.push({logId:e.filePath||e.id||t,variant:"global_name_taken0",..._(ie,(y,J)=>{const g=rt(y),F=g.hasSkill?g.hits>0?g.avg:0:1,q=g.hasSkill&&g.min||0;return{avg:F,min:q}})})}})}))}),Wt.length>0&&(console.groupCollapsed("[Mitigation Debug] Ashtonlightstone.9145 / Illusionary Warden"),console.table(Wt),ct.length>0&&console.table(ct),console.groupEnd()),jt.length>0&&(console.groupCollapsed("[Mitigation Debug] Ashtonlightstone.9145 / Player"),console.table(jt),Vt.length>0&&console.table(Vt),console.groupEnd());const Cn=(e,t)=>{const n=new Map,f=r=>{let C=n.get(r);return C||(C=ht(),n.set(r,C)),C};t.forEach((r,C)=>{const M=C.lastIndexOf("::"),K=M>-1?C.slice(0,M):C,G=M>-1?Number(C.slice(M+2)):Number.NaN,Q=Number.isFinite(G)?rt(G):{hasSkill:!1,avg:0,min:0,hits:0};if(!Q.hasSkill||Q.hits<=0)return;const pe=Q.avg,ue=Q.min,Pe=r.glanced*pe/2+(r.blocked+r.evaded+r.missed+r.invulned+r.interrupted)*pe,E=r.glanced*ue/2+(r.blocked+r.evaded+r.missed+r.invulned+r.interrupted)*ue;if(Pe<=0)return;const w=f(K);w.totalHits+=r.totalHits,w.blocked+=r.blocked,w.evaded+=r.evaded,w.glanced+=r.glanced,w.missed+=r.missed,w.invulned+=r.invulned,w.interrupted+=r.interrupted,w.totalMitigation+=Pe,w.minMitigation+=E}),e.forEach((r,C)=>{const M=n.get(C)||ht();r.mitigationTotals.totalHits=M.totalHits,r.mitigationTotals.blocked=M.blocked,r.mitigationTotals.evaded=M.evaded,r.mitigationTotals.glanced=M.glanced,r.mitigationTotals.missed=M.missed,r.mitigationTotals.invulned=M.invulned,r.mitigationTotals.interrupted=M.interrupted,r.mitigationTotals.totalMitigation=M.totalMitigation,r.mitigationTotals.minMitigation=M.minMitigation})};Cn(It,bn),Cn(Pt,kn);const Mi=V>0?Math.round(L/V):0,wi=V>0?Math.round(ce/V):0,vi=de>0?(he/de).toFixed(2):he>0?"∞":"0.00",Ei=_e>0?(be/_e).toFixed(2):be>0?"∞":"0.00",Dn=(e,t)=>{const f=e.filter(M=>Number.isFinite(M.value)&&(t?M.value>0:M.value>=0)).sort((M,K)=>{const G=t?K.value-M.value:M.value-K.value;return G!==0?G:M.account.localeCompare(K.account)});let r=null,C=0;return f.map((M,K)=>((r===null||M.value!==r)&&(C=K+1,r=M.value),{rank:C,...M}))},zt=Array.from(Ae.values()).map(e=>{const t=Array.from(e.professions).filter(n=>n!=="Unknown");if(e.professionList=t,t.length>0){let n=t[0],f=e.professionTimeMs[n]||0;t.forEach(r=>{const C=e.professionTimeMs[r]||0;C>f&&(f=C,n=r)}),e.profession=n}return{key:e.account,stat:e}}),Nn=e=>{const t=Ae.get(e.account);if(!t){const r=e.professionList.length>0?e.professionList:e.profession?[e.profession]:[];return{...e,professionList:r}}const n=t.professionList&&t.professionList.length>0?t.professionList:Array.from(t.professions||[]).filter(r=>r&&r!=="Unknown"),f=t.profession||e.profession;return{...e,profession:f,professionList:n.length>0?n:f?[f]:[],activeMs:t.defenseActiveMs||t.totalFightMs||e.activeMs}},Fi=Array.from(It.values()).map(Nn).filter(e=>Ti(e.mitigationTotals)).sort((e,t)=>e.account.localeCompare(t.account)),Bi=Array.from(Pt.values()).map(Nn).filter(e=>e.mitigationTotals.totalMitigation>0).sort((e,t)=>{const n=e.account.localeCompare(t.account);return n!==0?n:String(e.minion||"").localeCompare(String(t.minion||""))}),xt=(e,t)=>{switch(t){case"downContrib":return e.downContrib;case"barrier":return e.barrier;case"healing":return e.healing;case"dodges":return e.dodges;case"strips":return e.strips;case"cleanses":return e.cleanses;case"cc":return e.cc;case"stability":return e.stab;case"revives":return e.revives;case"dps":return e.dps;case"damage":return e.damage;case"participation":return e.logsJoined;case"closestToTag":return!e.isCommander&&e.distCount>0?e.totalDist/e.distCount:Number.POSITIVE_INFINITY;default:return 0}},Ge=(e,t)=>Dn(zt.map(({stat:n})=>({account:n.account,profession:n.profession,professionList:n.professionList,value:xt(n,e),count:n.logsJoined})),t),xe={downContrib:Ge("downContrib",!0),barrier:Ge("barrier",!0),healing:Ge("healing",!0),dodges:Ge("dodges",!0),strips:Ge("strips",!0),cleanses:Ge("cleanses",!0),cc:Ge("cc",!0),stability:Ge("stability",!0),revives:Ge("revives",!0),participation:Ge("participation",!0),dps:Ge("dps",!0),damage:Ge("damage",!0),closestToTag:Ge("closestToTag",!1).filter(e=>Number.isFinite(e.value))},Ii={downContrib:"downContrib",barrier:"barrier",healing:"healing",dodges:"dodges",strips:"strips",cleanses:"cleanses",cc:"cc",stability:"stability",closestToTag:"closestToTag"},Ee=e=>{const t=e==null?void 0:e[0];return{value:(t==null?void 0:t.value)??0,player:(t==null?void 0:t.account)??"-",count:(t==null?void 0:t.count)??0,profession:(t==null?void 0:t.profession)??"Unknown",professionList:(t==null?void 0:t.professionList)??[]}},nt={maxDownContrib:Ee([]),maxBarrier:Ee([]),maxHealing:Ee([]),maxDodges:Ee([]),maxStrips:Ee([]),maxCleanses:Ee([]),maxCC:Ee([]),maxStab:Ee([]),closestToTag:Ee([])},ye={},Pi=(e,t)=>{if(t==="closestToTag")return xt(e,t);const n=Math.max(1,(e.totalFightMs||0)/1e3);return xt(e,t)/n};Object.values(Ii).forEach(e=>{const t=e!=="closestToTag";ye[e]=Dn(zt.map(({stat:n})=>({account:n.account,profession:n.profession,professionList:n.professionList,value:Pi(n,e),count:n.logsJoined})),t)}),nt.maxDownContrib=Ee(ye.downContrib),nt.maxBarrier=Ee(ye.barrier),nt.maxHealing=Ee(ye.healing),nt.maxDodges=Ee(ye.dodges),nt.maxStrips=Ee(ye.strips),nt.maxCleanses=Ee(ye.cleanses),nt.maxCC=Ee(ye.cc),nt.maxStab=Ee(ye.stability),nt.closestToTag=Ee(ye.closestToTag);const Hi={maxDownContrib:Ee(xe.downContrib),maxBarrier:Ee(xe.barrier),maxHealing:Ee(xe.healing),maxDodges:Ee(xe.dodges),maxStrips:Ee(xe.strips),maxCleanses:Ee(xe.cleanses),maxCC:Ee(xe.cc),maxStab:Ee(xe.stability),closestToTag:Ee(xe.closestToTag)};let Kt={player:"None",account:"None",score:-1,profession:"Unknown",professionList:[],color:"#64748b",topStats:[]},An,Tn,Mn=0;if(Se!=null&&Se.showMvp){const e={"Down Contribution":"downContribution",Healing:"healing",Cleanses:"cleanses",Strips:"strips",Stability:"stability",CC:"cc",Revives:"revives","Distance to Tag":"distanceToTag",Participation:"participation",Dodging:"dodging",DPS:"dps",Damage:"damage"},t=C=>{const M=e[C];return M?Number(oe[M]||0)>0:!1},n=[],f=C=>[...C||[]].filter(M=>t(M==null?void 0:M.name)).sort((M,K)=>K.ratio-M.ratio||M.rank-K.rank||M.name.localeCompare(K.name)).slice(0,3),r=C=>{var K;if(!C)return;const M=f(C.contribs);return{...C,player:C.name,reason:((K=M[0])==null?void 0:K.name)||"Top Performance",topStats:M}};zt.forEach(({stat:C})=>{let M=0;const K=[],G=(Q,pe,ue,Pe,E=!0)=>{var $,X;if(ue<=0)return;const w=(($=pe[0])==null?void 0:$.value)||0;if(w&&Number.isFinite(Q)&&(E?Q>0:Q<Number.POSITIVE_INFINITY)){const ae=E?Q/w:w/Q;M+=ae*ue;const l=((X=pe.find(u=>u.account===C.account))==null?void 0:X.rank)||0;K.push({name:Pe,ratio:ae,val:Q.toLocaleString(),rank:l})}};G(C.downContrib,xe.downContrib,oe.downContribution,"Down Contribution"),G(C.healing,xe.healing,oe.healing,"Healing"),G(C.cleanses,xe.cleanses,oe.cleanses,"Cleanses"),G(C.strips,xe.strips,oe.strips,"Strips"),G(C.stab,xe.stability,oe.stability,"Stability"),G(C.cc,xe.cc,oe.cc,"CC"),G(C.revives,xe.revives,oe.revives,"Revives"),G(xt(C,"closestToTag"),xe.closestToTag,oe.distanceToTag,"Distance to Tag",!1),G(C.logsJoined,xe.participation,oe.participation,"Participation"),G(C.dodges,xe.dodges,oe.dodging,"Dodging"),G(C.dps,xe.dps,oe.dps,"DPS"),G(C.damage,xe.damage,oe.damage,"Damage"),n.push({...C,score:M,contribs:K.filter(Q=>t(Q.name))})}),n.sort((C,M)=>M.score-C.score),n[0]&&n[0].score>0&&(Kt=r(n[0])||Kt),An=r(n[1]),Tn=r(n[2]),Mn=n.length>0?n.reduce((C,M)=>C+M.score,0)/n.length:0}const Ui=Object.values(Te).sort((e,t)=>{const n=R==="downContribution"?e.downContribution:e.damage;return(R==="downContribution"?t.downContribution:t.damage)-n}).slice(0,25),xi=Object.values(Me).sort((e,t)=>t.damage-e.damage).slice(0,25),$i=e=>{const t=String(e).replace(/^Detailed\s*WvW\s*-\s*/i,"").replace(/^World\s*vs\s*World\s*-\s*/i,"").replace(/^WvW\s*-\s*/i,"").trim(),n=t.match(/^(Red|Blue|Green)\s+(?:Alpine|Desert)?\s*Borderlands$/i);return n?`${n[1]} Borderlands`:t||"Unknown"},$t=(e,t)=>$i((e==null?void 0:e.zone)||(e==null?void 0:e.mapName)||(e==null?void 0:e.map)||(e==null?void 0:e.location)||(e==null?void 0:e.fightName)||(t==null?void 0:t.fightName)||(t==null?void 0:t.encounterName)||"Unknown"),Li=(e,t)=>{const n=(t==null?void 0:t.permalink)||(e==null?void 0:e.permalink);if(typeof n=="string"&&n.trim().length>0)return n.trim();const f=e==null?void 0:e.uploadLinks;if(!Array.isArray(f))return"";for(const r of f){if(typeof r=="string"&&r.trim().length>0)return r.trim();if(r&&typeof r=="object"){const C=r.permalink||r.link||r.url||r.reportLink;if(typeof C=="string"&&C.trim().length>0)return C.trim()}}return""},Gt={};W.forEach(e=>{const t=$t(e==null?void 0:e.details,e);Gt[t]=(Gt[t]||0)+1});const Ri=Object.entries(Gt).map(([e,t])=>{const n=String(e).trim(),f=/eternal battlegrounds|^ebg$/i.test(n);let r="#64748b";return f?r="#ffffff":/red/i.test(n)?r="#ef4444":/blue/i.test(n)?r="#3b82f6":/green/i.test(n)&&(r="#22c55e"),{name:e,value:t,color:r}}).sort((e,t)=>t.value-e.value),{boonTables:Oi}=_n(W),_i=W.map((e,t)=>{var f,r;const n=((f=e.details)==null?void 0:f.players)||[];return{index:t+1,label:`Log ${t+1}`,timestamp:et(e.details,e),squadCount:n.filter(C=>!C.notInSquad).length,friendlyCount:n.length,enemies:((r=e.details)==null?void 0:r.targets).filter(C=>!C.isFake).length}}).sort((e,t)=>e.timestamp-t.timestamp),Yt={};Array.from(Ae.values()).forEach(e=>{e.profession&&e.profession!=="Unknown"&&(Yt[e.profession]=(Yt[e.profession]||0)+1)});const qi=Object.entries(Yt).map(([e,t])=>({name:e,value:t,color:an(e)})).sort((e,t)=>t.value-e.value),Jt={};Object.keys(Ie).length===0&&W.forEach(e=>{var t,n;(n=(t=e.details)==null?void 0:t.targets)==null||n.forEach(f=>{if(f.isFake)return;const r=f.profession&&f.profession!=="Unknown"?f.profession:f.name||f.id||"Unknown",C=at(r);Jt[C]=(Jt[C]||0)+1})});const Wi=Object.keys(Ie).length>0?Ie:Jt,ji=Object.entries(Wi).map(([e,t])=>({name:e,value:t,color:an(e)})).sort((e,t)=>t.value-e.value),Vi=W.map((e,t)=>({log:e,originalIndex:t})).sort((e,t)=>et(e.log.details,e.log)-et(t.log.details,t.log)).map(({log:e},t)=>{const n=e.details;if(!n)return null;const f=n.players||[],r=f.filter(a=>!a.notInSquad),C=f.filter(a=>a.notInSquad),K=(n.targets||[]).filter(a=>!a.isFake),G=r.reduce((a,S)=>{var I,b;return a+(((b=(I=S.dpsAll)==null?void 0:I[0])==null?void 0:b.damage)||0)},0),Q=r.reduce((a,S)=>{var I,b;return a+(((b=(I=S.defenses)==null?void 0:I[0])==null?void 0:b.damageTaken)||0)},0),{enemyDeaths:pe,enemyDownsDeaths:ue}=He(n),Pe=Fe(n),E=et(n,e),w=$t(n,e),$=a=>{if(!a||typeof a!="object")return;const S=a.teamID??a.teamId??a.team??a.teamColor??a.team_color;if(S!=null)return S;const I=Object.keys(a).find(b=>/^team/i.test(b));return I?a[I]:void 0},X=(a,S)=>{const I={};return a.forEach(b=>{const U=S(b),re=at(U);re&&(I[re]=(I[re]||0)+1)}),I},ae=X(r,a=>(a==null?void 0:a.profession)||(a==null?void 0:a.name)),l=X(C,a=>(a==null?void 0:a.profession)||(a==null?void 0:a.name)),u=X(K,a=>(a==null?void 0:a.profession)||(a==null?void 0:a.name)||(a==null?void 0:a.id)),k=new Set;r.forEach(a=>{const S=$(a);S!=null&&k.add(String(S))});const h=new Map;K.forEach(a=>{if((a==null?void 0:a.enemyPlayer)===!1)return;const S=$(a);if(S==null)return;const I=String(S);k.has(I)||h.set(I,(h.get(I)||0)+1)});const v=Array.from(h.entries()).sort((a,S)=>{const I=S[1]-a[1];return I!==0?I:a[0].localeCompare(S[0],void 0,{numeric:!0})}).slice(0,3).map(([a,S])=>({teamId:a,count:S}));return{id:e.filePath||`fight-${t}`,label:e.encounterName||`Fight ${t+1}`,permalink:Li(n,e),timestamp:E,mapName:w,duration:Si(n.durationMS),isWin:Pe,squadCount:r.length,allyCount:C.length,enemyCount:K.length,teamBreakdown:v,alliesDown:r.reduce((a,S)=>{var I,b;return a+(((b=(I=S.defenses)==null?void 0:I[0])==null?void 0:b.downCount)||0)},0),alliesDead:r.reduce((a,S)=>{var I,b;return a+(((b=(I=S.defenses)==null?void 0:I[0])==null?void 0:b.deadCount)||0)},0),alliesRevived:r.reduce((a,S)=>{var I,b;return Number(((b=(I=S.statsAll)==null?void 0:I[0])==null?void 0:b.saved)||0)>0?a+1:a},0),rallies:0,enemyDeaths:pe,enemyDowns:Math.max(0,ue-pe),totalOutgoingDamage:G,totalIncomingDamage:Q,incomingBarrierAbsorbed:r.reduce((a,S)=>{var I,b;return a+(((b=(I=S.defenses)==null?void 0:I[0])==null?void 0:b.damageBarrier)||0)},0),outgoingBarrierAbsorbed:r.reduce((a,S)=>{var U;const I=(U=S.extBarrierStats)==null?void 0:U.outgoingBarrier;if(!Array.isArray(I))return a;let b=0;return I.forEach(re=>{if(Array.isArray(re)){re.forEach(Be=>{b+=Number((Be==null?void 0:Be.barrier)||0)});return}b+=Number((re==null?void 0:re.barrier)||0)}),a+b},0),squadClassCountsFight:ae,allyClassCountsFight:l,enemyClassCounts:u}}).filter(Boolean),zi=(e,t)=>{const n=(t==null?void 0:t.skillMap)||{},f=(t==null?void 0:t.buffMap)||{};let r=0,C="";const M=Q=>{const pe=Number(Q);if(!Number.isFinite(pe))return String(Q||"Unknown Skill");const ue=(n==null?void 0:n[`s${pe}`])||(n==null?void 0:n[`${pe}`]);if(ue!=null&&ue.name)return String(ue.name);const Pe=(f==null?void 0:f[`b${pe}`])||(f==null?void 0:f[`${pe}`]);return Pe!=null&&Pe.name?String(Pe.name):`Skill ${pe}`},K=Q=>{if(!Q||typeof Q!="object")return;const pe=[Number(Q.max),Number(Q.maxDamage),Number(Q.maxHit)].filter(Pe=>Number.isFinite(Pe)),ue=pe.length>0?Math.max(...pe):0;ue>r&&(r=ue,C=M(Q.id))};let G=!1;return Array.isArray(e==null?void 0:e.targetDamageDist)&&e.targetDamageDist.forEach(Q=>{Array.isArray(Q)&&Q.forEach(pe=>{Array.isArray(pe)&&pe.forEach(ue=>{G=!0,K(ue)})})}),(!G||r<=0)&&Array.isArray(e==null?void 0:e.totalDamageDist)&&e.totalDamageDist.forEach(Q=>{Array.isArray(Q)&&Q.forEach(pe=>K(pe))}),{peak:r,skillName:C||"Unknown Skill"}},Ki=(()=>{const e=E=>String(E||"").replace(/^Detailed\s*WvW\s*-\s*/i,"").replace(/^World\s*vs\s*World\s*-\s*/i,"").replace(/^WvW\s*-\s*/i,"").trim(),t=E=>e(E).toLowerCase().split(/[^a-z0-9]+/i).map(w=>w.trim()).filter(Boolean).map(w=>w.length>3&&w.endsWith("s")?w.slice(0,-1):w),n=(E,w)=>{const $=e(E),X=e(w);if(!X)return $;if(!$)return X;const ae=t($),l=t(X),u=new Set(ae),k=new Set(l),h=l.length>0&&l.every(a=>u.has(a)),v=ae.length>0&&ae.every(a=>k.has(a));return h||v?$:`${$} - ${X}`},f=[],r=new Map,C=E=>{const w=h=>{if(!Array.isArray(h)||h.length===0)return[];const v=[];for(let a=0;a<h.length;a+=1){const S=Number(h[a]||0),I=a>0?Number(h[a-1]||0):0;v.push(Math.max(0,S-I))}return v},$=h=>{if(!Array.isArray(h))return[];const v=h.reduce((S,I)=>Math.max(S,Array.isArray(I)?I.length:0),0);if(v<=0)return[];const a=new Array(v).fill(0);return h.forEach(S=>{if(Array.isArray(S))for(let I=0;I<v;I+=1)a[I]+=Number(S[I]||0)}),a},X=h=>Array.isArray(h)?h.map(v=>Number(v||0)):null,l=(h=>{if(!Array.isArray(h)||h.length===0)return null;const v=h[0];if(!Array.isArray(v))return null;if(Array.isArray(v[0])&&Array.isArray(v[0][0]))return $(v);if(Array.isArray(v[0])&&!Array.isArray(v[0][0])){const a=h.map(S=>X(Array.isArray(S)?S[0]:null)).filter(S=>Array.isArray(S)&&S.length>0);if(a.length>0)return $(a)}return null})(E==null?void 0:E.targetDamage1S),u=Array.isArray(E==null?void 0:E.damage1S)&&Array.isArray(E.damage1S[0])?E.damage1S[0]:null,k=l||(Array.isArray(u)?u.map(h=>Number(h||0)):[]);return w(k)},M=(E,w)=>{if(!Array.isArray(E)||E.length===0||w<=0)return 0;let $=0,X=0;for(let ae=0;ae<E.length;ae+=1)$+=Number(E[ae]||0),ae>=w&&($-=Number(E[ae-w]||0)),ae>=w-1&&$>X&&(X=$);return Math.max(0,X)},K=(E,w)=>{if(!Array.isArray(E)||E.length===0||w<=0)return[];const $=[];for(let X=0;X<E.length;X+=w){const ae=Math.min(X+w,E.length),l=E.slice(X,ae).reduce((u,k)=>u+Number(k||0),0);$.push(l)}return $},G=(E,w)=>{const $=Number(E);if(!Number.isFinite($))return{name:String(E||"Unknown Skill"),icon:void 0};const X=(w==null?void 0:w.skillMap)||{},ae=(w==null?void 0:w.buffMap)||{},l=(X==null?void 0:X[`s${$}`])||(X==null?void 0:X[`${$}`]);if(l!=null&&l.name)return{name:String(l.name),icon:l==null?void 0:l.icon};const u=(ae==null?void 0:ae[`b${$}`])||(ae==null?void 0:ae[`${$}`]);return u!=null&&u.name?{name:String(u.name),icon:u==null?void 0:u.icon}:{name:`Skill ${$}`,icon:void 0}},Q=E=>Array.isArray(E)?E.map(w=>Array.isArray(w)?[Number(w[0]),Number(w[1])]:w&&typeof w=="object"?[Number(w.time),Number(w.value)]:null).filter(w=>!!w&&Number.isFinite(w[0])&&w[0]>=0):[],pe=(E,w,$,X,ae)=>{if(!E.length||X<=0)return[];const l=Math.max(X*5e3,ae||0),u=U=>U.reduce((re,Be)=>Be>=0&&Be<=l+2e3?re+1:re,0),k=E.map(U=>Number(U||0)).filter(U=>Number.isFinite(U)&&U>=0);if(!k.length)return[];const h=[k],v=k.reduce((U,re)=>Math.max(U,re),0),a=k.reduce((U,re)=>Math.min(U,re),Number.POSITIVE_INFINITY);v>l*20&&h.push(k.map(U=>U/1e3)),v<=l*2&&a>=0&&v>0&&v<Math.max(120,X*5+10)&&h.push(k.map(U=>U*1e3));let S=k,I=0,b=-1;return h.forEach(U=>{const re=U.reduce((ve,qe)=>Math.min(ve,qe),Number.POSITIVE_INFINITY),Be=new Set([0,...w,...$]);if(Number.isFinite(re)&&l>0&&re>l){const ve=Math.floor(re/l)*l;Be.add(ve),Be.add(Math.max(0,ve-l))}Be.forEach(ve=>{const qe=U.map($e=>$e-ve),fe=u(qe);fe>b&&(b=fe,I=ve,S=U)})}),S.map(U=>U-I).filter(U=>Number.isFinite(U)&&U>=0)},ue=(E,w,$,X,ae)=>{const l=pe(E,w,$,X,ae);return Array.from(new Set(l.map(u=>Math.floor(u/5e3)).filter(u=>Number.isFinite(u)&&u>=0&&u<X)))};W.map(E=>({log:E,ts:et(E==null?void 0:E.details,E)})).sort((E,w)=>E.ts-w.ts).forEach(({log:E},w)=>{const $=E==null?void 0:E.details;if(!$)return;const X=e($.fightName||E.fightName||`Fight ${w+1}`),ae=$t($,E),l=n(X,String(ae||"")),u={},k=Array.isArray($.players)?$.players:[],h=k.flatMap(b=>{const U=b==null?void 0:b.combatReplayData;return Array.isArray(U)?U.map(re=>Number(re==null?void 0:re.start)):[Number(U==null?void 0:U.start)]}).filter(b=>Number.isFinite(b)&&b>=0);k.forEach(b=>{if(b!=null&&b.notInSquad)return;const U=String((b==null?void 0:b.account)||(b==null?void 0:b.name)||"Unknown"),re=String((b==null?void 0:b.character_name)||(b==null?void 0:b.display_name)||(b==null?void 0:b.name)||""),Be=String((b==null?void 0:b.profession)||"Unknown"),ve=`${U}|${Be}`,qe=zi(b,$),fe=Number(qe.peak||0),$e=C(b),o=Number(M($e,1)||0),p=Number(M($e,5)||0),P=Number(M($e,30)||0),Z=Math.max(0,Math.ceil(Number(($==null?void 0:$.durationMS)||0)/5e3)),z=Math.max(0,Math.ceil($e.length/5)),s=Math.max(Z,z),D=K($e,5),A=Array.from({length:s},(g,F)=>Number(D[F]||0)),H=new Map,ne=g=>{if(!g||typeof g!="object"||g.indirectDamage)return;const F=Number(g.totalDamage||0);if(!Number.isFinite(F)||F<=0)return;const q=Number(g.connectedHits||g.hits||0),j=G(g.id,$),ge=j.name,we=H.get(ge)||{skillName:ge,damage:0,hits:0,icon:j.icon};we.damage+=F,we.hits+=Number.isFinite(q)?q:0,!we.icon&&j.icon&&(we.icon=j.icon),H.set(ge,we)},ee=new Map;Array.isArray(b==null?void 0:b.targetDamageDist)&&b.targetDamageDist.forEach(g=>{Array.isArray(g)&&g.forEach(F=>{Array.isArray(F)&&F.forEach(q=>{const j=Number(q==null?void 0:q.id),ge=Number((q==null?void 0:q.totalDamage)||0);if(Number.isFinite(j)){const we=ee.get(j)||{damage:0,hits:0};we.damage+=Number.isFinite(ge)?ge:0,we.hits+=Number((q==null?void 0:q.connectedHits)||(q==null?void 0:q.hits)||0),ee.set(j,we)}ne(q)})})}),!($!=null&&$.detailedWvW)&&Array.isArray(b==null?void 0:b.totalDamageDist)&&b.totalDamageDist.forEach(g=>{Array.isArray(g)&&g.forEach(F=>{const q=Number(F==null?void 0:F.id);if(!Number.isFinite(q)){ne(F);return}const j=ee.get(q);if(!j){ne(F);return}const ge=Number((F==null?void 0:F.totalDamage)||0),we=Number((F==null?void 0:F.connectedHits)||(F==null?void 0:F.hits)||0),Je=ge-Number(j.damage||0),Ye=we-Number(j.hits||0);Je<=0&&Ye<=0||ne({...F,totalDamage:Math.max(0,Je),connectedHits:Math.max(0,Ye),hits:Math.max(0,Ye)})})});const Y=(()=>{const g=b==null?void 0:b.combatReplayData;return Array.isArray(g)?g.filter(F=>F&&typeof F=="object"):g&&typeof g=="object"?[g]:[]})(),te=Y.map(g=>Number(g==null?void 0:g.start)).filter(g=>Number.isFinite(g)&&g>=0),ie=Y.flatMap(g=>Q(g==null?void 0:g.down).map(([F])=>Number(F||0))),y=Y.flatMap(g=>Q(g==null?void 0:g.dead).map(([F])=>Number(F||0)));u[ve]={hit:fe,burst1s:o,burst5s:p,burst30s:P,skillName:qe.skillName,buckets5s:A,downIndices5s:ue(ie,te,h,s,Number(($==null?void 0:$.durationMS)||0)),deathIndices5s:ue(y,te,h,s,Number(($==null?void 0:$.durationMS)||0)),skillRows:Array.from(H.values()).sort((g,F)=>F.damage-g.damage).slice(0,50)};const J=r.get(ve)||{key:ve,account:U,displayName:U,characterName:re,profession:Be,professionList:[Be],logs:0,peakHit:0,peak1s:0,peak5s:0,peak30s:0,peakFightLabel:"",peakSkillName:""};J.logs+=1,J.professionList.includes(Be)||J.professionList.push(Be),!J.characterName&&re&&(J.characterName=re),fe>J.peakHit&&(J.peakHit=fe,J.peakFightLabel=l,J.peakSkillName=qe.skillName),o>J.peak1s&&(J.peak1s=o),p>J.peak5s&&(J.peak5s=p),P>J.peak30s&&(J.peak30s=P),r.set(ve,J)});const v=Object.values(u).reduce((b,U)=>Math.max(b,Number((U==null?void 0:U.hit)||0)),0),a=Object.values(u).reduce((b,U)=>Math.max(b,Number((U==null?void 0:U.burst1s)||0)),0),S=Object.values(u).reduce((b,U)=>Math.max(b,Number((U==null?void 0:U.burst5s)||0)),0),I=Object.values(u).reduce((b,U)=>Math.max(b,Number((U==null?void 0:U.burst30s)||0)),0);f.push({id:E.filePath||E.id||`fight-${w+1}`,shortLabel:`F${w+1}`,fullLabel:l,timestamp:et($,E),values:u,maxHit:v,max1s:a,max5s:S,max30s:I})});const Pe=Array.from(r.values()).sort((E,w)=>w.peakHit!==E.peakHit?w.peakHit-E.peakHit:E.displayName.localeCompare(w.displayName));return{fights:f,players:Pe}})(),Gi=(()=>{const e=l=>String(l||"").replace(/^Detailed\s*WvW\s*-\s*/i,"").replace(/^World\s*vs\s*World\s*-\s*/i,"").replace(/^WvW\s*-\s*/i,"").trim(),t=l=>e(l).toLowerCase().split(/[^a-z0-9]+/i).map(u=>u.trim()).filter(Boolean).map(u=>u.length>3&&u.endsWith("s")?u.slice(0,-1):u),n=(l,u)=>{const k=e(l),h=e(u);if(!h)return k;if(!k)return h;const v=t(k),a=t(h),S=new Set(v),I=new Set(a),b=a.length>0&&a.every(re=>S.has(re)),U=v.length>0&&v.every(re=>I.has(re));return b||U?k:`${k} - ${h}`},f=[],r=new Map,C=(l,u)=>{const k=Number(l);if(!Number.isFinite(k))return{name:String(l||"Unknown Skill"),icon:void 0};const h=(u==null?void 0:u.skillMap)||{},v=(u==null?void 0:u.buffMap)||{},a=(h==null?void 0:h[`s${k}`])||(h==null?void 0:h[`${k}`]);if(a!=null&&a.name)return{name:String(a.name),icon:a==null?void 0:a.icon};const S=(v==null?void 0:v[`b${k}`])||(v==null?void 0:v[`${k}`]);return S!=null&&S.name?{name:String(S.name),icon:S==null?void 0:S.icon}:{name:`Skill ${k}`,icon:void 0}},M=(l,u)=>{let k=0,h="";const v=a=>{if(!a||typeof a!="object"||a.indirectDamage)return;const S=[Number(a.max),Number(a.maxDamage),Number(a.maxHit)].filter(b=>Number.isFinite(b)),I=S.length>0?Math.max(...S):0;I>k&&(k=I,h=C(a.id,u).name)};return Array.isArray(l==null?void 0:l.totalDamageDist)&&l.totalDamageDist.forEach(a=>{Array.isArray(a)&&a.forEach(S=>v(S))}),Array.isArray(l==null?void 0:l.targetDamageDist)&&l.targetDamageDist.forEach(a=>{Array.isArray(a)&&a.forEach(S=>{Array.isArray(S)&&S.forEach(I=>v(I))})}),{peak:k,skillName:h||"Unknown Skill"}},K=l=>{if(!Array.isArray(l)||l.length===0)return[];const u=[];for(let k=0;k<l.length;k+=1){const h=Number(l[k]||0),v=k>0?Number(l[k-1]||0):0;u.push(Math.max(0,h-v))}return u},G=l=>{if(!Array.isArray(l)||l.length===0)return[];const u=l.reduce((h,v)=>Math.max(h,Array.isArray(v)?v.length:0),0);if(u<=0)return[];const k=new Array(u).fill(0);return l.forEach(h=>{if(Array.isArray(h))for(let v=0;v<u;v+=1)k[v]+=Number(h[v]||0)}),k},Q=l=>{if(!Array.isArray(l)||l.length===0)return[];const u=l[0];if(typeof u=="number")return l.map(k=>Number(k||0));if(Array.isArray(u)&&u.length>0){if(typeof u[0]=="number")return u.map(k=>Number(k||0));if(Array.isArray(u[0])){const k=u.map(h=>Array.isArray(h)?h.map(v=>Number(v||0)):null).filter(h=>Array.isArray(h)&&h.length>0);if(k.length>0)return G(k)}}return[]},pe=l=>{const u=Q(l==null?void 0:l.powerDamage1S),k=Q(l==null?void 0:l.damage1S),h=u.length>0?u:k;return K(h)},ue=(l,u)=>{const k=l==null?void 0:l.targetPowerDamage1S;if(!Array.isArray(k)||!Array.isArray(k[u]))return[];const h=k[u];if(!Array.isArray(h)||h.length===0)return[];if(typeof h[0]=="number")return h.map(v=>Number(v||0));if(Array.isArray(h[0])&&!Array.isArray(h[0][0]))return h[0].map(v=>Number(v||0));if(Array.isArray(h[0])&&Array.isArray(h[0][0])){const a=h[0].map(S=>Array.isArray(S)?S.map(I=>Number(I||0)):null).filter(S=>Array.isArray(S)&&S.length>0);return G(a)}return[]},Pe=(l,u)=>{if(!Array.isArray(l)||l.length===0||u<=0)return 0;let k=0,h=0;for(let v=0;v<l.length;v+=1)k+=Number(l[v]||0),v>=u&&(k-=Number(l[v-u]||0)),v>=u-1&&k>h&&(h=k);return Math.max(0,h)},E=(l,u)=>{if(!Array.isArray(l)||l.length===0||u<=0)return[];const k=[];for(let h=0;h<l.length;h+=u){const v=Math.min(h+u,l.length),a=l.slice(h,v).reduce((S,I)=>S+Number(I||0),0);k.push(a)}return k},w=l=>Array.isArray(l)?l.map(u=>Array.isArray(u)?[Number(u[0]),Number(u[1])]:u&&typeof u=="object"?[Number(u.time),Number(u.value)]:null).filter(u=>!!u&&Number.isFinite(u[0])&&u[0]>=0):[],$=(l,u,k,h,v)=>{if(!l.length||h<=0)return[];const a=Math.max(h*5e3,v||0),S=fe=>fe.reduce(($e,o)=>o>=0&&o<=a+2e3?$e+1:$e,0),I=l.map(fe=>Number(fe||0)).filter(fe=>Number.isFinite(fe)&&fe>=0);if(!I.length)return[];const b=[I],U=I.reduce((fe,$e)=>Math.max(fe,$e),0),re=I.reduce((fe,$e)=>Math.min(fe,$e),Number.POSITIVE_INFINITY);U>a*20&&b.push(I.map(fe=>fe/1e3)),U<=a*2&&re>=0&&U>0&&U<Math.max(120,h*5+10)&&b.push(I.map(fe=>fe*1e3));let Be=I,ve=0,qe=-1;return b.forEach(fe=>{const $e=fe.reduce((p,P)=>Math.min(p,P),Number.POSITIVE_INFINITY),o=new Set([0,...u,...k]);if(Number.isFinite($e)&&a>0&&$e>a){const p=Math.floor($e/a)*a;o.add(p),o.add(Math.max(0,p-a))}o.forEach(p=>{const P=fe.map(z=>z-p),Z=S(P);Z>qe&&(qe=Z,ve=p,Be=fe)})}),Be.map(fe=>fe-ve).filter(fe=>Number.isFinite(fe)&&fe>=0)},X=(l,u,k,h,v)=>{const a=$(l,u,k,h,v);return Array.from(new Set(a.map(S=>Math.floor(S/5e3)).filter(S=>Number.isFinite(S)&&S>=0&&S<h)))};W.map(l=>({log:l,ts:et(l==null?void 0:l.details,l)})).sort((l,u)=>l.ts-u.ts).forEach(({log:l},u)=>{const k=l==null?void 0:l.details;if(!k)return;const h=e(k.fightName||l.fightName||`Fight ${u+1}`),v=$t(k,l),a=n(h,String(v||"")),S={},b=(Array.isArray(k.players)?k.players:[]).filter(s=>!(s!=null&&s.notInSquad)),U=b.flatMap(s=>{const D=s==null?void 0:s.combatReplayData;return Array.isArray(D)?D.map(A=>Number(A==null?void 0:A.start)):[Number(D==null?void 0:D.start)]}).filter(s=>Number.isFinite(s)&&s>=0),re=b.flatMap(s=>{const D=s==null?void 0:s.combatReplayData;return(Array.isArray(D)?D:D?[D]:[]).flatMap(H=>w(H==null?void 0:H.down).map(([ne])=>Number(ne||0)))}),Be=b.flatMap(s=>{const D=s==null?void 0:s.combatReplayData;return(Array.isArray(D)?D:D?[D]:[]).flatMap(H=>w(H==null?void 0:H.dead).map(([ne])=>Number(ne||0)))}),ve=new Map,qe=new Map,fe=new Map;(Array.isArray(k.targets)?k.targets:[]).forEach((s,D)=>{if(!s||s.isFake||!s.enemyPlayer)return;const A=at((s==null?void 0:s.profession)||(s==null?void 0:s.name)||(s==null?void 0:s.id))||"Unknown";fe.set(A,(fe.get(A)||0)+1);const H=qe.get(A)||new Map;Array.isArray(s==null?void 0:s.totalDamageDist)&&s.totalDamageDist.forEach(ie=>{Array.isArray(ie)&&ie.forEach(y=>{if(!y||typeof y!="object"||y.indirectDamage)return;const J=Number(y.totalDamage||0);if(!Number.isFinite(J)||J<=0)return;const g=Number(y.connectedHits||y.hits||0),F=C(y.id,k),q=F.name,j=H.get(q)||{skillName:q,damage:0,hits:0,icon:F.icon};j.damage+=J,j.hits+=Number.isFinite(g)?g:0,!j.icon&&F.icon&&(j.icon=F.icon),H.set(q,j)})}),qe.set(A,H);const ne=G(b.map(ie=>ue(ie,D))),ee=ne.length>0?K(ne):pe(s),_=M(s,k);let Y=ve.get(A);Y||(Y={perSecond:[],hit:0,skillName:""},ve.set(A,Y)),ee.length>Y.perSecond.length&&(Y.perSecond.length=ee.length);for(let ie=0;ie<ee.length;ie+=1)Y.perSecond[ie]=Number(Y.perSecond[ie]||0)+Number(ee[ie]||0);const te=Number(_.peak||0);te>Y.hit&&(Y.hit=te,Y.skillName=_.skillName||"Unknown Skill")});const o=Array.from(ve.values()).some(s=>Array.isArray(s.perSecond)&&s.perSecond.some(D=>Number(D||0)>0));if(ve.size===0||!o){const s=G(b.map(A=>{const H=Q(A==null?void 0:A.powerDamageTaken1S);return K(H)})),D=Array.from(fe.values()).reduce((A,H)=>A+Number(H||0),0);s.length>0&&D>0&&fe.forEach((A,H)=>{const ne=Number(A||0)/D,ee=s.map(Y=>Number(Y||0)*ne),_=ve.get(H);ve.set(H,{perSecond:ee,hit:Number((_==null?void 0:_.hit)||0),skillName:String((_==null?void 0:_.skillName)||"")})})}ve.forEach((s,D)=>{var F;const A=D,H=Number(s.hit||0),ne=Number(Pe(s.perSecond,1)||0),ee=Number(Pe(s.perSecond,5)||0),_=Number(Pe(s.perSecond,30)||0),Y=Math.max(0,Math.ceil(Number((k==null?void 0:k.durationMS)||0)/5e3)),te=Math.max(0,Math.ceil(s.perSecond.length/5)),ie=Math.max(Y,te),y=E(s.perSecond,5),J=Array.from({length:ie},(q,j)=>Number(y[j]||0));S[A]={hit:H,burst1s:ne,burst5s:ee,burst30s:_,skillName:s.skillName||"Unknown Skill",buckets5s:J,downIndices5s:X(re,[],U,ie,Number((k==null?void 0:k.durationMS)||0)),deathIndices5s:X(Be,[],U,ie,Number((k==null?void 0:k.durationMS)||0)),skillRows:Array.from(((F=qe.get(D))==null?void 0:F.values())||[]).sort((q,j)=>j.damage-q.damage).slice(0,50)};const g=r.get(A)||{key:A,account:D,displayName:D,characterName:"",profession:D,professionList:[D],logs:0,peakHit:0,peak1s:0,peak5s:0,peak30s:0,peakFightLabel:"",peakSkillName:""};g.logs+=1,H>g.peakHit&&(g.peakHit=H,g.peakFightLabel=a,g.peakSkillName=s.skillName||"Unknown Skill"),ne>g.peak1s&&(g.peak1s=ne),ee>g.peak5s&&(g.peak5s=ee),_>g.peak30s&&(g.peak30s=_),r.set(A,g)});const p=Object.values(S).reduce((s,D)=>Math.max(s,Number((D==null?void 0:D.hit)||0)),0),P=Object.values(S).reduce((s,D)=>Math.max(s,Number((D==null?void 0:D.burst1s)||0)),0),Z=Object.values(S).reduce((s,D)=>Math.max(s,Number((D==null?void 0:D.burst5s)||0)),0),z=Object.values(S).reduce((s,D)=>Math.max(s,Number((D==null?void 0:D.burst30s)||0)),0);f.push({id:l.filePath||l.id||`fight-${u+1}`,shortLabel:`F${u+1}`,fullLabel:a,timestamp:et(k,l),values:S,maxHit:p,max1s:P,max5s:Z,max30s:z})});const ae=Array.from(r.values()).sort((l,u)=>u.peakHit!==l.peakHit?u.peakHit-l.peakHit:l.displayName.localeCompare(u.displayName));return{fights:f,players:ae}})(),Yi=Array.from(tt.entries()).map(([e,t])=>{const n=st.get(e)||{},f=Array.from(t.values()).map(r=>{var Pe,E;const C=Array.from(r.professions||[]).filter(w=>w&&w!=="Unknown");let M=r.profession||"Unknown";if(C.length>0){M=C[0];let w=((Pe=r.professionTimeMs)==null?void 0:Pe[M])||0;C.forEach($=>{var ae;const X=((ae=r.professionTimeMs)==null?void 0:ae[$])||0;X>w&&(w=X,M=$)})}const K=r.durationMs||0,G=r.totalMs/1e3,Q=K>0?r.totalMs/K:0,pe=((E=Ae.get(r.account))==null?void 0:E.supportActiveMs)||K,ue=pe>0?r.uptimeMs/pe:0;return{account:r.account,profession:M,professionList:C,total:G,perSecond:Q,uptimePerSecond:ue,duration:K/1e3}}).filter(r=>r.total>0||r.perSecond>0);return{id:e,name:n.name||e,icon:n.icon,rows:f}}).filter(e=>e.rows.length>0),Ji=Array.from(Ve.values()).map(e=>{const t=Array.from(e.skills.values()).sort((f,r)=>r.damage-f.damage),n=t.reduce((f,r)=>(f[r.id]=r,f),{});return{key:e.key,account:e.account,displayName:e.displayName,profession:e.profession,professionList:e.professionList,totalFightMs:e.totalFightMs,skills:t,skillMap:n}}).sort((e,t)=>e.displayName.localeCompare(t.displayName));return{total:V,wins:ke,losses:me,avgSquadSize:Mi,avgEnemies:wi,squadKDR:vi,enemyKDR:Ei,totalSquadKills:he,totalSquadDeaths:de,totalEnemyKills:be,totalEnemyDeaths:_e,leaderboards:xe,...Hi,outgoingConditionSummary:Object.values(Ue).sort((e,t)=>t.damage-e.damage),incomingConditionSummary:Object.values(Re).sort((e,t)=>t.damage-e.damage),outgoingConditionPlayers:Array.from(Ae.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,conditions:e.outgoingConditions})),incomingConditionPlayers:Array.from(Ae.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,conditions:e.incomingConditions})),topSkills:Ui,topIncomingSkills:xi,playerSkillBreakdowns:Ji,topSkillsMetric:R,mapData:Ri,timelineData:_i,boonTables:Oi,offensePlayers:Array.from(Ae.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,offenseTotals:e.offenseTotals,offenseRateWeights:e.offenseRateWeights,totalFightMs:e.totalFightMs})),defensePlayers:Array.from(Ae.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,defenseTotals:e.defenseTotals,activeMs:e.defenseActiveMs})),damageMitigationPlayers:Fi,damageMitigationMinions:Bi,supportPlayers:Array.from(Ae.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,supportTotals:e.supportTotals,activeMs:e.supportActiveMs})),healingPlayers:Array.from(Ae.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,healingTotals:e.healingTotals,activeMs:e.healingActiveMs})),mvp:Kt,silver:An,bronze:Tn,squadClassData:qi,enemyClassData:ji,fightBreakdown:Vi,spikeDamage:Ki,incomingStrikeDamage:Gi,specialTables:Yi,topStatsPerSecond:nt,topStatsLeaderboardsPerSecond:ye,avgMvpScore:Mn}})(),Ke=(()=>{const Ne=new Map,De=new Map,R=[],V=new Map,ke=new Map;W.forEach(L=>{const ce=L.details;if(!ce)return;const de=ce.skillMap||{},he=ce.fightName||"Log",_e=et(ce,L)||Date.now(),be={id:L.filePath||L.id||he,label:he,timestamp:_e,skillEntries:{},playerActiveSeconds:{},durationSeconds:ce.durationMS?ce.durationMS/1e3:0};(ce.players||[]).forEach(Fe=>{if(Fe.notInSquad)return;const Ae=Fe.account||Fe.name||"Unknown",je=Fe.profession||"Unknown",Te=`${Ae}|${je}`;let Me=De.get(Te);Me||(Me={key:Te,account:Ae,displayName:Ae,profession:je,professionList:[je],logs:0,totalActiveSeconds:0,skillTotals:{}},De.set(Te,Me)),Me.logs++;const Ve=(Array.isArray(Fe.activeTimes)?Fe.activeTimes[0]:0)/1e3;Me.totalActiveSeconds=(Me.totalActiveSeconds||0)+Ve,be.playerActiveSeconds[Te]=Ve,(Fe.rotation||[]).forEach(Ue=>{var Et,Ft,Bt;if(!(Ue!=null&&Ue.id))return;const Re=((Et=Ue.skills)==null?void 0:Et.length)||0;if(Re<=0)return;const Ie=`s${Ue.id}`,st=((Ft=de[Ie])==null?void 0:Ft.name)||`Skill ${Ue.id}`,tt=(Bt=de[Ie])==null?void 0:Bt.icon;Me.skillTotals[Ie]=(Me.skillTotals[Ie]||0)+Re,Ne.set(Ie,(Ne.get(Ie)||0)+Re),V.set(Ie,st),tt&&!ke.has(Ie)&&ke.set(Ie,tt),be.skillEntries[Ie]||(be.skillEntries[Ie]={name:st,icon:tt,players:{}}),!be.skillEntries[Ie].icon&&tt&&(be.skillEntries[Ie].icon=tt),be.skillEntries[Ie].players[Te]=(be.skillEntries[Ie].players[Te]||0)+Re})}),R.push(be)});const me=Array.from(Ne.entries()).map(([L,ce])=>({id:L,name:V.get(L)||L,total:ce,icon:ke.get(L)})).sort((L,ce)=>ce.total-L.total);return{logRecords:R,players:Array.from(De.values()),skillOptions:me,resUtilitySkills:[]}})();return{validLogs:W,stats:Oe,skillUsageData:Ke}};let Ze=null,mt=!1,rn=null,cn=0,ln=0,_t=null;const un=i=>{if(!i||typeof i!="object")return i;const c=(B,O)=>{const W={};return O.forEach(Se=>{B&&Object.prototype.hasOwnProperty.call(B,Se)&&(W[Se]=B[Se])}),W},m=c(i,["players","targets","durationMS","uploadTime","timeStart","timeStartStd","timeEnd","timeEndStd","fightName","success","teamCounts","combatReplayMetaData","skillMap","buffMap","encounterDuration","player_damage_mitigation","player_minion_damage_mitigation","playerDamageMitigation","playerMinionDamageMitigation"]);return Array.isArray(m.players)&&(m.players=m.players.map(B=>c(B,["name","display_name","character_name","profession","elite_spec","group","dpsAll","statsAll","dpsTargets","statsTargets","defenses","support","rotation","extHealingStats","extBarrierStats","squadBuffVolumes","selfBuffs","groupBuffs","squadBuffs","selfBuffsActive","groupBuffsActive","squadBuffsActive","buffUptimes","totalDamageDist","targetDamageDist","damage1S","targetDamage1S","powerDamageTaken1S","targetPowerDamage1S","totalDamageTaken","totalDamageTakenDist","minions","combatReplayData","hasCommanderTag","notInSquad","account","activeTimes","teamID","teamId","team","teamColor","team_color"]))),Array.isArray(m.targets)&&(m.targets=m.targets.map(B=>c(B,["id","name","isFake","dpsAll","statsAll","defenses","totalHealth","healthPercentBurned","enemyPlayer","totalDamageDist","powerDamage1S","damage1S","profession","teamID","teamId","team","teamColor","team_color"]))),m},Ni=i=>{if(!i||typeof i!="object")return i;const c={...i};return i.details?c.details=un(i.details):c.details=un(i),c},mn=()=>{if(!mt||!Ze)return;mt=!1,cn+=1;const i=_t;_t=null;const c=Di(Ze);self.postMessage({type:"result",result:c,computeId:cn,logCount:Ze.logs.length,token:ln,completedAt:Date.now(),flushId:i})},qt=()=>{rn===null&&(rn=setInterval(()=>{mn()},5e3))};self.onmessage=i=>{var m,B,O,W;const c=i.data;if((c==null?void 0:c.type)==="reset"){Ze={logs:[]},typeof c.token=="number"&&(ln=c.token),mt=!0,qt();return}if((c==null?void 0:c.type)==="settings"){Ze={logs:(Ze==null?void 0:Ze.logs)||[],precomputedStats:(m=c.payload)==null?void 0:m.precomputedStats,mvpWeights:(B=c.payload)==null?void 0:B.mvpWeights,statsViewSettings:(O=c.payload)==null?void 0:O.statsViewSettings,disruptionMethod:(W=c.payload)==null?void 0:W.disruptionMethod},mt=!0,qt();return}if((c==null?void 0:c.type)==="log"){Ze||(Ze={logs:[]}),Ze.logs.push(Ni(c.payload)),mt=!0,qt();return}(c==null?void 0:c.type)==="flush"&&(typeof c.flushId=="number"&&(_t=c.flushId),mt=!0,mn())}})();
