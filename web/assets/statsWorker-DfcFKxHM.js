(function(){"use strict";const zt=["selfBuffs","groupBuffs","squadBuffs"],Kt=o=>o!=null&&o.classification?o.classification==="Boon":!0,Gt=o=>`b${o}`,Bn=(o,c)=>{const u=Array.isArray(o==null?void 0:o.activeTimes)?o.activeTimes:[],v=typeof u[0]=="number"?u[0]:0;return v>0?v:c},Yt=(o,c,u,v,_,q,he)=>{const Q=o==="selfBuffs"?1:Math.max(o==="groupBuffs"?q-1:he-1,0);return!Q||!_?{generationMs:0,wastedMs:0}:c?{generationMs:u*_*Q,wastedMs:v*_*Q}:{generationMs:u/100*_*Q,wastedMs:v/100*_*Q}},In=o=>{const c=new Map,u=new Map;return o.forEach(q=>{const he=q.details;if(!he)return;const Q=he.durationMS||0,be=he.buffMap||{};Object.entries(be).forEach(([L,W])=>{if(!c.has(L)){c.set(L,W);return}const ke=c.get(L)||{},U={name:ke.name||W.name,stacking:ke.stacking??W.stacking,icon:ke.icon||W.icon,classification:ke.classification||W.classification};c.set(L,U)});const ye=(he.players||[]).filter(L=>!L.notInSquad),Ce=ye.length,Se=new Map;ye.forEach(L=>{const W=L.group??0;Se.set(W,(Se.get(W)||0)+1)}),ye.forEach(L=>{const W=L.account||L.name||L.character_name||"Unknown",ke=L.profession||"Unknown",U=L.group??0,ce=Se.get(U)||1,le=Bn(L,Q);u.has(W)||u.set(W,{account:W,profession:ke,professions:new Set,professionTimeMs:{},activeTimeMs:0,numFights:0,groupSupported:0,squadSupported:0,boons:{}});const ue=u.get(W);ue.profession=ke,ke!=="Unknown"&&(ue.professions.add(ke),ue.professionTimeMs[ke]=(ue.professionTimeMs[ke]||0)+le),ue.activeTimeMs+=le,ue.numFights+=1,ue.groupSupported+=ce,ue.squadSupported+=Ce,zt.forEach(De=>{(L[De]||[]).forEach(ge=>{var Ie,$e,Fe,Ze;if(typeof(ge==null?void 0:ge.id)!="number")return;const Ue=Gt(ge.id),Be=be[Ue];if(!Kt(Be))return;const Ae=(Be==null?void 0:Be.stacking)??!1,qe=(($e=(Ie=ge.buffData)==null?void 0:Ie[0])==null?void 0:$e.generation)??0,Ne=((Ze=(Fe=ge.buffData)==null?void 0:Fe[0])==null?void 0:Ze.wasted)??0,{generationMs:Te,wastedMs:je}=Yt(De,Ae,qe,Ne,Q,ce,Ce);!Te&&!je||(c.has(Ue)||c.set(Ue,Be||{}),ue.boons[Ue]||(ue.boons[Ue]={selfBuffs:{generationMs:0,wastedMs:0},groupBuffs:{generationMs:0,wastedMs:0},squadBuffs:{generationMs:0,wastedMs:0}}),ue.boons[Ue][De].generationMs+=Te,ue.boons[Ue][De].wastedMs+=je)})})})}),{boonTables:Array.from(c.keys()).filter(q=>Kt(c.get(q))).map(q=>{const he=c.get(q)||{},Q=[];return u.forEach(be=>{var L;const xe=be.boons[q];if(!xe||!zt.some(W=>xe[W].generationMs>0||xe[W].wastedMs>0))return;const Ce=Array.from(be.professions||[]).filter(W=>W&&W!=="Unknown");let Se=be.profession;if(Ce.length>0){Se=Ce[0];let W=((L=be.professionTimeMs)==null?void 0:L[Se])||0;Ce.forEach(ke=>{var ce;const U=((ce=be.professionTimeMs)==null?void 0:ce[ke])||0;U>W&&(W=U,Se=ke)})}Q.push({account:be.account,profession:Se||"Unknown",professionList:Ce,activeTimeMs:be.activeTimeMs||1,numFights:be.numFights||1,groupSupported:be.groupSupported||1,squadSupported:be.squadSupported||1,categories:{selfBuffs:{...xe.selfBuffs},groupBuffs:{...xe.groupBuffs},squadBuffs:{...xe.squadBuffs}}})}),{id:q,name:he.name||q,icon:he.icon,stacking:he.stacking??!1,rows:Q}}).filter(q=>q.rows.length>0)}},Jt=(o,c,u,v,_,q,he={})=>{var L,W,ke,U;const be=((o==null?void 0:o[c])||[]).find(ce=>ce.id===u);if(!be)return{generationMs:0,wastedMs:0};const xe=he[Gt(u)],ye=(xe==null?void 0:xe.stacking)??!1,Ce=((W=(L=be.buffData)==null?void 0:L[0])==null?void 0:W.generation)??0,Se=((U=(ke=be.buffData)==null?void 0:ke[0])==null?void 0:U.wasted)??0;return Yt(c,ye,Ce,Se,v,_,q)};var Pn={methods:{tiered:{tiers:{shortMs:500,mediumMs:1500,weights:{short:.5,medium:1,long:2}}}}};const Hn=Pn,Lt="count",Un=o=>(o||0)/1e3,Ln=(o,c)=>{var _;if(!o)return 0;const u=(_=Hn.methods.tiered)==null?void 0:_.tiers;if(!u)return o;const v=c/Math.max(o,1);return v<=u.shortMs?o*u.weights.short:v<=u.mediumMs?o*u.weights.medium:o*u.weights.long},Qt=(o,c,u)=>u==="duration"?Un(c):u==="tiered"?Ln(o,c):o;function $n(o,c=Lt){var q;const u=(q=o.statsAll)==null?void 0:q[0],v=Number((u==null?void 0:u.appliedCrowdControl)??0),_=Number((u==null?void 0:u.appliedCrowdControlDuration)??0);return Qt(v,_,c)}function xn(o,c){const u=(c==null?void 0:c.durationMS)||0,v=(c==null?void 0:c.buffMap)||{},_=o.filter(Q=>!Q.notInSquad),q=_.length,he=new Map;_.forEach(Q=>{const be=Q.group??0;he.set(be,(he.get(be)||0)+1)}),_.forEach(Q=>{const be=he.get(Q.group??0)||1,xe=Jt(Q,"selfBuffs",1122,u,be,q,v),ye=Jt(Q,"squadBuffs",1122,u,be,q,v);Q.stabGeneration=(xe.generationMs+ye.generationMs)/1e3})}function On(o){if(!o.statsTargets)return 0;let c=0;for(const u of o.statsTargets)u&&u.length>0&&(c+=u[0].downContribution||0);return c}function Rn(o){if(!o.extBarrierStats||!o.extBarrierStats.outgoingBarrierAllies)return 0;let c=0;for(const u of o.extBarrierStats.outgoingBarrierAllies)if(u)for(const v of u)v&&(c+=v.barrier||0);return c}function _n(o){if(!o.extHealingStats||!o.extHealingStats.outgoingHealingAllies)return 0;let c=0;for(const u of o.extHealingStats.outgoingHealingAllies)if(u)for(const v of u)v&&(c+=v.healing||0);return c}const qn=o=>{var c,u,v,_;return(((u=(c=o.support)==null?void 0:c[0])==null?void 0:u.condiCleanse)||0)+(((_=(v=o.support)==null?void 0:v[0])==null?void 0:_.condiCleanseSelf)||0)},jn=(o,c=Lt)=>{var q;const u=(q=o.support)==null?void 0:q[0],v=Number((u==null?void 0:u.boonStrips)??0),_=Number((u==null?void 0:u.boonStripsTime)??0);return Qt(v,_,c)},Wn=o=>On(o),yn=o=>_n(o),Vn=o=>Rn(o),zn=(o,c=Lt)=>$n(o,c),Kn=(o,c)=>xn(o,c),Gn="count",Yn={downContribution:1,healing:1,cleanses:1,strips:1,stability:1,cc:.7,revives:.7,distanceToTag:.7,participation:.7,dodging:.4,dps:.2,damage:.2},Jn={showMvp:!0,topSkillDamageSource:"target",topSkillsMetric:"damage"},Xt=new Map([["bleeding","Bleeding"],["burning","Burning"],["confusion","Confusion"],["poison","Poison"],["torment","Torment"],["vulnerability","Vulnerability"],["weakness","Weakness"],["weakened","Weakness"],["blind","Blind"],["blinded","Blind"],["blinding","Blind"],["cripple","Cripple"],["crippled","Cripple"],["chill","Chill"],["chilled","Chill"],["immob","Immobilize"],["immobile","Immobilize"],["immobilized","Immobilize"],["slow","Slow"],["slowed","Slow"],["fear","Fear"],["feared","Fear"],["taunt","Taunt"],["taunted","Taunt"]]),Qn={Blind:"https://render.guildwars2.com/file/09770136BB76FD0DBE1CC4267DEED54774CB20F6/102837.png",Chill:"https://render.guildwars2.com/file/28C4EC547A3516AF0242E826772DA43A5EAC3DF3/102839.png",Cripple:"https://render.guildwars2.com/file/070325E519C178D502A8160523766070D30C0C19/102838.png",Fear:"https://render.guildwars2.com/file/30307A6E766D74B6EB09EDA12A4A2DE50E4D76F4/102869.png",Immobilize:"https://render.guildwars2.com/file/397A613651BFCA2832B6469CE34735580A2C120E/102844.png",Slow:"https://render.guildwars2.com/file/F60D1EF5271D7B9319610855676D320CD25F01C6/961397.png",Taunt:"https://render.guildwars2.com/file/02EED459AD65FAF7DF32A260E479C625070841B9/1228472.png",Vulnerability:"https://render.guildwars2.com/file/3A394C1A0A3257EB27A44842DDEEF0DF000E1241/102850.png",Weakness:"https://render.guildwars2.com/file/6CB0E64AF9AA292E332A38C1770CE577E2CDE0E8/102853.png"},ft=o=>{if(!o)return null;const c=o.trim().toLowerCase(),u=Xt.get(c);if(u)return u;const v=c.split(/[^a-z]+/).filter(Boolean);for(const _ of v){const q=Xt.get(_);if(q)return q}return null},Xn=o=>ft(o),Zt=o=>{const c=new Map;return o&&(Object.values(o).forEach(u=>{if(!(u!=null&&u.icon)||!(u!=null&&u.name))return;const v=ft(u.name);v&&(c.has(v)||c.set(v,u.icon))}),Object.entries(Qn).forEach(([u,v])=>{c.has(u)||c.set(u,v)})),c},Nt=(o,c,u)=>{var v;if(c&&u){const _=(v=u[`b${c}`])==null?void 0:v.name,q=ft(_);if(q)return q}return o?ft(o):null},Zn=o=>{const c=(o==null?void 0:o.account)||"Unknown";return c&&c!=="Unknown"?c:(o==null?void 0:o.name)||"Unknown"||null},ei=o=>{if(!o||o.length===0)return 0;let c=0,u=null;return o.forEach(v=>{const _=Number(v[1]??0);if(Number.isFinite(_)){if(u===null){u=_;return}_>u&&(c+=_-u),u=_}}),c},ti=o=>{if(!o||o.length===0)return 0;let c=0;return o.forEach(u=>{const v=Number(u[0]??0),_=Number(u[1]??0);Number.isFinite(_)&&v!==0&&_>0&&(c+=1)}),c},ni=o=>{const{players:c,targets:u,skillMap:v,buffMap:_}=o,q=o.getPlayerKey||Zn,he=Zt(_),Q={},be={};c.forEach(L=>{if(L!=null&&L.notInSquad)return;const W=q(L);W&&(Q[W]||(Q[W]={}),L!=null&&L.totalDamageDist&&L.totalDamageDist.forEach(ke=>{ke&&ke.forEach(U=>{if(!U.id)return;let ce=`Skill ${U.id}`,le;v&&(v[`s${U.id}`]?(ce=v[`s${U.id}`].name||ce,le=v[`s${U.id}`].icon||le):v[`${U.id}`]&&(ce=v[`${U.id}`].name||ce,le=v[`${U.id}`].icon||le));const ue=Nt(ce,U.id,_);if(!ue)return;const De=_==null?void 0:_[`b${U.id}`],_e=De==null?void 0:De.name,ge=he.get(ue)||(De==null?void 0:De.icon),Ue=ce.startsWith("Skill ")?_e||ue:ce,Be=le||(De==null?void 0:De.icon),Ae=Number(U.connectedHits??0),qe=Number(U.hits??0),Ne=Ae>0?Ae:qe,Te=Number(U.totalDamage??0);if(!Number.isFinite(Ne)&&!Number.isFinite(Te))return;const je=be[ue]||{name:ue,icon:ge,applications:0,damage:0};je.applications+=Number.isFinite(Ne)?Ne:0,je.damage+=Number.isFinite(Te)?Te:0,!je.icon&&ge&&(je.icon=ge),be[ue]=je;const Ie=Q[W][ue]||{icon:ge,applications:0,damage:0,skills:{}};Ie.applications+=Number.isFinite(Ne)?Ne:0,Ie.damage+=Number.isFinite(Te)?Te:0;const $e=Ie.skills[Ue]||{name:Ue,hits:0,damage:0,icon:Be};$e.hits+=Number.isFinite(Ne)?Ne:0,$e.damage+=Number.isFinite(Te)?Te:0,!$e.icon&&Be&&($e.icon=Be),Ie.skills[Ue]=$e,!Ie.icon&&ge&&(Ie.icon=ge),Q[W][ue]=Ie})}))});const xe=new Map;c.forEach(L=>{if(L!=null&&L.notInSquad)return;const W=q(L);W&&L!=null&&L.name&&xe.set(L.name,W)});let ye=0,Ce=0,Se=0;return u.forEach(L=>{L!=null&&L.buffs&&L.buffs.forEach(W=>{const ke=Number(W==null?void 0:W.id);if(!Number.isFinite(ke))return;const U=_==null?void 0:_[`b${ke}`],ce=ft(U==null?void 0:U.name);if(!ce||U!=null&&U.classification&&U.classification!=="Condition")return;const le=ce;if(!le)return;const ue=W.statesPerSource||{};Se+=1,Object.entries(ue).forEach(([De,_e])=>{var Ne;const ge=xe.get(De);if(!ge)return;Ce+=1;const Ue=ei(_e),Be=ti(_e);ye+=Ue;const Ae=((Ne=Q[ge])==null?void 0:Ne[le])||{applications:0,damage:0,skills:{}};Ae.applicationsFromBuffs=(Ae.applicationsFromBuffs||0)+Ue,Ae.applicationsFromBuffsActive=(Ae.applicationsFromBuffsActive||0)+Be,Q[ge]=Q[ge]||{},Q[ge][le]=Ae;const qe=be[le]||{name:le,applications:0,damage:0};qe.applicationsFromBuffs=(qe.applicationsFromBuffs||0)+Ue,qe.applicationsFromBuffsActive=(qe.applicationsFromBuffsActive||0)+Be,be[le]=qe})})}),Object.values(Q).forEach(L=>{Object.values(L).forEach(W=>{typeof W.applicationsFromBuffs=="number"&&(W.applications=W.applicationsFromBuffs)})}),Object.values(be).forEach(L=>{typeof L.applicationsFromBuffs=="number"&&(L.applications=L.applicationsFromBuffs)}),{playerConditions:Q,summary:be,meta:{buffStateApplicationsTotal:ye,targetBuffEntriesSeen:Se,buffStateSourcesSeen:Ce}}},ii=new Set(["Vulnerability","Weakness","Blind","Cripple","Chill","Immobilize","Slow","Fear","Taunt"]),oi=[{id:"damage",label:"Damage",field:"damage",source:"dpsAll"},{id:"directDmg",label:"Direct Damage",field:"directDmg",source:"statsTargets"},{id:"connectedDamageCount",label:"Connected Damage Count",field:"connectedDamageCount",source:"statsTargets"},{id:"connectedDirectDamageCount",label:"Connected Direct Damage Count",field:"connectedDirectDamageCount",source:"statsTargets"},{id:"battleStandardHits",label:"Battle Standard Tracking"},{id:"criticalRate",label:"Critical Rate",field:"criticalRate",isRate:!0,isPercent:!0,denomField:"critableDirectDamageCount",source:"statsTargets"},{id:"criticalDmg",label:"Critical Damage",field:"criticalDmg",source:"statsTargets"},{id:"flankingRate",label:"Flanking Rate",field:"flankingRate",isRate:!0,isPercent:!0,denomField:"connectedDirectDamageCount",source:"statsTargets"},{id:"glanceRate",label:"Glance Rate",field:"glanceRate",isRate:!0,isPercent:!0,denomField:"connectedDirectDamageCount",source:"statsTargets"},{id:"missed",label:"Missed",field:"missed",source:"statsTargets"},{id:"evaded",label:"Evaded (enemy)",field:"evaded",source:"statsTargets"},{id:"blocked",label:"Blocked (enemy)",field:"blocked",source:"statsTargets"},{id:"interrupts",label:"Interrupts",field:"interrupts",source:"statsTargets"},{id:"invulned",label:"Invulned",field:"invulned",source:"statsTargets"},{id:"killed",label:"Killed",field:"killed",source:"statsTargets"},{id:"downed",label:"Downed",field:"downed",source:"statsTargets"},{id:"downContribution",label:"Down Contribution",field:"downContribution",source:"statsTargets"},{id:"downContributionPercent",label:"Down Contribution %",isRate:!0,isPercent:!0},{id:"againstDownedDamage",label:"Against Downed Damage",field:"againstDownedDamage",source:"statsTargets"},{id:"appliedCrowdControl",label:"Applied CC",field:"appliedCrowdControl",source:"statsTargets"},{id:"appliedCrowdControlDuration",label:"Applied CC Duration",field:"appliedCrowdControlDuration",source:"statsTargets"},{id:"appliedCrowdControlDownContribution",label:"Applied CC Down Contribution",field:"appliedCrowdControlDownContribution",source:"statsTargets"},{id:"appliedCrowdControlDurationDownContribution",label:"Applied CC Duration Down Contribution",field:"appliedCrowdControlDurationDownContribution",source:"statsTargets"},{id:"boonStrips",label:"Boon Strips",field:"boonStrips",source:"support"}],si=[{id:"damageTaken",label:"Damage Taken",field:"damageTaken"},{id:"damageTakenCount",label:"Damage Taken Count",field:"damageTakenCount"},{id:"conditionDamageTaken",label:"Condition Damage Taken",field:"conditionDamageTaken"},{id:"conditionDamageTakenCount",label:"Condition Damage Taken Count",field:"conditionDamageTakenCount"},{id:"powerDamageTaken",label:"Power Damage Taken",field:"powerDamageTaken"},{id:"powerDamageTakenCount",label:"Power Damage Taken Count",field:"powerDamageTakenCount"},{id:"downedDamageTaken",label:"Downed Damage Taken",field:"downedDamageTaken"},{id:"downedDamageTakenCount",label:"Downed Damage Taken Count",field:"downedDamageTakenCount"},{id:"damageBarrier",label:"Damage Barrier",field:"damageBarrier"},{id:"damageBarrierCount",label:"Damage Barrier Count",field:"damageBarrierCount"},{id:"blockedCount",label:"Blocked Count",field:"blockedCount"},{id:"evadedCount",label:"Evaded Count",field:"evadedCount"},{id:"missedCount",label:"Missed Count",field:"missedCount"},{id:"dodgeCount",label:"Dodge Count",field:"dodgeCount"},{id:"invulnedCount",label:"Invulnerable Count",field:"invulnedCount"},{id:"interruptedCount",label:"Interrupted Count",field:"interruptedCount"},{id:"downCount",label:"Down Count",field:"downCount"},{id:"deadCount",label:"Death Count",field:"deadCount"},{id:"boonStrips",label:"Boon Strips (Incoming)",field:"boonStrips"},{id:"conditionCleanses",label:"Cleanses (Incoming)",field:"conditionCleanses"},{id:"receivedCrowdControl",label:"Crowd Control (Incoming)",field:"receivedCrowdControl"}],ai=[{id:"condiCleanse",label:"Condition Cleanses",field:"condiCleanse"},{id:"condiCleanseTime",label:"Condition Cleanse Time",field:"condiCleanseTime",isTime:!0},{id:"condiCleanseSelf",label:"Condition Cleanse Self",field:"condiCleanseSelf"},{id:"condiCleanseTimeSelf",label:"Condition Cleanse Time Self",field:"condiCleanseTimeSelf",isTime:!0},{id:"boonStrips",label:"Boon Strips",field:"boonStrips"},{id:"boonStripsTime",label:"Boon Strips Time",field:"boonStripsTime",isTime:!0},{id:"boonStripDownContribution",label:"Boon Strip Down Contribution",field:"boonStripDownContribution"},{id:"boonStripDownContributionTime",label:"Boon Strip Down Contribution Time",field:"boonStripDownContributionTime",isTime:!0},{id:"stunBreak",label:"Stun Breaks",field:"stunBreak"},{id:"removedStunDuration",label:"Removed Stun Duration",field:"removedStunDuration",isTime:!0},{id:"resurrects",label:"Resurrects",field:"resurrects"},{id:"resurrectTime",label:"Resurrect Time",field:"resurrectTime",isTime:!0}],ri=["battle standard","glyph of renewal","glyph of the stars","illusion of life","spirit of nature","nature spirit","search and rescue","signet of mercy"],ci=new Set([10244]),li=(o,c)=>{var _;if(ci.has(o))return!0;const u=(c==null?void 0:c[`s${o}`])||(c==null?void 0:c[`${o}`]),v=((_=u==null?void 0:u.name)==null?void 0:_.toLowerCase())||"";return ri.some(q=>v.includes(q))},ui=o=>{if(!o||!Number.isFinite(o))return"--:--";const c=Math.max(0,Math.round(o/1e3)),u=Math.floor(c/3600),v=Math.floor(c%3600/60),_=c%60;return u>0?`${u}:${String(v).padStart(2,"0")}:${String(_).padStart(2,"0")}`:`${v}:${String(_).padStart(2,"0")}`},At={Guardian:"#72C1D9",Dragonhunter:"#72C1D9",Firebrand:"#72C1D9",Willbender:"#72C1D9",Revenant:"#D16E5A",Herald:"#D16E5A",Renegade:"#D16E5A",Vindicator:"#D16E5A",Warrior:"#FFD166",Berserker:"#FFD166",Spellbreaker:"#FFD166",Bladesworn:"#FFD166",Engineer:"#D09C59",Scrapper:"#D09C59",Holosmith:"#D09C59",Mechanist:"#D09C59",Ranger:"#8CDC82",Druid:"#8CDC82",Soulbeast:"#8CDC82",Untamed:"#8CDC82",Thief:"#C08F95",Daredevil:"#C08F95",Deadeye:"#C08F95",Specter:"#C08F95",Elementalist:"#F68A87",Tempest:"#F68A87",Weaver:"#F68A87",Catalyst:"#F68A87",Mesmer:"#B679D5",Chronomancer:"#B679D5",Mirage:"#B679D5",Virtuoso:"#B679D5",Necromancer:"#52A76F",Reaper:"#52A76F",Scourge:"#52A76F",Harbinger:"#52A76F",Ritualist:"#52A76F",Luminary:"#72C1D9",Conduit:"#D16E5A",Paragon:"#FFD166",Amalgam:"#D09C59",Galeshot:"#8CDC82",Antiquary:"#C08F95",Evoker:"#F68A87",Troubadour:"#B679D5",Unknown:"#64748B"};function en(o){return At[o]||At.Unknown}const mi=o=>{if(o==null||o==="")return 0;if(typeof o=="number")return!Number.isFinite(o)||o<=0?0:o>1e12?o:o*1e3;if(o instanceof Date){const he=o.getTime();return Number.isFinite(he)&&he>0?he:0}const c=String(o).trim();if(!c)return 0;const u=Number(c);if(Number.isFinite(u)&&u>0)return u>1e12?u:u*1e3;const v=Date.parse(c);if(Number.isFinite(v)&&v>0)return v;const _=c.replace(/([+-]\d{2})$/,"$1:00"),q=Date.parse(_);return Number.isFinite(q)&&q>0?q:0},Je=(o,c)=>mi((o==null?void 0:o.uploadTime)??(c==null?void 0:c.uploadTime)??(o==null?void 0:o.timeStartStd)??(o==null?void 0:o.timeStart)??(o==null?void 0:o.timeEndStd)??(o==null?void 0:o.timeEnd)??(o==null?void 0:o.timeStartText)??(o==null?void 0:o.timeEndText)),di=({logs:o,precomputedStats:c,mvpWeights:u,statsViewSettings:v,disruptionMethod:_})=>{const q=(()=>{const Ce=o.filter(Se=>Se.details&&Se.details.players&&Se.details.players.length>0);return console.log("[useStatsAggregation] Filtering logs:",{total:o.length,passed:Ce.length,statuses:o.map(Se=>Se.status),hasDetails:o.map(Se=>!!Se.details)}),Ce})(),he=v||Jn,Q=u||Yn,be=Ce=>{if(!Ce||typeof Ce!="object")return Ce;const Se=Array.isArray(Ce.fightBreakdown)?Ce.fightBreakdown:null;if(!Se||Se.length===0)return Ce;const L=new Map,W=new Map;o.forEach(U=>{var ue;const ce=(U==null?void 0:U.filePath)||(U==null?void 0:U.id);ce&&L.set(String(ce),U);const le=(U==null?void 0:U.permalink)||((ue=U==null?void 0:U.details)==null?void 0:ue.permalink);typeof le=="string"&&le.trim()&&W.set(le.trim(),U)});const ke=Se.map(U=>{if(!U||typeof U!="object"||Number(U.timestamp)>0)return U;const le=U.id?String(U.id):"",ue=typeof U.permalink=="string"?U.permalink.trim():"",De=(le?L.get(le):void 0)||(ue?W.get(ue):void 0);if(!De)return U;const _e=Je(De==null?void 0:De.details,De);return _e?{...U,timestamp:_e}:U});return{...Ce,fightBreakdown:ke}},xe=(()=>{if(c)return be(c);const Ce=_||Gn,Se=he.topSkillDamageSource||"target",L=he.topSkillsMetric||"damage",W=q.length;let ke=0,U=0,ce=0,le=0,ue=0,De=0,_e=0,ge=0;const Ue=e=>{const n=((e==null?void 0:e.players)||[]).filter(z=>!z.notInSquad);let m=0,r=0,C=0,T=0;return n.forEach(z=>{var oe;const E=(oe=z.defenses)==null?void 0:oe[0];if(!E)return;const Y=Number(E.downCount||0),pe=Number(E.deadCount||0);m+=Y+pe,C+=pe}),n.forEach(z=>{!z.statsTargets||z.statsTargets.length===0||z.statsTargets.forEach(E=>{const Y=E==null?void 0:E[0];if(!Y)return;const pe=Number(Y.downed||0),oe=Number(Y.killed||0);r+=pe+oe,T+=oe})}),{squadDownsDeaths:m,enemyDownsDeaths:r,squadDeaths:C,enemyDeaths:T}},Be=e=>{const{squadDownsDeaths:t,enemyDownsDeaths:n}=Ue(e);return t>0||n>0?n>t:typeof(e==null?void 0:e.success)=="boolean"?e.success:!1},Ae=new Map,qe=new Set(["boonStripsTime","condiCleanseTime","condiCleanseTimeSelf"]),Ne={},Te={},je=new Map,Ie={},$e={},Fe={},Ze=new Map,Qe=new Map,Tt=new Set(Object.keys(At)),Mt=Object.keys(At).filter(e=>e&&e!=="Unknown").sort((e,t)=>t.length-e.length),wt=["Guardian","Revenant","Warrior","Engineer","Ranger","Thief","Elementalist","Mesmer","Necromancer"],st=e=>{if(!e)return"Unknown";const t=String(e).replace(/\s*\([^)]*\)\s*$/,"").replace(/\s*\[[^\]]*\]\s*$/,"").replace(/\s\d+$/,"").trim();if(Tt.has(t))return t;const n=t.toLowerCase();for(const r of Mt)if(n.includes(r.toLowerCase()))return r;return wt.find(r=>n.includes(r.toLowerCase()))||t||"Unknown"},gi=e=>e!=null&&e.classification?e.classification==="Boon":!0,vt=new Map,Et=new Map,gt=()=>({totalHits:0,blocked:0,evaded:0,glanced:0,missed:0,invulned:0,interrupted:0,totalMitigation:0,minMitigation:0}),ie=e=>{const t=Number(e);return Number.isFinite(t)?t:0},rn=e=>{const t=String(e).split("|"),n=t[0]||"Unknown",m=st(t[1]||"Unknown"),r=t[2]||n||"Unknown";return{name:n,profession:m,account:r}},cn=(e,t,n)=>{let m=e.get(t);return m?n.profession&&!m.professionList.includes(n.profession)&&m.professionList.push(n.profession):(m={account:n.account,name:n.name,profession:n.profession,professionList:n.profession?[n.profession]:[],activeMs:0,mitigationTotals:gt()},e.set(t,m)),m},ln=(e,t,n)=>{let m=e.get(t);return m?n.profession&&!m.professionList.includes(n.profession)&&m.professionList.push(n.profession):(m={account:n.account,name:n.name,profession:n.profession,professionList:n.profession?[n.profession]:[],activeMs:0,mitigationTotals:gt(),minion:n.minion},e.set(t,m)),m},un=(e,t)=>{e.totalHits+=ie((t==null?void 0:t.skill_hits)??(t==null?void 0:t.skillHits)),e.blocked+=ie(t==null?void 0:t.blocked),e.evaded+=ie(t==null?void 0:t.evaded),e.glanced+=ie(t==null?void 0:t.glanced),e.missed+=ie(t==null?void 0:t.missed),e.invulned+=ie(t==null?void 0:t.invulned),e.interrupted+=ie(t==null?void 0:t.interrupted),e.totalMitigation+=ie((t==null?void 0:t.avoided_damage)??(t==null?void 0:t.avoidedDamage)),e.minMitigation+=ie((t==null?void 0:t.min_avoided_damage)??(t==null?void 0:t.minAvoidedDamage))},pi=e=>Object.values(e).some(t=>t>0);console.log("[useStatsAggregation] Starting aggregation loop",{validLogsCount:q.length});const Ft=(e,t,n)=>{var C,T,z,E;const m=`s${e}`;if((C=t==null?void 0:t[m])!=null&&C.name)return t[m].name;if((T=t==null?void 0:t[String(e)])!=null&&T.name)return t[String(e)].name;const r=`b${e}`;return(z=n==null?void 0:n[r])!=null&&z.name?n[r].name:(E=n==null?void 0:n[String(e)])!=null&&E.name?n[String(e)].name:`Unknown Skill ${e}`},pt=new Map,at=e=>{const t=pt.get(e);if(!t)return{hasSkill:!1,avg:1,min:1,hits:0};const n=t.connectedHits||0,m=n>0?t.totalDamage/n:0,r=t.minCount>0?t.minTotal/t.minCount:0;return{hasSkill:!0,avg:m,min:r,hits:n}},Bt="Ashtonlightstone.9145",mn="Illusionary Warden",Ot=[],rt=[],Rt=[],_t=[],dn=new Map,fn=new Map,gn=(e,t,n)=>{const m=e.get(t)||gt();return m.totalHits+=n.totalHits,m.blocked+=n.blocked,m.evaded+=n.evaded,m.glanced+=n.glanced,m.missed+=n.missed,m.invulned+=n.invulned,m.interrupted+=n.interrupted,e.set(t,m),m};q.forEach(e=>{const t=e.details;if(!t)return;(t.targets||[]).forEach(m=>{const r=(m==null?void 0:m.totalDamageDist)||[],C=Array.isArray(r)?r[0]:null;C==null||C.forEach(T=>{if(!(T!=null&&T.id))return;const z=Number(T.id),E=pt.get(z)||{totalDamage:0,connectedHits:0,minTotal:0,minCount:0};E.totalDamage+=Number(T.totalDamage||0),E.connectedHits+=Number(T.connectedHits||0);const Y=Number.isFinite(Number(T.min))?Number(T.min):0;E.minTotal+=Y,E.minCount+=1,pt.set(z,E)})})}),q.forEach((e,t)=>{var se,Oe;const n=e.details;if(!n)return;const m=n.players;console.log(`[useStatsAggregation] Processing log ${t}:`,{playerCount:m==null?void 0:m.length,hasTargets:!!n.targets,firstPlayer:m!=null&&m[0]?{account:m[0].account,notInSquad:m[0].notInSquad}:"none"});const r=n.targets||[],C=n.skillMap||{},T=n.buffMap||{},z=new Map,E=new Map;r.forEach(s=>{const h=(s==null?void 0:s.totalDamageDist)||[],H=Array.isArray(h)?h[0]:null;H==null||H.forEach(G=>{var X;if(!(G!=null&&G.id))return;const j=Number(G.id),a=((X=C==null?void 0:C[j])==null?void 0:X.name)||G.name||G.skillName||String(j),D=z.get(j)||{totalDamage:0,connectedHits:0,minTotal:0,minCount:0};D.totalDamage+=Number(G.totalDamage||0),D.connectedHits+=Number(G.connectedHits||0);const N=Number.isFinite(Number(G.min))?Number(G.min):0;D.minTotal+=N,D.minCount+=1,z.set(j,D);const P=E.get(a)||{totalDamage:0,connectedHits:0,minTotal:0,minCount:0};P.totalDamage+=Number(G.totalDamage||0),P.connectedHits+=Number(G.connectedHits||0);const ee=Number.isFinite(Number(G.min))?Number(G.min):0;P.minTotal+=ee,P.minCount+=1,E.set(a,P)})});const Y=s=>{const h=z.get(s);if(!h||h.connectedHits<=0)return{avg:1,min:1};const H=h.connectedHits>0?h.totalDamage/h.connectedHits:0,G=h.minCount>0?h.minTotal/h.minCount:H;return{avg:H||1,min:G||1}},pe=s=>{const h=E.get(s);if(!h||h.connectedHits<=0)return{avg:1,min:1};const H=h.connectedHits>0?h.totalDamage/h.connectedHits:0,G=h.minCount>0?h.minTotal/h.minCount:H;return{avg:H||1,min:G||1}},oe=n.combatReplayMetaData||{},F=(oe==null?void 0:oe.inchToPixel)>0?oe.inchToPixel:1,$=(oe==null?void 0:oe.pollingRate)>0?oe.pollingRate:1,x=5e3,K=s=>Array.isArray(s)?s.map(h=>Array.isArray(h)?[Number(h[0]),Number(h[1])]:null).filter(h=>!!h&&Number.isFinite(h[0])):[];let de=[],me=n.durationMS||0,l=!1;const p=m.find(s=>(s==null?void 0:s.hasCommanderTag)&&!(s!=null&&s.notInSquad));(se=p==null?void 0:p.combatReplayData)!=null&&se.positions&&(de=p.combatReplayData.positions,K(p.combatReplayData.dead).forEach(([h])=>{h>0&&(l=!0,me=Math.min(me,h))}));const g=s=>{var P;const h=(P=s.statsAll)==null?void 0:P[0];if((h==null?void 0:h.distToCom)!==void 0&&(h==null?void 0:h.distToCom)!=="Infinity")return Math.round(Number(h.distToCom));if((h==null?void 0:h.stackDist)!==void 0)return Math.round(Number(h.stackDist))||0;if(s.hasCommanderTag)return 0;const H=s.combatReplayData;if(!(H!=null&&H.positions)||!de.length)return 0;const G=H.positions,j=K(H.dead),a=K(H.down),D=Math.floor((H.start||0)/$);let N=0;if(j.length&&a.length)for(const[ee]of j){if(ee<0)continue;const X=Math.max(0,Math.floor(ee/$))-D;for(const[w,I]of a){if(ee!==I)continue;const V=l&&w>me?Math.max(1,Math.floor(me/$)):X,Z=Math.max(0,Math.min(V,G.length,de.length));if(Z<=0)continue;let J=0;for(let fe=0;fe<Z;fe++){const[O,ae]=G[fe],[re,te]=de[fe];J+=Math.hypot(O-re,ae-te)}N=Math.round(J/Z/F)}}return N},k=m.filter(s=>!s.notInSquad);ce+=k.length,le+=r.filter(s=>!s.isFake).length,Kn(m,{durationMS:n.durationMS,buffMap:n.buffMap});const{squadDeaths:B,enemyDeaths:i}=Ue(n);ue+=B,De+=i,ge+=B,_e+=i,Be(n)?ke++:U++;const f=n.skillMap?Number((Oe=Object.keys(n.skillMap).find(s=>{var h,H;return((H=(h=n.skillMap)==null?void 0:h[s])==null?void 0:H.name)==="Battle Standard"}))==null?void 0:Oe.replace(/^s/,"")):null;m.forEach((s,h)=>{var et,tt,ct,lt,Ht,ht,bt,Dn,Nn,An,Tn,Mn;if(s.notInSquad)return;const H=s.account||"Unknown",G=H!=="Unknown"?H:s.name||"Unknown",j=s.name||"Unknown";Ae.has(G)||Ae.set(G,{name:j,account:G,downContrib:0,cleanses:0,strips:0,stab:0,healing:0,barrier:0,cc:0,logsJoined:0,totalDist:0,distCount:0,dodges:0,downs:0,deaths:0,totalFightMs:0,offenseTotals:{},offenseRateWeights:{},defenseActiveMs:0,defenseTotals:{},supportActiveMs:0,supportTotals:{},healingActiveMs:0,healingTotals:{},profession:s.profession||"Unknown",professions:new Set,professionTimeMs:{},isCommander:!1,damage:0,dps:0,revives:0,outgoingConditions:{},incomingConditions:{}});const a=Ae.get(G);if(s.hasCommanderTag&&(a.isCommander=!0),s.profession&&s.profession!=="Unknown"){a.profession=s.profession,a.professions.add(s.profession);const d=Array.isArray(s.activeTimes)&&typeof s.activeTimes[0]=="number"?s.activeTimes[0]:n.durationMS||0;a.professionTimeMs[s.profession]=(a.professionTimeMs[s.profession]||0)+d}a.logsJoined++,a.downContrib+=Wn(s),a.cleanses+=qn(s),a.strips+=jn(s,Ce),a.healing+=yn(s),a.barrier+=Vn(s),a.cc+=zn(s,Ce),a.stab+=s.stabGeneration||0;const D=g(s);D<=x&&(a.totalDist+=D,a.distCount++),(et=s.defenses)!=null&&et[0]&&(a.dodges+=s.defenses[0].dodgeCount||0,a.downs+=s.defenses[0].downCount||0,a.deaths+=s.defenses[0].deadCount||0),n.durationMS&&(a.totalFightMs+=n.durationMS);const N=Array.isArray(s.activeTimes)&&typeof s.activeTimes[0]=="number"?s.activeTimes[0]:n.durationMS||0;a.defenseActiveMs+=N,a.supportActiveMs+=N,a.healingActiveMs+=N,Array.isArray(s.buffUptimes)&&s.buffUptimes.length>0&&s.buffUptimes.forEach(d=>{var wn,vn,En,Fn;if(typeof(d==null?void 0:d.id)!="number")return;const S=`b${d.id}`,M=((wn=n.buffMap)==null?void 0:wn[S])||((vn=n.buffMap)==null?void 0:vn[String(d.id)]);if(!M||gi(M))return;const ne=Number(((Fn=(En=d.buffData)==null?void 0:En[0])==null?void 0:Fn.uptime)??0);if(!Number.isFinite(ne)||ne<=0)return;const Pe=(M==null?void 0:M.stacking)??!1,ze=(Pe?ne:ne/100)*N;if(!Number.isFinite(ze)||ze<=0)return;const Le=Xn(M==null?void 0:M.name);if(Le&&ii.has(Le)&&(!(M!=null&&M.classification)||M.classification==="Condition")){const Ut=ze/1e3,Ke=M==null?void 0:M.icon,kt=Ie[Le]||{name:Le,icon:Ke,applications:0,damage:0};kt.applicationsFromUptime=(kt.applicationsFromUptime||0)+Ut,!kt.icon&&Ke&&(kt.icon=Ke),Ie[Le]=kt;const St=a.outgoingConditions[Le]||{applications:0,damage:0,skills:{},icon:Ke};St.applicationsFromUptime=(St.applicationsFromUptime||0)+Ut,!St.icon&&Ke&&(St.icon=Ke),a.outgoingConditions[Le]=St;const Ct=$e[Le]||{name:Le,icon:Ke,applications:0,damage:0};Ct.applicationsFromUptime=(Ct.applicationsFromUptime||0)+Ut,!Ct.icon&&Ke&&(Ct.icon=Ke),$e[Le]=Ct;const Dt=a.incomingConditions[Le]||{applications:0,damage:0,skills:{},icon:Ke};Dt.applicationsFromUptime=(Dt.applicationsFromUptime||0)+Ut,!Dt.icon&&Ke&&(Dt.icon=Ke),a.incomingConditions[Le]=Dt}Ze.has(S)||Ze.set(S,{name:M==null?void 0:M.name,stacking:Pe,icon:M==null?void 0:M.icon}),Qe.has(S)||Qe.set(S,new Map);const ot=Qe.get(S),mt=a.account||s.account||s.name||"Unknown";let it=ot.get(mt);it||(it={account:mt,profession:a.profession||s.profession||"Unknown",professions:new Set,professionTimeMs:{},totalMs:0,durationMs:0},ot.set(mt,it));const dt=s.profession||a.profession;dt&&dt!=="Unknown"&&(it.professions.add(dt),it.professionTimeMs[dt]=(it.professionTimeMs[dt]||0)+N,it.profession=dt),it.totalMs+=ze,it.durationMs+=N}),(tt=s.defenses)!=null&&tt[0]&&si.forEach(d=>{const S=Number(s.defenses[0][d.field]??0);Number.isFinite(S)&&(a.defenseTotals[d.id]=(a.defenseTotals[d.id]||0)+S)}),(ct=s.support)!=null&&ct[0]&&ai.forEach(d=>{let S=Number(s.support[0][d.field]??0);Number.isFinite(S)&&(qe.has(d.field)&&S>999999&&(S=0),a.supportTotals[d.id]=(a.supportTotals[d.id]||0)+S)});const P=(d,S)=>{Number.isFinite(S)&&(a.healingTotals[d]=(a.healingTotals[d]||0)+S)},ee=(d,S)=>Array.isArray(d)?d.reduce((M,ne)=>M+Number((ne==null?void 0:ne[S])??0),0):0,X=(d,S,M)=>{if(!Number.isFinite(M)||M<=0)return;const ne=m[S],Pe=S===h,nt=ne==null?void 0:ne.notInSquad,ze=!nt,Le=ze&&(ne==null?void 0:ne.group)!=null&&ne.group===s.group;P(d,M),ze&&P(`squad${d[0].toUpperCase()}${d.slice(1)}`,M),Le&&P(`group${d[0].toUpperCase()}${d.slice(1)}`,M),Pe&&P(`self${d[0].toUpperCase()}${d.slice(1)}`,M),nt&&P(`offSquad${d[0].toUpperCase()}${d.slice(1)}`,M)};if(Array.isArray(s.rotation)){let d=0;s.rotation.forEach(S=>{var ne;if(!(S!=null&&S.id)||!li(S.id,n.skillMap))return;const M=((ne=S.skills)==null?void 0:ne.length)||0;M>0&&(d+=M,P(`resUtility_s${S.id}`,M))}),d>0&&P("resUtility",d)}const w=(lt=s.extHealingStats)==null?void 0:lt.outgoingHealingAllies;Array.isArray(w)&&w.forEach((d,S)=>{const M=ee(d,"healing"),ne=ee(d,"downedHealing");X("healing",S,M),X("downedHealing",S,ne)});const I=(Ht=s.extBarrierStats)==null?void 0:Ht.outgoingBarrierAllies;Array.isArray(I)&&I.forEach((d,S)=>{const M=ee(d,"barrier");X("barrier",S,M)});const V=(ht=s.statsAll)==null?void 0:ht[0],Z=(bt=s.dpsAll)==null?void 0:bt[0],J=(Dn=s.support)==null?void 0:Dn[0];if(oi.forEach(d=>{if(d.id==="downContributionPercent"||!d.field)return;let S=0,M=0;d.source==="dpsAll"&&Z?S=Number(Z[d.field]??0):d.source==="statsAll"&&V?(S=Number(V[d.field]??0),M=Number(V[d.denomField||d.weightField||"connectedDamageCount"]??0)):d.source==="support"&&J?S=Number(J[d.field]??0):s.statsTargets&&s.statsTargets.forEach(ne=>{ne!=null&&ne[0]&&(S+=Number(ne[0][d.field]??0),M+=Number(ne[0][d.denomField||d.weightField||"connectedDamageCount"]??0))}),Number.isFinite(S)&&(a.offenseTotals[d.id]=(a.offenseTotals[d.id]||0)+S,d.isRate&&M>0&&(a.offenseRateWeights[d.id]=(a.offenseRateWeights[d.id]||0)+M))}),s.targetDamageDist&&Number.isFinite(f)){const d=s.targetDamageDist.flatMap(S=>S||[]).flatMap(S=>S||[]).reduce((S,M)=>M!=null&&M.id&&M.id===f?S+((M==null?void 0:M.connectedHits)||0):S,0);a.offenseTotals.battleStandardHits=(a.offenseTotals.battleStandardHits||0)+d}a.revives+=((An=(Nn=s.support)==null?void 0:Nn[0])==null?void 0:An.resurrects)||0,Z&&(a.damage+=Z.damage||0,a.dps+=Z.dps||0);const fe=d=>{var Pe,nt,ze,Le;let S=`Skill ${d.id}`;const M=((Pe=n.skillMap)==null?void 0:Pe[`s${d.id}`])||((nt=n.skillMap)==null?void 0:nt[`${d.id}`]);let ne=M==null?void 0:M.icon;if(M!=null&&M.name&&(S=M.name),S.startsWith("Skill ")){const ot=Nt(S,d.id,n.buffMap);ot&&(S=ot,ne=((Le=(ze=n.buffMap)==null?void 0:ze[`b${d.id}`])==null?void 0:Le.icon)||ne)}return{name:S,icon:ne}},O=d=>{if(!(d!=null&&d.id))return;const{name:S,icon:M}=fe(d);Ne[d.id]||(Ne[d.id]={name:S,icon:M,damage:0,hits:0,downContribution:0}),Ne[d.id].name.startsWith("Skill ")&&!S.startsWith("Skill ")&&(Ne[d.id].name=S),!Ne[d.id].icon&&M&&(Ne[d.id].icon=M),Ne[d.id].damage+=d.totalDamage,Ne[d.id].hits+=d.connectedHits,Ne[d.id].downContribution+=Number(d.downContribution||0)},ae=s.account||s.name||"Unknown",re=s.profession||"Unknown",te=`${ae}|${re}`;let we=je.get(te);we||(we={key:te,account:ae,displayName:ae,profession:re,professionList:[re],totalFightMs:0,skills:new Map},je.set(te,we)),we.professionList.includes(re)||we.professionList.push(re),we.totalFightMs+=n.durationMS||0;const We=d=>{if(!(d!=null&&d.id))return;const{name:S,icon:M}=fe(d),ne=`s${d.id}`;let Pe=we.skills.get(ne);Pe||(Pe={id:ne,name:S,icon:M,damage:0,downContribution:0},we.skills.set(ne,Pe)),Pe.name.startsWith("Skill ")&&!S.startsWith("Skill ")&&(Pe.name=S),!Pe.icon&&M&&(Pe.icon=M),Pe.damage+=Number(d.totalDamage||0),Pe.downContribution+=Number(d.downContribution||0)};Se==="total"?(Tn=s.totalDamageDist)==null||Tn.forEach(d=>{d==null||d.forEach(S=>{O(S),We(S)})}):(Mn=s.targetDamageDist)==null||Mn.forEach(d=>{d==null||d.forEach(S=>{S==null||S.forEach(M=>{O(M),We(M)})})}),s.totalDamageTaken&&s.totalDamageTaken.forEach(d=>{d==null||d.forEach(S=>{var nt,ze,Le,ot;if(!(S!=null&&S.id))return;let M=`Skill ${S.id}`;const ne=((nt=n.skillMap)==null?void 0:nt[`s${S.id}`])||((ze=n.skillMap)==null?void 0:ze[`${S.id}`]);let Pe=ne==null?void 0:ne.icon;if(ne!=null&&ne.name&&(M=ne.name),M.startsWith("Skill ")){const mt=Nt(M,S.id,n.buffMap);mt&&(M=mt,Pe=((ot=(Le=n.buffMap)==null?void 0:Le[`b${S.id}`])==null?void 0:ot.icon)||Pe)}Te[S.id]||(Te[S.id]={name:M,icon:Pe,damage:0,hits:0}),(!Te[S.id].name.startsWith("Skill ")||M.startsWith("Skill "))&&(Te[S.id].name=M),!Te[S.id].icon&&Pe&&(Te[S.id].icon=Pe),Te[S.id].damage+=S.totalDamage,Te[S.id].hits+=S.hits})})}),r.forEach(s=>{if(s!=null&&s.isFake)return;const h=st((s==null?void 0:s.profession)||(s==null?void 0:s.name)||(s==null?void 0:s.id));h&&(Fe[h]=(Fe[h]||0)+1)});const b=ni({players:m,targets:r,skillMap:n.skillMap,buffMap:n.buffMap,getPlayerKey:s=>s.account&&s.account!=="Unknown"?s.account:s.name||null}),R=Zt(n.buffMap);Object.entries(b.playerConditions).forEach(([s,h])=>{const H=Ae.get(s);H&&Object.entries(h).forEach(([G,j])=>{const a=H.outgoingConditions[G]||{applications:0,damage:0,skills:{},icon:j.icon};a.applications+=Number(j.applications||0),a.damage+=Number(j.damage||0),j.applicationsFromBuffs&&(a.applicationsFromBuffs=(a.applicationsFromBuffs||0)+j.applicationsFromBuffs),j.applicationsFromBuffsActive&&(a.applicationsFromBuffsActive=(a.applicationsFromBuffsActive||0)+j.applicationsFromBuffsActive),Object.entries(j.skills||{}).forEach(([D,N])=>{const P=a.skills[D]||{name:N.name,hits:0,damage:0,icon:N.icon};P.hits+=Number(N.hits||0),P.damage+=Number(N.damage||0),!P.icon&&N.icon&&(P.icon=N.icon),a.skills[D]=P}),!a.icon&&j.icon&&(a.icon=j.icon),H.outgoingConditions[G]=a})}),Object.entries(b.summary).forEach(([s,h])=>{const H=Ie[s]||{name:h.name||s,icon:h.icon,applications:0,damage:0};H.applications+=Number(h.applications||0),H.damage+=Number(h.damage||0),h.applicationsFromBuffs&&(H.applicationsFromBuffs=(H.applicationsFromBuffs||0)+h.applicationsFromBuffs),h.applicationsFromBuffsActive&&(H.applicationsFromBuffsActive=(H.applicationsFromBuffsActive||0)+h.applicationsFromBuffsActive),!H.icon&&h.icon&&(H.icon=h.icon),Ie[s]=H}),k.forEach(s=>{const h=s.account&&s.account!=="Unknown"?s.account:s.name||"Unknown",H=Ae.get(h);!H||!s.totalDamageTaken||s.totalDamageTaken.forEach(G=>G==null?void 0:G.forEach(j=>{var fe,O,ae,re,te,we;if(!(j!=null&&j.id))return;let a=`Skill ${j.id}`;const D=((fe=n.skillMap)==null?void 0:fe[`s${j.id}`])||((O=n.skillMap)==null?void 0:O[`${j.id}`]);D!=null&&D.name&&(a=D.name);const N=Nt(a,j.id,n.buffMap);if(!N)return;const P=(re=(ae=n.buffMap)==null?void 0:ae[`b${j.id}`])==null?void 0:re.name,ee=R.get(N)||((we=(te=n.buffMap)==null?void 0:te[`b${j.id}`])==null?void 0:we.icon),X=(D==null?void 0:D.icon)||ee;a.startsWith("Skill ")&&(P||N)&&(a=P||N);const w=Number(j.hits??0),I=Number(j.totalDamage??0),V=$e[N]||{name:N,icon:ee,applications:0,damage:0};V.applications+=Number.isFinite(w)?w:0,V.damage+=Number.isFinite(I)?I:0,!V.icon&&ee&&(V.icon=ee),$e[N]=V;const Z=H.incomingConditions[N]||{applications:0,damage:0,skills:{},icon:ee};Z.applications+=Number.isFinite(w)?w:0,Z.damage+=Number.isFinite(I)?I:0;const J=Z.skills[a]||{name:a,hits:0,damage:0,icon:X};J.hits+=Number.isFinite(w)?w:0,J.damage+=Number.isFinite(I)?I:0,!J.icon&&X&&(J.icon=X),Z.skills[a]=J,!Z.icon&&ee&&(Z.icon=ee),H.incomingConditions[N]=Z}))});const y=n.player_damage_mitigation||n.playerDamageMitigation,Me=y&&typeof y=="object"&&Object.keys(y).length>0;Me&&Object.entries(y).forEach(([s,h])=>{if(!h||typeof h!="object")return;const H=rn(s),G=cn(vt,H.account,H);Object.values(h).forEach(j=>{ie((j==null?void 0:j.avoided_damage)??(j==null?void 0:j.avoidedDamage))<=0||un(G.mitigationTotals,j)})});const ve=n.player_minion_damage_mitigation||n.playerMinionDamageMitigation,Re=ve&&typeof ve=="object"&&Object.keys(ve).length>0;Re&&Object.entries(ve).forEach(([s,h])=>{if(!h||typeof h!="object")return;const H=rn(s);Object.entries(h).forEach(([G,j])=>{if(!j||typeof j!="object")return;const a=`${H.account}::${G}`,D=ln(Et,a,{...H,minion:String(G||"Unknown")});Object.values(j).forEach(N=>{un(D.mitigationTotals,N)})})}),(!Me||!Re)&&(Me||k.forEach(s=>{const h=(s==null?void 0:s.totalDamageTaken)||[];if(!Array.isArray(h)||h.length===0)return;const H=s.account||s.name||"Unknown",G={account:H,name:s.name||H,profession:st(s.profession||"Unknown")};cn(vt,H,G);const j=n.skillMap||{},a=n.buffMap||{},D=Array.isArray(h)?h[0]:null;if(D==null||D.forEach(N=>{if(!(N!=null&&N.id))return;const P=ie(N.blocked),ee=ie(N.evaded),X=ie(N.glance??N.glanced),w=ie(N.missed),I=ie(N.invulned),V=ie(N.interrupted),Z=ie(N.hits??N.connectedHits),J=Number(N.id),fe=Ft(J,j,a);if(gn(dn,`${H}::${J}`,{totalHits:Z,blocked:P,evaded:ee,glanced:X,missed:w,invulned:I,interrupted:V}),H===Bt){const O=pt.get(J),ae=at(J),re=ae.hasSkill?ae.hits>0?ae.avg:0:1,te=ae.hasSkill?ae.min||0:1,we=ae.hits>0?X*re/2+(P+ee+w+I+V)*re:0,We=ae.hits>0?X*te/2+(P+ee+w+I+V)*te:0;Rt.push({logId:e.filePath||e.id||t,skillId:N.id,skillName:fe,blocked:P,evaded:ee,glanced:X,missed:w,invulned:I,interrupted:V,totalAvoids:P+ee+X+w+I+V,avg:re,min:te,enemyHits:(O==null?void 0:O.connectedHits)??0,enemyTotalDmg:(O==null?void 0:O.totalDamage)??0,avoidDmg:we,avoidMinDmg:We})}}),H===Bt){const N=(P,ee)=>{let X=0,w=0,I=0;if(!Array.isArray(P))return{total:X,minTotal:w,hits:I};for(const V of P){if(!(V!=null&&V.id))continue;const Z=ie(V.blocked),J=ie(V.evaded),fe=ie(V.glance??V.glanced),O=ie(V.missed),ae=ie(V.invulned),re=ie(V.interrupted),te=Ft(Number(V.id),C,T),we=ee(Number(V.id),te);(we.hits??0)>0&&(X+=fe*we.avg/2+(Z+J+O+ae+re)*we.avg,w+=fe*we.min/2+(Z+J+O+ae+re)*we.min),I+=ie(V.hits??V.connectedHits)}return{total:X,minTotal:w,hits:I}};_t.push({logId:e.filePath||e.id||t,variant:"current_global_name_taken0",...N(D,(P,ee)=>{const X=at(P),w=X.hasSkill?X.hits>0?X.avg:0:1,I=X.hasSkill?X.min||0:1;return{avg:w,min:I,hits:X.hits}})})}}),Re||k.forEach(s=>{const h=(s==null?void 0:s.minions)||[];if(!Array.isArray(h)||h.length===0)return;const H=s.account||s.name||"Unknown",G={account:H,name:s.name||H,profession:st(s.profession||"Unknown")},j=n.skillMap||{},a=n.buffMap||{};h.forEach(D=>{const N=(D==null?void 0:D.totalDamageTakenDist)||[];if(!Array.isArray(N)||N.length===0)return;let P=String((D==null?void 0:D.name)||"Unknown").replace(/^Juvenile\s+/i,"")||"Unknown";P.toUpperCase().includes("UNKNOWN")&&(P="Unknown");const ee=`${H}::${P}`;ln(Et,ee,{...G,minion:P});const X=Array.isArray(N)?N[0]:null;if(X==null||X.forEach(w=>{if(!(w!=null&&w.id))return;const I=ie(w.blocked),V=ie(w.evaded),Z=ie(w.glance??w.glanced),J=ie(w.missed),fe=ie(w.invulned),O=ie(w.interrupted),ae=ie(w.hits??w.connectedHits),re=Number(w.id),te=Ft(re,j,a);if(gn(fn,`${ee}::${re}`,{totalHits:ae,blocked:I,evaded:V,glanced:Z,missed:J,invulned:fe,interrupted:O}),H===Bt&&P===mn){const we=pt.get(re),We=at(re),et=We.hasSkill?We.hits>0?We.avg:0:1,tt=We.hasSkill?We.min||0:1,ct=We.hits>0?Z*et/2+(I+V+J+fe+O)*et:0,lt=We.hits>0?Z*tt/2+(I+V+J+fe+O)*tt:0;Ot.push({logId:e.filePath||e.id||t,skillId:w.id,skillName:te,blocked:I,evaded:V,glanced:Z,missed:J,invulned:fe,interrupted:O,totalAvoids:I+V+Z+J+fe+O,avg:et,min:tt,enemyHits:(we==null?void 0:we.connectedHits)??0,enemyTotalDmg:(we==null?void 0:we.totalDamage)??0,avoidDmg:ct,avoidMinDmg:lt})}}),H===Bt&&P===mn){const w=(J,fe)=>{let O=0,ae=0,re=0;if(!Array.isArray(J))return{total:O,minTotal:ae,hits:re};for(const te of J){if(!(te!=null&&te.id))continue;const we=ie(te.blocked),We=ie(te.evaded),et=ie(te.glance??te.glanced),tt=ie(te.missed),ct=ie(te.invulned),lt=ie(te.interrupted),Ht=Ft(Number(te.id),C,T),{avg:ht,min:bt}=fe(Number(te.id),Ht);ie(te.hits??te.connectedHits)>0&&(O+=et*ht/2+(we+We+tt+ct+lt)*ht,ae+=et*bt/2+(we+We+tt+ct+lt)*bt),re+=ie(te.hits??te.connectedHits)}return{total:O,minTotal:ae,hits:re}},I=Array.isArray(N)?N[0]||[]:[],V=Array.isArray(N)?N.flat():[],Z=Array.isArray(D==null?void 0:D.totalDamageTaken)?D.totalDamageTaken[0]||[]:[];rt.push({logId:e.filePath||e.id||t,variant:"current_global_name_dist0",...w(I,(J,fe)=>{const O=at(J),ae=O.hasSkill?O.hits>0?O.avg:0:1,re=O.hasSkill&&O.min||0;return{avg:ae,min:re}})}),rt.push({logId:e.filePath||e.id||t,variant:"local_name_dist0",...w(I,(J,fe)=>pe(fe))}),rt.push({logId:e.filePath||e.id||t,variant:"local_id_dist0",...w(I,J=>Y(J))}),rt.push({logId:e.filePath||e.id||t,variant:"global_name_alllists",...w(V,(J,fe)=>{const O=at(J),ae=O.hasSkill?O.hits>0?O.avg:0:1,re=O.hasSkill&&O.min||0;return{avg:ae,min:re}})}),rt.push({logId:e.filePath||e.id||t,variant:"global_name_taken0",...w(Z,(J,fe)=>{const O=at(J),ae=O.hasSkill?O.hits>0?O.avg:0:1,re=O.hasSkill&&O.min||0;return{avg:ae,min:re}})})}})}))}),Ot.length>0&&(console.groupCollapsed("[Mitigation Debug] Ashtonlightstone.9145 / Illusionary Warden"),console.table(Ot),rt.length>0&&console.table(rt),console.groupEnd()),Rt.length>0&&(console.groupCollapsed("[Mitigation Debug] Ashtonlightstone.9145 / Player"),console.table(Rt),_t.length>0&&console.table(_t),console.groupEnd());const pn=(e,t)=>{const n=new Map,m=r=>{let C=n.get(r);return C||(C=gt(),n.set(r,C)),C};t.forEach((r,C)=>{const T=C.lastIndexOf("::"),z=T>-1?C.slice(0,T):C,E=T>-1?Number(C.slice(T+2)):Number.NaN,Y=Number.isFinite(E)?at(E):{hasSkill:!1,avg:0,min:0,hits:0};if(!Y.hasSkill||Y.hits<=0)return;const pe=Y.avg,oe=Y.min,F=r.glanced*pe/2+(r.blocked+r.evaded+r.missed+r.invulned+r.interrupted)*pe,$=r.glanced*oe/2+(r.blocked+r.evaded+r.missed+r.invulned+r.interrupted)*oe;if(F<=0)return;const x=m(z);x.totalHits+=r.totalHits,x.blocked+=r.blocked,x.evaded+=r.evaded,x.glanced+=r.glanced,x.missed+=r.missed,x.invulned+=r.invulned,x.interrupted+=r.interrupted,x.totalMitigation+=F,x.minMitigation+=$}),e.forEach((r,C)=>{const T=n.get(C)||gt();r.mitigationTotals.totalHits=T.totalHits,r.mitigationTotals.blocked=T.blocked,r.mitigationTotals.evaded=T.evaded,r.mitigationTotals.glanced=T.glanced,r.mitigationTotals.missed=T.missed,r.mitigationTotals.invulned=T.invulned,r.mitigationTotals.interrupted=T.interrupted,r.mitigationTotals.totalMitigation=T.totalMitigation,r.mitigationTotals.minMitigation=T.minMitigation})};pn(vt,dn),pn(Et,fn);const hi=W>0?Math.round(ce/W):0,bi=W>0?Math.round(le/W):0,ki=ue>0?(De/ue).toFixed(2):De>0?"∞":"0.00",Si=_e>0?(ge/_e).toFixed(2):ge>0?"∞":"0.00",hn=(e,t)=>{const m=e.filter(T=>Number.isFinite(T.value)&&(t?T.value>0:T.value>=0)).sort((T,z)=>{const E=t?z.value-T.value:T.value-z.value;return E!==0?E:T.account.localeCompare(z.account)});let r=null,C=0;return m.map((T,z)=>((r===null||T.value!==r)&&(C=z+1,r=T.value),{rank:C,...T}))},qt=Array.from(Ae.values()).map(e=>{const t=Array.from(e.professions).filter(n=>n!=="Unknown");if(e.professionList=t,t.length>0){let n=t[0],m=e.professionTimeMs[n]||0;t.forEach(r=>{const C=e.professionTimeMs[r]||0;C>m&&(m=C,n=r)}),e.profession=n}return{key:e.account,stat:e}}),bn=e=>{const t=Ae.get(e.account);if(!t){const r=e.professionList.length>0?e.professionList:e.profession?[e.profession]:[];return{...e,professionList:r}}const n=t.professionList&&t.professionList.length>0?t.professionList:Array.from(t.professions||[]).filter(r=>r&&r!=="Unknown"),m=t.profession||e.profession;return{...e,profession:m,professionList:n.length>0?n:m?[m]:[],activeMs:t.defenseActiveMs||t.totalFightMs||e.activeMs}},Ci=Array.from(vt.values()).map(bn).filter(e=>pi(e.mitigationTotals)).sort((e,t)=>e.account.localeCompare(t.account)),Di=Array.from(Et.values()).map(bn).filter(e=>e.mitigationTotals.totalMitigation>0).sort((e,t)=>{const n=e.account.localeCompare(t.account);return n!==0?n:String(e.minion||"").localeCompare(String(t.minion||""))}),It=(e,t)=>{switch(t){case"downContrib":return e.downContrib;case"barrier":return e.barrier;case"healing":return e.healing;case"dodges":return e.dodges;case"strips":return e.strips;case"cleanses":return e.cleanses;case"cc":return e.cc;case"stability":return e.stab;case"revives":return e.revives;case"dps":return e.dps;case"damage":return e.damage;case"participation":return e.logsJoined;case"closestToTag":return!e.isCommander&&e.distCount>0?e.totalDist/e.distCount:Number.POSITIVE_INFINITY;default:return 0}},Ve=(e,t)=>hn(qt.map(({stat:n})=>({account:n.account,profession:n.profession,professionList:n.professionList,value:It(n,e),count:n.logsJoined})),t),He={downContrib:Ve("downContrib",!0),barrier:Ve("barrier",!0),healing:Ve("healing",!0),dodges:Ve("dodges",!0),strips:Ve("strips",!0),cleanses:Ve("cleanses",!0),cc:Ve("cc",!0),stability:Ve("stability",!0),revives:Ve("revives",!0),participation:Ve("participation",!0),dps:Ve("dps",!0),damage:Ve("damage",!0),closestToTag:Ve("closestToTag",!1).filter(e=>Number.isFinite(e.value))},Ni={downContrib:"downContrib",barrier:"barrier",healing:"healing",dodges:"dodges",strips:"strips",cleanses:"cleanses",cc:"cc",stability:"stability",closestToTag:"closestToTag"},Ee=e=>{const t=e==null?void 0:e[0];return{value:(t==null?void 0:t.value)??0,player:(t==null?void 0:t.account)??"-",count:(t==null?void 0:t.count)??0,profession:(t==null?void 0:t.profession)??"Unknown",professionList:(t==null?void 0:t.professionList)??[]}},Xe={maxDownContrib:Ee([]),maxBarrier:Ee([]),maxHealing:Ee([]),maxDodges:Ee([]),maxStrips:Ee([]),maxCleanses:Ee([]),maxCC:Ee([]),maxStab:Ee([]),closestToTag:Ee([])},Ye={},Ai=(e,t)=>{if(t==="closestToTag")return It(e,t);const n=Math.max(1,(e.totalFightMs||0)/1e3);return It(e,t)/n};Object.values(Ni).forEach(e=>{const t=e!=="closestToTag";Ye[e]=hn(qt.map(({stat:n})=>({account:n.account,profession:n.profession,professionList:n.professionList,value:Ai(n,e),count:n.logsJoined})),t)}),Xe.maxDownContrib=Ee(Ye.downContrib),Xe.maxBarrier=Ee(Ye.barrier),Xe.maxHealing=Ee(Ye.healing),Xe.maxDodges=Ee(Ye.dodges),Xe.maxStrips=Ee(Ye.strips),Xe.maxCleanses=Ee(Ye.cleanses),Xe.maxCC=Ee(Ye.cc),Xe.maxStab=Ee(Ye.stability),Xe.closestToTag=Ee(Ye.closestToTag);const Ti={maxDownContrib:Ee(He.downContrib),maxBarrier:Ee(He.barrier),maxHealing:Ee(He.healing),maxDodges:Ee(He.dodges),maxStrips:Ee(He.strips),maxCleanses:Ee(He.cleanses),maxCC:Ee(He.cc),maxStab:Ee(He.stability),closestToTag:Ee(He.closestToTag)};let jt={player:"None",account:"None",score:-1,profession:"Unknown",professionList:[],color:"#64748b",topStats:[]},kn,Sn,Cn=0;if(he!=null&&he.showMvp){const e={"Down Contribution":"downContribution",Healing:"healing",Cleanses:"cleanses",Strips:"strips",Stability:"stability",CC:"cc",Revives:"revives","Distance to Tag":"distanceToTag",Participation:"participation",Dodging:"dodging",DPS:"dps",Damage:"damage"},t=C=>{const T=e[C];return T?Number(Q[T]||0)>0:!1},n=[],m=C=>[...C||[]].filter(T=>t(T==null?void 0:T.name)).sort((T,z)=>z.ratio-T.ratio||T.rank-z.rank||T.name.localeCompare(z.name)).slice(0,3),r=C=>{var z;if(!C)return;const T=m(C.contribs);return{...C,player:C.name,reason:((z=T[0])==null?void 0:z.name)||"Top Performance",topStats:T}};qt.forEach(({stat:C})=>{let T=0;const z=[],E=(Y,pe,oe,F,$=!0)=>{var K,de;if(oe<=0)return;const x=((K=pe[0])==null?void 0:K.value)||0;if(x&&Number.isFinite(Y)&&($?Y>0:Y<Number.POSITIVE_INFINITY)){const me=$?Y/x:x/Y;T+=me*oe;const l=((de=pe.find(p=>p.account===C.account))==null?void 0:de.rank)||0;z.push({name:F,ratio:me,val:Y.toLocaleString(),rank:l})}};E(C.downContrib,He.downContrib,Q.downContribution,"Down Contribution"),E(C.healing,He.healing,Q.healing,"Healing"),E(C.cleanses,He.cleanses,Q.cleanses,"Cleanses"),E(C.strips,He.strips,Q.strips,"Strips"),E(C.stab,He.stability,Q.stability,"Stability"),E(C.cc,He.cc,Q.cc,"CC"),E(C.revives,He.revives,Q.revives,"Revives"),E(It(C,"closestToTag"),He.closestToTag,Q.distanceToTag,"Distance to Tag",!1),E(C.logsJoined,He.participation,Q.participation,"Participation"),E(C.dodges,He.dodges,Q.dodging,"Dodging"),E(C.dps,He.dps,Q.dps,"DPS"),E(C.damage,He.damage,Q.damage,"Damage"),n.push({...C,score:T,contribs:z.filter(Y=>t(Y.name))})}),n.sort((C,T)=>T.score-C.score),n[0]&&n[0].score>0&&(jt=r(n[0])||jt),kn=r(n[1]),Sn=r(n[2]),Cn=n.length>0?n.reduce((C,T)=>C+T.score,0)/n.length:0}const Mi=Object.values(Ne).sort((e,t)=>{const n=L==="downContribution"?e.downContribution:e.damage;return(L==="downContribution"?t.downContribution:t.damage)-n}).slice(0,25),wi=Object.values(Te).sort((e,t)=>t.damage-e.damage).slice(0,25),vi=e=>{const t=String(e).replace(/^Detailed\s*WvW\s*-\s*/i,"").replace(/^World\s*vs\s*World\s*-\s*/i,"").replace(/^WvW\s*-\s*/i,"").trim(),n=t.match(/^(Red|Blue|Green)\s+(?:Alpine|Desert)?\s*Borderlands$/i);return n?`${n[1]} Borderlands`:t||"Unknown"},Pt=(e,t)=>vi((e==null?void 0:e.zone)||(e==null?void 0:e.mapName)||(e==null?void 0:e.map)||(e==null?void 0:e.location)||(e==null?void 0:e.fightName)||(t==null?void 0:t.fightName)||(t==null?void 0:t.encounterName)||"Unknown"),Ei=(e,t)=>{const n=(t==null?void 0:t.permalink)||(e==null?void 0:e.permalink);if(typeof n=="string"&&n.trim().length>0)return n.trim();const m=e==null?void 0:e.uploadLinks;if(!Array.isArray(m))return"";for(const r of m){if(typeof r=="string"&&r.trim().length>0)return r.trim();if(r&&typeof r=="object"){const C=r.permalink||r.link||r.url||r.reportLink;if(typeof C=="string"&&C.trim().length>0)return C.trim()}}return""},Wt={};q.forEach(e=>{const t=Pt(e==null?void 0:e.details,e);Wt[t]=(Wt[t]||0)+1});const Fi=Object.entries(Wt).map(([e,t])=>{const n=String(e).trim(),m=/eternal battlegrounds|^ebg$/i.test(n);let r="#64748b";return m?r="#ffffff":/red/i.test(n)?r="#ef4444":/blue/i.test(n)?r="#3b82f6":/green/i.test(n)&&(r="#22c55e"),{name:e,value:t,color:r}}).sort((e,t)=>t.value-e.value),{boonTables:Bi}=In(q),Ii=q.map((e,t)=>{var m,r;const n=((m=e.details)==null?void 0:m.players)||[];return{index:t+1,label:`Log ${t+1}`,timestamp:Je(e.details,e),squadCount:n.filter(C=>!C.notInSquad).length,friendlyCount:n.length,enemies:((r=e.details)==null?void 0:r.targets).filter(C=>!C.isFake).length}}).sort((e,t)=>e.timestamp-t.timestamp),yt={};Array.from(Ae.values()).forEach(e=>{e.profession&&e.profession!=="Unknown"&&(yt[e.profession]=(yt[e.profession]||0)+1)});const Pi=Object.entries(yt).map(([e,t])=>({name:e,value:t,color:en(e)})).sort((e,t)=>t.value-e.value),Vt={};Object.keys(Fe).length===0&&q.forEach(e=>{var t,n;(n=(t=e.details)==null?void 0:t.targets)==null||n.forEach(m=>{if(m.isFake)return;const r=m.profession&&m.profession!=="Unknown"?m.profession:m.name||m.id||"Unknown",C=st(r);Vt[C]=(Vt[C]||0)+1})});const Hi=Object.keys(Fe).length>0?Fe:Vt,Ui=Object.entries(Hi).map(([e,t])=>({name:e,value:t,color:en(e)})).sort((e,t)=>t.value-e.value),Li=q.map((e,t)=>({log:e,originalIndex:t})).sort((e,t)=>Je(e.log.details,e.log)-Je(t.log.details,t.log)).map(({log:e},t)=>{const n=e.details;if(!n)return null;const m=n.players||[],r=m.filter(i=>!i.notInSquad),C=m.filter(i=>i.notInSquad),T=n.targets||[],z=T.filter(i=>!i.isFake),E=r.reduce((i,A)=>{var f,b;return i+(((b=(f=A.dpsAll)==null?void 0:f[0])==null?void 0:b.damage)||0)},0),Y=r.reduce((i,A)=>{var f,b;return i+(((b=(f=A.defenses)==null?void 0:f[0])==null?void 0:b.damageTaken)||0)},0),{enemyDeaths:pe,enemyDownsDeaths:oe}=Ue(n),F=Be(n),$=Je(n,e),x=Pt(n,e),K={red:0,green:0,blue:0},de=i=>{const A=Number(i);return Number.isFinite(A)?A:0},me=i=>{if(!i||typeof i!="object")return;const A=i.teamID??i.teamId??i.team??i.teamColor??i.team_color;if(A!=null)return A;const f=Object.keys(i).find(b=>/^team/i.test(b));return f?i[f]:void 0},l=(i,A)=>{if(i==null)return null;if(typeof i=="string"){const f=i.toLowerCase();return f.includes("red")?"red":f.includes("green")?"green":f.includes("blue")?"blue":f==="r"?"red":f==="g"?"green":f==="b"?"blue":null}if(typeof i=="number")if(A==="zeroBased"){if(i===0)return"red";if(i===1)return"green";if(i===2)return"blue"}else{if(i===1)return"red";if(i===2)return"green";if(i===3)return"blue"}return null},p=(i,A)=>{const f={};return i.forEach(b=>{const R=A(b),y=st(R);y&&(f[y]=(f[y]||0)+1)}),f},g=p(r,i=>(i==null?void 0:i.profession)||(i==null?void 0:i.name)),k=p(C,i=>(i==null?void 0:i.profession)||(i==null?void 0:i.name)),B=p(z,i=>(i==null?void 0:i.profession)||(i==null?void 0:i.name)||(i==null?void 0:i.id));if(n.teamCounts&&typeof n.teamCounts=="object"){const i=n.teamCounts;K.red=de(i.red??i.r??i[0]??i[1]),K.green=de(i.green??i.g??i[1]??i[2]),K.blue=de(i.blue??i.b??i[2]??i[3])}else{const i=[];T.forEach(R=>{if(R!=null&&R.isFake)return;const y=me(R);y!=null&&i.push(y)}),m.forEach(R=>{if(!(R!=null&&R.notInSquad))return;const y=me(R);y!=null&&i.push(y)}),i.length===0&&m.forEach(R=>{const y=me(R);y!=null&&i.push(y)});const A=new Set;i.forEach(R=>{typeof R=="number"&&A.add(R)});const f=A.has(0)?"zeroBased":A.has(3)?"oneBased":"zeroBased";if(i.forEach(R=>{const y=l(R,f);y&&(K[y]+=1)}),K.red+K.green+K.blue===0&&i.length>0){const R=new Map;i.forEach(Me=>{const ve=String(Me);R.set(ve,(R.get(ve)||0)+1)});const y=Array.from(R.values()).sort((Me,ve)=>ve-Me);K.red=y[0]||0,K.green=y[1]||0,K.blue=y[2]||0}K.red+K.green+K.blue===0&&(K.red=Math.max(z.length,m.filter(R=>R==null?void 0:R.notInSquad).length))}return{id:e.filePath||`fight-${t}`,label:e.encounterName||`Fight ${t+1}`,permalink:Ei(n,e),timestamp:$,mapName:x,duration:ui(n.durationMS),isWin:F,squadCount:r.length,allyCount:C.length,enemyCount:z.length,teamCounts:K,alliesDown:r.reduce((i,A)=>{var f,b;return i+(((b=(f=A.defenses)==null?void 0:f[0])==null?void 0:b.downCount)||0)},0),alliesDead:r.reduce((i,A)=>{var f,b;return i+(((b=(f=A.defenses)==null?void 0:f[0])==null?void 0:b.deadCount)||0)},0),alliesRevived:r.reduce((i,A)=>{var f,b;return Number(((b=(f=A.statsAll)==null?void 0:f[0])==null?void 0:b.saved)||0)>0?i+1:i},0),rallies:0,enemyDeaths:pe,enemyDowns:Math.max(0,oe-pe),totalOutgoingDamage:E,totalIncomingDamage:Y,incomingBarrierAbsorbed:r.reduce((i,A)=>{var f,b;return i+(((b=(f=A.defenses)==null?void 0:f[0])==null?void 0:b.damageBarrier)||0)},0),outgoingBarrierAbsorbed:r.reduce((i,A)=>{var R;const f=(R=A.extBarrierStats)==null?void 0:R.outgoingBarrier;if(!Array.isArray(f))return i;let b=0;return f.forEach(y=>{if(Array.isArray(y)){y.forEach(Me=>{b+=Number((Me==null?void 0:Me.barrier)||0)});return}b+=Number((y==null?void 0:y.barrier)||0)}),i+b},0),squadClassCountsFight:g,allyClassCountsFight:k,enemyClassCounts:B}}).filter(Boolean),$i=(e,t)=>{const n=(t==null?void 0:t.skillMap)||{},m=(t==null?void 0:t.buffMap)||{};let r=0,C="";const T=E=>{const Y=Number(E);if(!Number.isFinite(Y))return String(E||"Unknown Skill");const pe=(n==null?void 0:n[`s${Y}`])||(n==null?void 0:n[`${Y}`]);if(pe!=null&&pe.name)return String(pe.name);const oe=(m==null?void 0:m[`b${Y}`])||(m==null?void 0:m[`${Y}`]);return oe!=null&&oe.name?String(oe.name):`Skill ${Y}`},z=E=>{if(!E||typeof E!="object")return;const Y=[Number(E.max),Number(E.maxDamage),Number(E.maxHit),Number(E.totalDamage)>0&&Number(E.connectedHits)>0?Number(E.totalDamage)/Number(E.connectedHits):0].filter(oe=>Number.isFinite(oe)),pe=Y.length>0?Math.max(...Y):0;pe>r&&(r=pe,C=T(E.id))};return Array.isArray(e==null?void 0:e.totalDamageDist)&&e.totalDamageDist.forEach(E=>{Array.isArray(E)&&E.forEach(Y=>z(Y))}),Array.isArray(e==null?void 0:e.targetDamageDist)&&e.targetDamageDist.forEach(E=>{Array.isArray(E)&&E.forEach(Y=>{Array.isArray(Y)&&Y.forEach(pe=>z(pe))})}),{peak:r,skillName:C||"Unknown Skill"}},xi=(()=>{const e=F=>String(F||"").replace(/^Detailed\s*WvW\s*-\s*/i,"").replace(/^World\s*vs\s*World\s*-\s*/i,"").replace(/^WvW\s*-\s*/i,"").trim(),t=F=>e(F).toLowerCase().split(/[^a-z0-9]+/i).map($=>$.trim()).filter(Boolean).map($=>$.length>3&&$.endsWith("s")?$.slice(0,-1):$),n=(F,$)=>{const x=e(F),K=e($);if(!K)return x;if(!x)return K;const de=t(x),me=t(K),l=new Set(de),p=new Set(me),g=me.length>0&&me.every(B=>l.has(B)),k=de.length>0&&de.every(B=>p.has(B));return g||k?x:`${x} - ${K}`},m=[],r=new Map,C=F=>{const $=g=>{if(!Array.isArray(g)||g.length===0)return[];const k=[];for(let B=0;B<g.length;B+=1){const i=Number(g[B]||0),A=B>0?Number(g[B-1]||0):0;k.push(Math.max(0,i-A))}return k},x=g=>{if(!Array.isArray(g))return[];const k=g.reduce((i,A)=>Math.max(i,Array.isArray(A)?A.length:0),0);if(k<=0)return[];const B=new Array(k).fill(0);return g.forEach(i=>{if(Array.isArray(i))for(let A=0;A<k;A+=1)B[A]+=Number(i[A]||0)}),B},K=g=>Array.isArray(g)?g.map(k=>Number(k||0)):null,me=(g=>{if(!Array.isArray(g)||g.length===0)return null;const k=g[0];if(!Array.isArray(k))return null;if(Array.isArray(k[0])&&Array.isArray(k[0][0]))return x(k);if(Array.isArray(k[0])&&!Array.isArray(k[0][0])){const B=g.map(i=>K(Array.isArray(i)?i[0]:null)).filter(i=>Array.isArray(i)&&i.length>0);if(B.length>0)return x(B)}return null})(F==null?void 0:F.targetDamage1S),l=Array.isArray(F==null?void 0:F.damage1S)&&Array.isArray(F.damage1S[0])?F.damage1S[0]:null,p=me||(Array.isArray(l)?l.map(g=>Number(g||0)):[]);return $(p)},T=(F,$)=>{if(!Array.isArray(F)||F.length===0||$<=0)return 0;let x=0,K=0;for(let de=0;de<F.length;de+=1)x+=Number(F[de]||0),de>=$&&(x-=Number(F[de-$]||0)),de>=$-1&&x>K&&(K=x);return Math.max(0,K)},z=(F,$)=>{if(!Array.isArray(F)||F.length===0||$<=0)return[];const x=[];for(let K=0;K<F.length;K+=$){const de=Math.min(K+$,F.length),me=F.slice(K,de).reduce((l,p)=>l+Number(p||0),0);x.push(me)}return x},E=F=>Array.isArray(F)?F.map($=>Array.isArray($)?[Number($[0]),Number($[1])]:$&&typeof $=="object"?[Number($.time),Number($.value)]:null).filter($=>!!$&&Number.isFinite($[0])&&$[0]>=0):[],Y=(F,$,x,K,de)=>{if(!F.length||K<=0)return[];const me=Math.max(K*5e3,de||0),l=b=>b.reduce((R,y)=>y>=0&&y<=me+2e3?R+1:R,0),p=F.map(b=>Number(b||0)).filter(b=>Number.isFinite(b)&&b>=0);if(!p.length)return[];const g=[p],k=p.reduce((b,R)=>Math.max(b,R),0),B=p.reduce((b,R)=>Math.min(b,R),Number.POSITIVE_INFINITY);k>me*20&&g.push(p.map(b=>b/1e3)),k<=me*2&&B>=0&&k>0&&k<Math.max(120,K*5+10)&&g.push(p.map(b=>b*1e3));let i=p,A=0,f=-1;return g.forEach(b=>{const R=b.reduce((Me,ve)=>Math.min(Me,ve),Number.POSITIVE_INFINITY),y=new Set([0,...$,...x]);if(Number.isFinite(R)&&me>0&&R>me){const Me=Math.floor(R/me)*me;y.add(Me),y.add(Math.max(0,Me-me))}y.forEach(Me=>{const ve=b.map(se=>se-Me),Re=l(ve);Re>f&&(f=Re,A=Me,i=b)})}),i.map(b=>b-A).filter(b=>Number.isFinite(b)&&b>=0)},pe=(F,$,x,K,de)=>{const me=Y(F,$,x,K,de);return Array.from(new Set(me.map(l=>Math.floor(l/5e3)).filter(l=>Number.isFinite(l)&&l>=0&&l<K)))};q.map(F=>({log:F,ts:Je(F==null?void 0:F.details,F)})).sort((F,$)=>F.ts-$.ts).forEach(({log:F},$)=>{const x=F==null?void 0:F.details;if(!x)return;const K=e(x.fightName||F.fightName||`Fight ${$+1}`),de=Pt(x,F),me=n(K,String(de||"")),l={},p=Array.isArray(x.players)?x.players:[],g=p.flatMap(f=>{const b=f==null?void 0:f.combatReplayData;return Array.isArray(b)?b.map(R=>Number(R==null?void 0:R.start)):[Number(b==null?void 0:b.start)]}).filter(f=>Number.isFinite(f)&&f>=0);p.forEach(f=>{if(f!=null&&f.notInSquad)return;const b=String((f==null?void 0:f.account)||(f==null?void 0:f.name)||"Unknown"),R=String((f==null?void 0:f.character_name)||(f==null?void 0:f.display_name)||(f==null?void 0:f.name)||""),y=String((f==null?void 0:f.profession)||"Unknown"),Me=`${b}|${y}`,ve=$i(f,x),Re=Number(ve.peak||0),se=C(f),Oe=Number(T(se,1)||0),s=Number(T(se,5)||0),h=Number(T(se,30)||0),H=Math.max(0,Math.ceil(Number((x==null?void 0:x.durationMS)||0)/5e3)),G=Math.max(0,Math.ceil(se.length/5)),j=Math.max(H,G),a=z(se,5),D=Array.from({length:j},(I,V)=>Number(a[V]||0)),N=(()=>{const I=f==null?void 0:f.combatReplayData;return Array.isArray(I)?I.filter(V=>V&&typeof V=="object"):I&&typeof I=="object"?[I]:[]})(),P=N.map(I=>Number(I==null?void 0:I.start)).filter(I=>Number.isFinite(I)&&I>=0),ee=N.flatMap(I=>E(I==null?void 0:I.down).map(([V])=>Number(V||0))),X=N.flatMap(I=>E(I==null?void 0:I.dead).map(([V])=>Number(V||0)));l[Me]={hit:Re,burst1s:Oe,burst5s:s,burst30s:h,skillName:ve.skillName,buckets5s:D,downIndices5s:pe(ee,P,g,j,Number((x==null?void 0:x.durationMS)||0)),deathIndices5s:pe(X,P,g,j,Number((x==null?void 0:x.durationMS)||0))};const w=r.get(Me)||{key:Me,account:b,displayName:b,characterName:R,profession:y,professionList:[y],logs:0,peakHit:0,peak1s:0,peak5s:0,peak30s:0,peakFightLabel:"",peakSkillName:""};w.logs+=1,w.professionList.includes(y)||w.professionList.push(y),!w.characterName&&R&&(w.characterName=R),Re>w.peakHit&&(w.peakHit=Re,w.peakFightLabel=me,w.peakSkillName=ve.skillName),Oe>w.peak1s&&(w.peak1s=Oe),s>w.peak5s&&(w.peak5s=s),h>w.peak30s&&(w.peak30s=h),r.set(Me,w)});const k=Object.values(l).reduce((f,b)=>Math.max(f,Number((b==null?void 0:b.hit)||0)),0),B=Object.values(l).reduce((f,b)=>Math.max(f,Number((b==null?void 0:b.burst1s)||0)),0),i=Object.values(l).reduce((f,b)=>Math.max(f,Number((b==null?void 0:b.burst5s)||0)),0),A=Object.values(l).reduce((f,b)=>Math.max(f,Number((b==null?void 0:b.burst30s)||0)),0);m.push({id:F.filePath||F.id||`fight-${$+1}`,shortLabel:`F${$+1}`,fullLabel:me,timestamp:Je(x,F),values:l,maxHit:k,max1s:B,max5s:i,max30s:A})});const oe=Array.from(r.values()).sort((F,$)=>$.peakHit!==F.peakHit?$.peakHit-F.peakHit:F.displayName.localeCompare($.displayName));return{fights:m,players:oe}})(),Oi=(()=>{const e=l=>String(l||"").replace(/^Detailed\s*WvW\s*-\s*/i,"").replace(/^World\s*vs\s*World\s*-\s*/i,"").replace(/^WvW\s*-\s*/i,"").trim(),t=l=>e(l).toLowerCase().split(/[^a-z0-9]+/i).map(p=>p.trim()).filter(Boolean).map(p=>p.length>3&&p.endsWith("s")?p.slice(0,-1):p),n=(l,p)=>{const g=e(l),k=e(p);if(!k)return g;if(!g)return k;const B=t(g),i=t(k),A=new Set(B),f=new Set(i),b=i.length>0&&i.every(y=>A.has(y)),R=B.length>0&&B.every(y=>f.has(y));return b||R?g:`${g} - ${k}`},m=[],r=new Map,C=(l,p)=>{const g=Number(l);if(!Number.isFinite(g))return{name:String(l||"Unknown Skill"),icon:void 0};const k=(p==null?void 0:p.skillMap)||{},B=(p==null?void 0:p.buffMap)||{},i=(k==null?void 0:k[`s${g}`])||(k==null?void 0:k[`${g}`]);if(i!=null&&i.name)return{name:String(i.name),icon:i==null?void 0:i.icon};const A=(B==null?void 0:B[`b${g}`])||(B==null?void 0:B[`${g}`]);return A!=null&&A.name?{name:String(A.name),icon:A==null?void 0:A.icon}:{name:`Skill ${g}`,icon:void 0}},T=(l,p)=>{let g=0,k="";const B=i=>{if(!i||typeof i!="object"||i.indirectDamage)return;const A=[Number(i.max),Number(i.maxDamage),Number(i.maxHit),Number(i.totalDamage)>0&&Number(i.connectedHits)>0?Number(i.totalDamage)/Number(i.connectedHits):0].filter(b=>Number.isFinite(b)),f=A.length>0?Math.max(...A):0;f>g&&(g=f,k=C(i.id,p).name)};return Array.isArray(l==null?void 0:l.totalDamageDist)&&l.totalDamageDist.forEach(i=>{Array.isArray(i)&&i.forEach(A=>B(A))}),Array.isArray(l==null?void 0:l.targetDamageDist)&&l.targetDamageDist.forEach(i=>{Array.isArray(i)&&i.forEach(A=>{Array.isArray(A)&&A.forEach(f=>B(f))})}),{peak:g,skillName:k||"Unknown Skill"}},z=l=>{if(!Array.isArray(l)||l.length===0)return[];const p=[];for(let g=0;g<l.length;g+=1){const k=Number(l[g]||0),B=g>0?Number(l[g-1]||0):0;p.push(Math.max(0,k-B))}return p},E=l=>{if(!Array.isArray(l)||l.length===0)return[];const p=l.reduce((k,B)=>Math.max(k,Array.isArray(B)?B.length:0),0);if(p<=0)return[];const g=new Array(p).fill(0);return l.forEach(k=>{if(Array.isArray(k))for(let B=0;B<p;B+=1)g[B]+=Number(k[B]||0)}),g},Y=l=>{if(!Array.isArray(l)||l.length===0)return[];const p=l[0];if(typeof p=="number")return l.map(g=>Number(g||0));if(Array.isArray(p)&&p.length>0){if(typeof p[0]=="number")return p.map(g=>Number(g||0));if(Array.isArray(p[0])){const g=p.map(k=>Array.isArray(k)?k.map(B=>Number(B||0)):null).filter(k=>Array.isArray(k)&&k.length>0);if(g.length>0)return E(g)}}return[]},pe=l=>{const p=Y(l==null?void 0:l.powerDamage1S),g=Y(l==null?void 0:l.damage1S),k=p.length>0?p:g;return z(k)},oe=(l,p)=>{const g=l==null?void 0:l.targetPowerDamage1S;if(!Array.isArray(g)||!Array.isArray(g[p]))return[];const k=g[p];if(!Array.isArray(k)||k.length===0)return[];if(typeof k[0]=="number")return k.map(B=>Number(B||0));if(Array.isArray(k[0])&&!Array.isArray(k[0][0]))return k[0].map(B=>Number(B||0));if(Array.isArray(k[0])&&Array.isArray(k[0][0])){const i=k[0].map(A=>Array.isArray(A)?A.map(f=>Number(f||0)):null).filter(A=>Array.isArray(A)&&A.length>0);return E(i)}return[]},F=(l,p)=>{if(!Array.isArray(l)||l.length===0||p<=0)return 0;let g=0,k=0;for(let B=0;B<l.length;B+=1)g+=Number(l[B]||0),B>=p&&(g-=Number(l[B-p]||0)),B>=p-1&&g>k&&(k=g);return Math.max(0,k)},$=(l,p)=>{if(!Array.isArray(l)||l.length===0||p<=0)return[];const g=[];for(let k=0;k<l.length;k+=p){const B=Math.min(k+p,l.length),i=l.slice(k,B).reduce((A,f)=>A+Number(f||0),0);g.push(i)}return g},x=l=>Array.isArray(l)?l.map(p=>Array.isArray(p)?[Number(p[0]),Number(p[1])]:p&&typeof p=="object"?[Number(p.time),Number(p.value)]:null).filter(p=>!!p&&Number.isFinite(p[0])&&p[0]>=0):[],K=(l,p,g,k,B)=>{if(!l.length||k<=0)return[];const i=Math.max(k*5e3,B||0),A=se=>se.reduce((Oe,s)=>s>=0&&s<=i+2e3?Oe+1:Oe,0),f=l.map(se=>Number(se||0)).filter(se=>Number.isFinite(se)&&se>=0);if(!f.length)return[];const b=[f],R=f.reduce((se,Oe)=>Math.max(se,Oe),0),y=f.reduce((se,Oe)=>Math.min(se,Oe),Number.POSITIVE_INFINITY);R>i*20&&b.push(f.map(se=>se/1e3)),R<=i*2&&y>=0&&R>0&&R<Math.max(120,k*5+10)&&b.push(f.map(se=>se*1e3));let Me=f,ve=0,Re=-1;return b.forEach(se=>{const Oe=se.reduce((h,H)=>Math.min(h,H),Number.POSITIVE_INFINITY),s=new Set([0,...p,...g]);if(Number.isFinite(Oe)&&i>0&&Oe>i){const h=Math.floor(Oe/i)*i;s.add(h),s.add(Math.max(0,h-i))}s.forEach(h=>{const H=se.map(j=>j-h),G=A(H);G>Re&&(Re=G,ve=h,Me=se)})}),Me.map(se=>se-ve).filter(se=>Number.isFinite(se)&&se>=0)},de=(l,p,g,k,B)=>{const i=K(l,p,g,k,B);return Array.from(new Set(i.map(A=>Math.floor(A/5e3)).filter(A=>Number.isFinite(A)&&A>=0&&A<k)))};q.map(l=>({log:l,ts:Je(l==null?void 0:l.details,l)})).sort((l,p)=>l.ts-p.ts).forEach(({log:l},p)=>{const g=l==null?void 0:l.details;if(!g)return;const k=e(g.fightName||l.fightName||`Fight ${p+1}`),B=Pt(g,l),i=n(k,String(B||"")),A={},b=(Array.isArray(g.players)?g.players:[]).filter(a=>!(a!=null&&a.notInSquad)),R=b.flatMap(a=>{const D=a==null?void 0:a.combatReplayData;return Array.isArray(D)?D.map(N=>Number(N==null?void 0:N.start)):[Number(D==null?void 0:D.start)]}).filter(a=>Number.isFinite(a)&&a>=0),y=b.flatMap(a=>{const D=a==null?void 0:a.combatReplayData;return(Array.isArray(D)?D:D?[D]:[]).flatMap(P=>x(P==null?void 0:P.down).map(([ee])=>Number(ee||0)))}),Me=b.flatMap(a=>{const D=a==null?void 0:a.combatReplayData;return(Array.isArray(D)?D:D?[D]:[]).flatMap(P=>x(P==null?void 0:P.dead).map(([ee])=>Number(ee||0)))}),ve=new Map,Re=new Map,se=new Map;(Array.isArray(g.targets)?g.targets:[]).forEach((a,D)=>{if(!a||a.isFake||!a.enemyPlayer)return;const N=st((a==null?void 0:a.profession)||(a==null?void 0:a.name)||(a==null?void 0:a.id))||"Unknown";se.set(N,(se.get(N)||0)+1);const P=Re.get(N)||new Map;Array.isArray(a==null?void 0:a.totalDamageDist)&&a.totalDamageDist.forEach(Z=>{Array.isArray(Z)&&Z.forEach(J=>{if(!J||typeof J!="object"||J.indirectDamage)return;const fe=Number(J.totalDamage||0);if(!Number.isFinite(fe)||fe<=0)return;const O=Number(J.connectedHits||J.hits||0),ae=C(J.id,g),re=ae.name,te=P.get(re)||{skillName:re,damage:0,hits:0,icon:ae.icon};te.damage+=fe,te.hits+=Number.isFinite(O)?O:0,!te.icon&&ae.icon&&(te.icon=ae.icon),P.set(re,te)})}),Re.set(N,P);const ee=E(b.map(Z=>oe(Z,D))),X=ee.length>0?z(ee):pe(a),w=T(a,g);let I=ve.get(N);I||(I={perSecond:[],hit:0,skillName:""},ve.set(N,I)),X.length>I.perSecond.length&&(I.perSecond.length=X.length);for(let Z=0;Z<X.length;Z+=1)I.perSecond[Z]=Number(I.perSecond[Z]||0)+Number(X[Z]||0);const V=Number(w.peak||0);V>I.hit&&(I.hit=V,I.skillName=w.skillName||"Unknown Skill")});const s=Array.from(ve.values()).some(a=>Array.isArray(a.perSecond)&&a.perSecond.some(D=>Number(D||0)>0));if(ve.size===0||!s){const a=E(b.map(N=>{const P=Y(N==null?void 0:N.powerDamageTaken1S);return z(P)})),D=Array.from(se.values()).reduce((N,P)=>N+Number(P||0),0);a.length>0&&D>0&&se.forEach((N,P)=>{const ee=Number(N||0)/D,X=a.map(I=>Number(I||0)*ee),w=ve.get(P);ve.set(P,{perSecond:X,hit:Number((w==null?void 0:w.hit)||0),skillName:String((w==null?void 0:w.skillName)||"")})})}ve.forEach((a,D)=>{var ae;const N=D,P=Number(a.hit||0),ee=Number(F(a.perSecond,1)||0),X=Number(F(a.perSecond,5)||0),w=Number(F(a.perSecond,30)||0),I=Math.max(0,Math.ceil(Number((g==null?void 0:g.durationMS)||0)/5e3)),V=Math.max(0,Math.ceil(a.perSecond.length/5)),Z=Math.max(I,V),J=$(a.perSecond,5),fe=Array.from({length:Z},(re,te)=>Number(J[te]||0));A[N]={hit:P,burst1s:ee,burst5s:X,burst30s:w,skillName:a.skillName||"Unknown Skill",buckets5s:fe,downIndices5s:de(y,[],R,Z,Number((g==null?void 0:g.durationMS)||0)),deathIndices5s:de(Me,[],R,Z,Number((g==null?void 0:g.durationMS)||0)),skillRows:Array.from(((ae=Re.get(D))==null?void 0:ae.values())||[]).sort((re,te)=>te.damage-re.damage).slice(0,50)};const O=r.get(N)||{key:N,account:D,displayName:D,characterName:"",profession:D,professionList:[D],logs:0,peakHit:0,peak1s:0,peak5s:0,peak30s:0,peakFightLabel:"",peakSkillName:""};O.logs+=1,P>O.peakHit&&(O.peakHit=P,O.peakFightLabel=i,O.peakSkillName=a.skillName||"Unknown Skill"),ee>O.peak1s&&(O.peak1s=ee),X>O.peak5s&&(O.peak5s=X),w>O.peak30s&&(O.peak30s=w),r.set(N,O)});const h=Object.values(A).reduce((a,D)=>Math.max(a,Number((D==null?void 0:D.hit)||0)),0),H=Object.values(A).reduce((a,D)=>Math.max(a,Number((D==null?void 0:D.burst1s)||0)),0),G=Object.values(A).reduce((a,D)=>Math.max(a,Number((D==null?void 0:D.burst5s)||0)),0),j=Object.values(A).reduce((a,D)=>Math.max(a,Number((D==null?void 0:D.burst30s)||0)),0);m.push({id:l.filePath||l.id||`fight-${p+1}`,shortLabel:`F${p+1}`,fullLabel:i,timestamp:Je(g,l),values:A,maxHit:h,max1s:H,max5s:G,max30s:j})});const me=Array.from(r.values()).sort((l,p)=>p.peakHit!==l.peakHit?p.peakHit-l.peakHit:l.displayName.localeCompare(p.displayName));return{fights:m,players:me}})(),Ri=Array.from(Qe.entries()).map(([e,t])=>{const n=Ze.get(e)||{},m=Array.from(t.values()).map(r=>{var pe;const C=Array.from(r.professions||[]).filter(oe=>oe&&oe!=="Unknown");let T=r.profession||"Unknown";if(C.length>0){T=C[0];let oe=((pe=r.professionTimeMs)==null?void 0:pe[T])||0;C.forEach(F=>{var x;const $=((x=r.professionTimeMs)==null?void 0:x[F])||0;$>oe&&(oe=$,T=F)})}const z=r.durationMs||0,E=r.totalMs/1e3,Y=z>0?r.totalMs/z:0;return{account:r.account,profession:T,professionList:C,total:E,perSecond:Y,duration:z/1e3}}).filter(r=>r.total>0||r.perSecond>0);return{id:e,name:n.name||e,icon:n.icon,rows:m}}).filter(e=>e.rows.length>0),_i=Array.from(je.values()).map(e=>{const t=Array.from(e.skills.values()).sort((m,r)=>r.damage-m.damage),n=t.reduce((m,r)=>(m[r.id]=r,m),{});return{key:e.key,account:e.account,displayName:e.displayName,profession:e.profession,professionList:e.professionList,totalFightMs:e.totalFightMs,skills:t,skillMap:n}}).sort((e,t)=>e.displayName.localeCompare(t.displayName));return{total:W,wins:ke,losses:U,avgSquadSize:hi,avgEnemies:bi,squadKDR:ki,enemyKDR:Si,totalSquadKills:De,totalSquadDeaths:ue,totalEnemyKills:ge,totalEnemyDeaths:_e,leaderboards:He,...Ti,outgoingConditionSummary:Object.values(Ie).sort((e,t)=>t.damage-e.damage),incomingConditionSummary:Object.values($e).sort((e,t)=>t.damage-e.damage),outgoingConditionPlayers:Array.from(Ae.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,conditions:e.outgoingConditions})),incomingConditionPlayers:Array.from(Ae.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,conditions:e.incomingConditions})),topSkills:Mi,topIncomingSkills:wi,playerSkillBreakdowns:_i,topSkillsMetric:L,mapData:Fi,timelineData:Ii,boonTables:Bi,offensePlayers:Array.from(Ae.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,offenseTotals:e.offenseTotals,offenseRateWeights:e.offenseRateWeights,totalFightMs:e.totalFightMs})),defensePlayers:Array.from(Ae.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,defenseTotals:e.defenseTotals,activeMs:e.defenseActiveMs})),damageMitigationPlayers:Ci,damageMitigationMinions:Di,supportPlayers:Array.from(Ae.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,supportTotals:e.supportTotals,activeMs:e.supportActiveMs})),healingPlayers:Array.from(Ae.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,healingTotals:e.healingTotals,activeMs:e.healingActiveMs})),mvp:jt,silver:kn,bronze:Sn,squadClassData:Pi,enemyClassData:Ui,fightBreakdown:Li,spikeDamage:xi,incomingStrikeDamage:Oi,specialTables:Ri,topStatsPerSecond:Xe,topStatsLeaderboardsPerSecond:Ye,avgMvpScore:Cn}})(),ye=(()=>{const Ce=new Map,Se=new Map,L=[],W=new Map,ke=new Map;q.forEach(ce=>{const le=ce.details;if(!le)return;const ue=le.skillMap||{},De=le.fightName||"Log",_e=Je(le,ce)||Date.now(),ge={id:ce.filePath||ce.id||De,label:De,timestamp:_e,skillEntries:{},playerActiveSeconds:{},durationSeconds:le.durationMS?le.durationMS/1e3:0};(le.players||[]).forEach(Be=>{if(Be.notInSquad)return;const Ae=Be.account||Be.name||"Unknown",qe=Be.profession||"Unknown",Ne=`${Ae}|${qe}`;let Te=Se.get(Ne);Te||(Te={key:Ne,account:Ae,displayName:Ae,profession:qe,professionList:[qe],logs:0,totalActiveSeconds:0,skillTotals:{}},Se.set(Ne,Te)),Te.logs++;const je=(Array.isArray(Be.activeTimes)?Be.activeTimes[0]:0)/1e3;Te.totalActiveSeconds=(Te.totalActiveSeconds||0)+je,ge.playerActiveSeconds[Ne]=je,(Be.rotation||[]).forEach(Ie=>{var Tt,Mt,wt;if(!(Ie!=null&&Ie.id))return;const $e=((Tt=Ie.skills)==null?void 0:Tt.length)||0;if($e<=0)return;const Fe=`s${Ie.id}`,Ze=((Mt=ue[Fe])==null?void 0:Mt.name)||`Skill ${Ie.id}`,Qe=(wt=ue[Fe])==null?void 0:wt.icon;Te.skillTotals[Fe]=(Te.skillTotals[Fe]||0)+$e,Ce.set(Fe,(Ce.get(Fe)||0)+$e),W.set(Fe,Ze),Qe&&!ke.has(Fe)&&ke.set(Fe,Qe),ge.skillEntries[Fe]||(ge.skillEntries[Fe]={name:Ze,icon:Qe,players:{}}),!ge.skillEntries[Fe].icon&&Qe&&(ge.skillEntries[Fe].icon=Qe),ge.skillEntries[Fe].players[Ne]=(ge.skillEntries[Fe].players[Ne]||0)+$e})}),L.push(ge)});const U=Array.from(Ce.entries()).map(([ce,le])=>({id:ce,name:W.get(ce)||ce,total:le,icon:ke.get(ce)})).sort((ce,le)=>le.total-ce.total);return{logRecords:L,players:Array.from(Se.values()),skillOptions:U,resUtilitySkills:[]}})();return{validLogs:q,stats:xe,skillUsageData:ye}};let Ge=null,ut=!1,tn=null,nn=0,on=0,$t=null;const sn=o=>{if(!o||typeof o!="object")return o;const c=(v,_)=>{const q={};return _.forEach(he=>{v&&Object.prototype.hasOwnProperty.call(v,he)&&(q[he]=v[he])}),q},u=c(o,["players","targets","durationMS","uploadTime","timeStart","timeStartStd","timeEnd","timeEndStd","fightName","success","teamCounts","combatReplayMetaData","skillMap","buffMap","encounterDuration","player_damage_mitigation","player_minion_damage_mitigation","playerDamageMitigation","playerMinionDamageMitigation"]);return Array.isArray(u.players)&&(u.players=u.players.map(v=>c(v,["name","display_name","character_name","profession","elite_spec","group","dpsAll","statsAll","dpsTargets","statsTargets","defenses","support","rotation","extHealingStats","extBarrierStats","squadBuffVolumes","selfBuffs","groupBuffs","squadBuffs","selfBuffsActive","groupBuffsActive","squadBuffsActive","buffUptimes","totalDamageDist","targetDamageDist","damage1S","targetDamage1S","powerDamageTaken1S","targetPowerDamage1S","totalDamageTaken","totalDamageTakenDist","minions","combatReplayData","hasCommanderTag","notInSquad","account","activeTimes"]))),Array.isArray(u.targets)&&(u.targets=u.targets.map(v=>c(v,["id","name","isFake","dpsAll","statsAll","defenses","totalHealth","healthPercentBurned","enemyPlayer","totalDamageDist","powerDamage1S","damage1S"]))),u},fi=o=>{if(!o||typeof o!="object")return o;const c={...o};return o.details?c.details=sn(o.details):c.details=sn(o),c},an=()=>{if(!ut||!Ge)return;ut=!1,nn+=1;const o=$t;$t=null;const c=di(Ge);self.postMessage({type:"result",result:c,computeId:nn,logCount:Ge.logs.length,token:on,completedAt:Date.now(),flushId:o})},xt=()=>{tn===null&&(tn=setInterval(()=>{an()},5e3))};self.onmessage=o=>{var u,v,_,q;const c=o.data;if((c==null?void 0:c.type)==="reset"){Ge={logs:[]},typeof c.token=="number"&&(on=c.token),ut=!0,xt();return}if((c==null?void 0:c.type)==="settings"){Ge={logs:(Ge==null?void 0:Ge.logs)||[],precomputedStats:(u=c.payload)==null?void 0:u.precomputedStats,mvpWeights:(v=c.payload)==null?void 0:v.mvpWeights,statsViewSettings:(_=c.payload)==null?void 0:_.statsViewSettings,disruptionMethod:(q=c.payload)==null?void 0:q.disruptionMethod},ut=!0,xt();return}if((c==null?void 0:c.type)==="log"){Ge||(Ge={logs:[]}),Ge.logs.push(fi(c.payload)),ut=!0,xt();return}(c==null?void 0:c.type)==="flush"&&(typeof c.flushId=="number"&&($t=c.flushId),ut=!0,an())}})();
