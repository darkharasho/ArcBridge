(function(){"use strict";const Kt=["selfBuffs","groupBuffs","squadBuffs"],yt=i=>i!=null&&i.classification?i.classification==="Boon":!0,Gt=i=>`b${i}`,Bn=(i,r)=>{const u=Array.isArray(i==null?void 0:i.activeTimes)?i.activeTimes:[],M=typeof u[0]=="number"?u[0]:0;return M>0?M:r},Yt=(i,r,u,M,R,_,ge)=>{const J=i==="selfBuffs"?1:Math.max(i==="groupBuffs"?_-1:ge-1,0);return!J||!R?{generationMs:0,wastedMs:0}:r?{generationMs:u*R*J,wastedMs:M*R*J}:{generationMs:u/100*R*J,wastedMs:M/100*R*J}},In=i=>{const r=new Map,u=new Map;return i.forEach(_=>{const ge=_.details;if(!ge)return;const J=ge.durationMS||0,pe=ge.buffMap||{};Object.entries(pe).forEach(([$,V])=>{if(!r.has($)){r.set($,V);return}const be=r.get($)||{},U={name:be.name||V.name,stacking:be.stacking??V.stacking,icon:be.icon||V.icon,classification:be.classification||V.classification};r.set($,U)});const Ve=(ge.players||[]).filter($=>!$.notInSquad),Se=Ve.length,ke=new Map;Ve.forEach($=>{const V=$.group??0;ke.set(V,(ke.get(V)||0)+1)}),Ve.forEach($=>{const V=$.account||$.name||$.character_name||"Unknown",be=$.profession||"Unknown",U=$.group??0,ie=ke.get(U)||1,oe=Bn($,J);u.has(V)||u.set(V,{account:V,profession:be,professions:new Set,professionTimeMs:{},activeTimeMs:0,numFights:0,groupSupported:0,squadSupported:0,boons:{}});const se=u.get(V);se.profession=be,be!=="Unknown"&&(se.professions.add(be),se.professionTimeMs[be]=(se.professionTimeMs[be]||0)+oe),se.activeTimeMs+=oe,se.numFights+=1,se.groupSupported+=ie,se.squadSupported+=Se,Kt.forEach(De=>{($[De]||[]).forEach(le=>{var Ie,$e,Fe,Ze;if(typeof(le==null?void 0:le.id)!="number")return;const Le=Gt(le.id),Be=pe[Le];if(!yt(Be))return;const Ae=(Be==null?void 0:Be.stacking)??!1,_e=(($e=(Ie=le.buffData)==null?void 0:Ie[0])==null?void 0:$e.generation)??0,Ne=((Ze=(Fe=le.buffData)==null?void 0:Fe[0])==null?void 0:Ze.wasted)??0,{generationMs:Me,wastedMs:qe}=Yt(De,Ae,_e,Ne,J,ie,Se);!Me&&!qe||(r.has(Le)||r.set(Le,Be||{}),se.boons[Le]||(se.boons[Le]={selfBuffs:{generationMs:0,wastedMs:0},groupBuffs:{generationMs:0,wastedMs:0},squadBuffs:{generationMs:0,wastedMs:0}}),se.boons[Le][De].generationMs+=Me,se.boons[Le][De].wastedMs+=qe)})})})}),{boonTables:Array.from(r.keys()).filter(_=>yt(r.get(_))).map(_=>{const ge=r.get(_)||{},J=[];return u.forEach(pe=>{var $;const Oe=pe.boons[_];if(!Oe||!Kt.some(V=>Oe[V].generationMs>0||Oe[V].wastedMs>0))return;const Se=Array.from(pe.professions||[]).filter(V=>V&&V!=="Unknown");let ke=pe.profession;if(Se.length>0){ke=Se[0];let V=(($=pe.professionTimeMs)==null?void 0:$[ke])||0;Se.forEach(be=>{var ie;const U=((ie=pe.professionTimeMs)==null?void 0:ie[be])||0;U>V&&(V=U,ke=be)})}J.push({account:pe.account,profession:ke||"Unknown",professionList:Se,activeTimeMs:pe.activeTimeMs||1,numFights:pe.numFights||1,groupSupported:pe.groupSupported||1,squadSupported:pe.squadSupported||1,categories:{selfBuffs:{...Oe.selfBuffs},groupBuffs:{...Oe.groupBuffs},squadBuffs:{...Oe.squadBuffs}}})}),{id:_,name:ge.name||_,icon:ge.icon,stacking:ge.stacking??!1,rows:J}}).filter(_=>_.rows.length>0)}},Jt=(i,r,u,M,R,_,ge={})=>{var $,V,be,U;const pe=((i==null?void 0:i[r])||[]).find(ie=>ie.id===u);if(!pe)return{generationMs:0,wastedMs:0};const Oe=ge[Gt(u)],Ve=(Oe==null?void 0:Oe.stacking)??!1,Se=((V=($=pe.buffData)==null?void 0:$[0])==null?void 0:V.generation)??0,ke=((U=(be=pe.buffData)==null?void 0:be[0])==null?void 0:U.wasted)??0;return Yt(r,Ve,Se,ke,M,R,_)};var Pn={methods:{tiered:{tiers:{shortMs:500,mediumMs:1500,weights:{short:.5,medium:1,long:2}}}}};const Hn=Pn,Lt="count",Un=i=>(i||0)/1e3,Ln=(i,r)=>{var R;if(!i)return 0;const u=(R=Hn.methods.tiered)==null?void 0:R.tiers;if(!u)return i;const M=r/Math.max(i,1);return M<=u.shortMs?i*u.weights.short:M<=u.mediumMs?i*u.weights.medium:i*u.weights.long},Qt=(i,r,u)=>u==="duration"?Un(r):u==="tiered"?Ln(i,r):i;function xn(i,r=Lt){var _;const u=(_=i.statsAll)==null?void 0:_[0],M=Number((u==null?void 0:u.appliedCrowdControl)??0),R=Number((u==null?void 0:u.appliedCrowdControlDuration)??0);return Qt(M,R,r)}function $n(i,r){const u=(r==null?void 0:r.durationMS)||0,M=(r==null?void 0:r.buffMap)||{},R=i.filter(J=>!J.notInSquad),_=R.length,ge=new Map;R.forEach(J=>{const pe=J.group??0;ge.set(pe,(ge.get(pe)||0)+1)}),R.forEach(J=>{const pe=ge.get(J.group??0)||1,Oe=Jt(J,"selfBuffs",1122,u,pe,_,M),Ve=Jt(J,"squadBuffs",1122,u,pe,_,M);J.stabGeneration=(Oe.generationMs+Ve.generationMs)/1e3})}function On(i){if(!i.statsTargets)return 0;let r=0;for(const u of i.statsTargets)u&&u.length>0&&(r+=u[0].downContribution||0);return r}function Rn(i){if(!i.extBarrierStats||!i.extBarrierStats.outgoingBarrierAllies)return 0;let r=0;for(const u of i.extBarrierStats.outgoingBarrierAllies)if(u)for(const M of u)M&&(r+=M.barrier||0);return r}function _n(i){if(!i.extHealingStats||!i.extHealingStats.outgoingHealingAllies)return 0;let r=0;for(const u of i.extHealingStats.outgoingHealingAllies)if(u)for(const M of u)M&&(r+=M.healing||0);return r}const qn=i=>{var r,u,M,R;return(((u=(r=i.support)==null?void 0:r[0])==null?void 0:u.condiCleanse)||0)+(((R=(M=i.support)==null?void 0:M[0])==null?void 0:R.condiCleanseSelf)||0)},jn=(i,r=Lt)=>{var _;const u=(_=i.support)==null?void 0:_[0],M=Number((u==null?void 0:u.boonStrips)??0),R=Number((u==null?void 0:u.boonStripsTime)??0);return Qt(M,R,r)},Wn=i=>On(i),Vn=i=>_n(i),zn=i=>Rn(i),Kn=(i,r=Lt)=>xn(i,r),yn=(i,r)=>$n(i,r),Gn="count",Yn={downContribution:1,healing:1,cleanses:1,strips:1,stability:1,cc:.7,revives:.7,distanceToTag:.7,participation:.7,dodging:.4,dps:.2,damage:.2},Jn={showMvp:!0,topSkillDamageSource:"target",topSkillsMetric:"damage"},Xt=new Map([["bleeding","Bleeding"],["burning","Burning"],["confusion","Confusion"],["poison","Poison"],["torment","Torment"],["vulnerability","Vulnerability"],["weakness","Weakness"],["weakened","Weakness"],["blind","Blind"],["blinded","Blind"],["blinding","Blind"],["cripple","Cripple"],["crippled","Cripple"],["chill","Chill"],["chilled","Chill"],["immob","Immobilize"],["immobile","Immobilize"],["immobilized","Immobilize"],["slow","Slow"],["slowed","Slow"],["fear","Fear"],["feared","Fear"],["taunt","Taunt"],["taunted","Taunt"]]),Qn={Blind:"https://render.guildwars2.com/file/09770136BB76FD0DBE1CC4267DEED54774CB20F6/102837.png",Chill:"https://render.guildwars2.com/file/28C4EC547A3516AF0242E826772DA43A5EAC3DF3/102839.png",Cripple:"https://render.guildwars2.com/file/070325E519C178D502A8160523766070D30C0C19/102838.png",Fear:"https://render.guildwars2.com/file/30307A6E766D74B6EB09EDA12A4A2DE50E4D76F4/102869.png",Immobilize:"https://render.guildwars2.com/file/397A613651BFCA2832B6469CE34735580A2C120E/102844.png",Slow:"https://render.guildwars2.com/file/F60D1EF5271D7B9319610855676D320CD25F01C6/961397.png",Taunt:"https://render.guildwars2.com/file/02EED459AD65FAF7DF32A260E479C625070841B9/1228472.png",Vulnerability:"https://render.guildwars2.com/file/3A394C1A0A3257EB27A44842DDEEF0DF000E1241/102850.png",Weakness:"https://render.guildwars2.com/file/6CB0E64AF9AA292E332A38C1770CE577E2CDE0E8/102853.png"},ft=i=>{if(!i)return null;const r=i.trim().toLowerCase(),u=Xt.get(r);if(u)return u;const M=r.split(/[^a-z]+/).filter(Boolean);for(const R of M){const _=Xt.get(R);if(_)return _}return null},Xn=i=>ft(i),Zt=i=>{const r=new Map;return i&&(Object.values(i).forEach(u=>{if(!(u!=null&&u.icon)||!(u!=null&&u.name))return;const M=ft(u.name);M&&(r.has(M)||r.set(M,u.icon))}),Object.entries(Qn).forEach(([u,M])=>{r.has(u)||r.set(u,M)})),r},Nt=(i,r,u)=>{var M;if(r&&u){const R=(M=u[`b${r}`])==null?void 0:M.name,_=ft(R);if(_)return _}return i?ft(i):null},Zn=i=>{const r=(i==null?void 0:i.account)||"Unknown";return r&&r!=="Unknown"?r:(i==null?void 0:i.name)||"Unknown"||null},ei=i=>{if(!i||i.length===0)return 0;let r=0,u=null;return i.forEach(M=>{const R=Number(M[1]??0);if(Number.isFinite(R)){if(u===null){u=R;return}R>u&&(r+=R-u),u=R}}),r},ti=i=>{if(!i||i.length===0)return 0;let r=0;return i.forEach(u=>{const M=Number(u[0]??0),R=Number(u[1]??0);Number.isFinite(R)&&M!==0&&R>0&&(r+=1)}),r},ni=i=>{const{players:r,targets:u,skillMap:M,buffMap:R}=i,_=i.getPlayerKey||Zn,ge=Zt(R),J={},pe={};r.forEach($=>{if($!=null&&$.notInSquad)return;const V=_($);V&&(J[V]||(J[V]={}),$!=null&&$.totalDamageDist&&$.totalDamageDist.forEach(be=>{be&&be.forEach(U=>{if(!U.id)return;let ie=`Skill ${U.id}`,oe;M&&(M[`s${U.id}`]?(ie=M[`s${U.id}`].name||ie,oe=M[`s${U.id}`].icon||oe):M[`${U.id}`]&&(ie=M[`${U.id}`].name||ie,oe=M[`${U.id}`].icon||oe));const se=Nt(ie,U.id,R);if(!se)return;const De=R==null?void 0:R[`b${U.id}`],Re=De==null?void 0:De.name,le=ge.get(se)||(De==null?void 0:De.icon),Le=ie.startsWith("Skill ")?Re||se:ie,Be=oe||(De==null?void 0:De.icon),Ae=Number(U.connectedHits??0),_e=Number(U.hits??0),Ne=Ae>0?Ae:_e,Me=Number(U.totalDamage??0);if(!Number.isFinite(Ne)&&!Number.isFinite(Me))return;const qe=pe[se]||{name:se,icon:le,applications:0,damage:0};qe.applications+=Number.isFinite(Ne)?Ne:0,qe.damage+=Number.isFinite(Me)?Me:0,!qe.icon&&le&&(qe.icon=le),pe[se]=qe;const Ie=J[V][se]||{icon:le,applications:0,damage:0,skills:{}};Ie.applications+=Number.isFinite(Ne)?Ne:0,Ie.damage+=Number.isFinite(Me)?Me:0;const $e=Ie.skills[Le]||{name:Le,hits:0,damage:0,icon:Be};$e.hits+=Number.isFinite(Ne)?Ne:0,$e.damage+=Number.isFinite(Me)?Me:0,!$e.icon&&Be&&($e.icon=Be),Ie.skills[Le]=$e,!Ie.icon&&le&&(Ie.icon=le),J[V][se]=Ie})}))});const Oe=new Map;r.forEach($=>{if($!=null&&$.notInSquad)return;const V=_($);V&&$!=null&&$.name&&Oe.set($.name,V)});let Ve=0,Se=0,ke=0;return u.forEach($=>{$!=null&&$.buffs&&$.buffs.forEach(V=>{const be=Number(V==null?void 0:V.id);if(!Number.isFinite(be))return;const U=R==null?void 0:R[`b${be}`],ie=ft(U==null?void 0:U.name);if(!ie||U!=null&&U.classification&&U.classification!=="Condition")return;const oe=ie;if(!oe)return;const se=V.statesPerSource||{};ke+=1,Object.entries(se).forEach(([De,Re])=>{var Ne;const le=Oe.get(De);if(!le)return;Se+=1;const Le=ei(Re),Be=ti(Re);Ve+=Le;const Ae=((Ne=J[le])==null?void 0:Ne[oe])||{applications:0,damage:0,skills:{}};Ae.applicationsFromBuffs=(Ae.applicationsFromBuffs||0)+Le,Ae.applicationsFromBuffsActive=(Ae.applicationsFromBuffsActive||0)+Be,J[le]=J[le]||{},J[le][oe]=Ae;const _e=pe[oe]||{name:oe,applications:0,damage:0};_e.applicationsFromBuffs=(_e.applicationsFromBuffs||0)+Le,_e.applicationsFromBuffsActive=(_e.applicationsFromBuffsActive||0)+Be,pe[oe]=_e})})}),Object.values(J).forEach($=>{Object.values($).forEach(V=>{typeof V.applicationsFromBuffs=="number"&&(V.applications=V.applicationsFromBuffs)})}),Object.values(pe).forEach($=>{typeof $.applicationsFromBuffs=="number"&&($.applications=$.applicationsFromBuffs)}),{playerConditions:J,summary:pe,meta:{buffStateApplicationsTotal:Ve,targetBuffEntriesSeen:ke,buffStateSourcesSeen:Se}}},ii=new Set(["Vulnerability","Weakness","Blind","Cripple","Chill","Immobilize","Slow","Fear","Taunt"]),oi=[{id:"damage",label:"Damage",field:"damage",source:"dpsAll"},{id:"directDmg",label:"Direct Damage",field:"directDmg",source:"statsTargets"},{id:"connectedDamageCount",label:"Connected Damage Count",field:"connectedDamageCount",source:"statsTargets"},{id:"connectedDirectDamageCount",label:"Connected Direct Damage Count",field:"connectedDirectDamageCount",source:"statsTargets"},{id:"battleStandardHits",label:"Battle Standard Tracking"},{id:"criticalRate",label:"Critical Rate",field:"criticalRate",isRate:!0,isPercent:!0,denomField:"critableDirectDamageCount",source:"statsTargets"},{id:"criticalDmg",label:"Critical Damage",field:"criticalDmg",source:"statsTargets"},{id:"flankingRate",label:"Flanking Rate",field:"flankingRate",isRate:!0,isPercent:!0,denomField:"connectedDirectDamageCount",source:"statsTargets"},{id:"glanceRate",label:"Glance Rate",field:"glanceRate",isRate:!0,isPercent:!0,denomField:"connectedDirectDamageCount",source:"statsTargets"},{id:"missed",label:"Missed",field:"missed",source:"statsTargets"},{id:"evaded",label:"Evaded (enemy)",field:"evaded",source:"statsTargets"},{id:"blocked",label:"Blocked (enemy)",field:"blocked",source:"statsTargets"},{id:"interrupts",label:"Interrupts",field:"interrupts",source:"statsTargets"},{id:"invulned",label:"Invulned",field:"invulned",source:"statsTargets"},{id:"killed",label:"Killed",field:"killed",source:"statsTargets"},{id:"downed",label:"Downed",field:"downed",source:"statsTargets"},{id:"downContribution",label:"Down Contribution",field:"downContribution",source:"statsTargets"},{id:"downContributionPercent",label:"Down Contribution %",isRate:!0,isPercent:!0},{id:"againstDownedDamage",label:"Against Downed Damage",field:"againstDownedDamage",source:"statsTargets"},{id:"appliedCrowdControl",label:"Applied CC",field:"appliedCrowdControl",source:"statsTargets"},{id:"appliedCrowdControlDuration",label:"Applied CC Duration",field:"appliedCrowdControlDuration",source:"statsTargets"},{id:"appliedCrowdControlDownContribution",label:"Applied CC Down Contribution",field:"appliedCrowdControlDownContribution",source:"statsTargets"},{id:"appliedCrowdControlDurationDownContribution",label:"Applied CC Duration Down Contribution",field:"appliedCrowdControlDurationDownContribution",source:"statsTargets"},{id:"boonStrips",label:"Boon Strips",field:"boonStrips",source:"support"}],si=[{id:"damageTaken",label:"Damage Taken",field:"damageTaken"},{id:"damageTakenCount",label:"Damage Taken Count",field:"damageTakenCount"},{id:"conditionDamageTaken",label:"Condition Damage Taken",field:"conditionDamageTaken"},{id:"conditionDamageTakenCount",label:"Condition Damage Taken Count",field:"conditionDamageTakenCount"},{id:"powerDamageTaken",label:"Power Damage Taken",field:"powerDamageTaken"},{id:"powerDamageTakenCount",label:"Power Damage Taken Count",field:"powerDamageTakenCount"},{id:"downedDamageTaken",label:"Downed Damage Taken",field:"downedDamageTaken"},{id:"downedDamageTakenCount",label:"Downed Damage Taken Count",field:"downedDamageTakenCount"},{id:"damageBarrier",label:"Damage Barrier",field:"damageBarrier"},{id:"damageBarrierCount",label:"Damage Barrier Count",field:"damageBarrierCount"},{id:"blockedCount",label:"Blocked Count",field:"blockedCount"},{id:"evadedCount",label:"Evaded Count",field:"evadedCount"},{id:"missedCount",label:"Missed Count",field:"missedCount"},{id:"dodgeCount",label:"Dodge Count",field:"dodgeCount"},{id:"invulnedCount",label:"Invulnerable Count",field:"invulnedCount"},{id:"interruptedCount",label:"Interrupted Count",field:"interruptedCount"},{id:"downCount",label:"Down Count",field:"downCount"},{id:"deadCount",label:"Death Count",field:"deadCount"},{id:"boonStrips",label:"Boon Strips (Incoming)",field:"boonStrips"},{id:"conditionCleanses",label:"Cleanses (Incoming)",field:"conditionCleanses"},{id:"receivedCrowdControl",label:"Crowd Control (Incoming)",field:"receivedCrowdControl"}],ai=[{id:"condiCleanse",label:"Condition Cleanses",field:"condiCleanse"},{id:"condiCleanseTime",label:"Condition Cleanse Time",field:"condiCleanseTime",isTime:!0},{id:"condiCleanseSelf",label:"Condition Cleanse Self",field:"condiCleanseSelf"},{id:"condiCleanseTimeSelf",label:"Condition Cleanse Time Self",field:"condiCleanseTimeSelf",isTime:!0},{id:"boonStrips",label:"Boon Strips",field:"boonStrips"},{id:"boonStripsTime",label:"Boon Strips Time",field:"boonStripsTime",isTime:!0},{id:"boonStripDownContribution",label:"Boon Strip Down Contribution",field:"boonStripDownContribution"},{id:"boonStripDownContributionTime",label:"Boon Strip Down Contribution Time",field:"boonStripDownContributionTime",isTime:!0},{id:"stunBreak",label:"Stun Breaks",field:"stunBreak"},{id:"removedStunDuration",label:"Removed Stun Duration",field:"removedStunDuration",isTime:!0},{id:"resurrects",label:"Resurrects",field:"resurrects"},{id:"resurrectTime",label:"Resurrect Time",field:"resurrectTime",isTime:!0}],ri=["battle standard","glyph of renewal","glyph of the stars","illusion of life","spirit of nature","nature spirit","search and rescue","signet of mercy"],ci=new Set([10244]),li=(i,r)=>{var R;if(ci.has(i))return!0;const u=(r==null?void 0:r[`s${i}`])||(r==null?void 0:r[`${i}`]),M=((R=u==null?void 0:u.name)==null?void 0:R.toLowerCase())||"";return ri.some(_=>M.includes(_))},ui=i=>{if(!i||!Number.isFinite(i))return"--:--";const r=Math.max(0,Math.round(i/1e3)),u=Math.floor(r/3600),M=Math.floor(r%3600/60),R=r%60;return u>0?`${u}:${String(M).padStart(2,"0")}:${String(R).padStart(2,"0")}`:`${M}:${String(R).padStart(2,"0")}`},Tt={Guardian:"#72C1D9",Dragonhunter:"#72C1D9",Firebrand:"#72C1D9",Willbender:"#72C1D9",Revenant:"#D16E5A",Herald:"#D16E5A",Renegade:"#D16E5A",Vindicator:"#D16E5A",Warrior:"#FFD166",Berserker:"#FFD166",Spellbreaker:"#FFD166",Bladesworn:"#FFD166",Engineer:"#D09C59",Scrapper:"#D09C59",Holosmith:"#D09C59",Mechanist:"#D09C59",Ranger:"#8CDC82",Druid:"#8CDC82",Soulbeast:"#8CDC82",Untamed:"#8CDC82",Thief:"#C08F95",Daredevil:"#C08F95",Deadeye:"#C08F95",Specter:"#C08F95",Elementalist:"#F68A87",Tempest:"#F68A87",Weaver:"#F68A87",Catalyst:"#F68A87",Mesmer:"#B679D5",Chronomancer:"#B679D5",Mirage:"#B679D5",Virtuoso:"#B679D5",Necromancer:"#52A76F",Reaper:"#52A76F",Scourge:"#52A76F",Harbinger:"#52A76F",Ritualist:"#52A76F",Luminary:"#72C1D9",Conduit:"#D16E5A",Paragon:"#FFD166",Amalgam:"#D09C59",Galeshot:"#8CDC82",Antiquary:"#C08F95",Evoker:"#F68A87",Troubadour:"#B679D5",Unknown:"#64748B"};function en(i){return Tt[i]||Tt.Unknown}const mi=i=>{if(i==null||i==="")return 0;if(typeof i=="number")return!Number.isFinite(i)||i<=0?0:i>1e12?i:i*1e3;if(i instanceof Date){const ge=i.getTime();return Number.isFinite(ge)&&ge>0?ge:0}const r=String(i).trim();if(!r)return 0;const u=Number(r);if(Number.isFinite(u)&&u>0)return u>1e12?u:u*1e3;const M=Date.parse(r);if(Number.isFinite(M)&&M>0)return M;const R=r.replace(/([+-]\d{2})$/,"$1:00"),_=Date.parse(R);return Number.isFinite(_)&&_>0?_:0},Je=(i,r)=>mi((i==null?void 0:i.uploadTime)??(r==null?void 0:r.uploadTime)??(i==null?void 0:i.timeStartStd)??(i==null?void 0:i.timeStart)??(i==null?void 0:i.timeEndStd)??(i==null?void 0:i.timeEnd)??(i==null?void 0:i.timeStartText)??(i==null?void 0:i.timeEndText)),di=({logs:i,precomputedStats:r,mvpWeights:u,statsViewSettings:M,disruptionMethod:R})=>{const _=(()=>{const Se=i.filter(ke=>ke.details&&ke.details.players&&ke.details.players.length>0);return console.log("[useStatsAggregation] Filtering logs:",{total:i.length,passed:Se.length,statuses:i.map(ke=>ke.status),hasDetails:i.map(ke=>!!ke.details)}),Se})(),ge=M||Jn,J=u||Yn,pe=Se=>{if(!Se||typeof Se!="object")return Se;const ke=Array.isArray(Se.fightBreakdown)?Se.fightBreakdown:null;if(!ke||ke.length===0)return Se;const $=new Map,V=new Map;i.forEach(U=>{var se;const ie=(U==null?void 0:U.filePath)||(U==null?void 0:U.id);ie&&$.set(String(ie),U);const oe=(U==null?void 0:U.permalink)||((se=U==null?void 0:U.details)==null?void 0:se.permalink);typeof oe=="string"&&oe.trim()&&V.set(oe.trim(),U)});const be=ke.map(U=>{if(!U||typeof U!="object"||Number(U.timestamp)>0)return U;const oe=U.id?String(U.id):"",se=typeof U.permalink=="string"?U.permalink.trim():"",De=(oe?$.get(oe):void 0)||(se?V.get(se):void 0);if(!De)return U;const Re=Je(De==null?void 0:De.details,De);return Re?{...U,timestamp:Re}:U});return{...Se,fightBreakdown:be}},Oe=(()=>{if(r)return pe(r);const Se=R||Gn,ke=ge.topSkillDamageSource||"target",$=ge.topSkillsMetric||"damage",V=_.length;let be=0,U=0,ie=0,oe=0,se=0,De=0,Re=0,le=0;const Le=e=>{const n=((e==null?void 0:e.players)||[]).filter(z=>!z.notInSquad);let m=0,a=0,D=0,N=0;return n.forEach(z=>{var ee;const E=(ee=z.defenses)==null?void 0:ee[0];if(!E)return;const Y=Number(E.downCount||0),ue=Number(E.deadCount||0);m+=Y+ue,D+=ue}),n.forEach(z=>{!z.statsTargets||z.statsTargets.length===0||z.statsTargets.forEach(E=>{const Y=E==null?void 0:E[0];if(!Y)return;const ue=Number(Y.downed||0),ee=Number(Y.killed||0);a+=ue+ee,N+=ee})}),{squadDownsDeaths:m,enemyDownsDeaths:a,squadDeaths:D,enemyDeaths:N}},Be=e=>{const{squadDownsDeaths:t,enemyDownsDeaths:n}=Le(e);return t>0||n>0?n>t:typeof(e==null?void 0:e.success)=="boolean"?e.success:!1},Ae=new Map,_e=new Set(["boonStripsTime","condiCleanseTime","condiCleanseTimeSelf"]),Ne={},Me={},qe=new Map,Ie={},$e={},Fe={},Ze=new Map,Qe=new Map,At=new Set(Object.keys(Tt)),Mt=Object.keys(Tt).filter(e=>e&&e!=="Unknown").sort((e,t)=>t.length-e.length),wt=["Guardian","Revenant","Warrior","Engineer","Ranger","Thief","Elementalist","Mesmer","Necromancer"],st=e=>{if(!e)return"Unknown";const t=String(e).replace(/\s*\([^)]*\)\s*$/,"").replace(/\s*\[[^\]]*\]\s*$/,"").replace(/\s\d+$/,"").trim();if(At.has(t))return t;const n=t.toLowerCase();for(const a of Mt)if(n.includes(a.toLowerCase()))return a;return wt.find(a=>n.includes(a.toLowerCase()))||t||"Unknown"},gi=e=>e!=null&&e.classification?e.classification==="Boon":!0,vt=new Map,Et=new Map,gt=()=>({totalHits:0,blocked:0,evaded:0,glanced:0,missed:0,invulned:0,interrupted:0,totalMitigation:0,minMitigation:0}),te=e=>{const t=Number(e);return Number.isFinite(t)?t:0},rn=e=>{const t=String(e).split("|"),n=t[0]||"Unknown",m=st(t[1]||"Unknown"),a=t[2]||n||"Unknown";return{name:n,profession:m,account:a}},cn=(e,t,n)=>{let m=e.get(t);return m?n.profession&&!m.professionList.includes(n.profession)&&m.professionList.push(n.profession):(m={account:n.account,name:n.name,profession:n.profession,professionList:n.profession?[n.profession]:[],activeMs:0,mitigationTotals:gt()},e.set(t,m)),m},ln=(e,t,n)=>{let m=e.get(t);return m?n.profession&&!m.professionList.includes(n.profession)&&m.professionList.push(n.profession):(m={account:n.account,name:n.name,profession:n.profession,professionList:n.profession?[n.profession]:[],activeMs:0,mitigationTotals:gt(),minion:n.minion},e.set(t,m)),m},un=(e,t)=>{e.totalHits+=te((t==null?void 0:t.skill_hits)??(t==null?void 0:t.skillHits)),e.blocked+=te(t==null?void 0:t.blocked),e.evaded+=te(t==null?void 0:t.evaded),e.glanced+=te(t==null?void 0:t.glanced),e.missed+=te(t==null?void 0:t.missed),e.invulned+=te(t==null?void 0:t.invulned),e.interrupted+=te(t==null?void 0:t.interrupted),e.totalMitigation+=te((t==null?void 0:t.avoided_damage)??(t==null?void 0:t.avoidedDamage)),e.minMitigation+=te((t==null?void 0:t.min_avoided_damage)??(t==null?void 0:t.minAvoidedDamage))},pi=e=>Object.values(e).some(t=>t>0);console.log("[useStatsAggregation] Starting aggregation loop",{validLogsCount:_.length});const Ft=(e,t,n)=>{var D,N,z,E;const m=`s${e}`;if((D=t==null?void 0:t[m])!=null&&D.name)return t[m].name;if((N=t==null?void 0:t[String(e)])!=null&&N.name)return t[String(e)].name;const a=`b${e}`;return(z=n==null?void 0:n[a])!=null&&z.name?n[a].name:(E=n==null?void 0:n[String(e)])!=null&&E.name?n[String(e)].name:`Unknown Skill ${e}`},pt=new Map,at=e=>{const t=pt.get(e);if(!t)return{hasSkill:!1,avg:1,min:1,hits:0};const n=t.connectedHits||0,m=n>0?t.totalDamage/n:0,a=t.minCount>0?t.minTotal/t.minCount:0;return{hasSkill:!0,avg:m,min:a,hits:n}},Bt="Ashtonlightstone.9145",mn="Illusionary Warden",Ot=[],rt=[],Rt=[],_t=[],dn=new Map,fn=new Map,gn=(e,t,n)=>{const m=e.get(t)||gt();return m.totalHits+=n.totalHits,m.blocked+=n.blocked,m.evaded+=n.evaded,m.glanced+=n.glanced,m.missed+=n.missed,m.invulned+=n.invulned,m.interrupted+=n.interrupted,e.set(t,m),m};_.forEach(e=>{const t=e.details;if(!t)return;(t.targets||[]).forEach(m=>{const a=(m==null?void 0:m.totalDamageDist)||[],D=Array.isArray(a)?a[0]:null;D==null||D.forEach(N=>{if(!(N!=null&&N.id))return;const z=Number(N.id),E=pt.get(z)||{totalDamage:0,connectedHits:0,minTotal:0,minCount:0};E.totalDamage+=Number(N.totalDamage||0),E.connectedHits+=Number(N.connectedHits||0);const Y=Number.isFinite(Number(N.min))?Number(N.min):0;E.minTotal+=Y,E.minCount+=1,pt.set(z,E)})})}),_.forEach((e,t)=>{var Pe,je;const n=e.details;if(!n)return;const m=n.players;console.log(`[useStatsAggregation] Processing log ${t}:`,{playerCount:m==null?void 0:m.length,hasTargets:!!n.targets,firstPlayer:m!=null&&m[0]?{account:m[0].account,notInSquad:m[0].notInSquad}:"none"});const a=n.targets||[],D=n.skillMap||{},N=n.buffMap||{},z=new Map,E=new Map;a.forEach(o=>{const h=(o==null?void 0:o.totalDamageDist)||[],c=Array.isArray(h)?h[0]:null;c==null||c.forEach(k=>{var ae;if(!(k!=null&&k.id))return;const v=Number(k.id),d=((ae=D==null?void 0:D[v])==null?void 0:ae.name)||k.name||k.skillName||String(v),P=z.get(v)||{totalDamage:0,connectedHits:0,minTotal:0,minCount:0};P.totalDamage+=Number(k.totalDamage||0),P.connectedHits+=Number(k.connectedHits||0);const B=Number.isFinite(Number(k.min))?Number(k.min):0;P.minTotal+=B,P.minCount+=1,z.set(v,P);const j=E.get(d)||{totalDamage:0,connectedHits:0,minTotal:0,minCount:0};j.totalDamage+=Number(k.totalDamage||0),j.connectedHits+=Number(k.connectedHits||0);const ce=Number.isFinite(Number(k.min))?Number(k.min):0;j.minTotal+=ce,j.minCount+=1,E.set(d,j)})});const Y=o=>{const h=z.get(o);if(!h||h.connectedHits<=0)return{avg:1,min:1};const c=h.connectedHits>0?h.totalDamage/h.connectedHits:0,k=h.minCount>0?h.minTotal/h.minCount:c;return{avg:c||1,min:k||1}},ue=o=>{const h=E.get(o);if(!h||h.connectedHits<=0)return{avg:1,min:1};const c=h.connectedHits>0?h.totalDamage/h.connectedHits:0,k=h.minCount>0?h.minTotal/h.minCount:c;return{avg:c||1,min:k||1}},ee=n.combatReplayMetaData||{},F=(ee==null?void 0:ee.inchToPixel)>0?ee.inchToPixel:1,x=(ee==null?void 0:ee.pollingRate)>0?ee.pollingRate:1,O=5e3,G=o=>Array.isArray(o)?o.map(h=>Array.isArray(h)?[Number(h[0]),Number(h[1])]:null).filter(h=>!!h&&Number.isFinite(h[0])):[];let me=[],l=n.durationMS||0,g=!1;const b=m.find(o=>(o==null?void 0:o.hasCommanderTag)&&!(o!=null&&o.notInSquad));(Pe=b==null?void 0:b.combatReplayData)!=null&&Pe.positions&&(me=b.combatReplayData.positions,G(b.combatReplayData.dead).forEach(([h])=>{h>0&&(g=!0,l=Math.min(l,h))}));const T=o=>{var j;const h=(j=o.statsAll)==null?void 0:j[0];if((h==null?void 0:h.distToCom)!==void 0&&(h==null?void 0:h.distToCom)!=="Infinity")return Math.round(Number(h.distToCom));if((h==null?void 0:h.stackDist)!==void 0)return Math.round(Number(h.stackDist))||0;if(o.hasCommanderTag)return 0;const c=o.combatReplayData;if(!(c!=null&&c.positions)||!me.length)return 0;const k=c.positions,v=G(c.dead),d=G(c.down),P=Math.floor((c.start||0)/x);let B=0;if(v.length&&d.length)for(const[ce]of v){if(ce<0)continue;const ae=Math.max(0,Math.floor(ce/x))-P;for(const[H,W]of d){if(ce!==W)continue;const y=g&&H>l?Math.max(1,Math.floor(l/x)):ae,X=Math.max(0,Math.min(y,k.length,me.length));if(X<=0)continue;let ne=0;for(let Te=0;Te<X;Te++){const[Q,Ce]=k[Te],[he,fe]=me[Te];ne+=Math.hypot(Q-he,Ce-fe)}B=Math.round(ne/X/F)}}return B},w=m.filter(o=>!o.notInSquad);ie+=w.length,oe+=a.filter(o=>!o.isFake).length,yn(m,{durationMS:n.durationMS,buffMap:n.buffMap});const{squadDeaths:I,enemyDeaths:s}=Le(n);se+=I,De+=s,le+=I,Re+=s,Be(n)?be++:U++;const p=n.skillMap?Number((je=Object.keys(n.skillMap).find(o=>{var h,c;return((c=(h=n.skillMap)==null?void 0:h[o])==null?void 0:c.name)==="Battle Standard"}))==null?void 0:je.replace(/^s/,"")):null;m.forEach((o,h)=>{var et,tt,ct,lt,Ht,bt,ht,Dn,Nn,Tn,An,Mn;if(o.notInSquad)return;const c=o.account||"Unknown",k=c!=="Unknown"?c:o.name||"Unknown",v=o.name||"Unknown";Ae.has(k)||Ae.set(k,{name:v,account:k,downContrib:0,cleanses:0,strips:0,stab:0,healing:0,barrier:0,cc:0,logsJoined:0,totalDist:0,distCount:0,dodges:0,downs:0,deaths:0,totalFightMs:0,offenseTotals:{},offenseRateWeights:{},defenseActiveMs:0,defenseTotals:{},supportActiveMs:0,supportTotals:{},healingActiveMs:0,healingTotals:{},profession:o.profession||"Unknown",professions:new Set,professionTimeMs:{},isCommander:!1,damage:0,dps:0,revives:0,outgoingConditions:{},incomingConditions:{}});const d=Ae.get(k);if(o.hasCommanderTag&&(d.isCommander=!0),o.profession&&o.profession!=="Unknown"){d.profession=o.profession,d.professions.add(o.profession);const f=Array.isArray(o.activeTimes)&&typeof o.activeTimes[0]=="number"?o.activeTimes[0]:n.durationMS||0;d.professionTimeMs[o.profession]=(d.professionTimeMs[o.profession]||0)+f}d.logsJoined++,d.downContrib+=Wn(o),d.cleanses+=qn(o),d.strips+=jn(o,Se),d.healing+=Vn(o),d.barrier+=zn(o),d.cc+=Kn(o,Se),d.stab+=o.stabGeneration||0;const P=T(o);P<=O&&(d.totalDist+=P,d.distCount++),(et=o.defenses)!=null&&et[0]&&(d.dodges+=o.defenses[0].dodgeCount||0,d.downs+=o.defenses[0].downCount||0,d.deaths+=o.defenses[0].deadCount||0),n.durationMS&&(d.totalFightMs+=n.durationMS);const B=Array.isArray(o.activeTimes)&&typeof o.activeTimes[0]=="number"?o.activeTimes[0]:n.durationMS||0;d.defenseActiveMs+=B,d.supportActiveMs+=B,d.healingActiveMs+=B,Array.isArray(o.buffUptimes)&&o.buffUptimes.length>0&&o.buffUptimes.forEach(f=>{var wn,vn,En,Fn;if(typeof(f==null?void 0:f.id)!="number")return;const S=`b${f.id}`,A=((wn=n.buffMap)==null?void 0:wn[S])||((vn=n.buffMap)==null?void 0:vn[String(f.id)]);if(!A||gi(A))return;const Z=Number(((Fn=(En=f.buffData)==null?void 0:En[0])==null?void 0:Fn.uptime)??0);if(!Number.isFinite(Z)||Z<=0)return;const He=(A==null?void 0:A.stacking)??!1,Ke=(He?Z:Z/100)*B;if(!Number.isFinite(Ke)||Ke<=0)return;const xe=Xn(A==null?void 0:A.name);if(xe&&ii.has(xe)&&(!(A!=null&&A.classification)||A.classification==="Condition")){const Ut=Ke/1e3,ye=A==null?void 0:A.icon,kt=Ie[xe]||{name:xe,icon:ye,applications:0,damage:0};kt.applicationsFromUptime=(kt.applicationsFromUptime||0)+Ut,!kt.icon&&ye&&(kt.icon=ye),Ie[xe]=kt;const Ct=d.outgoingConditions[xe]||{applications:0,damage:0,skills:{},icon:ye};Ct.applicationsFromUptime=(Ct.applicationsFromUptime||0)+Ut,!Ct.icon&&ye&&(Ct.icon=ye),d.outgoingConditions[xe]=Ct;const St=$e[xe]||{name:xe,icon:ye,applications:0,damage:0};St.applicationsFromUptime=(St.applicationsFromUptime||0)+Ut,!St.icon&&ye&&(St.icon=ye),$e[xe]=St;const Dt=d.incomingConditions[xe]||{applications:0,damage:0,skills:{},icon:ye};Dt.applicationsFromUptime=(Dt.applicationsFromUptime||0)+Ut,!Dt.icon&&ye&&(Dt.icon=ye),d.incomingConditions[xe]=Dt}Ze.has(S)||Ze.set(S,{name:A==null?void 0:A.name,stacking:He,icon:A==null?void 0:A.icon}),Qe.has(S)||Qe.set(S,new Map);const ot=Qe.get(S),mt=d.account||o.account||o.name||"Unknown";let it=ot.get(mt);it||(it={account:mt,profession:d.profession||o.profession||"Unknown",professions:new Set,professionTimeMs:{},totalMs:0,durationMs:0},ot.set(mt,it));const dt=o.profession||d.profession;dt&&dt!=="Unknown"&&(it.professions.add(dt),it.professionTimeMs[dt]=(it.professionTimeMs[dt]||0)+B,it.profession=dt),it.totalMs+=Ke,it.durationMs+=B}),(tt=o.defenses)!=null&&tt[0]&&si.forEach(f=>{const S=Number(o.defenses[0][f.field]??0);Number.isFinite(S)&&(d.defenseTotals[f.id]=(d.defenseTotals[f.id]||0)+S)}),(ct=o.support)!=null&&ct[0]&&ai.forEach(f=>{let S=Number(o.support[0][f.field]??0);Number.isFinite(S)&&(_e.has(f.field)&&S>999999&&(S=0),d.supportTotals[f.id]=(d.supportTotals[f.id]||0)+S)});const j=(f,S)=>{Number.isFinite(S)&&(d.healingTotals[f]=(d.healingTotals[f]||0)+S)},ce=(f,S)=>Array.isArray(f)?f.reduce((A,Z)=>A+Number((Z==null?void 0:Z[S])??0),0):0,ae=(f,S,A)=>{if(!Number.isFinite(A)||A<=0)return;const Z=m[S],He=S===h,nt=Z==null?void 0:Z.notInSquad,Ke=!nt,xe=Ke&&(Z==null?void 0:Z.group)!=null&&Z.group===o.group;j(f,A),Ke&&j(`squad${f[0].toUpperCase()}${f.slice(1)}`,A),xe&&j(`group${f[0].toUpperCase()}${f.slice(1)}`,A),He&&j(`self${f[0].toUpperCase()}${f.slice(1)}`,A),nt&&j(`offSquad${f[0].toUpperCase()}${f.slice(1)}`,A)};if(Array.isArray(o.rotation)){let f=0;o.rotation.forEach(S=>{var Z;if(!(S!=null&&S.id)||!li(S.id,n.skillMap))return;const A=((Z=S.skills)==null?void 0:Z.length)||0;A>0&&(f+=A,j(`resUtility_s${S.id}`,A))}),f>0&&j("resUtility",f)}const H=(lt=o.extHealingStats)==null?void 0:lt.outgoingHealingAllies;Array.isArray(H)&&H.forEach((f,S)=>{const A=ce(f,"healing"),Z=ce(f,"downedHealing");ae("healing",S,A),ae("downedHealing",S,Z)});const W=(Ht=o.extBarrierStats)==null?void 0:Ht.outgoingBarrierAllies;Array.isArray(W)&&W.forEach((f,S)=>{const A=ce(f,"barrier");ae("barrier",S,A)});const y=(bt=o.statsAll)==null?void 0:bt[0],X=(ht=o.dpsAll)==null?void 0:ht[0],ne=(Dn=o.support)==null?void 0:Dn[0];if(oi.forEach(f=>{if(f.id==="downContributionPercent"||!f.field)return;let S=0,A=0;f.source==="dpsAll"&&X?S=Number(X[f.field]??0):f.source==="statsAll"&&y?(S=Number(y[f.field]??0),A=Number(y[f.denomField||f.weightField||"connectedDamageCount"]??0)):f.source==="support"&&ne?S=Number(ne[f.field]??0):o.statsTargets&&o.statsTargets.forEach(Z=>{Z!=null&&Z[0]&&(S+=Number(Z[0][f.field]??0),A+=Number(Z[0][f.denomField||f.weightField||"connectedDamageCount"]??0))}),Number.isFinite(S)&&(d.offenseTotals[f.id]=(d.offenseTotals[f.id]||0)+S,f.isRate&&A>0&&(d.offenseRateWeights[f.id]=(d.offenseRateWeights[f.id]||0)+A))}),o.targetDamageDist&&Number.isFinite(p)){const f=o.targetDamageDist.flatMap(S=>S||[]).flatMap(S=>S||[]).reduce((S,A)=>A!=null&&A.id&&A.id===p?S+((A==null?void 0:A.connectedHits)||0):S,0);d.offenseTotals.battleStandardHits=(d.offenseTotals.battleStandardHits||0)+f}d.revives+=((Tn=(Nn=o.support)==null?void 0:Nn[0])==null?void 0:Tn.resurrects)||0,X&&(d.damage+=X.damage||0,d.dps+=X.dps||0);const Te=f=>{var He,nt,Ke,xe;let S=`Skill ${f.id}`;const A=((He=n.skillMap)==null?void 0:He[`s${f.id}`])||((nt=n.skillMap)==null?void 0:nt[`${f.id}`]);let Z=A==null?void 0:A.icon;if(A!=null&&A.name&&(S=A.name),S.startsWith("Skill ")){const ot=Nt(S,f.id,n.buffMap);ot&&(S=ot,Z=((xe=(Ke=n.buffMap)==null?void 0:Ke[`b${f.id}`])==null?void 0:xe.icon)||Z)}return{name:S,icon:Z}},Q=f=>{if(!(f!=null&&f.id))return;const{name:S,icon:A}=Te(f);Ne[f.id]||(Ne[f.id]={name:S,icon:A,damage:0,hits:0,downContribution:0}),Ne[f.id].name.startsWith("Skill ")&&!S.startsWith("Skill ")&&(Ne[f.id].name=S),!Ne[f.id].icon&&A&&(Ne[f.id].icon=A),Ne[f.id].damage+=f.totalDamage,Ne[f.id].hits+=f.connectedHits,Ne[f.id].downContribution+=Number(f.downContribution||0)},Ce=o.account||o.name||"Unknown",he=o.profession||"Unknown",fe=`${Ce}|${he}`;let we=qe.get(fe);we||(we={key:fe,account:Ce,displayName:Ce,profession:he,professionList:[he],totalFightMs:0,skills:new Map},qe.set(fe,we)),we.professionList.includes(he)||we.professionList.push(he),we.totalFightMs+=n.durationMS||0;const We=f=>{if(!(f!=null&&f.id))return;const{name:S,icon:A}=Te(f),Z=`s${f.id}`;let He=we.skills.get(Z);He||(He={id:Z,name:S,icon:A,damage:0,downContribution:0},we.skills.set(Z,He)),He.name.startsWith("Skill ")&&!S.startsWith("Skill ")&&(He.name=S),!He.icon&&A&&(He.icon=A),He.damage+=Number(f.totalDamage||0),He.downContribution+=Number(f.downContribution||0)};ke==="total"?(An=o.totalDamageDist)==null||An.forEach(f=>{f==null||f.forEach(S=>{Q(S),We(S)})}):(Mn=o.targetDamageDist)==null||Mn.forEach(f=>{f==null||f.forEach(S=>{S==null||S.forEach(A=>{Q(A),We(A)})})}),o.totalDamageTaken&&o.totalDamageTaken.forEach(f=>{f==null||f.forEach(S=>{var nt,Ke,xe,ot;if(!(S!=null&&S.id))return;let A=`Skill ${S.id}`;const Z=((nt=n.skillMap)==null?void 0:nt[`s${S.id}`])||((Ke=n.skillMap)==null?void 0:Ke[`${S.id}`]);let He=Z==null?void 0:Z.icon;if(Z!=null&&Z.name&&(A=Z.name),A.startsWith("Skill ")){const mt=Nt(A,S.id,n.buffMap);mt&&(A=mt,He=((ot=(xe=n.buffMap)==null?void 0:xe[`b${S.id}`])==null?void 0:ot.icon)||He)}Me[S.id]||(Me[S.id]={name:A,icon:He,damage:0,hits:0}),(!Me[S.id].name.startsWith("Skill ")||A.startsWith("Skill "))&&(Me[S.id].name=A),!Me[S.id].icon&&He&&(Me[S.id].icon=He),Me[S.id].damage+=S.totalDamage,Me[S.id].hits+=S.hits})})}),a.forEach(o=>{if(o!=null&&o.isFake)return;const h=st((o==null?void 0:o.profession)||(o==null?void 0:o.name)||(o==null?void 0:o.id));h&&(Fe[h]=(Fe[h]||0)+1)});const C=ni({players:m,targets:a,skillMap:n.skillMap,buffMap:n.buffMap,getPlayerKey:o=>o.account&&o.account!=="Unknown"?o.account:o.name||null}),q=Zt(n.buffMap);Object.entries(C.playerConditions).forEach(([o,h])=>{const c=Ae.get(o);c&&Object.entries(h).forEach(([k,v])=>{const d=c.outgoingConditions[k]||{applications:0,damage:0,skills:{},icon:v.icon};d.applications+=Number(v.applications||0),d.damage+=Number(v.damage||0),v.applicationsFromBuffs&&(d.applicationsFromBuffs=(d.applicationsFromBuffs||0)+v.applicationsFromBuffs),v.applicationsFromBuffsActive&&(d.applicationsFromBuffsActive=(d.applicationsFromBuffsActive||0)+v.applicationsFromBuffsActive),Object.entries(v.skills||{}).forEach(([P,B])=>{const j=d.skills[P]||{name:B.name,hits:0,damage:0,icon:B.icon};j.hits+=Number(B.hits||0),j.damage+=Number(B.damage||0),!j.icon&&B.icon&&(j.icon=B.icon),d.skills[P]=j}),!d.icon&&v.icon&&(d.icon=v.icon),c.outgoingConditions[k]=d})}),Object.entries(C.summary).forEach(([o,h])=>{const c=Ie[o]||{name:h.name||o,icon:h.icon,applications:0,damage:0};c.applications+=Number(h.applications||0),c.damage+=Number(h.damage||0),h.applicationsFromBuffs&&(c.applicationsFromBuffs=(c.applicationsFromBuffs||0)+h.applicationsFromBuffs),h.applicationsFromBuffsActive&&(c.applicationsFromBuffsActive=(c.applicationsFromBuffsActive||0)+h.applicationsFromBuffsActive),!c.icon&&h.icon&&(c.icon=h.icon),Ie[o]=c}),w.forEach(o=>{const h=o.account&&o.account!=="Unknown"?o.account:o.name||"Unknown",c=Ae.get(h);!c||!o.totalDamageTaken||o.totalDamageTaken.forEach(k=>k==null?void 0:k.forEach(v=>{var Te,Q,Ce,he,fe,we;if(!(v!=null&&v.id))return;let d=`Skill ${v.id}`;const P=((Te=n.skillMap)==null?void 0:Te[`s${v.id}`])||((Q=n.skillMap)==null?void 0:Q[`${v.id}`]);P!=null&&P.name&&(d=P.name);const B=Nt(d,v.id,n.buffMap);if(!B)return;const j=(he=(Ce=n.buffMap)==null?void 0:Ce[`b${v.id}`])==null?void 0:he.name,ce=q.get(B)||((we=(fe=n.buffMap)==null?void 0:fe[`b${v.id}`])==null?void 0:we.icon),ae=(P==null?void 0:P.icon)||ce;d.startsWith("Skill ")&&(j||B)&&(d=j||B);const H=Number(v.hits??0),W=Number(v.totalDamage??0),y=$e[B]||{name:B,icon:ce,applications:0,damage:0};y.applications+=Number.isFinite(H)?H:0,y.damage+=Number.isFinite(W)?W:0,!y.icon&&ce&&(y.icon=ce),$e[B]=y;const X=c.incomingConditions[B]||{applications:0,damage:0,skills:{},icon:ce};X.applications+=Number.isFinite(H)?H:0,X.damage+=Number.isFinite(W)?W:0;const ne=X.skills[d]||{name:d,hits:0,damage:0,icon:ae};ne.hits+=Number.isFinite(H)?H:0,ne.damage+=Number.isFinite(W)?W:0,!ne.icon&&ae&&(ne.icon=ae),X.skills[d]=ne,!X.icon&&ce&&(X.icon=ce),c.incomingConditions[B]=X}))});const K=n.player_damage_mitigation||n.playerDamageMitigation,de=K&&typeof K=="object"&&Object.keys(K).length>0;de&&Object.entries(K).forEach(([o,h])=>{if(!h||typeof h!="object")return;const c=rn(o),k=cn(vt,c.account,c);Object.values(h).forEach(v=>{te((v==null?void 0:v.avoided_damage)??(v==null?void 0:v.avoidedDamage))<=0||un(k.mitigationTotals,v)})});const Ee=n.player_minion_damage_mitigation||n.playerMinionDamageMitigation,re=Ee&&typeof Ee=="object"&&Object.keys(Ee).length>0;re&&Object.entries(Ee).forEach(([o,h])=>{if(!h||typeof h!="object")return;const c=rn(o);Object.entries(h).forEach(([k,v])=>{if(!v||typeof v!="object")return;const d=`${c.account}::${k}`,P=ln(Et,d,{...c,minion:String(k||"Unknown")});Object.values(v).forEach(B=>{un(P.mitigationTotals,B)})})}),(!de||!re)&&(de||w.forEach(o=>{const h=(o==null?void 0:o.totalDamageTaken)||[];if(!Array.isArray(h)||h.length===0)return;const c=o.account||o.name||"Unknown",k={account:c,name:o.name||c,profession:st(o.profession||"Unknown")};cn(vt,c,k);const v=n.skillMap||{},d=n.buffMap||{},P=Array.isArray(h)?h[0]:null;if(P==null||P.forEach(B=>{if(!(B!=null&&B.id))return;const j=te(B.blocked),ce=te(B.evaded),ae=te(B.glance??B.glanced),H=te(B.missed),W=te(B.invulned),y=te(B.interrupted),X=te(B.hits??B.connectedHits),ne=Number(B.id),Te=Ft(ne,v,d);if(gn(dn,`${c}::${ne}`,{totalHits:X,blocked:j,evaded:ce,glanced:ae,missed:H,invulned:W,interrupted:y}),c===Bt){const Q=pt.get(ne),Ce=at(ne),he=Ce.hasSkill?Ce.hits>0?Ce.avg:0:1,fe=Ce.hasSkill?Ce.min||0:1,we=Ce.hits>0?ae*he/2+(j+ce+H+W+y)*he:0,We=Ce.hits>0?ae*fe/2+(j+ce+H+W+y)*fe:0;Rt.push({logId:e.filePath||e.id||t,skillId:B.id,skillName:Te,blocked:j,evaded:ce,glanced:ae,missed:H,invulned:W,interrupted:y,totalAvoids:j+ce+ae+H+W+y,avg:he,min:fe,enemyHits:(Q==null?void 0:Q.connectedHits)??0,enemyTotalDmg:(Q==null?void 0:Q.totalDamage)??0,avoidDmg:we,avoidMinDmg:We})}}),c===Bt){const B=(j,ce)=>{let ae=0,H=0,W=0;if(!Array.isArray(j))return{total:ae,minTotal:H,hits:W};for(const y of j){if(!(y!=null&&y.id))continue;const X=te(y.blocked),ne=te(y.evaded),Te=te(y.glance??y.glanced),Q=te(y.missed),Ce=te(y.invulned),he=te(y.interrupted),fe=Ft(Number(y.id),D,N),we=ce(Number(y.id),fe);(we.hits??0)>0&&(ae+=Te*we.avg/2+(X+ne+Q+Ce+he)*we.avg,H+=Te*we.min/2+(X+ne+Q+Ce+he)*we.min),W+=te(y.hits??y.connectedHits)}return{total:ae,minTotal:H,hits:W}};_t.push({logId:e.filePath||e.id||t,variant:"current_global_name_taken0",...B(P,(j,ce)=>{const ae=at(j),H=ae.hasSkill?ae.hits>0?ae.avg:0:1,W=ae.hasSkill?ae.min||0:1;return{avg:H,min:W,hits:ae.hits}})})}}),re||w.forEach(o=>{const h=(o==null?void 0:o.minions)||[];if(!Array.isArray(h)||h.length===0)return;const c=o.account||o.name||"Unknown",k={account:c,name:o.name||c,profession:st(o.profession||"Unknown")},v=n.skillMap||{},d=n.buffMap||{};h.forEach(P=>{const B=(P==null?void 0:P.totalDamageTakenDist)||[];if(!Array.isArray(B)||B.length===0)return;let j=String((P==null?void 0:P.name)||"Unknown").replace(/^Juvenile\s+/i,"")||"Unknown";j.toUpperCase().includes("UNKNOWN")&&(j="Unknown");const ce=`${c}::${j}`;ln(Et,ce,{...k,minion:j});const ae=Array.isArray(B)?B[0]:null;if(ae==null||ae.forEach(H=>{if(!(H!=null&&H.id))return;const W=te(H.blocked),y=te(H.evaded),X=te(H.glance??H.glanced),ne=te(H.missed),Te=te(H.invulned),Q=te(H.interrupted),Ce=te(H.hits??H.connectedHits),he=Number(H.id),fe=Ft(he,v,d);if(gn(fn,`${ce}::${he}`,{totalHits:Ce,blocked:W,evaded:y,glanced:X,missed:ne,invulned:Te,interrupted:Q}),c===Bt&&j===mn){const we=pt.get(he),We=at(he),et=We.hasSkill?We.hits>0?We.avg:0:1,tt=We.hasSkill?We.min||0:1,ct=We.hits>0?X*et/2+(W+y+ne+Te+Q)*et:0,lt=We.hits>0?X*tt/2+(W+y+ne+Te+Q)*tt:0;Ot.push({logId:e.filePath||e.id||t,skillId:H.id,skillName:fe,blocked:W,evaded:y,glanced:X,missed:ne,invulned:Te,interrupted:Q,totalAvoids:W+y+X+ne+Te+Q,avg:et,min:tt,enemyHits:(we==null?void 0:we.connectedHits)??0,enemyTotalDmg:(we==null?void 0:we.totalDamage)??0,avoidDmg:ct,avoidMinDmg:lt})}}),c===Bt&&j===mn){const H=(ne,Te)=>{let Q=0,Ce=0,he=0;if(!Array.isArray(ne))return{total:Q,minTotal:Ce,hits:he};for(const fe of ne){if(!(fe!=null&&fe.id))continue;const we=te(fe.blocked),We=te(fe.evaded),et=te(fe.glance??fe.glanced),tt=te(fe.missed),ct=te(fe.invulned),lt=te(fe.interrupted),Ht=Ft(Number(fe.id),D,N),{avg:bt,min:ht}=Te(Number(fe.id),Ht);te(fe.hits??fe.connectedHits)>0&&(Q+=et*bt/2+(we+We+tt+ct+lt)*bt,Ce+=et*ht/2+(we+We+tt+ct+lt)*ht),he+=te(fe.hits??fe.connectedHits)}return{total:Q,minTotal:Ce,hits:he}},W=Array.isArray(B)?B[0]||[]:[],y=Array.isArray(B)?B.flat():[],X=Array.isArray(P==null?void 0:P.totalDamageTaken)?P.totalDamageTaken[0]||[]:[];rt.push({logId:e.filePath||e.id||t,variant:"current_global_name_dist0",...H(W,(ne,Te)=>{const Q=at(ne),Ce=Q.hasSkill?Q.hits>0?Q.avg:0:1,he=Q.hasSkill&&Q.min||0;return{avg:Ce,min:he}})}),rt.push({logId:e.filePath||e.id||t,variant:"local_name_dist0",...H(W,(ne,Te)=>ue(Te))}),rt.push({logId:e.filePath||e.id||t,variant:"local_id_dist0",...H(W,ne=>Y(ne))}),rt.push({logId:e.filePath||e.id||t,variant:"global_name_alllists",...H(y,(ne,Te)=>{const Q=at(ne),Ce=Q.hasSkill?Q.hits>0?Q.avg:0:1,he=Q.hasSkill&&Q.min||0;return{avg:Ce,min:he}})}),rt.push({logId:e.filePath||e.id||t,variant:"global_name_taken0",...H(X,(ne,Te)=>{const Q=at(ne),Ce=Q.hasSkill?Q.hits>0?Q.avg:0:1,he=Q.hasSkill&&Q.min||0;return{avg:Ce,min:he}})})}})}))}),Ot.length>0&&(console.groupCollapsed("[Mitigation Debug] Ashtonlightstone.9145 / Illusionary Warden"),console.table(Ot),rt.length>0&&console.table(rt),console.groupEnd()),Rt.length>0&&(console.groupCollapsed("[Mitigation Debug] Ashtonlightstone.9145 / Player"),console.table(Rt),_t.length>0&&console.table(_t),console.groupEnd());const pn=(e,t)=>{const n=new Map,m=a=>{let D=n.get(a);return D||(D=gt(),n.set(a,D)),D};t.forEach((a,D)=>{const N=D.lastIndexOf("::"),z=N>-1?D.slice(0,N):D,E=N>-1?Number(D.slice(N+2)):Number.NaN,Y=Number.isFinite(E)?at(E):{hasSkill:!1,avg:0,min:0,hits:0};if(!Y.hasSkill||Y.hits<=0)return;const ue=Y.avg,ee=Y.min,F=a.glanced*ue/2+(a.blocked+a.evaded+a.missed+a.invulned+a.interrupted)*ue,x=a.glanced*ee/2+(a.blocked+a.evaded+a.missed+a.invulned+a.interrupted)*ee;if(F<=0)return;const O=m(z);O.totalHits+=a.totalHits,O.blocked+=a.blocked,O.evaded+=a.evaded,O.glanced+=a.glanced,O.missed+=a.missed,O.invulned+=a.invulned,O.interrupted+=a.interrupted,O.totalMitigation+=F,O.minMitigation+=x}),e.forEach((a,D)=>{const N=n.get(D)||gt();a.mitigationTotals.totalHits=N.totalHits,a.mitigationTotals.blocked=N.blocked,a.mitigationTotals.evaded=N.evaded,a.mitigationTotals.glanced=N.glanced,a.mitigationTotals.missed=N.missed,a.mitigationTotals.invulned=N.invulned,a.mitigationTotals.interrupted=N.interrupted,a.mitigationTotals.totalMitigation=N.totalMitigation,a.mitigationTotals.minMitigation=N.minMitigation})};pn(vt,dn),pn(Et,fn);const bi=V>0?Math.round(ie/V):0,hi=V>0?Math.round(oe/V):0,ki=se>0?(De/se).toFixed(2):De>0?"∞":"0.00",Ci=Re>0?(le/Re).toFixed(2):le>0?"∞":"0.00",bn=(e,t)=>{const m=e.filter(N=>Number.isFinite(N.value)&&(t?N.value>0:N.value>=0)).sort((N,z)=>{const E=t?z.value-N.value:N.value-z.value;return E!==0?E:N.account.localeCompare(z.account)});let a=null,D=0;return m.map((N,z)=>((a===null||N.value!==a)&&(D=z+1,a=N.value),{rank:D,...N}))},qt=Array.from(Ae.values()).map(e=>{const t=Array.from(e.professions).filter(n=>n!=="Unknown");if(e.professionList=t,t.length>0){let n=t[0],m=e.professionTimeMs[n]||0;t.forEach(a=>{const D=e.professionTimeMs[a]||0;D>m&&(m=D,n=a)}),e.profession=n}return{key:e.account,stat:e}}),hn=e=>{const t=Ae.get(e.account);if(!t){const a=e.professionList.length>0?e.professionList:e.profession?[e.profession]:[];return{...e,professionList:a}}const n=t.professionList&&t.professionList.length>0?t.professionList:Array.from(t.professions||[]).filter(a=>a&&a!=="Unknown"),m=t.profession||e.profession;return{...e,profession:m,professionList:n.length>0?n:m?[m]:[],activeMs:t.defenseActiveMs||t.totalFightMs||e.activeMs}},Si=Array.from(vt.values()).map(hn).filter(e=>pi(e.mitigationTotals)).sort((e,t)=>e.account.localeCompare(t.account)),Di=Array.from(Et.values()).map(hn).filter(e=>e.mitigationTotals.totalMitigation>0).sort((e,t)=>{const n=e.account.localeCompare(t.account);return n!==0?n:String(e.minion||"").localeCompare(String(t.minion||""))}),It=(e,t)=>{switch(t){case"downContrib":return e.downContrib;case"barrier":return e.barrier;case"healing":return e.healing;case"dodges":return e.dodges;case"strips":return e.strips;case"cleanses":return e.cleanses;case"cc":return e.cc;case"stability":return e.stab;case"revives":return e.revives;case"dps":return e.dps;case"damage":return e.damage;case"participation":return e.logsJoined;case"closestToTag":return!e.isCommander&&e.distCount>0?e.totalDist/e.distCount:Number.POSITIVE_INFINITY;default:return 0}},ze=(e,t)=>bn(qt.map(({stat:n})=>({account:n.account,profession:n.profession,professionList:n.professionList,value:It(n,e),count:n.logsJoined})),t),Ue={downContrib:ze("downContrib",!0),barrier:ze("barrier",!0),healing:ze("healing",!0),dodges:ze("dodges",!0),strips:ze("strips",!0),cleanses:ze("cleanses",!0),cc:ze("cc",!0),stability:ze("stability",!0),revives:ze("revives",!0),participation:ze("participation",!0),dps:ze("dps",!0),damage:ze("damage",!0),closestToTag:ze("closestToTag",!1).filter(e=>Number.isFinite(e.value))},Ni={downContrib:"downContrib",barrier:"barrier",healing:"healing",dodges:"dodges",strips:"strips",cleanses:"cleanses",cc:"cc",stability:"stability",closestToTag:"closestToTag"},ve=e=>{const t=e==null?void 0:e[0];return{value:(t==null?void 0:t.value)??0,player:(t==null?void 0:t.account)??"-",count:(t==null?void 0:t.count)??0,profession:(t==null?void 0:t.profession)??"Unknown",professionList:(t==null?void 0:t.professionList)??[]}},Xe={maxDownContrib:ve([]),maxBarrier:ve([]),maxHealing:ve([]),maxDodges:ve([]),maxStrips:ve([]),maxCleanses:ve([]),maxCC:ve([]),maxStab:ve([]),closestToTag:ve([])},Ye={},Ti=(e,t)=>{if(t==="closestToTag")return It(e,t);const n=Math.max(1,(e.totalFightMs||0)/1e3);return It(e,t)/n};Object.values(Ni).forEach(e=>{const t=e!=="closestToTag";Ye[e]=bn(qt.map(({stat:n})=>({account:n.account,profession:n.profession,professionList:n.professionList,value:Ti(n,e),count:n.logsJoined})),t)}),Xe.maxDownContrib=ve(Ye.downContrib),Xe.maxBarrier=ve(Ye.barrier),Xe.maxHealing=ve(Ye.healing),Xe.maxDodges=ve(Ye.dodges),Xe.maxStrips=ve(Ye.strips),Xe.maxCleanses=ve(Ye.cleanses),Xe.maxCC=ve(Ye.cc),Xe.maxStab=ve(Ye.stability),Xe.closestToTag=ve(Ye.closestToTag);const Ai={maxDownContrib:ve(Ue.downContrib),maxBarrier:ve(Ue.barrier),maxHealing:ve(Ue.healing),maxDodges:ve(Ue.dodges),maxStrips:ve(Ue.strips),maxCleanses:ve(Ue.cleanses),maxCC:ve(Ue.cc),maxStab:ve(Ue.stability),closestToTag:ve(Ue.closestToTag)};let jt={player:"None",account:"None",score:-1,profession:"Unknown",professionList:[],color:"#64748b",topStats:[]},kn,Cn,Sn=0;if(ge!=null&&ge.showMvp){const e={"Down Contribution":"downContribution",Healing:"healing",Cleanses:"cleanses",Strips:"strips",Stability:"stability",CC:"cc",Revives:"revives","Distance to Tag":"distanceToTag",Participation:"participation",Dodging:"dodging",DPS:"dps",Damage:"damage"},t=D=>{const N=e[D];return N?Number(J[N]||0)>0:!1},n=[],m=D=>[...D||[]].filter(N=>t(N==null?void 0:N.name)).sort((N,z)=>z.ratio-N.ratio||N.rank-z.rank||N.name.localeCompare(z.name)).slice(0,3),a=D=>{var z;if(!D)return;const N=m(D.contribs);return{...D,player:D.name,reason:((z=N[0])==null?void 0:z.name)||"Top Performance",topStats:N}};qt.forEach(({stat:D})=>{let N=0;const z=[],E=(Y,ue,ee,F,x=!0)=>{var G,me;if(ee<=0)return;const O=((G=ue[0])==null?void 0:G.value)||0;if(O&&Number.isFinite(Y)&&(x?Y>0:Y<Number.POSITIVE_INFINITY)){const l=x?Y/O:O/Y;N+=l*ee;const g=((me=ue.find(b=>b.account===D.account))==null?void 0:me.rank)||0;z.push({name:F,ratio:l,val:Y.toLocaleString(),rank:g})}};E(D.downContrib,Ue.downContrib,J.downContribution,"Down Contribution"),E(D.healing,Ue.healing,J.healing,"Healing"),E(D.cleanses,Ue.cleanses,J.cleanses,"Cleanses"),E(D.strips,Ue.strips,J.strips,"Strips"),E(D.stab,Ue.stability,J.stability,"Stability"),E(D.cc,Ue.cc,J.cc,"CC"),E(D.revives,Ue.revives,J.revives,"Revives"),E(It(D,"closestToTag"),Ue.closestToTag,J.distanceToTag,"Distance to Tag",!1),E(D.logsJoined,Ue.participation,J.participation,"Participation"),E(D.dodges,Ue.dodges,J.dodging,"Dodging"),E(D.dps,Ue.dps,J.dps,"DPS"),E(D.damage,Ue.damage,J.damage,"Damage"),n.push({...D,score:N,contribs:z.filter(Y=>t(Y.name))})}),n.sort((D,N)=>N.score-D.score),n[0]&&n[0].score>0&&(jt=a(n[0])||jt),kn=a(n[1]),Cn=a(n[2]),Sn=n.length>0?n.reduce((D,N)=>D+N.score,0)/n.length:0}const Mi=Object.values(Ne).sort((e,t)=>{const n=$==="downContribution"?e.downContribution:e.damage;return($==="downContribution"?t.downContribution:t.damage)-n}).slice(0,25),wi=Object.values(Me).sort((e,t)=>t.damage-e.damage).slice(0,25),vi=e=>{const t=String(e).replace(/^Detailed\s*WvW\s*-\s*/i,"").replace(/^World\s*vs\s*World\s*-\s*/i,"").replace(/^WvW\s*-\s*/i,"").trim(),n=t.match(/^(Red|Blue|Green)\s+(?:Alpine|Desert)?\s*Borderlands$/i);return n?`${n[1]} Borderlands`:t||"Unknown"},Pt=(e,t)=>vi((e==null?void 0:e.zone)||(e==null?void 0:e.mapName)||(e==null?void 0:e.map)||(e==null?void 0:e.location)||(e==null?void 0:e.fightName)||(t==null?void 0:t.fightName)||(t==null?void 0:t.encounterName)||"Unknown"),Ei=(e,t)=>{const n=(t==null?void 0:t.permalink)||(e==null?void 0:e.permalink);if(typeof n=="string"&&n.trim().length>0)return n.trim();const m=e==null?void 0:e.uploadLinks;if(!Array.isArray(m))return"";for(const a of m){if(typeof a=="string"&&a.trim().length>0)return a.trim();if(a&&typeof a=="object"){const D=a.permalink||a.link||a.url||a.reportLink;if(typeof D=="string"&&D.trim().length>0)return D.trim()}}return""},Wt={};_.forEach(e=>{const t=Pt(e==null?void 0:e.details,e);Wt[t]=(Wt[t]||0)+1});const Fi=Object.entries(Wt).map(([e,t])=>{const n=String(e).trim(),m=/eternal battlegrounds|^ebg$/i.test(n);let a="#64748b";return m?a="#ffffff":/red/i.test(n)?a="#ef4444":/blue/i.test(n)?a="#3b82f6":/green/i.test(n)&&(a="#22c55e"),{name:e,value:t,color:a}}).sort((e,t)=>t.value-e.value),{boonTables:Bi}=In(_),Ii=_.map((e,t)=>{var m,a;const n=((m=e.details)==null?void 0:m.players)||[];return{index:t+1,label:`Log ${t+1}`,timestamp:Je(e.details,e),squadCount:n.filter(D=>!D.notInSquad).length,friendlyCount:n.length,enemies:((a=e.details)==null?void 0:a.targets).filter(D=>!D.isFake).length}}).sort((e,t)=>e.timestamp-t.timestamp),Vt={};Array.from(Ae.values()).forEach(e=>{e.profession&&e.profession!=="Unknown"&&(Vt[e.profession]=(Vt[e.profession]||0)+1)});const Pi=Object.entries(Vt).map(([e,t])=>({name:e,value:t,color:en(e)})).sort((e,t)=>t.value-e.value),zt={};Object.keys(Fe).length===0&&_.forEach(e=>{var t,n;(n=(t=e.details)==null?void 0:t.targets)==null||n.forEach(m=>{if(m.isFake)return;const a=m.profession&&m.profession!=="Unknown"?m.profession:m.name||m.id||"Unknown",D=st(a);zt[D]=(zt[D]||0)+1})});const Hi=Object.keys(Fe).length>0?Fe:zt,Ui=Object.entries(Hi).map(([e,t])=>({name:e,value:t,color:en(e)})).sort((e,t)=>t.value-e.value),Li=_.map((e,t)=>({log:e,originalIndex:t})).sort((e,t)=>Je(e.log.details,e.log)-Je(t.log.details,t.log)).map(({log:e},t)=>{const n=e.details;if(!n)return null;const m=n.players||[],a=m.filter(s=>!s.notInSquad),D=m.filter(s=>s.notInSquad),N=n.targets||[],z=N.filter(s=>!s.isFake),E=a.reduce((s,L)=>{var p,C;return s+(((C=(p=L.dpsAll)==null?void 0:p[0])==null?void 0:C.damage)||0)},0),Y=a.reduce((s,L)=>{var p,C;return s+(((C=(p=L.defenses)==null?void 0:p[0])==null?void 0:C.damageTaken)||0)},0),{enemyDeaths:ue,enemyDownsDeaths:ee}=Le(n),F=Be(n),x=Je(n,e),O=Pt(n,e),G={red:0,green:0,blue:0},me=s=>{const L=Number(s);return Number.isFinite(L)?L:0},l=s=>{if(!s||typeof s!="object")return;const L=s.teamID??s.teamId??s.team??s.teamColor??s.team_color;if(L!=null)return L;const p=Object.keys(s).find(C=>/^team/i.test(C));return p?s[p]:void 0},g=(s,L)=>{if(s==null)return null;if(typeof s=="string"){const p=s.toLowerCase();return p.includes("red")?"red":p.includes("green")?"green":p.includes("blue")?"blue":p==="r"?"red":p==="g"?"green":p==="b"?"blue":null}if(typeof s=="number")if(L==="zeroBased"){if(s===0)return"red";if(s===1)return"green";if(s===2)return"blue"}else{if(s===1)return"red";if(s===2)return"green";if(s===3)return"blue"}return null},b=(s,L)=>{const p={};return s.forEach(C=>{const q=L(C),K=st(q);K&&(p[K]=(p[K]||0)+1)}),p},T=b(a,s=>(s==null?void 0:s.profession)||(s==null?void 0:s.name)),w=b(D,s=>(s==null?void 0:s.profession)||(s==null?void 0:s.name)),I=b(z,s=>(s==null?void 0:s.profession)||(s==null?void 0:s.name)||(s==null?void 0:s.id));if(n.teamCounts&&typeof n.teamCounts=="object"){const s=n.teamCounts;G.red=me(s.red??s.r??s[0]??s[1]),G.green=me(s.green??s.g??s[1]??s[2]),G.blue=me(s.blue??s.b??s[2]??s[3])}else{const s=[];N.forEach(q=>{if(q!=null&&q.isFake)return;const K=l(q);K!=null&&s.push(K)}),m.forEach(q=>{if(!(q!=null&&q.notInSquad))return;const K=l(q);K!=null&&s.push(K)}),s.length===0&&m.forEach(q=>{const K=l(q);K!=null&&s.push(K)});const L=new Set;s.forEach(q=>{typeof q=="number"&&L.add(q)});const p=L.has(0)?"zeroBased":L.has(3)?"oneBased":"zeroBased";if(s.forEach(q=>{const K=g(q,p);K&&(G[K]+=1)}),G.red+G.green+G.blue===0&&s.length>0){const q=new Map;s.forEach(de=>{const Ee=String(de);q.set(Ee,(q.get(Ee)||0)+1)});const K=Array.from(q.values()).sort((de,Ee)=>Ee-de);G.red=K[0]||0,G.green=K[1]||0,G.blue=K[2]||0}G.red+G.green+G.blue===0&&(G.red=Math.max(z.length,m.filter(q=>q==null?void 0:q.notInSquad).length))}return{id:e.filePath||`fight-${t}`,label:e.encounterName||`Fight ${t+1}`,permalink:Ei(n,e),timestamp:x,mapName:O,duration:ui(n.durationMS),isWin:F,squadCount:a.length,allyCount:D.length,enemyCount:z.length,teamCounts:G,alliesDown:a.reduce((s,L)=>{var p,C;return s+(((C=(p=L.defenses)==null?void 0:p[0])==null?void 0:C.downCount)||0)},0),alliesDead:a.reduce((s,L)=>{var p,C;return s+(((C=(p=L.defenses)==null?void 0:p[0])==null?void 0:C.deadCount)||0)},0),alliesRevived:a.reduce((s,L)=>{var p,C;return Number(((C=(p=L.statsAll)==null?void 0:p[0])==null?void 0:C.saved)||0)>0?s+1:s},0),rallies:0,enemyDeaths:ue,enemyDowns:Math.max(0,ee-ue),totalOutgoingDamage:E,totalIncomingDamage:Y,incomingBarrierAbsorbed:a.reduce((s,L)=>{var p,C;return s+(((C=(p=L.defenses)==null?void 0:p[0])==null?void 0:C.damageBarrier)||0)},0),outgoingBarrierAbsorbed:a.reduce((s,L)=>{var q;const p=(q=L.extBarrierStats)==null?void 0:q.outgoingBarrier;if(!Array.isArray(p))return s;let C=0;return p.forEach(K=>{if(Array.isArray(K)){K.forEach(de=>{C+=Number((de==null?void 0:de.barrier)||0)});return}C+=Number((K==null?void 0:K.barrier)||0)}),s+C},0),squadClassCountsFight:T,allyClassCountsFight:w,enemyClassCounts:I}}).filter(Boolean),xi=(e,t)=>{const n=(t==null?void 0:t.skillMap)||{},m=(t==null?void 0:t.buffMap)||{};let a=0,D="";const N=E=>{const Y=Number(E);if(!Number.isFinite(Y))return String(E||"Unknown Skill");const ue=(n==null?void 0:n[`s${Y}`])||(n==null?void 0:n[`${Y}`]);if(ue!=null&&ue.name)return String(ue.name);const ee=(m==null?void 0:m[`b${Y}`])||(m==null?void 0:m[`${Y}`]);return ee!=null&&ee.name?String(ee.name):`Skill ${Y}`},z=E=>{if(!E||typeof E!="object")return;const Y=[Number(E.max),Number(E.maxDamage),Number(E.maxHit),Number(E.totalDamage)>0&&Number(E.connectedHits)>0?Number(E.totalDamage)/Number(E.connectedHits):0].filter(ee=>Number.isFinite(ee)),ue=Y.length>0?Math.max(...Y):0;ue>a&&(a=ue,D=N(E.id))};return Array.isArray(e==null?void 0:e.totalDamageDist)&&e.totalDamageDist.forEach(E=>{Array.isArray(E)&&E.forEach(Y=>z(Y))}),Array.isArray(e==null?void 0:e.targetDamageDist)&&e.targetDamageDist.forEach(E=>{Array.isArray(E)&&E.forEach(Y=>{Array.isArray(Y)&&Y.forEach(ue=>z(ue))})}),{peak:a,skillName:D||"Unknown Skill"}},$i=(()=>{const e=F=>String(F||"").replace(/^Detailed\s*WvW\s*-\s*/i,"").replace(/^World\s*vs\s*World\s*-\s*/i,"").replace(/^WvW\s*-\s*/i,"").trim(),t=F=>e(F).toLowerCase().split(/[^a-z0-9]+/i).map(x=>x.trim()).filter(Boolean).map(x=>x.length>3&&x.endsWith("s")?x.slice(0,-1):x),n=(F,x)=>{const O=e(F),G=e(x);if(!G)return O;if(!O)return G;const me=t(O),l=t(G),g=new Set(me),b=new Set(l),T=l.length>0&&l.every(I=>g.has(I)),w=me.length>0&&me.every(I=>b.has(I));return T||w?O:`${O} - ${G}`},m=[],a=new Map,D=F=>{const x=T=>{if(!Array.isArray(T)||T.length===0)return[];const w=[];for(let I=0;I<T.length;I+=1){const s=Number(T[I]||0),L=I>0?Number(T[I-1]||0):0;w.push(Math.max(0,s-L))}return w},O=T=>{if(!Array.isArray(T))return[];const w=T.reduce((s,L)=>Math.max(s,Array.isArray(L)?L.length:0),0);if(w<=0)return[];const I=new Array(w).fill(0);return T.forEach(s=>{if(Array.isArray(s))for(let L=0;L<w;L+=1)I[L]+=Number(s[L]||0)}),I},G=T=>Array.isArray(T)?T.map(w=>Number(w||0)):null,l=(T=>{if(!Array.isArray(T)||T.length===0)return null;const w=T[0];if(!Array.isArray(w))return null;if(Array.isArray(w[0])&&Array.isArray(w[0][0]))return O(w);if(Array.isArray(w[0])&&!Array.isArray(w[0][0])){const I=T.map(s=>G(Array.isArray(s)?s[0]:null)).filter(s=>Array.isArray(s)&&s.length>0);if(I.length>0)return O(I)}return null})(F==null?void 0:F.targetDamage1S),g=Array.isArray(F==null?void 0:F.damage1S)&&Array.isArray(F.damage1S[0])?F.damage1S[0]:null,b=l||(Array.isArray(g)?g.map(T=>Number(T||0)):[]);return x(b)},N=(F,x)=>{if(!Array.isArray(F)||F.length===0||x<=0)return 0;let O=0,G=0;for(let me=0;me<F.length;me+=1)O+=Number(F[me]||0),me>=x&&(O-=Number(F[me-x]||0)),me>=x-1&&O>G&&(G=O);return Math.max(0,G)},z=(F,x)=>{if(!Array.isArray(F)||F.length===0||x<=0)return[];const O=[];for(let G=0;G<F.length;G+=x){const me=Math.min(G+x,F.length),l=F.slice(G,me).reduce((g,b)=>g+Number(b||0),0);O.push(l)}return O},E=F=>Array.isArray(F)?F.map(x=>Array.isArray(x)?[Number(x[0]),Number(x[1])]:x&&typeof x=="object"?[Number(x.time),Number(x.value)]:null).filter(x=>!!x&&Number.isFinite(x[0])&&x[0]>=0):[],Y=(F,x,O,G,me)=>{if(!F.length||G<=0)return[];const l=Math.max(G*5e3,me||0),g=C=>C.reduce((q,K)=>K>=0&&K<=l+2e3?q+1:q,0),b=F.map(C=>Number(C||0)).filter(C=>Number.isFinite(C)&&C>=0);if(!b.length)return[];const T=[b],w=b.reduce((C,q)=>Math.max(C,q),0),I=b.reduce((C,q)=>Math.min(C,q),Number.POSITIVE_INFINITY);w>l*20&&T.push(b.map(C=>C/1e3)),w<=l*2&&I>=0&&w>0&&w<Math.max(120,G*5+10)&&T.push(b.map(C=>C*1e3));let s=b,L=0,p=-1;return T.forEach(C=>{const q=C.reduce((de,Ee)=>Math.min(de,Ee),Number.POSITIVE_INFINITY),K=new Set([0,...x,...O]);if(Number.isFinite(q)&&l>0&&q>l){const de=Math.floor(q/l)*l;K.add(de),K.add(Math.max(0,de-l))}K.forEach(de=>{const Ee=C.map(Pe=>Pe-de),re=g(Ee);re>p&&(p=re,L=de,s=C)})}),s.map(C=>C-L).filter(C=>Number.isFinite(C)&&C>=0)},ue=(F,x,O,G,me)=>{const l=Y(F,x,O,G,me);return Array.from(new Set(l.map(g=>Math.floor(g/5e3)).filter(g=>Number.isFinite(g)&&g>=0&&g<G)))};_.map(F=>({log:F,ts:Je(F==null?void 0:F.details,F)})).sort((F,x)=>F.ts-x.ts).forEach(({log:F},x)=>{const O=F==null?void 0:F.details;if(!O)return;const G=e(O.fightName||F.fightName||`Fight ${x+1}`),me=Pt(O,F),l=n(G,String(me||"")),g={},b=Array.isArray(O.players)?O.players:[],T=b.flatMap(p=>{const C=p==null?void 0:p.combatReplayData;return Array.isArray(C)?C.map(q=>Number(q==null?void 0:q.start)):[Number(C==null?void 0:C.start)]}).filter(p=>Number.isFinite(p)&&p>=0);b.forEach(p=>{if(p!=null&&p.notInSquad)return;const C=String((p==null?void 0:p.account)||(p==null?void 0:p.name)||"Unknown"),q=String((p==null?void 0:p.character_name)||(p==null?void 0:p.display_name)||(p==null?void 0:p.name)||""),K=String((p==null?void 0:p.profession)||"Unknown"),de=`${C}|${K}`,Ee=xi(p,O),re=Number(Ee.peak||0),Pe=D(p),je=Number(N(Pe,1)||0),o=Number(N(Pe,5)||0),h=Number(N(Pe,30)||0),c=Math.max(0,Math.ceil(Number((O==null?void 0:O.durationMS)||0)/5e3)),k=Math.max(0,Math.ceil(Pe.length/5)),v=Math.max(c,k),d=z(Pe,5),P=Array.from({length:v},(W,y)=>Number(d[y]||0)),B=(()=>{const W=p==null?void 0:p.combatReplayData;return Array.isArray(W)?W.filter(y=>y&&typeof y=="object"):W&&typeof W=="object"?[W]:[]})(),j=B.map(W=>Number(W==null?void 0:W.start)).filter(W=>Number.isFinite(W)&&W>=0),ce=B.flatMap(W=>E(W==null?void 0:W.down).map(([y])=>Number(y||0))),ae=B.flatMap(W=>E(W==null?void 0:W.dead).map(([y])=>Number(y||0)));g[de]={hit:re,burst1s:je,burst5s:o,burst30s:h,skillName:Ee.skillName,buckets5s:P,downIndices5s:ue(ce,j,T,v,Number((O==null?void 0:O.durationMS)||0)),deathIndices5s:ue(ae,j,T,v,Number((O==null?void 0:O.durationMS)||0))};const H=a.get(de)||{key:de,account:C,displayName:C,characterName:q,profession:K,professionList:[K],logs:0,peakHit:0,peak1s:0,peak5s:0,peak30s:0,peakFightLabel:"",peakSkillName:""};H.logs+=1,H.professionList.includes(K)||H.professionList.push(K),!H.characterName&&q&&(H.characterName=q),re>H.peakHit&&(H.peakHit=re,H.peakFightLabel=l,H.peakSkillName=Ee.skillName),je>H.peak1s&&(H.peak1s=je),o>H.peak5s&&(H.peak5s=o),h>H.peak30s&&(H.peak30s=h),a.set(de,H)});const w=Object.values(g).reduce((p,C)=>Math.max(p,Number((C==null?void 0:C.hit)||0)),0),I=Object.values(g).reduce((p,C)=>Math.max(p,Number((C==null?void 0:C.burst1s)||0)),0),s=Object.values(g).reduce((p,C)=>Math.max(p,Number((C==null?void 0:C.burst5s)||0)),0),L=Object.values(g).reduce((p,C)=>Math.max(p,Number((C==null?void 0:C.burst30s)||0)),0);m.push({id:F.filePath||F.id||`fight-${x+1}`,shortLabel:`F${x+1}`,fullLabel:l,timestamp:Je(O,F),values:g,maxHit:w,max1s:I,max5s:s,max30s:L})});const ee=Array.from(a.values()).sort((F,x)=>x.peakHit!==F.peakHit?x.peakHit-F.peakHit:F.displayName.localeCompare(x.displayName));return{fights:m,players:ee}})(),Oi=(()=>{const e=l=>String(l||"").replace(/^Detailed\s*WvW\s*-\s*/i,"").replace(/^World\s*vs\s*World\s*-\s*/i,"").replace(/^WvW\s*-\s*/i,"").trim(),t=l=>e(l).toLowerCase().split(/[^a-z0-9]+/i).map(g=>g.trim()).filter(Boolean).map(g=>g.length>3&&g.endsWith("s")?g.slice(0,-1):g),n=(l,g)=>{const b=e(l),T=e(g);if(!T)return b;if(!b)return T;const w=t(b),I=t(T),s=new Set(w),L=new Set(I),p=I.length>0&&I.every(q=>s.has(q)),C=w.length>0&&w.every(q=>L.has(q));return p||C?b:`${b} - ${T}`},m=[],a=new Map,D=(l,g)=>{const b=Number(l);if(!Number.isFinite(b))return String(l||"Unknown Skill");const T=(g==null?void 0:g.skillMap)||{},w=(g==null?void 0:g.buffMap)||{},I=(T==null?void 0:T[`s${b}`])||(T==null?void 0:T[`${b}`]);if(I!=null&&I.name)return String(I.name);const s=(w==null?void 0:w[`b${b}`])||(w==null?void 0:w[`${b}`]);return s!=null&&s.name?String(s.name):`Skill ${b}`},N=(l,g)=>{let b=0,T="";const w=I=>{if(!I||typeof I!="object"||I.indirectDamage)return;const s=[Number(I.max),Number(I.maxDamage),Number(I.maxHit),Number(I.totalDamage)>0&&Number(I.connectedHits)>0?Number(I.totalDamage)/Number(I.connectedHits):0].filter(p=>Number.isFinite(p)),L=s.length>0?Math.max(...s):0;L>b&&(b=L,T=D(I.id,g))};return Array.isArray(l==null?void 0:l.totalDamageDist)&&l.totalDamageDist.forEach(I=>{Array.isArray(I)&&I.forEach(s=>w(s))}),Array.isArray(l==null?void 0:l.targetDamageDist)&&l.targetDamageDist.forEach(I=>{Array.isArray(I)&&I.forEach(s=>{Array.isArray(s)&&s.forEach(L=>w(L))})}),{peak:b,skillName:T||"Unknown Skill"}},z=l=>{if(!Array.isArray(l)||l.length===0)return[];const g=[];for(let b=0;b<l.length;b+=1){const T=Number(l[b]||0),w=b>0?Number(l[b-1]||0):0;g.push(Math.max(0,T-w))}return g},E=l=>{if(!Array.isArray(l)||l.length===0)return[];const g=l.reduce((T,w)=>Math.max(T,Array.isArray(w)?w.length:0),0);if(g<=0)return[];const b=new Array(g).fill(0);return l.forEach(T=>{if(Array.isArray(T))for(let w=0;w<g;w+=1)b[w]+=Number(T[w]||0)}),b},Y=l=>{if(!Array.isArray(l)||l.length===0)return[];const g=l[0];if(typeof g=="number")return l.map(b=>Number(b||0));if(Array.isArray(g)&&g.length>0){if(typeof g[0]=="number")return g.map(b=>Number(b||0));if(Array.isArray(g[0])){const b=g.map(T=>Array.isArray(T)?T.map(w=>Number(w||0)):null).filter(T=>Array.isArray(T)&&T.length>0);if(b.length>0)return E(b)}}return[]},ue=l=>{const g=Y(l==null?void 0:l.powerDamage1S),b=Y(l==null?void 0:l.damage1S),T=g.length>0?g:b;return z(T)},ee=(l,g)=>{if(!Array.isArray(l)||l.length===0||g<=0)return 0;let b=0,T=0;for(let w=0;w<l.length;w+=1)b+=Number(l[w]||0),w>=g&&(b-=Number(l[w-g]||0)),w>=g-1&&b>T&&(T=b);return Math.max(0,T)},F=(l,g)=>{if(!Array.isArray(l)||l.length===0||g<=0)return[];const b=[];for(let T=0;T<l.length;T+=g){const w=Math.min(T+g,l.length),I=l.slice(T,w).reduce((s,L)=>s+Number(L||0),0);b.push(I)}return b},x=l=>Array.isArray(l)?l.map(g=>Array.isArray(g)?[Number(g[0]),Number(g[1])]:g&&typeof g=="object"?[Number(g.time),Number(g.value)]:null).filter(g=>!!g&&Number.isFinite(g[0])&&g[0]>=0):[],O=(l,g,b,T,w)=>{if(!l.length||T<=0)return[];const I=Math.max(T*5e3,w||0),s=re=>re.reduce((Pe,je)=>je>=0&&je<=I+2e3?Pe+1:Pe,0),L=l.map(re=>Number(re||0)).filter(re=>Number.isFinite(re)&&re>=0);if(!L.length)return[];const p=[L],C=L.reduce((re,Pe)=>Math.max(re,Pe),0),q=L.reduce((re,Pe)=>Math.min(re,Pe),Number.POSITIVE_INFINITY);C>I*20&&p.push(L.map(re=>re/1e3)),C<=I*2&&q>=0&&C>0&&C<Math.max(120,T*5+10)&&p.push(L.map(re=>re*1e3));let K=L,de=0,Ee=-1;return p.forEach(re=>{const Pe=re.reduce((o,h)=>Math.min(o,h),Number.POSITIVE_INFINITY),je=new Set([0,...g,...b]);if(Number.isFinite(Pe)&&I>0&&Pe>I){const o=Math.floor(Pe/I)*I;je.add(o),je.add(Math.max(0,o-I))}je.forEach(o=>{const h=re.map(k=>k-o),c=s(h);c>Ee&&(Ee=c,de=o,K=re)})}),K.map(re=>re-de).filter(re=>Number.isFinite(re)&&re>=0)},G=(l,g,b,T,w)=>{const I=O(l,g,b,T,w);return Array.from(new Set(I.map(s=>Math.floor(s/5e3)).filter(s=>Number.isFinite(s)&&s>=0&&s<T)))};_.map(l=>({log:l,ts:Je(l==null?void 0:l.details,l)})).sort((l,g)=>l.ts-g.ts).forEach(({log:l},g)=>{const b=l==null?void 0:l.details;if(!b)return;const T=e(b.fightName||l.fightName||`Fight ${g+1}`),w=Pt(b,l),I=n(T,String(w||"")),s={},L=Array.isArray(b.players)?b.players:[],p=L.filter(c=>!(c!=null&&c.notInSquad)),C=p.flatMap(c=>{const k=c==null?void 0:c.combatReplayData;return Array.isArray(k)?k.map(v=>Number(v==null?void 0:v.start)):[Number(k==null?void 0:k.start)]}).filter(c=>Number.isFinite(c)&&c>=0),q=p.flatMap(c=>{const k=c==null?void 0:c.combatReplayData;return(Array.isArray(k)?k:k?[k]:[]).flatMap(d=>x(d==null?void 0:d.down).map(([P])=>Number(P||0)))}),K=p.flatMap(c=>{const k=c==null?void 0:c.combatReplayData;return(Array.isArray(k)?k:k?[k]:[]).flatMap(d=>x(d==null?void 0:d.dead).map(([P])=>Number(P||0)))}),de=new Map,Ee=new Map;if((Array.isArray(b.targets)?b.targets:[]).forEach(c=>{if(!c||c.isFake||!c.enemyPlayer)return;const k=st((c==null?void 0:c.profession)||(c==null?void 0:c.name)||(c==null?void 0:c.id))||"Unknown";Ee.set(k,(Ee.get(k)||0)+1);const v=ue(c),d=N(c,b);let P=de.get(k);P||(P={perSecond:[],hit:0,skillName:""},de.set(k,P)),v.length>P.perSecond.length&&(P.perSecond.length=v.length);for(let j=0;j<v.length;j+=1)P.perSecond[j]=Number(P.perSecond[j]||0)+Number(v[j]||0);const B=Number(d.peak||0);B>P.hit&&(P.hit=B,P.skillName=d.skillName||"Unknown Skill")}),de.size===0){const c=L.filter(d=>!(d!=null&&d.notInSquad)),k=E(c.map(d=>{const P=Y(d==null?void 0:d.powerDamageTaken1S);return z(P)})),v=Array.from(Ee.values()).reduce((d,P)=>d+Number(P||0),0);k.length>0&&v>0&&Ee.forEach((d,P)=>{const B=Number(d||0)/v,j=k.map(ce=>Number(ce||0)*B);de.set(P,{perSecond:j,hit:0,skillName:""})})}de.forEach((c,k)=>{const v=k,d=Number(c.hit||0),P=Number(ee(c.perSecond,1)||0),B=Number(ee(c.perSecond,5)||0),j=Number(ee(c.perSecond,30)||0),ce=Math.max(0,Math.ceil(Number((b==null?void 0:b.durationMS)||0)/5e3)),ae=Math.max(0,Math.ceil(c.perSecond.length/5)),H=Math.max(ce,ae),W=F(c.perSecond,5),y=Array.from({length:H},(ne,Te)=>Number(W[Te]||0));s[v]={hit:d,burst1s:P,burst5s:B,burst30s:j,skillName:c.skillName||"Unknown Skill",buckets5s:y,downIndices5s:G(q,[],C,H,Number((b==null?void 0:b.durationMS)||0)),deathIndices5s:G(K,[],C,H,Number((b==null?void 0:b.durationMS)||0))};const X=a.get(v)||{key:v,account:k,displayName:k,characterName:"",profession:k,professionList:[k],logs:0,peakHit:0,peak1s:0,peak5s:0,peak30s:0,peakFightLabel:"",peakSkillName:""};X.logs+=1,d>X.peakHit&&(X.peakHit=d,X.peakFightLabel=I,X.peakSkillName=c.skillName||"Unknown Skill"),P>X.peak1s&&(X.peak1s=P),B>X.peak5s&&(X.peak5s=B),j>X.peak30s&&(X.peak30s=j),a.set(v,X)});const Pe=Object.values(s).reduce((c,k)=>Math.max(c,Number((k==null?void 0:k.hit)||0)),0),je=Object.values(s).reduce((c,k)=>Math.max(c,Number((k==null?void 0:k.burst1s)||0)),0),o=Object.values(s).reduce((c,k)=>Math.max(c,Number((k==null?void 0:k.burst5s)||0)),0),h=Object.values(s).reduce((c,k)=>Math.max(c,Number((k==null?void 0:k.burst30s)||0)),0);m.push({id:l.filePath||l.id||`fight-${g+1}`,shortLabel:`F${g+1}`,fullLabel:I,timestamp:Je(b,l),values:s,maxHit:Pe,max1s:je,max5s:o,max30s:h})});const me=Array.from(a.values()).sort((l,g)=>g.peakHit!==l.peakHit?g.peakHit-l.peakHit:l.displayName.localeCompare(g.displayName));return{fights:m,players:me}})(),Ri=Array.from(Qe.entries()).map(([e,t])=>{const n=Ze.get(e)||{},m=Array.from(t.values()).map(a=>{var ue;const D=Array.from(a.professions||[]).filter(ee=>ee&&ee!=="Unknown");let N=a.profession||"Unknown";if(D.length>0){N=D[0];let ee=((ue=a.professionTimeMs)==null?void 0:ue[N])||0;D.forEach(F=>{var O;const x=((O=a.professionTimeMs)==null?void 0:O[F])||0;x>ee&&(ee=x,N=F)})}const z=a.durationMs||0,E=a.totalMs/1e3,Y=z>0?a.totalMs/z:0;return{account:a.account,profession:N,professionList:D,total:E,perSecond:Y,duration:z/1e3}}).filter(a=>a.total>0||a.perSecond>0);return{id:e,name:n.name||e,icon:n.icon,rows:m}}).filter(e=>e.rows.length>0),_i=Array.from(qe.values()).map(e=>{const t=Array.from(e.skills.values()).sort((m,a)=>a.damage-m.damage),n=t.reduce((m,a)=>(m[a.id]=a,m),{});return{key:e.key,account:e.account,displayName:e.displayName,profession:e.profession,professionList:e.professionList,totalFightMs:e.totalFightMs,skills:t,skillMap:n}}).sort((e,t)=>e.displayName.localeCompare(t.displayName));return{total:V,wins:be,losses:U,avgSquadSize:bi,avgEnemies:hi,squadKDR:ki,enemyKDR:Ci,totalSquadKills:De,totalSquadDeaths:se,totalEnemyKills:le,totalEnemyDeaths:Re,leaderboards:Ue,...Ai,outgoingConditionSummary:Object.values(Ie).sort((e,t)=>t.damage-e.damage),incomingConditionSummary:Object.values($e).sort((e,t)=>t.damage-e.damage),outgoingConditionPlayers:Array.from(Ae.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,conditions:e.outgoingConditions})),incomingConditionPlayers:Array.from(Ae.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,conditions:e.incomingConditions})),topSkills:Mi,topIncomingSkills:wi,playerSkillBreakdowns:_i,topSkillsMetric:$,mapData:Fi,timelineData:Ii,boonTables:Bi,offensePlayers:Array.from(Ae.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,offenseTotals:e.offenseTotals,offenseRateWeights:e.offenseRateWeights,totalFightMs:e.totalFightMs})),defensePlayers:Array.from(Ae.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,defenseTotals:e.defenseTotals,activeMs:e.defenseActiveMs})),damageMitigationPlayers:Si,damageMitigationMinions:Di,supportPlayers:Array.from(Ae.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,supportTotals:e.supportTotals,activeMs:e.supportActiveMs})),healingPlayers:Array.from(Ae.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,healingTotals:e.healingTotals,activeMs:e.healingActiveMs})),mvp:jt,silver:kn,bronze:Cn,squadClassData:Pi,enemyClassData:Ui,fightBreakdown:Li,spikeDamage:$i,incomingStrikeDamage:Oi,specialTables:Ri,topStatsPerSecond:Xe,topStatsLeaderboardsPerSecond:Ye,avgMvpScore:Sn}})(),Ve=(()=>{const Se=new Map,ke=new Map,$=[],V=new Map,be=new Map;_.forEach(ie=>{const oe=ie.details;if(!oe)return;const se=oe.skillMap||{},De=oe.fightName||"Log",Re=Je(oe,ie)||Date.now(),le={id:ie.filePath||ie.id||De,label:De,timestamp:Re,skillEntries:{},playerActiveSeconds:{},durationSeconds:oe.durationMS?oe.durationMS/1e3:0};(oe.players||[]).forEach(Be=>{if(Be.notInSquad)return;const Ae=Be.account||Be.name||"Unknown",_e=Be.profession||"Unknown",Ne=`${Ae}|${_e}`;let Me=ke.get(Ne);Me||(Me={key:Ne,account:Ae,displayName:Ae,profession:_e,professionList:[_e],logs:0,totalActiveSeconds:0,skillTotals:{}},ke.set(Ne,Me)),Me.logs++;const qe=(Array.isArray(Be.activeTimes)?Be.activeTimes[0]:0)/1e3;Me.totalActiveSeconds=(Me.totalActiveSeconds||0)+qe,le.playerActiveSeconds[Ne]=qe,(Be.rotation||[]).forEach(Ie=>{var At,Mt,wt;if(!(Ie!=null&&Ie.id))return;const $e=((At=Ie.skills)==null?void 0:At.length)||0;if($e<=0)return;const Fe=`s${Ie.id}`,Ze=((Mt=se[Fe])==null?void 0:Mt.name)||`Skill ${Ie.id}`,Qe=(wt=se[Fe])==null?void 0:wt.icon;Me.skillTotals[Fe]=(Me.skillTotals[Fe]||0)+$e,Se.set(Fe,(Se.get(Fe)||0)+$e),V.set(Fe,Ze),Qe&&!be.has(Fe)&&be.set(Fe,Qe),le.skillEntries[Fe]||(le.skillEntries[Fe]={name:Ze,icon:Qe,players:{}}),!le.skillEntries[Fe].icon&&Qe&&(le.skillEntries[Fe].icon=Qe),le.skillEntries[Fe].players[Ne]=(le.skillEntries[Fe].players[Ne]||0)+$e})}),$.push(le)});const U=Array.from(Se.entries()).map(([ie,oe])=>({id:ie,name:V.get(ie)||ie,total:oe,icon:be.get(ie)})).sort((ie,oe)=>oe.total-ie.total);return{logRecords:$,players:Array.from(ke.values()),skillOptions:U,resUtilitySkills:[]}})();return{validLogs:_,stats:Oe,skillUsageData:Ve}};let Ge=null,ut=!1,tn=null,nn=0,on=0,xt=null;const sn=i=>{if(!i||typeof i!="object")return i;const r=(M,R)=>{const _={};return R.forEach(ge=>{M&&Object.prototype.hasOwnProperty.call(M,ge)&&(_[ge]=M[ge])}),_},u=r(i,["players","targets","durationMS","uploadTime","timeStart","timeStartStd","timeEnd","timeEndStd","fightName","success","teamCounts","combatReplayMetaData","skillMap","buffMap","encounterDuration","player_damage_mitigation","player_minion_damage_mitigation","playerDamageMitigation","playerMinionDamageMitigation"]);return Array.isArray(u.players)&&(u.players=u.players.map(M=>r(M,["name","display_name","character_name","profession","elite_spec","group","dpsAll","statsAll","dpsTargets","statsTargets","defenses","support","rotation","extHealingStats","extBarrierStats","squadBuffVolumes","selfBuffs","groupBuffs","squadBuffs","selfBuffsActive","groupBuffsActive","squadBuffsActive","buffUptimes","totalDamageDist","targetDamageDist","damage1S","targetDamage1S","totalDamageTaken","totalDamageTakenDist","minions","combatReplayData","hasCommanderTag","notInSquad","account","activeTimes"]))),Array.isArray(u.targets)&&(u.targets=u.targets.map(M=>r(M,["id","name","isFake","dpsAll","statsAll","defenses","totalHealth","healthPercentBurned","enemyPlayer","totalDamageDist"]))),u},fi=i=>{if(!i||typeof i!="object")return i;const r={...i};return i.details?r.details=sn(i.details):r.details=sn(i),r},an=()=>{if(!ut||!Ge)return;ut=!1,nn+=1;const i=xt;xt=null;const r=di(Ge);self.postMessage({type:"result",result:r,computeId:nn,logCount:Ge.logs.length,token:on,completedAt:Date.now(),flushId:i})},$t=()=>{tn===null&&(tn=setInterval(()=>{an()},5e3))};self.onmessage=i=>{var u,M,R,_;const r=i.data;if((r==null?void 0:r.type)==="reset"){Ge={logs:[]},typeof r.token=="number"&&(on=r.token),ut=!0,$t();return}if((r==null?void 0:r.type)==="settings"){Ge={logs:(Ge==null?void 0:Ge.logs)||[],precomputedStats:(u=r.payload)==null?void 0:u.precomputedStats,mvpWeights:(M=r.payload)==null?void 0:M.mvpWeights,statsViewSettings:(R=r.payload)==null?void 0:R.statsViewSettings,disruptionMethod:(_=r.payload)==null?void 0:_.disruptionMethod},ut=!0,$t();return}if((r==null?void 0:r.type)==="log"){Ge||(Ge={logs:[]}),Ge.logs.push(fi(r.payload)),ut=!0,$t();return}(r==null?void 0:r.type)==="flush"&&(typeof r.flushId=="number"&&(xt=r.flushId),ut=!0,an())}})();
