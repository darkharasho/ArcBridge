(function(){"use strict";const yt=["selfBuffs","groupBuffs","squadBuffs"],Kt=i=>i!=null&&i.classification?i.classification==="Boon":!0,Gt=i=>`b${i}`,Bn=(i,r)=>{const l=Array.isArray(i==null?void 0:i.activeTimes)?i.activeTimes:[],w=typeof l[0]=="number"?l[0]:0;return w>0?w:r},Yt=(i,r,l,w,R,q,fe)=>{const X=i==="selfBuffs"?1:Math.max(i==="groupBuffs"?q-1:fe-1,0);return!X||!R?{generationMs:0,wastedMs:0}:r?{generationMs:l*R*X,wastedMs:w*R*X}:{generationMs:l/100*R*X,wastedMs:w/100*R*X}},In=i=>{const r=new Map,l=new Map;return i.forEach(q=>{const fe=q.details;if(!fe)return;const X=fe.durationMS||0,ge=fe.buffMap||{};Object.entries(ge).forEach(([x,W])=>{if(!r.has(x)){r.set(x,W);return}const pe=r.get(x)||{},U={name:pe.name||W.name,stacking:pe.stacking??W.stacking,icon:pe.icon||W.icon,classification:pe.classification||W.classification};r.set(x,U)});const Ve=(fe.players||[]).filter(x=>!x.notInSquad),Se=Ve.length,ke=new Map;Ve.forEach(x=>{const W=x.group??0;ke.set(W,(ke.get(W)||0)+1)}),Ve.forEach(x=>{const W=x.account||x.name||x.character_name||"Unknown",pe=x.profession||"Unknown",U=x.group??0,oe=ke.get(U)||1,se=Bn(x,X);l.has(W)||l.set(W,{account:W,profession:pe,professions:new Set,professionTimeMs:{},activeTimeMs:0,numFights:0,groupSupported:0,squadSupported:0,boons:{}});const ae=l.get(W);ae.profession=pe,pe!=="Unknown"&&(ae.professions.add(pe),ae.professionTimeMs[pe]=(ae.professionTimeMs[pe]||0)+se),ae.activeTimeMs+=se,ae.numFights+=1,ae.groupSupported+=oe,ae.squadSupported+=Se,yt.forEach(De=>{(x[De]||[]).forEach(le=>{var Ie,xe,Fe,Ze;if(typeof(le==null?void 0:le.id)!="number")return;const Le=Gt(le.id),Be=ge[Le];if(!Kt(Be))return;const Te=(Be==null?void 0:Be.stacking)??!1,_e=((xe=(Ie=le.buffData)==null?void 0:Ie[0])==null?void 0:xe.generation)??0,Ne=((Ze=(Fe=le.buffData)==null?void 0:Fe[0])==null?void 0:Ze.wasted)??0,{generationMs:Ae,wastedMs:qe}=Yt(De,Te,_e,Ne,X,oe,Se);!Ae&&!qe||(r.has(Le)||r.set(Le,Be||{}),ae.boons[Le]||(ae.boons[Le]={selfBuffs:{generationMs:0,wastedMs:0},groupBuffs:{generationMs:0,wastedMs:0},squadBuffs:{generationMs:0,wastedMs:0}}),ae.boons[Le][De].generationMs+=Ae,ae.boons[Le][De].wastedMs+=qe)})})})}),{boonTables:Array.from(r.keys()).filter(q=>Kt(r.get(q))).map(q=>{const fe=r.get(q)||{},X=[];return l.forEach(ge=>{var x;const Oe=ge.boons[q];if(!Oe||!yt.some(W=>Oe[W].generationMs>0||Oe[W].wastedMs>0))return;const Se=Array.from(ge.professions||[]).filter(W=>W&&W!=="Unknown");let ke=ge.profession;if(Se.length>0){ke=Se[0];let W=((x=ge.professionTimeMs)==null?void 0:x[ke])||0;Se.forEach(pe=>{var oe;const U=((oe=ge.professionTimeMs)==null?void 0:oe[pe])||0;U>W&&(W=U,ke=pe)})}X.push({account:ge.account,profession:ke||"Unknown",professionList:Se,activeTimeMs:ge.activeTimeMs||1,numFights:ge.numFights||1,groupSupported:ge.groupSupported||1,squadSupported:ge.squadSupported||1,categories:{selfBuffs:{...Oe.selfBuffs},groupBuffs:{...Oe.groupBuffs},squadBuffs:{...Oe.squadBuffs}}})}),{id:q,name:fe.name||q,icon:fe.icon,stacking:fe.stacking??!1,rows:X}}).filter(q=>q.rows.length>0)}},Jt=(i,r,l,w,R,q,fe={})=>{var x,W,pe,U;const ge=((i==null?void 0:i[r])||[]).find(oe=>oe.id===l);if(!ge)return{generationMs:0,wastedMs:0};const Oe=fe[Gt(l)],Ve=(Oe==null?void 0:Oe.stacking)??!1,Se=((W=(x=ge.buffData)==null?void 0:x[0])==null?void 0:W.generation)??0,ke=((U=(pe=ge.buffData)==null?void 0:pe[0])==null?void 0:U.wasted)??0;return Yt(r,Ve,Se,ke,w,R,q)};var Pn={methods:{tiered:{tiers:{shortMs:500,mediumMs:1500,weights:{short:.5,medium:1,long:2}}}}};const Hn=Pn,Lt="count",Un=i=>(i||0)/1e3,Ln=(i,r)=>{var R;if(!i)return 0;const l=(R=Hn.methods.tiered)==null?void 0:R.tiers;if(!l)return i;const w=r/Math.max(i,1);return w<=l.shortMs?i*l.weights.short:w<=l.mediumMs?i*l.weights.medium:i*l.weights.long},Qt=(i,r,l)=>l==="duration"?Un(r):l==="tiered"?Ln(i,r):i;function $n(i,r=Lt){var q;const l=(q=i.statsAll)==null?void 0:q[0],w=Number((l==null?void 0:l.appliedCrowdControl)??0),R=Number((l==null?void 0:l.appliedCrowdControlDuration)??0);return Qt(w,R,r)}function xn(i,r){const l=(r==null?void 0:r.durationMS)||0,w=(r==null?void 0:r.buffMap)||{},R=i.filter(X=>!X.notInSquad),q=R.length,fe=new Map;R.forEach(X=>{const ge=X.group??0;fe.set(ge,(fe.get(ge)||0)+1)}),R.forEach(X=>{const ge=fe.get(X.group??0)||1,Oe=Jt(X,"selfBuffs",1122,l,ge,q,w),Ve=Jt(X,"squadBuffs",1122,l,ge,q,w);X.stabGeneration=(Oe.generationMs+Ve.generationMs)/1e3})}function On(i){if(!i.statsTargets)return 0;let r=0;for(const l of i.statsTargets)l&&l.length>0&&(r+=l[0].downContribution||0);return r}function Rn(i){if(!i.extBarrierStats||!i.extBarrierStats.outgoingBarrierAllies)return 0;let r=0;for(const l of i.extBarrierStats.outgoingBarrierAllies)if(l)for(const w of l)w&&(r+=w.barrier||0);return r}function _n(i){if(!i.extHealingStats||!i.extHealingStats.outgoingHealingAllies)return 0;let r=0;for(const l of i.extHealingStats.outgoingHealingAllies)if(l)for(const w of l)w&&(r+=w.healing||0);return r}const qn=i=>{var r,l,w,R;return(((l=(r=i.support)==null?void 0:r[0])==null?void 0:l.condiCleanse)||0)+(((R=(w=i.support)==null?void 0:w[0])==null?void 0:R.condiCleanseSelf)||0)},jn=(i,r=Lt)=>{var q;const l=(q=i.support)==null?void 0:q[0],w=Number((l==null?void 0:l.boonStrips)??0),R=Number((l==null?void 0:l.boonStripsTime)??0);return Qt(w,R,r)},Wn=i=>On(i),Vn=i=>_n(i),zn=i=>Rn(i),yn=(i,r=Lt)=>$n(i,r),Kn=(i,r)=>xn(i,r),Gn="count",Yn={downContribution:1,healing:1,cleanses:1,strips:1,stability:1,cc:.7,revives:.7,distanceToTag:.7,participation:.7,dodging:.4,dps:.2,damage:.2},Jn={showMvp:!0,topSkillDamageSource:"target",topSkillsMetric:"damage"},Xt=new Map([["bleeding","Bleeding"],["burning","Burning"],["confusion","Confusion"],["poison","Poison"],["torment","Torment"],["vulnerability","Vulnerability"],["weakness","Weakness"],["weakened","Weakness"],["blind","Blind"],["blinded","Blind"],["blinding","Blind"],["cripple","Cripple"],["crippled","Cripple"],["chill","Chill"],["chilled","Chill"],["immob","Immobilize"],["immobile","Immobilize"],["immobilized","Immobilize"],["slow","Slow"],["slowed","Slow"],["fear","Fear"],["feared","Fear"],["taunt","Taunt"],["taunted","Taunt"]]),Qn={Blind:"https://render.guildwars2.com/file/09770136BB76FD0DBE1CC4267DEED54774CB20F6/102837.png",Chill:"https://render.guildwars2.com/file/28C4EC547A3516AF0242E826772DA43A5EAC3DF3/102839.png",Cripple:"https://render.guildwars2.com/file/070325E519C178D502A8160523766070D30C0C19/102838.png",Fear:"https://render.guildwars2.com/file/30307A6E766D74B6EB09EDA12A4A2DE50E4D76F4/102869.png",Immobilize:"https://render.guildwars2.com/file/397A613651BFCA2832B6469CE34735580A2C120E/102844.png",Slow:"https://render.guildwars2.com/file/F60D1EF5271D7B9319610855676D320CD25F01C6/961397.png",Taunt:"https://render.guildwars2.com/file/02EED459AD65FAF7DF32A260E479C625070841B9/1228472.png",Vulnerability:"https://render.guildwars2.com/file/3A394C1A0A3257EB27A44842DDEEF0DF000E1241/102850.png",Weakness:"https://render.guildwars2.com/file/6CB0E64AF9AA292E332A38C1770CE577E2CDE0E8/102853.png"},ft=i=>{if(!i)return null;const r=i.trim().toLowerCase(),l=Xt.get(r);if(l)return l;const w=r.split(/[^a-z]+/).filter(Boolean);for(const R of w){const q=Xt.get(R);if(q)return q}return null},Xn=i=>ft(i),Zt=i=>{const r=new Map;return i&&(Object.values(i).forEach(l=>{if(!(l!=null&&l.icon)||!(l!=null&&l.name))return;const w=ft(l.name);w&&(r.has(w)||r.set(w,l.icon))}),Object.entries(Qn).forEach(([l,w])=>{r.has(l)||r.set(l,w)})),r},Nt=(i,r,l)=>{var w;if(r&&l){const R=(w=l[`b${r}`])==null?void 0:w.name,q=ft(R);if(q)return q}return i?ft(i):null},Zn=i=>{const r=(i==null?void 0:i.account)||"Unknown";return r&&r!=="Unknown"?r:(i==null?void 0:i.name)||"Unknown"||null},ei=i=>{if(!i||i.length===0)return 0;let r=0,l=null;return i.forEach(w=>{const R=Number(w[1]??0);if(Number.isFinite(R)){if(l===null){l=R;return}R>l&&(r+=R-l),l=R}}),r},ti=i=>{if(!i||i.length===0)return 0;let r=0;return i.forEach(l=>{const w=Number(l[0]??0),R=Number(l[1]??0);Number.isFinite(R)&&w!==0&&R>0&&(r+=1)}),r},ni=i=>{const{players:r,targets:l,skillMap:w,buffMap:R}=i,q=i.getPlayerKey||Zn,fe=Zt(R),X={},ge={};r.forEach(x=>{if(x!=null&&x.notInSquad)return;const W=q(x);W&&(X[W]||(X[W]={}),x!=null&&x.totalDamageDist&&x.totalDamageDist.forEach(pe=>{pe&&pe.forEach(U=>{if(!U.id)return;let oe=`Skill ${U.id}`,se;w&&(w[`s${U.id}`]?(oe=w[`s${U.id}`].name||oe,se=w[`s${U.id}`].icon||se):w[`${U.id}`]&&(oe=w[`${U.id}`].name||oe,se=w[`${U.id}`].icon||se));const ae=Nt(oe,U.id,R);if(!ae)return;const De=R==null?void 0:R[`b${U.id}`],Re=De==null?void 0:De.name,le=fe.get(ae)||(De==null?void 0:De.icon),Le=oe.startsWith("Skill ")?Re||ae:oe,Be=se||(De==null?void 0:De.icon),Te=Number(U.connectedHits??0),_e=Number(U.hits??0),Ne=Te>0?Te:_e,Ae=Number(U.totalDamage??0);if(!Number.isFinite(Ne)&&!Number.isFinite(Ae))return;const qe=ge[ae]||{name:ae,icon:le,applications:0,damage:0};qe.applications+=Number.isFinite(Ne)?Ne:0,qe.damage+=Number.isFinite(Ae)?Ae:0,!qe.icon&&le&&(qe.icon=le),ge[ae]=qe;const Ie=X[W][ae]||{icon:le,applications:0,damage:0,skills:{}};Ie.applications+=Number.isFinite(Ne)?Ne:0,Ie.damage+=Number.isFinite(Ae)?Ae:0;const xe=Ie.skills[Le]||{name:Le,hits:0,damage:0,icon:Be};xe.hits+=Number.isFinite(Ne)?Ne:0,xe.damage+=Number.isFinite(Ae)?Ae:0,!xe.icon&&Be&&(xe.icon=Be),Ie.skills[Le]=xe,!Ie.icon&&le&&(Ie.icon=le),X[W][ae]=Ie})}))});const Oe=new Map;r.forEach(x=>{if(x!=null&&x.notInSquad)return;const W=q(x);W&&x!=null&&x.name&&Oe.set(x.name,W)});let Ve=0,Se=0,ke=0;return l.forEach(x=>{x!=null&&x.buffs&&x.buffs.forEach(W=>{const pe=Number(W==null?void 0:W.id);if(!Number.isFinite(pe))return;const U=R==null?void 0:R[`b${pe}`],oe=ft(U==null?void 0:U.name);if(!oe||U!=null&&U.classification&&U.classification!=="Condition")return;const se=oe;if(!se)return;const ae=W.statesPerSource||{};ke+=1,Object.entries(ae).forEach(([De,Re])=>{var Ne;const le=Oe.get(De);if(!le)return;Se+=1;const Le=ei(Re),Be=ti(Re);Ve+=Le;const Te=((Ne=X[le])==null?void 0:Ne[se])||{applications:0,damage:0,skills:{}};Te.applicationsFromBuffs=(Te.applicationsFromBuffs||0)+Le,Te.applicationsFromBuffsActive=(Te.applicationsFromBuffsActive||0)+Be,X[le]=X[le]||{},X[le][se]=Te;const _e=ge[se]||{name:se,applications:0,damage:0};_e.applicationsFromBuffs=(_e.applicationsFromBuffs||0)+Le,_e.applicationsFromBuffsActive=(_e.applicationsFromBuffsActive||0)+Be,ge[se]=_e})})}),Object.values(X).forEach(x=>{Object.values(x).forEach(W=>{typeof W.applicationsFromBuffs=="number"&&(W.applications=W.applicationsFromBuffs)})}),Object.values(ge).forEach(x=>{typeof x.applicationsFromBuffs=="number"&&(x.applications=x.applicationsFromBuffs)}),{playerConditions:X,summary:ge,meta:{buffStateApplicationsTotal:Ve,targetBuffEntriesSeen:ke,buffStateSourcesSeen:Se}}},ii=new Set(["Vulnerability","Weakness","Blind","Cripple","Chill","Immobilize","Slow","Fear","Taunt"]),oi=[{id:"damage",label:"Damage",field:"damage",source:"dpsAll"},{id:"directDmg",label:"Direct Damage",field:"directDmg",source:"statsTargets"},{id:"connectedDamageCount",label:"Connected Damage Count",field:"connectedDamageCount",source:"statsTargets"},{id:"connectedDirectDamageCount",label:"Connected Direct Damage Count",field:"connectedDirectDamageCount",source:"statsTargets"},{id:"battleStandardHits",label:"Battle Standard Tracking"},{id:"criticalRate",label:"Critical Rate",field:"criticalRate",isRate:!0,isPercent:!0,denomField:"critableDirectDamageCount",source:"statsTargets"},{id:"criticalDmg",label:"Critical Damage",field:"criticalDmg",source:"statsTargets"},{id:"flankingRate",label:"Flanking Rate",field:"flankingRate",isRate:!0,isPercent:!0,denomField:"connectedDirectDamageCount",source:"statsTargets"},{id:"glanceRate",label:"Glance Rate",field:"glanceRate",isRate:!0,isPercent:!0,denomField:"connectedDirectDamageCount",source:"statsTargets"},{id:"missed",label:"Missed",field:"missed",source:"statsTargets"},{id:"evaded",label:"Evaded (enemy)",field:"evaded",source:"statsTargets"},{id:"blocked",label:"Blocked (enemy)",field:"blocked",source:"statsTargets"},{id:"interrupts",label:"Interrupts",field:"interrupts",source:"statsTargets"},{id:"invulned",label:"Invulned",field:"invulned",source:"statsTargets"},{id:"killed",label:"Killed",field:"killed",source:"statsTargets"},{id:"downed",label:"Downed",field:"downed",source:"statsTargets"},{id:"downContribution",label:"Down Contribution",field:"downContribution",source:"statsTargets"},{id:"downContributionPercent",label:"Down Contribution %",isRate:!0,isPercent:!0},{id:"againstDownedDamage",label:"Against Downed Damage",field:"againstDownedDamage",source:"statsTargets"},{id:"appliedCrowdControl",label:"Applied CC",field:"appliedCrowdControl",source:"statsTargets"},{id:"appliedCrowdControlDuration",label:"Applied CC Duration",field:"appliedCrowdControlDuration",source:"statsTargets"},{id:"appliedCrowdControlDownContribution",label:"Applied CC Down Contribution",field:"appliedCrowdControlDownContribution",source:"statsTargets"},{id:"appliedCrowdControlDurationDownContribution",label:"Applied CC Duration Down Contribution",field:"appliedCrowdControlDurationDownContribution",source:"statsTargets"},{id:"boonStrips",label:"Boon Strips",field:"boonStrips",source:"support"}],si=[{id:"damageTaken",label:"Damage Taken",field:"damageTaken"},{id:"damageTakenCount",label:"Damage Taken Count",field:"damageTakenCount"},{id:"conditionDamageTaken",label:"Condition Damage Taken",field:"conditionDamageTaken"},{id:"conditionDamageTakenCount",label:"Condition Damage Taken Count",field:"conditionDamageTakenCount"},{id:"powerDamageTaken",label:"Power Damage Taken",field:"powerDamageTaken"},{id:"powerDamageTakenCount",label:"Power Damage Taken Count",field:"powerDamageTakenCount"},{id:"downedDamageTaken",label:"Downed Damage Taken",field:"downedDamageTaken"},{id:"downedDamageTakenCount",label:"Downed Damage Taken Count",field:"downedDamageTakenCount"},{id:"damageBarrier",label:"Damage Barrier",field:"damageBarrier"},{id:"damageBarrierCount",label:"Damage Barrier Count",field:"damageBarrierCount"},{id:"blockedCount",label:"Blocked Count",field:"blockedCount"},{id:"evadedCount",label:"Evaded Count",field:"evadedCount"},{id:"missedCount",label:"Missed Count",field:"missedCount"},{id:"dodgeCount",label:"Dodge Count",field:"dodgeCount"},{id:"invulnedCount",label:"Invulnerable Count",field:"invulnedCount"},{id:"interruptedCount",label:"Interrupted Count",field:"interruptedCount"},{id:"downCount",label:"Down Count",field:"downCount"},{id:"deadCount",label:"Death Count",field:"deadCount"},{id:"boonStrips",label:"Boon Strips (Incoming)",field:"boonStrips"},{id:"conditionCleanses",label:"Cleanses (Incoming)",field:"conditionCleanses"},{id:"receivedCrowdControl",label:"Crowd Control (Incoming)",field:"receivedCrowdControl"}],ai=[{id:"condiCleanse",label:"Condition Cleanses",field:"condiCleanse"},{id:"condiCleanseTime",label:"Condition Cleanse Time",field:"condiCleanseTime",isTime:!0},{id:"condiCleanseSelf",label:"Condition Cleanse Self",field:"condiCleanseSelf"},{id:"condiCleanseTimeSelf",label:"Condition Cleanse Time Self",field:"condiCleanseTimeSelf",isTime:!0},{id:"boonStrips",label:"Boon Strips",field:"boonStrips"},{id:"boonStripsTime",label:"Boon Strips Time",field:"boonStripsTime",isTime:!0},{id:"boonStripDownContribution",label:"Boon Strip Down Contribution",field:"boonStripDownContribution"},{id:"boonStripDownContributionTime",label:"Boon Strip Down Contribution Time",field:"boonStripDownContributionTime",isTime:!0},{id:"stunBreak",label:"Stun Breaks",field:"stunBreak"},{id:"removedStunDuration",label:"Removed Stun Duration",field:"removedStunDuration",isTime:!0},{id:"resurrects",label:"Resurrects",field:"resurrects"},{id:"resurrectTime",label:"Resurrect Time",field:"resurrectTime",isTime:!0}],ri=["battle standard","glyph of renewal","glyph of the stars","illusion of life","spirit of nature","nature spirit","search and rescue","signet of mercy"],ci=new Set([10244]),li=(i,r)=>{var R;if(ci.has(i))return!0;const l=(r==null?void 0:r[`s${i}`])||(r==null?void 0:r[`${i}`]),w=((R=l==null?void 0:l.name)==null?void 0:R.toLowerCase())||"";return ri.some(q=>w.includes(q))},ui=i=>{if(!i||!Number.isFinite(i))return"--:--";const r=Math.max(0,Math.round(i/1e3)),l=Math.floor(r/3600),w=Math.floor(r%3600/60),R=r%60;return l>0?`${l}:${String(w).padStart(2,"0")}:${String(R).padStart(2,"0")}`:`${w}:${String(R).padStart(2,"0")}`},Tt={Guardian:"#72C1D9",Dragonhunter:"#72C1D9",Firebrand:"#72C1D9",Willbender:"#72C1D9",Revenant:"#D16E5A",Herald:"#D16E5A",Renegade:"#D16E5A",Vindicator:"#D16E5A",Warrior:"#FFD166",Berserker:"#FFD166",Spellbreaker:"#FFD166",Bladesworn:"#FFD166",Engineer:"#D09C59",Scrapper:"#D09C59",Holosmith:"#D09C59",Mechanist:"#D09C59",Ranger:"#8CDC82",Druid:"#8CDC82",Soulbeast:"#8CDC82",Untamed:"#8CDC82",Thief:"#C08F95",Daredevil:"#C08F95",Deadeye:"#C08F95",Specter:"#C08F95",Elementalist:"#F68A87",Tempest:"#F68A87",Weaver:"#F68A87",Catalyst:"#F68A87",Mesmer:"#B679D5",Chronomancer:"#B679D5",Mirage:"#B679D5",Virtuoso:"#B679D5",Necromancer:"#52A76F",Reaper:"#52A76F",Scourge:"#52A76F",Harbinger:"#52A76F",Ritualist:"#52A76F",Luminary:"#72C1D9",Conduit:"#D16E5A",Paragon:"#FFD166",Amalgam:"#D09C59",Galeshot:"#8CDC82",Antiquary:"#C08F95",Evoker:"#F68A87",Troubadour:"#B679D5",Unknown:"#64748B"};function en(i){return Tt[i]||Tt.Unknown}const mi=i=>{if(i==null||i==="")return 0;if(typeof i=="number")return!Number.isFinite(i)||i<=0?0:i>1e12?i:i*1e3;if(i instanceof Date){const fe=i.getTime();return Number.isFinite(fe)&&fe>0?fe:0}const r=String(i).trim();if(!r)return 0;const l=Number(r);if(Number.isFinite(l)&&l>0)return l>1e12?l:l*1e3;const w=Date.parse(r);if(Number.isFinite(w)&&w>0)return w;const R=r.replace(/([+-]\d{2})$/,"$1:00"),q=Date.parse(R);return Number.isFinite(q)&&q>0?q:0},Je=(i,r)=>mi((i==null?void 0:i.uploadTime)??(r==null?void 0:r.uploadTime)??(i==null?void 0:i.timeStartStd)??(i==null?void 0:i.timeStart)??(i==null?void 0:i.timeEndStd)??(i==null?void 0:i.timeEnd)??(i==null?void 0:i.timeStartText)??(i==null?void 0:i.timeEndText)),di=({logs:i,precomputedStats:r,mvpWeights:l,statsViewSettings:w,disruptionMethod:R})=>{const q=(()=>{const Se=i.filter(ke=>ke.details&&ke.details.players&&ke.details.players.length>0);return console.log("[useStatsAggregation] Filtering logs:",{total:i.length,passed:Se.length,statuses:i.map(ke=>ke.status),hasDetails:i.map(ke=>!!ke.details)}),Se})(),fe=w||Jn,X=l||Yn,ge=Se=>{if(!Se||typeof Se!="object")return Se;const ke=Array.isArray(Se.fightBreakdown)?Se.fightBreakdown:null;if(!ke||ke.length===0)return Se;const x=new Map,W=new Map;i.forEach(U=>{var ae;const oe=(U==null?void 0:U.filePath)||(U==null?void 0:U.id);oe&&x.set(String(oe),U);const se=(U==null?void 0:U.permalink)||((ae=U==null?void 0:U.details)==null?void 0:ae.permalink);typeof se=="string"&&se.trim()&&W.set(se.trim(),U)});const pe=ke.map(U=>{if(!U||typeof U!="object"||Number(U.timestamp)>0)return U;const se=U.id?String(U.id):"",ae=typeof U.permalink=="string"?U.permalink.trim():"",De=(se?x.get(se):void 0)||(ae?W.get(ae):void 0);if(!De)return U;const Re=Je(De==null?void 0:De.details,De);return Re?{...U,timestamp:Re}:U});return{...Se,fightBreakdown:pe}},Oe=(()=>{if(r)return ge(r);const Se=R||Gn,ke=fe.topSkillDamageSource||"target",x=fe.topSkillsMetric||"damage",W=q.length;let pe=0,U=0,oe=0,se=0,ae=0,De=0,Re=0,le=0;const Le=e=>{const n=((e==null?void 0:e.players)||[]).filter(z=>!z.notInSquad);let u=0,a=0,D=0,T=0;return n.forEach(z=>{var ne;const E=(ne=z.defenses)==null?void 0:ne[0];if(!E)return;const J=Number(E.downCount||0),ue=Number(E.deadCount||0);u+=J+ue,D+=ue}),n.forEach(z=>{!z.statsTargets||z.statsTargets.length===0||z.statsTargets.forEach(E=>{const J=E==null?void 0:E[0];if(!J)return;const ue=Number(J.downed||0),ne=Number(J.killed||0);a+=ue+ne,T+=ne})}),{squadDownsDeaths:u,enemyDownsDeaths:a,squadDeaths:D,enemyDeaths:T}},Be=e=>{const{squadDownsDeaths:t,enemyDownsDeaths:n}=Le(e);return t>0||n>0?n>t:typeof(e==null?void 0:e.success)=="boolean"?e.success:!1},Te=new Map,_e=new Set(["boonStripsTime","condiCleanseTime","condiCleanseTimeSelf"]),Ne={},Ae={},qe=new Map,Ie={},xe={},Fe={},Ze=new Map,Qe=new Map,At=new Set(Object.keys(Tt)),Mt=Object.keys(Tt).filter(e=>e&&e!=="Unknown").sort((e,t)=>t.length-e.length),wt=["Guardian","Revenant","Warrior","Engineer","Ranger","Thief","Elementalist","Mesmer","Necromancer"],st=e=>{if(!e)return"Unknown";const t=String(e).replace(/\s*\([^)]*\)\s*$/,"").replace(/\s*\[[^\]]*\]\s*$/,"").replace(/\s\d+$/,"").trim();if(At.has(t))return t;const n=t.toLowerCase();for(const a of Mt)if(n.includes(a.toLowerCase()))return a;return wt.find(a=>n.includes(a.toLowerCase()))||t||"Unknown"},gi=e=>e!=null&&e.classification?e.classification==="Boon":!0,vt=new Map,Et=new Map,gt=()=>({totalHits:0,blocked:0,evaded:0,glanced:0,missed:0,invulned:0,interrupted:0,totalMitigation:0,minMitigation:0}),ie=e=>{const t=Number(e);return Number.isFinite(t)?t:0},rn=e=>{const t=String(e).split("|"),n=t[0]||"Unknown",u=st(t[1]||"Unknown"),a=t[2]||n||"Unknown";return{name:n,profession:u,account:a}},cn=(e,t,n)=>{let u=e.get(t);return u?n.profession&&!u.professionList.includes(n.profession)&&u.professionList.push(n.profession):(u={account:n.account,name:n.name,profession:n.profession,professionList:n.profession?[n.profession]:[],activeMs:0,mitigationTotals:gt()},e.set(t,u)),u},ln=(e,t,n)=>{let u=e.get(t);return u?n.profession&&!u.professionList.includes(n.profession)&&u.professionList.push(n.profession):(u={account:n.account,name:n.name,profession:n.profession,professionList:n.profession?[n.profession]:[],activeMs:0,mitigationTotals:gt(),minion:n.minion},e.set(t,u)),u},un=(e,t)=>{e.totalHits+=ie((t==null?void 0:t.skill_hits)??(t==null?void 0:t.skillHits)),e.blocked+=ie(t==null?void 0:t.blocked),e.evaded+=ie(t==null?void 0:t.evaded),e.glanced+=ie(t==null?void 0:t.glanced),e.missed+=ie(t==null?void 0:t.missed),e.invulned+=ie(t==null?void 0:t.invulned),e.interrupted+=ie(t==null?void 0:t.interrupted),e.totalMitigation+=ie((t==null?void 0:t.avoided_damage)??(t==null?void 0:t.avoidedDamage)),e.minMitigation+=ie((t==null?void 0:t.min_avoided_damage)??(t==null?void 0:t.minAvoidedDamage))},pi=e=>Object.values(e).some(t=>t>0);console.log("[useStatsAggregation] Starting aggregation loop",{validLogsCount:q.length});const Ft=(e,t,n)=>{var D,T,z,E;const u=`s${e}`;if((D=t==null?void 0:t[u])!=null&&D.name)return t[u].name;if((T=t==null?void 0:t[String(e)])!=null&&T.name)return t[String(e)].name;const a=`b${e}`;return(z=n==null?void 0:n[a])!=null&&z.name?n[a].name:(E=n==null?void 0:n[String(e)])!=null&&E.name?n[String(e)].name:`Unknown Skill ${e}`},pt=new Map,at=e=>{const t=pt.get(e);if(!t)return{hasSkill:!1,avg:1,min:1,hits:0};const n=t.connectedHits||0,u=n>0?t.totalDamage/n:0,a=t.minCount>0?t.minTotal/t.minCount:0;return{hasSkill:!0,avg:u,min:a,hits:n}},Bt="Ashtonlightstone.9145",mn="Illusionary Warden",Ot=[],rt=[],Rt=[],_t=[],dn=new Map,fn=new Map,gn=(e,t,n)=>{const u=e.get(t)||gt();return u.totalHits+=n.totalHits,u.blocked+=n.blocked,u.evaded+=n.evaded,u.glanced+=n.glanced,u.missed+=n.missed,u.invulned+=n.invulned,u.interrupted+=n.interrupted,e.set(t,u),u};q.forEach(e=>{const t=e.details;if(!t)return;(t.targets||[]).forEach(u=>{const a=(u==null?void 0:u.totalDamageDist)||[],D=Array.isArray(a)?a[0]:null;D==null||D.forEach(T=>{if(!(T!=null&&T.id))return;const z=Number(T.id),E=pt.get(z)||{totalDamage:0,connectedHits:0,minTotal:0,minCount:0};E.totalDamage+=Number(T.totalDamage||0),E.connectedHits+=Number(T.connectedHits||0);const J=Number.isFinite(Number(T.min))?Number(T.min):0;E.minTotal+=J,E.minCount+=1,pt.set(z,E)})})}),q.forEach((e,t)=>{var Pe,je;const n=e.details;if(!n)return;const u=n.players;console.log(`[useStatsAggregation] Processing log ${t}:`,{playerCount:u==null?void 0:u.length,hasTargets:!!n.targets,firstPlayer:u!=null&&u[0]?{account:u[0].account,notInSquad:u[0].notInSquad}:"none"});const a=n.targets||[],D=n.skillMap||{},T=n.buffMap||{},z=new Map,E=new Map;a.forEach(o=>{const k=(o==null?void 0:o.totalDamageDist)||[],P=Array.isArray(k)?k[0]:null;P==null||P.forEach(d=>{var Z;if(!(d!=null&&d.id))return;const f=Number(d.id),p=((Z=D==null?void 0:D[f])==null?void 0:Z.name)||d.name||d.skillName||String(f),B=z.get(f)||{totalDamage:0,connectedHits:0,minTotal:0,minCount:0};B.totalDamage+=Number(d.totalDamage||0),B.connectedHits+=Number(d.connectedHits||0);const N=Number.isFinite(Number(d.min))?Number(d.min):0;B.minTotal+=N,B.minCount+=1,z.set(f,B);const V=E.get(p)||{totalDamage:0,connectedHits:0,minTotal:0,minCount:0};V.totalDamage+=Number(d.totalDamage||0),V.connectedHits+=Number(d.connectedHits||0);const ee=Number.isFinite(Number(d.min))?Number(d.min):0;V.minTotal+=ee,V.minCount+=1,E.set(p,V)})});const J=o=>{const k=z.get(o);if(!k||k.connectedHits<=0)return{avg:1,min:1};const P=k.connectedHits>0?k.totalDamage/k.connectedHits:0,d=k.minCount>0?k.minTotal/k.minCount:P;return{avg:P||1,min:d||1}},ue=o=>{const k=E.get(o);if(!k||k.connectedHits<=0)return{avg:1,min:1};const P=k.connectedHits>0?k.totalDamage/k.connectedHits:0,d=k.minCount>0?k.minTotal/k.minCount:P;return{avg:P||1,min:d||1}},ne=n.combatReplayMetaData||{},F=(ne==null?void 0:ne.inchToPixel)>0?ne.inchToPixel:1,$=(ne==null?void 0:ne.pollingRate)>0?ne.pollingRate:1,O=5e3,G=o=>Array.isArray(o)?o.map(k=>Array.isArray(k)?[Number(k[0]),Number(k[1])]:null).filter(k=>!!k&&Number.isFinite(k[0])):[];let me=[],c=n.durationMS||0,g=!1;const h=u.find(o=>(o==null?void 0:o.hasCommanderTag)&&!(o!=null&&o.notInSquad));(Pe=h==null?void 0:h.combatReplayData)!=null&&Pe.positions&&(me=h.combatReplayData.positions,G(h.combatReplayData.dead).forEach(([k])=>{k>0&&(g=!0,c=Math.min(c,k))}));const A=o=>{var V;const k=(V=o.statsAll)==null?void 0:V[0];if((k==null?void 0:k.distToCom)!==void 0&&(k==null?void 0:k.distToCom)!=="Infinity")return Math.round(Number(k.distToCom));if((k==null?void 0:k.stackDist)!==void 0)return Math.round(Number(k.stackDist))||0;if(o.hasCommanderTag)return 0;const P=o.combatReplayData;if(!(P!=null&&P.positions)||!me.length)return 0;const d=P.positions,f=G(P.dead),p=G(P.down),B=Math.floor((P.start||0)/$);let N=0;if(f.length&&p.length)for(const[ee]of f){if(ee<0)continue;const Z=Math.max(0,Math.floor(ee/$))-B;for(const[H,_]of p){if(ee!==_)continue;const K=g&&H>c?Math.max(1,Math.floor(c/$)):Z,be=Math.max(0,Math.min(K,d.length,me.length));if(be<=0)continue;let Y=0;for(let Me=0;Me<be;Me++){const[Q,Ce]=d[Me],[he,de]=me[Me];Y+=Math.hypot(Q-he,Ce-de)}N=Math.round(Y/be/F)}}return N},v=u.filter(o=>!o.notInSquad);oe+=v.length,se+=a.filter(o=>!o.isFake).length,Kn(u,{durationMS:n.durationMS,buffMap:n.buffMap});const{squadDeaths:I,enemyDeaths:s}=Le(n);ae+=I,De+=s,le+=I,Re+=s,Be(n)?pe++:U++;const b=n.skillMap?Number((je=Object.keys(n.skillMap).find(o=>{var k,P;return((P=(k=n.skillMap)==null?void 0:k[o])==null?void 0:P.name)==="Battle Standard"}))==null?void 0:je.replace(/^s/,"")):null;u.forEach((o,k)=>{var et,tt,ct,lt,Ht,bt,ht,Dn,Nn,Tn,An,Mn;if(o.notInSquad)return;const P=o.account||"Unknown",d=P!=="Unknown"?P:o.name||"Unknown",f=o.name||"Unknown";Te.has(d)||Te.set(d,{name:f,account:d,downContrib:0,cleanses:0,strips:0,stab:0,healing:0,barrier:0,cc:0,logsJoined:0,totalDist:0,distCount:0,dodges:0,downs:0,deaths:0,totalFightMs:0,offenseTotals:{},offenseRateWeights:{},defenseActiveMs:0,defenseTotals:{},supportActiveMs:0,supportTotals:{},healingActiveMs:0,healingTotals:{},profession:o.profession||"Unknown",professions:new Set,professionTimeMs:{},isCommander:!1,damage:0,dps:0,revives:0,outgoingConditions:{},incomingConditions:{}});const p=Te.get(d);if(o.hasCommanderTag&&(p.isCommander=!0),o.profession&&o.profession!=="Unknown"){p.profession=o.profession,p.professions.add(o.profession);const m=Array.isArray(o.activeTimes)&&typeof o.activeTimes[0]=="number"?o.activeTimes[0]:n.durationMS||0;p.professionTimeMs[o.profession]=(p.professionTimeMs[o.profession]||0)+m}p.logsJoined++,p.downContrib+=Wn(o),p.cleanses+=qn(o),p.strips+=jn(o,Se),p.healing+=Vn(o),p.barrier+=zn(o),p.cc+=yn(o,Se),p.stab+=o.stabGeneration||0;const B=A(o);B<=O&&(p.totalDist+=B,p.distCount++),(et=o.defenses)!=null&&et[0]&&(p.dodges+=o.defenses[0].dodgeCount||0,p.downs+=o.defenses[0].downCount||0,p.deaths+=o.defenses[0].deadCount||0),n.durationMS&&(p.totalFightMs+=n.durationMS);const N=Array.isArray(o.activeTimes)&&typeof o.activeTimes[0]=="number"?o.activeTimes[0]:n.durationMS||0;p.defenseActiveMs+=N,p.supportActiveMs+=N,p.healingActiveMs+=N,Array.isArray(o.buffUptimes)&&o.buffUptimes.length>0&&o.buffUptimes.forEach(m=>{var wn,vn,En,Fn;if(typeof(m==null?void 0:m.id)!="number")return;const S=`b${m.id}`,M=((wn=n.buffMap)==null?void 0:wn[S])||((vn=n.buffMap)==null?void 0:vn[String(m.id)]);if(!M||gi(M))return;const te=Number(((Fn=(En=m.buffData)==null?void 0:En[0])==null?void 0:Fn.uptime)??0);if(!Number.isFinite(te)||te<=0)return;const He=(M==null?void 0:M.stacking)??!1,ye=(He?te:te/100)*N;if(!Number.isFinite(ye)||ye<=0)return;const $e=Xn(M==null?void 0:M.name);if($e&&ii.has($e)&&(!(M!=null&&M.classification)||M.classification==="Condition")){const Ut=ye/1e3,Ke=M==null?void 0:M.icon,kt=Ie[$e]||{name:$e,icon:Ke,applications:0,damage:0};kt.applicationsFromUptime=(kt.applicationsFromUptime||0)+Ut,!kt.icon&&Ke&&(kt.icon=Ke),Ie[$e]=kt;const Ct=p.outgoingConditions[$e]||{applications:0,damage:0,skills:{},icon:Ke};Ct.applicationsFromUptime=(Ct.applicationsFromUptime||0)+Ut,!Ct.icon&&Ke&&(Ct.icon=Ke),p.outgoingConditions[$e]=Ct;const St=xe[$e]||{name:$e,icon:Ke,applications:0,damage:0};St.applicationsFromUptime=(St.applicationsFromUptime||0)+Ut,!St.icon&&Ke&&(St.icon=Ke),xe[$e]=St;const Dt=p.incomingConditions[$e]||{applications:0,damage:0,skills:{},icon:Ke};Dt.applicationsFromUptime=(Dt.applicationsFromUptime||0)+Ut,!Dt.icon&&Ke&&(Dt.icon=Ke),p.incomingConditions[$e]=Dt}Ze.has(S)||Ze.set(S,{name:M==null?void 0:M.name,stacking:He,icon:M==null?void 0:M.icon}),Qe.has(S)||Qe.set(S,new Map);const ot=Qe.get(S),mt=p.account||o.account||o.name||"Unknown";let it=ot.get(mt);it||(it={account:mt,profession:p.profession||o.profession||"Unknown",professions:new Set,professionTimeMs:{},totalMs:0,durationMs:0},ot.set(mt,it));const dt=o.profession||p.profession;dt&&dt!=="Unknown"&&(it.professions.add(dt),it.professionTimeMs[dt]=(it.professionTimeMs[dt]||0)+N,it.profession=dt),it.totalMs+=ye,it.durationMs+=N}),(tt=o.defenses)!=null&&tt[0]&&si.forEach(m=>{const S=Number(o.defenses[0][m.field]??0);Number.isFinite(S)&&(p.defenseTotals[m.id]=(p.defenseTotals[m.id]||0)+S)}),(ct=o.support)!=null&&ct[0]&&ai.forEach(m=>{let S=Number(o.support[0][m.field]??0);Number.isFinite(S)&&(_e.has(m.field)&&S>999999&&(S=0),p.supportTotals[m.id]=(p.supportTotals[m.id]||0)+S)});const V=(m,S)=>{Number.isFinite(S)&&(p.healingTotals[m]=(p.healingTotals[m]||0)+S)},ee=(m,S)=>Array.isArray(m)?m.reduce((M,te)=>M+Number((te==null?void 0:te[S])??0),0):0,Z=(m,S,M)=>{if(!Number.isFinite(M)||M<=0)return;const te=u[S],He=S===k,nt=te==null?void 0:te.notInSquad,ye=!nt,$e=ye&&(te==null?void 0:te.group)!=null&&te.group===o.group;V(m,M),ye&&V(`squad${m[0].toUpperCase()}${m.slice(1)}`,M),$e&&V(`group${m[0].toUpperCase()}${m.slice(1)}`,M),He&&V(`self${m[0].toUpperCase()}${m.slice(1)}`,M),nt&&V(`offSquad${m[0].toUpperCase()}${m.slice(1)}`,M)};if(Array.isArray(o.rotation)){let m=0;o.rotation.forEach(S=>{var te;if(!(S!=null&&S.id)||!li(S.id,n.skillMap))return;const M=((te=S.skills)==null?void 0:te.length)||0;M>0&&(m+=M,V(`resUtility_s${S.id}`,M))}),m>0&&V("resUtility",m)}const H=(lt=o.extHealingStats)==null?void 0:lt.outgoingHealingAllies;Array.isArray(H)&&H.forEach((m,S)=>{const M=ee(m,"healing"),te=ee(m,"downedHealing");Z("healing",S,M),Z("downedHealing",S,te)});const _=(Ht=o.extBarrierStats)==null?void 0:Ht.outgoingBarrierAllies;Array.isArray(_)&&_.forEach((m,S)=>{const M=ee(m,"barrier");Z("barrier",S,M)});const K=(bt=o.statsAll)==null?void 0:bt[0],be=(ht=o.dpsAll)==null?void 0:ht[0],Y=(Dn=o.support)==null?void 0:Dn[0];if(oi.forEach(m=>{if(m.id==="downContributionPercent"||!m.field)return;let S=0,M=0;m.source==="dpsAll"&&be?S=Number(be[m.field]??0):m.source==="statsAll"&&K?(S=Number(K[m.field]??0),M=Number(K[m.denomField||m.weightField||"connectedDamageCount"]??0)):m.source==="support"&&Y?S=Number(Y[m.field]??0):o.statsTargets&&o.statsTargets.forEach(te=>{te!=null&&te[0]&&(S+=Number(te[0][m.field]??0),M+=Number(te[0][m.denomField||m.weightField||"connectedDamageCount"]??0))}),Number.isFinite(S)&&(p.offenseTotals[m.id]=(p.offenseTotals[m.id]||0)+S,m.isRate&&M>0&&(p.offenseRateWeights[m.id]=(p.offenseRateWeights[m.id]||0)+M))}),o.targetDamageDist&&Number.isFinite(b)){const m=o.targetDamageDist.flatMap(S=>S||[]).flatMap(S=>S||[]).reduce((S,M)=>M!=null&&M.id&&M.id===b?S+((M==null?void 0:M.connectedHits)||0):S,0);p.offenseTotals.battleStandardHits=(p.offenseTotals.battleStandardHits||0)+m}p.revives+=((Tn=(Nn=o.support)==null?void 0:Nn[0])==null?void 0:Tn.resurrects)||0,be&&(p.damage+=be.damage||0,p.dps+=be.dps||0);const Me=m=>{var He,nt,ye,$e;let S=`Skill ${m.id}`;const M=((He=n.skillMap)==null?void 0:He[`s${m.id}`])||((nt=n.skillMap)==null?void 0:nt[`${m.id}`]);let te=M==null?void 0:M.icon;if(M!=null&&M.name&&(S=M.name),S.startsWith("Skill ")){const ot=Nt(S,m.id,n.buffMap);ot&&(S=ot,te=(($e=(ye=n.buffMap)==null?void 0:ye[`b${m.id}`])==null?void 0:$e.icon)||te)}return{name:S,icon:te}},Q=m=>{if(!(m!=null&&m.id))return;const{name:S,icon:M}=Me(m);Ne[m.id]||(Ne[m.id]={name:S,icon:M,damage:0,hits:0,downContribution:0}),Ne[m.id].name.startsWith("Skill ")&&!S.startsWith("Skill ")&&(Ne[m.id].name=S),!Ne[m.id].icon&&M&&(Ne[m.id].icon=M),Ne[m.id].damage+=m.totalDamage,Ne[m.id].hits+=m.connectedHits,Ne[m.id].downContribution+=Number(m.downContribution||0)},Ce=o.account||o.name||"Unknown",he=o.profession||"Unknown",de=`${Ce}|${he}`;let we=qe.get(de);we||(we={key:de,account:Ce,displayName:Ce,profession:he,professionList:[he],totalFightMs:0,skills:new Map},qe.set(de,we)),we.professionList.includes(he)||we.professionList.push(he),we.totalFightMs+=n.durationMS||0;const We=m=>{if(!(m!=null&&m.id))return;const{name:S,icon:M}=Me(m),te=`s${m.id}`;let He=we.skills.get(te);He||(He={id:te,name:S,icon:M,damage:0,downContribution:0},we.skills.set(te,He)),He.name.startsWith("Skill ")&&!S.startsWith("Skill ")&&(He.name=S),!He.icon&&M&&(He.icon=M),He.damage+=Number(m.totalDamage||0),He.downContribution+=Number(m.downContribution||0)};ke==="total"?(An=o.totalDamageDist)==null||An.forEach(m=>{m==null||m.forEach(S=>{Q(S),We(S)})}):(Mn=o.targetDamageDist)==null||Mn.forEach(m=>{m==null||m.forEach(S=>{S==null||S.forEach(M=>{Q(M),We(M)})})}),o.totalDamageTaken&&o.totalDamageTaken.forEach(m=>{m==null||m.forEach(S=>{var nt,ye,$e,ot;if(!(S!=null&&S.id))return;let M=`Skill ${S.id}`;const te=((nt=n.skillMap)==null?void 0:nt[`s${S.id}`])||((ye=n.skillMap)==null?void 0:ye[`${S.id}`]);let He=te==null?void 0:te.icon;if(te!=null&&te.name&&(M=te.name),M.startsWith("Skill ")){const mt=Nt(M,S.id,n.buffMap);mt&&(M=mt,He=((ot=($e=n.buffMap)==null?void 0:$e[`b${S.id}`])==null?void 0:ot.icon)||He)}Ae[S.id]||(Ae[S.id]={name:M,icon:He,damage:0,hits:0}),(!Ae[S.id].name.startsWith("Skill ")||M.startsWith("Skill "))&&(Ae[S.id].name=M),!Ae[S.id].icon&&He&&(Ae[S.id].icon=He),Ae[S.id].damage+=S.totalDamage,Ae[S.id].hits+=S.hits})})}),a.forEach(o=>{if(o!=null&&o.isFake)return;const k=st((o==null?void 0:o.profession)||(o==null?void 0:o.name)||(o==null?void 0:o.id));k&&(Fe[k]=(Fe[k]||0)+1)});const C=ni({players:u,targets:a,skillMap:n.skillMap,buffMap:n.buffMap,getPlayerKey:o=>o.account&&o.account!=="Unknown"?o.account:o.name||null}),j=Zt(n.buffMap);Object.entries(C.playerConditions).forEach(([o,k])=>{const P=Te.get(o);P&&Object.entries(k).forEach(([d,f])=>{const p=P.outgoingConditions[d]||{applications:0,damage:0,skills:{},icon:f.icon};p.applications+=Number(f.applications||0),p.damage+=Number(f.damage||0),f.applicationsFromBuffs&&(p.applicationsFromBuffs=(p.applicationsFromBuffs||0)+f.applicationsFromBuffs),f.applicationsFromBuffsActive&&(p.applicationsFromBuffsActive=(p.applicationsFromBuffsActive||0)+f.applicationsFromBuffsActive),Object.entries(f.skills||{}).forEach(([B,N])=>{const V=p.skills[B]||{name:N.name,hits:0,damage:0,icon:N.icon};V.hits+=Number(N.hits||0),V.damage+=Number(N.damage||0),!V.icon&&N.icon&&(V.icon=N.icon),p.skills[B]=V}),!p.icon&&f.icon&&(p.icon=f.icon),P.outgoingConditions[d]=p})}),Object.entries(C.summary).forEach(([o,k])=>{const P=Ie[o]||{name:k.name||o,icon:k.icon,applications:0,damage:0};P.applications+=Number(k.applications||0),P.damage+=Number(k.damage||0),k.applicationsFromBuffs&&(P.applicationsFromBuffs=(P.applicationsFromBuffs||0)+k.applicationsFromBuffs),k.applicationsFromBuffsActive&&(P.applicationsFromBuffsActive=(P.applicationsFromBuffsActive||0)+k.applicationsFromBuffsActive),!P.icon&&k.icon&&(P.icon=k.icon),Ie[o]=P}),v.forEach(o=>{const k=o.account&&o.account!=="Unknown"?o.account:o.name||"Unknown",P=Te.get(k);!P||!o.totalDamageTaken||o.totalDamageTaken.forEach(d=>d==null?void 0:d.forEach(f=>{var Me,Q,Ce,he,de,we;if(!(f!=null&&f.id))return;let p=`Skill ${f.id}`;const B=((Me=n.skillMap)==null?void 0:Me[`s${f.id}`])||((Q=n.skillMap)==null?void 0:Q[`${f.id}`]);B!=null&&B.name&&(p=B.name);const N=Nt(p,f.id,n.buffMap);if(!N)return;const V=(he=(Ce=n.buffMap)==null?void 0:Ce[`b${f.id}`])==null?void 0:he.name,ee=j.get(N)||((we=(de=n.buffMap)==null?void 0:de[`b${f.id}`])==null?void 0:we.icon),Z=(B==null?void 0:B.icon)||ee;p.startsWith("Skill ")&&(V||N)&&(p=V||N);const H=Number(f.hits??0),_=Number(f.totalDamage??0),K=xe[N]||{name:N,icon:ee,applications:0,damage:0};K.applications+=Number.isFinite(H)?H:0,K.damage+=Number.isFinite(_)?_:0,!K.icon&&ee&&(K.icon=ee),xe[N]=K;const be=P.incomingConditions[N]||{applications:0,damage:0,skills:{},icon:ee};be.applications+=Number.isFinite(H)?H:0,be.damage+=Number.isFinite(_)?_:0;const Y=be.skills[p]||{name:p,hits:0,damage:0,icon:Z};Y.hits+=Number.isFinite(H)?H:0,Y.damage+=Number.isFinite(_)?_:0,!Y.icon&&Z&&(Y.icon=Z),be.skills[p]=Y,!be.icon&&ee&&(be.icon=ee),P.incomingConditions[N]=be}))});const y=n.player_damage_mitigation||n.playerDamageMitigation,re=y&&typeof y=="object"&&Object.keys(y).length>0;re&&Object.entries(y).forEach(([o,k])=>{if(!k||typeof k!="object")return;const P=rn(o),d=cn(vt,P.account,P);Object.values(k).forEach(f=>{ie((f==null?void 0:f.avoided_damage)??(f==null?void 0:f.avoidedDamage))<=0||un(d.mitigationTotals,f)})});const Ee=n.player_minion_damage_mitigation||n.playerMinionDamageMitigation,ce=Ee&&typeof Ee=="object"&&Object.keys(Ee).length>0;ce&&Object.entries(Ee).forEach(([o,k])=>{if(!k||typeof k!="object")return;const P=rn(o);Object.entries(k).forEach(([d,f])=>{if(!f||typeof f!="object")return;const p=`${P.account}::${d}`,B=ln(Et,p,{...P,minion:String(d||"Unknown")});Object.values(f).forEach(N=>{un(B.mitigationTotals,N)})})}),(!re||!ce)&&(re||v.forEach(o=>{const k=(o==null?void 0:o.totalDamageTaken)||[];if(!Array.isArray(k)||k.length===0)return;const P=o.account||o.name||"Unknown",d={account:P,name:o.name||P,profession:st(o.profession||"Unknown")};cn(vt,P,d);const f=n.skillMap||{},p=n.buffMap||{},B=Array.isArray(k)?k[0]:null;if(B==null||B.forEach(N=>{if(!(N!=null&&N.id))return;const V=ie(N.blocked),ee=ie(N.evaded),Z=ie(N.glance??N.glanced),H=ie(N.missed),_=ie(N.invulned),K=ie(N.interrupted),be=ie(N.hits??N.connectedHits),Y=Number(N.id),Me=Ft(Y,f,p);if(gn(dn,`${P}::${Y}`,{totalHits:be,blocked:V,evaded:ee,glanced:Z,missed:H,invulned:_,interrupted:K}),P===Bt){const Q=pt.get(Y),Ce=at(Y),he=Ce.hasSkill?Ce.hits>0?Ce.avg:0:1,de=Ce.hasSkill?Ce.min||0:1,we=Ce.hits>0?Z*he/2+(V+ee+H+_+K)*he:0,We=Ce.hits>0?Z*de/2+(V+ee+H+_+K)*de:0;Rt.push({logId:e.filePath||e.id||t,skillId:N.id,skillName:Me,blocked:V,evaded:ee,glanced:Z,missed:H,invulned:_,interrupted:K,totalAvoids:V+ee+Z+H+_+K,avg:he,min:de,enemyHits:(Q==null?void 0:Q.connectedHits)??0,enemyTotalDmg:(Q==null?void 0:Q.totalDamage)??0,avoidDmg:we,avoidMinDmg:We})}}),P===Bt){const N=(V,ee)=>{let Z=0,H=0,_=0;if(!Array.isArray(V))return{total:Z,minTotal:H,hits:_};for(const K of V){if(!(K!=null&&K.id))continue;const be=ie(K.blocked),Y=ie(K.evaded),Me=ie(K.glance??K.glanced),Q=ie(K.missed),Ce=ie(K.invulned),he=ie(K.interrupted),de=Ft(Number(K.id),D,T),we=ee(Number(K.id),de);(we.hits??0)>0&&(Z+=Me*we.avg/2+(be+Y+Q+Ce+he)*we.avg,H+=Me*we.min/2+(be+Y+Q+Ce+he)*we.min),_+=ie(K.hits??K.connectedHits)}return{total:Z,minTotal:H,hits:_}};_t.push({logId:e.filePath||e.id||t,variant:"current_global_name_taken0",...N(B,(V,ee)=>{const Z=at(V),H=Z.hasSkill?Z.hits>0?Z.avg:0:1,_=Z.hasSkill?Z.min||0:1;return{avg:H,min:_,hits:Z.hits}})})}}),ce||v.forEach(o=>{const k=(o==null?void 0:o.minions)||[];if(!Array.isArray(k)||k.length===0)return;const P=o.account||o.name||"Unknown",d={account:P,name:o.name||P,profession:st(o.profession||"Unknown")},f=n.skillMap||{},p=n.buffMap||{};k.forEach(B=>{const N=(B==null?void 0:B.totalDamageTakenDist)||[];if(!Array.isArray(N)||N.length===0)return;let V=String((B==null?void 0:B.name)||"Unknown").replace(/^Juvenile\s+/i,"")||"Unknown";V.toUpperCase().includes("UNKNOWN")&&(V="Unknown");const ee=`${P}::${V}`;ln(Et,ee,{...d,minion:V});const Z=Array.isArray(N)?N[0]:null;if(Z==null||Z.forEach(H=>{if(!(H!=null&&H.id))return;const _=ie(H.blocked),K=ie(H.evaded),be=ie(H.glance??H.glanced),Y=ie(H.missed),Me=ie(H.invulned),Q=ie(H.interrupted),Ce=ie(H.hits??H.connectedHits),he=Number(H.id),de=Ft(he,f,p);if(gn(fn,`${ee}::${he}`,{totalHits:Ce,blocked:_,evaded:K,glanced:be,missed:Y,invulned:Me,interrupted:Q}),P===Bt&&V===mn){const we=pt.get(he),We=at(he),et=We.hasSkill?We.hits>0?We.avg:0:1,tt=We.hasSkill?We.min||0:1,ct=We.hits>0?be*et/2+(_+K+Y+Me+Q)*et:0,lt=We.hits>0?be*tt/2+(_+K+Y+Me+Q)*tt:0;Ot.push({logId:e.filePath||e.id||t,skillId:H.id,skillName:de,blocked:_,evaded:K,glanced:be,missed:Y,invulned:Me,interrupted:Q,totalAvoids:_+K+be+Y+Me+Q,avg:et,min:tt,enemyHits:(we==null?void 0:we.connectedHits)??0,enemyTotalDmg:(we==null?void 0:we.totalDamage)??0,avoidDmg:ct,avoidMinDmg:lt})}}),P===Bt&&V===mn){const H=(Y,Me)=>{let Q=0,Ce=0,he=0;if(!Array.isArray(Y))return{total:Q,minTotal:Ce,hits:he};for(const de of Y){if(!(de!=null&&de.id))continue;const we=ie(de.blocked),We=ie(de.evaded),et=ie(de.glance??de.glanced),tt=ie(de.missed),ct=ie(de.invulned),lt=ie(de.interrupted),Ht=Ft(Number(de.id),D,T),{avg:bt,min:ht}=Me(Number(de.id),Ht);ie(de.hits??de.connectedHits)>0&&(Q+=et*bt/2+(we+We+tt+ct+lt)*bt,Ce+=et*ht/2+(we+We+tt+ct+lt)*ht),he+=ie(de.hits??de.connectedHits)}return{total:Q,minTotal:Ce,hits:he}},_=Array.isArray(N)?N[0]||[]:[],K=Array.isArray(N)?N.flat():[],be=Array.isArray(B==null?void 0:B.totalDamageTaken)?B.totalDamageTaken[0]||[]:[];rt.push({logId:e.filePath||e.id||t,variant:"current_global_name_dist0",...H(_,(Y,Me)=>{const Q=at(Y),Ce=Q.hasSkill?Q.hits>0?Q.avg:0:1,he=Q.hasSkill&&Q.min||0;return{avg:Ce,min:he}})}),rt.push({logId:e.filePath||e.id||t,variant:"local_name_dist0",...H(_,(Y,Me)=>ue(Me))}),rt.push({logId:e.filePath||e.id||t,variant:"local_id_dist0",...H(_,Y=>J(Y))}),rt.push({logId:e.filePath||e.id||t,variant:"global_name_alllists",...H(K,(Y,Me)=>{const Q=at(Y),Ce=Q.hasSkill?Q.hits>0?Q.avg:0:1,he=Q.hasSkill&&Q.min||0;return{avg:Ce,min:he}})}),rt.push({logId:e.filePath||e.id||t,variant:"global_name_taken0",...H(be,(Y,Me)=>{const Q=at(Y),Ce=Q.hasSkill?Q.hits>0?Q.avg:0:1,he=Q.hasSkill&&Q.min||0;return{avg:Ce,min:he}})})}})}))}),Ot.length>0&&(console.groupCollapsed("[Mitigation Debug] Ashtonlightstone.9145 / Illusionary Warden"),console.table(Ot),rt.length>0&&console.table(rt),console.groupEnd()),Rt.length>0&&(console.groupCollapsed("[Mitigation Debug] Ashtonlightstone.9145 / Player"),console.table(Rt),_t.length>0&&console.table(_t),console.groupEnd());const pn=(e,t)=>{const n=new Map,u=a=>{let D=n.get(a);return D||(D=gt(),n.set(a,D)),D};t.forEach((a,D)=>{const T=D.lastIndexOf("::"),z=T>-1?D.slice(0,T):D,E=T>-1?Number(D.slice(T+2)):Number.NaN,J=Number.isFinite(E)?at(E):{hasSkill:!1,avg:0,min:0,hits:0};if(!J.hasSkill||J.hits<=0)return;const ue=J.avg,ne=J.min,F=a.glanced*ue/2+(a.blocked+a.evaded+a.missed+a.invulned+a.interrupted)*ue,$=a.glanced*ne/2+(a.blocked+a.evaded+a.missed+a.invulned+a.interrupted)*ne;if(F<=0)return;const O=u(z);O.totalHits+=a.totalHits,O.blocked+=a.blocked,O.evaded+=a.evaded,O.glanced+=a.glanced,O.missed+=a.missed,O.invulned+=a.invulned,O.interrupted+=a.interrupted,O.totalMitigation+=F,O.minMitigation+=$}),e.forEach((a,D)=>{const T=n.get(D)||gt();a.mitigationTotals.totalHits=T.totalHits,a.mitigationTotals.blocked=T.blocked,a.mitigationTotals.evaded=T.evaded,a.mitigationTotals.glanced=T.glanced,a.mitigationTotals.missed=T.missed,a.mitigationTotals.invulned=T.invulned,a.mitigationTotals.interrupted=T.interrupted,a.mitigationTotals.totalMitigation=T.totalMitigation,a.mitigationTotals.minMitigation=T.minMitigation})};pn(vt,dn),pn(Et,fn);const bi=W>0?Math.round(oe/W):0,hi=W>0?Math.round(se/W):0,ki=ae>0?(De/ae).toFixed(2):De>0?"∞":"0.00",Ci=Re>0?(le/Re).toFixed(2):le>0?"∞":"0.00",bn=(e,t)=>{const u=e.filter(T=>Number.isFinite(T.value)&&(t?T.value>0:T.value>=0)).sort((T,z)=>{const E=t?z.value-T.value:T.value-z.value;return E!==0?E:T.account.localeCompare(z.account)});let a=null,D=0;return u.map((T,z)=>((a===null||T.value!==a)&&(D=z+1,a=T.value),{rank:D,...T}))},qt=Array.from(Te.values()).map(e=>{const t=Array.from(e.professions).filter(n=>n!=="Unknown");if(e.professionList=t,t.length>0){let n=t[0],u=e.professionTimeMs[n]||0;t.forEach(a=>{const D=e.professionTimeMs[a]||0;D>u&&(u=D,n=a)}),e.profession=n}return{key:e.account,stat:e}}),hn=e=>{const t=Te.get(e.account);if(!t){const a=e.professionList.length>0?e.professionList:e.profession?[e.profession]:[];return{...e,professionList:a}}const n=t.professionList&&t.professionList.length>0?t.professionList:Array.from(t.professions||[]).filter(a=>a&&a!=="Unknown"),u=t.profession||e.profession;return{...e,profession:u,professionList:n.length>0?n:u?[u]:[],activeMs:t.defenseActiveMs||t.totalFightMs||e.activeMs}},Si=Array.from(vt.values()).map(hn).filter(e=>pi(e.mitigationTotals)).sort((e,t)=>e.account.localeCompare(t.account)),Di=Array.from(Et.values()).map(hn).filter(e=>e.mitigationTotals.totalMitigation>0).sort((e,t)=>{const n=e.account.localeCompare(t.account);return n!==0?n:String(e.minion||"").localeCompare(String(t.minion||""))}),It=(e,t)=>{switch(t){case"downContrib":return e.downContrib;case"barrier":return e.barrier;case"healing":return e.healing;case"dodges":return e.dodges;case"strips":return e.strips;case"cleanses":return e.cleanses;case"cc":return e.cc;case"stability":return e.stab;case"revives":return e.revives;case"dps":return e.dps;case"damage":return e.damage;case"participation":return e.logsJoined;case"closestToTag":return!e.isCommander&&e.distCount>0?e.totalDist/e.distCount:Number.POSITIVE_INFINITY;default:return 0}},ze=(e,t)=>bn(qt.map(({stat:n})=>({account:n.account,profession:n.profession,professionList:n.professionList,value:It(n,e),count:n.logsJoined})),t),Ue={downContrib:ze("downContrib",!0),barrier:ze("barrier",!0),healing:ze("healing",!0),dodges:ze("dodges",!0),strips:ze("strips",!0),cleanses:ze("cleanses",!0),cc:ze("cc",!0),stability:ze("stability",!0),revives:ze("revives",!0),participation:ze("participation",!0),dps:ze("dps",!0),damage:ze("damage",!0),closestToTag:ze("closestToTag",!1).filter(e=>Number.isFinite(e.value))},Ni={downContrib:"downContrib",barrier:"barrier",healing:"healing",dodges:"dodges",strips:"strips",cleanses:"cleanses",cc:"cc",stability:"stability",closestToTag:"closestToTag"},ve=e=>{const t=e==null?void 0:e[0];return{value:(t==null?void 0:t.value)??0,player:(t==null?void 0:t.account)??"-",count:(t==null?void 0:t.count)??0,profession:(t==null?void 0:t.profession)??"Unknown",professionList:(t==null?void 0:t.professionList)??[]}},Xe={maxDownContrib:ve([]),maxBarrier:ve([]),maxHealing:ve([]),maxDodges:ve([]),maxStrips:ve([]),maxCleanses:ve([]),maxCC:ve([]),maxStab:ve([]),closestToTag:ve([])},Ye={},Ti=(e,t)=>{if(t==="closestToTag")return It(e,t);const n=Math.max(1,(e.totalFightMs||0)/1e3);return It(e,t)/n};Object.values(Ni).forEach(e=>{const t=e!=="closestToTag";Ye[e]=bn(qt.map(({stat:n})=>({account:n.account,profession:n.profession,professionList:n.professionList,value:Ti(n,e),count:n.logsJoined})),t)}),Xe.maxDownContrib=ve(Ye.downContrib),Xe.maxBarrier=ve(Ye.barrier),Xe.maxHealing=ve(Ye.healing),Xe.maxDodges=ve(Ye.dodges),Xe.maxStrips=ve(Ye.strips),Xe.maxCleanses=ve(Ye.cleanses),Xe.maxCC=ve(Ye.cc),Xe.maxStab=ve(Ye.stability),Xe.closestToTag=ve(Ye.closestToTag);const Ai={maxDownContrib:ve(Ue.downContrib),maxBarrier:ve(Ue.barrier),maxHealing:ve(Ue.healing),maxDodges:ve(Ue.dodges),maxStrips:ve(Ue.strips),maxCleanses:ve(Ue.cleanses),maxCC:ve(Ue.cc),maxStab:ve(Ue.stability),closestToTag:ve(Ue.closestToTag)};let jt={player:"None",account:"None",score:-1,profession:"Unknown",professionList:[],color:"#64748b",topStats:[]},kn,Cn,Sn=0;if(fe!=null&&fe.showMvp){const e={"Down Contribution":"downContribution",Healing:"healing",Cleanses:"cleanses",Strips:"strips",Stability:"stability",CC:"cc",Revives:"revives","Distance to Tag":"distanceToTag",Participation:"participation",Dodging:"dodging",DPS:"dps",Damage:"damage"},t=D=>{const T=e[D];return T?Number(X[T]||0)>0:!1},n=[],u=D=>[...D||[]].filter(T=>t(T==null?void 0:T.name)).sort((T,z)=>z.ratio-T.ratio||T.rank-z.rank||T.name.localeCompare(z.name)).slice(0,3),a=D=>{var z;if(!D)return;const T=u(D.contribs);return{...D,player:D.name,reason:((z=T[0])==null?void 0:z.name)||"Top Performance",topStats:T}};qt.forEach(({stat:D})=>{let T=0;const z=[],E=(J,ue,ne,F,$=!0)=>{var G,me;if(ne<=0)return;const O=((G=ue[0])==null?void 0:G.value)||0;if(O&&Number.isFinite(J)&&($?J>0:J<Number.POSITIVE_INFINITY)){const c=$?J/O:O/J;T+=c*ne;const g=((me=ue.find(h=>h.account===D.account))==null?void 0:me.rank)||0;z.push({name:F,ratio:c,val:J.toLocaleString(),rank:g})}};E(D.downContrib,Ue.downContrib,X.downContribution,"Down Contribution"),E(D.healing,Ue.healing,X.healing,"Healing"),E(D.cleanses,Ue.cleanses,X.cleanses,"Cleanses"),E(D.strips,Ue.strips,X.strips,"Strips"),E(D.stab,Ue.stability,X.stability,"Stability"),E(D.cc,Ue.cc,X.cc,"CC"),E(D.revives,Ue.revives,X.revives,"Revives"),E(It(D,"closestToTag"),Ue.closestToTag,X.distanceToTag,"Distance to Tag",!1),E(D.logsJoined,Ue.participation,X.participation,"Participation"),E(D.dodges,Ue.dodges,X.dodging,"Dodging"),E(D.dps,Ue.dps,X.dps,"DPS"),E(D.damage,Ue.damage,X.damage,"Damage"),n.push({...D,score:T,contribs:z.filter(J=>t(J.name))})}),n.sort((D,T)=>T.score-D.score),n[0]&&n[0].score>0&&(jt=a(n[0])||jt),kn=a(n[1]),Cn=a(n[2]),Sn=n.length>0?n.reduce((D,T)=>D+T.score,0)/n.length:0}const Mi=Object.values(Ne).sort((e,t)=>{const n=x==="downContribution"?e.downContribution:e.damage;return(x==="downContribution"?t.downContribution:t.damage)-n}).slice(0,25),wi=Object.values(Ae).sort((e,t)=>t.damage-e.damage).slice(0,25),vi=e=>{const t=String(e).replace(/^Detailed\s*WvW\s*-\s*/i,"").replace(/^World\s*vs\s*World\s*-\s*/i,"").replace(/^WvW\s*-\s*/i,"").trim(),n=t.match(/^(Red|Blue|Green)\s+(?:Alpine|Desert)?\s*Borderlands$/i);return n?`${n[1]} Borderlands`:t||"Unknown"},Pt=(e,t)=>vi((e==null?void 0:e.zone)||(e==null?void 0:e.mapName)||(e==null?void 0:e.map)||(e==null?void 0:e.location)||(e==null?void 0:e.fightName)||(t==null?void 0:t.fightName)||(t==null?void 0:t.encounterName)||"Unknown"),Ei=(e,t)=>{const n=(t==null?void 0:t.permalink)||(e==null?void 0:e.permalink);if(typeof n=="string"&&n.trim().length>0)return n.trim();const u=e==null?void 0:e.uploadLinks;if(!Array.isArray(u))return"";for(const a of u){if(typeof a=="string"&&a.trim().length>0)return a.trim();if(a&&typeof a=="object"){const D=a.permalink||a.link||a.url||a.reportLink;if(typeof D=="string"&&D.trim().length>0)return D.trim()}}return""},Wt={};q.forEach(e=>{const t=Pt(e==null?void 0:e.details,e);Wt[t]=(Wt[t]||0)+1});const Fi=Object.entries(Wt).map(([e,t])=>{const n=String(e).trim(),u=/eternal battlegrounds|^ebg$/i.test(n);let a="#64748b";return u?a="#ffffff":/red/i.test(n)?a="#ef4444":/blue/i.test(n)?a="#3b82f6":/green/i.test(n)&&(a="#22c55e"),{name:e,value:t,color:a}}).sort((e,t)=>t.value-e.value),{boonTables:Bi}=In(q),Ii=q.map((e,t)=>{var u,a;const n=((u=e.details)==null?void 0:u.players)||[];return{index:t+1,label:`Log ${t+1}`,timestamp:Je(e.details,e),squadCount:n.filter(D=>!D.notInSquad).length,friendlyCount:n.length,enemies:((a=e.details)==null?void 0:a.targets).filter(D=>!D.isFake).length}}).sort((e,t)=>e.timestamp-t.timestamp),Vt={};Array.from(Te.values()).forEach(e=>{e.profession&&e.profession!=="Unknown"&&(Vt[e.profession]=(Vt[e.profession]||0)+1)});const Pi=Object.entries(Vt).map(([e,t])=>({name:e,value:t,color:en(e)})).sort((e,t)=>t.value-e.value),zt={};Object.keys(Fe).length===0&&q.forEach(e=>{var t,n;(n=(t=e.details)==null?void 0:t.targets)==null||n.forEach(u=>{if(u.isFake)return;const a=u.profession&&u.profession!=="Unknown"?u.profession:u.name||u.id||"Unknown",D=st(a);zt[D]=(zt[D]||0)+1})});const Hi=Object.keys(Fe).length>0?Fe:zt,Ui=Object.entries(Hi).map(([e,t])=>({name:e,value:t,color:en(e)})).sort((e,t)=>t.value-e.value),Li=q.map((e,t)=>({log:e,originalIndex:t})).sort((e,t)=>Je(e.log.details,e.log)-Je(t.log.details,t.log)).map(({log:e},t)=>{const n=e.details;if(!n)return null;const u=n.players||[],a=u.filter(s=>!s.notInSquad),D=u.filter(s=>s.notInSquad),T=n.targets||[],z=T.filter(s=>!s.isFake),E=a.reduce((s,L)=>{var b,C;return s+(((C=(b=L.dpsAll)==null?void 0:b[0])==null?void 0:C.damage)||0)},0),J=a.reduce((s,L)=>{var b,C;return s+(((C=(b=L.defenses)==null?void 0:b[0])==null?void 0:C.damageTaken)||0)},0),{enemyDeaths:ue,enemyDownsDeaths:ne}=Le(n),F=Be(n),$=Je(n,e),O=Pt(n,e),G={red:0,green:0,blue:0},me=s=>{const L=Number(s);return Number.isFinite(L)?L:0},c=s=>{if(!s||typeof s!="object")return;const L=s.teamID??s.teamId??s.team??s.teamColor??s.team_color;if(L!=null)return L;const b=Object.keys(s).find(C=>/^team/i.test(C));return b?s[b]:void 0},g=(s,L)=>{if(s==null)return null;if(typeof s=="string"){const b=s.toLowerCase();return b.includes("red")?"red":b.includes("green")?"green":b.includes("blue")?"blue":b==="r"?"red":b==="g"?"green":b==="b"?"blue":null}if(typeof s=="number")if(L==="zeroBased"){if(s===0)return"red";if(s===1)return"green";if(s===2)return"blue"}else{if(s===1)return"red";if(s===2)return"green";if(s===3)return"blue"}return null},h=(s,L)=>{const b={};return s.forEach(C=>{const j=L(C),y=st(j);y&&(b[y]=(b[y]||0)+1)}),b},A=h(a,s=>(s==null?void 0:s.profession)||(s==null?void 0:s.name)),v=h(D,s=>(s==null?void 0:s.profession)||(s==null?void 0:s.name)),I=h(z,s=>(s==null?void 0:s.profession)||(s==null?void 0:s.name)||(s==null?void 0:s.id));if(n.teamCounts&&typeof n.teamCounts=="object"){const s=n.teamCounts;G.red=me(s.red??s.r??s[0]??s[1]),G.green=me(s.green??s.g??s[1]??s[2]),G.blue=me(s.blue??s.b??s[2]??s[3])}else{const s=[];T.forEach(j=>{if(j!=null&&j.isFake)return;const y=c(j);y!=null&&s.push(y)}),u.forEach(j=>{if(!(j!=null&&j.notInSquad))return;const y=c(j);y!=null&&s.push(y)}),s.length===0&&u.forEach(j=>{const y=c(j);y!=null&&s.push(y)});const L=new Set;s.forEach(j=>{typeof j=="number"&&L.add(j)});const b=L.has(0)?"zeroBased":L.has(3)?"oneBased":"zeroBased";if(s.forEach(j=>{const y=g(j,b);y&&(G[y]+=1)}),G.red+G.green+G.blue===0&&s.length>0){const j=new Map;s.forEach(re=>{const Ee=String(re);j.set(Ee,(j.get(Ee)||0)+1)});const y=Array.from(j.values()).sort((re,Ee)=>Ee-re);G.red=y[0]||0,G.green=y[1]||0,G.blue=y[2]||0}G.red+G.green+G.blue===0&&(G.red=Math.max(z.length,u.filter(j=>j==null?void 0:j.notInSquad).length))}return{id:e.filePath||`fight-${t}`,label:e.encounterName||`Fight ${t+1}`,permalink:Ei(n,e),timestamp:$,mapName:O,duration:ui(n.durationMS),isWin:F,squadCount:a.length,allyCount:D.length,enemyCount:z.length,teamCounts:G,alliesDown:a.reduce((s,L)=>{var b,C;return s+(((C=(b=L.defenses)==null?void 0:b[0])==null?void 0:C.downCount)||0)},0),alliesDead:a.reduce((s,L)=>{var b,C;return s+(((C=(b=L.defenses)==null?void 0:b[0])==null?void 0:C.deadCount)||0)},0),alliesRevived:a.reduce((s,L)=>{var b,C;return Number(((C=(b=L.statsAll)==null?void 0:b[0])==null?void 0:C.saved)||0)>0?s+1:s},0),rallies:0,enemyDeaths:ue,enemyDowns:Math.max(0,ne-ue),totalOutgoingDamage:E,totalIncomingDamage:J,incomingBarrierAbsorbed:a.reduce((s,L)=>{var b,C;return s+(((C=(b=L.defenses)==null?void 0:b[0])==null?void 0:C.damageBarrier)||0)},0),outgoingBarrierAbsorbed:a.reduce((s,L)=>{var j;const b=(j=L.extBarrierStats)==null?void 0:j.outgoingBarrier;if(!Array.isArray(b))return s;let C=0;return b.forEach(y=>{if(Array.isArray(y)){y.forEach(re=>{C+=Number((re==null?void 0:re.barrier)||0)});return}C+=Number((y==null?void 0:y.barrier)||0)}),s+C},0),squadClassCountsFight:A,allyClassCountsFight:v,enemyClassCounts:I}}).filter(Boolean),$i=(e,t)=>{const n=(t==null?void 0:t.skillMap)||{},u=(t==null?void 0:t.buffMap)||{};let a=0,D="";const T=E=>{const J=Number(E);if(!Number.isFinite(J))return String(E||"Unknown Skill");const ue=(n==null?void 0:n[`s${J}`])||(n==null?void 0:n[`${J}`]);if(ue!=null&&ue.name)return String(ue.name);const ne=(u==null?void 0:u[`b${J}`])||(u==null?void 0:u[`${J}`]);return ne!=null&&ne.name?String(ne.name):`Skill ${J}`},z=E=>{if(!E||typeof E!="object")return;const J=[Number(E.max),Number(E.maxDamage),Number(E.maxHit),Number(E.totalDamage)>0&&Number(E.connectedHits)>0?Number(E.totalDamage)/Number(E.connectedHits):0].filter(ne=>Number.isFinite(ne)),ue=J.length>0?Math.max(...J):0;ue>a&&(a=ue,D=T(E.id))};return Array.isArray(e==null?void 0:e.totalDamageDist)&&e.totalDamageDist.forEach(E=>{Array.isArray(E)&&E.forEach(J=>z(J))}),Array.isArray(e==null?void 0:e.targetDamageDist)&&e.targetDamageDist.forEach(E=>{Array.isArray(E)&&E.forEach(J=>{Array.isArray(J)&&J.forEach(ue=>z(ue))})}),{peak:a,skillName:D||"Unknown Skill"}},xi=(()=>{const e=F=>String(F||"").replace(/^Detailed\s*WvW\s*-\s*/i,"").replace(/^World\s*vs\s*World\s*-\s*/i,"").replace(/^WvW\s*-\s*/i,"").trim(),t=F=>e(F).toLowerCase().split(/[^a-z0-9]+/i).map($=>$.trim()).filter(Boolean).map($=>$.length>3&&$.endsWith("s")?$.slice(0,-1):$),n=(F,$)=>{const O=e(F),G=e($);if(!G)return O;if(!O)return G;const me=t(O),c=t(G),g=new Set(me),h=new Set(c),A=c.length>0&&c.every(I=>g.has(I)),v=me.length>0&&me.every(I=>h.has(I));return A||v?O:`${O} - ${G}`},u=[],a=new Map,D=F=>{const $=A=>{if(!Array.isArray(A)||A.length===0)return[];const v=[];for(let I=0;I<A.length;I+=1){const s=Number(A[I]||0),L=I>0?Number(A[I-1]||0):0;v.push(Math.max(0,s-L))}return v},O=A=>{if(!Array.isArray(A))return[];const v=A.reduce((s,L)=>Math.max(s,Array.isArray(L)?L.length:0),0);if(v<=0)return[];const I=new Array(v).fill(0);return A.forEach(s=>{if(Array.isArray(s))for(let L=0;L<v;L+=1)I[L]+=Number(s[L]||0)}),I},G=A=>Array.isArray(A)?A.map(v=>Number(v||0)):null,c=(A=>{if(!Array.isArray(A)||A.length===0)return null;const v=A[0];if(!Array.isArray(v))return null;if(Array.isArray(v[0])&&Array.isArray(v[0][0]))return O(v);if(Array.isArray(v[0])&&!Array.isArray(v[0][0])){const I=A.map(s=>G(Array.isArray(s)?s[0]:null)).filter(s=>Array.isArray(s)&&s.length>0);if(I.length>0)return O(I)}return null})(F==null?void 0:F.targetDamage1S),g=Array.isArray(F==null?void 0:F.damage1S)&&Array.isArray(F.damage1S[0])?F.damage1S[0]:null,h=c||(Array.isArray(g)?g.map(A=>Number(A||0)):[]);return $(h)},T=(F,$)=>{if(!Array.isArray(F)||F.length===0||$<=0)return 0;let O=0,G=0;for(let me=0;me<F.length;me+=1)O+=Number(F[me]||0),me>=$&&(O-=Number(F[me-$]||0)),me>=$-1&&O>G&&(G=O);return Math.max(0,G)},z=(F,$)=>{if(!Array.isArray(F)||F.length===0||$<=0)return[];const O=[];for(let G=0;G<F.length;G+=$){const me=Math.min(G+$,F.length),c=F.slice(G,me).reduce((g,h)=>g+Number(h||0),0);O.push(c)}return O},E=F=>Array.isArray(F)?F.map($=>Array.isArray($)?[Number($[0]),Number($[1])]:$&&typeof $=="object"?[Number($.time),Number($.value)]:null).filter($=>!!$&&Number.isFinite($[0])&&$[0]>=0):[],J=(F,$,O,G,me)=>{if(!F.length||G<=0)return[];const c=Math.max(G*5e3,me||0),g=C=>C.reduce((j,y)=>y>=0&&y<=c+2e3?j+1:j,0),h=F.map(C=>Number(C||0)).filter(C=>Number.isFinite(C)&&C>=0);if(!h.length)return[];const A=[h],v=h.reduce((C,j)=>Math.max(C,j),0),I=h.reduce((C,j)=>Math.min(C,j),Number.POSITIVE_INFINITY);v>c*20&&A.push(h.map(C=>C/1e3)),v<=c*2&&I>=0&&v>0&&v<Math.max(120,G*5+10)&&A.push(h.map(C=>C*1e3));let s=h,L=0,b=-1;return A.forEach(C=>{const j=C.reduce((re,Ee)=>Math.min(re,Ee),Number.POSITIVE_INFINITY),y=new Set([0,...$,...O]);if(Number.isFinite(j)&&c>0&&j>c){const re=Math.floor(j/c)*c;y.add(re),y.add(Math.max(0,re-c))}y.forEach(re=>{const Ee=C.map(Pe=>Pe-re),ce=g(Ee);ce>b&&(b=ce,L=re,s=C)})}),s.map(C=>C-L).filter(C=>Number.isFinite(C)&&C>=0)},ue=(F,$,O,G,me)=>{const c=J(F,$,O,G,me);return Array.from(new Set(c.map(g=>Math.floor(g/5e3)).filter(g=>Number.isFinite(g)&&g>=0&&g<G)))};q.map(F=>({log:F,ts:Je(F==null?void 0:F.details,F)})).sort((F,$)=>F.ts-$.ts).forEach(({log:F},$)=>{const O=F==null?void 0:F.details;if(!O)return;const G=e(O.fightName||F.fightName||`Fight ${$+1}`),me=Pt(O,F),c=n(G,String(me||"")),g={},h=Array.isArray(O.players)?O.players:[],A=h.flatMap(b=>{const C=b==null?void 0:b.combatReplayData;return Array.isArray(C)?C.map(j=>Number(j==null?void 0:j.start)):[Number(C==null?void 0:C.start)]}).filter(b=>Number.isFinite(b)&&b>=0);h.forEach(b=>{if(b!=null&&b.notInSquad)return;const C=String((b==null?void 0:b.account)||(b==null?void 0:b.name)||"Unknown"),j=String((b==null?void 0:b.character_name)||(b==null?void 0:b.display_name)||(b==null?void 0:b.name)||""),y=String((b==null?void 0:b.profession)||"Unknown"),re=`${C}|${y}`,Ee=$i(b,O),ce=Number(Ee.peak||0),Pe=D(b),je=Number(T(Pe,1)||0),o=Number(T(Pe,5)||0),k=Number(T(Pe,30)||0),P=Math.max(0,Math.ceil(Number((O==null?void 0:O.durationMS)||0)/5e3)),d=Math.max(0,Math.ceil(Pe.length/5)),f=Math.max(P,d),p=z(Pe,5),B=Array.from({length:f},(_,K)=>Number(p[K]||0)),N=(()=>{const _=b==null?void 0:b.combatReplayData;return Array.isArray(_)?_.filter(K=>K&&typeof K=="object"):_&&typeof _=="object"?[_]:[]})(),V=N.map(_=>Number(_==null?void 0:_.start)).filter(_=>Number.isFinite(_)&&_>=0),ee=N.flatMap(_=>E(_==null?void 0:_.down).map(([K])=>Number(K||0))),Z=N.flatMap(_=>E(_==null?void 0:_.dead).map(([K])=>Number(K||0)));g[re]={hit:ce,burst1s:je,burst5s:o,burst30s:k,skillName:Ee.skillName,buckets5s:B,downIndices5s:ue(ee,V,A,f,Number((O==null?void 0:O.durationMS)||0)),deathIndices5s:ue(Z,V,A,f,Number((O==null?void 0:O.durationMS)||0))};const H=a.get(re)||{key:re,account:C,displayName:C,characterName:j,profession:y,professionList:[y],logs:0,peakHit:0,peak1s:0,peak5s:0,peak30s:0,peakFightLabel:"",peakSkillName:""};H.logs+=1,H.professionList.includes(y)||H.professionList.push(y),!H.characterName&&j&&(H.characterName=j),ce>H.peakHit&&(H.peakHit=ce,H.peakFightLabel=c,H.peakSkillName=Ee.skillName),je>H.peak1s&&(H.peak1s=je),o>H.peak5s&&(H.peak5s=o),k>H.peak30s&&(H.peak30s=k),a.set(re,H)});const v=Object.values(g).reduce((b,C)=>Math.max(b,Number((C==null?void 0:C.hit)||0)),0),I=Object.values(g).reduce((b,C)=>Math.max(b,Number((C==null?void 0:C.burst1s)||0)),0),s=Object.values(g).reduce((b,C)=>Math.max(b,Number((C==null?void 0:C.burst5s)||0)),0),L=Object.values(g).reduce((b,C)=>Math.max(b,Number((C==null?void 0:C.burst30s)||0)),0);u.push({id:F.filePath||F.id||`fight-${$+1}`,shortLabel:`F${$+1}`,fullLabel:c,timestamp:Je(O,F),values:g,maxHit:v,max1s:I,max5s:s,max30s:L})});const ne=Array.from(a.values()).sort((F,$)=>$.peakHit!==F.peakHit?$.peakHit-F.peakHit:F.displayName.localeCompare($.displayName));return{fights:u,players:ne}})(),Oi=(()=>{const e=c=>String(c||"").replace(/^Detailed\s*WvW\s*-\s*/i,"").replace(/^World\s*vs\s*World\s*-\s*/i,"").replace(/^WvW\s*-\s*/i,"").trim(),t=c=>e(c).toLowerCase().split(/[^a-z0-9]+/i).map(g=>g.trim()).filter(Boolean).map(g=>g.length>3&&g.endsWith("s")?g.slice(0,-1):g),n=(c,g)=>{const h=e(c),A=e(g);if(!A)return h;if(!h)return A;const v=t(h),I=t(A),s=new Set(v),L=new Set(I),b=I.length>0&&I.every(j=>s.has(j)),C=v.length>0&&v.every(j=>L.has(j));return b||C?h:`${h} - ${A}`},u=[],a=new Map,D=(c,g)=>{const h=Number(c);if(!Number.isFinite(h))return String(c||"Unknown Skill");const A=(g==null?void 0:g.skillMap)||{},v=(g==null?void 0:g.buffMap)||{},I=(A==null?void 0:A[`s${h}`])||(A==null?void 0:A[`${h}`]);if(I!=null&&I.name)return String(I.name);const s=(v==null?void 0:v[`b${h}`])||(v==null?void 0:v[`${h}`]);return s!=null&&s.name?String(s.name):`Skill ${h}`},T=(c,g)=>{let h=0,A="";const v=I=>{if(!I||typeof I!="object"||I.indirectDamage)return;const s=[Number(I.max),Number(I.maxDamage),Number(I.maxHit),Number(I.totalDamage)>0&&Number(I.connectedHits)>0?Number(I.totalDamage)/Number(I.connectedHits):0].filter(b=>Number.isFinite(b)),L=s.length>0?Math.max(...s):0;L>h&&(h=L,A=D(I.id,g))};return Array.isArray(c==null?void 0:c.totalDamageDist)&&c.totalDamageDist.forEach(I=>{Array.isArray(I)&&I.forEach(s=>v(s))}),Array.isArray(c==null?void 0:c.targetDamageDist)&&c.targetDamageDist.forEach(I=>{Array.isArray(I)&&I.forEach(s=>{Array.isArray(s)&&s.forEach(L=>v(L))})}),{peak:h,skillName:A||"Unknown Skill"}},z=c=>{if(!Array.isArray(c)||c.length===0)return[];const g=[];for(let h=0;h<c.length;h+=1){const A=Number(c[h]||0),v=h>0?Number(c[h-1]||0):0;g.push(Math.max(0,A-v))}return g},E=c=>{if(!Array.isArray(c)||c.length===0)return[];const g=c.reduce((A,v)=>Math.max(A,Array.isArray(v)?v.length:0),0);if(g<=0)return[];const h=new Array(g).fill(0);return c.forEach(A=>{if(Array.isArray(A))for(let v=0;v<g;v+=1)h[v]+=Number(A[v]||0)}),h},J=c=>{if(!Array.isArray(c)||c.length===0)return[];const g=c[0];if(typeof g=="number")return c.map(h=>Number(h||0));if(Array.isArray(g)&&g.length>0){if(typeof g[0]=="number")return g.map(h=>Number(h||0));if(Array.isArray(g[0])){const h=g.map(A=>Array.isArray(A)?A.map(v=>Number(v||0)):null).filter(A=>Array.isArray(A)&&A.length>0);if(h.length>0)return E(h)}}return[]},ue=c=>{const g=J(c==null?void 0:c.powerDamage1S),h=J(c==null?void 0:c.damage1S),A=g.length>0?g:h;return z(A)},ne=(c,g)=>{if(!Array.isArray(c)||c.length===0||g<=0)return 0;let h=0,A=0;for(let v=0;v<c.length;v+=1)h+=Number(c[v]||0),v>=g&&(h-=Number(c[v-g]||0)),v>=g-1&&h>A&&(A=h);return Math.max(0,A)},F=(c,g)=>{if(!Array.isArray(c)||c.length===0||g<=0)return[];const h=[];for(let A=0;A<c.length;A+=g){const v=Math.min(A+g,c.length),I=c.slice(A,v).reduce((s,L)=>s+Number(L||0),0);h.push(I)}return h},$=c=>Array.isArray(c)?c.map(g=>Array.isArray(g)?[Number(g[0]),Number(g[1])]:g&&typeof g=="object"?[Number(g.time),Number(g.value)]:null).filter(g=>!!g&&Number.isFinite(g[0])&&g[0]>=0):[],O=(c,g,h,A,v)=>{if(!c.length||A<=0)return[];const I=Math.max(A*5e3,v||0),s=ce=>ce.reduce((Pe,je)=>je>=0&&je<=I+2e3?Pe+1:Pe,0),L=c.map(ce=>Number(ce||0)).filter(ce=>Number.isFinite(ce)&&ce>=0);if(!L.length)return[];const b=[L],C=L.reduce((ce,Pe)=>Math.max(ce,Pe),0),j=L.reduce((ce,Pe)=>Math.min(ce,Pe),Number.POSITIVE_INFINITY);C>I*20&&b.push(L.map(ce=>ce/1e3)),C<=I*2&&j>=0&&C>0&&C<Math.max(120,A*5+10)&&b.push(L.map(ce=>ce*1e3));let y=L,re=0,Ee=-1;return b.forEach(ce=>{const Pe=ce.reduce((o,k)=>Math.min(o,k),Number.POSITIVE_INFINITY),je=new Set([0,...g,...h]);if(Number.isFinite(Pe)&&I>0&&Pe>I){const o=Math.floor(Pe/I)*I;je.add(o),je.add(Math.max(0,o-I))}je.forEach(o=>{const k=ce.map(d=>d-o),P=s(k);P>Ee&&(Ee=P,re=o,y=ce)})}),y.map(ce=>ce-re).filter(ce=>Number.isFinite(ce)&&ce>=0)},G=(c,g,h,A,v)=>{const I=O(c,g,h,A,v);return Array.from(new Set(I.map(s=>Math.floor(s/5e3)).filter(s=>Number.isFinite(s)&&s>=0&&s<A)))};q.map(c=>({log:c,ts:Je(c==null?void 0:c.details,c)})).sort((c,g)=>c.ts-g.ts).forEach(({log:c},g)=>{const h=c==null?void 0:c.details;if(!h)return;const A=e(h.fightName||c.fightName||`Fight ${g+1}`),v=Pt(h,c),I=n(A,String(v||"")),s={},L=Array.isArray(h.players)?h.players:[],b=L.filter(d=>!(d!=null&&d.notInSquad)),C=b.flatMap(d=>{const f=d==null?void 0:d.combatReplayData;return Array.isArray(f)?f.map(p=>Number(p==null?void 0:p.start)):[Number(f==null?void 0:f.start)]}).filter(d=>Number.isFinite(d)&&d>=0),j=b.flatMap(d=>{const f=d==null?void 0:d.combatReplayData;return(Array.isArray(f)?f:f?[f]:[]).flatMap(B=>$(B==null?void 0:B.down).map(([N])=>Number(N||0)))}),y=b.flatMap(d=>{const f=d==null?void 0:d.combatReplayData;return(Array.isArray(f)?f:f?[f]:[]).flatMap(B=>$(B==null?void 0:B.dead).map(([N])=>Number(N||0)))}),re=new Map,Ee=new Map;(Array.isArray(h.targets)?h.targets:[]).forEach(d=>{if(!d||d.isFake||!d.enemyPlayer)return;const f=st((d==null?void 0:d.profession)||(d==null?void 0:d.name)||(d==null?void 0:d.id))||"Unknown";Ee.set(f,(Ee.get(f)||0)+1);const p=ue(d),B=T(d,h);let N=re.get(f);N||(N={perSecond:[],hit:0,skillName:""},re.set(f,N)),p.length>N.perSecond.length&&(N.perSecond.length=p.length);for(let ee=0;ee<p.length;ee+=1)N.perSecond[ee]=Number(N.perSecond[ee]||0)+Number(p[ee]||0);const V=Number(B.peak||0);V>N.hit&&(N.hit=V,N.skillName=B.skillName||"Unknown Skill")});const Pe=Array.from(re.values()).some(d=>Array.isArray(d.perSecond)&&d.perSecond.some(f=>Number(f||0)>0));if(re.size===0||!Pe){const d=L.filter(B=>!(B!=null&&B.notInSquad)),f=E(d.map(B=>{const N=J(B==null?void 0:B.powerDamageTaken1S);return z(N)})),p=Array.from(Ee.values()).reduce((B,N)=>B+Number(N||0),0);f.length>0&&p>0&&Ee.forEach((B,N)=>{const V=Number(B||0)/p,ee=f.map(H=>Number(H||0)*V),Z=re.get(N);re.set(N,{perSecond:ee,hit:Number((Z==null?void 0:Z.hit)||0),skillName:String((Z==null?void 0:Z.skillName)||"")})})}re.forEach((d,f)=>{const p=f,B=Number(d.hit||0),N=Number(ne(d.perSecond,1)||0),V=Number(ne(d.perSecond,5)||0),ee=Number(ne(d.perSecond,30)||0),Z=Math.max(0,Math.ceil(Number((h==null?void 0:h.durationMS)||0)/5e3)),H=Math.max(0,Math.ceil(d.perSecond.length/5)),_=Math.max(Z,H),K=F(d.perSecond,5),be=Array.from({length:_},(Me,Q)=>Number(K[Q]||0));s[p]={hit:B,burst1s:N,burst5s:V,burst30s:ee,skillName:d.skillName||"Unknown Skill",buckets5s:be,downIndices5s:G(j,[],C,_,Number((h==null?void 0:h.durationMS)||0)),deathIndices5s:G(y,[],C,_,Number((h==null?void 0:h.durationMS)||0))};const Y=a.get(p)||{key:p,account:f,displayName:f,characterName:"",profession:f,professionList:[f],logs:0,peakHit:0,peak1s:0,peak5s:0,peak30s:0,peakFightLabel:"",peakSkillName:""};Y.logs+=1,B>Y.peakHit&&(Y.peakHit=B,Y.peakFightLabel=I,Y.peakSkillName=d.skillName||"Unknown Skill"),N>Y.peak1s&&(Y.peak1s=N),V>Y.peak5s&&(Y.peak5s=V),ee>Y.peak30s&&(Y.peak30s=ee),a.set(p,Y)});const je=Object.values(s).reduce((d,f)=>Math.max(d,Number((f==null?void 0:f.hit)||0)),0),o=Object.values(s).reduce((d,f)=>Math.max(d,Number((f==null?void 0:f.burst1s)||0)),0),k=Object.values(s).reduce((d,f)=>Math.max(d,Number((f==null?void 0:f.burst5s)||0)),0),P=Object.values(s).reduce((d,f)=>Math.max(d,Number((f==null?void 0:f.burst30s)||0)),0);u.push({id:c.filePath||c.id||`fight-${g+1}`,shortLabel:`F${g+1}`,fullLabel:I,timestamp:Je(h,c),values:s,maxHit:je,max1s:o,max5s:k,max30s:P})});const me=Array.from(a.values()).sort((c,g)=>g.peakHit!==c.peakHit?g.peakHit-c.peakHit:c.displayName.localeCompare(g.displayName));return{fights:u,players:me}})(),Ri=Array.from(Qe.entries()).map(([e,t])=>{const n=Ze.get(e)||{},u=Array.from(t.values()).map(a=>{var ue;const D=Array.from(a.professions||[]).filter(ne=>ne&&ne!=="Unknown");let T=a.profession||"Unknown";if(D.length>0){T=D[0];let ne=((ue=a.professionTimeMs)==null?void 0:ue[T])||0;D.forEach(F=>{var O;const $=((O=a.professionTimeMs)==null?void 0:O[F])||0;$>ne&&(ne=$,T=F)})}const z=a.durationMs||0,E=a.totalMs/1e3,J=z>0?a.totalMs/z:0;return{account:a.account,profession:T,professionList:D,total:E,perSecond:J,duration:z/1e3}}).filter(a=>a.total>0||a.perSecond>0);return{id:e,name:n.name||e,icon:n.icon,rows:u}}).filter(e=>e.rows.length>0),_i=Array.from(qe.values()).map(e=>{const t=Array.from(e.skills.values()).sort((u,a)=>a.damage-u.damage),n=t.reduce((u,a)=>(u[a.id]=a,u),{});return{key:e.key,account:e.account,displayName:e.displayName,profession:e.profession,professionList:e.professionList,totalFightMs:e.totalFightMs,skills:t,skillMap:n}}).sort((e,t)=>e.displayName.localeCompare(t.displayName));return{total:W,wins:pe,losses:U,avgSquadSize:bi,avgEnemies:hi,squadKDR:ki,enemyKDR:Ci,totalSquadKills:De,totalSquadDeaths:ae,totalEnemyKills:le,totalEnemyDeaths:Re,leaderboards:Ue,...Ai,outgoingConditionSummary:Object.values(Ie).sort((e,t)=>t.damage-e.damage),incomingConditionSummary:Object.values(xe).sort((e,t)=>t.damage-e.damage),outgoingConditionPlayers:Array.from(Te.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,conditions:e.outgoingConditions})),incomingConditionPlayers:Array.from(Te.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,conditions:e.incomingConditions})),topSkills:Mi,topIncomingSkills:wi,playerSkillBreakdowns:_i,topSkillsMetric:x,mapData:Fi,timelineData:Ii,boonTables:Bi,offensePlayers:Array.from(Te.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,offenseTotals:e.offenseTotals,offenseRateWeights:e.offenseRateWeights,totalFightMs:e.totalFightMs})),defensePlayers:Array.from(Te.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,defenseTotals:e.defenseTotals,activeMs:e.defenseActiveMs})),damageMitigationPlayers:Si,damageMitigationMinions:Di,supportPlayers:Array.from(Te.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,supportTotals:e.supportTotals,activeMs:e.supportActiveMs})),healingPlayers:Array.from(Te.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,healingTotals:e.healingTotals,activeMs:e.healingActiveMs})),mvp:jt,silver:kn,bronze:Cn,squadClassData:Pi,enemyClassData:Ui,fightBreakdown:Li,spikeDamage:xi,incomingStrikeDamage:Oi,specialTables:Ri,topStatsPerSecond:Xe,topStatsLeaderboardsPerSecond:Ye,avgMvpScore:Sn}})(),Ve=(()=>{const Se=new Map,ke=new Map,x=[],W=new Map,pe=new Map;q.forEach(oe=>{const se=oe.details;if(!se)return;const ae=se.skillMap||{},De=se.fightName||"Log",Re=Je(se,oe)||Date.now(),le={id:oe.filePath||oe.id||De,label:De,timestamp:Re,skillEntries:{},playerActiveSeconds:{},durationSeconds:se.durationMS?se.durationMS/1e3:0};(se.players||[]).forEach(Be=>{if(Be.notInSquad)return;const Te=Be.account||Be.name||"Unknown",_e=Be.profession||"Unknown",Ne=`${Te}|${_e}`;let Ae=ke.get(Ne);Ae||(Ae={key:Ne,account:Te,displayName:Te,profession:_e,professionList:[_e],logs:0,totalActiveSeconds:0,skillTotals:{}},ke.set(Ne,Ae)),Ae.logs++;const qe=(Array.isArray(Be.activeTimes)?Be.activeTimes[0]:0)/1e3;Ae.totalActiveSeconds=(Ae.totalActiveSeconds||0)+qe,le.playerActiveSeconds[Ne]=qe,(Be.rotation||[]).forEach(Ie=>{var At,Mt,wt;if(!(Ie!=null&&Ie.id))return;const xe=((At=Ie.skills)==null?void 0:At.length)||0;if(xe<=0)return;const Fe=`s${Ie.id}`,Ze=((Mt=ae[Fe])==null?void 0:Mt.name)||`Skill ${Ie.id}`,Qe=(wt=ae[Fe])==null?void 0:wt.icon;Ae.skillTotals[Fe]=(Ae.skillTotals[Fe]||0)+xe,Se.set(Fe,(Se.get(Fe)||0)+xe),W.set(Fe,Ze),Qe&&!pe.has(Fe)&&pe.set(Fe,Qe),le.skillEntries[Fe]||(le.skillEntries[Fe]={name:Ze,icon:Qe,players:{}}),!le.skillEntries[Fe].icon&&Qe&&(le.skillEntries[Fe].icon=Qe),le.skillEntries[Fe].players[Ne]=(le.skillEntries[Fe].players[Ne]||0)+xe})}),x.push(le)});const U=Array.from(Se.entries()).map(([oe,se])=>({id:oe,name:W.get(oe)||oe,total:se,icon:pe.get(oe)})).sort((oe,se)=>se.total-oe.total);return{logRecords:x,players:Array.from(ke.values()),skillOptions:U,resUtilitySkills:[]}})();return{validLogs:q,stats:Oe,skillUsageData:Ve}};let Ge=null,ut=!1,tn=null,nn=0,on=0,$t=null;const sn=i=>{if(!i||typeof i!="object")return i;const r=(w,R)=>{const q={};return R.forEach(fe=>{w&&Object.prototype.hasOwnProperty.call(w,fe)&&(q[fe]=w[fe])}),q},l=r(i,["players","targets","durationMS","uploadTime","timeStart","timeStartStd","timeEnd","timeEndStd","fightName","success","teamCounts","combatReplayMetaData","skillMap","buffMap","encounterDuration","player_damage_mitigation","player_minion_damage_mitigation","playerDamageMitigation","playerMinionDamageMitigation"]);return Array.isArray(l.players)&&(l.players=l.players.map(w=>r(w,["name","display_name","character_name","profession","elite_spec","group","dpsAll","statsAll","dpsTargets","statsTargets","defenses","support","rotation","extHealingStats","extBarrierStats","squadBuffVolumes","selfBuffs","groupBuffs","squadBuffs","selfBuffsActive","groupBuffsActive","squadBuffsActive","buffUptimes","totalDamageDist","targetDamageDist","damage1S","targetDamage1S","totalDamageTaken","totalDamageTakenDist","minions","combatReplayData","hasCommanderTag","notInSquad","account","activeTimes"]))),Array.isArray(l.targets)&&(l.targets=l.targets.map(w=>r(w,["id","name","isFake","dpsAll","statsAll","defenses","totalHealth","healthPercentBurned","enemyPlayer","totalDamageDist"]))),l},fi=i=>{if(!i||typeof i!="object")return i;const r={...i};return i.details?r.details=sn(i.details):r.details=sn(i),r},an=()=>{if(!ut||!Ge)return;ut=!1,nn+=1;const i=$t;$t=null;const r=di(Ge);self.postMessage({type:"result",result:r,computeId:nn,logCount:Ge.logs.length,token:on,completedAt:Date.now(),flushId:i})},xt=()=>{tn===null&&(tn=setInterval(()=>{an()},5e3))};self.onmessage=i=>{var l,w,R,q;const r=i.data;if((r==null?void 0:r.type)==="reset"){Ge={logs:[]},typeof r.token=="number"&&(on=r.token),ut=!0,xt();return}if((r==null?void 0:r.type)==="settings"){Ge={logs:(Ge==null?void 0:Ge.logs)||[],precomputedStats:(l=r.payload)==null?void 0:l.precomputedStats,mvpWeights:(w=r.payload)==null?void 0:w.mvpWeights,statsViewSettings:(R=r.payload)==null?void 0:R.statsViewSettings,disruptionMethod:(q=r.payload)==null?void 0:q.disruptionMethod},ut=!0,xt();return}if((r==null?void 0:r.type)==="log"){Ge||(Ge={logs:[]}),Ge.logs.push(fi(r.payload)),ut=!0,xt();return}(r==null?void 0:r.type)==="flush"&&(typeof r.flushId=="number"&&($t=r.flushId),ut=!0,an())}})();
