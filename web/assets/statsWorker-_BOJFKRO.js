(function(){"use strict";const Xt=["selfBuffs","groupBuffs","squadBuffs"],Zt=n=>n!=null&&n.classification?n.classification==="Boon":!0,yt=n=>`b${n}`,jn=(n,r)=>{const d=Array.isArray(n==null?void 0:n.activeTimes)?n.activeTimes:[],I=typeof d[0]=="number"?d[0]:0;return I>0?I:r},en=(n,r,d,I,P,v,be)=>{const G=n==="selfBuffs"?1:Math.max(n==="groupBuffs"?v-1:be-1,0);return!G||!P?{generationMs:0,wastedMs:0}:r?{generationMs:d*P*G,wastedMs:I*P*G}:{generationMs:d/100*P*G,wastedMs:I/100*P*G}},Wn=n=>{const r=new Map,d=new Map;return n.forEach(v=>{const be=v.details;if(!be)return;const G=be.durationMS||0,oe=be.buffMap||{};Object.entries(oe).forEach(([$,J])=>{if(!r.has($)){r.set($,J);return}const le=r.get($)||{},ne={name:le.name||J.name,stacking:le.stacking??J.stacking,icon:le.icon||J.icon,classification:le.classification||J.classification};r.set($,ne)});const Oe=(be.players||[]).filter($=>!$.notInSquad),$e=Oe.length,qe=new Map;Oe.forEach($=>{const J=$.group??0;qe.set(J,(qe.get(J)||0)+1)}),Oe.forEach($=>{const J=$.account||$.name||$.character_name||"Unknown",le=$.profession||"Unknown",ne=$.group??0,Ce=qe.get(ne)||1,Be=jn($,G);d.has(J)||d.set(J,{account:J,profession:le,professions:new Set,professionTimeMs:{},activeTimeMs:0,numFights:0,groupSupported:0,squadSupported:0,boons:{}});const se=d.get(J);se.profession=le,le!=="Unknown"&&(se.professions.add(le),se.professionTimeMs[le]=(se.professionTimeMs[le]||0)+Be),se.activeTimeMs+=Be,se.numFights+=1,se.groupSupported+=Ce,se.squadSupported+=$e,Xt.forEach(he=>{($[he]||[]).forEach(f=>{var Se,Re,He,ze;if(typeof(f==null?void 0:f.id)!="number")return;const ae=yt(f.id),me=oe[ae];if(!Zt(me))return;const De=(me==null?void 0:me.stacking)??!1,ke=((Re=(Se=f.buffData)==null?void 0:Se[0])==null?void 0:Re.generation)??0,ce=((ze=(He=f.buffData)==null?void 0:He[0])==null?void 0:ze.wasted)??0,{generationMs:Pe,wastedMs:de}=en(he,De,ke,ce,G,Ce,$e);!Pe&&!de||(r.has(ae)||r.set(ae,me||{}),se.boons[ae]||(se.boons[ae]={selfBuffs:{generationMs:0,wastedMs:0},groupBuffs:{generationMs:0,wastedMs:0},squadBuffs:{generationMs:0,wastedMs:0}}),se.boons[ae][he].generationMs+=Pe,se.boons[ae][he].wastedMs+=de)})})})}),{boonTables:Array.from(r.keys()).filter(v=>Zt(r.get(v))).map(v=>{const be=r.get(v)||{},G=[];return d.forEach(oe=>{var $;const pe=oe.boons[v];if(!pe||!Xt.some(J=>pe[J].generationMs>0||pe[J].wastedMs>0))return;const $e=Array.from(oe.professions||[]).filter(J=>J&&J!=="Unknown");let qe=oe.profession;if($e.length>0){qe=$e[0];let J=(($=oe.professionTimeMs)==null?void 0:$[qe])||0;$e.forEach(le=>{var Ce;const ne=((Ce=oe.professionTimeMs)==null?void 0:Ce[le])||0;ne>J&&(J=ne,qe=le)})}G.push({account:oe.account,profession:qe||"Unknown",professionList:$e,activeTimeMs:oe.activeTimeMs||1,numFights:oe.numFights||1,groupSupported:oe.groupSupported||1,squadSupported:oe.squadSupported||1,categories:{selfBuffs:{...pe.selfBuffs},groupBuffs:{...pe.groupBuffs},squadBuffs:{...pe.squadBuffs}}})}),{id:v,name:be.name||v,icon:be.icon,stacking:be.stacking??!1,rows:G}}).filter(v=>v.rows.length>0)}},tn=(n,r,d,I,P,v,be={})=>{var $,J,le,ne;const oe=((n==null?void 0:n[r])||[]).find(Ce=>Ce.id===d);if(!oe)return{generationMs:0,wastedMs:0};const pe=be[yt(d)],Oe=(pe==null?void 0:pe.stacking)??!1,$e=((J=($=oe.buffData)==null?void 0:$[0])==null?void 0:J.generation)??0,qe=((ne=(le=oe.buffData)==null?void 0:le[0])==null?void 0:ne.wasted)??0;return en(r,Oe,$e,qe,I,P,v)};var _n={methods:{tiered:{tiers:{shortMs:500,mediumMs:1500,weights:{short:.5,medium:1,long:2}}}}};const zn=_n,Ht="count",Kn=n=>(n||0)/1e3,Vn=(n,r)=>{var P;if(!n)return 0;const d=(P=zn.methods.tiered)==null?void 0:P.tiers;if(!d)return n;const I=r/Math.max(n,1);return I<=d.shortMs?n*d.weights.short:I<=d.mediumMs?n*d.weights.medium:n*d.weights.long},nn=(n,r,d)=>d==="duration"?Kn(r):d==="tiered"?Vn(n,r):n;function Gn(n,r=Ht){var v;const d=(v=n.statsAll)==null?void 0:v[0],I=Number((d==null?void 0:d.appliedCrowdControl)??0),P=Number((d==null?void 0:d.appliedCrowdControlDuration)??0);return nn(I,P,r)}function Jn(n,r){const d=(r==null?void 0:r.durationMS)||0,I=(r==null?void 0:r.buffMap)||{},P=n.filter(G=>!G.notInSquad),v=P.length,be=new Map;P.forEach(G=>{const oe=G.group??0;be.set(oe,(be.get(oe)||0)+1)}),P.forEach(G=>{const oe=be.get(G.group??0)||1,pe=tn(G,"selfBuffs",1122,d,oe,v,I),Oe=tn(G,"squadBuffs",1122,d,oe,v,I);G.stabGeneration=(pe.generationMs+Oe.generationMs)/1e3})}function Yn(n){if(!n.statsTargets)return 0;let r=0;for(const d of n.statsTargets)d&&d.length>0&&(r+=d[0].downContribution||0);return r}function Qn(n){if(!n.extBarrierStats||!n.extBarrierStats.outgoingBarrierAllies)return 0;let r=0;for(const d of n.extBarrierStats.outgoingBarrierAllies)if(d)for(const I of d)I&&(r+=I.barrier||0);return r}function Xn(n){if(!n.extHealingStats||!n.extHealingStats.outgoingHealingAllies)return 0;let r=0;for(const d of n.extHealingStats.outgoingHealingAllies)if(d)for(const I of d)I&&(r+=I.healing||0);return r}const on=n=>{var r,d,I,P;return(((d=(r=n.support)==null?void 0:r[0])==null?void 0:d.condiCleanse)||0)+(((P=(I=n.support)==null?void 0:I[0])==null?void 0:P.condiCleanseSelf)||0)},sn=(n,r=Ht)=>{var v;const d=(v=n.support)==null?void 0:v[0],I=Number((d==null?void 0:d.boonStrips)??0),P=Number((d==null?void 0:d.boonStripsTime)??0);return nn(I,P,r)},an=n=>Yn(n),rn=n=>Xn(n),cn=n=>Qn(n),un=(n,r=Ht)=>Gn(n,r),Zn=(n,r)=>Jn(n,r),yn="count",ei={downContribution:1,healing:1,cleanses:1,strips:1,stability:1,cc:.7,revives:.7,distanceToTag:.7,participation:.7,dodging:.4,dps:.2,damage:.2},ti={showMvp:!0,topSkillDamageSource:"target",topSkillsMetric:"damage"},mn=new Map([["bleeding","Bleeding"],["burning","Burning"],["confusion","Confusion"],["poison","Poison"],["torment","Torment"],["vulnerability","Vulnerability"],["weakness","Weakness"],["weakened","Weakness"],["blind","Blind"],["blinded","Blind"],["blinding","Blind"],["cripple","Cripple"],["crippled","Cripple"],["chill","Chill"],["chilled","Chill"],["immob","Immobilize"],["immobile","Immobilize"],["immobilized","Immobilize"],["slow","Slow"],["slowed","Slow"],["fear","Fear"],["feared","Fear"],["taunt","Taunt"],["taunted","Taunt"]]),ni={Blind:"https://render.guildwars2.com/file/09770136BB76FD0DBE1CC4267DEED54774CB20F6/102837.png",Chill:"https://render.guildwars2.com/file/28C4EC547A3516AF0242E826772DA43A5EAC3DF3/102839.png",Cripple:"https://render.guildwars2.com/file/070325E519C178D502A8160523766070D30C0C19/102838.png",Fear:"https://render.guildwars2.com/file/30307A6E766D74B6EB09EDA12A4A2DE50E4D76F4/102869.png",Immobilize:"https://render.guildwars2.com/file/397A613651BFCA2832B6469CE34735580A2C120E/102844.png",Slow:"https://render.guildwars2.com/file/F60D1EF5271D7B9319610855676D320CD25F01C6/961397.png",Taunt:"https://render.guildwars2.com/file/02EED459AD65FAF7DF32A260E479C625070841B9/1228472.png",Vulnerability:"https://render.guildwars2.com/file/3A394C1A0A3257EB27A44842DDEEF0DF000E1241/102850.png",Weakness:"https://render.guildwars2.com/file/6CB0E64AF9AA292E332A38C1770CE577E2CDE0E8/102853.png"},gt=n=>{if(!n)return null;const r=n.trim().toLowerCase(),d=mn.get(r);if(d)return d;const I=r.split(/[^a-z]+/).filter(Boolean);for(const P of I){const v=mn.get(P);if(v)return v}return null},ii=n=>gt(n),ln=n=>{const r=new Map;return n&&(Object.values(n).forEach(d=>{if(!(d!=null&&d.icon)||!(d!=null&&d.name))return;const I=gt(d.name);I&&(r.has(I)||r.set(I,d.icon))}),Object.entries(ni).forEach(([d,I])=>{r.has(d)||r.set(d,I)})),r},At=(n,r,d)=>{var I;if(r&&d){const P=(I=d[`b${r}`])==null?void 0:I.name,v=gt(P);if(v)return v}return n?gt(n):null},oi=n=>{const r=(n==null?void 0:n.account)||"Unknown";return r&&r!=="Unknown"?r:(n==null?void 0:n.name)||"Unknown"||null},si=n=>{if(!n||n.length===0)return 0;let r=0,d=null;return n.forEach(I=>{const P=Number(I[1]??0);if(Number.isFinite(P)){if(d===null){d=P;return}P>d&&(r+=P-d),d=P}}),r},ai=n=>{if(!n||n.length===0)return 0;let r=0;return n.forEach(d=>{const I=Number(d[0]??0),P=Number(d[1]??0);Number.isFinite(P)&&I!==0&&P>0&&(r+=1)}),r},ri=n=>{const{players:r,targets:d,skillMap:I,buffMap:P}=n,v=n.getPlayerKey||oi,be=ln(P),G={},oe={};r.forEach($=>{if($!=null&&$.notInSquad)return;const J=v($);J&&(G[J]||(G[J]={}),$!=null&&$.totalDamageDist&&$.totalDamageDist.forEach(le=>{le&&le.forEach(ne=>{if(!ne.id)return;let Ce=`Skill ${ne.id}`,Be;I&&(I[`s${ne.id}`]?(Ce=I[`s${ne.id}`].name||Ce,Be=I[`s${ne.id}`].icon||Be):I[`${ne.id}`]&&(Ce=I[`${ne.id}`].name||Ce,Be=I[`${ne.id}`].icon||Be));const se=At(Ce,ne.id,P);if(!se)return;const he=P==null?void 0:P[`b${ne.id}`],Je=he==null?void 0:he.name,f=be.get(se)||(he==null?void 0:he.icon),ae=Ce.startsWith("Skill ")?Je||se:Ce,me=Be||(he==null?void 0:he.icon),De=Number(ne.connectedHits??0),ke=Number(ne.hits??0),ce=De>0?De:ke,Pe=Number(ne.totalDamage??0);if(!Number.isFinite(ce)&&!Number.isFinite(Pe))return;const de=oe[se]||{name:se,icon:f,applications:0,damage:0};de.applications+=Number.isFinite(ce)?ce:0,de.damage+=Number.isFinite(Pe)?Pe:0,!de.icon&&f&&(de.icon=f),oe[se]=de;const Se=G[J][se]||{icon:f,applications:0,damage:0,skills:{}};Se.applications+=Number.isFinite(ce)?ce:0,Se.damage+=Number.isFinite(Pe)?Pe:0;const Re=Se.skills[ae]||{name:ae,hits:0,damage:0,icon:me};Re.hits+=Number.isFinite(ce)?ce:0,Re.damage+=Number.isFinite(Pe)?Pe:0,!Re.icon&&me&&(Re.icon=me),Se.skills[ae]=Re,!Se.icon&&f&&(Se.icon=f),G[J][se]=Se})}))});const pe=new Map;r.forEach($=>{if($!=null&&$.notInSquad)return;const J=v($);J&&$!=null&&$.name&&pe.set($.name,J)});let Oe=0,$e=0,qe=0;return d.forEach($=>{$!=null&&$.buffs&&$.buffs.forEach(J=>{const le=Number(J==null?void 0:J.id);if(!Number.isFinite(le))return;const ne=P==null?void 0:P[`b${le}`],Ce=gt(ne==null?void 0:ne.name);if(!Ce||ne!=null&&ne.classification&&ne.classification!=="Condition")return;const Be=Ce;if(!Be)return;const se=J.statesPerSource||{};qe+=1,Object.entries(se).forEach(([he,Je])=>{var ce;const f=pe.get(he);if(!f)return;$e+=1;const ae=si(Je),me=ai(Je);Oe+=ae;const De=((ce=G[f])==null?void 0:ce[Be])||{applications:0,damage:0,skills:{}};De.applicationsFromBuffs=(De.applicationsFromBuffs||0)+ae,De.applicationsFromBuffsActive=(De.applicationsFromBuffsActive||0)+me,G[f]=G[f]||{},G[f][Be]=De;const ke=oe[Be]||{name:Be,applications:0,damage:0};ke.applicationsFromBuffs=(ke.applicationsFromBuffs||0)+ae,ke.applicationsFromBuffsActive=(ke.applicationsFromBuffsActive||0)+me,oe[Be]=ke})})}),Object.values(G).forEach($=>{Object.values($).forEach(J=>{typeof J.applicationsFromBuffs=="number"&&(J.applications=J.applicationsFromBuffs)})}),Object.values(oe).forEach($=>{typeof $.applicationsFromBuffs=="number"&&($.applications=$.applicationsFromBuffs)}),{playerConditions:G,summary:oe,meta:{buffStateApplicationsTotal:Oe,targetBuffEntriesSeen:qe,buffStateSourcesSeen:$e}}},ci=new Set(["Vulnerability","Weakness","Blind","Cripple","Chill","Immobilize","Slow","Fear","Taunt"]),ui=[{id:"damage",label:"Damage",field:"damage",source:"dpsAll"},{id:"directDmg",label:"Direct Damage",field:"directDmg",source:"statsTargets"},{id:"connectedDamageCount",label:"Connected Damage Count",field:"connectedDamageCount",source:"statsTargets"},{id:"connectedDirectDamageCount",label:"Connected Direct Damage Count",field:"connectedDirectDamageCount",source:"statsTargets"},{id:"battleStandardHits",label:"Battle Standard Tracking"},{id:"criticalRate",label:"Critical Rate",field:"criticalRate",isRate:!0,isPercent:!0,denomField:"critableDirectDamageCount",source:"statsTargets"},{id:"criticalDmg",label:"Critical Damage",field:"criticalDmg",source:"statsTargets"},{id:"flankingRate",label:"Flanking Rate",field:"flankingRate",isRate:!0,isPercent:!0,denomField:"connectedDirectDamageCount",source:"statsTargets"},{id:"glanceRate",label:"Glance Rate",field:"glanceRate",isRate:!0,isPercent:!0,denomField:"connectedDirectDamageCount",source:"statsTargets"},{id:"missed",label:"Missed",field:"missed",source:"statsTargets"},{id:"evaded",label:"Evaded (enemy)",field:"evaded",source:"statsTargets"},{id:"blocked",label:"Blocked (enemy)",field:"blocked",source:"statsTargets"},{id:"interrupts",label:"Interrupts",field:"interrupts",source:"statsTargets"},{id:"invulned",label:"Invulned",field:"invulned",source:"statsTargets"},{id:"killed",label:"Killed",field:"killed",source:"statsTargets"},{id:"downed",label:"Downed",field:"downed",source:"statsTargets"},{id:"downContribution",label:"Down Contribution",field:"downContribution",source:"statsTargets"},{id:"downContributionPercent",label:"Down Contribution %",isRate:!0,isPercent:!0},{id:"againstDownedDamage",label:"Against Downed Damage",field:"againstDownedDamage",source:"statsTargets"},{id:"appliedCrowdControl",label:"Applied CC",field:"appliedCrowdControl",source:"statsTargets"},{id:"appliedCrowdControlDuration",label:"Applied CC Duration",field:"appliedCrowdControlDuration",source:"statsTargets"},{id:"appliedCrowdControlDownContribution",label:"Applied CC Down Contribution",field:"appliedCrowdControlDownContribution",source:"statsTargets"},{id:"appliedCrowdControlDurationDownContribution",label:"Applied CC Duration Down Contribution",field:"appliedCrowdControlDurationDownContribution",source:"statsTargets"},{id:"boonStrips",label:"Boon Strips",field:"boonStrips",source:"support"}],mi=[{id:"damageTaken",label:"Damage Taken",field:"damageTaken"},{id:"minionDamageTaken",label:"Minion Damage Taken"},{id:"damageTakenCount",label:"Damage Taken Count",field:"damageTakenCount"},{id:"conditionDamageTaken",label:"Condition Damage Taken",field:"conditionDamageTaken"},{id:"conditionDamageTakenCount",label:"Condition Damage Taken Count",field:"conditionDamageTakenCount"},{id:"powerDamageTaken",label:"Power Damage Taken",field:"powerDamageTaken"},{id:"powerDamageTakenCount",label:"Power Damage Taken Count",field:"powerDamageTakenCount"},{id:"downedDamageTaken",label:"Downed Damage Taken",field:"downedDamageTaken"},{id:"downedDamageTakenCount",label:"Downed Damage Taken Count",field:"downedDamageTakenCount"},{id:"damageBarrier",label:"Damage Barrier",field:"damageBarrier"},{id:"damageBarrierCount",label:"Damage Barrier Count",field:"damageBarrierCount"},{id:"blockedCount",label:"Blocked Count",field:"blockedCount"},{id:"evadedCount",label:"Evaded Count",field:"evadedCount"},{id:"missedCount",label:"Missed Count",field:"missedCount"},{id:"dodgeCount",label:"Dodge Count",field:"dodgeCount"},{id:"invulnedCount",label:"Invulnerable Count",field:"invulnedCount"},{id:"interruptedCount",label:"Interrupted Count",field:"interruptedCount"},{id:"downCount",label:"Down Count",field:"downCount"},{id:"deadCount",label:"Death Count",field:"deadCount"},{id:"boonStrips",label:"Boon Strips (Incoming)",field:"boonStrips"},{id:"conditionCleanses",label:"Cleanses (Incoming)",field:"conditionCleanses"},{id:"receivedCrowdControl",label:"Crowd Control (Incoming)",field:"receivedCrowdControl"}],li=[{id:"condiCleanse",label:"Condition Cleanses",field:"condiCleanse"},{id:"condiCleanseTime",label:"Condition Cleanse Time",field:"condiCleanseTime",isTime:!0},{id:"condiCleanseSelf",label:"Condition Cleanse Self",field:"condiCleanseSelf"},{id:"condiCleanseTimeSelf",label:"Condition Cleanse Time Self",field:"condiCleanseTimeSelf",isTime:!0},{id:"boonStrips",label:"Boon Strips",field:"boonStrips"},{id:"boonStripsTime",label:"Boon Strips Time",field:"boonStripsTime",isTime:!0},{id:"boonStripDownContribution",label:"Boon Strip Down Contribution",field:"boonStripDownContribution"},{id:"boonStripDownContributionTime",label:"Boon Strip Down Contribution Time",field:"boonStripDownContributionTime",isTime:!0},{id:"stunBreak",label:"Stun Breaks",field:"stunBreak"},{id:"removedStunDuration",label:"Removed Stun Duration",field:"removedStunDuration",isTime:!0},{id:"resurrects",label:"Resurrects",field:"resurrects"},{id:"resurrectTime",label:"Resurrect Time",field:"resurrectTime",isTime:!0}],di=["battle standard","glyph of renewal","glyph of the stars","illusion of life","spirit of nature","nature spirit","search and rescue","signet of mercy"],fi=new Set([10244]),gi=(n,r)=>{var P;if(fi.has(n))return!0;const d=(r==null?void 0:r[`s${n}`])||(r==null?void 0:r[`${n}`]),I=((P=d==null?void 0:d.name)==null?void 0:P.toLowerCase())||"";return di.some(v=>I.includes(v))},wt=n=>{if(!n||!Number.isFinite(n))return"--:--";const r=Math.max(0,Math.round(n/1e3)),d=Math.floor(r/3600),I=Math.floor(r%3600/60),P=r%60;return d>0?`${d}:${String(I).padStart(2,"0")}:${String(P).padStart(2,"0")}`:`${I}:${String(P).padStart(2,"0")}`},Mt={Guardian:"#72C1D9",Dragonhunter:"#72C1D9",Firebrand:"#72C1D9",Willbender:"#72C1D9",Revenant:"#D16E5A",Herald:"#D16E5A",Renegade:"#D16E5A",Vindicator:"#D16E5A",Warrior:"#FFD166",Berserker:"#FFD166",Spellbreaker:"#FFD166",Bladesworn:"#FFD166",Engineer:"#D09C59",Scrapper:"#D09C59",Holosmith:"#D09C59",Mechanist:"#D09C59",Ranger:"#8CDC82",Druid:"#8CDC82",Soulbeast:"#8CDC82",Untamed:"#8CDC82",Thief:"#C08F95",Daredevil:"#C08F95",Deadeye:"#C08F95",Specter:"#C08F95",Elementalist:"#F68A87",Tempest:"#F68A87",Weaver:"#F68A87",Catalyst:"#F68A87",Mesmer:"#B679D5",Chronomancer:"#B679D5",Mirage:"#B679D5",Virtuoso:"#B679D5",Necromancer:"#52A76F",Reaper:"#52A76F",Scourge:"#52A76F",Harbinger:"#52A76F",Ritualist:"#52A76F",Luminary:"#72C1D9",Conduit:"#D16E5A",Paragon:"#FFD166",Amalgam:"#D09C59",Galeshot:"#8CDC82",Antiquary:"#C08F95",Evoker:"#F68A87",Troubadour:"#B679D5",Unknown:"#64748B"};function dn(n){return Mt[n]||Mt.Unknown}const bi=n=>{if(n==null||n==="")return 0;if(typeof n=="number")return!Number.isFinite(n)||n<=0?0:n>1e12?n:n*1e3;if(n instanceof Date){const be=n.getTime();return Number.isFinite(be)&&be>0?be:0}const r=String(n).trim();if(!r)return 0;const d=Number(r);if(Number.isFinite(d)&&d>0)return d>1e12?d:d*1e3;const I=Date.parse(r);if(Number.isFinite(I)&&I>0)return I;const P=r.replace(/([+-]\d{2})$/,"$1:00"),v=Date.parse(P);return Number.isFinite(v)&&v>0?v:0},Ge=(n,r)=>bi((n==null?void 0:n.uploadTime)??(r==null?void 0:r.uploadTime)??(n==null?void 0:n.timeStartStd)??(n==null?void 0:n.timeStart)??(n==null?void 0:n.timeEndStd)??(n==null?void 0:n.timeEnd)??(n==null?void 0:n.timeStartText)??(n==null?void 0:n.timeEndText)),pi=({logs:n,precomputedStats:r,mvpWeights:d,statsViewSettings:I,disruptionMethod:P,includePlayerSkillMap:v})=>{const be=$=>{var le;return(Array.isArray((le=$==null?void 0:$.details)==null?void 0:le.players)?$.details.players:[]).length>0},G=n.filter($=>be($)),oe=I||ti,pe=d||ei,Oe=$=>{if(!$||typeof $!="object")return $;const J=Array.isArray($.fightBreakdown)?$.fightBreakdown:null;if(!J||J.length===0)return $;const le=f=>Array.isArray(f)&&f.some(ae=>ae&&Number(ae.count)>0),ne=new Map,Ce=new Map;n.forEach(f=>{var De;const ae=(f==null?void 0:f.filePath)||(f==null?void 0:f.id);ae&&ne.set(String(ae),f);const me=(f==null?void 0:f.permalink)||((De=f==null?void 0:f.details)==null?void 0:De.permalink);typeof me=="string"&&me.trim()&&Ce.set(me.trim(),f)});const Be=J.map(f=>{var Pe;if(!f||typeof f!="object")return f;const ae=f.id?String(f.id):"",me=typeof f.permalink=="string"?f.permalink.trim():"",De=(ae?ne.get(ae):void 0)||(me?Ce.get(me):void 0);if(!De)return f;let ke=f;if(Number(f.timestamp)<=0){const de=Ge(De==null?void 0:De.details,De);de&&(ke={...ke,timestamp:de})}const ce=(Pe=De==null?void 0:De.details)==null?void 0:Pe.teamBreakdown;return le(ce)&&(ke={...ke,teamBreakdown:ce}),ke}),se=Array.isArray($.fightDiffMode)?$.fightDiffMode:[],Je=se.some(f=>Array.isArray(f==null?void 0:f.targetFocus)&&f.targetFocus.some(ae=>Number((ae==null?void 0:ae.damage)||0)>0||Number((ae==null?void 0:ae.hits)||0)>0))?se:Be.map((f,ae)=>{const me=f&&typeof f.enemyClassCounts=="object"&&f.enemyClassCounts?f.enemyClassCounts:{},De=Object.entries(me).map(([Ue,je])=>({label:String(Ue||"Unknown"),count:Number(je||0)})).filter(Ue=>Ue.count>0).sort((Ue,je)=>je.count-Ue.count||Ue.label.localeCompare(je.label)),ke=De.reduce((Ue,je)=>Ue+je.count,0),ce=De.map(Ue=>({label:Ue.label,damage:Ue.count,hits:0,share:ke>0?Ue.count/ke:0})),Pe=Number((f==null?void 0:f.enemyDowns)||0),de=Number((f==null?void 0:f.enemyDeaths)||0),Se=Number((f==null?void 0:f.alliesDown)||0),Re=Number((f==null?void 0:f.alliesDead)||0),He=Number((f==null?void 0:f.totalOutgoingDamage)||0),ze=Number((f==null?void 0:f.totalIncomingDamage)||0),Ie=[{metricId:"winFlag",metricLabel:"Win (1) / Loss (0)",higherIsBetter:!0,value:f!=null&&f.isWin?1:0},{metricId:"squadCount",metricLabel:"Squad Size",higherIsBetter:!0,value:Number((f==null?void 0:f.squadCount)||0)},{metricId:"enemyCount",metricLabel:"Enemy Count",higherIsBetter:!1,value:Number((f==null?void 0:f.enemyCount)||0)},{metricId:"squadKdr",metricLabel:"Squad KDR",higherIsBetter:!0,value:Re>0?de/Re:de},{metricId:"enemyDeaths",metricLabel:"Enemy Deaths",higherIsBetter:!0,value:de},{metricId:"enemyDowns",metricLabel:"Enemy Downs",higherIsBetter:!0,value:Pe},{metricId:"squadDeaths",metricLabel:"Squad Deaths",higherIsBetter:!1,value:Re},{metricId:"squadDowns",metricLabel:"Squad Downs",higherIsBetter:!1,value:Se},{metricId:"damageDelta",metricLabel:"Damage Delta",higherIsBetter:!0,value:He-ze},{metricId:"outgoingDamage",metricLabel:"Outgoing Damage",higherIsBetter:!0,value:He},{metricId:"incomingDamage",metricLabel:"Incoming Damage",higherIsBetter:!1,value:ze},{metricId:"barrierIncomingAbsorb",metricLabel:"Barrier Absorption (Incoming)",higherIsBetter:!0,value:Number((f==null?void 0:f.incomingBarrierAbsorbed)||0)},{metricId:"enemyBarrierAbsorb",metricLabel:"Enemy Barrier Absorption",higherIsBetter:!1,value:Number((f==null?void 0:f.outgoingBarrierAbsorbed)||0)},{metricId:"alliesRevived",metricLabel:"Allies Revived (Players)",higherIsBetter:!0,value:Number((f==null?void 0:f.alliesRevived)||0)}];return{id:String((f==null?void 0:f.id)||`fight-${ae+1}`),shortLabel:`F${ae+1}`,fullLabel:`${String((f==null?void 0:f.mapName)||(f==null?void 0:f.label)||"Unknown Map")} • ${String((f==null?void 0:f.duration)||"--:--")}`,mapName:String((f==null?void 0:f.mapName)||""),timestamp:Number((f==null?void 0:f.timestamp)||0),duration:String((f==null?void 0:f.duration)||"--:--"),isWin:!!(f!=null&&f.isWin),targetFocus:ce,squadMetrics:Ie}});return{...$,fightBreakdown:Be,fightDiffMode:Je}},$e=(()=>{if(r)return Oe(r);const $=P||yn,J=oe.topSkillDamageSource||"target",le=oe.topSkillsMetric||"damage",ne=G.length;let Ce=0,Be=0,se=0,he=0,Je=0,f=0,ae=0,me=0;const De=e=>{const i=((e==null?void 0:e.players)||[]).filter(z=>!z.notInSquad);let k=0,a=0,B=0,b=0;return i.forEach(z=>{var ee;const H=(ee=z.defenses)==null?void 0:ee[0];if(!H)return;const Y=Number(H.downCount||0),Q=Number(H.deadCount||0);k+=Y+Q,B+=Q}),i.forEach(z=>{!z.statsTargets||z.statsTargets.length===0||z.statsTargets.forEach(H=>{const Y=H==null?void 0:H[0];if(!Y)return;const Q=Number(Y.downed||0),ee=Number(Y.killed||0);a+=Q+ee,b+=ee})}),{squadDownsDeaths:k,enemyDownsDeaths:a,squadDeaths:B,enemyDeaths:b}},ke=e=>{const{squadDownsDeaths:t,enemyDownsDeaths:i}=De(e);return t>0||i>0?i>t:typeof(e==null?void 0:e.success)=="boolean"?e.success:!1},ce=new Map,Pe=new Set(["boonStripsTime","condiCleanseTime","condiCleanseTimeSelf"]),de={},Se={},Re=new Map,He={},ze={},Ie={},Ue=new Map,je=new Map,Et=new Set(Object.keys(Mt)),vt=Object.keys(Mt).filter(e=>e&&e!=="Unknown").sort((e,t)=>t.length-e.length),Bt=["Guardian","Revenant","Warrior","Engineer","Ranger","Thief","Elementalist","Mesmer","Necromancer"],et=e=>{if(!e)return"Unknown";const t=String(e).replace(/\s*\([^)]*\)\s*$/,"").replace(/\s*\[[^\]]*\]\s*$/,"").replace(/\s\d+$/,"").trim();if(Et.has(t))return t;const i=t.toLowerCase();for(const a of vt)if(i.includes(a.toLowerCase()))return a;return Bt.find(a=>i.includes(a.toLowerCase()))||t||"Unknown"},Ni=e=>e!=null&&e.classification?e.classification==="Boon":!0,It=new Map,Lt=new Map,pt=()=>({totalHits:0,blocked:0,evaded:0,glanced:0,missed:0,invulned:0,interrupted:0,totalMitigation:0,minMitigation:0}),Ee=e=>{const t=Number(e);return Number.isFinite(t)?t:0},Dn=e=>{const t=String(e).split("|"),i=t[0]||"Unknown",k=et(t[1]||"Unknown"),a=t[2]||i||"Unknown";return{name:i,profession:k,account:a}},kn=(e,t,i)=>{let k=e.get(t);return k?i.profession&&!k.professionList.includes(i.profession)&&k.professionList.push(i.profession):(k={account:i.account,name:i.name,profession:i.profession,professionList:i.profession?[i.profession]:[],activeMs:0,mitigationTotals:pt()},e.set(t,k)),k},Sn=(e,t,i)=>{let k=e.get(t);return k?i.profession&&!k.professionList.includes(i.profession)&&k.professionList.push(i.profession):(k={account:i.account,name:i.name,profession:i.profession,professionList:i.profession?[i.profession]:[],activeMs:0,mitigationTotals:pt(),minion:i.minion},e.set(t,k)),k},Cn=(e,t)=>{e.totalHits+=Ee((t==null?void 0:t.skill_hits)??(t==null?void 0:t.skillHits)),e.blocked+=Ee(t==null?void 0:t.blocked),e.evaded+=Ee(t==null?void 0:t.evaded),e.glanced+=Ee(t==null?void 0:t.glanced),e.missed+=Ee(t==null?void 0:t.missed),e.invulned+=Ee(t==null?void 0:t.invulned),e.interrupted+=Ee(t==null?void 0:t.interrupted),e.totalMitigation+=Ee((t==null?void 0:t.avoided_damage)??(t==null?void 0:t.avoidedDamage)),e.minMitigation+=Ee((t==null?void 0:t.min_avoided_damage)??(t==null?void 0:t.minAvoidedDamage))},Ai=e=>Object.values(e).some(t=>t>0),Wt=new Map,wi=e=>{const t=Wt.get(e);if(!t)return{hasSkill:!1,avg:1,min:1,hits:0};const i=t.connectedHits||0,k=i>0?t.totalDamage/i:0,a=t.minCount>0?t.minTotal/t.minCount:0;return{hasSkill:!0,avg:k,min:a,hits:i}},Nn=new Map,An=new Map,wn=(e,t,i)=>{const k=e.get(t)||pt();return k.totalHits+=i.totalHits,k.blocked+=i.blocked,k.evaded+=i.evaded,k.glanced+=i.glanced,k.missed+=i.missed,k.invulned+=i.invulned,k.interrupted+=i.interrupted,e.set(t,k),k};G.forEach(e=>{const t=e.details;if(!t)return;(t.targets||[]).forEach(k=>{const a=(k==null?void 0:k.totalDamageDist)||[],B=Array.isArray(a)?a[0]:null;B==null||B.forEach(b=>{if(!(b!=null&&b.id))return;const z=Number(b.id),H=Wt.get(z)||{totalDamage:0,connectedHits:0,minTotal:0,minCount:0};H.totalDamage+=Number(b.totalDamage||0),H.connectedHits+=Number(b.connectedHits||0);const Y=Number.isFinite(Number(b.min))?Number(b.min):0;H.minTotal+=Y,H.minCount+=1,Wt.set(z,H)})})}),G.forEach(e=>{var L,_;const t=e.details;if(!t)return;const i=t.players,k=t.targets||[],a=t.combatReplayMetaData||{},B=(a==null?void 0:a.inchToPixel)>0?a.inchToPixel:1,b=(a==null?void 0:a.pollingRate)>0?a.pollingRate:1,z=5e3,H=o=>Array.isArray(o)?o.map(M=>Array.isArray(M)?[Number(M[0]),Number(M[1])]:null).filter(M=>!!M&&Number.isFinite(M[0])):[];let Y=[],Q=t.durationMS||0,ee=!1;const ie=i.find(o=>(o==null?void 0:o.hasCommanderTag)&&!(o!=null&&o.notInSquad));(L=ie==null?void 0:ie.combatReplayData)!=null&&L.positions&&(Y=ie.combatReplayData.positions,H(ie.combatReplayData.dead).forEach(([M])=>{M>0&&(ee=!0,Q=Math.min(Q,M))}));const fe=o=>{var w;const M=(w=o.statsAll)==null?void 0:w[0];if((M==null?void 0:M.distToCom)!==void 0&&(M==null?void 0:M.distToCom)!=="Infinity")return Math.round(Number(M.distToCom));if((M==null?void 0:M.stackDist)!==void 0)return Math.round(Number(M.stackDist))||0;if(o.hasCommanderTag)return 0;const U=o.combatReplayData;if(!(U!=null&&U.positions)||!Y.length)return 0;const Z=U.positions,l=H(U.dead),s=H(U.down),y=Math.floor((U.start||0)/b);let u=0;if(l.length&&s.length)for(const[x]of l){if(x<0)continue;const V=Math.max(0,Math.floor(x/b))-y;for(const[O,T]of s){if(x!==T)continue;const R=ee&&O>Q?Math.max(1,Math.floor(Q/b)):V,j=Math.max(0,Math.min(R,Z.length,Y.length));if(j<=0)continue;let te=0;for(let ue=0;ue<j;ue++){const[ve,Fe]=Z[ue],[Ne,We]=Y[ue];te+=Math.hypot(ve-Ne,Fe-We)}u=Math.round(te/j/B)}}return u},N=i.filter(o=>!o.notInSquad);se+=N.length,he+=k.filter(o=>!o.isFake).length,Zn(i,{durationMS:t.durationMS,buffMap:t.buffMap});const{squadDeaths:W,enemyDeaths:K}=De(t);Je+=W,f+=K,me+=W,ae+=K,ke(t)?Ce++:Be++;const g=t.skillMap?Number((_=Object.keys(t.skillMap).find(o=>{var M,U;return((U=(M=t.skillMap)==null?void 0:M[o])==null?void 0:U.name)==="Battle Standard"}))==null?void 0:_.replace(/^s/,"")):null;i.forEach((o,M)=>{var tt,Ye,Qe,Pt,qt,Rt,mt,ct,lt,Yt,dt,ht,Ut;if(o.notInSquad)return;const U=o.account||"Unknown",Z=U!=="Unknown"?U:o.name||"Unknown",l=o.name||"Unknown";ce.has(Z)||ce.set(Z,{name:l,account:Z,characterNames:new Set,downContrib:0,cleanses:0,strips:0,stab:0,healing:0,barrier:0,cc:0,logsJoined:0,totalDist:0,distCount:0,dodges:0,downs:0,deaths:0,totalFightMs:0,offenseTotals:{},offenseRateWeights:{},defenseActiveMs:0,defenseTotals:{},defenseMinionDamageTaken:{},supportActiveMs:0,supportTotals:{},healingActiveMs:0,healingTotals:{},profession:o.profession||"Unknown",professions:new Set,professionTimeMs:{},squadActiveMs:0,firstSeenFightTs:0,lastSeenFightTs:0,lastSeenFightDurationMs:0,isCommander:!1,damage:0,dps:0,revives:0,outgoingConditions:{},incomingConditions:{}});const s=ce.get(Z);if(o.hasCommanderTag&&(s.isCommander=!0),l!=="Unknown"&&s.characterNames.add(String(l)),o.profession&&o.profession!=="Unknown"){s.profession=o.profession,s.professions.add(o.profession);const C=Array.isArray(o.activeTimes)&&typeof o.activeTimes[0]=="number"?o.activeTimes[0]:t.durationMS||0;s.professionTimeMs[o.profession]=(s.professionTimeMs[o.profession]||0)+C}s.logsJoined++,s.downContrib+=an(o),s.cleanses+=on(o),s.strips+=sn(o,$),s.healing+=rn(o),s.barrier+=cn(o),s.cc+=un(o,$),s.stab+=o.stabGeneration||0;const y=fe(o);y<=z&&(s.totalDist+=y,s.distCount++),(tt=o.defenses)!=null&&tt[0]&&(s.dodges+=o.defenses[0].dodgeCount||0,s.downs+=o.defenses[0].downCount||0,s.deaths+=o.defenses[0].deadCount||0),t.durationMS&&(s.totalFightMs+=t.durationMS);const u=Array.isArray(o.activeTimes)&&typeof o.activeTimes[0]=="number"?o.activeTimes[0]:t.durationMS||0;s.squadActiveMs+=u;const w=Ge(t,e),x=Number((t==null?void 0:t.durationMS)||0);if(w>0&&((s.firstSeenFightTs<=0||w<s.firstSeenFightTs)&&(s.firstSeenFightTs=w),s.lastSeenFightTs<=0||w>s.lastSeenFightTs?(s.lastSeenFightTs=w,s.lastSeenFightDurationMs=x):w===s.lastSeenFightTs&&x>s.lastSeenFightDurationMs&&(s.lastSeenFightDurationMs=x)),s.defenseActiveMs+=u,s.supportActiveMs+=u,s.healingActiveMs+=u,Array.isArray(o.buffUptimes)&&o.buffUptimes.length>0&&o.buffUptimes.forEach(C=>{var qn,Rn,Un,$n,Hn,On;if(typeof(C==null?void 0:C.id)!="number")return;const S=`b${C.id}`,m=((qn=t.buffMap)==null?void 0:qn[S])||((Rn=t.buffMap)==null?void 0:Rn[String(C.id)]);if(!m||Ni(m))return;const p=Number((($n=(Un=C.buffData)==null?void 0:Un[0])==null?void 0:$n.uptime)??0),q=Number(((On=(Hn=C.buffData)==null?void 0:Hn[0])==null?void 0:On.presence)??0);if((!Number.isFinite(p)||p<=0)&&(!Number.isFinite(q)||q<=0))return;const re=(m==null?void 0:m.stacking)??!1,Me=(re?Number.isFinite(p)?p:0:Number.isFinite(p)?p/100:0)*u,Te=re?q:p,Ve=Math.min(Math.max(Number.isFinite(Te)?Te:0,0),100)/100*u,ye=Number.isFinite(Me)&&Me>0,Dt=Number.isFinite(Ve)&&Ve>0;if(!ye&&!Dt)return;const it=ii(m==null?void 0:m.name);if(it&&ci.has(it)&&(!(m!=null&&m.classification)||m.classification==="Condition")){const $t=Me/1e3,ot=m==null?void 0:m.icon,kt=He[it]||{name:it,icon:ot,applications:0,damage:0};kt.applicationsFromUptime=(kt.applicationsFromUptime||0)+$t,!kt.icon&&ot&&(kt.icon=ot),He[it]=kt;const St=s.outgoingConditions[it]||{applications:0,damage:0,skills:{},icon:ot};St.applicationsFromUptime=(St.applicationsFromUptime||0)+$t,!St.icon&&ot&&(St.icon=ot),s.outgoingConditions[it]=St;const Ct=ze[it]||{name:it,icon:ot,applications:0,damage:0};Ct.applicationsFromUptime=(Ct.applicationsFromUptime||0)+$t,!Ct.icon&&ot&&(Ct.icon=ot),ze[it]=Ct;const Nt=s.incomingConditions[it]||{applications:0,damage:0,skills:{},icon:ot};Nt.applicationsFromUptime=(Nt.applicationsFromUptime||0)+$t,!Nt.icon&&ot&&(Nt.icon=ot),s.incomingConditions[it]=Nt}Ue.has(S)||Ue.set(S,{name:m==null?void 0:m.name,stacking:re,icon:m==null?void 0:m.icon}),je.has(S)||je.set(S,new Map);const Pn=je.get(S),Qt=s.account||o.account||o.name||"Unknown";let rt=Pn.get(Qt);rt||(rt={account:Qt,profession:s.profession||o.profession||"Unknown",professions:new Set,professionTimeMs:{},totalMs:0,uptimeMs:0,durationMs:0},Pn.set(Qt,rt));const ft=o.profession||s.profession;ft&&ft!=="Unknown"&&(rt.professions.add(ft),rt.professionTimeMs[ft]=(rt.professionTimeMs[ft]||0)+u,rt.profession=ft),rt.totalMs+=ye?Me:0,rt.uptimeMs+=Dt?Ve:0,rt.durationMs+=u}),(Ye=o.defenses)!=null&&Ye[0]){const C=p=>{let q=String(p||"Unknown").replace(/^Juvenile\s+/i,"")||"Unknown";return q.toUpperCase().includes("UNKNOWN")&&(q="Unknown"),q},m=(()=>{const p=Array.isArray(o==null?void 0:o.minions)?o.minions:[];if(p.length===0)return{total:0,byMinion:{}};let q=0;const re={};return p.forEach(ge=>{const Me=Array.isArray(ge==null?void 0:ge.totalDamageTakenDist)?ge.totalDamageTakenDist:[],Te=Array.isArray(Me[0])?Me[0]:[],nt=C(ge==null?void 0:ge.name);Te.forEach(Ve=>{const ye=Number((Ve==null?void 0:Ve.totalDamage)??(Ve==null?void 0:Ve.damageTaken)??0);Number.isFinite(ye)&&(q+=ye,re[nt]=(re[nt]||0)+ye)})}),{total:q,byMinion:re}})();m.byMinion&&typeof m.byMinion=="object"&&Object.entries(m.byMinion).forEach(([p,q])=>{const re=Number(q||0);!Number.isFinite(re)||re<=0||(s.defenseMinionDamageTaken[p]=(s.defenseMinionDamageTaken[p]||0)+re)}),mi.forEach(p=>{const q=p.id==="minionDamageTaken"?m.total:Number(o.defenses[0][p.field]??0);Number.isFinite(q)&&(s.defenseTotals[p.id]=(s.defenseTotals[p.id]||0)+q)})}(Qe=o.support)!=null&&Qe[0]&&li.forEach(C=>{let S=Number(o.support[0][C.field]??0);Number.isFinite(S)&&(Pe.has(C.field)&&S>999999&&(S=0),s.supportTotals[C.id]=(s.supportTotals[C.id]||0)+S)});const V=(C,S)=>{Number.isFinite(S)&&(s.healingTotals[C]=(s.healingTotals[C]||0)+S)},O=(C,S)=>Array.isArray(C)?C.reduce((m,p)=>m+Number((p==null?void 0:p[S])??0),0):0,T=(C,S,m)=>{if(!Number.isFinite(m)||m<=0)return;const p=i[S],q=S===M,re=p==null?void 0:p.notInSquad,ge=!re,Me=ge&&(p==null?void 0:p.group)!=null&&p.group===o.group;V(C,m),ge&&V(`squad${C[0].toUpperCase()}${C.slice(1)}`,m),Me&&V(`group${C[0].toUpperCase()}${C.slice(1)}`,m),q&&V(`self${C[0].toUpperCase()}${C.slice(1)}`,m),re&&V(`offSquad${C[0].toUpperCase()}${C.slice(1)}`,m)};if(Array.isArray(o.rotation)){let C=0;o.rotation.forEach(S=>{var p;if(!(S!=null&&S.id)||!gi(S.id,t.skillMap))return;const m=((p=S.skills)==null?void 0:p.length)||0;m>0&&(C+=m,V(`resUtility_s${S.id}`,m))}),C>0&&V("resUtility",C)}const R=(Pt=o.extHealingStats)==null?void 0:Pt.outgoingHealingAllies;Array.isArray(R)&&R.forEach((C,S)=>{const m=O(C,"healing"),p=O(C,"downedHealing");T("healing",S,m),T("downedHealing",S,p)});const j=(qt=o.extBarrierStats)==null?void 0:qt.outgoingBarrierAllies;Array.isArray(j)&&j.forEach((C,S)=>{const m=O(C,"barrier");T("barrier",S,m)});const te=(Rt=o.statsAll)==null?void 0:Rt[0],ue=(mt=o.dpsAll)==null?void 0:mt[0],ve=(ct=o.support)==null?void 0:ct[0];if(ui.forEach(C=>{if(C.id==="downContributionPercent"||!C.field)return;let S=0,m=0;C.source==="dpsAll"&&ue?S=Number(ue[C.field]??0):C.source==="statsAll"&&te?(S=Number(te[C.field]??0),m=Number(te[C.denomField||C.weightField||"connectedDamageCount"]??0)):C.source==="support"&&ve?S=Number(ve[C.field]??0):o.statsTargets&&o.statsTargets.forEach(p=>{p!=null&&p[0]&&(S+=Number(p[0][C.field]??0),m+=Number(p[0][C.denomField||C.weightField||"connectedDamageCount"]??0))}),Number.isFinite(S)&&(s.offenseTotals[C.id]=(s.offenseTotals[C.id]||0)+S,C.isRate&&m>0&&(s.offenseRateWeights[C.id]=(s.offenseRateWeights[C.id]||0)+m))}),o.targetDamageDist&&Number.isFinite(g)){const C=o.targetDamageDist.flatMap(S=>S||[]).flatMap(S=>S||[]).reduce((S,m)=>m!=null&&m.id&&m.id===g?S+((m==null?void 0:m.connectedHits)||0):S,0);s.offenseTotals.battleStandardHits=(s.offenseTotals.battleStandardHits||0)+C}s.revives+=((Yt=(lt=o.support)==null?void 0:lt[0])==null?void 0:Yt.resurrects)||0,ue&&(s.damage+=ue.damage||0,s.dps+=ue.dps||0);const Fe=C=>{var q,re,ge,Me;let S=`Skill ${C.id}`;const m=((q=t.skillMap)==null?void 0:q[`s${C.id}`])||((re=t.skillMap)==null?void 0:re[`${C.id}`]);let p=m==null?void 0:m.icon;if(m!=null&&m.name&&(S=m.name),S.startsWith("Skill ")){const Te=At(S,C.id,t.buffMap);Te&&(S=Te,p=((Me=(ge=t.buffMap)==null?void 0:ge[`b${C.id}`])==null?void 0:Me.icon)||p)}return{name:S,icon:p}},Ne=C=>{if(!(C!=null&&C.id))return;const{name:S,icon:m}=Fe(C);de[C.id]||(de[C.id]={name:S,icon:m,damage:0,hits:0,downContribution:0}),de[C.id].name.startsWith("Skill ")&&!S.startsWith("Skill ")&&(de[C.id].name=S),!de[C.id].icon&&m&&(de[C.id].icon=m),de[C.id].damage+=C.totalDamage,de[C.id].hits+=C.connectedHits,de[C.id].downContribution+=Number(C.downContribution||0)},We=o.account||o.name||"Unknown",we=o.profession||"Unknown",_e=`${We}|${we}`;let Ke=Re.get(_e);Ke||(Ke={key:_e,account:We,displayName:We,profession:we,professionList:[we],totalFightMs:0,skills:new Map},Re.set(_e,Ke)),Ke.professionList.includes(we)||Ke.professionList.push(we),Ke.totalFightMs+=t.durationMS||0;const xe=C=>{if(!(C!=null&&C.id))return;const{name:S,icon:m}=Fe(C),p=`s${C.id}`;let q=Ke.skills.get(p);q||(q={id:p,name:S,icon:m,damage:0,downContribution:0},Ke.skills.set(p,q)),q.name.startsWith("Skill ")&&!S.startsWith("Skill ")&&(q.name=S),!q.icon&&m&&(q.icon=m),q.damage+=Number(C.totalDamage||0),q.downContribution+=Number(C.downContribution||0)};if(J==="total")(dt=o.totalDamageDist)==null||dt.forEach(C=>{C==null||C.forEach(S=>{Ne(S),xe(S)})});else{const C=new Map;(ht=o.targetDamageDist)==null||ht.forEach(m=>{m==null||m.forEach(p=>{p==null||p.forEach(q=>{const re=Number(q==null?void 0:q.id);if(Number.isFinite(re)){const ge=C.get(re)||{damage:0,hits:0,downContribution:0};ge.damage+=Number((q==null?void 0:q.totalDamage)||0),ge.hits+=Number((q==null?void 0:q.connectedHits)||0),ge.downContribution+=Number((q==null?void 0:q.downContribution)||0),C.set(re,ge)}Ne(q),xe(q)})})}),!(t!=null&&t.detailedWvW)&&((Ut=o.totalDamageDist)==null||Ut.forEach(m=>{m==null||m.forEach(p=>{const q=Number(p==null?void 0:p.id);if(!Number.isFinite(q))return;const re=C.get(q);if(!re){Ne(p),xe(p);return}const ge=Number((p==null?void 0:p.totalDamage)||0),Me=Number((p==null?void 0:p.connectedHits)||0),Te=Number((p==null?void 0:p.downContribution)||0),nt=ge-Number(re.damage||0),Ve=Me-Number(re.hits||0),ye=Te-Number(re.downContribution||0);if(nt<=0&&Ve<=0&&ye<=0)return;const Dt={...p,totalDamage:Math.max(0,nt),connectedHits:Math.max(0,Ve),downContribution:Math.max(0,ye)};Ne(Dt),xe(Dt)})}))}o.totalDamageTaken&&o.totalDamageTaken.forEach(C=>{C==null||C.forEach(S=>{var re,ge,Me,Te;if(!(S!=null&&S.id))return;let m=`Skill ${S.id}`;const p=((re=t.skillMap)==null?void 0:re[`s${S.id}`])||((ge=t.skillMap)==null?void 0:ge[`${S.id}`]);let q=p==null?void 0:p.icon;if(p!=null&&p.name&&(m=p.name),m.startsWith("Skill ")){const nt=At(m,S.id,t.buffMap);nt&&(m=nt,q=((Te=(Me=t.buffMap)==null?void 0:Me[`b${S.id}`])==null?void 0:Te.icon)||q)}Se[S.id]||(Se[S.id]={name:m,icon:q,damage:0,hits:0}),(!Se[S.id].name.startsWith("Skill ")||m.startsWith("Skill "))&&(Se[S.id].name=m),!Se[S.id].icon&&q&&(Se[S.id].icon=q),Se[S.id].damage+=S.totalDamage,Se[S.id].hits+=S.hits})})}),k.forEach(o=>{if(o!=null&&o.isFake)return;const M=et((o==null?void 0:o.profession)||(o==null?void 0:o.name)||(o==null?void 0:o.id));M&&(Ie[M]=(Ie[M]||0)+1)});const h=ri({players:i,targets:k,skillMap:t.skillMap,buffMap:t.buffMap,getPlayerKey:o=>o.account&&o.account!=="Unknown"?o.account:o.name||null}),D=ln(t.buffMap);Object.entries(h.playerConditions).forEach(([o,M])=>{const U=ce.get(o);U&&Object.entries(M).forEach(([Z,l])=>{const s=U.outgoingConditions[Z]||{applications:0,damage:0,skills:{},icon:l.icon};s.applications+=Number(l.applications||0),s.damage+=Number(l.damage||0),l.applicationsFromBuffs&&(s.applicationsFromBuffs=(s.applicationsFromBuffs||0)+l.applicationsFromBuffs),l.applicationsFromBuffsActive&&(s.applicationsFromBuffsActive=(s.applicationsFromBuffsActive||0)+l.applicationsFromBuffsActive),Object.entries(l.skills||{}).forEach(([y,u])=>{const w=s.skills[y]||{name:u.name,hits:0,damage:0,icon:u.icon};w.hits+=Number(u.hits||0),w.damage+=Number(u.damage||0),!w.icon&&u.icon&&(w.icon=u.icon),s.skills[y]=w}),!s.icon&&l.icon&&(s.icon=l.icon),U.outgoingConditions[Z]=s})}),Object.entries(h.summary).forEach(([o,M])=>{const U=He[o]||{name:M.name||o,icon:M.icon,applications:0,damage:0};U.applications+=Number(M.applications||0),U.damage+=Number(M.damage||0),M.applicationsFromBuffs&&(U.applicationsFromBuffs=(U.applicationsFromBuffs||0)+M.applicationsFromBuffs),M.applicationsFromBuffsActive&&(U.applicationsFromBuffsActive=(U.applicationsFromBuffsActive||0)+M.applicationsFromBuffsActive),!U.icon&&M.icon&&(U.icon=M.icon),He[o]=U}),N.forEach(o=>{const M=o.account&&o.account!=="Unknown"?o.account:o.name||"Unknown",U=ce.get(M);!U||!o.totalDamageTaken||o.totalDamageTaken.forEach(Z=>Z==null?void 0:Z.forEach(l=>{var ue,ve,Fe,Ne,We,we;if(!(l!=null&&l.id))return;let s=`Skill ${l.id}`;const y=((ue=t.skillMap)==null?void 0:ue[`s${l.id}`])||((ve=t.skillMap)==null?void 0:ve[`${l.id}`]);y!=null&&y.name&&(s=y.name);const u=At(s,l.id,t.buffMap);if(!u)return;const w=(Ne=(Fe=t.buffMap)==null?void 0:Fe[`b${l.id}`])==null?void 0:Ne.name,x=D.get(u)||((we=(We=t.buffMap)==null?void 0:We[`b${l.id}`])==null?void 0:we.icon),V=(y==null?void 0:y.icon)||x;s.startsWith("Skill ")&&(w||u)&&(s=w||u);const O=Number(l.hits??0),T=Number(l.totalDamage??0),R=ze[u]||{name:u,icon:x,applications:0,damage:0};R.applications+=Number.isFinite(O)?O:0,R.damage+=Number.isFinite(T)?T:0,!R.icon&&x&&(R.icon=x),ze[u]=R;const j=U.incomingConditions[u]||{applications:0,damage:0,skills:{},icon:x};j.applications+=Number.isFinite(O)?O:0,j.damage+=Number.isFinite(T)?T:0;const te=j.skills[s]||{name:s,hits:0,damage:0,icon:V};te.hits+=Number.isFinite(O)?O:0,te.damage+=Number.isFinite(T)?T:0,!te.icon&&V&&(te.icon=V),j.skills[s]=te,!j.icon&&x&&(j.icon=x),U.incomingConditions[u]=j}))});const F=t.player_damage_mitigation||t.playerDamageMitigation,A=F&&typeof F=="object"&&Object.keys(F).length>0;A&&Object.entries(F).forEach(([o,M])=>{if(!M||typeof M!="object")return;const U=Dn(o),Z=kn(It,U.account,U);Object.values(M).forEach(l=>{Ee((l==null?void 0:l.avoided_damage)??(l==null?void 0:l.avoidedDamage))<=0||Cn(Z.mitigationTotals,l)})});const E=t.player_minion_damage_mitigation||t.playerMinionDamageMitigation,c=E&&typeof E=="object"&&Object.keys(E).length>0;c&&Object.entries(E).forEach(([o,M])=>{if(!M||typeof M!="object")return;const U=Dn(o);Object.entries(M).forEach(([Z,l])=>{if(!l||typeof l!="object")return;const s=`${U.account}::${Z}`,y=Sn(Lt,s,{...U,minion:String(Z||"Unknown")});Object.values(l).forEach(u=>{Cn(y.mitigationTotals,u)})})}),(!A||!c)&&(A||N.forEach(o=>{const M=(o==null?void 0:o.totalDamageTaken)||[];if(!Array.isArray(M)||M.length===0)return;const U=o.account||o.name||"Unknown",Z={account:U,name:o.name||U,profession:et(o.profession||"Unknown")};kn(It,U,Z);const l=Array.isArray(M)?M[0]:null;l==null||l.forEach(s=>{if(!(s!=null&&s.id))return;const y=Ee(s.blocked),u=Ee(s.evaded),w=Ee(s.glance??s.glanced),x=Ee(s.missed),V=Ee(s.invulned),O=Ee(s.interrupted),T=Ee(s.hits??s.connectedHits),R=Number(s.id);wn(Nn,`${U}::${R}`,{totalHits:T,blocked:y,evaded:u,glanced:w,missed:x,invulned:V,interrupted:O})})}),c||N.forEach(o=>{const M=(o==null?void 0:o.minions)||[];if(!Array.isArray(M)||M.length===0)return;const U=o.account||o.name||"Unknown",Z={account:U,name:o.name||U,profession:et(o.profession||"Unknown")};M.forEach(l=>{const s=(l==null?void 0:l.totalDamageTakenDist)||[];if(!Array.isArray(s)||s.length===0)return;let y=String((l==null?void 0:l.name)||"Unknown").replace(/^Juvenile\s+/i,"")||"Unknown";y.toUpperCase().includes("UNKNOWN")&&(y="Unknown");const u=`${U}::${y}`;Sn(Lt,u,{...Z,minion:y});const w=Array.isArray(s)?s[0]:null;w==null||w.forEach(x=>{if(!(x!=null&&x.id))return;const V=Ee(x.blocked),O=Ee(x.evaded),T=Ee(x.glance??x.glanced),R=Ee(x.missed),j=Ee(x.invulned),te=Ee(x.interrupted),ue=Ee(x.hits??x.connectedHits),ve=Number(x.id);wn(An,`${u}::${ve}`,{totalHits:ue,blocked:V,evaded:O,glanced:T,missed:R,invulned:j,interrupted:te})})})}))});const Mn=(e,t)=>{const i=new Map,k=a=>{let B=i.get(a);return B||(B=pt(),i.set(a,B)),B};t.forEach((a,B)=>{const b=B.lastIndexOf("::"),z=b>-1?B.slice(0,b):B,H=b>-1?Number(B.slice(b+2)):Number.NaN,Y=Number.isFinite(H)?wi(H):{hasSkill:!1,avg:0,min:0,hits:0};if(!Y.hasSkill||Y.hits<=0)return;const Q=Y.avg,ee=Y.min,ie=a.glanced*Q/2+(a.blocked+a.evaded+a.missed+a.invulned+a.interrupted)*Q,fe=a.glanced*ee/2+(a.blocked+a.evaded+a.missed+a.invulned+a.interrupted)*ee;if(ie<=0)return;const N=k(z);N.totalHits+=a.totalHits,N.blocked+=a.blocked,N.evaded+=a.evaded,N.glanced+=a.glanced,N.missed+=a.missed,N.invulned+=a.invulned,N.interrupted+=a.interrupted,N.totalMitigation+=ie,N.minMitigation+=fe}),e.forEach((a,B)=>{const b=i.get(B)||pt();a.mitigationTotals.totalHits=b.totalHits,a.mitigationTotals.blocked=b.blocked,a.mitigationTotals.evaded=b.evaded,a.mitigationTotals.glanced=b.glanced,a.mitigationTotals.missed=b.missed,a.mitigationTotals.invulned=b.invulned,a.mitigationTotals.interrupted=b.interrupted,a.mitigationTotals.totalMitigation=b.totalMitigation,a.mitigationTotals.minMitigation=b.minMitigation})};Mn(It,Nn),Mn(Lt,An);const Mi=ne>0?Math.round(se/ne):0,Ti=ne>0?Math.round(he/ne):0,Fi=Je>0?(f/Je).toFixed(2):f>0?"∞":"0.00",Ei=ae>0?(me/ae).toFixed(2):me>0?"∞":"0.00",Tn=(e,t)=>{const k=e.filter(b=>Number.isFinite(b.value)&&(t?b.value>0:b.value>=0)).sort((b,z)=>{const H=t?z.value-b.value:b.value-z.value;return H!==0?H:b.account.localeCompare(z.account)});let a=null,B=0;return k.map((b,z)=>((a===null||b.value!==a)&&(B=z+1,a=b.value),{rank:B,...b}))},_t=Array.from(ce.values()).map(e=>{const t=Array.from(e.professions).filter(i=>i!=="Unknown");if(e.professionList=t,t.length>0){let i=t[0],k=e.professionTimeMs[i]||0;t.forEach(a=>{const B=e.professionTimeMs[a]||0;B>k&&(k=B,i=a)}),e.profession=i}return{key:e.account,stat:e}}),Fn=e=>{const t=ce.get(e.account);if(!t){const a=e.professionList.length>0?e.professionList:e.profession?[e.profession]:[];return{...e,professionList:a}}const i=t.professionList&&t.professionList.length>0?t.professionList:Array.from(t.professions||[]).filter(a=>a&&a!=="Unknown"),k=t.profession||e.profession;return{...e,profession:k,professionList:i.length>0?i:k?[k]:[],activeMs:t.defenseActiveMs||t.totalFightMs||e.activeMs}},vi=Array.from(It.values()).map(Fn).filter(e=>Ai(e.mitigationTotals)).sort((e,t)=>e.account.localeCompare(t.account)),Bi=Array.from(Lt.values()).map(Fn).filter(e=>e.mitigationTotals.totalMitigation>0).sort((e,t)=>{const i=e.account.localeCompare(t.account);return i!==0?i:String(e.minion||"").localeCompare(String(t.minion||""))}),xt=(e,t)=>{switch(t){case"downContrib":return e.downContrib;case"barrier":return e.barrier;case"healing":return e.healing;case"dodges":return e.dodges;case"strips":return e.strips;case"cleanses":return e.cleanses;case"cc":return e.cc;case"stability":return e.stab;case"revives":return e.revives;case"dps":return e.dps;case"damage":return e.damage;case"participation":return e.logsJoined;case"closestToTag":return!e.isCommander&&e.distCount>0?e.totalDist/e.distCount:Number.POSITIVE_INFINITY;default:return 0}},Ze=(e,t)=>Tn(_t.map(({stat:i})=>({account:i.account,profession:i.profession,professionList:i.professionList,value:xt(i,e),count:i.logsJoined})),t),Le={downContrib:Ze("downContrib",!0),barrier:Ze("barrier",!0),healing:Ze("healing",!0),dodges:Ze("dodges",!0),strips:Ze("strips",!0),cleanses:Ze("cleanses",!0),cc:Ze("cc",!0),stability:Ze("stability",!0),revives:Ze("revives",!0),participation:Ze("participation",!0),dps:Ze("dps",!0),damage:Ze("damage",!0),closestToTag:Ze("closestToTag",!1).filter(e=>Number.isFinite(e.value))},Ii={downContrib:"downContrib",barrier:"barrier",healing:"healing",dodges:"dodges",strips:"strips",cleanses:"cleanses",cc:"cc",stability:"stability",closestToTag:"closestToTag"},Ae=e=>{const t=e==null?void 0:e[0];return{value:(t==null?void 0:t.value)??0,player:(t==null?void 0:t.account)??"-",count:(t==null?void 0:t.count)??0,profession:(t==null?void 0:t.profession)??"Unknown",professionList:(t==null?void 0:t.professionList)??[]}},at={maxDownContrib:Ae([]),maxBarrier:Ae([]),maxHealing:Ae([]),maxDodges:Ae([]),maxStrips:Ae([]),maxCleanses:Ae([]),maxCC:Ae([]),maxStab:Ae([]),closestToTag:Ae([])},st={},Li=(e,t)=>{if(t==="closestToTag")return xt(e,t);const i=Math.max(1,(e.totalFightMs||0)/1e3);return xt(e,t)/i};Object.values(Ii).forEach(e=>{const t=e!=="closestToTag";st[e]=Tn(_t.map(({stat:i})=>({account:i.account,profession:i.profession,professionList:i.professionList,value:Li(i,e),count:i.logsJoined})),t)}),at.maxDownContrib=Ae(st.downContrib),at.maxBarrier=Ae(st.barrier),at.maxHealing=Ae(st.healing),at.maxDodges=Ae(st.dodges),at.maxStrips=Ae(st.strips),at.maxCleanses=Ae(st.cleanses),at.maxCC=Ae(st.cc),at.maxStab=Ae(st.stability),at.closestToTag=Ae(st.closestToTag);const xi={maxDownContrib:Ae(Le.downContrib),maxBarrier:Ae(Le.barrier),maxHealing:Ae(Le.healing),maxDodges:Ae(Le.dodges),maxStrips:Ae(Le.strips),maxCleanses:Ae(Le.cleanses),maxCC:Ae(Le.cc),maxStab:Ae(Le.stability),closestToTag:Ae(Le.closestToTag)};let zt={player:"None",account:"None",score:-1,profession:"Unknown",professionList:[],color:"#64748b",topStats:[]},En,vn,Bn=0;if(oe!=null&&oe.showMvp){const e={"Down Contribution":"downContribution",Healing:"healing",Cleanses:"cleanses",Strips:"strips",Stability:"stability",CC:"cc",Revives:"revives","Distance to Tag":"distanceToTag",Participation:"participation",Dodging:"dodging",DPS:"dps",Damage:"damage"},t=B=>{const b=e[B];return b?Number(pe[b]||0)>0:!1},i=[],k=B=>[...B||[]].filter(b=>t(b==null?void 0:b.name)).sort((b,z)=>z.ratio-b.ratio||b.rank-z.rank||b.name.localeCompare(z.name)).slice(0,3),a=B=>{var z;if(!B)return;const b=k(B.contribs);return{...B,player:B.name,reason:((z=b[0])==null?void 0:z.name)||"Top Performance",topStats:b}};_t.forEach(({stat:B})=>{let b=0;const z=[],H=(Y,Q,ee,ie,fe=!0)=>{var W,K;if(ee<=0)return;const N=((W=Q[0])==null?void 0:W.value)||0;if(N&&Number.isFinite(Y)&&(fe?Y>0:Y<Number.POSITIVE_INFINITY)){const X=fe?Y/N:N/Y;b+=X*ee;const g=((K=Q.find(h=>h.account===B.account))==null?void 0:K.rank)||0;z.push({name:ie,ratio:X,val:Y.toLocaleString(),rank:g})}};H(B.downContrib,Le.downContrib,pe.downContribution,"Down Contribution"),H(B.healing,Le.healing,pe.healing,"Healing"),H(B.cleanses,Le.cleanses,pe.cleanses,"Cleanses"),H(B.strips,Le.strips,pe.strips,"Strips"),H(B.stab,Le.stability,pe.stability,"Stability"),H(B.cc,Le.cc,pe.cc,"CC"),H(B.revives,Le.revives,pe.revives,"Revives"),H(xt(B,"closestToTag"),Le.closestToTag,pe.distanceToTag,"Distance to Tag",!1),H(B.logsJoined,Le.participation,pe.participation,"Participation"),H(B.dodges,Le.dodges,pe.dodging,"Dodging"),H(B.dps,Le.dps,pe.dps,"DPS"),H(B.damage,Le.damage,pe.damage,"Damage"),i.push({...B,score:b,contribs:z.filter(Y=>t(Y.name))})}),i.sort((B,b)=>b.score-B.score),i[0]&&i[0].score>0&&(zt=a(i[0])||zt),En=a(i[1]),vn=a(i[2]),Bn=i.length>0?i.reduce((B,b)=>B+b.score,0)/i.length:0}const In=Object.values(de).sort((e,t)=>t.damage-e.damage||t.hits-e.hits||String(e.name||"").localeCompare(String(t.name||""))).slice(0,25),Ln=Object.values(de).sort((e,t)=>t.downContribution-e.downContribution||t.hits-e.hits||String(e.name||"").localeCompare(String(t.name||""))).slice(0,25),Pi=le==="downContribution"?Ln:In,qi=Object.values(Se).sort((e,t)=>t.damage-e.damage).slice(0,25),Ri=e=>{const t=String(e).replace(/^Detailed\s*WvW\s*-\s*/i,"").replace(/^World\s*vs\s*World\s*-\s*/i,"").replace(/^WvW\s*-\s*/i,"").trim(),i=t.match(/^(Red|Blue|Green)\s+(?:Alpine|Desert)?\s*Borderlands$/i);return i?`${i[1]} Borderlands`:t||"Unknown"},ut=(e,t)=>Ri((e==null?void 0:e.zone)||(e==null?void 0:e.mapName)||(e==null?void 0:e.map)||(e==null?void 0:e.location)||(e==null?void 0:e.fightName)||(t==null?void 0:t.fightName)||(t==null?void 0:t.encounterName)||"Unknown"),Ui=(e,t)=>{const i=(t==null?void 0:t.permalink)||(e==null?void 0:e.permalink);if(typeof i=="string"&&i.trim().length>0)return i.trim();const k=e==null?void 0:e.uploadLinks;if(!Array.isArray(k))return"";for(const a of k){if(typeof a=="string"&&a.trim().length>0)return a.trim();if(a&&typeof a=="object"){const B=a.permalink||a.link||a.url||a.reportLink;if(typeof B=="string"&&B.trim().length>0)return B.trim()}}return""},$i=(e,t)=>{const i=Number((e==null?void 0:e.durationMS)||0);return i>0?wt(i):(typeof(t==null?void 0:t.encounterDuration)=="string"?t.encounterDuration.trim():"")||"--:--"},xn=(e,t)=>{if((Array.isArray(e==null?void 0:e.players)?e.players:[]).length>0)return ke(e);if(typeof(e==null?void 0:e.success)=="boolean")return e.success;const k=t==null?void 0:t.dashboardSummary;if(k&&typeof k=="object"){if(k.isWin===!0)return!0;if(k.isWin===!1)return!1}return null},Hi=(e,t)=>{var b,z;const i=Ge((b=e.log)==null?void 0:b.details,e.log),k=Ge((z=t.log)==null?void 0:z.details,t.log),a=i>0,B=k>0;return a&&B&&i!==k?i-k:a!==B?a?-1:1:e.originalIndex-t.originalIndex},Kt=n.map((e,t)=>({log:e,originalIndex:t})).sort(Hi),Oi=Kt.filter(({log:e})=>be(e)),Vt={};G.forEach(e=>{const t=ut(e==null?void 0:e.details,e);Vt[t]=(Vt[t]||0)+1});const ji=Object.entries(Vt).map(([e,t])=>{const i=String(e).trim(),k=/eternal battlegrounds|^ebg$/i.test(i);let a="#64748b";return k?a="#ffffff":/red/i.test(i)?a="#ef4444":/blue/i.test(i)?a="#3b82f6":/green/i.test(i)&&(a="#22c55e"),{name:e,value:t,color:a}}).sort((e,t)=>t.value-e.value),{boonTables:Wi}=Wn(G),_i=Kt.map(({log:e})=>{const t=e==null?void 0:e.details,i=Array.isArray(t==null?void 0:t.players)?t.players:[],k=Array.isArray(t==null?void 0:t.targets)?t.targets:[],a=e!=null&&e.dashboardSummary&&typeof e.dashboardSummary=="object"?e.dashboardSummary:null,B=i.filter(ie=>!ie.notInSquad),b=k.filter(ie=>!ie.isFake),z=Math.max(0,Number((a==null?void 0:a.squadCount)||0)),H=Math.max(0,Number((a==null?void 0:a.enemyCount)||0)),Y=B.length>0?B.length:z,Q=b.length>0?b.length:H,ee=i.length>0?i.length:Y;return{timestamp:Ge(t,e),squadCount:Y,friendlyCount:ee,enemies:Q,isWin:xn(t,e)}}).map((e,t)=>({...e,index:t+1,label:`Log ${t+1}`})),Gt={};Array.from(ce.values()).forEach(e=>{e.profession&&e.profession!=="Unknown"&&(Gt[e.profession]=(Gt[e.profession]||0)+1)});const zi=Object.entries(Gt).map(([e,t])=>({name:e,value:t,color:dn(e)})).sort((e,t)=>t.value-e.value),Jt={};Object.keys(Ie).length===0&&G.forEach(e=>{var t,i;(i=(t=e.details)==null?void 0:t.targets)==null||i.forEach(k=>{if(k.isFake)return;const a=k.profession&&k.profession!=="Unknown"?k.profession:k.name||k.id||"Unknown",B=et(a);Jt[B]=(Jt[B]||0)+1})});const Ki=Object.keys(Ie).length>0?Ie:Jt,Vi=Object.entries(Ki).map(([e,t])=>({name:e,value:t,color:dn(e)})).sort((e,t)=>t.value-e.value),Gi=Kt.map(({log:e},t)=>{const i=e==null?void 0:e.details,k=Array.isArray(i==null?void 0:i.players)?i.players:[],a=k.filter(c=>!c.notInSquad),B=k.filter(c=>c.notInSquad),z=(Array.isArray(i==null?void 0:i.targets)?i.targets:[]).filter(c=>!c.isFake),H=e!=null&&e.dashboardSummary&&typeof e.dashboardSummary=="object"?e.dashboardSummary:null,Y=a.reduce((c,L)=>{var _,o;return c+(((o=(_=L.dpsAll)==null?void 0:_[0])==null?void 0:o.damage)||0)},0),Q=a.reduce((c,L)=>{var _,o;return c+(((o=(_=L.defenses)==null?void 0:_[0])==null?void 0:o.damageTaken)||0)},0),{enemyDeaths:ee,enemyDownsDeaths:ie}=De(i),fe=xn(i,e),N=Ge(i,e),W=ut(i,e),K=c=>{if(!c||typeof c!="object")return;const L=c.teamID??c.teamId??c.team??c.teamColor??c.team_color;if(L!=null)return L;const _=Object.keys(c).find(o=>/^team/i.test(o));return _?c[_]:void 0},X=(c,L)=>{const _={};return c.forEach(o=>{const M=L(o),U=et(M);U&&(_[U]=(_[U]||0)+1)}),_},g=X(a,c=>(c==null?void 0:c.profession)||(c==null?void 0:c.name)),h=X(B,c=>(c==null?void 0:c.profession)||(c==null?void 0:c.name)),D=X(z,c=>(c==null?void 0:c.profession)||(c==null?void 0:c.name)||(c==null?void 0:c.id)),F=new Set;a.forEach(c=>{const L=K(c);L!=null&&F.add(String(L))});const A=new Map;z.forEach(c=>{if((c==null?void 0:c.enemyPlayer)===!1)return;const L=K(c);if(L==null)return;const _=String(L);F.has(_)||A.set(_,(A.get(_)||0)+1)});const E=Array.from(A.entries()).sort((c,L)=>{const _=L[1]-c[1];return _!==0?_:c[0].localeCompare(L[0],void 0,{numeric:!0})}).slice(0,3).map(([c,L])=>({teamId:c,count:L}));return{id:e.filePath||`fight-${t}`,label:e.encounterName||`Fight ${t+1}`,permalink:Ui(i,e),timestamp:N,mapName:W,duration:$i(i,e),isWin:fe,squadCount:a.length>0?a.length:Math.max(0,Number((H==null?void 0:H.squadCount)||0)),allyCount:B.length,enemyCount:z.length>0?z.length:Math.max(0,Number((H==null?void 0:H.enemyCount)||0)),teamBreakdown:E,alliesDown:a.reduce((c,L)=>{var _,o;return c+(((o=(_=L.defenses)==null?void 0:_[0])==null?void 0:o.downCount)||0)},0),alliesDead:a.length>0?a.reduce((c,L)=>{var _,o;return c+(((o=(_=L.defenses)==null?void 0:_[0])==null?void 0:o.deadCount)||0)},0):Math.max(0,Number((H==null?void 0:H.squadDeaths)||0)),alliesRevived:a.reduce((c,L)=>{var _,o;return Number(((o=(_=L.statsAll)==null?void 0:_[0])==null?void 0:o.saved)||0)>0?c+1:c},0),rallies:0,enemyDeaths:z.length>0||a.length>0?ee:Math.max(0,Number((H==null?void 0:H.enemyDeaths)||0)),enemyDowns:Math.max(0,ie-ee),totalOutgoingDamage:Y,totalIncomingDamage:Q,incomingBarrierAbsorbed:a.reduce((c,L)=>{var _,o;return c+(((o=(_=L.defenses)==null?void 0:_[0])==null?void 0:o.damageBarrier)||0)},0),outgoingBarrierAbsorbed:a.reduce((c,L)=>{var M;const _=(M=L.extBarrierStats)==null?void 0:M.outgoingBarrier;if(!Array.isArray(_))return c;let o=0;return _.forEach(U=>{if(Array.isArray(U)){U.forEach(Z=>{o+=Number((Z==null?void 0:Z.barrier)||0)});return}o+=Number((U==null?void 0:U.barrier)||0)}),c+o},0),squadClassCountsFight:g,allyClassCountsFight:h,enemyClassCounts:D}}),Ji=Oi.map(({log:e},t)=>{const i=e.details;if(!i)return null;const a=(Array.isArray(i.players)?i.players:[]).filter(u=>!u.notInSquad),B=Array.isArray(i.targets)?i.targets:[],b=Ge(i,e),z=ut(i,e),H=Number(i.durationMS||0),{squadDownsDeaths:Y,enemyDownsDeaths:Q,squadDeaths:ee,enemyDeaths:ie}=De(i),fe=new Map,N=(u,w,x)=>{const V=fe.get(u)||{label:u,damage:0,hits:0};V.damage+=w,V.hits+=x,fe.set(u,V)};if(a.forEach(u=>{(Array.isArray(u==null?void 0:u.statsTargets)?u.statsTargets:[]).forEach((x,V)=>{const O=Array.isArray(x)?x[0]:x,T=Number((O==null?void 0:O.damage)??(O==null?void 0:O.totalDmg)??(O==null?void 0:O.connectedDmg)??0),R=Number((O==null?void 0:O.connectedHits)??(O==null?void 0:O.connectedDamageCount)??(O==null?void 0:O.hits)??0);if(T<=0&&R<=0)return;const j=B[V];if(j!=null&&j.isFake)return;const te=(j==null?void 0:j.profession)||(j==null?void 0:j.name)||(j==null?void 0:j.id)||`Target ${V+1}`,ue=et(te);N(ue||String(te),T,R)})}),fe.size===0){const u=new Map,w=x=>{if(!Array.isArray(x)||x.length===0)return[];const V=x[0];if(Array.isArray(V)&&Array.isArray(V[0])){if(typeof V[0][0]=="number")return V;if(Array.isArray(V[0])&&typeof V[0][0]=="number")return x.map(O=>Array.isArray(O)?O[0]||[]:[])}return[]};a.forEach(x=>{w(x==null?void 0:x.targetDamage1S).forEach((O,T)=>{if(!Array.isArray(O)||O.length===0)return;const R=O.map(te=>Number(te)).filter(te=>Number.isFinite(te)&&te>=0);if(R.length===0)return;const j=Math.max(0,R[R.length-1]||0);j<=0||u.set(T,(u.get(T)||0)+j)})}),u.forEach((x,V)=>{if(x<=0)return;const O=B[V];if(O!=null&&O.isFake)return;const T=(O==null?void 0:O.profession)||(O==null?void 0:O.name)||(O==null?void 0:O.id)||`Target ${V+1}`,R=et(T);N(R||String(T),x,0)})}if(fe.size===0&&B.forEach((u,w)=>{if(u!=null&&u.isFake)return;const x=Array.isArray(u==null?void 0:u.totalDamageTaken)?u.totalDamageTaken:Array.isArray(u==null?void 0:u.totalDamageDist)?u.totalDamageDist:[];let V=0,O=0;if(x.forEach(j=>{V+=Number((j==null?void 0:j.totalDamage)||(j==null?void 0:j.damage)||0),O+=Number((j==null?void 0:j.connectedHits)||(j==null?void 0:j.hits)||0)}),V<=0&&Number((u==null?void 0:u.damageTaken)||0)>0&&(V=Number(u.damageTaken||0)),V<=0&&O<=0)return;const T=(u==null?void 0:u.profession)||(u==null?void 0:u.name)||(u==null?void 0:u.id)||`Target ${w+1}`,R=et(T);N(R||String(T),V,O)}),fe.size===0){const u=new Map;B.forEach((w,x)=>{if(w!=null&&w.isFake)return;const V=(w==null?void 0:w.profession)||(w==null?void 0:w.name)||(w==null?void 0:w.id)||`Target ${x+1}`,O=et(V)||String(V);u.set(O,(u.get(O)||0)+1)}),u.forEach((w,x)=>{w>0&&N(x,w,0)})}const W=Array.from(fe.values()).sort((u,w)=>w.damage-u.damage||w.hits-u.hits||u.label.localeCompare(w.label)),K=W.reduce((u,w)=>u+w.damage,0),X=W.map(u=>({label:u.label,damage:u.damage,hits:u.hits,share:K>0?u.damage/K:0})),g=B.filter(u=>!(u!=null&&u.isFake)).length,h=a.length,D=a.reduce((u,w)=>{var x,V;return u+Number(((V=(x=w==null?void 0:w.dpsAll)==null?void 0:x[0])==null?void 0:V.damage)||0)},0),F=a.reduce((u,w)=>{var x,V;return u+Number(((V=(x=w==null?void 0:w.defenses)==null?void 0:x[0])==null?void 0:V.damageTaken)||0)},0),A=a.reduce((u,w)=>{var x,V;return u+Number(((V=(x=w==null?void 0:w.defenses)==null?void 0:x[0])==null?void 0:V.damageBarrier)||0)},0),E=a.reduce((u,w)=>{var O;const x=(O=w==null?void 0:w.extBarrierStats)==null?void 0:O.outgoingBarrier;if(!Array.isArray(x))return u;let V=0;return x.forEach(T=>{Array.isArray(T)?T.forEach(R=>{V+=Number((R==null?void 0:R.barrier)||0)}):V+=Number((T==null?void 0:T.barrier)||0)}),u+V},0),c=a.reduce((u,w)=>{var x,V;return Number(((V=(x=w==null?void 0:w.statsAll)==null?void 0:x[0])==null?void 0:V.saved)||0)>0?u+1:u},0),L=a.reduce((u,w)=>u+Number(on(w)||0),0),_=a.reduce((u,w)=>u+Number(sn(w)||0),0),o=a.reduce((u,w)=>u+Number((w==null?void 0:w.stabGeneration)||0),0),M=a.reduce((u,w)=>u+Number(rn(w)||0),0),U=a.reduce((u,w)=>u+Number(cn(w)||0),0),Z=a.reduce((u,w)=>u+Number(un(w)||0),0),l=a.reduce((u,w)=>u+Number(an(w)||0),0),s=ee>0?ie/ee:ie,y=[{metricId:"winFlag",metricLabel:"Win (1) / Loss (0)",higherIsBetter:!0,value:ke(i)?1:0},{metricId:"squadCount",metricLabel:"Squad Size",higherIsBetter:!0,value:h},{metricId:"enemyCount",metricLabel:"Enemy Count",higherIsBetter:!1,value:g},{metricId:"squadKdr",metricLabel:"Squad KDR",higherIsBetter:!0,value:s},{metricId:"enemyDeaths",metricLabel:"Enemy Deaths",higherIsBetter:!0,value:ie},{metricId:"enemyDowns",metricLabel:"Enemy Downs",higherIsBetter:!0,value:Math.max(0,Q-ie)},{metricId:"squadDeaths",metricLabel:"Squad Deaths",higherIsBetter:!1,value:ee},{metricId:"squadDowns",metricLabel:"Squad Downs",higherIsBetter:!1,value:Math.max(0,Y-ee)},{metricId:"damageDelta",metricLabel:"Damage Delta",higherIsBetter:!0,value:D-F},{metricId:"outgoingDamage",metricLabel:"Outgoing Damage",higherIsBetter:!0,value:D},{metricId:"incomingDamage",metricLabel:"Incoming Damage",higherIsBetter:!1,value:F},{metricId:"cleanses",metricLabel:"Squad Cleanses",higherIsBetter:!0,value:L},{metricId:"strips",metricLabel:"Squad Strips",higherIsBetter:!0,value:_},{metricId:"stability",metricLabel:"Squad Stability",higherIsBetter:!0,value:o},{metricId:"healing",metricLabel:"Squad Healing",higherIsBetter:!0,value:M},{metricId:"barrierOut",metricLabel:"Squad Barrier Out",higherIsBetter:!0,value:U},{metricId:"barrierIncomingAbsorb",metricLabel:"Barrier Absorption (Incoming)",higherIsBetter:!0,value:A},{metricId:"enemyBarrierAbsorb",metricLabel:"Enemy Barrier Absorption",higherIsBetter:!1,value:E},{metricId:"cc",metricLabel:"Squad CC",higherIsBetter:!0,value:Z},{metricId:"downContrib",metricLabel:"Squad Down Contribution",higherIsBetter:!0,value:l},{metricId:"alliesRevived",metricLabel:"Allies Revived (Players)",higherIsBetter:!0,value:c}];return{id:e.filePath||e.id||`fight-${t+1}`,shortLabel:`F${t+1}`,fullLabel:`${z||e.encounterName||"Unknown Map"} • ${wt(H)}`,mapName:z,timestamp:b,duration:wt(H),isWin:ke(i),targetFocus:X,squadMetrics:y}}).filter(Boolean),Yi=Array.from(ce.values()).map(e=>{const t=Object.entries(e.professionTimeMs||{}).map(([i,k])=>({profession:i,timeMs:Number(k||0)})).filter(i=>i.profession&&i.profession!=="Unknown"&&i.timeMs>0).sort((i,k)=>{const a=k.timeMs-i.timeMs;return a!==0?a:i.profession.localeCompare(k.profession)});return{account:e.account||"Unknown",characterNames:Array.from(e.characterNames||[]).filter(Boolean).sort((i,k)=>i.localeCompare(k)),classTimes:t,combatTimeMs:Number(e.squadActiveMs||e.totalFightMs||0),squadTimeMs:(()=>{const i=Number(e.firstSeenFightTs||0),k=Number(e.lastSeenFightTs||0),a=Math.max(0,Number(e.lastSeenFightDurationMs||0));return i>0&&k>0?Math.max(0,k+a-i):Number(e.squadActiveMs||e.totalFightMs||0)})()}}).filter(e=>e.account&&e.account!=="Unknown").sort((e,t)=>{const i=t.squadTimeMs-e.squadTimeMs;return i!==0?i:String(e.account).localeCompare(String(t.account))}),Qi=G.map(e=>e).sort((e,t)=>Ge(e.details,e)-Ge(t.details,t)).map((e,t)=>{const i=e==null?void 0:e.details,k=Array.isArray(i==null?void 0:i.players)?i.players.filter(b=>!(b!=null&&b.notInSquad)):[],a=new Map;k.forEach(b=>{const z=Number(b==null?void 0:b.group),H=Number.isFinite(z)&&z>0?z:0;a.has(H)||a.set(H,{party:H,players:[],classCounts:{}});const Y=et((b==null?void 0:b.profession)||(b==null?void 0:b.name)||"Unknown"),Q=String((b==null?void 0:b.account)||"Unknown"),ee=String((b==null?void 0:b.name)||(b==null?void 0:b.character_name)||""),ie=!!(b!=null&&b.hasCommanderTag),fe=a.get(H);fe.players.push({account:Q,characterName:ee,profession:Y,isCommander:ie}),fe.classCounts[Y]=(fe.classCounts[Y]||0)+1});const B=Array.from(a.values()).map(b=>({...b,players:b.players.sort((z,H)=>{const Y=+!!H.isCommander-+!!z.isCommander;if(Y!==0)return Y;const Q=String(z.profession).localeCompare(String(H.profession));return Q!==0?Q:String(z.account).localeCompare(String(H.account))})})).sort((b,z)=>b.party===0&&z.party!==0?1:z.party===0&&b.party!==0?-1:b.party-z.party);return{id:String((e==null?void 0:e.filePath)||(e==null?void 0:e.id)||`fight-${t+1}`),label:`F${t+1}`,timestamp:Ge(i,e),mapName:ut(i,e),duration:wt(Number((i==null?void 0:i.durationMS)||0)),parties:B}}),Xi=(e,t)=>{const i=(t==null?void 0:t.skillMap)||{},k=(t==null?void 0:t.buffMap)||{};let a=0,B=0,b="";const z=Q=>{const ee=Number(Q);if(!Number.isFinite(ee))return String(Q||"Unknown Skill");const ie=(i==null?void 0:i[`s${ee}`])||(i==null?void 0:i[`${ee}`]);if(ie!=null&&ie.name)return String(ie.name);const fe=(k==null?void 0:k[`b${ee}`])||(k==null?void 0:k[`${ee}`]);return fe!=null&&fe.name?String(fe.name):`Skill ${ee}`},H=Q=>{if(!Q||typeof Q!="object")return;const ee=[Number(Q.max),Number(Q.maxDamage),Number(Q.maxHit)].filter(N=>Number.isFinite(N)),ie=ee.length>0?Math.max(...ee):0;ie>a&&(a=ie,b=z(Q.id));const fe=Number(Q.downContribution||0);fe>B&&(B=fe)};let Y=!1;return Array.isArray(e==null?void 0:e.targetDamageDist)&&e.targetDamageDist.forEach(Q=>{Array.isArray(Q)&&Q.forEach(ee=>{Array.isArray(ee)&&ee.forEach(ie=>{Y=!0,H(ie)})})}),(!Y||a<=0)&&Array.isArray(e==null?void 0:e.totalDamageDist)&&e.totalDamageDist.forEach(Q=>{Array.isArray(Q)&&Q.forEach(ee=>H(ee))}),{peak:a,peakDownContribution:B,skillName:b||"Unknown Skill"}},Zi=(()=>{const e=N=>String(N||"").replace(/^Detailed\s*WvW\s*-\s*/i,"").replace(/^World\s*vs\s*World\s*-\s*/i,"").replace(/^WvW\s*-\s*/i,"").trim(),t=N=>e(N).toLowerCase().split(/[^a-z0-9]+/i).map(W=>W.trim()).filter(Boolean).map(W=>W.length>3&&W.endsWith("s")?W.slice(0,-1):W),i=(N,W)=>{const K=e(N),X=e(W);if(!X)return K;if(!K)return X;const g=t(K),h=t(X),D=new Set(g),F=new Set(h),A=h.length>0&&h.every(c=>D.has(c)),E=g.length>0&&g.every(c=>F.has(c));return A||E?K:`${K} - ${X}`},k=[],a=new Map,B=N=>{const W=A=>{if(!Array.isArray(A)||A.length===0)return[];const E=[];for(let c=0;c<A.length;c+=1){const L=Number(A[c]||0),_=c>0?Number(A[c-1]||0):0;E.push(Math.max(0,L-_))}return E},K=A=>{if(!Array.isArray(A))return[];const E=A.reduce((L,_)=>Math.max(L,Array.isArray(_)?_.length:0),0);if(E<=0)return[];const c=new Array(E).fill(0);return A.forEach(L=>{if(Array.isArray(L))for(let _=0;_<E;_+=1)c[_]+=Number(L[_]||0)}),c},X=A=>Array.isArray(A)?A.map(E=>Number(E||0)):null,h=(A=>{if(!Array.isArray(A)||A.length===0)return null;const E=A[0];if(!Array.isArray(E))return null;if(Array.isArray(E[0])&&Array.isArray(E[0][0]))return K(E);if(Array.isArray(E[0])&&!Array.isArray(E[0][0])){const c=A.map(L=>X(Array.isArray(L)?L[0]:null)).filter(L=>Array.isArray(L)&&L.length>0);if(c.length>0)return K(c)}return null})(N==null?void 0:N.targetDamage1S),D=Array.isArray(N==null?void 0:N.damage1S)&&Array.isArray(N.damage1S[0])?N.damage1S[0]:null,F=h||(Array.isArray(D)?D.map(A=>Number(A||0)):[]);return W(F)},b=(N,W)=>{if(!Array.isArray(N)||N.length===0||W<=0)return 0;let K=0,X=0;for(let g=0;g<N.length;g+=1)K+=Number(N[g]||0),g>=W&&(K-=Number(N[g-W]||0)),g>=W-1&&K>X&&(X=K);return Math.max(0,X)},z=(N,W)=>{if(!Array.isArray(N)||N.length===0||W<=0)return[];const K=[];for(let X=0;X<N.length;X+=W){const g=Math.min(X+W,N.length),h=N.slice(X,g).reduce((D,F)=>D+Number(F||0),0);K.push(h)}return K},H=(N,W)=>{let K=0,X=0;const g=new Map,h=F=>{if(!F||typeof F!="object"||F.indirectDamage)return;const A=Number(F.totalDamage||0),E=Number(F.downContribution||0);!Number.isFinite(A)&&!Number.isFinite(E)||(K+=Number.isFinite(A)?A:0,X+=Number.isFinite(E)?E:0)};return Array.isArray(N==null?void 0:N.targetDamageDist)&&N.targetDamageDist.forEach(F=>{Array.isArray(F)&&F.forEach(A=>{Array.isArray(A)&&A.forEach(E=>{const c=Number(E==null?void 0:E.id);if(Number.isFinite(c)){const L=g.get(c)||{damage:0,downContribution:0};L.damage+=Number((E==null?void 0:E.totalDamage)||0),L.downContribution+=Number((E==null?void 0:E.downContribution)||0),g.set(c,L)}h(E)})})}),!(W!=null&&W.detailedWvW)&&Array.isArray(N==null?void 0:N.totalDamageDist)&&N.totalDamageDist.forEach(F=>{Array.isArray(F)&&F.forEach(A=>{const E=Number(A==null?void 0:A.id);if(!Number.isFinite(E)){h(A);return}const c=g.get(E);if(!c){h(A);return}const L=Number((A==null?void 0:A.totalDamage)||0)-Number(c.damage||0),_=Number((A==null?void 0:A.downContribution)||0)-Number(c.downContribution||0);L<=0&&_<=0||h({...A,totalDamage:Math.max(0,L),downContribution:Math.max(0,_)})})}),{damageTotal:Math.max(0,K),downContributionTotal:Math.max(0,X)}},Y=(N,W)=>{const K=Number(N);if(!Number.isFinite(K))return{name:String(N||"Unknown Skill"),icon:void 0};const X=(W==null?void 0:W.skillMap)||{},g=(W==null?void 0:W.buffMap)||{},h=(X==null?void 0:X[`s${K}`])||(X==null?void 0:X[`${K}`]);if(h!=null&&h.name)return{name:String(h.name),icon:h==null?void 0:h.icon};const D=(g==null?void 0:g[`b${K}`])||(g==null?void 0:g[`${K}`]);return D!=null&&D.name?{name:String(D.name),icon:D==null?void 0:D.icon}:{name:`Skill ${K}`,icon:void 0}},Q=N=>Array.isArray(N)?N.map(W=>Array.isArray(W)?[Number(W[0]),Number(W[1])]:W&&typeof W=="object"?[Number(W.time),Number(W.value)]:null).filter(W=>!!W&&Number.isFinite(W[0])&&W[0]>=0):[],ee=(N,W,K,X,g)=>{if(!N.length||X<=0)return[];const h=Math.max(X*5e3,g||0),D=M=>M.reduce((U,Z)=>Z>=0&&Z<=h+2e3?U+1:U,0),F=N.map(M=>Number(M||0)).filter(M=>Number.isFinite(M)&&M>=0);if(!F.length)return[];const A=[F],E=F.reduce((M,U)=>Math.max(M,U),0),c=F.reduce((M,U)=>Math.min(M,U),Number.POSITIVE_INFINITY);E>h*20&&A.push(F.map(M=>M/1e3)),E<=h*2&&c>=0&&E>0&&E<Math.max(120,X*5+10)&&A.push(F.map(M=>M*1e3));let L=F,_=0,o=-1;return A.forEach(M=>{const U=M.reduce((l,s)=>Math.min(l,s),Number.POSITIVE_INFINITY),Z=new Set([0,...W,...K]);if(Number.isFinite(U)&&h>0&&U>h){const l=Math.floor(U/h)*h;Z.add(l),Z.add(Math.max(0,l-h))}Z.forEach(l=>{const s=M.map(u=>u-l),y=D(s);y>o&&(o=y,_=l,L=M)})}),L.map(M=>M-_).filter(M=>Number.isFinite(M)&&M>=0)},ie=(N,W,K,X,g)=>{const h=ee(N,W,K,X,g);return Array.from(new Set(h.map(D=>Math.floor(D/5e3)).filter(D=>Number.isFinite(D)&&D>=0&&D<X)))};G.map(N=>({log:N,ts:Ge(N==null?void 0:N.details,N)})).sort((N,W)=>N.ts-W.ts).forEach(({log:N},W)=>{const K=N==null?void 0:N.details;if(!K)return;const X=e(K.fightName||N.fightName||`Fight ${W+1}`),g=ut(K,N),h=i(X,String(g||"")),D={},F=Array.isArray(K.players)?K.players:[],A=F.flatMap(l=>{const s=l==null?void 0:l.combatReplayData;return Array.isArray(s)?s.map(y=>Number(y==null?void 0:y.start)):[Number(s==null?void 0:s.start)]}).filter(l=>Number.isFinite(l)&&l>=0);F.forEach(l=>{if(l!=null&&l.notInSquad)return;const s=String((l==null?void 0:l.account)||(l==null?void 0:l.name)||"Unknown"),y=String((l==null?void 0:l.character_name)||(l==null?void 0:l.display_name)||(l==null?void 0:l.name)||""),u=String((l==null?void 0:l.profession)||"Unknown"),w=`${s}|${u}`,x=Xi(l,K),V=Number(x.peak||0),O=Number(x.peakDownContribution||0),T=B(l),{damageTotal:R,downContributionTotal:j}=H(l,K),te=R>0?Math.min(1,Math.max(0,j/R)):0,ue=T.map(m=>Number(m||0)*te),ve=Number(b(T,1)||0),Fe=Number(b(T,5)||0),Ne=Number(b(T,30)||0),We=Number(b(ue,1)||0),we=Number(b(ue,5)||0),_e=Number(b(ue,30)||0),Ke=Math.max(0,Math.ceil(Number((K==null?void 0:K.durationMS)||0)/5e3)),xe=Math.max(0,Math.ceil(T.length/5)),tt=Math.max(0,Math.ceil(ue.length/5)),Ye=Math.max(Ke,xe,tt),Qe=z(T,5),Pt=z(ue,5),qt=Array.from({length:Ye},(m,p)=>Number(Qe[p]||0)),Rt=Array.from({length:Ye},(m,p)=>Number(Pt[p]||0)),mt=new Map,ct=m=>{if(!m||typeof m!="object"||m.indirectDamage)return;const p=Number(m.totalDamage||0),q=Number(m.downContribution||0);if((!Number.isFinite(p)||p<=0)&&(!Number.isFinite(q)||q<=0))return;const re=Number(m.connectedHits||m.hits||0),ge=Y(m.id,K),Me=ge.name,Te=mt.get(Me)||{skillName:Me,damage:0,downContribution:0,hits:0,icon:ge.icon};Te.damage+=Number.isFinite(p)?p:0,Te.downContribution+=Number.isFinite(q)?q:0,Te.hits+=Number.isFinite(re)?re:0,!Te.icon&&ge.icon&&(Te.icon=ge.icon),mt.set(Me,Te)},lt=new Map;Array.isArray(l==null?void 0:l.targetDamageDist)&&l.targetDamageDist.forEach(m=>{Array.isArray(m)&&m.forEach(p=>{Array.isArray(p)&&p.forEach(q=>{const re=Number(q==null?void 0:q.id),ge=Number((q==null?void 0:q.totalDamage)||0),Me=Number((q==null?void 0:q.downContribution)||0);if(Number.isFinite(re)){const Te=lt.get(re)||{damage:0,downContribution:0,hits:0};Te.damage+=Number.isFinite(ge)?ge:0,Te.downContribution+=Number.isFinite(Me)?Me:0,Te.hits+=Number((q==null?void 0:q.connectedHits)||(q==null?void 0:q.hits)||0),lt.set(re,Te)}ct(q)})})}),!(K!=null&&K.detailedWvW)&&Array.isArray(l==null?void 0:l.totalDamageDist)&&l.totalDamageDist.forEach(m=>{Array.isArray(m)&&m.forEach(p=>{const q=Number(p==null?void 0:p.id);if(!Number.isFinite(q)){ct(p);return}const re=lt.get(q);if(!re){ct(p);return}const ge=Number((p==null?void 0:p.totalDamage)||0),Me=Number((p==null?void 0:p.downContribution)||0),Te=Number((p==null?void 0:p.connectedHits)||(p==null?void 0:p.hits)||0),nt=ge-Number(re.damage||0),Ve=Me-Number(re.downContribution||0),ye=Te-Number(re.hits||0);nt<=0&&Ve<=0&&ye<=0||ct({...p,totalDamage:Math.max(0,nt),downContribution:Math.max(0,Ve),connectedHits:Math.max(0,ye),hits:Math.max(0,ye)})})});const dt=(()=>{const m=l==null?void 0:l.combatReplayData;return Array.isArray(m)?m.filter(p=>p&&typeof p=="object"):m&&typeof m=="object"?[m]:[]})(),ht=dt.map(m=>Number(m==null?void 0:m.start)).filter(m=>Number.isFinite(m)&&m>=0),Ut=dt.flatMap(m=>Q(m==null?void 0:m.down).map(([p])=>Number(p||0))),C=dt.flatMap(m=>Q(m==null?void 0:m.dead).map(([p])=>Number(p||0)));D[w]={hit:V,burst1s:ve,burst5s:Fe,burst30s:Ne,hitDown:O,burst1sDown:We,burst5sDown:we,burst30sDown:_e,skillName:x.skillName,buckets5s:qt,buckets5sDown:Rt,downIndices5s:ie(Ut,ht,A,Ye,Number((K==null?void 0:K.durationMS)||0)),deathIndices5s:ie(C,ht,A,Ye,Number((K==null?void 0:K.durationMS)||0)),skillRows:Array.from(mt.values()).sort((m,p)=>p.damage-m.damage).slice(0,50)};const S=a.get(w)||{key:w,account:s,displayName:s,characterName:y,profession:u,professionList:[u],logs:0,peakHit:0,peak1s:0,peak5s:0,peak30s:0,peakHitDown:0,peak1sDown:0,peak5sDown:0,peak30sDown:0,peakFightLabel:"",peakSkillName:""};S.logs+=1,S.professionList.includes(u)||S.professionList.push(u),!S.characterName&&y&&(S.characterName=y),V>S.peakHit&&(S.peakHit=V,S.peakFightLabel=h,S.peakSkillName=x.skillName),ve>S.peak1s&&(S.peak1s=ve),Fe>S.peak5s&&(S.peak5s=Fe),Ne>S.peak30s&&(S.peak30s=Ne),O>S.peakHitDown&&(S.peakHitDown=O),We>S.peak1sDown&&(S.peak1sDown=We),we>S.peak5sDown&&(S.peak5sDown=we),_e>S.peak30sDown&&(S.peak30sDown=_e),a.set(w,S)});const E=Object.values(D).reduce((l,s)=>Math.max(l,Number((s==null?void 0:s.hit)||0)),0),c=Object.values(D).reduce((l,s)=>Math.max(l,Number((s==null?void 0:s.burst1s)||0)),0),L=Object.values(D).reduce((l,s)=>Math.max(l,Number((s==null?void 0:s.burst5s)||0)),0),_=Object.values(D).reduce((l,s)=>Math.max(l,Number((s==null?void 0:s.burst30s)||0)),0),o=Object.values(D).reduce((l,s)=>Math.max(l,Number((s==null?void 0:s.hitDown)||0)),0),M=Object.values(D).reduce((l,s)=>Math.max(l,Number((s==null?void 0:s.burst1sDown)||0)),0),U=Object.values(D).reduce((l,s)=>Math.max(l,Number((s==null?void 0:s.burst5sDown)||0)),0),Z=Object.values(D).reduce((l,s)=>Math.max(l,Number((s==null?void 0:s.burst30sDown)||0)),0);k.push({id:N.filePath||N.id||`fight-${W+1}`,shortLabel:`F${W+1}`,fullLabel:h,timestamp:Ge(K,N),values:D,maxHit:E,max1s:c,max5s:L,max30s:_,maxHitDown:o,max1sDown:M,max5sDown:U,max30sDown:Z})});const fe=Array.from(a.values()).sort((N,W)=>W.peakHit!==N.peakHit?W.peakHit-N.peakHit:N.displayName.localeCompare(W.displayName));return{fights:k,players:fe}})(),yi=(()=>{const e=g=>String(g||"").replace(/^Detailed\s*WvW\s*-\s*/i,"").replace(/^World\s*vs\s*World\s*-\s*/i,"").replace(/^WvW\s*-\s*/i,"").trim(),t=g=>e(g).toLowerCase().split(/[^a-z0-9]+/i).map(h=>h.trim()).filter(Boolean).map(h=>h.length>3&&h.endsWith("s")?h.slice(0,-1):h),i=(g,h)=>{const D=e(g),F=e(h);if(!F)return D;if(!D)return F;const A=t(D),E=t(F),c=new Set(A),L=new Set(E),_=E.length>0&&E.every(M=>c.has(M)),o=A.length>0&&A.every(M=>L.has(M));return _||o?D:`${D} - ${F}`},k=[],a=new Map,B=(g,h)=>{const D=Number(g);if(!Number.isFinite(D))return{name:String(g||"Unknown Skill"),icon:void 0};const F=(h==null?void 0:h.skillMap)||{},A=(h==null?void 0:h.buffMap)||{},E=(F==null?void 0:F[`s${D}`])||(F==null?void 0:F[`${D}`]);if(E!=null&&E.name)return{name:String(E.name),icon:E==null?void 0:E.icon};const c=(A==null?void 0:A[`b${D}`])||(A==null?void 0:A[`${D}`]);return c!=null&&c.name?{name:String(c.name),icon:c==null?void 0:c.icon}:{name:`Skill ${D}`,icon:void 0}},b=(g,h)=>{let D=0,F="";const A=E=>{if(!E||typeof E!="object"||E.indirectDamage)return;const c=[Number(E.max),Number(E.maxDamage),Number(E.maxHit)].filter(_=>Number.isFinite(_)),L=c.length>0?Math.max(...c):0;L>D&&(D=L,F=B(E.id,h).name)};return Array.isArray(g==null?void 0:g.totalDamageDist)&&g.totalDamageDist.forEach(E=>{Array.isArray(E)&&E.forEach(c=>A(c))}),Array.isArray(g==null?void 0:g.targetDamageDist)&&g.targetDamageDist.forEach(E=>{Array.isArray(E)&&E.forEach(c=>{Array.isArray(c)&&c.forEach(L=>A(L))})}),{peak:D,skillName:F||"Unknown Skill"}},z=g=>{if(!Array.isArray(g)||g.length===0)return[];const h=[];for(let D=0;D<g.length;D+=1){const F=Number(g[D]||0),A=D>0?Number(g[D-1]||0):0;h.push(Math.max(0,F-A))}return h},H=g=>{if(!Array.isArray(g)||g.length===0)return[];const h=g.reduce((F,A)=>Math.max(F,Array.isArray(A)?A.length:0),0);if(h<=0)return[];const D=new Array(h).fill(0);return g.forEach(F=>{if(Array.isArray(F))for(let A=0;A<h;A+=1)D[A]+=Number(F[A]||0)}),D},Y=g=>{if(!Array.isArray(g)||g.length===0)return[];const h=g[0];if(typeof h=="number")return g.map(D=>Number(D||0));if(Array.isArray(h)&&h.length>0){if(typeof h[0]=="number")return h.map(D=>Number(D||0));if(Array.isArray(h[0])){const D=h.map(F=>Array.isArray(F)?F.map(A=>Number(A||0)):null).filter(F=>Array.isArray(F)&&F.length>0);if(D.length>0)return H(D)}}return[]},Q=g=>{const h=Y(g==null?void 0:g.powerDamage1S),D=Y(g==null?void 0:g.damage1S),F=h.length>0?h:D;return z(F)},ee=(g,h)=>{const D=g==null?void 0:g.targetPowerDamage1S;if(!Array.isArray(D)||!Array.isArray(D[h]))return[];const F=D[h];if(!Array.isArray(F)||F.length===0)return[];if(typeof F[0]=="number")return F.map(A=>Number(A||0));if(Array.isArray(F[0])&&!Array.isArray(F[0][0]))return F[0].map(A=>Number(A||0));if(Array.isArray(F[0])&&Array.isArray(F[0][0])){const E=F[0].map(c=>Array.isArray(c)?c.map(L=>Number(L||0)):null).filter(c=>Array.isArray(c)&&c.length>0);return H(E)}return[]},ie=(g,h)=>{if(!Array.isArray(g)||g.length===0||h<=0)return 0;let D=0,F=0;for(let A=0;A<g.length;A+=1)D+=Number(g[A]||0),A>=h&&(D-=Number(g[A-h]||0)),A>=h-1&&D>F&&(F=D);return Math.max(0,F)},fe=(g,h)=>{if(!Array.isArray(g)||g.length===0||h<=0)return[];const D=[];for(let F=0;F<g.length;F+=h){const A=Math.min(F+h,g.length),E=g.slice(F,A).reduce((c,L)=>c+Number(L||0),0);D.push(E)}return D},N=g=>Array.isArray(g)?g.map(h=>Array.isArray(h)?[Number(h[0]),Number(h[1])]:h&&typeof h=="object"?[Number(h.time),Number(h.value)]:null).filter(h=>!!h&&Number.isFinite(h[0])&&h[0]>=0):[],W=(g,h,D,F,A)=>{if(!g.length||F<=0)return[];const E=Math.max(F*5e3,A||0),c=s=>s.reduce((y,u)=>u>=0&&u<=E+2e3?y+1:y,0),L=g.map(s=>Number(s||0)).filter(s=>Number.isFinite(s)&&s>=0);if(!L.length)return[];const _=[L],o=L.reduce((s,y)=>Math.max(s,y),0),M=L.reduce((s,y)=>Math.min(s,y),Number.POSITIVE_INFINITY);o>E*20&&_.push(L.map(s=>s/1e3)),o<=E*2&&M>=0&&o>0&&o<Math.max(120,F*5+10)&&_.push(L.map(s=>s*1e3));let U=L,Z=0,l=-1;return _.forEach(s=>{const y=s.reduce((w,x)=>Math.min(w,x),Number.POSITIVE_INFINITY),u=new Set([0,...h,...D]);if(Number.isFinite(y)&&E>0&&y>E){const w=Math.floor(y/E)*E;u.add(w),u.add(Math.max(0,w-E))}u.forEach(w=>{const x=s.map(O=>O-w),V=c(x);V>l&&(l=V,Z=w,U=s)})}),U.map(s=>s-Z).filter(s=>Number.isFinite(s)&&s>=0)},K=(g,h,D,F,A)=>{const E=W(g,h,D,F,A);return Array.from(new Set(E.map(c=>Math.floor(c/5e3)).filter(c=>Number.isFinite(c)&&c>=0&&c<F)))};G.map(g=>({log:g,ts:Ge(g==null?void 0:g.details,g)})).sort((g,h)=>g.ts-h.ts).forEach(({log:g},h)=>{const D=g==null?void 0:g.details;if(!D)return;const F=e(D.fightName||g.fightName||`Fight ${h+1}`),A=ut(D,g),E=i(F,String(A||"")),c={},_=(Array.isArray(D.players)?D.players:[]).filter(T=>!(T!=null&&T.notInSquad)),o=_.flatMap(T=>{const R=T==null?void 0:T.combatReplayData;return Array.isArray(R)?R.map(j=>Number(j==null?void 0:j.start)):[Number(R==null?void 0:R.start)]}).filter(T=>Number.isFinite(T)&&T>=0),M=_.flatMap(T=>{const R=T==null?void 0:T.combatReplayData;return(Array.isArray(R)?R:R?[R]:[]).flatMap(te=>N(te==null?void 0:te.down).map(([ue])=>Number(ue||0)))}),U=_.flatMap(T=>{const R=T==null?void 0:T.combatReplayData;return(Array.isArray(R)?R:R?[R]:[]).flatMap(te=>N(te==null?void 0:te.dead).map(([ue])=>Number(ue||0)))}),Z=new Map,l=new Map,s=new Map;(Array.isArray(D.targets)?D.targets:[]).forEach((T,R)=>{if(!T||T.isFake||!T.enemyPlayer)return;const j=et((T==null?void 0:T.profession)||(T==null?void 0:T.name)||(T==null?void 0:T.id))||"Unknown";s.set(j,(s.get(j)||0)+1);const te=l.get(j)||new Map;Array.isArray(T==null?void 0:T.totalDamageDist)&&T.totalDamageDist.forEach(we=>{Array.isArray(we)&&we.forEach(_e=>{if(!_e||typeof _e!="object"||_e.indirectDamage)return;const Ke=Number(_e.totalDamage||0);if(!Number.isFinite(Ke)||Ke<=0)return;const xe=Number(_e.connectedHits||_e.hits||0),tt=B(_e.id,D),Ye=tt.name,Qe=te.get(Ye)||{skillName:Ye,damage:0,hits:0,icon:tt.icon};Qe.damage+=Ke,Qe.hits+=Number.isFinite(xe)?xe:0,!Qe.icon&&tt.icon&&(Qe.icon=tt.icon),te.set(Ye,Qe)})}),l.set(j,te);const ue=H(_.map(we=>ee(we,R))),ve=ue.length>0?z(ue):Q(T),Fe=b(T,D);let Ne=Z.get(j);Ne||(Ne={perSecond:[],hit:0,skillName:""},Z.set(j,Ne)),ve.length>Ne.perSecond.length&&(Ne.perSecond.length=ve.length);for(let we=0;we<ve.length;we+=1)Ne.perSecond[we]=Number(Ne.perSecond[we]||0)+Number(ve[we]||0);const We=Number(Fe.peak||0);We>Ne.hit&&(Ne.hit=We,Ne.skillName=Fe.skillName||"Unknown Skill")});const u=Array.from(Z.values()).some(T=>Array.isArray(T.perSecond)&&T.perSecond.some(R=>Number(R||0)>0));if(Z.size===0||!u){const T=H(_.map(j=>{const te=Y(j==null?void 0:j.powerDamageTaken1S);return z(te)})),R=Array.from(s.values()).reduce((j,te)=>j+Number(te||0),0);T.length>0&&R>0&&s.forEach((j,te)=>{const ue=Number(j||0)/R,ve=T.map(Ne=>Number(Ne||0)*ue),Fe=Z.get(te);Z.set(te,{perSecond:ve,hit:Number((Fe==null?void 0:Fe.hit)||0),skillName:String((Fe==null?void 0:Fe.skillName)||"")})})}Z.forEach((T,R)=>{var tt;const j=R,te=Number(T.hit||0),ue=Number(ie(T.perSecond,1)||0),ve=Number(ie(T.perSecond,5)||0),Fe=Number(ie(T.perSecond,30)||0),Ne=Math.max(0,Math.ceil(Number((D==null?void 0:D.durationMS)||0)/5e3)),We=Math.max(0,Math.ceil(T.perSecond.length/5)),we=Math.max(Ne,We),_e=fe(T.perSecond,5),Ke=Array.from({length:we},(Ye,Qe)=>Number(_e[Qe]||0));c[j]={hit:te,burst1s:ue,burst5s:ve,burst30s:Fe,skillName:T.skillName||"Unknown Skill",buckets5s:Ke,downIndices5s:K(M,[],o,we,Number((D==null?void 0:D.durationMS)||0)),deathIndices5s:K(U,[],o,we,Number((D==null?void 0:D.durationMS)||0)),skillRows:Array.from(((tt=l.get(R))==null?void 0:tt.values())||[]).sort((Ye,Qe)=>Qe.damage-Ye.damage).slice(0,50)};const xe=a.get(j)||{key:j,account:R,displayName:R,characterName:"",profession:R,professionList:[R],logs:0,peakHit:0,peak1s:0,peak5s:0,peak30s:0,peakFightLabel:"",peakSkillName:""};xe.logs+=1,te>xe.peakHit&&(xe.peakHit=te,xe.peakFightLabel=E,xe.peakSkillName=T.skillName||"Unknown Skill"),ue>xe.peak1s&&(xe.peak1s=ue),ve>xe.peak5s&&(xe.peak5s=ve),Fe>xe.peak30s&&(xe.peak30s=Fe),a.set(j,xe)});const w=Object.values(c).reduce((T,R)=>Math.max(T,Number((R==null?void 0:R.hit)||0)),0),x=Object.values(c).reduce((T,R)=>Math.max(T,Number((R==null?void 0:R.burst1s)||0)),0),V=Object.values(c).reduce((T,R)=>Math.max(T,Number((R==null?void 0:R.burst5s)||0)),0),O=Object.values(c).reduce((T,R)=>Math.max(T,Number((R==null?void 0:R.burst30s)||0)),0);k.push({id:g.filePath||g.id||`fight-${h+1}`,shortLabel:`F${h+1}`,fullLabel:E,timestamp:Ge(D,g),values:c,maxHit:w,max1s:x,max5s:V,max30s:O})});const X=Array.from(a.values()).sort((g,h)=>h.peakHit!==g.peakHit?h.peakHit-g.peakHit:g.displayName.localeCompare(h.displayName));return{fights:k,players:X}})(),eo=Array.from(je.entries()).map(([e,t])=>{const i=Ue.get(e)||{},k=Array.from(t.values()).map(a=>{var ie,fe;const B=Array.from(a.professions||[]).filter(N=>N&&N!=="Unknown");let b=a.profession||"Unknown";if(B.length>0){b=B[0];let N=((ie=a.professionTimeMs)==null?void 0:ie[b])||0;B.forEach(W=>{var X;const K=((X=a.professionTimeMs)==null?void 0:X[W])||0;K>N&&(N=K,b=W)})}const z=a.durationMs||0,H=a.totalMs/1e3,Y=z>0?a.totalMs/z:0,Q=((fe=ce.get(a.account))==null?void 0:fe.supportActiveMs)||z,ee=Q>0?a.uptimeMs/Q:0;return{account:a.account,profession:b,professionList:B,total:H,perSecond:Y,uptimePerSecond:ee,duration:z/1e3}}).filter(a=>a.total>0||a.perSecond>0);return{id:e,name:i.name||e,icon:i.icon,rows:k}}).filter(e=>e.rows.length>0),to=Array.from(Re.values()).map(e=>{const t=Array.from(e.skills.values()).sort((k,a)=>a.damage-k.damage);return{key:e.key,account:e.account,displayName:e.displayName,profession:e.profession,professionList:e.professionList,totalFightMs:e.totalFightMs,skills:t}}).sort((e,t)=>e.displayName.localeCompare(t.displayName));return{total:ne,wins:Ce,losses:Be,avgSquadSize:Mi,avgEnemies:Ti,squadKDR:Fi,enemyKDR:Ei,totalSquadKills:f,totalSquadDeaths:Je,totalEnemyKills:me,totalEnemyDeaths:ae,leaderboards:Le,...xi,outgoingConditionSummary:Object.values(He).sort((e,t)=>t.damage-e.damage),incomingConditionSummary:Object.values(ze).sort((e,t)=>t.damage-e.damage),outgoingConditionPlayers:Array.from(ce.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,conditions:e.outgoingConditions})),incomingConditionPlayers:Array.from(ce.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,conditions:e.incomingConditions})),topSkills:Pi,topIncomingSkills:qi,topSkillsByDamage:In,topSkillsByDownContribution:Ln,playerSkillBreakdowns:to,topSkillsMetric:le,mapData:ji,timelineData:_i,boonTables:Wi,offensePlayers:Array.from(ce.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,offenseTotals:e.offenseTotals,offenseRateWeights:e.offenseRateWeights,totalFightMs:e.totalFightMs})),defensePlayers:Array.from(ce.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,defenseTotals:e.defenseTotals,activeMs:e.defenseActiveMs,minionDamageTakenByMinion:e.defenseMinionDamageTaken})),damageMitigationPlayers:vi,damageMitigationMinions:Bi,supportPlayers:Array.from(ce.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,supportTotals:e.supportTotals,activeMs:e.supportActiveMs})),healingPlayers:Array.from(ce.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,healingTotals:e.healingTotals,activeMs:e.healingActiveMs})),mvp:zt,silver:En,bronze:vn,squadClassData:zi,enemyClassData:Vi,fightBreakdown:Gi,fightDiffMode:Ji,attendanceData:Yi,squadCompByFight:Qi,spikeDamage:Zi,incomingStrikeDamage:yi,specialTables:eo,topStatsPerSecond:at,topStatsLeaderboardsPerSecond:st,avgMvpScore:Bn}})(),qe=(()=>{const $=new Map,J=new Map,le=[],ne=new Map,Ce=new Map;G.forEach(se=>{const he=se.details;if(!he)return;const Je=he.skillMap||{},f=he.fightName||"Log",ae=Ge(he,se)||Date.now(),me={id:se.filePath||se.id||f,label:f,timestamp:ae,skillEntries:{},playerActiveSeconds:{},durationSeconds:he.durationMS?he.durationMS/1e3:0};(he.players||[]).forEach(ke=>{if(ke.notInSquad)return;const ce=ke.account||ke.name||"Unknown",Pe=ke.profession||"Unknown",de=`${ce}|${Pe}`;let Se=J.get(de);Se||(Se={key:de,account:ce,displayName:ce,profession:Pe,professionList:[Pe],logs:0,totalActiveSeconds:0,skillTotals:{}},J.set(de,Se)),Se.logs++;const Re=(Array.isArray(ke.activeTimes)?ke.activeTimes[0]:0)/1e3;Se.totalActiveSeconds=(Se.totalActiveSeconds||0)+Re,me.playerActiveSeconds[de]=Re,(ke.rotation||[]).forEach(He=>{var Et,vt,Bt;if(!(He!=null&&He.id))return;const ze=((Et=He.skills)==null?void 0:Et.length)||0;if(ze<=0)return;const Ie=`s${He.id}`,Ue=((vt=Je[Ie])==null?void 0:vt.name)||`Skill ${He.id}`,je=(Bt=Je[Ie])==null?void 0:Bt.icon;Se.skillTotals[Ie]=(Se.skillTotals[Ie]||0)+ze,$.set(Ie,($.get(Ie)||0)+ze),ne.set(Ie,Ue),je&&!Ce.has(Ie)&&Ce.set(Ie,je),me.skillEntries[Ie]||(me.skillEntries[Ie]={name:Ue,icon:je,players:{}}),!me.skillEntries[Ie].icon&&je&&(me.skillEntries[Ie].icon=je),me.skillEntries[Ie].players[de]=(me.skillEntries[Ie].players[de]||0)+ze})}),le.push(me)});const Be=Array.from($.entries()).map(([se,he])=>({id:se,name:ne.get(se)||se,total:he,icon:Ce.get(se)})).sort((se,he)=>he.total-se.total);return{logRecords:le,players:Array.from(J.values()),skillOptions:Be,resUtilitySkills:[]}})();return{validLogs:G,stats:$e,skillUsageData:qe}},bt=(n,r)=>{const d={};return r.forEach(I=>{n&&Object.prototype.hasOwnProperty.call(n,I)&&(d[I]=n[I])}),d},fn=n=>!!(n&&n.__statsPruned===!0),gn=(n,r)=>{if(!n||typeof n!="object")return n;const d={};return Object.entries(n).forEach(([I,P])=>{if(!P||typeof P!="object")return;const v={};typeof P.name=="string"&&(v.name=P.name),typeof P.icon=="string"&&(v.icon=P.icon),r!=null&&r.includeClassification&&typeof P.classification=="string"&&(v.classification=P.classification),r!=null&&r.includeStacking&&(typeof P.stacking=="boolean"?v.stacking=P.stacking:typeof P.stacking=="number"&&(v.stacking=!!P.stacking)),Object.keys(v).length>0&&(d[I]=v)}),d},bn=n=>{var d;const r=(d=n==null?void 0:n.statsAll)==null?void 0:d[0];return!r||typeof r!="object"?!1:r.distToCom!==void 0&&r.distToCom!=="Infinity"||r.stackDist!==void 0},hi=(n,r)=>{const d=I=>{if(!I||typeof I!="object")return null;const P=bt(I,["start","down","dead"]);return r&&Array.isArray(I.positions)&&(P.positions=I.positions),P};return Array.isArray(n)?n.map(I=>d(I)).filter(I=>!!I):n&&typeof n=="object"?d(n):n},pn=n=>{if(!n||typeof n!="object")return n;const r=bt(n,["players","targets","durationMS","uploadTime","timeStart","timeStartStd","timeEnd","timeEndStd","fightName","zone","mapName","map","location","permalink","uploadLinks","success","teamBreakdown","teamCounts","combatReplayMetaData","skillMap","buffMap","encounterDuration","player_damage_mitigation","player_minion_damage_mitigation","playerDamageMitigation","playerMinionDamageMitigation"]);if(r.skillMap=gn(r.skillMap,{includeClassification:!1,includeStacking:!1}),r.buffMap=gn(r.buffMap,{includeClassification:!0,includeStacking:!0}),Array.isArray(r.players)){const d=n.players,P=d.filter(v=>!(v!=null&&v.notInSquad)).some(v=>!(v!=null&&v.hasCommanderTag)&&!bn(v));r.players=d.map(v=>{const be=bt(v,["name","display_name","character_name","profession","elite_spec","group","dpsAll","statsAll","dpsTargets","statsTargets","defenses","support","rotation","extHealingStats","extBarrierStats","squadBuffVolumes","selfBuffs","groupBuffs","squadBuffs","selfBuffsActive","groupBuffsActive","squadBuffsActive","buffUptimes","totalDamageDist","targetDamageDist","damage1S","targetDamage1S","powerDamageTaken1S","targetPowerDamage1S","totalDamageTaken","totalDamageTakenDist","hasCommanderTag","notInSquad","account","activeTimes","teamID","teamId","team","teamColor","team_color"]),G=Array.isArray(v==null?void 0:v.minions)?v.minions:[];be.minions=G.map(pe=>bt(pe,["name","totalDamageTakenDist"]));const oe=P&&((v==null?void 0:v.hasCommanderTag)&&!(v!=null&&v.notInSquad)||!(v!=null&&v.notInSquad)&&!bn(v));return be.combatReplayData=hi(v==null?void 0:v.combatReplayData,oe),be})}return Array.isArray(r.targets)&&(r.targets=r.targets.map(d=>bt(d,["id","name","isFake","dpsAll","statsAll","defenses","totalHealth","healthPercentBurned","enemyPlayer","totalDamageDist","totalDamageTaken","totalDamageTakenDist","damageTaken","powerDamage1S","damage1S","profession","teamID","teamId","team","teamColor","team_color"]))),r},Di=n=>{if(!n||typeof n!="object"||fn(n))return n;const r={...n};return n.details?r.details=pn(n.details):r.details=pn(n),r.__statsPruned=!0,r};let Xe=null,hn=0,Ot=0,Tt=null,Ft=0,jt=0;const ki=n=>typeof(n==null?void 0:n.token)=="number"&&n.token!==Ot,Si=n=>{const r=n==null?void 0:n.stats;if(!r||typeof r!="object")return{spikeSkillRowsRemoved:0,incomingSkillRowsRemoved:0,playerSkillMapsRemoved:0};const d=G=>{let oe=0;return(Array.isArray(G==null?void 0:G.fights)?G.fights:[]).forEach(Oe=>{if(!Oe||typeof Oe!="object")return;const $e=Oe.values;!$e||typeof $e!="object"||Object.values($e).forEach(qe=>{!qe||typeof qe!="object"||Array.isArray(qe.skillRows)&&(delete qe.skillRows,oe+=1)})}),oe},I=d(r.spikeDamage),P=d(r.incomingStrikeDamage);let v=0;return(Array.isArray(r.playerSkillBreakdowns)?r.playerSkillBreakdowns:[]).forEach(G=>{!G||typeof G!="object"||G.skillMap&&typeof G.skillMap=="object"&&(delete G.skillMap,v+=1)}),{spikeSkillRowsRemoved:I,incomingSkillRowsRemoved:P,playerSkillMapsRemoved:v}},Ci=()=>{var be,G;if(!Xe)return;hn+=1;const n=Tt;Tt=null;const r=performance.now(),d=pi({...Xe,includePlayerSkillMap:!1}),I=Si(d),P=Math.max(0,performance.now()-r),v=d==null?void 0:d.stats;self.postMessage({type:"result",result:d,computeId:hn,logCount:Xe.logs.length,token:Ot,completedAt:Date.now(),flushId:n,diagnostics:{computeMs:P,logsInPayload:Xe.logs.length,expectedLogCount:Ft,droppedLogMessages:jt,transferStripStats:I,counts:{playerSkillBreakdowns:Array.isArray(v==null?void 0:v.playerSkillBreakdowns)?v.playerSkillBreakdowns.length:0,spikeFights:Array.isArray((be=v==null?void 0:v.spikeDamage)==null?void 0:be.fights)?v.spikeDamage.fights.length:0,incomingStrikeFights:Array.isArray((G=v==null?void 0:v.incomingStrikeDamage)==null?void 0:G.fights)?v.incomingStrikeDamage.fights.length:0}}})};self.onmessage=n=>{var d,I,P,v;const r=n.data;if((r==null?void 0:r.type)==="reset"){Xe={logs:[]},typeof r.token=="number"&&(Ot=r.token),Ft=Math.max(0,Number(r.totalLogs||0)),jt=0,Tt=null;return}if(!ki(r)){if((r==null?void 0:r.type)==="settings"){Xe={logs:(Xe==null?void 0:Xe.logs)||[],precomputedStats:(d=r.payload)==null?void 0:d.precomputedStats,mvpWeights:(I=r.payload)==null?void 0:I.mvpWeights,statsViewSettings:(P=r.payload)==null?void 0:P.statsViewSettings,disruptionMethod:(v=r.payload)==null?void 0:v.disruptionMethod};return}if((r==null?void 0:r.type)==="log"){if(Xe||(Xe={logs:[]}),Ft>0&&Xe.logs.length>=Ft){jt+=1;return}Xe.logs.push(fn(r.payload)?r.payload:Di(r.payload));return}(r==null?void 0:r.type)==="flush"&&(typeof r.flushId=="number"&&(Tt=r.flushId),Ci())}}})();
